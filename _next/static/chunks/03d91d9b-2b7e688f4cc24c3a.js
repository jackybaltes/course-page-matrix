"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[764],{32950:function(e,t,r){var i,o,n,s,a=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.UNSTABLE_MSC3852_LAST_SEEN_UA=t.UNSTABLE_MSC2666_SHARED_ROOMS=t.UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS=t.UNSTABLE_MSC2666_MUTUAL_ROOMS=t.RoomVersionStability=t.PendingEventOrdering=t.MatrixClient=t.M_AUTHENTICATION=t.GET_LOGIN_TOKEN_CAPABILITY=t.ClientEvent=t.CRYPTO_ENABLED=void 0,t.fixNotificationCountOnDecryption=eE,t.inMainTimelineForReceipt=eR,t.threadIdForReceipt=eS;var d=a(r(14474)),l=a(r(13102)),h=r(9855),c=r(39325),u=r(19314),p=r(59721),g=r(51601),v=r(30394),m=r(11773),y=ec(r(44480)),f=r(91776),E=r(77360),S=r(32540),R=ec(r(14995)),k=r(98870),T=r(92807),I=r(34002),w=r(67439),_=r(498),b=r(94161),P=r(41806),C=r(53978),M=r(69509),U=r(34479),D=r(53014),A=r(70152),x=r(75661),B=ec(r(79662)),$=r(29197),q=r(74130),O=r(15748),N=r(36673),K=r(27526),F=r(89027),L=r(80323),G=r(43705),V=r(14150),H=r(49820),j=r(41943),W=r(33551),Y=r(44441),Q=r(64157),z=r(46694),J=r(93655),Z=r(42e3),X=r(87225),ee=r(68104),et=r(85300),er=r(1755),ei=r(78043),eo=r(98466),en=r(33829),es=r(12994);let ea=["server","limit","since"];function ed(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)}return r}function el(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ed(Object(r),!0).forEach(function(t){(0,l.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ed(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function eh(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(eh=function(e){return e?r:t})(e)}function ec(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=eh(t);if(r&&r.has(e))return r.get(e);var i={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var s=o?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(i,n,s):i[n]=e[n]}return i.default=e,r&&r.set(e,i),i}t.CRYPTO_ENABLED=(0,b.isCryptoAvailable)(),t.UNSTABLE_MSC3852_LAST_SEEN_UA=new X.UnstableValue("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),t.PendingEventOrdering=((i={}).Chronological="chronological",i.Detached="detached",i),t.RoomVersionStability=((o={}).Stable="stable",o.Unstable="unstable",o),t.GET_LOGIN_TOKEN_CAPABILITY=new X.NamespacedValue("m.get_login_token","org.matrix.msc3882.get_login_token");let eu=t.UNSTABLE_MSC2666_SHARED_ROOMS="uk.half-shot.msc2666",ep=t.UNSTABLE_MSC2666_MUTUAL_ROOMS="uk.half-shot.msc2666.mutual_rooms",eg=t.UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS="uk.half-shot.msc2666.query_mutual_rooms";var ev=((n=ev||{}).MasterKey="master_key",n.SelfSigningKey="self_signing_key",n.UserSigningKey="user_signing_key",n);t.M_AUTHENTICATION=new X.UnstableValue("m.authentication","org.matrix.msc2965.authentication");let em=t.ClientEvent=((s={}).Sync="sync",s.Event="event",s.ToDeviceEvent="toDeviceEvent",s.AccountData="accountData",s.Room="Room",s.DeleteRoom="deleteRoom",s.SyncUnexpectedError="sync.unexpectedError",s.ClientWellKnown="WellKnown.client",s.ReceivedVoipEvent="received_voip_event",s.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",s.TurnServers="turnServers",s.TurnServersError="turnServers.error",s),ey=new X.UnstableValue("action","org.matrix.msc3824.action");class ef extends Y.TypedEventEmitter{set store(e){this._store=e,this._store.setUserCreator(e=>M.User.createUser(e,this))}get store(){return this._store}async startClient(e){var t;if(this.clientRunning)return;this.clientRunning=!0,this.on(em.Sync,this.startMatrixRTC),"number"==typeof e&&(e={initialSyncLimit:e});let r=this.getUserId();r&&this.store.storeUser(new M.User(r)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},6e5),this.checkTurnServers()),this.syncApi&&(this.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();let{threads:e,list:t,fwdPagination:r}=await this.doesServerSupportThread();J.Thread.setServerSideSupport(e),J.Thread.setServerSideListSupport(t),J.Thread.setServerSideFwdPaginationSupport(r)}catch(e){this.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}this.clientOpts=null!==(t=e)&&void 0!==t?t:{},this.clientOpts.slidingSync?this.syncApi=new z.SlidingSyncSdk(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&this.logger.warn("`experimentalThreadSupport` has been deprecated, use `threadSupport` instead"),!this.clientOpts.hasOwnProperty("threadSupport")&&this.clientOpts.hasOwnProperty("experimentalThreadSupport")&&(this.clientOpts.threadSupport=this.clientOpts.experimentalThreadSupport),this.syncApi.sync().catch(e=>this.logger.info("Sync startup aborted with an error:",e)),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e,t,i,o,n;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.off(em.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(i=this.peekSync)||void 0===i||i.stopPeeking(),null===(o=this.callEventHandler)||void 0===o||o.stop(),null===(n=this.groupCallEventHandler)||void 0===n||n.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,r.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&r.g.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop())}async rehydrateDevice(){if(this.crypto)throw Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;let e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id){this.logger.info("no dehydrated device found");return}let t=new r.g.Olm.Account;try{let r=e.device_data;if(r.algorithm!==A.DEHYDRATION_ALGORITHM){this.logger.warn("Wrong algorithm for dehydrated device");return}this.logger.debug("unpickling dehydrated device");let i=await this.cryptoCallbacks.getDehydrationKey(r,e=>{t.unpickle(new Uint8Array(e),r.account)});if(t.unpickle(i,r.account),this.logger.debug("unpickled device"),(await this.http.authedRequest(_.Method.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,this.logger.info("using dehydrated device");let r=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(r),sessions:[],pickleKey:r},t.free(),this.deviceId}t.free(),this.logger.info("not using dehydrated device");return}catch(e){t.free(),this.logger.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(_.Method.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){this.logger.info("could not get dehydrated device",e);return}}async setDehydrationKey(e,t,r){if(!this.crypto){this.logger.warn("not dehydrating device if crypto is not enabled");return}return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,r)}async createDehydratedDevice(e,t,r){if(!this.crypto){this.logger.warn("not dehydrating device if crypto is not enabled");return}return await this.crypto.dehydrationManager.setKey(e,t,r),this.crypto.dehydrationManager.dehydrateDevice()}async exportDevice(){if(!this.crypto){this.logger.warn("not exporting device if crypto is not enabled");return}return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()}}clearStores(){if(this.clientRunning)throw Error("Cannot clear stores while client is running");let e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),e.push((async()=>{let e;try{if(!(e=r.g.indexedDB))return}catch(e){return}for(let t of["".concat(ei.RUST_SDK_STORE_PREFIX,"::matrix-sdk-crypto"),"".concat(ei.RUST_SDK_STORE_PREFIX,"::matrix-sdk-crypto-meta")]){let r=new Promise((r,i)=>{this.logger.info("Removing IndexedDB instance ".concat(t));let o=e.deleteDatabase(t);o.onsuccess=e=>{this.logger.info("Removed IndexedDB instance ".concat(t)),r(0)},o.onerror=e=>{this.logger.warn("Failed to remove IndexedDB instance ".concat(t,":"),e),r(0)},o.onblocked=e=>{this.logger.info("cannot yet remove IndexedDB instance ".concat(t))}});await r}})()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){let e=this.getUserId();if(!e)throw Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,p.createNewMatrixCall)(this,e)}async createGroupCall(e,t,r,i,o,n){if(this.getGroupCallForRoom(e))throw Error("".concat(e," already has an existing group call"));let s=this.getRoom(e);if(!s)throw Error("Cannot find room ".concat(e));return new j.GroupCall(this,s,t,r,i,void 0,o||this.isVoipWithNoMediaAllowed,n,this.isVoipWithNoMediaAllowed,this.useLivekitForGroupCalls,this.livekitServiceURL).create()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){let e=this.getSyncState();return!!e&&(e===h.SyncState.Prepared||e===h.SyncState.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];var t=this;let r=new Date().getTime();return this.cachedCapabilities&&!e&&r<this.cachedCapabilities.expiration?(this.logger.debug("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(_.Method.Get,"/capabilities").catch(e=>(this.logger.error(e),{})).then(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.capabilities||{},o=Object.keys(i).length?216e5:6e4+5e3*Math.random();return t.cachedCapabilities={capabilities:i,expiration:r+o},t.logger.debug("Caching capabilities: ",i),i})}async initCrypto(){if(!(0,b.isCryptoAvailable)())throw Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend){this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!this.cryptoStore)throw Error("Cannot enable encryption: no cryptoStore provided");this.logger.debug("Crypto: Starting up crypto store..."),await this.cryptoStore.startup();let e=this.getUserId();if(null===e)throw Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");let t=new b.Crypto(this,e,this.deviceId,this.store,this.cryptoStore,this.verificationMethods);this.reEmitter.reEmit(t,[b.CryptoEvent.KeyBackupFailed,b.CryptoEvent.KeyBackupSessionsRemaining,b.CryptoEvent.RoomKeyRequest,b.CryptoEvent.RoomKeyRequestCancellation,b.CryptoEvent.Warning,b.CryptoEvent.DevicesUpdated,b.CryptoEvent.WillUpdateDevices,b.CryptoEvent.DeviceVerificationChanged,b.CryptoEvent.UserTrustStatusChanged,b.CryptoEvent.KeysChanged]),this.logger.debug("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=b.Crypto.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch(e=>{this.logger.error("Error uploading device keys",e)})}async initRustCrypto(){var e;let{useIndexedDB:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.cryptoBackend){this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}let i=this.getUserId();if(null===i)throw Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");let o=this.getDeviceId();if(null===o)throw Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");this.logger.debug("Downloading Rust crypto library");let n=await Promise.resolve().then(()=>ec(r(43542))),s=await n.initRustCrypto({logger:this.logger,http:this.http,userId:i,deviceId:o,secretStorage:this.secretStorage,cryptoCallbacks:this.cryptoCallbacks,storePrefix:t?ei.RUST_SDK_STORE_PREFIX:null,storePassphrase:this.pickleKey,legacyCryptoStore:this.cryptoStore,legacyPickleKey:null!==(e=this.pickleKey)&&void 0!==e?e:"DEFAULT_KEY",legacyMigrationProgressListener:(e,t)=>{this.emit(b.CryptoEvent.LegacyCryptoStoreMigrationProgress,e,t)}});s.setSupportedVerificationMethods(this.verificationMethods),this.cryptoBackend=s,this.on(q.RoomMemberEvent.Membership,s.onRoomMembership.bind(s)),this.on(em.Event,e=>{s.onLiveEventFromSync(e)}),this.reEmitter.reEmit(s,[b.CryptoEvent.VerificationRequestReceived,b.CryptoEvent.UserTrustStatusChanged,b.CryptoEvent.KeyBackupStatus,b.CryptoEvent.KeyBackupSessionsRemaining,b.CryptoEvent.KeyBackupFailed,b.CryptoEvent.KeyBackupDecryptionKeyCached,b.CryptoEvent.KeysChanged,b.CryptoEvent.DevicesUpdated,b.CryptoEvent.WillUpdateDevices])}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}async uploadKeys(){this.logger.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),i}setDeviceBlocked(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return this.setDeviceVerification(e,t,null,null,r)}async setDeviceVerification(e,t,r,i,o){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,r,i,o)}requestVerificationDM(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(this.cryptoBackend){if(!this.crypto)return}else throw Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x.CrossSigningKey.Master;if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){let t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw Error("End-to-End encryption disabled");let t=e.getWireContent(),r={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return r.session_id&&r.sender_key&&r.algorithm&&r.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(r):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,r;let i=this.getRoom(e);return!!i&&(!!i.hasEncryptionStateEvent()||null!==(t=null===(r=this.crypto)||void 0===r?void 0:r.isRoomEncrypted(e))&&void 0!==t&&t)}encryptAndSendToDevices(e,t){if(!this.crypto)throw Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(_.Method.Get,"/room_keys/version",void 0,void 0,{prefix:_.ClientPrefix.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return L.BackupManager.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{secureSecretStorage:!1};if(!this.crypto)throw Error("End-to-end encryption disabled");let{algorithm:r,auth_data:i,recovery_key:o,privateKey:n}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.secretStorage.store("m.megolm_backup.v1",(0,k.encodeBase64)(n)),this.logger.info("Key backup private key stored in secret storage")),{algorithm:r,auth_data:i,recovery_key:o}}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);let t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");let r=await this.http.authedRequest(_.Method.Post,"/room_keys/version",void 0,t);return await this.checkKeyBackup(),this.getKeyBackupEnabled()||this.logger.error("Key backup not usable even though we just created it"),r}async deleteKeyBackupVersion(e){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");await this.cryptoBackend.deleteKeyBackupVersion(e)}makeKeyBackupPath(e,t,r){return{path:void 0!==t?y.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?y.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}}async sendKeyBackup(e,t,r,i){if(!this.crypto)throw Error("End-to-end encryption disabled");let o=this.makeKeyBackupPath(e,t,r);await this.http.authedRequest(_.Method.Put,o.path,o.queryData,i,{prefix:_.ClientPrefix.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,P.decodeRecoveryKey)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return(0,C.keyFromAuthData)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,P.decodeRecoveryKey)(e)}async restoreKeyBackupWithPassword(e,t,r,i,o){let n=await (0,C.keyFromAuthData)(i.auth_data,e);return this.restoreKeyBackup(n,t,r,i,o)}async restoreKeyBackupWithSecretStorage(e,t,r,i){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");let o=await this.secretStorage.get("m.megolm_backup.v1"),n=(0,b.fixBackupKey)(o);if(n){let e=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",n,[e[0]])}let s=(0,k.decodeBase64)(n||o);return this.restoreKeyBackup(s,t,r,e,i)}restoreKeyBackupWithRecoveryKey(e,t,r,i,o){let n=(0,P.decodeRecoveryKey)(e);return this.restoreKeyBackup(n,t,r,i,o)}async restoreKeyBackupWithCache(e,t,r,i){if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");let o=await this.cryptoBackend.getSessionBackupPrivateKey();if(!o)throw Error("Couldn't get key");return this.restoreKeyBackup(o,e,t,r,i)}async restoreKeyBackup(e,t,r,i,o){let n=null==o?void 0:o.cacheCompleteCallback,s=null==o?void 0:o.progressCallback;if(!this.cryptoBackend)throw Error("End-to-end encryption disabled");if(!i.version)throw Error("Backup version must be defined");let a=0,d=0,l=0,h=this.makeKeyBackupPath(t,r,i.version),c=await this.cryptoBackend.getBackupDecryptor(i,e),u=!c.sourceTrusted;try{if(!(e instanceof Uint8Array))throw Error("restoreKeyBackup expects Uint8Array, got ".concat(e));this.cryptoBackend.storeSessionBackupPrivateKey(e,i.version).catch(e=>{this.logger.warn("Error caching session backup key:",e)}).then(n),s&&s({stage:"fetch"});let o=await this.http.authedRequest(_.Method.Get,h.path,h.queryData,void 0,{prefix:_.ClientPrefix.V3});if(s&&s({stage:"load_keys"}),o.rooms)a=this.getTotalKeyCount(o),await this.handleDecryptionOfAFullBackup(o,c,200,async e=>{try{await this.cryptoBackend.importBackedUpRoomKeys(e,{untrusted:u}),l+=e.length}catch(t){d+=e.length,I.logger.error("Error importing keys from backup",t)}s&&s({total:a,successes:l,stage:"load_keys",failures:d})});else if(o.sessions){let e=o.sessions;a=Object.keys(e).length;let r=await c.decryptSessions(e);for(let e of r)e.room_id=t;await this.cryptoBackend.importBackedUpRoomKeys(r,{progressCallback:s,untrusted:u}),l=r.length}else{a=1;try{let[e]=await c.decryptSessions({[r]:o});e.room_id=t,e.session_id=r,await this.cryptoBackend.importBackedUpRoomKeys([e],{progressCallback:s,untrusted:u}),l=1}catch(e){this.logger.debug("Failed to decrypt megolm session from backup",e)}}}finally{c.free()}return await this.cryptoBackend.checkKeyBackupAndEnable(),{total:a,imported:l}}getTotalKeyCount(e){let t=e.rooms,r=0;for(let e of Object.values(t))e.sessions&&(r+=Object.keys(e.sessions).length);return r}async handleDecryptionOfAFullBackup(e,t,r,i){let o=e.rooms,n=0,s=new Map,a=async e=>{let r=[];for(let i of e.keys()){let o=await t.decryptSessions(e.get(i));for(let e in o){let t=o[e];t.room_id=i,r.push(t)}}await i(r)};for(let[e,t]of Object.entries(o))if(t.sessions)for(let[i,o]of(s.set(e,{}),Object.entries(t.sessions)))s.get(e)[i]=o,(n+=1)>=r&&(await a(s),(s=new Map).set(e,{}),n=0);n>0&&await a(s)}async deleteKeysFromBackup(e,t,r){if(!this.crypto)throw Error("End-to-end encryption disabled");let i=this.makeKeyBackupPath(e,t,r);await this.http.authedRequest(_.Method.Delete,i.path,i.queryData,void 0,{prefix:_.ClientPrefix.V3})}async sendSharedHistoryKeys(e,t){var r;if(!this.crypto)throw Error("End-to-end encryption disabled");let i=null===(r=this.crypto)||void 0===r?void 0:r.getRoomEncryption(e);if(!i){this.logger.error("Unknown room.  Not sharing decryption keys");return}let o=await this.crypto.downloadKeys(t),n=new Map;for(let[e,t]of o)n.set(e,Array.from(t.values()));let s=this.crypto.getRoomDecryptor(e,i.algorithm);s.sendSharedHistoryInboundSessions?await s.sendSharedHistoryInboundSessions(n):this.logger.warn("Algorithm does not support sharing previous keys",i.algorithm)}getMediaConfig(){return this.http.authedRequest(_.Method.Get,"/config",void 0,void 0,{prefix:_.MediaPrefix.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.store.getRooms(),r=new Set;for(let o of t){var i;let t=null===(i=o.findPredecessor(e))||void 0===i?void 0:i.roomId;t&&r.add(t)}return t.filter(e=>!(e.currentState.getStateEvents(O.EventType.RoomTombstone,"")&&r.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){let r=y.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return(0,_.retryNetworkOperation)(5,()=>this.http.authedRequest(_.Method.Put,r,void 0,t))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){let t=this.store.getAccountData(e);return t?t.getContent():null}let t=y.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(_.Method.Get,t)}catch(e){var r;if((null===(r=e.data)||void 0===r?void 0:r.errcode)==="M_NOT_FOUND")return null;throw e}}async deleteAccountData(e){let t=this.canSupport.get(er.Feature.AccountDataDeletion);if(t===er.ServerSupport.Unsupported){await this.setAccountData(e,{});return}let r=y.encodeUri("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),i=t===er.ServerSupport.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(_.Method.Delete,r,void 0,void 0,i)}getIgnoredUsers(){let e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){let t={ignored_users:{}};return e.forEach(e=>{t.ignored_users[e]={}}),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};void 0===t.syncRoom&&(t.syncRoom=!0);let r=this.getRoom(e);if(null!=r&&r.hasMembershipState(this.credentials.userId,"join"))return r;let i=Promise.resolve();if(t.inviteSignUrl){let e=new URL(t.inviteSignUrl);e.searchParams.set("mxid",this.credentials.userId),i=this.http.requestOtherUrl(_.Method.Post,e)}let o={};t.viaServers&&(o.server_name=t.viaServers);let n={},s=await i;s&&(n.third_party_signed=s);let a=y.encodeUri("/join/$roomid",{$roomid:e}),d=(await this.http.authedRequest(_.Method.Post,a,o,n)).room_id,l=this.getRoom(d);if(null!=l&&l.hasMembershipState(this.credentials.userId,"join"))return l;let c=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(d);return t.syncRoom,c}knockRoom(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getRoom(e);if(null!=r&&r.hasMembershipState(this.credentials.userId,"knock"))return Promise.resolve({room_id:r.roomId});let i=y.encodeUri("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),o={};t.viaServers&&(o.server_name=t.viaServers);let n={};return t.reason&&(n.reason=t.reason),this.http.authedRequest(_.Method.Post,i,o,n)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,c.EventStatus.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![c.EventStatus.QUEUED,c.EventStatus.NOT_SENT,c.EventStatus.ENCRYPTING].includes(e.status))throw Error("cannot cancel an event with status "+e.status);e.status===c.EventStatus.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===c.EventStatus.QUEUED&&this.scheduler.removeEventFromQueue(e);let t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,c.EventStatus.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,O.EventType.RoomName,{name:t})}setRoomTopic(e,t,r){let i=B.makeTopicContent(t,r);return this.sendStateEvent(e,O.EventType.RoomTopic,i)}getRoomTags(e){let t=y.encodeUri("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(_.Method.Get,t)}setRoomTag(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=y.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(_.Method.Put,i,void 0,r)}deleteRoomTag(e,t){let r=y.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(_.Method.Delete,r)}setRoomAccountData(e,t,r){let i=y.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(_.Method.Put,i,void 0,r)}async setPowerLevel(e,t,r,i){var o,n;let s;if(this.clientRunning&&this.isInitialSyncComplete()&&(s=null===(n=this.getRoom(e))||void 0===n||null===(n=n.currentState)||void 0===n||null===(n=n.getStateEvents(O.EventType.RoomPowerLevels,""))||void 0===n?void 0:n.getContent()),!s)try{s=await this.getStateEvent(e,O.EventType.RoomPowerLevels,"")}catch(e){if(e instanceof _.MatrixError&&"M_NOT_FOUND"===e.errcode)s={};else throw e}for(let e of(null!==(o=s=y.deepCopy(s))&&void 0!==o&&o.users||(s.users={}),Array.isArray(t)?t:[t]))null==r?delete s.users[e]:s.users[e]=r;return this.sendStateEvent(e,O.EventType.RoomPowerLevels,s,"")}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,Z.M_BEACON_INFO.name,t,this.getUserId())}sendEvent(e,t,r,i,o){var n,s,a,d,l;let h,c,u,p;if(null!=t&&t.startsWith("$")||null===t?(p=o,u=i,c=r,h=t):(p=i,u=r,c=t,h=null),h&&!(null!==(n=u["m.relates_to"])&&void 0!==n&&n.rel_type)){let t=!!(null!==(s=u["m.relates_to"])&&void 0!==s&&s["m.in_reply_to"]);u["m.relates_to"]=el(el({},u["m.relates_to"]),{},{rel_type:J.THREAD_RELATION_TYPE.name,event_id:h,is_falling_back:!t});let r=null===(a=this.getRoom(e))||void 0===a?void 0:a.getThread(h);r&&!t&&(u["m.relates_to"]["m.in_reply_to"]={event_id:null!==(d=null===(l=r.lastReply(e=>e.isRelation(J.THREAD_RELATION_TYPE.name)&&!e.status))||void 0===l?void 0:l.getId())&&void 0!==d?d:h})}return this.sendCompleteEvent(e,h,{type:c,content:u},p)}sendCompleteEvent(e,t,r,i){i||(i=this.makeTxnId());let o=new c.MatrixEvent(Object.assign(r,{event_id:"~"+e+":"+i,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),n=this.getRoom(e),s=t?null==n?void 0:n.getThread(t):void 0;s&&o.setThread(s),this.reEmitter.reEmit(o,[c.MatrixEventEvent.Replaced,c.MatrixEventEvent.VisibilityChange]),null==n||n.reEmitter.reEmit(o,[c.MatrixEventEvent.BeforeRedaction]);let a=o.getAssociatedId();if(null!=a&&a.startsWith("~")){let e=null==n?void 0:n.getPendingEvents().find(e=>e.getId()===a);null==e||e.once(c.MatrixEventEvent.LocalEventIdReplaced,()=>{o.updateAssociatedId(e.getId())})}let d=o.getType();return(this.logger.debug("sendEvent of type ".concat(d," in ").concat(e," with txnId ").concat(i)),o.setTxnId(i),o.setStatus(c.EventStatus.SENDING),null==n||n.addPendingEvent(o,i),o.status===c.EventStatus.NOT_SENT)?Promise.reject(Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(n,o)}async encryptAndSendEvent(e,t){try{let r;this.eventsBeingEncrypted.add(t.getId());try{await this.encryptEventIfNeeded(t,null!=e?e:void 0)}finally{r=!this.eventsBeingEncrypted.delete(t.getId())}if(r)return{};t.status===c.EventStatus.ENCRYPTING&&this.updatePendingEventStatus(e,t,c.EventStatus.SENDING);let i=null;return this.scheduler&&(i=this.scheduler.queueEvent(t))&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,c.EventStatus.QUEUED),!i&&(i=this.sendEventHttpRequest(t),e&&(i=i.then(r=>(e.updatePendingEvent(t,c.EventStatus.SENT,r.event_id),r)))),await i}catch(r){this.logger.error("Error sending event",r);try{t.error=r,this.updatePendingEventStatus(e,t,c.EventStatus.NOT_SENT)}catch(e){this.logger.error("Exception in error handler!",e)}throw r instanceof _.MatrixError&&(r.event=t),r}}async encryptEventIfNeeded(e,t){if(t&&await this.shouldEncryptEventForRoom(e,t)&&(this.cryptoBackend||!this.usingExternalCrypto)){if(!this.cryptoBackend)throw Error("This room is configured to use encryption, but your client does not support encryption.");this.updatePendingEventStatus(t,e,c.EventStatus.ENCRYPTING),await this.cryptoBackend.encryptEvent(e,t)}}async shouldEncryptEventForRoom(e,t){var r;return!(e.isEncrypted()||e.getType()===O.EventType.Reaction||e.isRedaction())&&!!(t.hasEncryptionStateEvent()||await (null===(r=this.cryptoBackend)||void 0===r?void 0:r.isEncryptionEnabledInRoom(t.roomId)))}getEncryptedIfNeededEventType(e,t){var r;return t===O.EventType.Reaction?t:null!==(r=this.getRoom(e))&&void 0!==r&&r.hasEncryptionStateEvent()?O.EventType.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e){let t,r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));let i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r};if(e.isState()){let r="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(r="/rooms/$roomId/state/$eventType/$stateKey"),t=y.encodeUri(r,i)}else t=e.isRedaction()?y.encodeUri("/rooms/$roomId/redact/$redactsEventId/$txnId",el({$redactsEventId:e.event.redacts},i)):y.encodeUri("/rooms/$roomId/send/$eventType/$txnId",i);return this.http.authedRequest(_.Method.Put,t,void 0,e.getWireContent()).then(t=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(t.event_id)),t))}redactEvent(e,t,r,i,o){var n,s,a;null!==(n=r)&&void 0!==n&&n.startsWith("$")||(o=i,i=r,r=t,t=null);let d={reason:null===(s=o)||void 0===s?void 0:s.reason};if((null===(a=o)||void 0===a?void 0:a.with_rel_types)!==void 0){if(this.canSupport.get(er.Feature.RelationBasedRedactions)===er.ServerSupport.Unsupported)throw Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(i," threadId ").concat(t));d[this.canSupport.get(er.Feature.RelationBasedRedactions)===er.ServerSupport.Stable?O.MSC3912_RELATION_BASED_REDACTIONS_PROP.stable:O.MSC3912_RELATION_BASED_REDACTIONS_PROP.unstable]=o.with_rel_types}return this.sendCompleteEvent(e,t,{type:O.EventType.RoomRedaction,content:d,redacts:r},i)}sendMessage(e,t,r,i){"string"!=typeof t&&null!==t&&(i=r,r=t,t=null);let o=O.EventType.RoomMessage,n=r;return this.sendEvent(e,t,o,n,i)}sendTextMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeTextMessage(r);return this.sendMessage(e,t,n,i)}sendNotice(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeNotice(r);return this.sendMessage(e,t,n,i)}sendEmoteMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeEmoteMessage(r);return this.sendMessage(e,t,n,i)}sendImageMessage(e,t,r,i){var o;let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image";null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(n=i||"Image",i=r,r=t,t=null);let s={msgtype:O.MsgType.Image,url:r,info:i,body:n};return this.sendMessage(e,t,s)}sendStickerMessage(e,t,r,i){var o;let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker";null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(n=i||"Sticker",i=r,r=t,t=null);let s={url:r,info:i,body:n};return this.sendEvent(e,t,O.EventType.Sticker,s)}sendHtmlMessage(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeHtmlMessage(r,i);return this.sendMessage(e,t,n)}sendHtmlNotice(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeHtmlNotice(r,i);return this.sendMessage(e,t,n)}sendHtmlEmote(e,t,r,i){var o;null!==(o=t)&&void 0!==o&&o.startsWith("$")||null===t||(i=r,r=t,t=null);let n=B.makeHtmlEmote(r,i);return this.sendMessage(e,t,n)}async sendReceipt(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.isGuest())return Promise.resolve({});let o=y.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),n=!i&&this.supportsThreads()?el(el({},r),{},{thread_id:eS(e)}):r,s=this.http.authedRequest(_.Method.Post,o,void 0,n||{}),a=this.getRoom(e.getRoomId());return a&&this.credentials.userId&&a.addLocalEchoReceipt(this.credentials.userId,e,t,i),s}async sendReadReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q.ReceiptType.Read,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)return;let i=e.getId(),o=this.getRoom(e.getRoomId());if(null!=o&&o.hasPendingEvent(i))throw Error("Cannot set read receipt to a pending event (".concat(i,")"));return this.sendReceipt(e,t,{},r)}async setRoomReadMarkers(e,t,r,i){let o,n;let s=this.getRoom(e);if(null!=s&&s.hasPendingEvent(t))throw Error("Cannot set read marker to a pending event (".concat(t,")"));if(r){if(o=r.getId(),null!=s&&s.hasPendingEvent(o))throw Error("Cannot set read receipt to a pending event (".concat(o,")"));null==s||s.addLocalEchoReceipt(this.credentials.userId,r,Q.ReceiptType.Read)}if(i){if(n=i.getId(),null!=s&&s.hasPendingEvent(n))throw Error("Cannot set read receipt to a pending event (".concat(n,")"));null==s||s.addLocalEchoReceipt(this.credentials.userId,i,Q.ReceiptType.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,o,n)}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);let r=new URL(e);r.hash="",e=r.toString();let i=t+"_"+e;if(i in this.urlPreviewCache)return this.urlPreviewCache[i];let o=this.http.authedRequest(_.Method.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:_.MediaPrefix.V3,priority:"low"});return this.urlPreviewCache[i]=o,o}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});let i=y.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),o={typing:t};return t&&(o.timeout=r||2e4),this.http.authedRequest(_.Method.Put,i,void 0,o)}getRoomUpgradeHistory(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.getRoom(e);if(!i)return[];let o=this.findPredecessorRooms(i,t,r),n=this.findSuccessorRooms(i,t,r);return[...o,i,...n]}findPredecessorRooms(e,t,r){var i,o;let n=[],s=null===(i=e.findPredecessor(r))||void 0===i?void 0:i.roomId;for(;null!==s;){let i=this.getRoom(s);if(null===i)break;if(t){let t=i.currentState.getStateEvents(O.EventType.RoomTombstone,"");if(!t||t.getContent().replacement_room!==e.roomId)break}n.splice(0,0,i),s=null===(o=(e=i).findPredecessor(r))||void 0===o?void 0:o.roomId}return n}findSuccessorRooms(e,t,r){let i=[],o=e.currentState.getStateEvents(O.EventType.RoomTombstone,"");for(;o;){let s=this.getRoom(o.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var n;let t=null===(n=s.findPredecessor(r))||void 0===n?void 0:n.roomId;if(!t||t!==e.roomId)break}if(i.push(s),new Set(i.map(e=>e.roomId)).size<i.length)return i.slice(0,i.length-1);o=(e=s).currentState.getStateEvents(O.EventType.RoomTombstone,"")}return i}invite(e,t,r){return this.membershipChange(e,t,"invite",r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,r){var i;let o=y.encodeUri("/rooms/$roomId/invite",{$roomId:e}),n=this.getIdentityServerUrl(!0);if(!n)return Promise.reject(new _.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));let s={id_server:n,medium:t,address:r};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken){let e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}return this.http.authedRequest(_.Method.Post,o,void 0,s)}leave(e){return this.membershipChange(e,void 0,"leave")}leaveRoomChain(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=this.getRoomUpgradeHistory(e),i=r;if(!t){for(let t of(i=[],r))if(i.push(t),t.roomId===e)break}let o={},n=[],s=e=>this.leave(e).then(()=>{delete o[e]}).catch(t=>{o[e]=t});for(let e of i)n.push(s(e.roomId));return Promise.all(n).then(()=>o)}ban(e,t,r){return this.membershipChange(e,t,"ban",r)}forget(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=this.membershipChange(e,void 0,"forget");return t?r.then(t=>(this.store.removeRoom(e),this.emit(em.DeleteRoom,e),t)):r}unban(e,t){let r=y.encodeUri("/rooms/$roomId/unban",{$roomId:e});return this.http.authedRequest(_.Method.Post,r,void 0,{user_id:t})}kick(e,t,r){let i=y.encodeUri("/rooms/$roomId/kick",{$roomId:e});return this.http.authedRequest(_.Method.Post,i,void 0,{user_id:t,reason:r})}membershipChange(e,t,r,i){let o=y.encodeUri("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(_.Method.Post,o,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushActions()||t){let{actions:t,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,r)}return e.getPushActions()}getPushDetailsForEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushDetails()||t){let{actions:t,rule:r}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,r)}return e.getPushDetails()}setProfileInfo(e,t){let r=y.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(_.Method.Put,r,void 0,t)}async setDisplayName(e){let t=await this.setProfileInfo("displayname",{displayname:e}),r=this.getUser(this.getUserId());return r&&(r.displayName=e,r.emit(M.UserEvent.DisplayName,r.events.presence,r)),t}async setAvatarUrl(e){let t=await this.setProfileInfo("avatar_url",{avatar_url:e}),r=this.getUser(this.getUserId());return r&&(r.avatarUrl=e,r.emit(M.UserEvent.AvatarUrl,r.events.presence,r)),t}mxcUrlToHttp(e,t,r,i,o,n){return(0,U.getHttpUriForMxc)(this.baseUrl,e,t,r,i,o,n)}async setSyncPresence(e){var t;null===(t=this.syncApi)||void 0===t||t.setPresence(e)}async setPresence(e){let t=y.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw Error("Bad presence value: "+e.presence);await this.http.authedRequest(_.Method.Put,t,void 0,e)}getPresence(e){let t=y.encodeUri("/presence/$userId/status",{$userId:e});return this.http.authedRequest(_.Method.Get,t)}scrollback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,r=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs&&(r=Math.max(3e3-(Date.now()-i.errorTs),0)),null===e.oldState.paginationToken)return Promise.resolve(e);let o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;let n=new Promise((i,o)=>{(0,y.sleep)(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,f.Direction.Backward)).then(t=>{var r,o;let n=t.chunk.map(this.getEventMapper());if(t.state){let r=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(r)}let[s,a,d]=e.partitionThreadedEvents(n);this.processAggregatedTimelineEvents(e,s),e.addEventsToTimeline(s,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),d.forEach(t=>e.relations.aggregateChildEvent(t)),e.oldState.paginationToken=null!==(r=t.end)&&void 0!==r?r:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,n,null!==(o=t.end)&&void 0!==o?o:null,!0),delete this.ongoingScrollbacks[e.roomId],i(e)}).catch(t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},o(t)})});return i={promise:n},this.ongoingScrollbacks[e.roomId]=i,n}getEventMapper(e){return(0,K.eventMapperFor)(this,e||{})}async getEventTimeline(e,t){var r,i,o,n;let s;if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(null!=e&&e.room))throw Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);let a=y.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(s={filter:JSON.stringify(g.Filter.LAZY_LOADING_MESSAGES_FILTER)});let d=await this.http.authedRequest(_.Method.Get,a,s);if(!d.event)throw Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);let l=this.getEventMapper(),h=l(d.event);if(h.isRelation(J.THREAD_RELATION_TYPE.name)){this.logger.warn("Tried loading a regular timeline at the position of a thread event");return}let c=[...d.events_after.reverse().map(l),h,...d.events_before.map(l)],u=e.getTimelineForEvent(c[0].getId());u?u.getState(f.EventTimeline.BACKWARDS).setUnknownStateEvents(d.state.map(l)):((u=e.addTimeline()).initialiseState(d.state.map(l)),u.getState(f.EventTimeline.FORWARDS).paginationToken=d.end);let[p,v,m]=e.room.partitionThreadedEvents(c);return e.addEventsToTimeline(p,!0,u,d.start),this.processThreadEvents(e.room,v,!0),this.processAggregatedTimelineEvents(e.room,p),m.forEach(t=>e.relations.aggregateChildEvent(t)),null!==(i=null!==(o=e.getTimelineForEvent(t))&&void 0!==o?o:null===(n=e.room.findThreadForEvent(h))||void 0===n?void 0:n.liveTimeline)&&void 0!==i?i:u}async getThreadTimeline(e,t){var r,i,o,n,s,a,d,l;if(!this.supportsThreads())throw Error("could not get thread timeline: no client support");if(!e.room)throw Error("could not get thread timeline: not a room timeline");if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");let h=y.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),c={limit:"0"};null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(c.filter=JSON.stringify(g.Filter.LAZY_LOADING_MESSAGES_FILTER));let u=await this.http.authedRequest(_.Method.Get,h,c),p=this.getEventMapper(),v=p(u.event);if(!e.canContain(v))return;let m=this.canSupport.get(er.Feature.RelationsRecursion)!==er.ServerSupport.Unsupported;if(J.Thread.hasServerSideSupport){if(J.Thread.hasServerSideFwdPaginationSupport){if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");let r=e.thread,a=await this.fetchRelations(e.room.roomId,r.id,null,null,{dir:f.Direction.Backward,from:u.start,recurse:m||void 0}),d=await this.fetchRelations(e.room.roomId,r.id,null,null,{dir:f.Direction.Forward,from:u.end,recurse:m||void 0}),l=[...d.chunk.reverse().filter((0,es.getRelationsThreadFilter)(r.id)).map(p),v,...a.chunk.filter((0,es.getRelationsThreadFilter)(r.id)).map(p)];for(let t of l)await (null===(s=e.thread)||void 0===s?void 0:s.processEvent(t));let h=e.getTimelineForEvent(v.getId());if(h?h.getState(f.EventTimeline.BACKWARDS).setUnknownStateEvents(u.state.map(p)):(h=e.addTimeline()).initialiseState(u.state.map(p)),e.addEventsToTimeline(l,!0,h,d.next_batch),!a.next_batch){let t=await this.fetchRoomEvent(e.room.roomId,r.id);e.addEventsToTimeline([p(t)],!0,h,null)}return h.setPaginationToken(null!==(i=a.next_batch)&&void 0!==i?i:null,f.Direction.Backward),h.setPaginationToken(null!==(o=d.next_batch)&&void 0!==o?o:null,f.Direction.Forward),this.processAggregatedTimelineEvents(e.room,l),null!==(n=e.getTimelineForEvent(t))&&void 0!==n?n:h}{let t=e.thread,r=await this.fetchRelations(e.room.roomId,t.id,J.THREAD_RELATION_TYPE.name,null,{dir:f.Direction.Backward,from:u.start,recurse:m||void 0}),i=[],o=u.end;for(;o;){let r=await this.fetchRelations(e.room.roomId,t.id,J.THREAD_RELATION_TYPE.name,null,{dir:f.Direction.Forward,from:o,recurse:m||void 0});o=null!==(d=r.next_batch)&&void 0!==d?d:null,i.push(...r.chunk)}let n=[...i.reverse().map(p),v,...r.chunk.map(p)];for(let t of n)await (null===(l=e.thread)||void 0===l?void 0:l.processEvent(t));let s=e.getLiveTimeline();if(s.getState(f.EventTimeline.BACKWARDS).setUnknownStateEvents(u.state.map(p)),e.addEventsToTimeline(n,!0,s,null),!r.next_batch){let r=await this.fetchRoomEvent(e.room.roomId,t.id);e.addEventsToTimeline([p(r)],!0,s,null)}return s.setPaginationToken(null!==(a=r.next_batch)&&void 0!==a?a:null,f.Direction.Backward),s.setPaginationToken(null,f.Direction.Forward),this.processAggregatedTimelineEvents(e.room,n),s}}}async getLatestTimeline(e){var t,r,i,o;let n;if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw Error("getLatestTimeline only supports room timelines");if(null!==e.threadListType)n=null===(t=(await this.createThreadListMessagesRequest(e.room.roomId,null,1,f.Direction.Backward,e.threadListType,e.getFilter())).chunk)||void 0===t?void 0:t[0];else if(e.thread&&J.Thread.hasServerSideSupport){let t=this.canSupport.get(er.Feature.RelationsRecursion)!==er.ServerSupport.Unsupported;n=null===(r=(await this.fetchRelations(e.room.roomId,e.thread.id,J.THREAD_RELATION_TYPE.name,null,{dir:f.Direction.Backward,limit:1,recurse:t||void 0})).chunk)||void 0===r?void 0:r[0]}else{let t=y.encodeUri("/rooms/$roomId/messages",{$roomId:e.room.roomId}),r={dir:"b"};null!==(i=this.clientOpts)&&void 0!==i&&i.lazyLoadMembers&&(r.filter=JSON.stringify(g.Filter.LAZY_LOADING_MESSAGES_FILTER)),n=null===(o=(await this.http.authedRequest(_.Method.Get,t,r)).chunk)||void 0===o?void 0:o[0]}if(!n)throw Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,n.event_id)}createMessagesRequest(e,t){var r,i;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a=y.encodeUri("/rooms/$roomId/messages",{$roomId:e}),d={limit:o.toString(),dir:n};t&&(d.from=t);let l=null;return null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(l=Object.assign({},g.Filter.LAZY_LOADING_MESSAGES_FILTER)),s&&Object.assign(l=l||{},null===(i=s.getRoomTimelineFilterComponent())||void 0===i?void 0:i.toJSON()),l&&(d.filter=JSON.stringify(l)),this.http.authedRequest(_.Method.Get,a,d)}createThreadListMessagesRequest(e,t){var r,i;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:f.Direction.Backward,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:J.ThreadFilterType.All,a=arguments.length>5?arguments[5]:void 0,d=y.encodeUri("/rooms/$roomId/threads",{$roomId:e}),l={limit:o.toString(),dir:n,include:(0,J.threadFilterTypeToFilter)(s)};t&&(l.from=t);let h={};null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(h=el({},g.Filter.LAZY_LOADING_MESSAGES_FILTER)),a&&(h=el(el({},h),null===(i=a.getRoomTimelineFilterComponent())||void 0===i?void 0:i.toJSON())),Object.keys(h).length&&(l.filter=JSON.stringify(h));let c={prefix:J.Thread.hasServerSideListSupport===J.FeatureSupport.Stable?_.ClientPrefix.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(_.Method.Get,d,l,void 0,c).then(e=>{var t;return el(el({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})})}paginateEventTimeline(e,t){var r,i,o;let n,s;let a=e.getTimelineSet()===this.notifTimelineSet,d=this.getRoom(e.getRoomId()),l=e.getTimelineSet().threadListType,h=e.getTimelineSet().thread,c=(t=t||{}).backwards||!1;if(a&&!c)throw Error("paginateNotifTimeline can only paginate backwards");let u=c?f.EventTimeline.BACKWARDS:f.EventTimeline.FORWARDS,p=e.getPaginationToken(u),g=e.paginationRequests[u];if(g)return g;if(a)n={limit:(null!==(r=t.limit)&&void 0!==r?r:30).toString(),only:"highlight"},p&&"end"!==p&&(n.from=p),s=this.http.authedRequest(_.Method.Get,"/notifications",n).then(async t=>{let r=t.next_token,i=[];t.notifications=t.notifications.filter(y.noUnsafeEventProps);for(let e=0;e<t.notifications.length;e++){let r=t.notifications[e],o=this.getEventMapper()(r.event);this.getPushDetailsForEvent(o,!0),o.event.room_id=r.room_id,i[e]=o}let o=e.getTimelineSet();return o.addEventsToTimeline(i,c,e,r),this.processAggregatedTimelineEvents(o.room,i),c&&!t.next_token&&e.setPaginationToken(null,u),!!t.next_token}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=s;else if(null!==l){if(!d)throw Error("Unknown room "+e.getRoomId());if(!J.Thread.hasServerSideFwdPaginationSupport&&u===f.Direction.Forward)throw Error("Cannot paginate threads forwards without server-side support for MSC 3715");s=this.createThreadListMessagesRequest(e.getRoomId(),p,t.limit,u,l,e.getFilter()).then(t=>{if(t.state){let r=e.getState(u),i=t.state.filter(y.noUnsafeEventProps).map(this.getEventMapper());r.setUnknownStateEvents(i)}let r=t.end,i=t.chunk.filter(y.noUnsafeEventProps).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(i,c,e,r),this.processAggregatedTimelineEvents(d,i),this.processThreadRoots(d,i,c),c&&t.end==t.start&&e.setPaginationToken(null,u),t.end!==t.start}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=s}else if(h){let r=this.getRoom(null!==(i=e.getRoomId())&&void 0!==i?i:void 0);if(!r)throw Error("Unknown room "+e.getRoomId());let n=this.canSupport.get(er.Feature.RelationsRecursion)!==er.ServerSupport.Unsupported;s=this.fetchRelations(null!==(o=e.getRoomId())&&void 0!==o?o:"",h.id,null,null,{dir:u,limit:t.limit,from:null!=p?p:void 0,recurse:n||void 0}).then(async t=>{let i=this.getEventMapper(),o=t.chunk.filter(y.noUnsafeEventProps).filter((0,es.getRelationsThreadFilter)(h.id)).map(i);for(let e of o.slice().reverse()){await (null==h?void 0:h.processEvent(e));let t=e.getSender();c&&(null==h?void 0:h.getEventReadUpTo(t))!==null||r.addLocalEchoReceipt(t,e,Q.ReceiptType.Read)}let n=t.next_batch,s=e.getTimelineSet();if(s.addEventsToTimeline(o,c,e,null!=n?n:null),!n&&c){var a;let t=await this.fetchRoomEvent(null!==(a=e.getRoomId())&&void 0!==a?a:"",h.id);s.addEventsToTimeline([i(t)],!0,e,null)}return this.processAggregatedTimelineEvents(s.room,o),c&&!n&&e.setPaginationToken(null,u),!!n}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=s}else{if(!d)throw Error("Unknown room "+e.getRoomId());s=this.createMessagesRequest(e.getRoomId(),p,t.limit,u,e.getFilter()).then(t=>{if(t.state){let r=e.getState(u),i=t.state.filter(y.noUnsafeEventProps).map(this.getEventMapper());r.setUnknownStateEvents(i)}let r=t.end,i=t.chunk.filter(y.noUnsafeEventProps).map(this.getEventMapper()),o=e.getTimelineSet(),[n,,s]=d.partitionThreadedEvents(i);o.addEventsToTimeline(n,c,e,r),this.processAggregatedTimelineEvents(d,n),this.processThreadRoots(d,n.filter(e=>e.getServerAggregatedRelation(J.THREAD_RELATION_TYPE.name)),!1),s.forEach(e=>d.relations.aggregateChildEvent(e));let a=void 0===t.end||t.end===t.start;return c&&a&&e.setPaginationToken(null,u),!a}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=s}return s}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){let r=this.sendStateEvent(e,O.EventType.RoomGuestAccess,{guest_access:t.allowJoin?"can_join":"forbidden"},""),i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,O.EventType.RoomHistoryVisibility,{history_visibility:"world_readable"},"")),Promise.all([i,r]).then()}requestRegisterEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestRegisterMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}requestAdd3pidEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestAdd3pidMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}requestPasswordEmailToken(e,t,r,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:i})}requestPasswordMsisdnToken(e,t,r,i,o){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:i,next_link:o})}async requestTokenFromEndpoint(e,t){let r=Object.assign({},t);return this.http.request(_.Method.Post,e,void 0,r)}getRoomPushRule(e,t){if(this.pushRules){var r;return null===(r=this.pushRules[e])||void 0===r||null===(r=r.room)||void 0===r?void 0:r.find(e=>e.rule_id===t)}throw Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){let i;let o=!1,n=this.getRoomPushRule(e,t);if(null!=n&&n.actions.includes(H.PushRuleActionName.DontNotify)&&(o=!0),r){if(n){if(!o){let r=y.defer();this.deletePushRule(e,H.PushRuleKind.RoomSpecific,n.rule_id).then(()=>{this.addPushRule(e,H.PushRuleKind.RoomSpecific,t,{actions:[H.PushRuleActionName.DontNotify]}).then(()=>{r.resolve()}).catch(e=>{r.reject(e)})}).catch(e=>{r.reject(e)}),i=r.promise}}else i=this.addPushRule(e,H.PushRuleKind.RoomSpecific,t,{actions:[H.PushRuleActionName.DontNotify]})}else o&&(i=this.deletePushRule(e,H.PushRuleKind.RoomSpecific,n.rule_id));if(i)return new Promise((e,t)=>{i.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(r=>{this.pushRules=r,t(e)}).catch(r=>{t(e)})})})}searchMessageText(e){let t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){let t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:V.SearchOrderBy.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(r,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;let t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,i;let o=t.search_categories.room_events;e.count=o.count,e.next_batch=o.next_batch;let n=new Set(o.highlights);e.highlights.forEach(e=>{n.add(e)}),e.highlights=Array.from(n);let s=this.getEventMapper(),a=null!==(r=null===(i=o.results)||void 0===i?void 0:i.length)&&void 0!==r?r:0;for(let t=0;t<a;t++){let r=D.SearchResult.fromJson(o.results[t],s),i=this.getRoom(r.context.getEvent().getRoomId());if(i)for(let e of r.context.getTimeline()){let t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(r)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;let e=new h.SyncApi(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){let t=y.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(_.Method.Post,t,void 0,e).then(t=>{let r=g.Filter.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r})}getFilter(e,t,r){if(r){let r=this.store.getFilter(e,t);if(r)return Promise.resolve(r)}let i=y.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(_.Method.Get,i).then(r=>{let i=g.Filter.fromJson(e,t,r);return this.store.storeFilter(i),i})}async getOrCreateFilter(e,t){let r;let i=this.store.getFilterIdByName(e);if(i){try{let e=await this.getFilter(this.credentials.userId,i,!0);if(e){let o=e.getDefinition(),n=t.getDefinition();y.deepCompare(o,n)&&(r=i)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}r||this.store.setFilterIdByName(e,void 0)}if(r)return r;let o=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,o.filterId),o.filterId}getOpenIdToken(){let e=y.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(_.Method.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(_.Method.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1,t=this.turnServersExpiry-Date.now();if(t>6e5)this.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{this.logger.debug("Fetching new TURN credentials");try{let t=await this.turnServer();if(t.uris){this.logger.debug("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");let r={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[r],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0,this.emit(em.TurnServers,this.turnServers)}}catch(e){this.logger.error("Failed to get TURN URIs",e),403===e.httpStatus?(this.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&r.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(em.TurnServersError,e,!0)):this.emit(em.TurnServersError,e,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){let e=y.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(_.Method.Get,e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){let t=y.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(_.Method.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){let t=y.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(_.Method.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){var e;this.clientWellKnownPromise=S.AutoDiscovery.getRawClientConfig(null!==(e=this.getDomain())&&void 0!==e?e:void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(em.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){let e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(t=>{let[r,i]=t;return e.includes(typeof i)}).reduce((e,t)=>{let[r,i]=t;return e[r]=i,e},{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){let t,r;let i=await this.doesServerSupportUnstableFeature(eu),o=await this.doesServerSupportUnstableFeature(ep),n=await this.doesServerSupportUnstableFeature(eg);if(!i&&!o&&!n)throw Error("Server does not support the Mutual Rooms API");n?(t="/uk.half-shot.msc2666/user/mutual_rooms",r={user_id:e}):(t=y.encodeUri("/uk.half-shot.msc2666/user/".concat(o?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),r={});let s=[],a=null;do{let e={};null!=a&&n&&(e.batch_token=a);let i=await this.http.authedRequest(_.Method.Get,t,el(el({},r),e),void 0,{prefix:_.ClientPrefix.Unstable});s.push(...i.joined),a=void 0!==i.next_batch_token?i.next_batch_token:null}while(null!=a);return s}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.authedRequest(_.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(e=>{throw this.serverVersionsPromise=void 0,e});let e=await this.serverVersionsPromise;return this.canSupport=await (0,er.buildFeatureSupportMap)(e),this.serverVersionsPromise}async isVersionSupported(e){let{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportUnstableFeature(e){let t=await this.getVersions();if(!t)return!1;let r=t.unstable_features;return r&&!!r[e]}async doesServerForceEncryptionForPreset(e){let t=await this.getVersions();if(!t)return!1;let r=t.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return r&&!!r["io.element.e2ee_forced.".concat(i)]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:J.FeatureSupport.Stable,list:J.FeatureSupport.Stable,fwdPagination:J.FeatureSupport.Stable};try{let[e,t,r,i,o,n]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,J.determineFeatureSupport)(t,e),list:(0,J.determineFeatureSupport)(i,r),fwdPagination:(0,J.determineFeatureSupport)(n,o)}}catch(e){return{threads:J.FeatureSupport.None,list:J.FeatureSupport.None,fwdPagination:J.FeatureSupport.None}}}hasLazyLoadMembersEnabled(){var e;return!!(null!==(e=this.clientOpts)&&void 0!==e&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,r,i){var o,n;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:f.Direction.Backward},a=i?this.getEncryptedIfNeededEventType(e,i):null,[d,l]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,r,a,s)]),h=this.getEventMapper(),c=d?h(d):void 0,u=l.chunk.map(h);if(a===O.EventType.RoomMessageEncrypted){let e=c?u.concat(c):u;await Promise.all(e.map(e=>this.decryptEventIfNeeded(e))),null!==i&&(u=u.filter(e=>e.getType()===i))}return c&&r===O.RelationType.Replace&&(u=u.filter(e=>e.getSender()===c.getSender())),{originalEvent:null!=c?c:null,events:u,nextBatch:null!==(o=l.next_batch)&&void 0!==o?o:null,prevBatch:null!==(n=l.prev_batch)&&void 0!==n?n:null}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,F.randomString)(32)}decryptEventIfNeeded(e,t){return(e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted())?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case w.SERVICE_TYPES.IS:return this.http.getUrl("/terms",void 0,_.IdentityPrefix.V2,t);case w.SERVICE_TYPES.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t;let r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return r&&(null!==(e=this.idBaseUrl)&&void 0!==e&&e.startsWith("http://")||null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=y.ensureNoTrailingSlash(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!==(e=this.http.opts.refreshToken)&&void 0!==e?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(_.Method.Get,"/register/available",{username:e}).then(e=>e.available).catch(e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e))}register(e,t,r,i,o,n,s){!0===o?o={email:!0}:(null==o||!1===o)&&(o={}),r&&(i.session=r);let a={auth:i,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),o.email&&(a.bind_email=!0),o.msisdn&&(a.bind_msisdn=!0),null!=n&&(a.guest_access_token=n),null!=s&&(a.inhibit_login=s),null!=t&&(a.x_show_msisdn=!0),this.registerRequest(a)}registerGuest(){let{body:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){let r={};return t&&(r.kind=t),this.http.request(_.Method.Post,"/register",r,e)}refreshToken(e){let t=t=>this.http.authedRequest(_.Method.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(_.ClientPrefix.V3).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return t(_.ClientPrefix.V1);throw e})}loginFlows(){return this.http.request(_.Method.Get,"/login")}login(e,t){return this.http.authedRequest(_.Method.Post,"/login",void 0,el(el({},t),{},{type:e})).then(e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o="/login/"+t+"/redirect";r&&(o+="/"+r);let n={redirectUrl:e,[ey.unstable]:i};return this.http.getUrl(o,n).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(null!==(e=this.crypto)&&void 0!==e&&null!==(e=e.backupManager)&&void 0!==e&&e.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){this.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return t&&(this.stopClient(),this.http.abort()),this.http.authedRequest(_.Method.Post,"/logout")}deactivateAccount(e,t){let r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(_.Method.Post,"/account/deactivate",void 0,r)}async requestLoginToken(e){return this.http.authedRequest(_.Method.Post,"/login/get_token",void 0,{auth:e},{prefix:_.ClientPrefix.V1})}getFallbackAuthUrl(e,t){let r=y.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}async createRoom(e){var t;let r=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(r.length>0&&null!==(t=this.identityServer)&&void 0!==t&&t.getAccessToken){let e=await this.identityServer.getAccessToken();if(e)for(let t of r)t.id_access_token=e}return this.http.authedRequest(_.Method.Post,"/createRoom",void 0,e)}fetchRelations(e,t,r,i){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:f.Direction.Backward},n=o;J.Thread.hasServerSideFwdPaginationSupport===J.FeatureSupport.Experimental&&(n=(0,y.replaceParam)("dir","org.matrix.msc3715.dir",n)),this.canSupport.get(er.Feature.RelationsRecursion)===er.ServerSupport.Unstable&&(n=(0,y.replaceParam)("recurse","org.matrix.msc3981.recurse",n));let s=y.encodeParams(n),a="/rooms/$roomId/relations/$eventId";null!==r?(a+="/$relationType",null!==i&&(a+="/$eventType")):null!==i&&(this.logger.warn("eventType: ".concat(i," ignored when fetching\n            relations as relationType is null")),i=null);let d=y.encodeUri(a+"?"+s,{$roomId:e,$eventId:t,$relationType:r,$eventType:i});return this.http.authedRequest(_.Method.Get,d,void 0,void 0,{prefix:_.ClientPrefix.V1})}roomState(e){let t=y.encodeUri("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(_.Method.Get,t)}fetchRoomEvent(e,t){let r=y.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(_.Method.Get,r)}members(e,t,r,i){let o={};t&&(o.membership=t),r&&(o.not_membership=r),i&&(o.at=i);let n=y.encodeParams(o),s=y.encodeUri("/rooms/$roomId/members?"+n,{$roomId:e});return this.http.authedRequest(_.Method.Get,s)}upgradeRoom(e,t){let r=y.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(_.Method.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){let i={$roomId:e,$eventType:t,$stateKey:r},o=y.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==r&&(o=y.encodeUri(o+"/$stateKey",i)),this.http.authedRequest(_.Method.Get,o)}sendStateEvent(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},n={$roomId:e,$eventType:t,$stateKey:i},s=y.encodeUri("/rooms/$roomId/state/$eventType",n);return void 0!==i&&(s=y.encodeUri(s+"/$stateKey",n)),this.http.authedRequest(_.Method.Put,s,void 0,r,o)}roomInitialSync(e,t){var r;let i=y.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(_.Method.Get,i,{limit:null!==(r=null==t?void 0:t.toString())&&void 0!==r?r:"30"})}async setRoomReadMarkersHttpRequest(e,t,r,i){let o=y.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),n={[Q.ReceiptType.FullyRead]:t,[Q.ReceiptType.Read]:r};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(n[Q.ReceiptType.ReadPrivate]=i),this.http.authedRequest(_.Method.Post,o,void 0,n)}getJoinedRooms(){let e=y.encodeUri("/joined_rooms",{});return this.http.authedRequest(_.Method.Get,e)}getJoinedRoomMembers(e){let t=y.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(_.Method.Get,t)}publicRooms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{server:t,limit:r,since:i}=e,o=(0,d.default)(e,ea),n={server:t,limit:r,since:i};return 0===Object.keys(o).length?this.http.authedRequest(_.Method.Get,"/publicRooms",n):this.http.authedRequest(_.Method.Post,"/publicRooms",n,o)}createAlias(e,t){let r=y.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(_.Method.Put,r,void 0,{room_id:t})}deleteAlias(e){let t=y.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(_.Method.Delete,t)}getLocalAliases(e){let t=y.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),r=_.ClientPrefix.V3;return this.http.authedRequest(_.Method.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){let t=y.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(_.Method.Get,t)}resolveRoomAlias(e){let t=y.encodeUri("/directory/room/$alias",{$alias:e});return this.http.request(_.Method.Get,t)}getRoomDirectoryVisibility(e){let t=y.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(_.Method.Get,t)}setRoomDirectoryVisibility(e,t){let r=y.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(_.Method.Put,r,void 0,{visibility:t})}searchUserDirectory(e){let{term:t,limit:r}=e,i={search_term:t};return void 0!==r&&(i.limit=r),this.http.authedRequest(_.Method.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){let r=t?y.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):y.encodeUri("/profile/$userId",{$userId:e});return this.http.authedRequest(_.Method.Get,r)}getThreePids(){return this.http.authedRequest(_.Method.Get,"/account/3pid")}async addThreePidOnly(e){return this.http.authedRequest(_.Method.Post,"/account/3pid/add",void 0,e)}async bindThreePid(e){return this.http.authedRequest(_.Method.Post,"/account/3pid/bind",void 0,e)}async unbindThreePid(e,t){let r={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)};return this.http.authedRequest(_.Method.Post,"/account/3pid/unbind",void 0,r)}deleteThreePid(e,t){return this.http.authedRequest(_.Method.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,r){return this.http.authedRequest(_.Method.Post,"/account/password",void 0,{auth:e,new_password:t,logout_devices:r})}getDevices(){return this.http.authedRequest(_.Method.Get,"/devices")}getDevice(e){let t=y.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(_.Method.Get,t)}setDeviceDetails(e,t){let r=y.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(_.Method.Put,r,void 0,t)}deleteDevice(e,t){let r=y.encodeUri("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(_.Method.Delete,r,void 0,i)}deleteMultipleDevices(e,t){let r={devices:e};return t&&(r.auth=t),this.http.authedRequest(_.Method.Post,"/delete_devices",void 0,r)}async getPushers(){let e=await this.http.authedRequest(_.Method.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map(e=>(e.hasOwnProperty(O.PUSHER_ENABLED.name)||(e[O.PUSHER_ENABLED.name]=!0),e))),e}setPusher(e){return this.http.authedRequest(_.Method.Post,"/pushers/set",void 0,e)}removePusher(e,t){return this.http.authedRequest(_.Method.Post,"/pushers/set",void 0,{pushkey:e,app_id:t,kind:null})}setLocalNotificationSettings(e,t){let r="".concat(O.LOCAL_NOTIFICATION_SETTINGS_PREFIX.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(_.Method.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=E.PushProcessor.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,i){let o=y.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(_.Method.Put,o,void 0,i)}deletePushRule(e,t,r){let i=y.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(_.Method.Delete,i)}setPushRuleEnabled(e,t,r,i){let o=y.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(_.Method.Put,o,void 0,{enabled:i})}setPushRuleActions(e,t,r,i){let o=y.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(_.Method.Put,o,void 0,{actions:i})}search(e,t){let{body:r,next_batch:i}=e,o={};return i&&(o.next_batch=i),this.http.authedRequest(_.Method.Post,"/search",o,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(_.Method.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(_.Method.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){let{token:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={device_keys:{}};return void 0!==t&&(r.token=t),e.forEach(e=>{r.device_keys[e]=[]}),this.http.authedRequest(_.Method.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,i={};for(let[r,o]of(void 0===t&&(t="signed_curve25519"),e)){let e=i[r]||{};(0,y.safeSet)(i,r,e),(0,y.safeSet)(e,o,t)}let o={one_time_keys:i};return r&&(o.timeout=r),this.http.authedRequest(_.Method.Post,"/keys/claim",void 0,o)}getKeyChanges(e,t){return this.http.authedRequest(_.Method.Get,"/keys/changes",{from:e,to:t})}uploadDeviceSigningKeys(e,t){let r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(_.Method.Post,"/keys/device_signing/upload",void 0,r,{prefix:_.ClientPrefix.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw Error("No identity server base URL set");let t=this.http.getUrl("/account/register",void 0,_.IdentityPrefix.V2,this.idBaseUrl);return this.http.requestOtherUrl(_.Method.Post,t,e)}requestEmailToken(e,t,r,i,o){let n={client_secret:t,email:e,send_attempt:null==r?void 0:r.toString()};return i&&(n.next_link=i),this.http.idServerRequest(_.Method.Post,"/validate/email/requestToken",n,_.IdentityPrefix.V2,o)}requestMsisdnToken(e,t,r,i,o,n){let s={client_secret:r,country:e,phone_number:t,send_attempt:null==i?void 0:i.toString()};return o&&(s.next_link=o),this.http.idServerRequest(_.Method.Post,"/validate/msisdn/requestToken",s,_.IdentityPrefix.V2,n)}submitMsisdnToken(e,t,r,i){return this.http.idServerRequest(_.Method.Post,"/validate/msisdn/submitToken",{sid:e,client_secret:t,token:r},_.IdentityPrefix.V2,null!=i?i:void 0)}submitMsisdnTokenOtherUrl(e,t,r,i){return this.http.requestOtherUrl(_.Method.Post,e,{sid:t,client_secret:r,token:i})}getIdentityHashDetails(e){return this.http.idServerRequest(_.Method.Get,"/hash_details",void 0,_.IdentityPrefix.V2,e)}async identityHashedLookup(e,t){let i={},o=await this.getIdentityHashDetails(t);if(!o||!o.lookup_pepper||!o.algorithms)throw Error("Unsupported identity server: bad response");i.pepper=o.lookup_pepper;let n={};if(o.algorithms.includes("sha256")){let t=new r.g.Olm.Utility;i.addresses=e.map(e=>{let r=e[0].toLowerCase(),o=e[1].toLowerCase(),s=t.sha256("".concat(r," ").concat(o," ").concat(i.pepper)).replace(/\+/g,"-").replace(/\//g,"_");return n[s]=e[0],s}),i.algorithm="sha256"}else if(o.algorithms.includes("none"))i.addresses=e.map(e=>{let t=e[0].toLowerCase(),r=e[1].toLowerCase(),i="".concat(t," ").concat(r);return n[i]=e[0],i}),i.algorithm="none";else throw Error("Unsupported identity server: unknown hash algorithm");let s=await this.http.idServerRequest(_.Method.Post,"/lookup",i,_.IdentityPrefix.V2,t);if(!(null!=s&&s.mappings))return[];let a=[];for(let e of Object.keys(s.mappings)){let t=s.mappings[e],r=n[e];if(!r)throw Error("Identity server returned more results than expected");a.push({address:r,mxid:t})}return a}async lookupThreePid(e,t,r){let i=(await this.identityHashedLookup([[t,e]],r)).find(e=>e.address===t);return i?{address:t,medium:e,mxid:i.mxid}:{}}async bulkLookupThreePids(e,t){let r=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),i=[];for(let t of r){let r=e.find(e=>e[1]===t.address);if(!r)throw Error("Identity sever returned unexpected results");i.push([r[0],t.address,t.mxid])}return{threepids:i}}getIdentityAccount(e){return this.http.idServerRequest(_.Method.Get,"/account",void 0,_.IdentityPrefix.V2,e)}sendToDevice(e,t,r){let i=y.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),o={messages:y.recursiveMapToObject(t)},n=new Map;for(let[e,r]of t)n.set(e,Array.from(r.keys()));return this.logger.debug("PUT ".concat(i),n),this.http.authedRequest(_.Method.Put,i,void 0,o)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(_.Method.Get,"/thirdparty/protocols").then(e=>{if(!e||"object"!=typeof e)throw Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){let r=y.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(_.Method.Get,r,t)}getThirdpartyUser(e,t){let r=y.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(_.Method.Get,r,t)}getTerms(e,t){let r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(_.Method.Get,r)}agreeToTerms(e,t,r,i){let o=this.termsUrlForService(e,t);return this.http.requestOtherUrl(_.Method.Post,o,{user_accepts:i},{headers:{Authorization:"Bearer "+r}})}reportEvent(e,t,r,i){let o=y.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(_.Method.Post,o,void 0,{score:r,reason:i})}getRoomHierarchy(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4?arguments[4]:void 0,n=y.encodeUri("/rooms/$roomId/hierarchy",{$roomId:e}),s={suggested_only:String(i),max_depth:null==r?void 0:r.toString(),from:o,limit:null==t?void 0:t.toString()};return this.http.authedRequest(_.Method.Get,n,s,void 0,{prefix:_.ClientPrefix.V1}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(_.Method.Get,n,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e})}async unstableCreateFileTree(e){let{room_id:t}=await this.createRoom({name:e,preset:N.Preset.PrivateChat,power_level_content_override:el(el({},G.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{},{users:{[this.getUserId()]:100}}),creation_content:{[O.RoomCreateTypeField]:O.RoomType.Space},initial_state:[{type:O.UNSTABLE_MSC3088_PURPOSE.name,state_key:O.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[O.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:O.EventType.RoomEncryption,state_key:"",content:{algorithm:R.MEGOLM_ALGORITHM}}]});return new G.MSC3089TreeSpace(this,t)}unstableGetFileTreeSpace(e){var t,r;let i=this.getRoom(e);if((null==i?void 0:i.getMyMembership())!=="join")return null;let o=i.currentState.getStateEvents(O.EventType.RoomCreate,""),n=i.currentState.getStateEvents(O.UNSTABLE_MSC3088_PURPOSE.name,O.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!o)throw Error("Expected single room create event");return null!=n&&null!==(t=n.getContent())&&void 0!==t&&t[O.UNSTABLE_MSC3088_ENABLED.name]&&(null===(r=o.getContent())||void 0===r?void 0:r[O.RoomCreateTypeField])===O.RoomType.Space?new G.MSC3089TreeSpace(this,e):null}slidingSync(e,t,r){let i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);let o=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(_.Method.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:o,abortSignal:r})}supportsExperimentalThreads(){var e;return this.logger.warn("supportsExperimentalThreads() is deprecated, use supportThreads() instead"),(null===(e=this.clientOpts)||void 0===e?void 0:e.experimentalThreadSupport)||!1}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(er.Feature.IntentionalMentions)!==er.ServerSupport.Unsupported}async getRoomSummary(e,t){let r=y.encodeUri("/rooms/$roomid/summary",{$roomid:e});return this.http.authedRequest(_.Method.Get,r,{via:t},void 0,{prefix:"/_matrix/client/unstable/im.nheko.summary"})}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(_.Method.Get,"/account/whoami")}async timestampToEvent(e,t,r){let i=y.encodeUri("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:r};try{return await this.http.authedRequest(_.Method.Get,i,o,void 0,{prefix:_.ClientPrefix.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return await this.http.authedRequest(_.Method.Get,i,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}}constructor(e){var t,r,i;super(),(0,l.default)(this,"reEmitter",new T.TypedReEmitter(this)),(0,l.default)(this,"olmVersion",null),(0,l.default)(this,"usingExternalCrypto",!1),(0,l.default)(this,"clientRunning",!1),(0,l.default)(this,"timelineSupport",!1),(0,l.default)(this,"urlPreviewCache",{}),(0,l.default)(this,"supportsCallTransfer",!1),(0,l.default)(this,"forceTURN",!1),(0,l.default)(this,"iceCandidatePoolSize",0),(0,l.default)(this,"canSupportVoip",!1),(0,l.default)(this,"peekSync",null),(0,l.default)(this,"isGuestAccount",!1),(0,l.default)(this,"ongoingScrollbacks",{}),(0,l.default)(this,"notifTimelineSet",null),(0,l.default)(this,"fallbackICEServerAllowed",!1),(0,l.default)(this,"syncedLeftRooms",!1),(0,l.default)(this,"canSupport",new Map),(0,l.default)(this,"pushProcessor",new E.PushProcessor(this)),(0,l.default)(this,"turnServers",[]),(0,l.default)(this,"turnServersExpiry",0),(0,l.default)(this,"txnCtr",0),(0,l.default)(this,"mediaHandler",new W.MediaHandler(this)),(0,l.default)(this,"eventsBeingEncrypted",new Set),(0,l.default)(this,"useE2eForGroupCall",!0),(0,l.default)(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&((0,p.supportsMatrixCall)()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(em.Sync,this.startCallEventHandler))}),(0,l.default)(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(em.Sync,this.startMatrixRTC))}),(0,l.default)(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var e;for(let t of(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter(e=>e.getUnreadNotificationCount($.NotificationCountType.Total)>0)){let e=this.getSafeUserId();t.fixupNotifications(e)}this.off(em.Sync,this.fixupRoomNotifications)}}),this.logger=null!==(t=e.logger)&&void 0!==t?t:I.logger,e.baseUrl=y.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=y.ensureNoTrailingSlash(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(r=e.usingExternalCrypto)&&void 0!==r&&r,this.store=e.store||new u.StubStore,this.deviceId=e.deviceId||null,this.sessionId=(0,F.randomString)(10);let o=e.userId||null;this.credentials={userId:o},this.http=new _.MatrixHttpApi(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:_.ClientPrefix.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async e=>{let t=this.getRoom(e.getRoomId());e.status!==c.EventStatus.SENDING&&this.updatePendingEventStatus(t,e,c.EventStatus.SENDING);let r=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,c.EventStatus.SENT,r.event_id),r}),(0,p.supportsMatrixCall)()&&(this.callEventHandler=new v.CallEventHandler(this),this.groupCallEventHandler=new m.GroupCallEventHandler(this),this.canSupportVoip=!0,this.on(em.Sync,this.startCallEventHandler)),this.matrixRTC=new en.MatrixRTCSessionManager(this),this.on(em.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new ee.ToDeviceMessageQueue(this),this.on(c.MatrixEventEvent.Decrypted,e=>{eE(this,e)}),this.on($.RoomEvent.Receipt,(e,t)=>{if(null!=t&&t.hasEncryptionStateEvent()){let i=e.getContent();if(!(Object.keys(i).filter(e=>{for(let[t,r]of Object.entries(i[e]))if(y.isSupportedReceiptType(t)&&r&&Object.keys(r).includes(this.getUserId()))return!0;return!1}).length>0))return;let o=t.getLiveTimeline().getEvents(),n=0;for(let e=o.length-1;e>=0;e--){var r;if(e===o.length-20)return;let i=o[e];if(t.hasUserReadEvent(this.getUserId(),i.getId()))break;let s=this.getPushActionsForEvent(i);n+=null!=s&&null!==(r=s.tweaks)&&void 0!==r&&r.highlight?1:0}t.setUnreadNotificationCount($.NotificationCountType.Highlight,n)}}),this.ignoredInvites=new et.IgnoredInvites(this),this._secretStorage=new eo.ServerSideSecretStorageImpl(this,null!==(i=e.cryptoCallbacks)&&void 0!==i?i:{}),this.setMaxListeners(0)}}function eE(e,t){var r;let i;let o=e.getUserId(),n=t.getId(),s=e.getRoom(t.getRoomId());if(!s||!o||!n)return;if(!s.findEventById(n)){I.logger.info("Decrypted event ".concat(t.getId()," is not in room ").concat(s.roomId,": ignoring"));return}let a=!!t.threadRootId&&!t.isThreadRoot;if(a){let e=s.getThread(t.threadRootId);i=!e||e.hasUserReadEvent(o,n)}else i=s.hasUserReadEvent(o,n);if(i)return;let d=e.getPushActionsForEvent(t,!0);if(null!=d&&null!==(r=d.tweaks)&&void 0!==r&&r.highlight){let e=s.getUnreadCountForEventContext($.NotificationCountType.Highlight,t)+1;a?s.setThreadUnreadNotificationCount(t.threadRootId,$.NotificationCountType.Highlight,e):s.setUnreadNotificationCount($.NotificationCountType.Highlight,e)}if(null!=d&&d.notify){let e=s.getUnreadCountForEventContext($.NotificationCountType.Total,t)+1;a?s.setThreadUnreadNotificationCount(t.threadRootId,$.NotificationCountType.Total,e):s.setUnreadNotificationCount($.NotificationCountType.Total,e)}}function eS(e){return eR(e)?Q.MAIN_ROOM_TIMELINE:e.threadRootId}function eR(e){return!e.threadRootId||!!e.isThreadRoot||(e.isRelation()?!e.isRelation(J.THREAD_RELATION_TYPE.name)&&e.relationEventId===e.threadRootId:(I.logger.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(e.getId())),!0))}t.MatrixClient=ef,(0,l.default)(ef,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}}]);