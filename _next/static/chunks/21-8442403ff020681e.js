(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[21],{6691:function(e){"use strict";for(var t=/[\\\"\x00-\x1F]/g,r={},n=0;n<32;++n)r[String.fromCharCode(n)]="\\U"+("0000"+n.toString(16)).slice(-4).toUpperCase();function i(e){return t.lastIndex=0,e.replace(t,function(e){return r[e]})}function o(e){switch(typeof e){case"string":return'"'+i(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":if(null===e)return"null";if(Array.isArray(e))return s(e);return a(e);default:throw Error("Cannot stringify: "+typeof e)}}function s(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=o(e[n]);return","!=t?"[]":r+"]"}function a(e){var t="{",r="",n=Object.keys(e);n.sort();for(var s=0;s<n.length;++s){var a=n[s];r+=t+'"'+i(a)+'":',t=",",r+=o(e[a])}return","!=t?"{}":r+"}"}r["\b"]="\\b",r["	"]="\\t",r["\n"]="\\n",r["\f"]="\\f",r["\r"]="\\r",r['"']='\\"',r["\\"]="\\\\",e.exports={stringify:o}},9766:function(e){"use strict";function t(e){if(e.length>=255)throw TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var n=0;n<e.length;n++){var i=e.charAt(n),o=i.charCodeAt(0);if(255!==t[o])throw TypeError(i+" is ambiguous");t[o]=n}var s=e.length,a=e.charAt(0),l=Math.log(s)/Math.log(256),c=Math.log(256)/Math.log(s);function d(e){if("string"!=typeof e)throw TypeError("Expected String");if(0===e.length)return new Uint8Array;for(var r=0,n=0,i=0;e[r]===a;)n++,r++;for(var o=(e.length-r)*l+1>>>0,c=new Uint8Array(o);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var u=0,h=o-1;(0!==d||u<i)&&-1!==h;h--,u++)d+=s*c[h]>>>0,c[h]=d%256>>>0,d=d/256>>>0;if(0!==d)throw Error("Non-zero carry");i=u,r++}for(var p=o-i;p!==o&&0===c[p];)p++;for(var f=new Uint8Array(n+(o-p)),g=n;p!==o;)f[g++]=c[p++];return f}function u(e){var t=d(e);if(t)return t;throw Error("Non-base"+s+" character")}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,i=0,o=t.length;i!==o&&0===t[i];)i++,r++;for(var l=(o-i)*c+1>>>0,d=new Uint8Array(l);i!==o;){for(var u=t[i],h=0,p=l-1;(0!==u||h<n)&&-1!==p;p--,h++)u+=256*d[p]>>>0,d[p]=u%s>>>0,u=u/s>>>0;if(0!==u)throw Error("Non-zero carry");n=h,i++}for(var f=l-n;f!==l&&0===d[f];)f++;for(var g=a.repeat(r);f<l;++f)g+=e.charAt(d[f]);return g},decodeUnsafe:d,decode:u}}e.exports=t},54895:function(e,t,r){"use strict";let n=r(9766),i="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";e.exports=n(i)},91333:function(e,t){"use strict";/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var r=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,n=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,o=/\\([\u000b\u0020-\u00ff])/g,s=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function l(e){if(!e||"object"!=typeof e)throw TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!a.test(r))throw TypeError("invalid type");var n=r;if(t&&"object"==typeof t)for(var o,s=Object.keys(t).sort(),l=0;l<s.length;l++){if(o=s[l],!i.test(o))throw TypeError("invalid parameter name");n+="; "+o+"="+u(t[o])}return n}function c(e){if(!e)throw TypeError("argument string is required");var t,n,i,s="object"==typeof e?d(e):e;if("string"!=typeof s)throw TypeError("argument string is required to be a string");var l=s.indexOf(";"),c=-1!==l?s.slice(0,l).trim():s.trim();if(!a.test(c))throw TypeError("invalid media type");var u=new h(c.toLowerCase());if(-1!==l){for(r.lastIndex=l;n=r.exec(s);){if(n.index!==l)throw TypeError("invalid parameter format");l+=n[0].length,t=n[1].toLowerCase(),34===(i=n[2]).charCodeAt(0)&&-1!==(i=i.slice(1,-1)).indexOf("\\")&&(i=i.replace(o,"$1")),u.parameters[t]=i}if(l!==s.length)throw TypeError("invalid parameter format")}return u}function d(e){var t;if("function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!=typeof t)throw TypeError("content-type header is missing from object");return t}function u(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!n.test(t))throw TypeError("invalid parameter value");return'"'+t.replace(s,"\\$1")+'"'}function h(e){this.parameters=Object.create(null),this.type=e}t.format=l,t.parse=c},28389:function(e,t,r){"use strict";!function(r,n){e.exports=t=n()}(0,function(){var e=e||function(e,t){if(window.crypto&&(n=window.crypto),"undefined"!=typeof self&&self.crypto&&(n=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(n=globalThis.crypto),!n&&window.msCrypto&&(n=window.msCrypto),!n&&void 0!==r.g&&r.g.crypto&&(n=r.g.crypto),!n)try{n=r(91054)}catch(e){}var n,i=function(){if(n){if("function"==typeof n.getRandomValues)try{return n.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof n.randomBytes)try{return n.randomBytes(4).readInt32LE()}catch(e){}}throw Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),s={},a=s.lib={},l=a.Base=function(){return{extend:function(e){var t=o(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),c=a.WordArray=l.extend({init:function(e,t){e=this.words=e||[],void 0!=t?this.sigBytes=t:this.sigBytes=4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var o=0;o<i;o++){var s=r[o>>>2]>>>24-o%4*8&255;t[n+o>>>2]|=s<<24-(n+o)%4*8}else for(var a=0;a<i;a+=4)t[n+a>>>2]=r[a>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=l.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(i());return new c.init(t,e)}}),d=s.enc={},u=d.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new c.init(r,t/2)}},h=d.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new c.init(r,t)}},p=d.Utf8={stringify:function(e){try{return decodeURIComponent(escape(h.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return h.parse(unescape(encodeURIComponent(e)))}},f=a.BufferedBlockAlgorithm=l.extend({reset:function(){this._data=new c.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=p.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,n=this._data,i=n.words,o=n.sigBytes,s=this.blockSize,a=o/(4*s),l=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,d=e.min(4*l,o);if(l){for(var u=0;u<l;u+=s)this._doProcessBlock(i,u);r=i.splice(0,l),n.sigBytes-=d}return new c.init(r,d)},clone:function(){var e=l.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});a.Hasher=f.extend({cfg:l.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){f.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new g.HMAC.init(e,r).finalize(t)}}});var g=s.algo={};return s}(Math);return e})},30146:function(e,t,r){"use strict";!function(n,i){e.exports=t=i(r(28389))}(0,function(e){return!function(){var t=e,r=t.lib.WordArray;function n(e,t,n){for(var i=[],o=0,s=0;s<t;s++)if(s%4){var a=n[e.charCodeAt(s-1)]<<s%4*2|n[e.charCodeAt(s)]>>>6-s%4*2;i[o>>>2]|=a<<24-o%4*8,o++}return r.create(i,o)}t.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var i=[],o=0;o<r;o+=3)for(var s=(t[o>>>2]>>>24-o%4*8&255)<<16|(t[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|t[o+2>>>2]>>>24-(o+2)%4*8&255,a=0;a<4&&o+.75*a<r;a++)i.push(n.charAt(s>>>6*(3-a)&63));var l=n.charAt(64);if(l)for(;i.length%4;)i.push(l);return i.join("")},parse:function(e){var t=e.length,r=this._map,i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var o=0;o<r.length;o++)i[r.charCodeAt(o)]=o}var s=r.charAt(64);if(s){var a=e.indexOf(s);-1!==a&&(t=a)}return n(e,t,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),e.enc.Base64})},11892:function(e,t,r){"use strict";!function(n,i){e.exports=t=i(r(28389))}(0,function(e){return e.enc.Utf8})},46445:function(e,t,r){"use strict";!function(n,i){e.exports=t=i(r(28389))}(0,function(e){return!function(t){var r=e,n=r.lib,i=n.WordArray,o=n.Hasher,s=r.algo,a=[],l=[];!function(){function e(e){for(var r=t.sqrt(e),n=2;n<=r;n++)if(!(e%n))return!1;return!0}function r(e){return(e-(0|e))*4294967296|0}for(var n=2,i=0;i<64;)e(n)&&(i<8&&(a[i]=r(t.pow(n,.5))),l[i]=r(t.pow(n,1/3)),i++),n++}();var c=[],d=s.SHA256=o.extend({_doReset:function(){this._hash=new i.init(a.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],i=r[1],o=r[2],s=r[3],a=r[4],d=r[5],u=r[6],h=r[7],p=0;p<64;p++){if(p<16)c[p]=0|e[t+p];else{var f=c[p-15],g=(f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,m=c[p-2],v=(m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10;c[p]=g+c[p-7]+v+c[p-16]}var y=a&d^~a&u,b=n&i^n&o^i&o,S=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),E=h+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+y+l[p]+c[p],_=S+b;h=u,u=d,d=a,a=s+E|0,s=o,o=i,i=n,n=E+_|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+o|0,r[3]=r[3]+s|0,r[4]=r[4]+a|0,r[5]=r[5]+d|0,r[6]=r[6]+u|0,r[7]=r[7]+h|0},_doFinalize:function(){var e=this._data,r=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;return r[i>>>5]|=128<<24-i%32,r[(i+64>>>9<<4)+14]=t.floor(n/4294967296),r[(i+64>>>9<<4)+15]=n,e.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});r.SHA256=o._createHelper(d),r.HmacSHA256=o._createHmacHelper(d)}(Math),e.SHA256})},67779:function(e){"use strict";var t,r="object"==typeof Reflect?Reflect:null,n=r&&"function"==typeof r.apply?r.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};function i(e){console&&console.warn&&console.warn(e)}t=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=y,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){if(l(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),void 0===a)a=s[t]=r,++e._eventsCount;else if("function"==typeof a?a=s[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),(o=c(e))>0&&a.length>o&&!a.warned){a.warned=!0;var o,s,a,d=Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=a.length,i(d)}return e}function u(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=u.bind(n);return i.listener=r,n.wrapFn=i,i}function p(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?v(i):g(i,i.length)}function f(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=Array(t),n=0;n<t;++n)r[n]=e[n];return r}function m(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function v(e){for(var t=Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function y(e,t){return new Promise(function(r,n){function i(r){e.removeListener(t,o),n(r)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}S(e,t,o,{once:!0}),"error"!==t&&b(e,i,{once:!0})})}function b(e,t,r){"function"==typeof e.on&&S(e,"error",t,r)}function S(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else if("function"==typeof e.addEventListener)e.addEventListener(t,function i(o){n.once&&e.removeEventListener(t,i),r(o)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||o(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),s.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var s,a=Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)n(l,this,t);else for(var c=l.length,d=g(l,c),r=0;r<c;++r)n(d[r],this,t);return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){return l(t),this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var r,n,i,o,s;if(l(t),void 0===(n=this._events)||void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():m(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0==arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},s.prototype.listeners=function(e){return p(this,e,!0)},s.prototype.rawListeners=function(e){return p(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},9104:function(e,t,r){"use strict";function n(e){this.message=e}r.r(t),r.d(t,{InvalidTokenError:function(){return s}}),n.prototype=Error(),n.prototype.name="InvalidCharacterError";var i=window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new n("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,i,o=0,s=0,a="";i=t.charAt(s++);~i&&(r=o%4?64*r+i:i,o++%4)&&(a+=String.fromCharCode(255&r>>(-2*o&6))))i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return a};function o(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(i(e).replace(/(.)/g,function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}(t)}catch(e){return i(t)}}function s(e){this.message=e}function a(e,t){if("string"!=typeof e)throw new s("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(o(e.split(".")[r]))}catch(e){throw new s("Invalid token specified: "+e.message)}}s.prototype=Error(),s.prototype.name="InvalidTokenError",t.default=a},42954:function(e,t,r){"use strict";var n,i;!function(o,s){void 0!==(i="function"==typeof(n=s)?n.call(t,r,t,e):n)&&(e.exports=i)}(0,function(){var e=function(){},t="undefined",r="object"!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],i={},o=null;function s(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?a:void 0!==console[n]?s(console,n):void 0!==console.log?s(console,"log"):e)}function c(){for(var r=this.getLevel(),i=0;i<n.length;i++){var o=n[i];this[o]=i<r?e:this.methodFactory(o,r,this.name)}if(this.log=this.debug,typeof console===t&&r<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function u(e,t,r){return l(e)||d.apply(this,arguments)}function h(e,r){var s,a,l,d=this,h="loglevel";function p(e){var r=(n[e]||"silent").toUpperCase();if("object"!==t&&h){try{window.localStorage[h]=r;return}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+r+";"}catch(e){}}}function f(){var e;if("object"!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=encodeURIComponent(h),i=r.indexOf(n+"=");-1!==i&&(e=/^([^;]+)/.exec(r.slice(i+n.length+1))[1])}catch(e){}return void 0===d.levels[e]&&(e=void 0),e}}function g(){if("object"!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function m(e){var t=e;if("string"==typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=r||u,d.getLevel=function(){return null!=l?l:null!=a?a:s},d.setLevel=function(e,t){return l=m(e),!1!==t&&p(l),c.call(d)},d.setDefaultLevel=function(e){a=m(e),f()||d.setLevel(e,!1)},d.resetLevel=function(){l=null,g(),c.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(o!==d&&(s=m(o.getLevel())),c.call(d),o===d)for(var e in i)i[e].rebuild()},s=m(o?o.getLevel():"WARN");var v=f();null!=v&&(l=m(v)),c.call(d)}(o=new h).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new h(e,o.methodFactory)),t};var p="object"!==t?window.log:void 0;return o.noConflict=function(){return"object"!==t&&window.log===o&&(window.log=p),o},o.getLoggers=function(){return i},o.default=o,o})},96015:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var n=r(28367),i=r(72018),o=r(16952),s=r(86033),a=r(74204),l=r(77744),c=r(914);function d(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=u(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function u(e,t){if(e){if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return h(e,t)}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function p(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function g(e,t,r){return t&&f(e.prototype,t),r&&f(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var v=function(){function e(){p(this,e),m(this,"interpreters",new n.NamespacedMap([[o.LEGACY_M_ROOM_MESSAGE,o.parseMRoomMessage],[a.M_MESSAGE,s.parseMMessage],[a.M_EMOTE,s.parseMMessage],[a.M_NOTICE,s.parseMMessage],[l.M_POLL_START,c.parseMPoll],[l.M_POLL_RESPONSE,c.parseMPoll],[l.M_POLL_END,c.parseMPoll]])),m(this,"_unknownInterpretOrder",[a.M_MESSAGE])}return g(e,[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,r=d(this.unknownInterpretOrder);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this.interpreters.has(n)){var o=this.interpreters.get(n)(e);if(o)return o}}}catch(e){r.e(e)}finally{r.f()}return null}catch(e){if(e instanceof i.InvalidEventError)return null;throw e}}}],[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,r){e.defaultInstance.registerInterpreter(t,r)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}]),e}();t.ExtensibleEvents=v,m(v,"_defaultInstance",new v)},72639:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},72018:function(e,t){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function s(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function a(e){var t=h();return function(){var r,n=g(e);if(t){var i=g(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return l(this,r)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return c(e)}function c(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){var t="function"==typeof Map?new Map:void 0;return(d=function(e){if(null===e||!p(e))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,g(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),f(r,e)})(e)}function u(e,t,r){return(u=h()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&f(i,r.prototype),i}).apply(null,arguments)}function h(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function p(e){return -1!==Function.toString.call(e).indexOf("[native code]")}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var m=function(e){s(r,e);var t=a(r);function r(e){return o(this,r),t.call(this,e)}return i(r)}(d(Error));t.InvalidEventError=m},28367:function(e,t){"use strict";function r(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=n(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){l=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(l)throw s}}}}function n(e,t){if(e){if("string"==typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return i(e,t)}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function o(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var c=function(){function e(t){if(o(this,e),l(this,"internalMap",new Map),t){var n,i=r(t);try{for(i.s();!(n=i.n()).done;){var s=n.value;this.set(s[0],s[1])}}catch(e){i.e(e)}finally{i.f()}}}return a(e,[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}]),e}();t.NamespacedMap=c},29239:function(e,t){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){var t=l();return function(){var r,n=c(e);if(t){var i=c(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return s(this,r)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return a(e)}function a(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var p=function(){function e(t,r){if(d(this,e),this.stable=t,this.unstable=r,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}return h(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=p;var f=function(e){n(r,e);var t=o(r);function r(e,n){var i;if(d(this,r),!(i=t.call(this,e,n)).unstable)throw Error("Unstable value must be supplied");return i}return h(r,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),r}(p);t.UnstableValue=f},93960:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var i=r(4185),o=r(74204),s=r(92761);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=h(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}}).apply(this,arguments)}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=b(e)););return e}function p(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){var t=y();return function(){var r,n=b(e);if(t){var i=b(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return m(this,r)}}function m(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var S=function(e){p(r,e);var t=g(r);function r(e){return l(this,r),t.call(this,e)}return d(r,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_EMOTE)||u(b(r.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(b(r.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}],[{key:"from",value:function(e,t){var n;return new r({type:o.M_EMOTE.name,content:(a(n={},o.M_TEXT.name,e),a(n,o.M_HTML.name,t),n)})}}]),r}(i.MessageEvent);t.EmoteEvent=S},41503:function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var o=function(){function e(t){r(this,e),this.wireFormat=t}return i(e,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),e}();t.ExtensibleEvent=o},4185:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var i=r(41503),o=r(58538),s=r(72018),a=r(74204),l=r(92761);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){E(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function p(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function f(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e){var t=b();return function(){var r,n=S(e);if(t){var i=S(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return v(this,r)}}function v(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return y(e)}function y(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var _=function(e){f(r,e);var t=m(r);function r(e){u(this,r),E(y(n=t.call(this,e)),"text",void 0),E(y(n),"html",void 0),E(y(n),"renderings",void 0);var n,i=a.M_MESSAGE.findIn(n.wireContent),l=a.M_TEXT.findIn(n.wireContent),c=a.M_HTML.findIn(n.wireContent);if((0,o.isProvided)(i)){if(!Array.isArray(i))throw new s.InvalidEventError("m.message contents must be an array");var d=i.find(function(e){return!(0,o.isProvided)(e.mimetype)||"text/plain"===e.mimetype}),h=i.find(function(e){return"text/html"===e.mimetype});if(!d)throw new s.InvalidEventError("m.message is missing a plain text representation");n.text=d.body,n.html=null==h?void 0:h.body,n.renderings=i}else if((0,o.isOptionalAString)(l))n.text=l,n.html=c,n.renderings=[{body:l,mimetype:"text/plain"}],n.html&&n.renderings.push({body:n.html,mimetype:"text/html"});else throw new s.InvalidEventError("Missing textual representation for event");return n}return p(r,[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=E({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;(void 0===t||"text/plain"===t)&&(e=E({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}],[{key:"from",value:function(e,t){var n;return new r({type:a.M_MESSAGE.name,content:(E(n={},a.M_TEXT.name,e),E(n,a.M_HTML.name,t),n)})}}]),r}(i.ExtensibleEvent);t.MessageEvent=_},38861:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var i=r(4185),o=r(74204),s=r(92761);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=h(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}}).apply(this,arguments)}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=b(e)););return e}function p(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){var t=y();return function(){var r,n=b(e);if(t){var i=b(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return m(this,r)}}function m(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var S=function(e){p(r,e);var t=g(r);function r(e){return l(this,r),t.call(this,e)}return d(r,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_NOTICE)||u(b(r.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(b(r.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}],[{key:"from",value:function(e,t){var n;return new r({type:o.M_NOTICE.name,content:(a(n={},o.M_TEXT.name,e),a(n,o.M_HTML.name,t),n)})}}]),r}(i.MessageEvent);t.NoticeEvent=S},88053:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var i=r(77744),o=r(72018),s=r(11912),a=r(4185),l=r(74204),c=r(92761);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){_(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function h(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,r){return t&&p(e.prototype,t),r&&p(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){var t=S();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}function y(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return b(e)}function b(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function E(e){return(E=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var w=function(e){g(r,e);var t=v(r);function r(e){h(this,r),_(b(n=t.call(this,e)),"pollEventId",void 0),_(b(n),"closingMessage",void 0);var n,i=n.wireContent["m.relates_to"];if(!s.REFERENCE_RELATION.matches(null==i?void 0:i.rel_type)||"string"!=typeof(null==i?void 0:i.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=i.event_id,n.closingMessage=new a.MessageEvent(n.wireFormat),n}return f(r,[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,i.M_POLL_END)}},{key:"serialize",value:function(){return{type:i.M_POLL_END.name,content:u(_({"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:this.pollEventId}},i.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(e,t){var n;return new r({type:i.M_POLL_END.name,content:(_(n={"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:e}},i.M_POLL_END.name,{}),_(n,l.M_TEXT.name,t),n)})}}]),r}(r(41503).ExtensibleEvent);t.PollEndEvent=w},60062:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var i=r(41503),o=r(77744),s=r(72018),a=r(11912),l=r(92761);function c(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e){var t=v();return function(){var r,n=y(e);if(t){var i=y(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return g(this,r)}}function g(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return m(e)}function m(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var S=function(e){h(r,e);var t=f(r);function r(e){c(this,r),b(m(n=t.call(this,e)),"internalAnswerIds",void 0),b(m(n),"internalSpoiled",void 0),b(m(n),"pollEventId",void 0);var n,i=n.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null==i?void 0:i.rel_type)||"string"!=typeof(null==i?void 0:i.event_id))throw new s.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=i.event_id,n.validateAgainst(null),n}return u(r,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=o.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var r=t.answers;if(r.some(function(e){return"string"!=typeof e})||0===r.length){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(e){if(r.some(function(t){return!e.answers.some(function(e){return e.id===t})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}r=r.slice(0,e.maxSelections)}this.internalAnswerIds=r,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,o.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:o.M_POLL_RESPONSE.name,content:b({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},o.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(e,t){return new r({type:o.M_POLL_RESPONSE.name,content:b({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},o.M_POLL_RESPONSE.name,{answers:e})})}}]),r}(i.ExtensibleEvent);t.PollResponseEvent=S},25461:function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var i=r(77744),o=r(4185),s=r(74204),a=r(72018),l=r(29239),c=r(92761),d=r(41503);function u(e){return g(e)||f(e)||p(e)||h()}function h(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function p(e,t){if(e){if("string"==typeof e)return m(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return m(e,t)}}function f(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function g(e){if(Array.isArray(e))return m(e)}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){k(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function b(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function S(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function E(e,t,r){return t&&S(e.prototype,t),r&&S(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&w(e,t)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){var t=R();return function(){var r,n=C(e);if(t){var i=C(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return I(this,r)}}function I(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return O(e)}function O(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function R(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function C(e){return(C=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var M=function(e){_(r,e);var t=T(r);function r(e){b(this,r),k(O(n=t.call(this,e)),"id",void 0);var n,i=e.content.id;if(!i||"string"!=typeof i)throw new a.InvalidEventError("Answer ID must be a non-empty string");return n.id=i,n}return E(r,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:y({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new r({type:"org.matrix.sdk.poll.answer",content:k({id:e},s.M_TEXT.name,t)})}}]),r}(o.MessageEvent);t.PollAnswerSubevent=M;var P=function(e){_(r,e);var t=T(r);function r(e){b(this,r),k(O(n=t.call(this,e)),"question",void 0),k(O(n),"kind",void 0),k(O(n),"rawKind",void 0),k(O(n),"maxSelections",void 0),k(O(n),"answers",void 0);var n,s=i.M_POLL_START.findIn(n.wireContent);if(!s.question)throw new a.InvalidEventError("A question is required");if(n.question=new o.MessageEvent({type:"org.matrix.sdk.poll.question",content:s.question}),n.rawKind=s.kind,i.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=i.M_POLL_KIND_DISCLOSED:n.kind=i.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(s.max_selections)&&s.max_selections>0?s.max_selections:1,!Array.isArray(s.answers))throw new a.InvalidEventError("Poll answers must be an array");var l=s.answers.slice(0,20).map(function(e){return new M({type:"org.matrix.sdk.poll.answer",content:e})});if(l.length<=0)throw new a.InvalidEventError("No answers available");return n.answers=l,n}return E(r,[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,i.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:i.M_POLL_START.name,content:(k(e={},i.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(e){return e.serialize().content})}),k(e,s.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map(function(e,t){return"".concat(t+1,". ").concat(e.text)}).join("\n"))),e)}}}],[{key:"from",value:function(e,t,n){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new r({type:i.M_POLL_START.name,content:(k(o={},s.M_TEXT.name,e),k(o,i.M_POLL_START.name,{question:k({},s.M_TEXT.name,e),kind:n instanceof l.NamespacedValue?n.name:n,max_selections:a,answers:t.map(function(e){return k({id:D()},s.M_TEXT.name,e)})}),o)})}}]),r}(d.ExtensibleEvent);t.PollStartEvent=P;var A="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function D(){return u(Array(16)).map(function(){return A.charAt(Math.floor(Math.random()*A.length))}).join("")}},74204:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var n=r(29239),i=new n.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=i;var o=new n.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=o;var s=new n.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=s;var a=new n.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var l=new n.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=l},77744:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var n=r(29239),i=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=i;var o=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=o;var s=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=s;var a=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var l=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=l},11912:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var n=new(r(29239)).NamespacedValue("m.reference");t.REFERENCE_RELATION=n},33653:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(96015);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))});var i=r(72639);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(72018);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var s=r(29239);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var a=r(28367);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var l=r(58538);Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var c=r(89643);Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))});var d=r(92761);Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(16952);Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(86033);Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var p=r(914);Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var f=r(11912);Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))});var g=r(41503);Object.keys(g).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))});var m=r(74204);Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))});var v=r(4185);Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))});var y=r(93960);Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))});var b=r(38861);Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))});var S=r(77744);Object.keys(S).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))});var E=r(25461);Object.keys(E).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))});var _=r(60062);Object.keys(_).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))});var w=r(88053);Object.keys(w).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))})},16952:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=h;var n=r(4185),i=r(38861),o=r(93960),s=r(29239),a=r(74204);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){d(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var u=new s.NamespacedValue("m.room.message");function h(e){if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new n.MessageEvent(e);var t,r,s,l,u,h,p=null===(t=e.content)||void 0===t?void 0:t.msgtype,f=null===(r=e.content)||void 0===r?void 0:r.body,g=(null===(s=e.content)||void 0===s?void 0:s.format)==="org.matrix.custom.html"?e.content.formatted_body:null;return"m.text"===p?new n.MessageEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(l={},a.M_TEXT.name,f),d(l,a.M_HTML.name,g),l))})):"m.notice"===p?new i.NoticeEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(u={},a.M_TEXT.name,f),d(u,a.M_HTML.name,g),u))})):"m.emote"===p?new o.EmoteEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(h={},a.M_TEXT.name,f),d(h,a.M_HTML.name,g),h))})):null}t.LEGACY_M_ROOM_MESSAGE=u},86033:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=a;var n=r(4185),i=r(74204),o=r(93960),s=r(38861);function a(e){return i.M_EMOTE.matches(e.type)?new o.EmoteEvent(e):i.M_NOTICE.matches(e.type)?new s.NoticeEvent(e):new n.MessageEvent(e)}},914:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=a;var n=r(77744),i=r(25461),o=r(60062),s=r(88053);function a(e){return n.M_POLL_START.matches(e.type)?new i.PollStartEvent(e):n.M_POLL_RESPONSE.matches(e.type)?new o.PollResponseEvent(e):n.M_POLL_END.matches(e.type)?new s.PollEndEvent(e):null}},58538:function(e,t){"use strict";function r(e){return n(e)&&"string"==typeof e}function n(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=r,t.isProvided=n},89643:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=o;var n,i=r(74204);function o(e,t){var r=e.content;return t===n.Text?i.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.text":t===n.Emote?i.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.emote":t===n.Notice&&(i.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.notice")}t.LegacyMsgType=n,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(n||(t.LegacyMsgType=n={}))},92761:function(e,t){"use strict";function r(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=r},77897:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},49820:function(e,t){"use strict";function r(e){return"==2"===e||"2"===e}Object.defineProperty(t,"__esModule",{value:!0}),t.TweakName=t.RuleId=t.PushRuleKind=t.PushRuleActionName=t.DMMemberCountCondition=t.ConditionOperator=t.ConditionKind=void 0,t.isDmMemberCountCondition=r,t.PushRuleActionName=function(e){return e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e}({}),t.TweakName=function(e){return e.Highlight="highlight",e.Sound="sound",e}({}),t.ConditionOperator=function(e){return e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<=",e}({}),t.DMMemberCountCondition="2",t.ConditionKind=function(e){return e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.EventPropertyContains="event_property_contains",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started",e}({}),t.PushRuleKind=function(e){return e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e}({}),t.RuleId=function(e){return e.Master=".m.rule.master",e.IsUserMention=".m.rule.is_user_mention",e.IsRoomMention=".m.rule.is_room_mention",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({})},19905:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SSOAction=t.IdentityProviderBrand=t.DELEGATED_OIDC_COMPATIBILITY=void 0;var n=r(87225);t.DELEGATED_OIDC_COMPATIBILITY=new n.UnstableValue("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),t.IdentityProviderBrand=function(e){return e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter",e}({}),t.SSOAction=function(e){return e.LOGIN="login",e.REGISTER="register",e}({})},42e3:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_BEACON_INFO=t.M_BEACON=void 0;var n=r(87225);t.M_BEACON_INFO=new n.UnstableValue("m.beacon_info","org.matrix.msc3672.beacon_info"),t.M_BEACON=new n.UnstableValue("m.beacon","org.matrix.msc3672.beacon")},35095:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},15748:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UNSTABLE_MSC3089_TREE_SUBTYPE=t.UNSTABLE_MSC3089_LEAF=t.UNSTABLE_MSC3089_BRANCH=t.UNSTABLE_MSC3088_PURPOSE=t.UNSTABLE_MSC3088_ENABLED=t.UNSTABLE_MSC2716_MARKER=t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=t.UNSIGNED_THREAD_ID_FIELD=t.ToDeviceMessageId=t.RoomType=t.RoomCreateTypeField=t.RelationType=t.PUSHER_ENABLED=t.PUSHER_DEVICE_ID=t.MsgType=t.MSC3912_RELATION_BASED_REDACTIONS_PROP=t.LOCAL_NOTIFICATION_SETTINGS_PREFIX=t.EventType=t.EVENT_VISIBILITY_CHANGE_TYPE=void 0;var n=r(87225);t.EventType=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.CallNotify="org.matrix.msc4075.call.notify",e}({}),t.RelationType=function(e){return e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread",e}({}),t.MsgType=function(e){return e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request",e}({}),t.RoomCreateTypeField="type",t.RoomType=function(e){return e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e}({}),t.ToDeviceMessageId="org.matrix.msgid",t.UNSTABLE_MSC3088_PURPOSE=new n.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose"),t.UNSTABLE_MSC3088_ENABLED=new n.UnstableValue("m.enabled","org.matrix.msc3088.enabled"),t.UNSTABLE_MSC3089_TREE_SUBTYPE=new n.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree"),t.UNSTABLE_MSC3089_LEAF=new n.UnstableValue("m.leaf","org.matrix.msc3089.leaf"),t.UNSTABLE_MSC3089_BRANCH=new n.UnstableValue("m.branch","org.matrix.msc3089.branch"),t.UNSTABLE_MSC2716_MARKER=new n.UnstableValue("m.room.marker","org.matrix.msc2716.marker"),t.MSC3912_RELATION_BASED_REDACTIONS_PROP=new n.UnstableValue("with_rel_types","org.matrix.msc3912.with_relations"),t.UNSTABLE_ELEMENT_FUNCTIONAL_USERS=new n.UnstableValue("io.element.functional_members","io.element.functional_members"),t.EVENT_VISIBILITY_CHANGE_TYPE=new n.UnstableValue("m.visibility","org.matrix.msc3531.visibility"),t.PUSHER_ENABLED=new n.UnstableValue("enabled","org.matrix.msc3881.enabled"),t.PUSHER_DEVICE_ID=new n.UnstableValue("device_id","org.matrix.msc3881.device_id"),t.LOCAL_NOTIFICATION_SETTINGS_PREFIX=new n.UnstableValue("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),t.UNSIGNED_THREAD_ID_FIELD=new n.UnstableValue("thread_id","org.matrix.msc4023.thread_id")},9792:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=t.M_TEXT=t.M_MESSAGE=t.M_HTML=void 0,t.isEventTypeSame=o;var n=r(33653),i=r(41900);function o(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);{let r=t,n=e;return r.matches(n.name)||(0,i.isProvided)(n.altName)&&r.matches(n.altName)}}t.M_MESSAGE=new n.UnstableValue("m.message","org.matrix.msc1767.message"),t.M_TEXT=new n.UnstableValue("m.text","org.matrix.msc1767.text"),t.M_HTML=new n.UnstableValue("m.html","org.matrix.msc1767.html"),t.REFERENCE_RELATION=new n.NamespacedValue("m.reference")},10436:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},13043:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TIMESTAMP=t.M_LOCATION=t.M_ASSET=t.LocationAssetType=void 0;var n=r(87225);r(9792),t.LocationAssetType=function(e){return e.Self="m.self",e.Pin="m.pin",e}({}),t.M_ASSET=new n.UnstableValue("m.asset","org.matrix.msc3488.asset"),t.M_TIMESTAMP=new n.UnstableValue("m.ts","org.matrix.msc3488.ts"),t.M_LOCATION=new n.UnstableValue("m.location","org.matrix.msc3488.location")},36673:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Visibility=t.RestrictedAllowType=t.Preset=t.JoinRule=t.HistoryVisibility=t.GuestAccess=void 0,t.Visibility=function(e){return e.Public="public",e.Private="private",e}({}),t.Preset=function(e){return e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e}({}),t.JoinRule=function(e){return e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e}({}),t.RestrictedAllowType=function(e){return e.RoomMembership="m.room_membership",e}({}),t.GuestAccess=function(e){return e.CanJoin="can_join",e.Forbidden="forbidden",e}({}),t.HistoryVisibility=function(e){return e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable",e}({})},11235:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var n=r(33653);t.M_POLL_KIND_DISCLOSED=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),t.M_POLL_KIND_UNDISCLOSED=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),t.M_POLL_START=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),t.M_POLL_RESPONSE=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),t.M_POLL_END=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},64157:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiptType=t.MAIN_ROOM_TIMELINE=void 0,t.ReceiptType=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({}),t.MAIN_ROOM_TIMELINE="main"},82526:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},69427:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},14150:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchOrderBy=void 0;var r=function(e){return e.RoomId="room_id",e.Sender="sender",e}(r||{});t.SearchOrderBy=function(e){return e.Recent="recent",e.Rank="rank",e}({})},64791:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UNREAD_THREAD_NOTIFICATIONS=void 0;var n=r(87225);t.UNREAD_THREAD_NOTIFICATIONS=new n.ServerControlledNamespacedValue("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},33097:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThreepidMedium=void 0,t.ThreepidMedium=function(e){return e.Email="email",e.Phone="msisdn",e}({})},49699:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TOPIC=void 0;var n=r(87225);t.M_TOPIC=new n.UnstableValue("m.topic","org.matrix.msc3765.topic")},41121:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},87225:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.ServerControlledNamespacedValue=t.NamespacedValue=void 0;var i=n(r(13102));class o{get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){let e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}}t.NamespacedValue=o;class s extends o{setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}constructor(...e){super(...e),(0,i.default)(this,"preferUnstable",!1)}}t.ServerControlledNamespacedValue=s;class a extends o{get name(){return this.unstable}get altName(){return this.stable}constructor(e,t){if(super(e,t),!this.unstable)throw Error("Unstable value must be supplied")}}t.UnstableValue=a},92807:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.TypedReEmitter=t.ReEmitter=void 0;var i=n(r(13102));class o{reEmit(e,t){let r=this.reEmitters.get(e);for(let i of(r||(r=new Map,this.reEmitters.set(e,r)),t)){var n=this;if(r.has(i))continue;let t=function(){for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];("error"!==i||0!==n.target.listenerCount("error"))&&n.target.emit(i,...r,e)};e.on(i,t),r.set(i,t)}}stopReEmitting(e,t){let r=this.reEmitters.get(e);if(r){for(let n of t)e.off(n,r.get(n)),r.delete(n);0===r.size&&this.reEmitters.delete(e)}}constructor(e){(0,i.default)(this,"reEmitters",new WeakMap),this.target=e}}t.ReEmitter=o;class s extends o{reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}constructor(e){super(e)}}t.TypedReEmitter=s},68104:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceMessageQueue=void 0;var i=n(r(13102)),o=r(15748),s=r(34002),a=r(32950),l=r(89657),c=r(9855),d=r(44480);let u=20;class h{start(){this.running=!0,this.sendQueue(),this.client.on(a.ClientEvent.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(a.ClientEvent.Sync,this.onResumedSync)}async queueBatch(e){let t=[];for(let r=0;r<e.batch.length;r+=u){let n={eventType:e.eventType,batch:e.batch.slice(r,r+u),txnId:this.client.makeTxnId()};t.push(n);let i=n.batch.map(e=>"".concat(e.userId,"/").concat(e.deviceId," (msgid ").concat(e.payload[o.ToDeviceMessageId],")"));s.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(n.txnId),i)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){let t=new d.MapWithDefault(()=>new Map);for(let r of e.batch)t.getOrCreate(r.userId).set(r.deviceId,r.payload);s.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),await this.client.sendToDevice(e.eventType,t,e.txnId)}constructor(e){(0,i.default)(this,"sending",!1),(0,i.default)(this,"running",!0),(0,i.default)(this,"retryTimeout",null),(0,i.default)(this,"retryAttempts",0),(0,i.default)(this,"sendQueue",async()=>{let e;if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,!this.sending&&this.running){s.logger.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;s.logger.debug("All queued to-device messages sent")}catch(r){++this.retryAttempts;let t=l.MatrixScheduler.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,r);if(-1===t){4===Math.floor(r.httpStatus/100)?(s.logger.error("Fatal error when sending to-device message - dropping to-device batch!",r),await this.client.store.removeToDeviceBatch(e.id)):s.logger.info("Automatic retry limit reached for to-device messages.");return}s.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(t,"ms"),r),this.retryTimeout=setTimeout(this.sendQueue,t)}finally{this.sending=!1}}}),(0,i.default)(this,"onResumedSync",(e,t)=>{e===c.SyncState.Syncing&&t!==c.SyncState.Syncing&&(s.logger.info("Resuming queue after resumed sync"),this.sendQueue())}),this.client=e}}t.ToDeviceMessageQueue=h},32540:function(e,t,r){"use strict";var n,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscoveryError=t.AutoDiscoveryAction=t.AutoDiscovery=void 0;var o=i(r(13102)),s=r(32950),a=r(34002),l=r(498),c=r(72939),d=r(19251),u=r(63350),h=r(15715);function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach(function(t){(0,o.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let g=t.AutoDiscoveryAction=function(e){return e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR",e}({}),m=t.AutoDiscoveryError=function(e){return e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON",e.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",e.HomeserverTooOld="The homeserver does not meet the version requirements",e}({});class v{static async fromDiscoveryConfig(e){var t;let r={"m.homeserver":{state:v.FAIL_ERROR,error:v.ERROR_INVALID,base_url:null},"m.identity_server":{state:v.PROMPT,error:null,base_url:null}};if(!(null!=e&&e["m.homeserver"]))return a.logger.error("No m.homeserver key in config"),r["m.homeserver"].state=v.FAIL_PROMPT,r["m.homeserver"].error=v.ERROR_INVALID,Promise.resolve(r);if(!e["m.homeserver"].base_url)return a.logger.error("No m.homeserver base_url in config"),r["m.homeserver"].state=v.FAIL_PROMPT,r["m.homeserver"].error=v.ERROR_INVALID_HS_BASE_URL,Promise.resolve(r);let n=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return a.logger.error("Invalid base_url for m.homeserver"),r["m.homeserver"].error=v.ERROR_INVALID_HS_BASE_URL,Promise.resolve(r);let i=await this.fetchWellKnownObject("".concat(n,"/_matrix/client/versions"));if(!i||!Array.isArray(null===(t=i.raw)||void 0===t?void 0:t.versions))return a.logger.error("Invalid /versions response"),r["m.homeserver"].error=v.ERROR_INVALID_HOMESERVER,r["m.homeserver"].base_url=n,Promise.resolve(r);let o=new Set(i.raw.versions),l=!1;for(let e of h.SUPPORTED_MATRIX_VERSIONS)if(o.has(e)){l=!0;break}if(!l)return a.logger.error("Homeserver does not meet version requirements"),r["m.homeserver"].error=v.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,r["m.homeserver"].base_url=n,Promise.resolve(r);r["m.homeserver"]={state:v.SUCCESS,error:null,base_url:n};let c="";if(e["m.identity_server"]){let t={"m.homeserver":r["m.homeserver"],"m.identity_server":{state:v.FAIL_PROMPT,error:v.ERROR_INVALID_IS,base_url:null}};if(!(c=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url)))return a.logger.error("Invalid base_url for m.identity_server"),t["m.identity_server"].error=v.ERROR_INVALID_IS_BASE_URL,Promise.resolve(t);let n=await this.fetchWellKnownObject("".concat(c,"/_matrix/identity/v2"));if(!(null!=n&&n.raw)||n.action!==g.SUCCESS)return a.logger.error("Invalid /v2 response"),t["m.identity_server"].error=v.ERROR_INVALID_IDENTITY_SERVER,t["m.identity_server"].base_url=c,Promise.resolve(t)}c&&c.toString().length>0&&(r["m.identity_server"]={state:v.SUCCESS,error:null,base_url:c}),Object.keys(e).forEach(t=>{if("m.homeserver"===t||"m.identity_server"===t){let n=["error","state","base_url"];for(let i of Object.keys(e[t]))n.includes(i)||(r[t][i]=e[t][i])}else r[t]=e[t]});let d=await this.discoverAndValidateAuthenticationConfig(e);return r[s.M_AUTHENTICATION.stable]=d,Promise.resolve(r)}static async validateDiscoveryAuthenticationConfig(e){try{let t=s.M_AUTHENTICATION.findIn(e)||void 0,r=(0,d.validateWellKnownAuthentication)(t),n="".concat(this.sanitizeWellKnownUrl(r.issuer),"/.well-known/openid-configuration"),i=await this.fetchWellKnownObject(n);if(i.action!==g.SUCCESS)throw a.logger.error("Failed to fetch issuer openid configuration"),Error(u.OidcError.General);let o=(0,d.validateOIDCIssuerWellKnown)(i.raw);return f(f({state:g.SUCCESS,error:null},r),o)}catch(r){let e=r.message,t=Object.values(u.OidcError).includes(e)?e:u.OidcError.General;return{state:t===u.OidcError.NotSupported?g.IGNORE:g.FAIL_ERROR,error:t}}}static async discoverAndValidateAuthenticationConfig(e){try{let t=s.M_AUTHENTICATION.findIn(e)||void 0,r=await (0,c.discoverAndValidateAuthenticationConfig)(t),n=(0,d.validateOIDCIssuerWellKnown)(r.metadata);return f(f({state:g.SUCCESS,error:null},n),r)}catch(r){let e=r.message,t=Object.values(u.OidcError).includes(e)?e:u.OidcError.General;return{state:t===u.OidcError.NotSupported?g.IGNORE:g.FAIL_ERROR,error:t}}}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw Error("'domain' must be a string of non-zero length");let t={"m.homeserver":{state:v.FAIL_ERROR,error:v.ERROR_INVALID,base_url:null},"m.identity_server":{state:v.PROMPT,error:null,base_url:null}},r=e.includes("://")?e:"https://".concat(e),n=await this.fetchWellKnownObject("".concat(r,"/.well-known/matrix/client"));return n&&n.action===g.SUCCESS?v.fromDiscoveryConfig(n.raw):(a.logger.error("No response or error when parsing .well-known"),n.reason&&a.logger.error(n.reason),n.action===g.IGNORE?t["m.homeserver"]={state:v.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=v.FAIL_PROMPT,t["m.homeserver"].error=v.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){var t;if(!e||"string"!=typeof e||0===e.length)throw Error("'domain' must be a string of non-zero length");let r=await this.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return r&&null!==(t=r.raw)&&void 0!==t?t:{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t;let r;try{r=new URL(e)}catch(e){a.logger.error("Could not parse url",e)}if(!(null!==(t=r)&&void 0!==t&&t.hostname)||"http:"!==r.protocol&&"https:"!==r.protocol)return!1;let n=r.port?":".concat(r.port):"",i=r.pathname?r.pathname:"",o="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(i);return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return a.logger.error(e),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):r.g.fetch(e,t)}static setFetchFn(e){v.fetchFn=e}static async fetchWellKnownObject(e){let t;try{if(t=await v.fetch(e,{method:l.Method.Get,signal:(0,l.timeoutSignal)(5e3)}),404===t.status)return{raw:{},action:g.IGNORE,reason:v.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:g.FAIL_PROMPT,reason:"General failure"}}catch(r){let e=r,t="";return"object"==typeof e&&(t=null==e?void 0:e.message),{error:e,raw:{},action:g.FAIL_PROMPT,reason:t||"General failure"}}try{return{raw:await t.json(),action:g.SUCCESS}}catch(t){let e=t;return{error:e,raw:{},action:g.FAIL_PROMPT,reason:(null==e?void 0:e.name)==="SyntaxError"?v.ERROR_INVALID_JSON:v.ERROR_INVALID}}}}t.AutoDiscovery=v,n=v,(0,o.default)(v,"ERROR_INVALID",m.Invalid),(0,o.default)(v,"ERROR_GENERIC_FAILURE",m.GenericFailure),(0,o.default)(v,"ERROR_INVALID_HS_BASE_URL",m.InvalidHsBaseUrl),(0,o.default)(v,"ERROR_INVALID_HOMESERVER",m.InvalidHomeserver),(0,o.default)(v,"ERROR_INVALID_IS_BASE_URL",m.InvalidIsBaseUrl),(0,o.default)(v,"ERROR_INVALID_IDENTITY_SERVER",m.InvalidIdentityServer),(0,o.default)(v,"ERROR_INVALID_IS",m.InvalidIs),(0,o.default)(v,"ERROR_MISSING_WELLKNOWN",m.MissingWellknown),(0,o.default)(v,"ERROR_INVALID_JSON",m.InvalidJson),(0,o.default)(v,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",m.UnsupportedHomeserverSpecVersion),(0,o.default)(v,"ERROR_HOMESERVER_TOO_OLD",n.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION),(0,o.default)(v,"ALL_ERRORS",Object.keys(m)),(0,o.default)(v,"FAIL_ERROR",g.FAIL_ERROR),(0,o.default)(v,"FAIL_PROMPT",g.FAIL_PROMPT),(0,o.default)(v,"PROMPT",g.PROMPT),(0,o.default)(v,"SUCCESS",g.SUCCESS)},98870:function(e,t,r){"use strict";var n=r(31180).Buffer;function i(e){if("function"==typeof n)return n.from(e).toString("base64");if("function"==typeof btoa&&e instanceof Uint8Array)return btoa(e.reduce((e,t)=>e+String.fromCharCode(t),""));throw Error("No base64 impl found!")}function o(e){return i(e).replace(/={1,2}$/,"")}function s(e){return o(e).replace("+","-").replace("/","_")}function a(e){if("function"==typeof n)return n.from(e,"base64");if("function"==typeof atob){let t=function*(){let t=atob(e.replace("-","+").replace("_","/"));for(let e=0;e<t.length;++e)yield t.charCodeAt(e)};return Uint8Array.from(t())}throw Error("No base64 impl found!")}Object.defineProperty(t,"__esModule",{value:!0}),t.decodeBase64=a,t.encodeBase64=i,t.encodeUnpaddedBase64=o,t.encodeUnpaddedBase64Url=s},95923:function(e,t,r){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0});var i=s(r(301));function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(o=function(e){return e?r:t})(e)}function s(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=o(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}if(Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}),globalThis.__js_sdk_entrypoint)throw Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;try{n=globalThis.indexedDB}catch(e){}n&&i.setCryptoStoreFactory(()=>new i.IndexedDBCryptoStore(n,"matrix-js-sdk:crypto")),globalThis.matrixcs=i},79662:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.makeBeaconInfoContent=t.makeBeaconContent=t.getTextForLocationEvent=void 0,t.makeEmoteMessage=v,t.makeHtmlEmote=f,t.makeHtmlMessage=h,t.makeHtmlNotice=p,t.makeLocationContent=void 0,t.makeNotice=m,t.makeTextMessage=g,t.parseTopicContent=t.parseLocationEvent=t.parseBeaconInfoContent=t.parseBeaconContent=t.makeTopicContent=void 0;var i=n(r(13102)),o=r(15748),s=r(9792),a=r(41900),l=r(13043),c=r(49699);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function h(e,t){return{msgtype:o.MsgType.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function p(e,t){return{msgtype:o.MsgType.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function f(e,t){return{msgtype:o.MsgType.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function g(e){return{msgtype:o.MsgType.Text,body:e}}function m(e){return{msgtype:o.MsgType.Notice,body:e}}function v(e){return{msgtype:o.MsgType.Emote,body:e}}let y=(e,t,r,n)=>{let i="at ".concat(new Date(r).toISOString());return[t===l.LocationAssetType.Self?"User":void 0,"Location",n?'"'.concat(n,'"'):void 0,e,i].filter(Boolean).join(" ")};t.getTextForLocationEvent=y;let b=(e,t,r,n,i)=>{let a=null!=e?e:y(t,i||l.LocationAssetType.Self,r,n),c=r?{[l.M_TIMESTAMP.name]:r}:{};return u({msgtype:o.MsgType.Location,body:a,geo_uri:t,[l.M_LOCATION.name]:{description:n,uri:t},[l.M_ASSET.name]:{type:i||l.LocationAssetType.Self},[s.M_TEXT.name]:a},c)};t.makeLocationContent=b;let S=e=>{var t,r;let n=l.M_LOCATION.findIn(e),i=l.M_ASSET.findIn(e),o=l.M_TIMESTAMP.findIn(e),a=s.M_TEXT.findIn(e),c=null!==(t=null==n?void 0:n.uri)&&void 0!==t?t:null==e?void 0:e.geo_uri,d=null==n?void 0:n.description,u=null!==(r=null==i?void 0:i.type)&&void 0!==r?r:l.LocationAssetType.Self;return b(null!=a?a:e.body,c,null!=o?o:void 0,d,u)};t.parseLocationEvent=S;let E=(e,t)=>{let r=[{body:e,mimetype:"text/plain"}];return(0,a.isProvided)(t)&&r.push({body:t,mimetype:"text/html"}),{topic:e,[c.M_TOPIC.name]:r}};t.makeTopicContent=E;let _=e=>{var t,r,n;let i=c.M_TOPIC.findIn(e);return Array.isArray(i)?{text:null!==(t=null==i||null===(r=i.find(e=>!(0,a.isProvided)(e.mimetype)||"text/plain"===e.mimetype))||void 0===r?void 0:r.body)&&void 0!==t?t:e.topic,html:null==i||null===(n=i.find(e=>"text/html"===e.mimetype))||void 0===n?void 0:n.body}:{text:e.topic}};t.parseTopicContent=_;let w=(e,t,r,n,i)=>({description:r,timeout:e,live:t,[l.M_TIMESTAMP.name]:i||Date.now(),[l.M_ASSET.name]:{type:null!=n?n:l.LocationAssetType.Self}});t.makeBeaconInfoContent=w;let T=e=>{var t;let{description:r,timeout:n,live:i}=e,o=null!==(t=l.M_TIMESTAMP.findIn(e))&&void 0!==t?t:void 0,s=l.M_ASSET.findIn(e);return{description:r,timeout:n,live:i,assetType:null==s?void 0:s.type,timestamp:o}};t.parseBeaconInfoContent=T;let I=(e,t,r,n)=>({[l.M_LOCATION.name]:{description:n,uri:e},[l.M_TIMESTAMP.name]:t,"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:r}});t.makeBeaconContent=I;let O=e=>{var t;let r=l.M_LOCATION.findIn(e),n=null!==(t=l.M_TIMESTAMP.findIn(e))&&void 0!==t?t:void 0;return{description:null==r?void 0:r.description,uri:null==r?void 0:r.uri,timestamp:n}};t.parseBeaconContent=O},34479:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHttpUriForMxc=i;var n=r(44480);function i(e,t,r,i,o){let s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6?arguments[6]:void 0;if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";let l=t.slice(6),c="/_matrix/media/v3/download/",d={};r&&(d.width=Math.round(r).toString()),i&&(d.height=Math.round(i).toString()),o&&(d.method=o),Object.keys(d).length>0&&(c="/_matrix/media/v3/thumbnail/"),"boolean"==typeof a&&(d.allow_redirect=JSON.stringify(a));let u=l.indexOf("#"),h="";return u>=0&&(h=l.slice(u),l=l.slice(0,u)),e+c+l+(0===Object.keys(d).length?"":"?"+(0,n.encodeParams)(d))+h}},68995:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={UserVerificationStatus:!0,DeviceVerificationStatus:!0,CrossSigningKey:!0,EventShieldColour:!0,EventShieldReason:!0};t.UserVerificationStatus=t.EventShieldReason=t.EventShieldColour=t.DeviceVerificationStatus=t.CrossSigningKey=void 0;var i=r(12796);Object.keys(i).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(51486);Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});class s{isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}constructor(e,t,r){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r}}t.UserVerificationStatus=s;class a{isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}constructor(e){var t,r,n,i,o;this.signedByOwner=null!==(t=e.signedByOwner)&&void 0!==t&&t,this.crossSigningVerified=null!==(r=e.crossSigningVerified)&&void 0!==r&&r,this.tofu=null!==(n=e.tofu)&&void 0!==n&&n,this.localVerified=null!==(i=e.localVerified)&&void 0!==i&&i,this.trustCrossSignedDevices=null!==(o=e.trustCrossSignedDevices)&&void 0!==o&&o}}t.DeviceVerificationStatus=a,t.CrossSigningKey=function(e){return e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing",e}({}),t.EventShieldColour=function(e){return e[e.NONE=0]="NONE",e[e.GREY=1]="GREY",e[e.RED=2]="RED",e}({}),t.EventShieldReason=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",e[e.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",e[e.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",e[e.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",e[e.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",e}({})},51486:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},12796:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerifierEvent=t.VerificationRequestEvent=t.VerificationPhase=void 0,t.canAcceptVerificationRequest=n,t.VerificationRequestEvent=function(e){return e.Change="change",e}({});let r=t.VerificationPhase=function(e){return e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done",e}({});function n(e){return e.phase<r.Ready&&!e.accepting&&!e.declining}t.VerifierEvent=function(e){return e.Cancel="cancel",e.ShowSas="show_sas",e.ShowReciprocateQr="show_reciprocate_qr",e}({})},807:function(e,t,r){"use strict";var n=r(31180).Buffer,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0,Object.defineProperty(t,"UserTrustLevel",{enumerable:!0,get:function(){return d.UserVerificationStatus}}),t.createCryptoStoreCacheCallbacks=y,t.requestKeysDuringVerification=b;var o=i(r(13102)),s=r(14995),a=r(34002),l=r(87786),c=r(54410),d=r(68995),u=r(98870);let h=6e4;function p(e){return Object.values(e.keys)[0]}class f{static fromStorage(e,t){let r=new f(t);for(let t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){let n=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw Error("No getCrossSigningKey callback supplied");function i(e){if(!e)return;let n=new r.g.Olm.PkSigning,i=n.init_with_seed(e);if(i===t)return[i,n];n.free()}void 0===t&&(t=this.getId(e));let o=null;this.cacheCallbacks.getCrossSigningKeyCache&&n&&(o=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));let s=i(o);if(s)return s;let a=i(o=await this.callbacks.getCrossSigningKey(e,t));if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&n&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,o),a;if(!o)throw Error("getCrossSigningKey callback for "+e+" returned falsey");throw Error("Key type "+e+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){let t=await e.isStored("m.cross_signing.master")||{};function r(e){for(let r of Object.keys(t))e[r]||delete t[r]}for(let t of["self_signing","user_signing"])r(await e.isStored("m.cross_signing.".concat(t))||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(let[r,n]of e){let e=(0,u.encodeBase64)(n);await t.store("m.cross_signing.".concat(r),e)}}static async getFromSecretStorage(e,t){let r=await t.get("m.cross_signing.".concat(e));return r?(0,u.decodeBase64)(r):null}async isStoredInKeyCache(e){let t=this.cacheCallbacks;if(!t)return!1;for(let n of e?[e]:["master","self_signing","user_signing"]){var r;if(!await (null===(r=t.getCrossSigningKeyCache)||void 0===r?void 0:r.call(t,n)))return!1}return!0}async getCrossSigningKeysFromCache(){let e=new Map,t=this.cacheCallbacks;if(!t)return e;for(let n of["master","self_signing","user_signing"]){var r;let i=await (null===(r=t.getCrossSigningKeyCache)||void 0===r?void 0:r.call(t,n));i&&e.set(n,i)}return e}getId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"master";return this.keys[e]?p(this.keys[e]):null}async resetKeys(e){let t,n;if(!this.callbacks.saveCrossSigningKeys)throw Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&m.MASTER||!this.keys.master)e=m.MASTER|m.USER_SIGNING|m.SELF_SIGNING;else if(0===e)return;let i={},o={};try{if(e&m.MASTER?(t=new r.g.Olm.PkSigning,i.master=t.generate_seed(),n=t.init_with_seed(i.master),o.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+n]:n}}):[n,t]=await this.getCrossSigningKey("master"),e&m.SELF_SIGNING){let e=new r.g.Olm.PkSigning;try{i.self_signing=e.generate_seed();let r=e.init_with_seed(i.self_signing);o.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+r]:r}},(0,s.pkSign)(o.self_signing,t,this.userId,n)}finally{e.free()}}if(e&m.USER_SIGNING){let e=new r.g.Olm.PkSigning;try{i.user_signing=e.generate_seed();let r=e.init_with_seed(i.user_signing);o.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+r]:r}},(0,s.pkSign)(o.user_signing,t,this.userId,n)}finally{e.free()}}Object.assign(this.keys,o),this.callbacks.saveCrossSigningKeys(i)}finally{t&&t.free()}}clearKeys(){this.keys={}}setKeys(e){let t={};if(e.master){if(e.master.user_id!==this.userId){let t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw a.logger.error(t),Error(t)}this.keys.master?p(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else if(this.keys.master)t.master=this.keys.master;else throw Error("Tried to set cross-signing keys without a master key");let r=p(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){let t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw a.logger.error(t),Error(t)}try{(0,s.pkVerify)(e.user_signing,r,this.userId)}catch(e){throw a.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){let t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw a.logger.error(t),Error(t)}try{(0,s.pkVerify)(e.self_signing,r,this.userId)}catch(e){throw a.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw Error("Attempted to sign with "+t+" key but no such key present");let[r,n]=await this.getCrossSigningKey(t);try{return(0,s.pkSign)(e,n,this.userId,r),e}finally{n.free()}}async signUser(e){if(!this.keys.user_signing){a.logger.info("No user signing key: not signing user");return}return this.signObject(e.keys.master,"user_signing")}async signDevice(e,t){if(e!==this.userId)throw Error("Trying to sign ".concat(e,"'s device; can only sign our own device"));if(!this.keys.self_signing){a.logger.info("No self signing key: not signing device");return}return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")}checkUserTrust(e){let t;if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new d.UserVerificationStatus(!0,!0,this.firstUse);if(!this.keys.user_signing)return new d.UserVerificationStatus(!1,!1,e.firstUse);let r=e.keys.master,n=this.getId("user_signing");try{(0,s.pkVerify)(r,n,this.userId),t=!0}catch(e){t=!1}return new d.UserVerificationStatus(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,r,n){let i=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new v(!1,!1,r,n);let a=g(t,e.userId);try{return(0,s.pkVerify)(o,e.getId(),e.userId),(0,s.pkVerify)(a,p(o),e.userId),v.fromUserTrustLevel(i,r,n)}catch(e){return new v(!1,!1,r,n)}}getCacheCallbacks(){return this.cacheCallbacks}constructor(e,t={},r={}){(0,o.default)(this,"keys",{}),(0,o.default)(this,"firstUse",!0),(0,o.default)(this,"crossSigningVerifiedBefore",!1),this.userId=e,this.callbacks=t,this.cacheCallbacks=r}}function g(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}t.CrossSigningInfo=f;let m=t.CrossSigningLevel=function(e){return e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING",e}({});class v extends d.DeviceVerificationStatus{static fromUserTrustLevel(e,t,r){return new v(e.isCrossSigningVerified(),e.isTofu(),t,r,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}constructor(e,t,r,n,i=!1){super({crossSigningVerified:e,tofu:t,localVerified:r,trustCrossSignedDevices:n,signedByOwner:i})}}function y(e,t){return{getCrossSigningKeyCache:async function(r,i){let o=await new Promise(t=>{e.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,r)})});if(!o||!o.ciphertext)return o;{let e=n.from(t.pickleKey),i=await (0,c.decryptAES)(o,e,r);return(0,u.decodeBase64)(i)}},storeCrossSigningKeyCache:async function(r,i){if(!(i instanceof Uint8Array))throw Error("storeCrossSigningKeyCache expects Uint8Array, got ".concat(i));let o=n.from(t.pickleKey),s=await (0,c.encryptAES)((0,u.encodeBase64)(i),o,r);return e.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,r,s)})}}}async function b(e,t,r){if(e.getUserId()===t)return a.logger.log("Cross-signing: Self-verification done; requesting keys"),new Promise((t,n)=>{let i=e,o=i.crypto.crossSigningInfo,s=new f(o.userId,{getCrossSigningKey:async e=>{a.logger.debug("Cross-signing: requesting secret",e,r);let{promise:t}=i.requestSecret("m.cross_signing.".concat(e),[r]),n=await t,o=(0,u.decodeBase64)(n);return Uint8Array.from(o)}},o.getCacheCallbacks());s.keys=o.keys;let l=new Promise(e=>{setTimeout(e,h,Error("Timeout"))}),c=(async()=>{if(!await i.crypto.getSessionBackupPrivateKey()){a.logger.info("No cached backup key found. Requesting...");let e=i.requestSecret("m.megolm_backup.v1",[r]),t=await e.promise;a.logger.info("Got key backup key, decoding...");let n=(0,u.decodeBase64)(t);a.logger.info("Decoded backup key, storing..."),await i.crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),a.logger.info("Backup key stored. Starting backup restore...");let o=await i.getKeyBackupVersion();i.restoreKeyBackupWithCache(void 0,void 0,o).then(()=>{a.logger.info("Backup restored.")})}})();Promise.race([Promise.all([s.getCrossSigningKey("master"),s.getCrossSigningKey("self_signing"),s.getCrossSigningKey("user_signing"),c]),l]).then(t,n)}).catch(e=>{a.logger.warn("Cross-signing: failure while requesting keys:",e)})}t.DeviceTrustLevel=v},97043:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingStatus=t.DeviceList=void 0;var i=n(r(13102)),o=r(34002),s=r(5382),a=r(807),l=f(r(14995)),c=r(87786),d=r(44480),u=r(44441),h=r(94161);function p(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(p=function(e){return e?r:t})(e)}function f(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=p(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}let g=t.TrackingStatus=function(e){return e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate",e}({});class m extends u.TypedEventEmitter{async load(){for(let e of(await this.cryptoStore.doTxn("readonly",[c.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{this.cryptoStore.getEndToEndDeviceData(e,e=>{var t;for(let r of(this.hasFetched=!!(null==e?void 0:e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=null!==(t=null==e?void 0:e.syncToken)&&void 0!==t?t:null,this.userByIdentityKey={},Object.keys(this.devices))){let e=this.devices[r];for(let t of Object.keys(e)){let n=e[t].keys["curve25519:"+t];void 0!==n&&(this.userByIdentityKey[n]=r)}}})}),Object.keys(this.deviceTrackingStatus)))this.deviceTrackingStatus[e]==g.DownloadInProgress&&(this.deviceTrackingStatus[e]=g.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;if(!this.dirty)return Promise.resolve(!1);let t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let r=this.savePromise;if(null===r&&(r=new Promise(e=>{this.resolveSavePromise=e}),this.savePromise=r),null===this.saveTimer){let r=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout(()=>{o.logger.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[c.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{var t;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:null!==(t=this.syncToken)&&void 0!==t?t:void 0},e)}).then(()=>{this.dirty=!1,null==r||r(!0)},e=>{o.logger.error("Failed to save device tracking data",this.syncToken),o.logger.error(e)})},e)}return r}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){let r=[],n=[];if(e.forEach(e=>{let i=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser.has(e)?(o.logger.log("downloadKeys: already have a download in progress for "+"".concat(e,": awaiting its result")),n.push(this.keyDownloadsInProgressByUser.get(e))):(t||i!=g.UpToDate)&&r.push(e)}),0!=r.length){o.logger.log("downloadKeys: downloading for",r);let e=this.doKeyDownload(r);n.push(e)}return 0===n.length&&o.logger.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){let t=new Map;return e.forEach(e=>{var r;let n=new Map;null===(r=this.getStoredDevicesForUser(e))||void 0===r||r.forEach(function(e){n.set(e.deviceId,e)}),t.set(e,n)}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){let t=this.devices[e];if(!t)return null;let r=[];for(let e in t)t.hasOwnProperty(e)&&r.push(s.DeviceInfo.fromStorage(t[e],e));return r}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){let r=this.devices[e];if(null!=r&&r[t])return s.DeviceInfo.fromStorage(r[t],t)}getUserByIdentityKey(e,t){return e!==l.OLM_ALGORITHM&&e!==l.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){let r=this.getUserByIdentityKey(e,t);if(!r)return null;let n=this.devices[r];if(!n)return null;for(let e in n){if(!n.hasOwnProperty(e))continue;let r=n[e];for(let n in r.keys)if(r.keys.hasOwnProperty(n)&&0===n.indexOf("curve25519:")&&r.keys[n]==t)return s.DeviceInfo.fromStorage(r,e)}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(o.logger.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=g.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(o.logger.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=g.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(let e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=g.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(o.logger.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=g.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();let e=[];for(let t of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[t]==g.PendingDownload&&e.push(t);return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(let[t,r]of Object.entries(this.devices[e])){let e=r.keys["curve25519:"+t];delete this.userByIdentityKey[e]}for(let[r,n]of(this.devices[e]=t,Object.entries(t))){let t=n.keys["curve25519:"+r];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();let t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{r(!0)},t=>{throw o.logger.error("Error downloading keys for "+e+":",t),r(!1),t});e.forEach(e=>{this.keyDownloadsInProgressByUser.set(e,t),this.deviceTrackingStatus[e]==g.PendingDownload&&(this.deviceTrackingStatus[e]=g.DownloadInProgress)});let r=r=>{this.emit(h.CryptoEvent.WillUpdateDevices,e,!this.hasFetched),e.forEach(e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(e)!==t){o.logger.log("Another update in the queue for",e,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(e),this.deviceTrackingStatus[e]==g.DownloadInProgress&&(r?(this.deviceTrackingStatus[e]=g.UpToDate,o.logger.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=g.PendingDownload)}),this.saveIfDirty(),this.emit(h.CryptoEvent.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}constructor(e,t,r,n=250){super(),(0,i.default)(this,"devices",{}),(0,i.default)(this,"crossSigningInfo",{}),(0,i.default)(this,"userByIdentityKey",{}),(0,i.default)(this,"deviceTrackingStatus",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"keyDownloadsInProgressByUser",new Map),(0,i.default)(this,"dirty",!1),(0,i.default)(this,"savePromise",null),(0,i.default)(this,"resolveSavePromise",null),(0,i.default)(this,"savePromiseTime",null),(0,i.default)(this,"saveTimer",null),(0,i.default)(this,"hasFetched",null),this.cryptoStore=t,this.keyDownloadChunkSize=n,this.serialiser=new v(e,r,this)}}t.DeviceList=m;class v{updateDevicesForUsers(e,t){return(e.forEach(e=>{this.keyDownloadsQueuedByUser[e]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,d.defer)()),this.syncToken=t,this.downloadInProgress)?(o.logger.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");let e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};let t=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,o.logger.log("Starting key download for",e),this.downloadInProgress=!0;let r={};this.syncToken&&(r.token=this.syncToken);let n=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){let i=e.slice(t,t+this.deviceList.keyDownloadChunkSize);n.push(()=>this.baseApis.downloadKeysForUsers(i,r))}return(0,d.chunkPromises)(n,3).then(async t=>{let r=Object.assign({},...t.map(e=>e.device_keys||{})),n=Object.assign({},...t.map(e=>e.master_keys||{})),i=Object.assign({},...t.map(e=>e.self_signing_keys||{})),s=Object.assign({},...t.map(e=>e.user_signing_keys||{}));for(let t of e){await (0,d.sleep)(5);try{await this.processQueryResponseForUser(t,r[t],{master:null==n?void 0:n[t],self_signing:null==i?void 0:i[t],user_signing:null==s?void 0:s[t]})}catch(e){o.logger.error("Error processing keys for ".concat(t,":"),e)}}}).then(()=>{o.logger.log("Completed key download for "+e),this.downloadInProgress=!1,null==t||t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},r=>{o.logger.warn("Error downloading keys for "+e+":",r),this.downloadInProgress=!1,null==t||t.reject(r)}),t.promise}async processQueryResponseForUser(e,t,r){o.logger.log("got device keys for "+e+":",t),o.logger.log("got cross-signing keys for "+e+":",r);{let r={},n=this.deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach(e=>{let t=s.DeviceInfo.fromStorage(n[e],e);r[e]=t}),await y(this.olmDevice,e,r,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);let i={};Object.keys(r).forEach(e=>{i[e]=r[e].toStorage()}),this.deviceList.setRawStoredDevicesForUser(e,i)}if(r&&(r.master||r.self_signing||r.user_signing)){let t=this.deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(r),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(h.CryptoEvent.UserCrossSigningUpdated,e)}}constructor(e,t,r){(0,i.default)(this,"downloadInProgress",!1),(0,i.default)(this,"keyDownloadsQueuedByUser",{}),this.baseApis=e,this.olmDevice=t,this.deviceList=r}}async function y(e,t,r,n,i,s){let a=!1;for(let e in r)if(r.hasOwnProperty(e)&&!(e in n)){if(t===i&&e===s){o.logger.warn("Local device ".concat(e," missing from sync, skipping removal"));continue}o.logger.log("Device "+t+":"+e+" has been removed"),delete r[e],a=!0}for(let i in n){if(!n.hasOwnProperty(i))continue;let s=n[i];if(s.user_id!==t){o.logger.warn("Mismatched user_id "+s.user_id+" in keys from "+t+":"+i);continue}if(s.device_id!==i){o.logger.warn("Mismatched device_id "+s.device_id+" in keys from "+t+":"+i);continue}await b(e,r,s)&&(a=!0)}return a}async function b(e,t,r){let n;if(!r.keys)return!1;let i=r.device_id,a=r.user_id,c="ed25519:"+i,d=r.keys[c];if(!d)return o.logger.warn("Device "+a+":"+i+" has no ed25519 key"),!1;let u=r.unsigned||{},h=r.signatures||{};try{await l.verifySignature(e,r,a,i,d)}catch(e){return o.logger.warn("Unable to verify signature on device "+a+":"+i+":"+e),!1}if(i in t){if((n=t[i]).getFingerprint()!=d)return o.logger.warn("Ed25519 key for device "+a+":"+i+" has changed"),!1}else t[i]=n=new s.DeviceInfo(i);return n.keys=r.keys||{},n.algorithms=r.algorithms||[],n.unsigned=u,n.signatures=h,!0}},84018:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.EncryptionSetupOperation=t.EncryptionSetupBuilder=void 0;var i=n(r(13102)),o=r(34002),s=r(39325),a=r(807),l=r(87786),c=r(498),d=r(32950),u=r(44441);class h{addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,r){this.keySignatures||(this.keySignatures={});let n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=r}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){return new p(this.accountDataClientAdapter.values,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){let r=(0,a.createCryptoStoreCacheCallbacks)(e.cryptoStore,e.olmDevice);for(let e of["master","self_signing","user_signing"]){var t;o.logger.log("Cache ".concat(e," cross-signing private key locally"));let n=this.crossSigningCallbacks.privateKeys.get(e);await (null===(t=r.storeCrossSigningKeyCache)||void 0===t?void 0:t.call(r,e,n))}await e.cryptoStore.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}constructor(e,t){this.accountDataClientAdapter=new f(e),this.crossSigningCallbacks=new g,this.ssssCryptoCallbacks=new m(t)}}t.EncryptionSetupBuilder=h;class p{async apply(e){let t=e.baseApis;if(this.crossSigningKeys){var r,n;let i={};for(let[e,t]of Object.entries(this.crossSigningKeys.keys))i[e+"_key"]=t;await (null===(r=(n=this.crossSigningKeys).authUpload)||void 0===r?void 0:r.call(n,e=>t.uploadDeviceSigningKeys(null!=e?e:void 0,i))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(let[e,r]of this.accountData)await t.setAccountData(e,r);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(c.Method.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:c.ClientPrefix.V3}):await t.http.authedRequest(c.Method.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:c.ClientPrefix.V3}),await e.backupManager.checkKeyBackup())}constructor(e,t,r,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=r,this.keySignatures=n}}t.EncryptionSetupOperation=p;class f extends u.TypedEventEmitter{getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){let t=this.values.get(e);if(t)return t;let r=this.existingValues.get(e);return r?r.getContent():null}setAccountData(e,t){let r=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{let n=new s.MatrixEvent({type:e,content:t});return this.emit(d.ClientEvent.AccountData,n,r),{}})}constructor(e){super(),(0,i.default)(this,"values",new Map),this.existingValues=e}}class g{getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var r;return Promise.resolve(null!==(r=this.privateKeys.get(e))&&void 0!==r?r:null)}saveCrossSigningKeys(e){for(let[t,r]of Object.entries(e))this.privateKeys.set(t,r)}constructor(){(0,i.default)(this,"privateKeys",new Map)}}class m{async getSecretStorageKey(e,t){var r;let{keys:n}=e;for(let e of Object.keys(n)){let t=this.privateKeys.get(e);if(t)return[e,t]}if(this!==null&&void 0!==this&&null!==(r=this.delegateCryptoCallbacks)&&void 0!==r&&r.getSecretStorageKey){let e=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:n},t);if(e){let[t,r]=e;this.privateKeys.set(t,r)}return e}return null}addPrivateKey(e,t,r){var n,i;this.privateKeys.set(e,r),null===(n=this.delegateCryptoCallbacks)||void 0===n||null===(i=n.cacheSecretStorageKey)||void 0===i||i.call(n,e,t,r)}constructor(e){(0,i.default)(this,"privateKeys",new Map),this.delegateCryptoCallbacks=e}}},10845:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.WITHHELD_MESSAGES=t.PayloadTooLargeError=t.OlmDevice=void 0;var i=n(r(13102)),o=r(34002),s=r(87786),a=c(r(22079));function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(l=function(e){return e?r:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=l(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}let d=49152;class u extends Error{constructor(...e){super(...e),(0,i.default)(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function h(e){if(void 0===e)throw Error("payloadString undefined");if(e.length>d)throw new u("Message too long (".concat(e.length," bytes). ")+"The maximum for an encrypted message is ".concat(d," bytes."))}t.PayloadTooLargeError=u;class p{static getOlmVersion(){return r.g.Olm.get_library_version()}async init(){let e,{pickleKey:t,fromExportedDevice:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=new r.g.Olm.Account;try{n?(t&&o.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=n.pickleKey,await this.initialiseFromExportedDevice(n,i)):(t&&(this.pickleKey=t),await this.initialiseAccount(i)),e=JSON.parse(i.identity_keys()),this.maxOneTimeKeys=i.max_number_of_one_time_keys()}finally{i.free()}this.deviceCurve25519Key=e.curve25519,this.deviceEd25519Key=e.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach(e=>{let{deviceKey:r,sessionId:n}=e,i={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(r,n,i,t)})}),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this.cryptoStore.getAccount(t,r=>{null!==r?e.unpickle(this.pickleKey,r):(e.create(),r=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,r))})})}getAccount(e,t){this.cryptoStore.getAccount(e,e=>{let n=new r.g.Olm.Account;try{n.unpickle(this.pickleKey,e),t(n)}finally{n.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){let e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this.cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e}getSession(e,t,r,n){this.cryptoStore.getEndToEndSession(e,t,r,e=>{this.unpickleSession(e,n)})}unpickleSession(e,t){let n=new r.g.Olm.Session;try{n.unpickle(this.pickleKey,e.session);let r=Object.assign({},e,{session:n});t(r)}finally{n.free()}}saveSession(e,t,r){let n=t.session.session_id();o.logger.debug("Saving Olm session ".concat(n," with device ").concat(e,": ").concat(t.session.describe()));let i=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,i,r)}getUtility(e){let t=new r.g.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],r=>{this.getAccount(r,r=>{t=r.sign(e)})}),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e}maxNumberOfOneTimeKeys(){var e;return null!==(e=this.maxOneTimeKeys)&&void 0!==e?e:-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.mark_keys_as_published(),this.storeAccount(e,t)})})}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this.getAccount(t,r=>{r.generate_one_time_keys(e),this.storeAccount(t,r)})})}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.generate_fallback_key(),this.storeAccount(e,t)})})}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this.getAccount(t,t=>{e=JSON.parse(t.unpublished_fallback_key())})}),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)})})}async createOutboundSession(e,t){let n;return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this.getAccount(i,o=>{let s=new r.g.Olm.Session;try{s.create_outbound(o,e,t),n=s.session_id(),this.storeAccount(i,o);let r={session:s,lastReceivedMessageTs:Date.now()};this.saveSession(e,r,i)}finally{s.free()}})},o.logger.getChild("[createOutboundSession]")),n}async createInboundSession(e,t,n){let i;if(0!==t)throw Error("Need messageType == 0 to create inbound session");return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT,s.IndexedDBCryptoStore.STORE_SESSIONS],o=>{this.getAccount(o,s=>{let a=new r.g.Olm.Session;try{a.create_inbound_from(s,e,n),s.remove_one_time_keys(a),this.storeAccount(o,s);let r=a.decrypt(t,n),l={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,l,o),i={payload:r,session_id:a.session_id()}}finally{a.free()}})},o.logger.getChild("[createInboundSession]")),i}async getSessionIdsForDevice(e){let t;let r=o.logger.getChild("[getSessionIdsForDevice]");if(e in this.sessionsInProgress){r.debug("Waiting for Olm session for ".concat(e," to be created"));try{await this.sessionsInProgress[e]}catch(e){}}return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],r=>{this.cryptoStore.getEndToEndSessions(e,r,e=>{t=Object.keys(e)})},r),t}async getSessionIdForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2?arguments[2]:void 0,n=await this.getSessionInfoForDevice(e,t,r);if(0===n.length)return null;let i=0;for(let e=1;e<n.length;e++){let t=n[e],r=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,o=n[i],s=void 0===o.lastReceivedMessageTs?0:o.lastReceivedMessageTs;(r>s||r===s&&t.sessionId<o.sessionId)&&(i=e)}return n[i].sessionId}async getSessionInfoForDevice(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.logger;if(r=r.getChild("[getSessionInfoForDevice]"),e in this.sessionsInProgress&&!t){r.debug("Waiting for Olm session for ".concat(e," to be created"));try{await this.sessionsInProgress[e]}catch(e){}}let n=[];return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this.cryptoStore.getEndToEndSessions(e,t,e=>{for(let t of Object.keys(e).sort())this.unpickleSession(e[t],e=>{n.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:t})})})},r),n}async encryptMessage(e,t,r){let n;return h(r),await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this.getSession(e,t,i,s=>{let a=s.session.describe();o.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),n=s.session.encrypt(r),this.saveSession(e,s,i)})},o.logger.getChild("[encryptMessage]")),n}async decryptMessage(e,t,r,n){let i;return await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_SESSIONS],s=>{this.getSession(e,t,s,a=>{let l=a.session.describe();o.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+l),i=a.session.decrypt(r,n),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,s)})},o.logger.getChild("[decryptMessage]")),i}async matchesSession(e,t,r,n){let i;return 0===r&&(await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SESSIONS],r=>{this.getSession(e,t,r,e=>{i=e.session.matches_inbound(n)})},o.logger.getChild("[matchesSession]")),i)}async recordSessionProblem(e,t,r){o.logger.info("Recording problem on olm session with ".concat(e," of type ").concat(t,". Recreating: ").concat(r)),await this.cryptoStore.storeEndToEndSessionProblem(e,t,r)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){let n=this.outboundGroupSessionStore[e];if(void 0===n)throw Error("Unknown outbound group session "+e);let i=new r.g.Olm.OutboundGroupSession;try{return i.unpickle(this.pickleKey,n),t(i)}finally{i.free()}}createOutboundGroupSession(){let e=new r.g.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return o.logger.log("encrypting msg with megolm session ".concat(e)),h(t),this.getOutboundGroupSession(e,e=>{let r=e.encrypt(t);return this.saveOutboundGroupSession(e),r})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,function(e){return{chain_index:e.message_index(),key:e.session_key()}})}unpickleInboundGroupSession(e,t){let n=new r.g.Olm.InboundGroupSession;try{return n.unpickle(this.pickleKey,e.session),t(n)}finally{n.free()}}getInboundGroupSession(e,t,r,n,i){this.cryptoStore.getEndToEndInboundGroupSession(t,r,n,(t,r)=>{if(null===t){i(null,null,r);return}if(null!==e&&e!==t.room_id)throw Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,e=>{i(e,t,r)})})}async addInboundGroupSession(e,t,n,i,a,l,c){let d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,s.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],s=>{this.getInboundGroupSession(e,t,i,s,(u,h)=>{let p=new r.g.Olm.InboundGroupSession;try{if(c?p.import_session(a):p.create(a),i!=p.session_id())throw Error("Mismatched group session ID from senderKey: "+t);if(u&&(o.logger.log("Update for megolm session ".concat(t,"|").concat(i)),u.first_known_index()<=p.first_known_index())){if(!h.untrusted||d.untrusted){o.logger.log("Keeping existing megolm session ".concat(t,"|").concat(i));return}if(u.first_known_index()<p.first_known_index()){u.export_session(p.first_known_index())===p.export_session(p.first_known_index())?(o.logger.info("Upgrading trust of existing megolm session "+"".concat(t,"|").concat(i," based on newly-received trusted session")),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(t,i,h,s)):o.logger.warn("Newly-received megolm session ".concat(t,"|$sessionId}")+" does not match existing session! Keeping existing session");return}}o.logger.debug("Storing megolm session ".concat(t,"|").concat(i," with first index ")+p.first_known_index());let r=Object.assign({},d,{room_id:e,session:p.pickle(this.pickleKey),keysClaimed:l,forwardingCurve25519KeyChain:n});this.cryptoStore.storeEndToEndInboundGroupSession(t,i,r,s),!u&&d.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,i,s)}finally{p.free()}})},o.logger.getChild("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,r,n,i){await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:n,reason:i},o)})}async decryptGroupMessage(e,t,r,n,i,l){let c,d=null;if(await this.cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.getInboundGroupSession(e,t,r,o,(e,s,u)=>{let h;if(null===e||null===s){u&&(c=new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",g(u),{session:t+"|"+r})),d=null;return}try{h=e.decrypt(n)}catch(e){c=(null==e?void 0:e.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&u?new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",g(u),{session:t+"|"+r}):e;return}let p=h.plaintext;if(void 0===p)p=h;else{let e=t+"|"+r+"|"+h.message_index;if(e in this.inboundGroupSessionMessageIndexes){let t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==i||t.timestamp!==l){c=Error("Duplicate message index, possible replay attack: "+e);return}}this.inboundGroupSessionMessageIndexes[e]={id:i,timestamp:l}}s.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,r,s,o),d={result:p,keysClaimed:s.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain||[],untrusted:!!s.untrusted}})},o.logger.getChild("[decryptGroupMessage]")),c)throw c;return d}async hasInboundSessionKeys(e,t,r){let n;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this.cryptoStore.getEndToEndInboundGroupSession(t,r,i,i=>{if(null===i){n=!1;return}e!==i.room_id?(o.logger.warn("requested keys for inbound group session ".concat(t,"|")+"".concat(r,", with incorrect room_id ")+"(expected ".concat(i.room_id,", ")+"was ".concat(e,")")),n=!1):n=!0})},o.logger.getChild("[hasInboundSessionKeys]")),n}async getInboundGroupSessionKey(e,t,r,n){let i=null;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,s.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.getInboundGroupSession(e,t,r,o,(e,t)=>{if(null===e||null===t){i=null;return}void 0===n&&(n=e.first_known_index());let r=e.export_session(n),o=(t.keysClaimed||{}).ed25519||null,s=t.forwardingCurve25519KeyChain||[],a="untrusted"in t?t.untrusted:s.length>0;i={chain_index:n,key:r,forwarding_curve25519_key_chain:s,sender_claimed_ed25519_key:o,shared_history:t.sharedHistory||!1,untrusted:a}})},o.logger.getChild("[getInboundGroupSessionKey]")),i}exportInboundGroupSession(e,t,r){return this.unpickleInboundGroupSession(r,n=>{let i=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:r.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":r.sharedHistory||!1}})}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[s.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],r=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,r)},o.logger.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,r){this.getUtility(function(n){n.ed25519_verify(e,t,r)})}constructor(e){(0,i.default)(this,"pickleKey","DEFAULT_KEY"),(0,i.default)(this,"deviceCurve25519Key",null),(0,i.default)(this,"deviceEd25519Key",null),(0,i.default)(this,"maxOneTimeKeys",null),(0,i.default)(this,"outboundGroupSessionStore",{}),(0,i.default)(this,"inboundGroupSessionMessageIndexes",{}),(0,i.default)(this,"sessionsInProgress",{}),(0,i.default)(this,"olmPrekeyPromise",Promise.resolve()),this.cryptoStore=e}}t.OlmDevice=p;let f=t.WITHHELD_MESSAGES={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function g(e){return e.code&&e.code in f?f[e.code]:e.reason?e.reason:"decryption key withheld"}},20900:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomKeyRequestState=t.OutgoingRoomKeyRequestManager=void 0;var i=n(r(13102)),o=r(2461),s=r(34002),a=r(15748),l=r(44480);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let u=500,h=t.RoomKeyRequestState=function(e){return e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",e}({});class p{stop(){s.logger.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(n)switch(n.state){case h.CancellationPendingAndWillResend:case h.Unsent:return;case h.CancellationPending:{let e=r?h.CancellationPendingAndWillResend:h.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,h.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case h.Sent:if(r){let i=h.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,h.Sent,{state:i,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,r);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){s.logger.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw Error("unhandled state: "+n.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:h.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case h.CancellationPending:case h.CancellationPendingAndWillResend:return;case h.Unsent:return s.logger.log("deleting unnecessary room key request for "+f(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,h.Unsent);case h.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,h.Sent,{state:h.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(t=>{if(!t){s.logger.log("Tried to cancel room key request for "+f(e)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{s.logger.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})});default:throw Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[h.Sent])}async cancelAndResendAllOutgoingRequests(){return Promise.all((await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(h.Sent)).map(e=>{let{requestBody:t,recipients:r}=e;return this.queueRoomKeyRequest(t,r,!0)}))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;let e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{s.logger.warn("error in OutgoingRoomKeyRequestManager: ".concat(e))})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,u)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}let e=await this.cryptoStore.getOutgoingRoomKeyRequestByState([h.CancellationPending,h.CancellationPendingAndWillResend,h.Unsent]);if(!e){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(e.state){case h.Unsent:await this.sendOutgoingRoomKeyRequest(e);break;case h.CancellationPending:await this.sendOutgoingRoomKeyRequestCancellation(e);break;case h.CancellationPendingAndWillResend:await this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return this.sendOutgoingRoomKeyRequests()}catch(e){s.logger.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=void 0}}sendOutgoingRoomKeyRequest(e){s.logger.log("Requesting keys for ".concat(f(e.requestBody))+" from ".concat(g(e.recipients))+"(id ".concat(e.requestId,")"));let t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,h.Unsent,{state:h.Sent}))}sendOutgoingRoomKeyRequestCancellation(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s.logger.log("Sending cancellation for key request for "+"".concat(f(e.requestBody)," to ")+"".concat(g(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));let r={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(r,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,h.CancellationPendingAndWillResend,{state:h.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,h.CancellationPending))}sendMessageToDevices(e,t,r){let n=new l.MapWithDefault(()=>new Map);for(let r of t)n.getOrCreate(r.userId).set(r.deviceId,d(d({},e),{},{[a.ToDeviceMessageId]:(0,o.v4)()}));return this.baseApis.sendToDevice(a.EventType.RoomKeyRequest,n,r)}constructor(e,t,r){(0,i.default)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,i.default)(this,"clientRunning",!0),this.baseApis=e,this.deviceId=t,this.cryptoStore=r}}function f(e){return e.room_id+" / "+e.session_id}function g(e){return"[".concat(e.map(e=>"".concat(e.userId,":").concat(e.deviceId)).join(","),"]")}t.OutgoingRoomKeyRequestManager=p},61225:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var i=n(r(13102)),o=r(87786);class s{async init(){await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],e=>{this.cryptoStore.getEndToEndRooms(e,e=>{this.roomEncryption=e})})}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return!!this.getRoomEncryption(e)}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],r=>{this.cryptoStore.storeEndToEndRoom(e,t,r)})}constructor(e){(0,i.default)(this,"roomEncryption",{}),this.cryptoStore=e}}t.RoomList=s},20384:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SecretSharing=void 0;var i=n(r(13102)),o=r(2461),s=r(44480),a=r(15748),l=r(34002),c=u(r(14995));function d(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(d=function(e){return e?r:t})(e)}function u(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=d(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}class h{request(e,t){let r=this.baseApis.makeTxnId(),n=(0,s.defer)();this.requests.set(r,{name:e,devices:t,deferred:n});let i=e=>{let i={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:r},o=new Map;for(let e of t)o.set(e,i);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),o]])),n.reject(Error(e||"Cancelled"))},c={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:r,[a.ToDeviceMessageId]:(0,o.v4)()},d=new Map;for(let e of t)d.set(e,c);return l.logger.info("Request secret ".concat(e," from ").concat(t,", id ").concat(r)),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),d]])),{requestId:r,promise:n.promise,cancel:i}}async onRequestReceived(e){let t=e.getSender(),r=e.getContent();if(t!==this.baseApis.getUserId()||!(r.name&&r.action&&r.requesting_device_id&&r.request_id))return;let n=r.requesting_device_id;if("request_cancellation"===r.action);else if("request"===r.action){if(n===this.baseApis.deviceId||(l.logger.info("received request for secret ("+t+", "+n+", "+r.request_id+")"),!this.cryptoCallbacks.onSecretRequested))return;let e=await this.cryptoCallbacks.onSecretRequested(t,n,r.request_id,r.name,this.baseApis.checkDeviceTrust(t,n));if(e){l.logger.info("Preparing ".concat(r.name," secret for ").concat(n));let i={type:"m.secret.send",content:{request_id:r.request_id,secret:e}},s={algorithm:c.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[a.ToDeviceMessageId]:(0,o.v4)()};await c.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[t,[this.baseApis.getStoredDevice(t,n)]]])),await c.encryptMessageForDevice(s.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,n),i);let d=new Map([[t,new Map([[n,s]])]]);l.logger.info("Sending ".concat(r.name," secret for ").concat(n)),this.baseApis.sendToDevice("m.room.encrypted",d)}else l.logger.info("Request denied for ".concat(r.name," secret for ").concat(n))}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!c.isOlmEncrypted(e)){l.logger.error("secret event not properly encrypted");return}let t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(c.OLM_ALGORITHM,e.getSenderKey()||"")!==e.getSender()){l.logger.error("sending device does not belong to the user it claims to be from");return}l.logger.log("got secret share for request",t.request_id);let r=this.requests.get(t.request_id);if(r){let n=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(c.OLM_ALGORITHM,e.getSenderKey());if(!n){l.logger.log("secret share from unknown device with key",e.getSenderKey());return}if(!r.devices.includes(n.deviceId)){l.logger.log("unsolicited secret share from device",n.deviceId);return}if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),n).isVerified()){l.logger.log("secret share from unverified device");return}l.logger.log("Successfully received secret ".concat(r.name," ")+"from ".concat(n.deviceId)),r.deferred.resolve(t.secret)}}constructor(e,t){(0,i.default)(this,"requests",new Map),this.baseApis=e,this.cryptoCallbacks=t}}t.SecretSharing=h},72424:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=void 0;var n=r(98466),i=r(20384);class o{getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,r){return this.storageImpl.addKey(e,t,r)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,r){return this.storageImpl.store(e,t,r)}get(e){return this.storageImpl.get(e)}async isStored(e){return this.storageImpl.isStored(e)}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}constructor(e,t,r){this.storageImpl=new n.ServerSideSecretStorageImpl(e,t),this.sharingImpl=new i.SecretSharing(r,t)}}t.SecretStorage=o},54410:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateKeyCheck=d,t.decryptAES=a,t.encryptAES=s;var n=r(98870),i=r(20763);let o=new Uint8Array(8);async function s(e,t,r,o){let s;o?s=(0,n.decodeBase64)(o):(s=new Uint8Array(16),i.crypto.getRandomValues(s),s[8]&=127);let[a,c]=await l(t,r),d=new i.TextEncoder().encode(e),u=await i.subtleCrypto.encrypt({name:"AES-CTR",counter:s,length:64},a,d),h=await i.subtleCrypto.sign({name:"HMAC"},c,u);return{iv:(0,n.encodeBase64)(s),ciphertext:(0,n.encodeBase64)(u),mac:(0,n.encodeBase64)(h)}}async function a(e,t,r){let[o,s]=await l(t,r),a=(0,n.decodeBase64)(e.ciphertext);if(!await i.subtleCrypto.verify({name:"HMAC"},s,(0,n.decodeBase64)(e.mac),a))throw Error("Error decrypting secret ".concat(r,": bad MAC"));let c=await i.subtleCrypto.decrypt({name:"AES-CTR",counter:(0,n.decodeBase64)(e.iv),length:64},o,a);return new TextDecoder().decode(new Uint8Array(c))}async function l(e,t){let r=await i.subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await i.subtleCrypto.deriveBits({name:"HKDF",salt:o,info:new i.TextEncoder().encode(t),hash:"SHA-256"},r,512),s=n.slice(0,32),a=n.slice(32);return Promise.all([i.subtleCrypto.importKey("raw",s,{name:"AES-CTR"},!1,["encrypt","decrypt"]),i.subtleCrypto.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"])])}let c="\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";function d(e,t){return s(c,e,"",t)}},85838:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnknownDeviceError=t.EncryptionAlgorithm=t.ENCRYPTION_CLASSES=t.DecryptionError=t.DecryptionAlgorithm=t.DECRYPTION_CLASSES=void 0,t.registerAlgorithm=c;let r=t.ENCRYPTION_CLASSES=new Map,n=t.DECRYPTION_CLASSES=new Map;class i{prepareToEncrypt(e){}onRoomMembership(e,t,r){}constructor(e){this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}}t.EncryptionAlgorithm=i;class o{async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}constructor(e){this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}}t.DecryptionAlgorithm=o;class s extends Error{constructor(e,t,r){super(t),this.code=e,this.code=e,this.name="DecryptionError",this.detailedString=a(this,r)}}function a(e,t){let r=e.name+"[msg: "+e.message;return t&&(r+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", ")),r+="]"}t.DecryptionError=s;class l extends Error{constructor(e,t,r){super(e),this.devices=t,this.event=r,this.name="UnknownDeviceError",this.devices=t}}function c(e,t,i){r.set(e,t),n.set(e,i)}t.UnknownDeviceError=l},22079:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(1564),r(96229);var n=r(85838);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))})},96229:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MegolmEncryption=t.MegolmDecryption=void 0,t.isRoomSharedHistory=v;var i=n(r(13102)),o=r(2461),s=r(34002),a=f(r(14995)),l=r(85838),c=r(10845),d=r(15748),u=r(20900),h=r(44480);function p(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(p=function(e){return e?r:t})(e)}function f(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=p(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function m(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?g(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function v(e){var t,r;let n=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility","");return["world_readable","shared"].includes(null==n||null===(r=n.getContent())||void 0===r?void 0:r.history_visibility)}let y=e=>"string"==typeof e.ciphertext?!!e.ciphertext.length:!!Object.keys(e.ciphertext).length;class b{needsRotation(e,t){let r=new Date().getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(s.logger.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)}markSharedWithDevice(e,t,r,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:r,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(let[r,n]of this.sharedWithDevices){if(!e.has(r))return s.logger.log("Starting new megolm session because we shared with "+r),!0;for(let[i]of n){var t;if(!(null!==(t=e.get(r))&&void 0!==t&&t.get(i)))return s.logger.log("Starting new megolm session because we shared with "+r+":"+i),!0}}return!1}constructor(e,t=!1){(0,i.default)(this,"useCount",0),(0,i.default)(this,"sharedWithDevices",new h.MapWithDefault(()=>new Map)),(0,i.default)(this,"blockedDevicesNotified",new h.MapWithDefault(()=>new Map)),this.sessionId=e,this.sharedHistory=t,this.creationTime=new Date().getTime()}}class S extends l.EncryptionAlgorithm{async ensureOutboundSession(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=async i=>{let o=v(e),s=await this.prepareSession(t,o,i);return await this.shareSession(t,o,n,r,s),s},o=this.setupPromise.then(i);return this.setupPromise=o.catch(e=>(this.prefixedLogger.error("Failed to setup outbound session",e),null)),o}async prepareSession(e,t,r){var n,i;return r&&t!==r.sharedHistory&&(r=null),null!==(n=r)&&void 0!==n&&n.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.debug("Starting new megolm session because we need to rotate."),r=null),null!==(i=r)&&void 0!==i&&i.sharedWithTooManyDevices(e)&&(r=null),r||(this.prefixedLogger.debug("Starting new megolm session"),r=await this.prepareNewSession(t),this.prefixedLogger.debug("Started new megolm session ".concat(r.sessionId)),this.outboundSessions[r.sessionId]=r),r}async shareSession(e,t,r,n,i){let o={};for(let[t,r]of e)for(let[e,n]of r){var s;n.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(null!==(s=i.sharedWithDevices.get(t))&&void 0!==s&&s.get(e)||(o[t]=o[t]||[],o[t].push(n)))}let l=this.olmDevice.getOutboundGroupSessionKey(i.sessionId),c={type:"m.room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:i.sessionId,session_key:l.key,chain_index:l.chain_index,"org.matrix.msc3061.shared_history":t}},[d,u]=await a.getExistingOlmSessions(this.olmDevice,this.baseApis,o);await Promise.all([(async()=>{let e=Array.from(u.entries()).map(e=>{let[t,r]=e;return Array.from(r.entries()).map(e=>{let[r,n]=e;return"".concat(t,"/").concat(r,": ").concat(n.sessionId)})}).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",e),await this.shareKeyWithOlmSessions(i,l,c,u),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{let e=Array.from(d.entries()).map(e=>{let[t,r]=e;return r.map(e=>"".concat(t,"/").concat(e.deviceId))}).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",e);let t=[],n=Date.now(),o=[];await this.shareKeyWithDevices(i,l,c,d,t,r?1e4:2e3,o),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!r&&Date.now()-n<1e4?(async()=>{let e=new h.MapWithDefault(()=>[]),r=new Set;for(let e of o)r.add(e);let n=[];for(let{userId:i,deviceInfo:o}of t){let t=i.slice(i.indexOf(":")+1);r.has(t)?e.getOrCreate(i).push(o):n.push({userId:i,deviceInfo:o})}let s=Array.from(e.entries()).map(e=>{let[t,r]=e;return r.map(e=>"".concat(t,"/").concat(e.deviceId))}).flat(1);s.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",s),await this.shareKeyWithDevices(i,l,c,e,n,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(i,l,n)})():await this.notifyFailedOlmDevices(i,l,t)})(),(async()=>{this.prefixedLogger.debug("There are ".concat(n.size," blocked devices:"),Array.from(n.entries()).map(e=>{let[t,r]=e;return Array.from(r.entries()).map(e=>{let[r,n]=e;return"".concat(t,"/").concat(r)})}).flat(1));let e=new h.MapWithDefault(()=>new Map),t=0;for(let[o,s]of n)for(let[n,a]of s){var r;(null===(r=i.blockedDevicesNotified.get(o))||void 0===r?void 0:r.get(n))===void 0&&(e.getOrCreate(o).set(n,{device:a}),t++)}t&&(this.prefixedLogger.debug("Notifying ".concat(t," newly blocked devices:"),Array.from(e.entries()).map(e=>{let[t,r]=e;return Object.entries(r).map(e=>{let[r,n]=e;return"".concat(t,"/").concat(r)})}).flat(1)),await this.notifyBlockedDevices(i,e),this.prefixedLogger.debug("Notified ".concat(t," newly blocked devices")))})()])}async prepareNewSession(e){let t=this.olmDevice.createOutboundGroupSession(),r=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,r.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new b(t,e)}getDevicesWithoutSessions(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(let[n,i]of t){let t=e.get(n);for(let e of i){let i=e.deviceId,o=null==t?void 0:t.get(i);if(!(null!=o&&o.sessionId)){r.push({userId:n,deviceInfo:e}),null==t||t.delete(i);continue}}}return r}splitDevices(e){let t=20,r=[],n=[r];for(let[i,o]of e){for(let e of o.values())r.push({userId:i,deviceInfo:e.device});r.length>t&&(r=[],n.push(r))}return 0===r.length&&n.pop(),n}encryptAndSendKeysToDevices(e,t,r,n){return this.crypto.encryptAndSendToDevices(r,n).then(()=>{for(let n of r)e.markSharedWithDevice(n.userId,n.deviceInfo.deviceId,n.deviceInfo.getIdentityKey(),t)}).catch(e=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",e),e})}async sendBlockedNotificationsToDevices(e,t,r){let n=new h.MapWithDefault(()=>new Map);for(let e of t){let t=e.userId,i=e.deviceInfo,s=i.deviceInfo.deviceId,a=m(m({},r),{},{code:i.code,reason:i.reason,[d.ToDeviceMessageId]:(0,o.v4)()});"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),n.getOrCreate(t).set(s,a)}for(let[t,r]of(await this.baseApis.sendToDevice("m.room_key.withheld",n),n))for(let n of r.keys())e.markNotifiedBlockedDevice(t,n)}async reshareKeyWithDevice(e,t,r,n){var i;let s=this.outboundSessions[t];if(!s){this.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," not found: not re-sharing keys"));return}if(!s.sharedWithDevices.has(r)){this.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with user ").concat(r));return}let l=null===(i=s.sharedWithDevices.get(r))||void 0===i?void 0:i.get(n.deviceId);if(void 0===l){this.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with device ").concat(r,":").concat(n.deviceId));return}if(l.deviceKey!==n.getIdentityKey()){this.prefixedLogger.warn("Megolm session ".concat(e,"|").concat(t," has been shared with device ").concat(n.deviceId," but ")+"with identity key ".concat(l.deviceKey,". Key is now ").concat(n.getIdentityKey(),"!"));return}let c=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,l.messageIndex);if(!c){this.prefixedLogger.warn("No inbound session key found for megolm session ".concat(e,"|").concat(t,": not re-sharing keys"));return}await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[r,[n]]]));let u={type:"m.forwarded_room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},h={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.ToDeviceMessageId]:(0,o.v4)()};await a.encryptMessageForDevice(h.ciphertext,this.userId,this.deviceId,this.olmDevice,r,n,u),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[r,new Map([[n.deviceId,h]])]])),this.prefixedLogger.debug("Re-shared key for megolm session ".concat(e,"|").concat(t," with ").concat(r,":").concat(n.deviceId))}async shareKeyWithDevices(e,t,r,n,i,o,s){let l=await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,n,!1,o,s,this.prefixedLogger);this.getDevicesWithoutSessions(l,n,i),await this.shareKeyWithOlmSessions(e,t,r,l)}async shareKeyWithOlmSessions(e,t,r,n){let i=this.splitDevices(n);for(let n=0;n<i.length;n++){let o="megolm keys for ".concat(e.sessionId," (slice ").concat(n+1,"/").concat(i.length,")");try{this.prefixedLogger.debug("Sharing ".concat(o),i[n].map(e=>"".concat(e.userId,"/").concat(e.deviceInfo.deviceId))),await this.encryptAndSendKeysToDevices(e,t.chain_index,i[n],r),this.prefixedLogger.debug("Shared ".concat(o))}catch(e){throw this.prefixedLogger.error("Failed to share ".concat(o)),e}}}async notifyFailedOlmDevices(e,t,r){for(let{userId:n,deviceInfo:i}of(this.prefixedLogger.debug("Notifying ".concat(r.length," devices we failed to create Olm sessions")),r)){let r=i.deviceId;e.markSharedWithDevice(n,r,i.getIdentityKey(),t.chain_index)}let n=await this.olmDevice.filterOutNotifiedErrorDevices(r);this.prefixedLogger.debug("Need to notify ".concat(n.length," failed devices which haven't been notified before"));let i=new h.MapWithDefault(()=>new Map);for(let{userId:e,deviceInfo:t}of n)i.getOrCreate(e).set(t.deviceId,{device:{code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:t}});await this.notifyBlockedDevices(e,i),this.prefixedLogger.debug("Notified ".concat(n.length," devices we failed to create Olm sessions"))}async notifyBlockedDevices(e,t){let r={room_id:this.roomId,session_id:e.sessionId,algorithm:a.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},n=this.splitDevices(t);for(let t=0;t<n.length;t++)try{await this.sendBlockedNotificationsToDevices(e,n[t],r),this.prefixedLogger.debug("Completed blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(t+1,"/").concat(n.length,")"))}catch(r){throw this.prefixedLogger.debug("blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(t+1,"/").concat(n.length,") failed")),r}}prepareToEncrypt(e){if(e.roomId!==this.roomId)throw Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){let e=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug("Already started preparing to encrypt for this room ".concat(e,"ms ago, skipping")),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let t=!1,r=()=>t;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{let t=await this.getDevicesInRoom(e,!1,r);if(null===t)return;let[n,i]=t;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(n),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(e,n,i,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(e){this.prefixedLogger.error("Failed to prepare to encrypt events",e)}finally{delete this.encryptionPreparation}})(),cancel:()=>{t=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(e,t,r){if(this.prefixedLogger.debug("Starting to encrypt event"),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(e){}let n=this.isVerificationEvent(t,r),[i,o]=await this.getDevicesInRoom(e,n);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(i);let s=await this.ensureOutboundSession(e,i,o),l={room_id:this.roomId,type:t,content:r},c=this.olmDevice.encryptGroupMessage(s.sessionId,JSON.stringify(l)),d={algorithm:a.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:c,session_id:s.sessionId,device_id:this.deviceId};return s.useCount++,d}isVerificationEvent(e,t){switch(e){case d.EventType.KeyVerificationCancel:case d.EventType.KeyVerificationDone:case d.EventType.KeyVerificationMac:case d.EventType.KeyVerificationStart:case d.EventType.KeyVerificationKey:case d.EventType.KeyVerificationReady:case d.EventType.KeyVerificationAccept:return!0;case d.EventType.RoomMessage:return t.msgtype===d.MsgType.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){let t=new h.MapWithDefault(()=>new Map);for(let[r,n]of e)for(let[e,i]of n)i.isUnverified()&&!i.isKnown()&&t.getOrCreate(r).set(e,i);if(t.size)throw new l.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(let[t,r]of e){for(let[e,t]of r)t.isUnverified()&&!t.isKnown()&&r.delete(e);0===r.size&&e.delete(t)}}async getDevicesInRoom(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2?arguments[2]:void 0,n=await e.getEncryptionTargetMembers();this.prefixedLogger.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(e.shouldEncryptForInvitedMembers(),"):"),n.map(e=>"".concat(e.userId," (").concat(e.membership,")")));let i=n.map(function(e){return e.userId}),o=this.crypto.globalBlacklistUnverifiedDevices,s=e.getBlacklistUnverifiedDevices();"boolean"==typeof s&&(o=s);let a=await this.crypto.downloadKeys(i,!1);if((null==r?void 0:r())===!0)return null;let l=new h.MapWithDefault(()=>new Map);for(let[e,n]of a)for(let[i,s]of n){if(void 0!==r&&await (0,h.immediate)(),(null==r?void 0:r())===!0)return null;let a=this.crypto.checkDeviceTrust(e,i);if(s.isBlocked()||!a.isVerified()&&o&&!t){let t=l.getOrCreate(e),r=s.isBlocked();t.set(i,{code:r?"m.blacklisted":"m.unverified",reason:c.WITHHELD_MESSAGES[r?"m.blacklisted":"m.unverified"],deviceInfo:s}),n.delete(i)}}return[a,l]}constructor(e){var t,r,n,o;super(e),(0,i.default)(this,"setupPromise",Promise.resolve(null)),(0,i.default)(this,"outboundSessions",{}),this.roomId=e.roomId,this.prefixedLogger=s.logger.getChild("[".concat(this.roomId," encryption]")),this.sessionRotationPeriodMsgs=null!==(t=null===(r=e.config)||void 0===r?void 0:r.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(n=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==n?n:6048e5}}t.MegolmEncryption=S;class E extends l.DecryptionAlgorithm{async decryptEvent(e){let t;let r=e.getWireContent();if(!r.sender_key||!r.session_id||!r.ciphertext)throw new l.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");this.addEventToPendingList(e);try{t=await this.olmDevice.decryptGroupMessage(e.getRoomId(),r.sender_key,r.session_id,r.ciphertext,e.getId(),e.getTs())}catch(n){if("DecryptionError"===n.name)throw n;let t="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw(null==n?void 0:n.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(this.requestKeysForEvent(e),t="OLM_UNKNOWN_MESSAGE_INDEX"),new l.DecryptionError(t,n instanceof Error?n.message:"Unknown Error: Error is undefined",{session:r.sender_key+"|"+r.session_id})}if(null===t){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),r.session_id).catch(()=>{}),this.requestKeysForEvent(e);let t=await this.olmDevice.sessionMayHaveProblems(r.sender_key,e.getTs()-12e4);if(t){this.prefixedLogger.info("When handling UISI from ".concat(e.getSender()," (sender key ").concat(r.sender_key,"): ")+"recent session problem with that sender:",t);let n=_[t.type]||_.unknown;throw t.fixed&&(n+=" Trying to create a new secure channel and re-requesting the keys."),new l.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",n,{session:r.sender_key+"|"+r.session_id})}throw new l.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:r.sender_key+"|"+r.session_id})}t.untrusted||this.removeEventFromPendingList(e);let n=JSON.parse(t.result);if(n.room_id!==e.getRoomId())throw new l.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:t.senderKey,claimedEd25519Key:t.keysClaimed.ed25519,forwardingCurve25519KeyChain:t.forwardingCurve25519KeyChain,untrusted:t.untrusted}}requestKeysForEvent(e){let t=e.getWireContent(),r=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)}addEventToPendingList(e){var t;let r=e.getWireContent(),n=r.sender_key,i=r.session_id;this.pendingEvents.has(n)||this.pendingEvents.set(n,new Map);let o=this.pendingEvents.get(n);o.has(i)||o.set(i,new Set),null===(t=o.get(i))||void 0===t||t.add(e)}removeEventFromPendingList(e){let t=e.getWireContent(),r=t.sender_key,n=t.session_id,i=this.pendingEvents.get(r),o=null==i?void 0:i.get(n);o&&(o.delete(e),0===o.size&&i.delete(n),0===i.size&&this.pendingEvents.delete(r))}roomKeyFromEvent(e){let t=e.getSenderKey(),r=e.getContent(),n={};if(!r.room_id||!r.session_key||!r.session_id||!r.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!a.isOlmEncrypted(e)){this.prefixedLogger.error("key event not properly encrypted");return}return r["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),{senderKey:t,sessionId:r.session_id,sessionKey:r.session_key,extraSessionData:n,exportFormat:!1,roomId:r.room_id,algorithm:r.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()}}forwardedRoomKeyFromEvent(e){let t=this.roomKeyFromEvent(e);if(!t)return;let r=e.getSenderKey(),n=e.getContent(),i=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.OLM_ALGORITHM,r),o=n.sender_key,s=n.sender_claimed_ed25519_key,l=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if((l=l.slice()).push(r),i!==e.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!o){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!s){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}let c={ed25519:s};return t.senderKey=o,t.keysClaimed=c,t.exportFormat=!0,t.forwardingKeyChain=l,t.extraSessionData.untrusted=!0,t}async shouldAcceptForwardedKey(e,t){var r;let n=e.getSenderKey(),i=null!==(r=this.crypto.deviceList.getDeviceByIdentityKey(a.OLM_ALGORITHM,n))&&void 0!==r?r:void 0,o=this.crypto.checkDeviceInfoTrust(e.getSender(),i),s=e.getSender()===this.baseApis.getUserId(),l=o.isVerified()&&s,c=await this.wasRoomKeyRequested(e,t),d=this.wasRoomKeyForwardedByInviter(e,t),u=this.wasRoomKeyForwardedAsHistory(t);return c&&l||d&&u}async wasRoomKeyRequested(e,t){return(await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[u.RoomKeyRequestState.Sent])).some(e=>e.requestBody.room_id===t.roomId&&e.requestBody.session_id===t.sessionId)}wasRoomKeyForwardedByInviter(e,t){var r,n,i;let o=this.baseApis.getRoom(t.roomId),s=e.getSenderKey();if(!s)return!1;let l=this.crypto.deviceList.getUserByIdentityKey(a.OLM_ALGORITHM,s);if(!l)return!1;let c=null==o||null===(r=o.getMember(this.userId))||void 0===r?void 0:r.events.member,d=(null==c?void 0:c.getSender())===l||(null==c||null===(n=c.getUnsigned())||void 0===n?void 0:n.prev_sender)===l&&(null==c||null===(i=c.getPrevContent())||void 0===i?void 0:i.membership)==="invite";return!!o&&!!d}wasRoomKeyForwardedAsHistory(e){return!!this.baseApis.getRoom(e.roomId)&&!!e.extraSessionData.sharedHistory}shouldParkForwardedKey(e){return!this.baseApis.getRoom(e.roomId)&&!!e.extraSessionData.sharedHistory}async parkForwardedKey(e,t){let r={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],e=>this.crypto.cryptoStore.addParkedSharedHistory(t.roomId,r,e),s.logger.getChild("[addParkedSharedHistory]"))}async addRoomKey(e){try{await this.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),await this.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),await this.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(e){this.prefixedLogger.error("Error handling m.room_key_event: ".concat(e))}}async onForwardedRoomKey(e){let t=this.forwardedRoomKeyFromEvent(e);t&&(await this.shouldAcceptForwardedKey(e,t)?await this.addRoomKey(t):this.shouldParkForwardedKey(t)&&await this.parkForwardedKey(e,t))}async onRoomKeyEvent(e){if("m.forwarded_room_key"==e.getType())await this.onForwardedRoomKey(e);else{let t=this.roomKeyFromEvent(e);if(!t)return;await this.addRoomKey(t)}}async onRoomKeyWithheldEvent(e){let t=e.getContent(),r=t.sender_key;"m.no_olm"===t.code?await this.onNoOlmWithheldEvent(e):"m.unavailable"===t.code||await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,r,t.session_id,t.code,t.reason),t.session_id?await this.retryDecryption(r,t.session_id):await this.retryDecryptionFromSender(r)}async onNoOlmWithheldEvent(e){let t=e.getContent(),r=t.sender_key,n=e.getSender();if(this.prefixedLogger.warn("".concat(n,":").concat(r," was unable to establish an olm session with us")),await this.olmDevice.getSessionIdForDevice(r)){this.prefixedLogger.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(r,"no_olm",!0);return}let i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,r);if(!i&&(await this.crypto.downloadKeys([n],!1),!(i=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,r)))){this.prefixedLogger.info("Couldn't find device for identity key "+r+": not establishing session"),await this.olmDevice.recordSessionProblem(r,"no_olm",!1);return}await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[n,[i]]]),!1);let s={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.ToDeviceMessageId]:(0,o.v4)()};await a.encryptMessageForDevice(s.ciphertext,this.userId,void 0,this.olmDevice,n,i,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(r,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[i.deviceId,s]])]]))}hasKeysForKeyRequest(e){let t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){let t=e.userId,r=e.deviceId,n=this.crypto.getStoredDevice(t,r),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then(e=>{var n;let o=null===(n=e.get(t))||void 0===n?void 0:n.get(r);return null!=o&&o.sessionId?(this.prefixedLogger.debug("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+r),this.buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null}).then(e=>{let i={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.ToDeviceMessageId]:(0,o.v4)()};return this.olmlib.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,t,n,e).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[r,i]])]])))})}async buildKeyForwardingMessage(e,t,r){let n=await this.olmDevice.getInboundGroupSessionKey(e,t,r);return{type:"m.forwarded_room_key",content:{algorithm:a.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:r,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}}importRoomKey(e){let{untrusted:t,source:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then(()=>{"backup"!==r&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(e=>{this.prefixedLogger.debug("Failed to back up megolm session",e)}),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)})}async retryDecryption(e,t,r){var n;let i=this.pendingEvents.get(e);if(!i)return!0;let o=i.get(t);if(!o)return!0;let s=[...o];return this.prefixedLogger.debug("Retrying decryption on events:",s.map(e=>"".concat(e.getId()))),await Promise.all(s.map(async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:r})}catch(e){}})),!(null!==(n=this.pendingEvents.get(e))&&void 0!==n&&n.has(t))}async retryDecryptionFromSender(e){let t=this.pendingEvents.get(e);return!t||(this.pendingEvents.delete(e),await Promise.all([...t].map(async e=>{let[t,r]=e;await Promise.all([...r].map(async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}}))})),!this.pendingEvents.has(e))}async sendSharedHistoryInboundSessions(e){await a.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e);let t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);for(let[r,n]of(this.prefixedLogger.debug("Sharing history in with users ".concat(Array.from(e.keys())),t.map(e=>{let[t,r]=e;return"".concat(t,"|").concat(r)})),t)){let t=await this.buildKeyForwardingMessage(this.roomId,r,n),i=[],s=new Map;for(let[r,n]of e){let e=new Map;for(let l of(s.set(r,e),n)){let n={algorithm:a.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[d.ToDeviceMessageId]:(0,o.v4)()};e.set(l.deviceId,n),i.push(a.encryptMessageForDevice(n.ciphertext,this.userId,void 0,this.olmDevice,r,l,t))}}for(let[e,t]of(await Promise.all(i),s)){for(let[r,n]of t)y(n)||(this.prefixedLogger.debug("No ciphertext for device "+e+":"+r+": pruning"),t.delete(r));0===t.size&&(this.prefixedLogger.debug("Pruned all devices for user "+e),s.delete(e))}if(0===s.size){this.prefixedLogger.debug("No users left to send to: aborting");return}await this.baseApis.sendToDevice("m.room.encrypted",s)}}constructor(e){super(e),(0,i.default)(this,"pendingEvents",new Map),(0,i.default)(this,"olmlib",a),this.roomId=e.roomId,this.prefixedLogger=s.logger.getChild("[".concat(this.roomId," decryption]"))}}t.MegolmDecryption=E;let _={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,l.registerAlgorithm)(a.MEGOLM_ALGORITHM,S,E)},1564:function(e,t,r){"use strict";var n=r(53058)(r(13102)),i=r(34002),o=c(r(14995)),s=r(5382),a=r(85838);function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(l=function(e){return e?r:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=l(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}let d=s.DeviceInfo.DeviceVerification;class u extends a.EncryptionAlgorithm{ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(()=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}async encryptMessage(e,t,r){let n=(await e.getEncryptionTargetMembers()).map(function(e){return e.userId});await this.ensureSession(n);let i={room_id:e.roomId,type:t,content:r},s={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},a=[];for(let e of n)for(let t of this.crypto.getStoredDevicesForUser(e)||[])t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&t.verified!=d.BLOCKED&&a.push(o.encryptMessageForDevice(s.ciphertext,this.userId,this.deviceId,this.olmDevice,e,t,i));return Promise.all(a).then(()=>s)}constructor(...e){super(...e),(0,n.default)(this,"sessionPrepared",!1),(0,n.default)(this,"prepPromise",null)}}class h extends a.DecryptionAlgorithm{async decryptEvent(e){let t;let r=e.getWireContent(),n=r.sender_key,i=r.ciphertext;if(!i)throw new a.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in i))throw new a.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");let s=i[this.olmDevice.deviceCurve25519Key];try{t=await this.decryptMessage(n,s)}catch(e){throw new a.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e})}let l=JSON.parse(t);if(l.recipient!=this.userId)throw new a.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+l.recipient);if(l.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new a.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:l.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});let c=this.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,n);if(null==c){try{await this.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(e){throw new a.DecryptionError("OLM_BAD_SENDER_CHECK_FAILED","Could not verify sender identity",{sender:n,err:e})}c=this.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,n)}if(c!==e.getSender()&&null!=c)throw new a.DecryptionError("OLM_BAD_SENDER","Message claimed to be from "+e.getSender(),{real_sender:c});if(l.sender!=e.getSender())throw new a.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+l.sender,{reported_sender:e.getSender()});if(l.room_id!==e.getRoomId())throw new a.DecryptionError("OLM_BAD_ROOM","Message intended for room "+l.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});let d=l.keys||{};return{clearEvent:l,senderCurve25519Key:n,claimedEd25519Key:d.ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{let r=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=r.catch(()=>{}),r}}async reallyDecryptMessage(e,t){let r;let n=await this.olmDevice.getSessionIdsForDevice(e),o={};for(let r of n)try{let n=await this.olmDevice.decryptMessage(e,r,t.type,t.body);return i.logger.log("Decrypted Olm message from "+e+" with session "+r),n}catch(n){if(await this.olmDevice.matchesSession(e,r,t.type,t.body))throw Error("Error decrypting prekey message with existing session id "+r+": "+n.message);o[r]=n.message}if(0!==t.type){if(0===n.length)throw Error("No existing sessions");throw Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(o))}try{r=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw o["(new)"]=e.message,Error("Error decrypting prekey message: "+JSON.stringify(o))}return i.logger.log("created new inbound Olm session ID "+r.session_id+" with "+e),r.payload}}(0,a.registerAlgorithm)(o.OLM_ALGORITHM,u,h)},75661:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"CrossSigningKey",{enumerable:!0,get:function(){return n.CrossSigningKey}});var n=r(68995)},80323:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.algorithmsByName=t.LibOlmBackupDecryptor=t.DefaultAlgorithm=t.Curve25519=t.BackupManager=t.Aes256=void 0,t.backupTrustInfoFromLegacyTrustInfo=O;var i=n(r(13102)),o=r(32950),s=r(34002),a=r(14995),l=r(53978),c=r(44480),d=r(87786),u=r(41806),h=r(54410),p=r(87225),f=r(94161),g=r(20763),m=r(498);let v=200,y=5e3;class b{stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){let t=T[e.algorithm];if(!t)throw Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){let r=T[e.algorithm];if(!r)throw Error("Unknown backup algorithm");return r.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await b.makeAlgorithm(e,this.getKey),this.baseApis.emit(f.CryptoEvent.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(f.CryptoEvent.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}async prepareKeyBackupVersion(e,t){let r=t?T[t]:I;if(!r)throw Error("Unknown backup algorithm");let[n,i]=await r.prepare(e),o=(0,u.encodeRecoveryKey)(n);return{algorithm:r.algorithmName,auth_data:i,recovery_key:o,privateKey:n}}async createKeyBackupVersion(e){this.algorithm=await b.makeAlgorithm(e,this.getKey)}async deleteAllKeyBackupVersions(){var e,t,r,n;let i=null!==(e=null===(t=await this.baseApis.getKeyBackupVersion())||void 0===t?void 0:t.version)&&void 0!==e?e:null;for(;null!=i;)await this.deleteKeyBackupVersion(i),this.disableKeyBackup(),i=null!==(r=null===(n=await this.baseApis.getKeyBackupVersion())||void 0===n?void 0:n.version)&&void 0!==r?r:null}async deleteKeyBackupVersion(e){let t=(0,c.encodeUri)("/room_keys/version/$version",{$version:e});await this.baseApis.http.authedRequest(m.Method.Delete,t,void 0,void 0,{prefix:m.ClientPrefix.V3})}async checkAndStart(){let e;if(s.logger.log("Checking key backup status..."),this.baseApis.isGuest())return s.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;try{var t;e=null!==(t=await this.baseApis.getKeyBackupVersion())&&void 0!==t?t:void 0}catch(e){return s.logger.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;let r=await this.isKeyBackupTrusted(e);return r.usable&&!this.backupInfo?(s.logger.log("Found usable key backup v".concat(e.version,": enabling key backups")),await this.enableKeyBackup(e)):!r.usable&&this.backupInfo?(s.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):r.usable||this.backupInfo?r.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(s.logger.log("On backup version ".concat(this.backupInfo.version," but ")+"found version ".concat(e.version,": switching.")),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):s.logger.log("Backup version ".concat(e.version," still current"))):s.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:r}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;let r=new Date().getTime();(!this.sessionLastCheckAttemptedTime[t]||r-this.sessionLastCheckAttemptedTime[t]>y)&&(this.sessionLastCheckAttemptedTime[t]=r,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){let t={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return s.logger.info("Key backup is absent or missing required data: ".concat(JSON.stringify(e))),t;let r=this.baseApis.getUserId(),n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let r=null;try{r=await b.makeAlgorithm(e,async()=>n),await r.keyMatches(n)&&(s.logger.info("Backup is trusted locally"),t.trusted_locally=!0)}catch(e){}finally{var i;null===(i=r)||void 0===i||i.free()}}for(let n of Object.keys(e.auth_data.signatures[r]||{})){let i=n.split(":");if("ed25519"!==i[0]){s.logger.log("Ignoring unknown signature type: "+i[0]);continue}let o={deviceId:i[1]},l=this.baseApis.crypto.crossSigningInfo.getId();if(l===o.deviceId){o.crossSigningId=!0;try{await (0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,r,o.deviceId,l),o.valid=!0}catch(e){s.logger.warn("Bad signature from cross signing key "+l,e),o.valid=!1}t.sigs.push(o);continue}let c=this.baseApis.crypto.deviceList.getStoredDevice(r,o.deviceId);if(c){o.device=c,o.deviceTrust=this.baseApis.checkDeviceTrust(r,o.deviceId);try{await (0,a.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,r,c.deviceId,c.getFingerprint()),o.valid=!0}catch(t){s.logger.info("Bad signature from key ID "+n+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),o.valid=!1}}else o.valid=null,s.logger.info("Ignoring signature from unknown key "+n);t.sigs.push(o)}return t.usable=t.sigs.some(e=>{var t;return e.valid&&(e.device&&(null===(t=e.deviceTrust)||void 0===t?void 0:t.isVerified())||e.crossSigningId)}),t}async scheduleKeyBackupSend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;if(s.logger.debug("Key backup: scheduleKeyBackupSend currentSending:".concat(this.sendingBackups," delay:").concat(e)),!this.sendingBackups){this.sendingBackups=!0;try{let t=Math.random()*e;if(await (0,c.sleep)(t),!this.clientRunning){this.sendingBackups=!1;return}let r=0;for(;;){if(!this.algorithm)return;try{let e=await this.backupPendingKeys(v);if(0===e){this.sendingBackups=!1;return}r=0}catch(e){if(r++,s.logger.log("Key backup request failed",e),e instanceof m.MatrixError){let t=e.data.errcode;if("M_NOT_FOUND"==t||"M_WRONG_ROOM_KEYS_VERSION"==t){this.sendingBackups=!1,this.baseApis.crypto.emit(f.CryptoEvent.KeyBackupFailed,t),await this.checkKeyBackup();return}}}if(r&&await (0,c.sleep)(1e3*Math.pow(2,Math.min(r-1,4))),!this.clientRunning){s.logger.debug("Key backup send loop aborted, client stopped"),this.sendingBackups=!1;return}}}catch(e){s.logger.log("Backup loop failed ".concat(e)),this.sendingBackups=!1}}}async backupPendingKeys(e){let t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let r=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(f.CryptoEvent.KeyBackupSessionsRemaining,r);let n={};for(let e of t){var i;let t=e.sessionData.room_id;(0,c.safeSet)(n,t,n[t]||{sessions:{}});let r=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);r.algorithm=a.MEGOLM_ALGORITHM;let o=(r.forwarding_curve25519_key_chain||[]).length,s=this.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey),l=null!==(i=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,e.senderKey))&&void 0!==i?i:void 0,d=this.baseApis.crypto.checkDeviceInfoTrust(s,l).isVerified();(0,c.safeSet)(n[t].sessions,e.sessionId,{first_message_index:r.first_known_index,forwarded_count:o,is_verified:d,session_data:await this.algorithm.encryptSession(r)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),r=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(f.CryptoEvent.KeyBackupSessionsRemaining,r),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,d.IndexedDBCryptoStore.STORE_BACKUP],e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)})});let e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(f.CryptoEvent.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}constructor(e,t){(0,i.default)(this,"sessionLastCheckAttemptedTime",{}),(0,i.default)(this,"clientRunning",!0),this.baseApis=e,this.getKey=t,this.checkedForBackup=!1,this.sendingBackups=!1}}t.BackupManager=b;class S{static async init(e,t){if(!e||!("public_key"in e))throw Error("auth_data missing required information");let n=new r.g.Olm.PkEncryption;return n.set_recipient_key(e.public_key),new S(e,n,t)}static async prepare(e){let t=new r.g.Olm.PkDecryption;try{let n={};if(e){if(e instanceof Uint8Array)n.public_key=t.init_with_private_key(e);else{let r=await (0,l.keyFromPassphrase)(e);n.private_key_salt=r.salt,n.private_key_iterations=r.iterations,n.public_key=t.init_with_private_key(r.key)}}else n.public_key=t.generate_key();return new r.g.Olm.PkEncryption().set_recipient_key(n.public_key),[t.get_private_key(),n]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){let t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){let t=await this.getKey(),n=new r.g.Olm.PkDecryption;try{if(n.init_with_private_key(t)!==this.authData.public_key)throw new m.MatrixError({errcode:o.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY});let r=[];for(let[t,i]of Object.entries(e))try{let e=JSON.parse(n.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));e.session_id=t,r.push(e)}catch(e){s.logger.log("Failed to decrypt megolm session from backup",e,i)}return r}finally{n.free()}}async keyMatches(e){let t;let n=new r.g.Olm.PkDecryption;try{t=n.init_with_private_key(e)}finally{n.free()}return t===this.authData.public_key}free(){this.publicKey.free()}constructor(e,t,r){this.authData=e,this.publicKey=t,this.getKey=r}}function E(e){let t=new Uint8Array(e);return g.crypto.getRandomValues(t),t}t.Curve25519=S,(0,i.default)(S,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");let _=new p.UnstableValue("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class w{static async init(e,t){if(!e)throw Error("auth_data missing");let r=await t();if(e.mac){let{mac:t}=await (0,h.calculateKeyCheck)(r,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw Error("Key does not match")}return new w(e,r)}static async prepare(e){let t;let r={};if(e){if(e instanceof Uint8Array)t=new Uint8Array(e);else{let n=await (0,l.keyFromPassphrase)(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,t=n.key}}else t=E(32);let{iv:n,mac:i}=await (0,h.calculateKeyCheck)(t);return r.iv=n,r.mac=i,[t,r]}static checkBackupVersion(e){if(!("iv"in e.auth_data&&"mac"in e.auth_data))throw Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){let t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,h.encryptAES)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){let t=[];for(let[r,n]of Object.entries(e))try{let e=JSON.parse(await (0,h.decryptAES)(n.session_data,this.key,r));e.session_id=r,t.push(e)}catch(e){s.logger.log("Failed to decrypt megolm session from backup",e,n)}return t}async keyMatches(e){if(!this.authData.mac)return!0;{let{mac:t}=await (0,h.calculateKeyCheck)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}}free(){this.key.fill(0)}constructor(e,t){this.authData=e,this.key=t}}t.Aes256=w,(0,i.default)(w,"algorithmName",_.name);let T=t.algorithmsByName={[S.algorithmName]:S,[w.algorithmName]:w},I=t.DefaultAlgorithm=S;function O(e){var t;return{trusted:e.usable,matchesDecryptionKey:null!==(t=e.trusted_locally)&&void 0!==t&&t}}class R{free(){this.algorithm.free()}async decryptSessions(e){return await this.algorithm.decryptSessions(e)}constructor(e){this.algorithm=e,this.sourceTrusted=!e.untrusted}}t.LibOlmBackupDecryptor=R},20763:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.crypto=t.TextEncoder=void 0,t.setCrypto=p,t.setTextEncoder=f,t.subtleCrypto=void 0;var n,i,o,s,a,l,c=r(34002);let d=t.crypto=null===(n=globalThis.window)||void 0===n?void 0:n.crypto,u=t.subtleCrypto=null!==(i=null===(o=globalThis.window)||void 0===o||null===(o=o.crypto)||void 0===o?void 0:o.subtle)&&void 0!==i?i:null===(s=r.g.window)||void 0===s||null===(s=s.crypto)||void 0===s?void 0:s.webkitSubtle,h=t.TextEncoder=null===(a=globalThis.window)||void 0===a?void 0:a.TextEncoder;if(!d)try{t.crypto=d=r(48157).webcrypto}catch(e){c.logger.error("Failed to load webcrypto",e)}if(u||(t.subtleCrypto=u=null===(l=d)||void 0===l?void 0:l.subtle),!h)try{t.TextEncoder=h=r(9574).TextEncoder}catch(e){c.logger.error("Failed to load TextEncoder util",e)}function p(e){var r;t.crypto=d=e,t.subtleCrypto=u=null!==(r=e.subtle)&&void 0!==r?r:e.webkitSubtle}function f(e){t.TextEncoder=h=e}},70152:function(e,t,r){"use strict";var n=r(31180).Buffer,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.DehydrationManager=t.DEHYDRATION_ALGORITHM=void 0;var o=i(r(13102)),s=i(r(6691)),a=r(98870),l=r(87786),c=r(54410),d=r(34002),u=r(498);let h=t.DEHYDRATION_ALGORITHM="org.matrix.msc2697.v1.olm.libolm_pickle",p=6048e5;class f{getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,async e=>{if(e){let{key:t,keyInfo:i,deviceDisplayName:o,time:s}=e,l=n.from(this.crypto.olmDevice.pickleKey),d=await (0,c.decryptAES)(t,l,h);this.key=(0,a.decodeBase64)(d),this.keyInfo=i,this.deviceDisplayName=o;let u=Math.max(1,s+p-Date.now());this.timeoutId=r.g.setTimeout(this.dehydrateDevice.bind(this),u)}},"dehydration")})}async setKeyAndQueueDehydration(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;await this.setKey(e,t,r)||this.dehydrateDevice()}async setKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;if(!e){this.timeoutId&&(r.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)}),this.key=void 0,this.keyInfo=void 0;return}let i=!!this.key&&e.length==this.key.length;for(let t=0;i&&t<e.length;t++)e[t]!=this.key[t]&&(i=!1);return i||(this.key=e,this.keyInfo=t,this.deviceDisplayName=n),i}async dehydrateDevice(){if(this.inProgress){d.logger.log("Dehydration already in progress -- not starting new dehydration");return}this.inProgress=!0,this.timeoutId&&(r.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{let e=n.from(this.crypto.olmDevice.pickleKey),t=await (0,c.encryptAES)((0,a.encodeBase64)(this.key),e,h);await this.crypto.cryptoStore.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),d.logger.log("Attempting to dehydrate device"),d.logger.log("Creating account");let i=new r.g.Olm.Account;i.create();let o=JSON.parse(i.identity_keys()),f=i.max_number_of_one_time_keys();i.generate_one_time_keys(f/2),i.generate_fallback_key();let g=JSON.parse(i.one_time_keys()),m=JSON.parse(i.fallback_key());i.mark_keys_as_published();let v=i.pickle(new Uint8Array(this.key)),y={algorithm:h,account:v};this.keyInfo.passphrase&&(y.passphrase=this.keyInfo.passphrase),d.logger.log("Uploading account to server");let b=(await this.crypto.baseApis.http.authedRequest(u.Method.Put,"/dehydrated_device",void 0,{device_data:y,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;d.logger.log("Preparing device keys",b);let S={algorithms:this.crypto.supportedAlgorithms,device_id:b,user_id:this.crypto.userId,keys:{["ed25519:".concat(b)]:o.ed25519,["curve25519:".concat(b)]:o.curve25519}},E=i.sign(s.default.stringify(S));S.signatures={[this.crypto.userId]:{["ed25519:".concat(b)]:E}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(S,"self_signing"),d.logger.log("Preparing one-time keys");let _={};for(let[e,t]of Object.entries(g.curve25519)){let r={key:t},n=i.sign(s.default.stringify(r));r.signatures={[this.crypto.userId]:{["ed25519:".concat(b)]:n}},_["signed_curve25519:".concat(e)]=r}d.logger.log("Preparing fallback keys");let w={};for(let[e,t]of Object.entries(m.curve25519)){let r={key:t,fallback:!0},n=i.sign(s.default.stringify(r));r.signatures={[this.crypto.userId]:{["ed25519:".concat(b)]:n}},w["signed_curve25519:".concat(e)]=r}return d.logger.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(u.Method.Post,"/keys/upload/"+encodeURI(b),void 0,{device_keys:S,one_time_keys:_,"org.matrix.msc2732.fallback_keys":w}),d.logger.log("Done dehydrating"),this.timeoutId=r.g.setTimeout(this.dehydrateDevice.bind(this),p),b}finally{this.inProgress=!1}}stop(){this.timeoutId&&(r.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}constructor(e){(0,o.default)(this,"inProgress",!1),this.crypto=e,this.getDehydrationKeyFromCache()}}t.DehydrationManager=f},84881:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deviceInfoToDevice=i;var n=r(74967);function i(e,t){let r=new Map(Object.entries(e.keys)),i=e.getDisplayName()||void 0,o=new Map;if(e.signatures)for(let t in e.signatures)o.set(t,new Map(Object.entries(e.signatures[t])));return new n.Device({deviceId:e.deviceId,userId:t,keys:r,algorithms:e.algorithms,verified:e.verified,signatures:o,displayName:i})}},5382:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=void 0;var i=n(r(13102)),o=r(74967);class s{static fromStorage(e,t){let r=new s(t);for(let t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==o.DeviceVerification.Blocked}isVerified(){return this.verified==o.DeviceVerification.Verified}isUnverified(){return this.verified==o.DeviceVerification.Unverified}isKnown(){return!0===this.known}constructor(e){(0,i.default)(this,"algorithms",[]),(0,i.default)(this,"keys",{}),(0,i.default)(this,"verified",o.DeviceVerification.Unverified),(0,i.default)(this,"known",!1),(0,i.default)(this,"unsigned",{}),(0,i.default)(this,"signatures",{}),this.deviceId=e}}t.DeviceInfo=s,(0,i.default)(s,"DeviceVerification",{VERIFIED:o.DeviceVerification.Verified,UNVERIFIED:o.DeviceVerification.Unverified,BLOCKED:o.DeviceVerification.Blocked})},53978:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveKey=c,t.keyFromAuthData=a,t.keyFromPassphrase=l;var n=r(89027),i=r(20763);let o=5e5,s=256;function a(e,t){if(!r.g.Olm)throw Error("Olm is not available");if(!e.private_key_salt||!e.private_key_iterations)throw Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return c(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits||s)}async function l(e){if(!r.g.Olm)throw Error("Olm is not available");let t=(0,n.randomString)(32);return{key:await c(e,t,o,s),salt:t,iterations:o}}async function c(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s;if(!i.subtleCrypto||!i.TextEncoder)throw Error("Password-based backup is not available on this platform");let o=await i.subtleCrypto.importKey("raw",new i.TextEncoder().encode(e),{name:"PBKDF2"},!1,["deriveBits"]),a=await i.subtleCrypto.deriveBits({name:"PBKDF2",salt:new i.TextEncoder().encode(t),iterations:r,hash:"SHA-512"},o,n);return new Uint8Array(a)}},14995:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.OLM_ALGORITHM=t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=void 0,t.encryptMessageForDevice=h,t.ensureOlmSessionsForDevices=f,t.getExistingOlmSessions=p,t.isOlmEncrypted=b,t.pkSign=v,t.pkVerify=y,t.verifySignature=m;var i=n(r(13102)),o=n(r(6691)),s=r(34002),a=r(15748),l=r(44480);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var u=function(e){return e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",e}(u||{});async function h(e,t,r,n,i,o,a){let l=o.getIdentityKey(),c=await n.getSessionIdForDevice(l);if(null===c){s.logger.log("[olmlib.encryptMessageForDevice] Unable to find Olm session for device "+"".concat(i,":").concat(o.deviceId));return}s.logger.log("[olmlib.encryptMessageForDevice] Using Olm session ".concat(c," for device ")+"".concat(i,":").concat(o.deviceId));let u=d({sender:t,sender_device:r,keys:{ed25519:n.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:o.getFingerprint()}},a);e[l]=await n.encryptMessage(l,c,JSON.stringify(u))}async function p(e,t,r){let n=new l.MapWithDefault(()=>[]),i=new l.MapWithDefault(()=>new Map),o=[];for(let[t,s]of Object.entries(r))for(let r of s){let s=r.deviceId,a=r.getIdentityKey();o.push((async()=>{let o=await e.getSessionIdForDevice(a,!0);null===o?n.getOrCreate(t).push(r):i.getOrCreate(t).set(s,{device:r,sessionId:o})})())}return await Promise.all(o),[n,i]}async function f(e,t,r){let n,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:s.logger,c=[],d=new Map,u=new Map;for(let t of r.values())for(let r of t){let t=r.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise(r=>{u.set(t,n=>{delete e.sessionsInProgress[t],r(n)})})))}for(let[t,n]of r){let r=new Map;for(let o of(d.set(t,r),n)){let n=o.deviceId,s=o.getIdentityKey();if(s===e.deviceCurve25519Key){l.info("Attempted to start session with ourself! Ignoring"),r.set(n,{device:o,sessionId:null});continue}let a="for ".concat(s," (").concat(t,":").concat(n,")"),d=await e.getSessionIdForDevice(s,!!u.get(s),l),h=u.get(s);null!==d&&h&&h(),(null===d||i)&&(i?l.info("Forcing new Olm session ".concat(a)):l.info("Making new Olm session ".concat(a)),c.push([t,n])),r.set(n,{device:o,sessionId:d})}}if(0===c.length)return d;let h="signed_curve25519",p="one-time keys for ".concat(c.length," devices");try{l.debug("Claiming ".concat(p)),n=await t.claimOneTimeKeys(c,h,o),l.debug("Claimed ".concat(p))}catch(e){for(let e of u.values())e();throw l.debug("Failed to claim ".concat(p),e,c),e}a&&"failures"in n&&a.push(...Object.keys(n.failures));let f=n.one_time_keys||{},m=[];for(let[t,n]of r){let r=f[t]||{};for(let o of n){var v,y;let n=o.deviceId,s=o.getIdentityKey();if(s===e.deviceCurve25519Key||null!==(v=d.get(t))&&void 0!==v&&null!==(v=v.get(n))&&void 0!==v&&v.sessionId&&!i)continue;let a=r[n]||{},c=null;for(let e in a)0===e.indexOf(h+":")&&(c=a[e]);if(!c){l.warn("No one-time keys (alg=".concat(h,") ")+"for device ".concat(t,":").concat(n)),null===(y=u.get(s))||void 0===y||y();continue}m.push(g(e,c,t,o).then(e=>{var r,i;null===(r=u.get(s))||void 0===r||r(null!=e?e:void 0);let o=null===(i=d.get(t))||void 0===i?void 0:i.get(n);o&&(o.sessionId=e)},e=>{var t;throw null===(t=u.get(s))||void 0===t||t(),e}))}}return p="Olm sessions for ".concat(m.length," devices"),l.debug("Starting ".concat(p)),await Promise.all(m),l.debug("Started ".concat(p)),d}async function g(e,t,r,n){let i;let o=n.deviceId;try{await m(e,t,r,o,n.getFingerprint())}catch(e){return s.logger.error("Unable to verify signature on one-time key for device "+r+":"+o+":",e),null}try{i=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return s.logger.error("Error starting olm session with device "+r+":"+o+": "+e),null}return s.logger.log("Started new olm sessionid "+i+" for device "+r+":"+o),i}async function m(e,t,r,n,i){let s="ed25519:"+n,a=((t.signatures||{})[r]||{})[s];if(!a)throw Error("No signature");let l=Object.assign({},t);"unsigned"in l&&delete l.unsigned,delete l.signatures;let c=o.default.stringify(l);e.verifySignature(i,c,a)}function v(e,t,n,i){let s=!1;if(t instanceof Uint8Array){let e=new r.g.Olm.PkSigning;i=e.init_with_seed(t),t=e,s=!0}let a=e.signatures||{};delete e.signatures;let l=e.unsigned;e.unsigned&&delete e.unsigned;try{let r=a[n]||{};return a[n]=r,r["ed25519:"+i]=t.sign(o.default.stringify(e))}finally{e.signatures=a,l&&(e.unsigned=l),s&&t.free()}}function y(e,t,n){let i="ed25519:"+t;if(!(e.signatures&&e.signatures[n]&&e.signatures[n][i]))throw Error("No signature");let s=e.signatures[n][i],a=new r.g.Olm.Utility,l=e.signatures;delete e.signatures;let c=e.unsigned;e.unsigned&&delete e.unsigned;try{a.ed25519_verify(t,o.default.stringify(e),s)}finally{e.signatures=l,c&&(e.unsigned=c),a.free()}}function b(e){return e.getSenderKey()?!!(e.getWireType()===a.EventType.RoomMessageEncrypted&&["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(s.logger.error("Event was not encrypted using an appropriate algorithm"),!1):(s.logger.error("Event has no sender key (not encrypted?)"),!1)}t.OLM_ALGORITHM=u.Olm,t.MEGOLM_ALGORITHM=u.Megolm,t.MEGOLM_BACKUP_ALGORITHM=u.MegolmBackup},41806:function(e,t,r){"use strict";var n=r(31180).Buffer;Object.defineProperty(t,"__esModule",{value:!0}),t.decodeRecoveryKey=d,t.encodeRecoveryKey=c;var i=s(r(54895));function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(o=function(e){return e?r:t})(e)}function s(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=o(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}let a=[139,1],l=32;function c(e){var t;let r=n.alloc(a.length+e.length+1);r.set(a,0),r.set(e,a.length);let o=0;for(let e=0;e<r.length-1;++e)o^=r[e];return r[r.length-1]=o,null===(t=i.encode(r).match(/.{1,4}/g))||void 0===t?void 0:t.join(" ")}function d(e){let t=i.decode(e.replace(/ /g,"")),r=0;for(let e of t)r^=e;if(0!==r)throw Error("Incorrect parity");for(let e=0;e<a.length;++e)if(t[e]!==a[e])throw Error("Incorrect prefix");if(t.length!==a.length+l+1)throw Error("Incorrect length");return Uint8Array.from(t.slice(a.length,a.length+l))}},77705:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SESSION_BATCH_SIZE=t.MigrationState=t.ACCOUNT_OBJECT_KEY_MIGRATION_STATE=void 0,t.ACCOUNT_OBJECT_KEY_MIGRATION_STATE="migrationState",t.MigrationState=function(e){return e[e.NOT_STARTED=0]="NOT_STARTED",e[e.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",e[e.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",e[e.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",e[e.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",e}({}),t.SESSION_BATCH_SIZE=50},24813:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=t.Backend=void 0,t.upgradeDatabase=p;var i=n(r(13102)),o=r(34002),s=r(44480),a=r(77705),l=r(87786);let c=!1;class d{async containsData(){throw Error("Not implemented for Backend")}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}async getMigrationState(){let e=a.MigrationState.NOT_STARTED;return await this.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_ACCOUNT).get(a.ACCOUNT_OBJECT_KEY_MIGRATION_STATE);r.onsuccess=()=>{var t;e=null!==(t=r.result)&&void 0!==t?t:a.MigrationState.NOT_STARTED}}),e}async setMigrationState(e){await this.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{t.objectStore(l.IndexedDBCryptoStore.STORE_ACCOUNT).put(e,a.ACCOUNT_OBJECT_KEY_MIGRATION_STATE)})}getOrAddOutgoingRoomKeyRequest(e){let t=e.requestBody;return new Promise((r,n)=>{let i=this.db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=n,this._getOutgoingRoomKeyRequest(i,t,n=>{if(n){o.logger.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r(n);return}o.logger.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),i.oncomplete=()=>{r(e)},i.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,r)=>{let n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=r,this._getOutgoingRoomKeyRequest(n,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,r){let n=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);n.onsuccess=()=>{let e=n.result;if(!e){r(null);return}let i=e.value;if((0,s.deepCompare)(i.requestBody,t)){r(i);return}e.continue()}}getOutgoingRoomKeyRequestByState(e){let t;if(0===e.length)return Promise.resolve(null);let r=0;function n(){let i=this.result;if(i){t=i.value;return}if(++r>=e.length)return;let o=e[r];this.source.openCursor(o).onsuccess=n}let i=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=i.objectStore("outgoingRoomKeyRequests"),s=e[r];return o.index("state").openCursor(s).onsuccess=n,m(i).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,r)=>{let n=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=()=>t(n.result),n.onerror=()=>r(n.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,r){let n=0,i=[];function o(){let s=this.result;if(s){let r=s.value;r.recipients.some(r=>r.userId===e&&r.deviceId===t)&&i.push(r),s.continue()}else{if(++n>=r.length)return;let e=r[n];this.source.openCursor(e).onsuccess=o}}let s=this.db.transaction("outgoingRoomKeyRequests","readonly"),a=s.objectStore("outgoingRoomKeyRequests"),l=r[n];return a.index("state").openCursor(l).onsuccess=o,m(s).then(()=>i)}updateOutgoingRoomKeyRequest(e,t,r){let n=null;function i(){let e=this.result;if(!e)return;let i=e.value;if(i.state!=t){o.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(i.state));return}Object.assign(i,r),e.update(i),n=i}let s=this.db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=i,m(s).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){let r=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=r.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{let e=n.result;if(!e)return;let r=e.value;if(r.state!=t){o.logger.warn("Cannot delete room key request in state ".concat(r.state," ")+"(expected ".concat(t,")"));return}e.delete()},m(r)}getAccount(e,t){let r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){g(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){let r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){g(e,t)}}}getSecretStorePrivateKey(e,t,r){let n=e.objectStore("account").get("ssss_cache:".concat(r));n.onsuccess=function(){try{t(n.result||null)}catch(t){g(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,r){e.objectStore("account").put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){let r=e.objectStore("sessions").count();r.onsuccess=function(){try{t(r.result)}catch(t){g(e,t)}}}getEndToEndSessions(e,t,r){let n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){let e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(i)}catch(e){g(t,e)}}}getEndToEndSession(e,t,r,n){let i=r.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){g(r,e)}}}getAllEndToEndSessions(e,t){let r=e.objectStore("sessions").openCursor();r.onsuccess=function(){try{let e=r.result;e?(t(e.value),e.continue()):t(null)}catch(t){g(e,t)}}}storeEndToEndSession(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,r){let n=this.db.transaction("session_problems","readwrite");n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:r,time:Date.now()}),await m(n)}async getEndToEndSessionProblem(e,t){let r=null,n=this.db.transaction("session_problems","readwrite"),i=n.objectStore("session_problems").index("deviceKey").getAll(e);return i.onsuccess=()=>{let e=i.result;if(!e.length){r=null;return}e.sort((e,t)=>e.time-t.time);let n=e[e.length-1];for(let i of e)if(i.time>t){r=Object.assign({},i,{fixed:n.fixed});return}r=n.fixed?null:n},await m(n),r}async filterOutNotifiedErrorDevices(e){let t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),r=[];return await Promise.all(e.map(e=>new Promise(n=>{let{userId:i,deviceInfo:o}=e,s=t.get([i,o.deviceId]);s.onsuccess=function(){s.result||(t.put({userId:i,deviceId:o.deviceId}),r.push(e)),n()}}))),r}async getEndToEndSessionsBatch(){let e=[];return(await this.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_SESSIONS],t=>{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_SESSIONS).openCursor();r.onsuccess=function(){try{let t=r.result;t&&(e.push(t.value),e.length<a.SESSION_BATCH_SIZE&&t.continue())}catch(e){g(t,e)}}}),0===e.length)?null:e}async deleteEndToEndSessionsBatch(e){await this.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_SESSIONS],async t=>{try{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_SESSIONS);for(let{deviceKey:t,sessionId:n}of e){let e=r.delete([t,n]);await new Promise(t=>{e.onsuccess=t})}}catch(e){g(t,e)}})}getEndToEndInboundGroupSession(e,t,r,n){let i=!1,o=!1,s=r.objectStore("inbound_group_sessions").get([e,t]);s.onsuccess=function(){try{i=s.result?s.result.session:null,!1!==o&&n(i,o)}catch(e){g(r,e)}};let a=r.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(i,o)}catch(e){g(r,e)}}}getAllEndToEndInboundGroupSessions(e,t){let r=e.objectStore("inbound_group_sessions").openCursor();r.onsuccess=function(){let n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){g(e,t)}n.continue()}else try{t(null)}catch(t){g(e,t)}}}addEndToEndInboundGroupSession(e,t,r,n){let i=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:r});i.onerror=r=>{var s;(null===(s=i.error)||void 0===s?void 0:s.name)==="ConstraintError"?(r.stopPropagation(),r.preventDefault(),o.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):g(n,Error("Failed to add inbound group session: "+i.error))}}storeEndToEndInboundGroupSession(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:r})}async countEndToEndInboundGroupSessions(){let e=0;return await this.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],t=>{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS).count();r.onsuccess=()=>{e=r.result}}),e}async getEndToEndInboundGroupSessionsBatch(){let e=[];return(await this.doTxn("readonly",[l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,l.IndexedDBCryptoStore.STORE_BACKUP],t=>{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS),n=t.objectStore(l.IndexedDBCryptoStore.STORE_BACKUP),i=r.openCursor();i.onsuccess=function(){try{let t=i.result;if(t){let r=n.get(t.key);r.onsuccess=()=>{e.push({senderKey:t.value.senderCurve25519Key,sessionId:t.value.sessionId,sessionData:t.value.session,needsBackup:void 0!==r.result}),e.length<a.SESSION_BATCH_SIZE&&t.continue()}}}catch(e){g(t,e)}}}),0===e.length)?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){await this.doTxn("readwrite",[l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],async t=>{try{let r=t.objectStore(l.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS);for(let{senderKey:t,sessionId:n}of e){let e=r.delete([t,n]);await new Promise(t=>{e.onsuccess=t})}}catch(e){g(t,e)}})}getEndToEndDeviceData(e,t){let r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){g(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,r){r.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){let r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){let i=n.result;if(i)r[i.key]=i.value,i.continue();else try{t(r)}catch(t){g(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,r)=>{let n=[],i=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=r,i.oncomplete=function(){t(n)};let o=i.objectStore("sessions_needing_backup"),s=i.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){let t=a.result;if(t){let r=s.get(t.key);r.onsuccess=function(){n.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||n.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));let t=e.objectStore("sessions_needing_backup");return new Promise((e,r)=>{let n=t.count();n.onerror=r,n.onsuccess=()=>e(n.result)})}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));let r=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,n)=>{let i=r.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n})))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));let r=t.objectStore("sessions_needing_backup");await Promise.all(e.map(e=>new Promise((t,n)=>{let i=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n})))}addSharedHistoryInboundGroupSession(e,t,r,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));let i=n.objectStore("shared_history_inbound_group_sessions"),o=i.get([e]);o.onsuccess=()=>{let{sessions:n}=o.result||{sessions:[]};n.push([t,r]),i.put({roomId:e,sessions:n})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));let r=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((e,t)=>{r.onsuccess=()=>{let{sessions:t}=r.result||{sessions:[]};e(t)},r.onerror=t})}addParkedSharedHistory(e,t,r){r||(r=this.db.transaction("parked_shared_history","readwrite"));let n=r.objectStore("parked_shared_history"),i=n.get([e]);i.onsuccess=()=>{let{parked:r}=i.result||{parked:[]};r.push(t),n.put({roomId:e,parked:r})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));let r=t.objectStore("parked_shared_history").openCursor(e);return new Promise((e,t)=>{r.onsuccess=()=>{let t=r.result;if(!t){e([]);return}let n=t.value;t.delete(),e(n)},r.onerror=t})}doTxn(e,t,r){let n,i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o.logger;if(c){let r=this.nextTxnId++;n=Date.now(),i="".concat(e," crypto store transaction ").concat(r," in ").concat(t),s.debug("Starting ".concat(i))}let a=this.db.transaction(t,e),l=m(a),d=r(a);return c&&l.then(()=>{let e=Date.now()-n;s.debug("Finished ".concat(i,", took ").concat(e," ms"))},()=>{let e=Date.now()-n;s.error("Failed ".concat(i,", took ").concat(e," ms"))}),l.then(()=>d)}constructor(e){(0,i.default)(this,"nextTxnId",0),this.db=e,e.onversionchange=()=>{o.logger.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}}t.Backend=d;let u=[e=>{f(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],h=t.VERSION=u.length;function p(e,t){o.logger.log("Upgrading IndexedDBCryptoStore from version ".concat(t)+" to ".concat(h)),u.forEach((r,n)=>{t<=n&&r(e)})}function f(e){let t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}function g(e,t){e._mx_abortexception=t;try{e.abort()}catch(e){}}function m(e){return new Promise((t,r)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&r(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),r(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),r(e.error))}})}},87786:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var i=n(r(13102)),o=r(34002),s=r(28875),a=r(46455),l=p(r(24813)),c=r(74460),d=p(r(86036)),u=r(77705);function h(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(h=function(e){return e?r:t})(e)}function p(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=h(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}class f{static exists(e,t){return d.exists(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{let i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{let s=o.result;if(i){let e=s.transaction([f.STORE_ACCOUNT],"readonly").objectStore(f.STORE_ACCOUNT).get(u.ACCOUNT_OBJECT_KEY_MIGRATION_STATE);e.onsuccess=()=>{var t;r((null!==(t=e.result)&&void 0!==t?t:u.MigrationState.NOT_STARTED)===u.MigrationState.NOT_STARTED)},e.onerror=()=>{n(e.error)},s.close()}else s.close(),e.deleteDatabase(t),r(!1)},o.onerror=()=>n(o.error)})}async containsData(){return f.exists(this.indexedDB,this.dbName)}startup(){return this.backendPromise||(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(Error("no indexeddb support available"));return}o.logger.log("connecting to indexeddb ".concat(this.dbName));let r=this.indexedDB.open(this.dbName,l.VERSION);r.onupgradeneeded=e=>{let t=r.result,n=e.oldVersion;l.upgradeDatabase(t,n)},r.onblocked=()=>{o.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.logger.log("Error connecting to indexeddb",e),t(r.error)},r.onsuccess=()=>{let t=r.result;o.logger.log("connected to indexeddb ".concat(this.dbName)),e(new l.Backend(t))}}).then(e=>e.doTxn("readonly",[f.STORE_INBOUND_GROUP_SESSIONS,f.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if("VersionError"===e.name)throw o.logger.warn("Crypto DB is too new for us to use!",e),new c.InvalidCryptoStoreError(c.InvalidCryptoStoreState.TooNew);o.logger.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{return new s.LocalStorageCryptoStore(r.g.localStorage)}catch(e){return o.logger.warn("unable to open localStorage: falling back to in-memory store: ".concat(e)),new a.MemoryCryptoStore}}).then(e=>(this.backend=e,e))),this.backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(Error("no indexeddb support available"));return}o.logger.log("Removing indexeddb instance: ".concat(this.dbName));let r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{o.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.logger.log("Error deleting data from indexeddb",e),t(r.error)},r.onsuccess=()=>{o.logger.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{o.logger.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,r){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}updateOutgoingRoomKeyRequest(e,t,r){return this.backend.updateOutgoingRoomKeyRequest(e,t,r)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}storeEndToEndSessionProblem(e,t,r){return this.backend.storeEndToEndSessionProblem(e,t,r)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,r,n){this.backend.addEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,r){this.backend.storeEndToEndRoom(e,t,r)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,r,n){this.backend.addSharedHistoryInboundGroupSession(e,t,r,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,r){this.backend.addParkedSharedHistory(e,t,r)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}constructor(e,t){this.indexedDB=e,this.dbName=t}}t.IndexedDBCryptoStore=f,(0,i.default)(f,"STORE_ACCOUNT","account"),(0,i.default)(f,"STORE_SESSIONS","sessions"),(0,i.default)(f,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.default)(f,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.default)(f,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.default)(f,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,i.default)(f,"STORE_DEVICE_DATA","device_data"),(0,i.default)(f,"STORE_ROOMS","rooms"),(0,i.default)(f,"STORE_BACKUP","sessions_needing_backup")},28875:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var n=r(34002),i=r(46455),o=r(77705),s=r(44480);let a="crypto.",l=a+"migration",c=a+"account",d=a+"cross_signing_keys",u=a+"notified_error_devices",h=a+"device_data",p=a+"inboundgroupsessions/",f=a+"inboundgroupsessions.withheld/",g=a+"rooms/",m=a+"sessionsneedingbackup";function v(e){return a+"sessions/"+e}function y(e){return a+"session.problems/"+e}function b(e,t){return p+e+"/"+t}function S(e,t){return f+e+"/"+t}function E(e){return g+e}class _ extends i.MemoryCryptoStore{static exists(e){let t=e.length;for(let n=0;n<t;n++){var r;if(null!==(r=e.key(n))&&void 0!==r&&r.startsWith(a))return!0}return!1}async containsData(){return _.exists(this.store)}async getMigrationState(){var e;return null!==(e=w(this.store,l))&&void 0!==e?e:o.MigrationState.NOT_STARTED}async setMigrationState(e){T(this.store,l,e)}countEndToEndSessions(e,t){let r=0;for(let e=0;e<this.store.length;++e){let t=this.store.key(e);if(null!=t&&t.startsWith(v(""))){let e=w(this.store,t);r+=Object.keys(null!=e?e:{}).length}}t(r)}_getEndToEndSessions(e){let t=w(this.store,v(e)),r={};for(let[e,n]of Object.entries(t||{}))"string"==typeof n?r[e]={session:n}:r[e]=n;return r}getEndToEndSession(e,t,r,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,r){r(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e){var r;if(null!==(r=this.store.key(e))&&void 0!==r&&r.startsWith(v(""))){let r=this.store.key(e).split("/")[1];for(let e of Object.values(this._getEndToEndSessions(r)))t(e)}}}storeEndToEndSession(e,t,r,n){let i=this._getEndToEndSessions(e)||{};i[t]=r,T(this.store,v(e),i)}async storeEndToEndSessionProblem(e,t,r){let n=y(e),i=w(this.store,n)||[];i.push({type:t,fixed:r,time:Date.now()}),i.sort((e,t)=>e.time-t.time),T(this.store,n,i)}async getEndToEndSessionProblem(e,t){let r=y(e),n=w(this.store,r)||[];if(!n.length)return null;let i=n[n.length-1];for(let e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){let t=w(this.store,u)||{},r=[];for(let n of e){let{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(r.push(n),(0,s.safeSet)(t[e],i.deviceId,!0)):(r.push(n),(0,s.safeSet)(t,e,{[i.deviceId]:!0}))}return T(this.store,u,t),r}async getEndToEndSessionsBatch(){let e=[];for(let r=0;r<this.store.length;++r){var t;if(null!==(t=this.store.key(r))&&void 0!==t&&t.startsWith(v(""))){let t=this.store.key(r).split("/")[1];for(let r of Object.values(this._getEndToEndSessions(t)))if(e.push(r),e.length>=o.SESSION_BATCH_SIZE)return e}}return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(let{deviceKey:t,sessionId:r}of e){let e=this._getEndToEndSessions(t)||{};delete e[r],0===Object.keys(e).length?this.store.removeItem(v(t)):T(this.store,v(t),e)}}getEndToEndInboundGroupSession(e,t,r,n){n(w(this.store,b(e,t)),w(this.store,S(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){let r=this.store.key(e);null!=r&&r.startsWith(p)&&t({senderKey:r.slice(p.length,p.length+43),sessionId:r.slice(p.length+44),sessionData:w(this.store,r)})}t(null)}addEndToEndInboundGroupSession(e,t,r,n){w(this.store,b(e,t))||this.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){T(this.store,b(e,t),r)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){T(this.store,S(e,t),r)}async countEndToEndInboundGroupSessions(){let e=0;for(let t=0;t<this.store.length;++t){let r=this.store.key(t);null!=r&&r.startsWith(p)&&(e+=1)}return e}async getEndToEndInboundGroupSessionsBatch(){let e=w(this.store,m)||{},t=[];for(let r=0;r<this.store.length;++r){let n=this.store.key(r);if(null!=n&&n.startsWith(p)){let r=n.slice(p.length);if(t.push({senderKey:r.slice(0,43),sessionId:r.slice(44),sessionData:w(this.store,n),needsBackup:r in e}),t.length>=o.SESSION_BATCH_SIZE)return t}}return 0===t.length?null:t}async deleteEndToEndInboundGroupSessionsBatch(e){for(let{senderKey:t,sessionId:r}of e){let e=b(t,r);this.store.removeItem(e)}}getEndToEndDeviceData(e,t){t(w(this.store,h))}storeEndToEndDeviceData(e,t){T(this.store,h,e)}storeEndToEndRoom(e,t,r){T(this.store,E(e),t)}getEndToEndRooms(e,t){let r={},n=E("");for(let e=0;e<this.store.length;++e){let t=this.store.key(e);null!=t&&t.startsWith(n)&&(r[t.slice(n.length)]=w(this.store,t))}t(r)}getSessionsNeedingBackup(e){let t=w(this.store,m)||{},r=[];for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let t=n.slice(0,43),i=n.slice(44);if(this.getEndToEndInboundGroupSession(t,i,null,e=>{r.push({senderKey:t,sessionId:i,sessionData:e})}),e&&r.length>=e)break}return Promise.resolve(r)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(w(this.store,m)||{}).length)}unmarkSessionsNeedingBackup(e){let t=w(this.store,m)||{};for(let r of e)delete t[r.senderKey+"/"+r.sessionId];return T(this.store,m,t),Promise.resolve()}markSessionsNeedingBackup(e){let t=w(this.store,m)||{};for(let r of e)t[r.senderKey+"/"+r.sessionId]=!0;return T(this.store,m,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(c),Promise.resolve()}getAccount(e,t){t(w(this.store,c))}storeAccount(e,t){T(this.store,c,t)}getCrossSigningKeys(e,t){t(w(this.store,d))}getSecretStorePrivateKey(e,t,r){t(w(this.store,a+"ssss_cache.".concat(r)))}storeCrossSigningKeys(e,t){T(this.store,d,t)}storeSecretStorePrivateKey(e,t,r){T(this.store,a+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}constructor(e){super(),this.store=e}}function w(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.logger.log("Error: Failed to get key %s: %s",t,e.message),n.logger.log(e.stack)}return null}function T(e,t,r){e.setItem(t,JSON.stringify(r))}t.LocalStorageCryptoStore=_},46455:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var i=n(r(13102)),o=r(34002),s=r(44480),a=r(77705);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class d{async containsData(){return null!==this.account}async startup(){return this}deleteAllData(){return Promise.resolve()}async getMigrationState(){return this.migrationState}async setMigrationState(e){this.migrationState=e}getOrAddOutgoingRoomKeyRequest(e){let t=e.requestBody;return(0,s.promiseTry)(()=>{let r=this._getOutgoingRoomKeyRequest(t);return r?(o.logger.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r):(o.logger.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(let t of this.outgoingRoomKeyRequests)if((0,s.deepCompare)(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(let t of this.outgoingRoomKeyRequests)for(let r of e)if(t.state===r)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,r){let n=[];for(let i of this.outgoingRoomKeyRequests)for(let o of r)i.state===o&&i.recipients.some(r=>r.userId===e&&r.deviceId===t)&&n.push(i);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,r){for(let n of this.outgoingRoomKeyRequests)if(n.requestId===e){if(n.state!==t){o.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(n.state));break}return Object.assign(n,r),Promise.resolve(n)}return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let r=0;r<this.outgoingRoomKeyRequests.length;r++){let n=this.outgoingRoomKeyRequests[r];if(n.requestId===e){if(n.state!=t){o.logger.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")"));break}return this.outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n)}}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){t(this.privateKeys[r]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){let r=0;for(let e of Object.values(this.sessions))r+=Object.keys(e).length;t(r)}getEndToEndSession(e,t,r,n){n((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(e=>{let[r,n]=e;Object.entries(n).forEach(e=>{let[n,i]=e;t(c(c({},i),{},{deviceKey:r,sessionId:n}))})})}storeEndToEndSession(e,t,r,n){let i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),(0,s.safeSet)(i,t,r)}async storeEndToEndSessionProblem(e,t,r){let n=this.sessionProblems[e]=this.sessionProblems[e]||[];n.push({type:t,fixed:r,time:Date.now()}),n.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){let r=this.sessionProblems[e]||[];if(!r.length)return null;let n=r[r.length-1];for(let e of r)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){let t=this.notifiedErrorDevices,r=[];for(let n of e){let{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(r.push(n),(0,s.safeSet)(t[e],i.deviceId,!0)):(r.push(n),(0,s.safeSet)(t,e,{[i.deviceId]:!0}))}return r}async getEndToEndSessionsBatch(){let e=[];for(let t of Object.values(this.sessions))for(let r of Object.values(t))if(e.push(r),e.length>=a.SESSION_BATCH_SIZE)return e;return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(let{deviceKey:t,sessionId:r}of e){let e=this.sessions[t]||{};delete e[r],0===Object.keys(e).length&&delete this.sessions[t]}}getEndToEndInboundGroupSession(e,t,r,n){let i=e+"/"+t;n(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(let e of Object.keys(this.inboundGroupSessions))t({senderKey:e.slice(0,43),sessionId:e.slice(44),sessionData:this.inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,r,n){let i=e+"/"+t;void 0===this.inboundGroupSessions[i]&&(this.inboundGroupSessions[i]=r)}storeEndToEndInboundGroupSession(e,t,r,n){this.inboundGroupSessions[e+"/"+t]=r}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){let i=e+"/"+t;this.inboundGroupSessionsWithheld[i]=r}async countEndToEndInboundGroupSessions(){return Object.keys(this.inboundGroupSessions).length}async getEndToEndInboundGroupSessionsBatch(){let e=[];for(let[t,r]of Object.entries(this.inboundGroupSessions))if(e.push({senderKey:t.slice(0,43),sessionId:t.slice(44),sessionData:r,needsBackup:t in this.sessionsNeedingBackup}),e.length>=a.SESSION_BATCH_SIZE)return e;return 0===e.length?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){for(let{senderKey:t,sessionId:r}of e){let e=t+"/"+r;delete this.inboundGroupSessions[e]}}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,r){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){let t=[];for(let r in this.sessionsNeedingBackup)if(this.inboundGroupSessions[r]&&(t.push({senderKey:r.slice(0,43),sessionId:r.slice(44),sessionData:this.inboundGroupSessions[r]}),e&&r.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(let t of e){let e=t.senderKey+"/"+t.sessionId;delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(let t of e){let e=t.senderKey+"/"+t.sessionId;this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,r){let n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,r]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var r;let n=null!==(r=this.parkedSharedHistory.get(e))&&void 0!==r?r:[];n.push(t),this.parkedSharedHistory.set(e,n)}takeParkedSharedHistory(e){var t;let r=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(r)}doTxn(e,t,r){return Promise.resolve(r(null))}constructor(){(0,i.default)(this,"migrationState",a.MigrationState.NOT_STARTED),(0,i.default)(this,"outgoingRoomKeyRequests",[]),(0,i.default)(this,"account",null),(0,i.default)(this,"crossSigningKeys",null),(0,i.default)(this,"privateKeys",{}),(0,i.default)(this,"sessions",{}),(0,i.default)(this,"sessionProblems",{}),(0,i.default)(this,"notifiedErrorDevices",{}),(0,i.default)(this,"inboundGroupSessions",{}),(0,i.default)(this,"inboundGroupSessionsWithheld",{}),(0,i.default)(this,"deviceData",null),(0,i.default)(this,"rooms",{}),(0,i.default)(this,"sessionsNeedingBackup",{}),(0,i.default)(this,"sharedHistoryInboundGroupSessions",{}),(0,i.default)(this,"parkedSharedHistory",new Map)}}t.MemoryCryptoStore=d},27597:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationEvent=t.VerificationBase=t.SwitchStartEventError=void 0;var i=n(r(13102)),o=r(39325),s=r(15748),a=r(34002),l=r(5382),c=r(95623),d=r(807),u=r(44441),h=r(12796);let p=Error("Verification timed out");class f extends Error{constructor(e){super(),this.startEvent=e}}t.SwitchStartEventError=f;let g=t.VerificationEvent=h.VerifierEvent;class m extends u.TypedEventEmitter{get initiatedByMe(){if(!this.startEvent)return!0;let e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){a.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(a.logger.info("Triggering verification timeout"),this.cancel(p))},6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(Error("Verification is already done"));let t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((e,t)=>{this.resolveEvent=e,this.rejectEvent=t}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e)){if(a.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){let t=this.rejectEvent;this.rejectEvent=void 0,t(new f(e))}else this.startEvent=e}}handleEvent(e){if(!this._done){if(e.getType()===this.expectedEvent){if(this.expectedEvent!==s.EventType.KeyVerificationDone){var t;this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(t=this.resolveEvent)||void 0===t||t.call(this,e)}}else if(e.getType()===s.EventType.KeyVerificationCancel){let t=this.reject;if(this.reject=void 0,t){let{reason:r,code:n}=e.getContent();t(Error("Other side cancelled verification "+"because ".concat(r," (").concat(n,")")))}}else if(this.expectedEvent){let t=Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){let e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}}async done(){if(this.endTimer(),!this._done){var e;return this.request.onVerifierFinished(),null===(e=this.resolve)||void 0===e||e.call(this),(0,d.requestKeysDuringVerification)(this.baseApis,this.userId,this.deviceId)}}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId){if(e===p){let e=(0,c.newTimeoutError)();this.send(e.getType(),e.getContent())}else if(e instanceof o.MatrixEvent){if(e.getSender()!==this.userId){let t=e.getContent();e.getType()===s.EventType.KeyVerificationCancel?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send(s.EventType.KeyVerificationCancel,t)):this.send(s.EventType.KeyVerificationCancel,{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send(s.EventType.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()})}null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(g.Cancel,e)}}verify(){return this.promise||(this.promise=new Promise((e,t)=>{var r=this;this.resolve=function(){for(var t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];r._done=!0,r.endTimer(),e(...n)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((e,t)=>{var r;(null===(r=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===r?void 0:r.getId())===this.deviceId&&t(Error("Device ID is the same as the cross-signing ID")),e()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,r){let n=[];for(let[i,o]of Object.entries(t)){let t=i.split(":",2)[1],s=this.baseApis.getStoredDevice(e,t);if(s)r(i,s,o),n.push([t,i,s.keys[i]]);else{let s=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);s&&s.getId()===t?(r(i,l.DeviceInfo.fromStorage({keys:{[i]:t}},t),o),n.push([t,i,t])):a.logger.warn("verification: Could not find device ".concat(t," to verify"))}}if(!n.length)throw Error("No devices could be verified");for(let[t,r,i]of(a.logger.info("Verification completed! Marking devices verified: ",n),n))await this.baseApis.crypto.setDeviceVerification(e,t,!0,null,null,{[r]:i});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}constructor(e,t,r,n,o,s){super(),(0,i.default)(this,"cancelled",!1),(0,i.default)(this,"_done",!1),(0,i.default)(this,"promise",null),(0,i.default)(this,"transactionTimeoutTimer",null),this.channel=e,this.baseApis=t,this.userId=r,this.deviceId=n,this.startEvent=o,this.request=s}}t.VerificationBase=m},95623:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorFactory=s,t.errorFromEvent=a,t.newUserCancelledError=t.newUnknownMethodError=t.newUnexpectedMessageError=t.newTimeoutError=t.newKeyMismatchError=t.newInvalidMessageError=void 0,t.newVerificationError=o;var n=r(39325),i=r(15748);function o(e,t,r){let o=Object.assign({},{code:e,reason:t},r);return new n.MatrixEvent({type:i.EventType.KeyVerificationCancel,content:o})}function s(e,t){return function(r){return o(e,t,r)}}function a(e){let t=e.getContent();if(!t)return{code:"Unknown error",reason:"m.unknown"};{let{code:e,reason:r}=t;return{code:e,reason:r}}}t.newUserCancelledError=s("m.user","Cancelled by user"),t.newTimeoutError=s("m.timeout","Timed out"),t.newUnknownMethodError=s("m.unknown_method","Unknown method"),t.newUnexpectedMessageError=s("m.unexpected_message","Unexpected message"),t.newKeyMismatchError=s("m.key_mismatch","Key mismatch"),t.newInvalidMessageError=s("m.invalid_message","Invalid message")},60747:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.IllegalMethod=void 0;var i=n(r(13102)),o=r(27597);class s extends o.VerificationBase{static factory(e,t,r,n,i,o){return new s(e,t,r,n,i,o)}static get NAME(){return"org.matrix.illegal_method"}constructor(...e){super(...e),(0,i.default)(this,"doVerification",async()=>{throw Error("Verification is not possible with this method")})}}t.IllegalMethod=s},56674:function(e,t,r){"use strict";var n=r(31180).Buffer,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SHOW_QR_CODE_METHOD=t.SCAN_QR_CODE_METHOD=t.ReciprocateQRCode=t.QrCodeEvent=t.QRCodeData=void 0;var o=i(r(13102)),s=r(20763),a=r(27597),l=r(95623),c=r(98870),d=r(34002),u=r(12796);t.SHOW_QR_CODE_METHOD="m.qr_code.show.v1",t.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";let h=t.QrCodeEvent=u.VerifierEvent;class p extends a.VerificationBase{static factory(e,t,r,n,i,o){return new p(e,t,r,n,i,o)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return null!==(e=this.reciprocateQREvent)&&void 0!==e?e:null}constructor(...e){super(...e),(0,o.default)(this,"doVerification",async()=>{if(!this.startEvent)throw Error("It is not currently possible to start verificationwith this method yet.");let{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==(null==e?void 0:e.encodedSharedSecret))throw(0,l.newKeyMismatchError)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t((0,l.newUserCancelledError)())},this.emit(h.ShowReciprocateQr,this.reciprocateQREvent)});let t={};switch(null==e?void 0:e.mode){case m.VerifyOtherUser:{let r=e.otherUserMasterKey;t["ed25519:".concat(r)]=r;break}case m.VerifySelfTrusted:{let r=this.request.targetDevice.deviceId;t["ed25519:".concat(r)]=e.otherDeviceKey;break}case m.VerifySelfUntrusted:{let r=e.myMasterKey;t["ed25519:".concat(r)]=r}}await this.verifyKeys(this.userId,t,(e,r,n)=>{let i=t[e];if(!i)throw(0,l.newKeyMismatchError)();if(n!==i)throw d.logger.error("key ID from key info does not match"),(0,l.newKeyMismatchError)();for(let e in r.keys){if(!e.startsWith("ed25519"))continue;let n=t[e];if(!n)throw(0,l.newKeyMismatchError)();if(r.keys[e]!==n)throw d.logger.error("master key does not match"),(0,l.newKeyMismatchError)()}})})}}t.ReciprocateQRCode=p;let f=2,g="MATRIX";var m=function(e){return e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted",e}(m||{});class v{static async create(e,t){let r=v.generateSharedSecret(),n=v.determineMode(e,t),i=null,o=null,s=null;if(n===m.VerifyOtherUser)i=t.getStoredCrossSigningForUser(e.otherUserId).getId("master");else if(n===m.VerifySelfTrusted)o=await v.getOtherDeviceKey(e,t);else if(n===m.VerifySelfUntrusted){let e=t.getUserId();s=t.getStoredCrossSigningForUser(e).getId("master")}let a=v.generateQrData(e,t,n,r,i,o,s),l=v.generateBuffer(a);return new v(n,r,i,o,s,l)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){let e=new Uint8Array(11);return s.crypto.getRandomValues(e),(0,c.encodeUnpaddedBase64)(e)}static async getOtherDeviceKey(e,t){let r=t.getUserId(),n=e.targetDevice,i=n.deviceId?t.getStoredDevice(r,n.deviceId):void 0;if(!i)throw Error("could not find device "+(null==n?void 0:n.deviceId));return i.getFingerprint()}static determineMode(e,t){let r=t.getUserId(),n=e.otherUserId,i=m.VerifyOtherUser;return r===n&&(i=t.checkUserTrust(r).isCrossSigningVerified()?m.VerifySelfTrusted:m.VerifySelfUntrusted),i}static generateQrData(e,t,r,n,i,o,s){let a=t.getUserId(),l={prefix:g,version:f,mode:r,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},c=t.getStoredCrossSigningForUser(a);return r===m.VerifyOtherUser?(l.firstKeyB64=c.getId("master"),l.secondKeyB64=i):r===m.VerifySelfTrusted?(l.firstKeyB64=c.getId("master"),l.secondKeyB64=o):r===m.VerifySelfUntrusted&&(l.firstKeyB64=t.getDeviceEd25519Key(),l.secondKeyB64=s),l}static generateBuffer(e){let t=n.alloc(0),r=e=>{let r=n.from([e]);t=n.concat([t,r])},i=e=>{let r=n.alloc(2);r.writeInt16BE(e,0),t=n.concat([t,r])},o=function(e,r){let o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=n.from(e,r);o&&i(s.byteLength),t=n.concat([t,s])},s=e=>{let r=(0,c.decodeBase64)(e),i=n.from(r);t=n.concat([t,i])};return o(e.prefix,"ascii",!1),r(e.version),r(e.mode),o(e.transactionId,"utf-8"),s(e.firstKeyB64),s(e.secondKeyB64),s(e.secretB64),t}constructor(e,t,r,n,i,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=r,this.otherDeviceKey=n,this.myMasterKey=i,this.buffer=o}}t.QRCodeData=v},71418:function(e,t,r){"use strict";let n;var i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SasEvent=t.SAS=void 0;var o=i(r(13102)),s=i(r(6691)),a=r(27597),l=r(95623),c=r(34002),d=r(85951),u=r(15748),h=r(12796);let p=u.EventType.KeyVerificationStart,f=[u.EventType.KeyVerificationAccept,u.EventType.KeyVerificationKey,u.EventType.KeyVerificationMac],g=(0,l.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),m=(0,l.errorFactory)("m.mismatched_commitment","Mismatched commitment"),v=[["\uD83D\uDC36","dog"],["\uD83D\uDC31","cat"],["\uD83E\uDD81","lion"],["\uD83D\uDC0E","horse"],["\uD83E\uDD84","unicorn"],["\uD83D\uDC37","pig"],["\uD83D\uDC18","elephant"],["\uD83D\uDC30","rabbit"],["\uD83D\uDC3C","panda"],["\uD83D\uDC13","rooster"],["\uD83D\uDC27","penguin"],["\uD83D\uDC22","turtle"],["\uD83D\uDC1F","fish"],["\uD83D\uDC19","octopus"],["\uD83E\uDD8B","butterfly"],["\uD83C\uDF37","flower"],["\uD83C\uDF33","tree"],["\uD83C\uDF35","cactus"],["\uD83C\uDF44","mushroom"],["\uD83C\uDF0F","globe"],["\uD83C\uDF19","moon"],["☁️","cloud"],["\uD83D\uDD25","fire"],["\uD83C\uDF4C","banana"],["\uD83C\uDF4E","apple"],["\uD83C\uDF53","strawberry"],["\uD83C\uDF3D","corn"],["\uD83C\uDF55","pizza"],["\uD83C\uDF82","cake"],["❤️","heart"],["\uD83D\uDE00","smiley"],["\uD83E\uDD16","robot"],["\uD83C\uDFA9","hat"],["\uD83D\uDC53","glasses"],["\uD83D\uDD27","spanner"],["\uD83C\uDF85","santa"],["\uD83D\uDC4D","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["\uD83C\uDF81","gift"],["\uD83D\uDCA1","light bulb"],["\uD83D\uDCD5","book"],["✏️","pencil"],["\uD83D\uDCCE","paperclip"],["✂️","scissors"],["\uD83D\uDD12","lock"],["\uD83D\uDD11","key"],["\uD83D\uDD28","hammer"],["☎️","telephone"],["\uD83C\uDFC1","flag"],["\uD83D\uDE82","train"],["\uD83D\uDEB2","bicycle"],["✈️","aeroplane"],["\uD83D\uDE80","rocket"],["\uD83C\uDFC6","trophy"],["⚽","ball"],["\uD83C\uDFB8","guitar"],["\uD83C\uDFBA","trumpet"],["\uD83D\uDD14","bell"],["⚓","anchor"],["\uD83C\uDFA7","headphones"],["\uD83D\uDCC1","folder"],["\uD83D\uDCCC","pin"]];function y(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>v[e])}let b={decimal:d.generateDecimalSas,emoji:y};function S(e,t){let r={};for(let n of t)n in b&&(r[n]=b[n](Array.from(e)));return r}let E={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function _(e,t){return function(r,n){let i=e[E[t]](r,n);return c.logger.log("SAS calculateMAC:",t,[r,n],i),i}}let w={"curve25519-hkdf-sha256":function(e,t,r){let n="".concat(e.baseApis.getUserId(),"|").concat(e.baseApis.deviceId,"|")+"".concat(e.ourSASPubKey,"|"),i="".concat(e.userId,"|").concat(e.deviceId,"|").concat(e.theirSASPubKey,"|"),o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(o,r)},curve25519:function(e,t,r){let n="".concat(e.baseApis.getUserId()).concat(e.baseApis.deviceId),i="".concat(e.userId).concat(e.deviceId),o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(o,r)}},T=["curve25519-hkdf-sha256","curve25519"],I=["sha256"],O=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],R=Object.keys(b),C=new Set(T),k=new Set(I),M=new Set(O),P=new Set(R);function A(e,t){return Array.isArray(e)?e.filter(e=>t.has(e)):[]}let D=t.SasEvent=h.VerifierEvent;class x extends a.VerificationBase{static get NAME(){return"m.sas.v1"}get events(){return f}canSwitchStartEvent(e){if(e.getType()!==p)return!1;let t=e.getContent();return(null==t?void 0:t.method)===x.NAME&&!!this.waitingForAccept}async sendStart(){let e=this.channel.completeContent(p,{method:x.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:T,hashes:I,message_authentication_codes:O,short_authentication_string:R});return await this.channel.sendCompleted(p,e),e}async verifyAndCheckMAC(e,t,r,n){let i=w[e](this,r,6),o=new Promise((e,o)=>{this.sasEvent={sas:S(i,t),confirm:async()=>{try{await this.sendMAC(r,n),e()}catch(e){o(e)}},cancel:()=>o((0,l.newUserCancelledError)()),mismatch:()=>o(g())},this.emit(D.ShowSas,this.sasEvent)}),[s]=await Promise.all([this.waitForEvent(u.EventType.KeyVerificationMac).then(e=>(this.expectedEvent=u.EventType.KeyVerificationDone,e)),o]),a=s.getContent();await this.checkMAC(r,a,n)}async doSendVerification(){let e,t;if(this.waitingForAccept=!0,e=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new a.SwitchStartEventError(this.startEvent);try{t=await this.waitForEvent(u.EventType.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let i=t.getContent(),o=A(i.short_authentication_string,P);if(!(C.has(i.key_agreement_protocol)&&k.has(i.hash)&&M.has(i.message_authentication_code)&&o.length))throw(0,l.newUnknownMethodError)();if("string"!=typeof i.commitment)throw(0,l.newInvalidMessageError)();let c=i.key_agreement_protocol,d=i.message_authentication_code,h=i.commitment,p=new r.g.Olm.SAS;try{this.ourSASPubKey=p.get_pubkey(),await this.send(u.EventType.KeyVerificationKey,{key:this.ourSASPubKey});let r=(i=(t=await this.waitForEvent(u.EventType.KeyVerificationKey)).getContent()).key+s.default.stringify(e);if(n.sha256(r)!==h)throw m();this.theirSASPubKey=i.key,p.set_their_key(i.key),await this.verifyAndCheckMAC(c,o,p,d)}finally{p.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent),t=A(T,new Set(e.key_agreement_protocols))[0],i=A(I,new Set(e.hashes))[0],o=A(O,new Set(e.message_authentication_codes))[0],a=A(e.short_authentication_string,P);if(!(void 0!==t&&void 0!==i&&void 0!==o&&a.length))throw(0,l.newUnknownMethodError)();let c=new r.g.Olm.SAS;try{let r=c.get_pubkey()+s.default.stringify(e);await this.send(u.EventType.KeyVerificationAccept,{key_agreement_protocol:t,hash:i,message_authentication_code:o,short_authentication_string:a,commitment:n.sha256(r)}),e=(await this.waitForEvent(u.EventType.KeyVerificationKey)).getContent(),this.theirSASPubKey=e.key,c.set_their_key(e.key),this.ourSASPubKey=c.get_pubkey(),await this.send(u.EventType.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(t,a,c,o)}finally{c.free()}}sendMAC(e,t){let r={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o="ed25519:".concat(this.baseApis.deviceId);r[o]=_(e,t)(this.baseApis.getDeviceEd25519Key(),i+o),n.push(o);let s=this.baseApis.getCrossSigningId();if(s){let o="ed25519:".concat(s);r[o]=_(e,t)(s,i+o),n.push(o)}let a=_(e,t)(n.sort().join(","),i+"KEY_IDS");return this.send(u.EventType.KeyVerificationMac,{mac:r,keys:a})}async checkMAC(e,t,r){let n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==_(e,r)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw(0,l.newKeyMismatchError)();await this.verifyKeys(this.userId,t.mac,(t,i,o)=>{if(o!==_(e,r)(i.keys[t],n+t))throw(0,l.newKeyMismatchError)()})}getShowSasCallbacks(){var e;return null!==(e=this.sasEvent)&&void 0!==e?e:null}constructor(...e){super(...e),(0,o.default)(this,"doVerification",async()=>{await r.g.Olm.init(),n=n||new r.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do try{if(this.initiatedByMe)return await this.doSendVerification();return await this.doRespondVerification()}catch(t){if(t instanceof a.SwitchStartEventError)this.startEvent=t.startEvent,e=!0;else throw t}while(e)})}}t.SAS=x},85951:function(e,t){"use strict";function r(e){return[(e[0]<<5|e[1]>>3)+1e3,((7&e[1])<<10|e[2]<<2|e[3]>>6)+1e3,((63&e[3])<<7|e[4]>>1)+1e3]}Object.defineProperty(t,"__esModule",{value:!0}),t.generateDecimalSas=r},14431:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomRequests=t.InRoomChannel=void 0;var i=n(r(13102)),o=r(78017),s=r(34002);let a=r(15748).EventType.RoomMessage,l="m.reference",c="m.relates_to";class d{get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(d.getEventType(e)!==o.REQUEST_TYPE)return;let r=t.getUserId(),n=e.getSender(),i=e.getContent().to;return n===r?i:i===r?n:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===o.REQUEST_TYPE}canCreateRequest(e){return d.canCreateRequest(e)}static getTransactionId(e){if(d.getEventType(e)===o.REQUEST_TYPE)return e.getId();{let t=e.getRelation();if((null==t?void 0:t.rel_type)===l)return t.event_id}}static validateEvent(e,t){let r=d.getTransactionId(e);if("string"!=typeof r||0===r.length)return!1;let n=d.getEventType(e),i=e.getContent();if(n===o.REQUEST_TYPE){if(!i||"string"!=typeof i.to||!i.to.length)return s.logger.log("InRoomChannel: validateEvent: no valid to "+i.to),!1;if(!d.getOtherPartyUserId(e,t))return s.logger.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(e.getSender())+", ".concat(i.to)),!1}return o.VerificationRequest.validateEvent(n,e,t)}static getEventType(e){let t=e.getType();if(t===a){let t=e.getContent();if(t){let{msgtype:e}=t;if(e===o.REQUEST_TYPE)return o.REQUEST_TYPE}}return t&&t!==o.REQUEST_TYPE?t:""}async handleEvent(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.hasEventId(e.getId()))return;let n=d.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(!this.userId){let t=d.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}let i=this.client.getUserId(),o=e.getSender();if(this.userId&&o!==i&&o!==this.userId){s.logger.log("InRoomChannel: ignoring verification event from non-participating sender ".concat(o));return}this.requestEventId||(this.requestEventId=d.getTransactionId(e));let a=!!e.getTxnId(),l=!!e.getUnsigned().transaction_id,c=e.getSender()===this.client.getUserId();return t.handleEvent(n,e,r,a||l,c)}completedContentFromEvent(e){let t=Object.assign({},e.getContent());return t[c]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),(e===o.REQUEST_TYPE||e===o.READY_TYPE||e===o.START_TYPE)&&(t.from_device=this.client.getDeviceId()),e===o.REQUEST_TYPE?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:o.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t[c]={rel_type:l,event_id:this.transactionId},t}send(e,t){let r=this.completeContent(e,t);return this.sendCompleted(e,r)}async sendCompleted(e,t){let r=e;e===o.REQUEST_TYPE&&(r=a);let n=await this.client.sendEvent(this.roomId,r,t);e===o.REQUEST_TYPE&&(this.requestEventId=n.event_id)}constructor(e,t,r){this.client=e,this.roomId=t,this.userId=r}}t.InRoomChannel=d;class u{getRequest(e){let t=e.getRoomId(),r=d.getTransactionId(e);return this.getRequestByTxnId(t,r)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){let r=this.requestsByRoomId.get(e);if(r)return r.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,r){let n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,r)}removeRequest(e){let t=e.getRoomId(),r=this.requestsByRoomId.get(t);r&&(r.delete(d.getTransactionId(e)),0===r.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){let r=this.requestsByRoomId.get(e);if(r){for(let e of r.values())if(e.pending&&(void 0===t||e.requestingUserId===t))return e}}constructor(){(0,i.default)(this,"requestsByRoomId",new Map)}}t.InRoomRequests=u},46368:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceRequests=t.ToDeviceChannel=void 0;var i=n(r(13102)),o=r(89027),s=r(34002),a=r(78017),l=r(95623),c=r(39325);class d{isToDevices(e){if(e.length!==this.devices.length)return!1;for(let t of e)if(!this.devices.includes(t))return!1;return!0}static getEventType(e){return e.getType()}static getTransactionId(e){let t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===a.REQUEST_TYPE||e===a.START_TYPE}canCreateRequest(e){return d.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return s.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;let r=e.getContent();if(!r)return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;let n=e.getType();if(n===a.REQUEST_TYPE){if(!Number.isFinite(r.timestamp))return s.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return s.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return a.VerificationRequest.validateEvent(n,e,t)}getTimestamp(e){let t=e.getContent();return t&&t.timestamp}async handleEvent(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e.getType(),i=e.getContent();if(n===a.REQUEST_TYPE||n===a.READY_TYPE||n===a.START_TYPE){this.transactionId||(this.transactionId=i.transaction_id);let e=i.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){let t=this.completeContent(a.CANCEL_TYPE,(0,l.errorFromEvent)((0,l.newUnexpectedMessageError)()));return this.sendToDevices(a.CANCEL_TYPE,t,[e])}}let o=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY;await t.handleEvent(e.getType(),e,r,!1,!1);let s=t.phase===a.PHASE_STARTED||t.phase===a.PHASE_READY;if((n===a.START_TYPE||n===a.READY_TYPE)&&!o&&s&&this.deviceId){let e=this.devices.filter(e=>e!==this.deviceId&&e!==this.client.getDeviceId());if(e.length){let t=this.completeContent(a.CANCEL_TYPE,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(a.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),(e===a.REQUEST_TYPE||e===a.READY_TYPE||e===a.START_TYPE)&&(t.from_device=this.client.getDeviceId()),e===a.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e!==a.REQUEST_TYPE&&e!==a.START_TYPE||this.transactionId||(this.transactionId=d.makeTransactionId());let r=this.completeContent(e,t);return this.sendCompleted(e,r)}async sendCompleted(e,t){let r;r=e!==a.REQUEST_TYPE&&(e!==a.CANCEL_TYPE||this.deviceId)?await this.sendToDevices(e,t,[this.deviceId]):await this.sendToDevices(e,t,this.devices);let n=new c.MatrixEvent({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,n,!0,!0,!0),r}async sendToDevices(e,t,r){if(r.length){let n=new Map;for(let e of r)n.set(e,t);await this.client.sendToDevice(e,new Map([[this.userId,n]]))}}static makeTransactionId(){return(0,o.randomString)(32)}constructor(e,t,r,n,i){this.client=e,this.userId=t,this.devices=r,this.transactionId=n,this.deviceId=i}}t.ToDeviceChannel=d;class u{getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){let r=this.requestsByUserId.get(e);if(r)return r.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),d.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,r){let n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,r)}removeRequest(e){let t=e.getSender(),r=this.requestsByUserId.get(t);r&&(r.delete(d.getTransactionId(e)),0===r.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){let r=this.requestsByUserId.get(e);if(r){for(let e of r.values())if(e.pending&&e.channel.isToDevices(t))return e}}getRequestsInProgress(e){let t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}constructor(){(0,i.default)(this,"requestsByUserId",new Map)}}t.ToDeviceRequests=u},78017:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.PHASE_UNSENT=t.PHASE_STARTED=t.PHASE_REQUESTED=t.PHASE_READY=t.PHASE_DONE=t.PHASE_CANCELLED=t.EVENT_PREFIX=t.DONE_TYPE=t.CANCEL_TYPE=void 0,Object.defineProperty(t,"Phase",{enumerable:!0,get:function(){return d.VerificationPhase}}),t.VerificationRequest=t.START_TYPE=t.REQUEST_TYPE=t.READY_TYPE=void 0,Object.defineProperty(t,"VerificationRequestEvent",{enumerable:!0,get:function(){return d.VerificationRequestEvent}});var i=n(r(13102)),o=r(34002),s=r(95623),a=r(56674),l=r(15748),c=r(44441),d=r(12796);let u=6e5,h=12e4,p=3e3,f=t.EVENT_PREFIX="m.key.verification.",g=t.REQUEST_TYPE=f+"request",m=t.START_TYPE=f+"start",v=t.CANCEL_TYPE=f+"cancel",y=t.DONE_TYPE=f+"done",b=t.READY_TYPE=f+"ready",S=t.PHASE_UNSENT=d.VerificationPhase.Unsent,E=t.PHASE_REQUESTED=d.VerificationPhase.Requested,_=t.PHASE_READY=d.VerificationPhase.Ready,w=t.PHASE_STARTED=d.VerificationPhase.Started,T=t.PHASE_CANCELLED=d.VerificationPhase.Cancelled,I=t.PHASE_DONE=d.VerificationPhase.Done;class O extends c.TypedEventEmitter{static validateEvent(e,t,r){let n=t.getContent();return!!(e&&e.startsWith(f))&&(n?e!==g&&e!==b||Array.isArray(n.methods)?e!==g&&e!==b&&e!==m||"string"==typeof n.from_device&&0!==n.from_device.length||(o.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.logger.log("VerificationRequest: validateEvent: no content"),!1))}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===S}get requested(){return this.phase===E}get cancelled(){return this.phase===T}get ready(){return this.phase===_}get started(){return this.phase===w}get done(){return this.phase===I}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+u;return this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=E&&(t=Math.min(t,this.requestReceivedAt+h)),Math.max(0,t-Date.now())}get timeout(){let e=this.getEventByEither(g);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(g)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return(0,d.canAcceptVerificationRequest)(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==I&&this._phase!==T}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return null===(e=this._qrCodeData)||void 0===e?void 0:e.getBuffer()}async generateQRCode(){return this.getQRCodeBytes()}otherPartySupportsMethod(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t&&!this.ready&&!this.started)return!1;let r=this.eventsByThem.get(g)||this.eventsByThem.get(b);if(!r){if(this.started&&this.initiatedByMe){let t=this.eventsByUs.get(m),r=t&&t.getContent();return e==(r&&r.method)}return!1}let n=r.getContent();if(!n)return!1;let{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){let e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===S&&e)return!0;let t=this.eventsByUs.has(g),r=this.eventsByThem.has(g);if(t&&!r)return!0;if(!t&&r)return!1;let n=this.eventsByUs.has(m),i=this.eventsByThem.has(m);return!!n&&!i}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){let e=this.eventsByUs.get(v),t=this.eventsByThem.get(v);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){let e=this.getEventByEither(v);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){let e=this.eventsByThem.get(g)||this.eventsByThem.get(b)||this.eventsByThem.get(m),t=null==e?void 0:e.getContent(),r=null==t?void 0:t.from_device;return{userId:this.otherUserId,deviceId:r}}beginKeyVerification(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier&&(this.phase===E||this.phase===_||this.phase===S&&this.channel.canCreateRequest(m))){if(this.commonMethods.length&&!this.commonMethods.includes(e)||(this._verifier=this.createVerifier(e,null,t),!this._verifier))throw(0,s.newUnknownMethodError)();this._chosenMethod=e}return this._verifier}async startVerification(e){let t=this.beginKeyVerification(e);return t.verify(),t}scanQRCode(e){throw Error("QR code scanning not supported by legacy crypto")}async sendRequest(){if(!this.observeOnly&&this._phase===S){let e=[...this.verificationMethods.keys()];await this.channel.send(g,{methods:e})}}async cancel(){let{reason:e="User declined",code:t="m.user"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.observeOnly&&this._phase!==T){if(this._declining=!0,this.emit(d.VerificationRequestEvent.Change),this._verifier)return this._verifier.cancel((0,s.errorFactory)(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(v,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===E&&!this.initiatedByMe){let e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(d.VerificationRequestEvent.Change),await this.channel.send(b,{methods:e})}}waitFor(e){return new Promise((t,r)=>{let n=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(r(Error("cancelled")),i=!0),i&&this.off(d.VerificationRequestEvent.Change,n),i};n()||this.on(d.VerificationRequestEvent.Change,n)})}setPhase(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this._phase=e,t&&this.emit(d.VerificationRequestEvent.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){let e;let t=[{phase:S}],r=()=>t[t.length-1].phase,n=this.eventsByThem.has(g),i=this.getEventBy(g,n);i&&t.push({phase:E,event:i});let o=i&&this.getEventBy(b,!n);if(o&&r()===E&&t.push({phase:_,event:o}),o||!i){let t=this.eventsByThem.get(m),r=this.eventsByUs.get(m);e=t&&r?t.getSender()<r.getSender()?t:r:t||r}else e=this.getEventBy(m,!n);if(e){let n=r()===E&&(null==i?void 0:i.getSender())!==e.getSender(),o=r()===S&&this.channel.canCreateRequest(m);(n||r()===_||o)&&t.push({phase:w,event:e})}let s=this.eventsByUs.get(y);(this.verifierHasFinished||s&&r()===w)&&t.push({phase:I});let a=this.getEventByEither(v);return(this._cancelled||a)&&r()!==I&&t.push({phase:T,event:a}),t}transitionToPhase(e){let{phase:t,event:r}=e;if((t===E||t===_)&&!this.wasSentByOwnDevice(r)){let e=r.getContent();this.commonMethods=e.methods.filter(e=>this.verificationMethods.has(e))}if(!this.observeOnly&&(t===E||t===w||t===_)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(r)&&!this.wasSentByOwnDevice(r)&&(this._observeOnly=!0),t===w){let{method:e}=r.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,r),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: ".concat(e)}))}}applyPhaseTransitions(){let e=this.calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),r=e.slice(t+1);for(let e of r)this.transitionToPhase(e);return r}isWinningStartRace(e){let t,r;if(e.getType()!==m)return!1;let n=this._verifier.startEvent;if(this.isSelfVerification){if(n){let e=n.getContent();t=e&&e.from_device}else t=this.client.getDeviceId()}else t=n?n.getSender():this.client.getUserId();if(this.isSelfVerification){let t=e.getContent();r=t&&t.from_device}else r=e.getSender();return r<t}hasEventId(e){for(let t of this.eventsByUs.values())if(t.getId()===e)return!0;for(let t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,r,n,i){if(this.done||this.cancelled)return;let s=this._observeOnly;if(this.adjustObserveOnly(t,r),!this.observeOnly&&!n&&await this.cancelOnError(e,t)||(i?this.eventsByUs.has(e):this.eventsByThem.has(e)))return;let l=this.phase;this.addEvent(e,t,i);let c=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){let r=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&r)this._verifier.switchStartEvent(t);else if(!n){var u;(e===v||null!==(u=this._verifier.events)&&void 0!==u&&u.includes(e))&&this._verifier.handleEvent(t)}}if(c.length){r&&c.some(e=>e.phase===_)&&this.otherPartySupportsMethod(a.SCAN_QR_CODE_METHOD,!0)&&(this._qrCodeData=await a.QRCodeData.create(this,this.client));let{phase:e}=c[c.length-1];this.setupTimeout(e),this.setPhase(e)}else this._observeOnly!==s&&this.emit(d.VerificationRequestEvent.Change)}finally{o.logger.log("Verification request ".concat(this.channel.transactionId,": ")+"".concat(e," event with id:").concat(t.getId(),", ")+"content:".concat(JSON.stringify(t.getContent())," ")+"deviceId:".concat(this.channel.deviceId,", ")+"sender:".concat(t.getSender(),", isSentByUs:").concat(i,", ")+"isLiveEvent:".concat(r,", isRemoteEcho:").concat(n,", ")+"phase:".concat(l,"=>").concat(this.phase,", ")+"observeOnly:".concat(s,"=>").concat(this._observeOnly))}}setupTimeout(e){this.timeoutTimer||this.observeOnly||e!==E||(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer&&(e===w||e===_||e===I||e===T)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async cancelOnError(e,t){if(e===m){let e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel((0,s.errorFromEvent)((0,s.newUnknownMethodError)())),!0}let r=e===g&&this.phase!==S,n=e===b&&this.phase!==E&&this.phase!==w;if(this.phase!==S&&(r||n)){o.logger.warn("Cancelling, unexpected ".concat(e," verification ")+"event from ".concat(t.getSender()));let r="Unexpected ".concat(e," event in phase ").concat(this.phase);return await this.cancel((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)({reason:r}))),!0}return!1}adjustObserveOnly(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t||(this._observeOnly=!0),this.calculateEventTimeout(e)<p&&(this._observeOnly=!0)}addEvent(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(r?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===g){for(let[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r||(r=this.targetDevice);let{userId:n,deviceId:i}=r,s=this.verificationMethods.get(e);if(!s){o.logger.warn("could not find verifier constructor for method",e);return}return new s(this.channel,this.client,n,i,t,this)}wasSentByOwnUser(e){return(null==e?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;let t=e.getContent();return!!t&&t.from_device===this.client.getDeviceId()}onVerifierCancelled(){this._cancelled=!0;let e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(l.EventType.KeyVerificationDone,{}),this.verifierHasFinished=!0;let e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}constructor(e,t,r){super(),(0,i.default)(this,"eventsByUs",new Map),(0,i.default)(this,"eventsByThem",new Map),(0,i.default)(this,"_observeOnly",!1),(0,i.default)(this,"timeoutTimer",null),(0,i.default)(this,"_accepting",!1),(0,i.default)(this,"_declining",!1),(0,i.default)(this,"verifierHasFinished",!1),(0,i.default)(this,"_cancelled",!1),(0,i.default)(this,"_chosenMethod",null),(0,i.default)(this,"_qrCodeData",null),(0,i.default)(this,"requestReceivedAt",null),(0,i.default)(this,"commonMethods",[]),(0,i.default)(this,"cancelOnTimeout",async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.logger.error("Error while cancelling verification request",e)}}),this.channel=e,this.verificationMethods=t,this.client=r,this.channel.request=this,this.setPhase(S,!1)}}t.VerificationRequest=O},1513:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomWidgetClient=void 0;var i=n(r(13102)),o=r(98826),s=r(39325),a=r(15748),l=r(34002),c=r(32950),d=r(9855),u=r(46694),h=r(69509),p=r(44480);class f extends c.MatrixClient{async startClient(){var e,t;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.lifecycle=new AbortController;let n=this.getUserId();n&&this.store.storeUser(new h.User(n)),r.slidingSync?this.syncApi=new u.SlidingSyncSdk(r.slidingSync,this,r,this.buildSyncApiOptions()):this.syncApi=new d.SyncApi(this,r,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),await this.widgetApiReady,await Promise.all(null!==(e=null===(t=this.capabilities.receiveState)||void 0===t?void 0:t.map(async e=>{let{eventType:t,stateKey:r}=e,n=(await this.widgetApi.readStateEvents(t,void 0,r,[this.roomId])).map(e=>new s.MatrixEvent(e));await this.syncApi.injectRoomEvents(this.room,[],n),n.forEach(e=>{this.emit(c.ClientEvent.Event,e),l.logger.info("Backfilled event ".concat(e.getId()," ").concat(e.getType()," ").concat(e.getStateKey()))})}))&&void 0!==e?e:[]),this.setSyncState(d.SyncState.Syncing),l.logger.info("Finished backfilling events"),this.matrixRTC.start(),this.capabilities.turnServers&&this.watchTurnServers()}stopClient(){this.widgetApi.off("action:".concat(o.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(o.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),super.stopClient(),this.lifecycle.abort()}async joinRoom(e){if(e===this.roomId)return this.room;throw Error("Unknown room: ".concat(e))}async encryptAndSendEvent(e,t){let r;try{r=await this.widgetApi.sendRoomEvent(t.getType(),t.getContent(),e.roomId)}catch(r){throw this.updatePendingEventStatus(e,t,s.EventStatus.NOT_SENT),r}return e.updatePendingEvent(t,s.EventStatus.SENT,r.event_id),{event_id:r.event_id}}async sendStateEvent(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return await this.widgetApi.sendStateEvent(t,n,r,e)}async sendToDevice(e,t){return await this.widgetApi.sendToDevice(e,!1,(0,p.recursiveMapToObject)(t)),{}}async getOpenIdToken(){let e=await this.widgetApi.requestOpenIDConnectToken();return{access_token:e.access_token,expires_in:e.expires_in,matrix_server_name:e.matrix_server_name,token_type:e.token_type}}async queueToDevice(e){let{eventType:t,batch:r}=e,n=new p.MapWithDefault(()=>new Map);for(let{userId:e,deviceId:t,payload:i}of r)n.getOrCreate(e).set(t,i);await this.widgetApi.sendToDevice(t,!1,(0,p.recursiveMapToObject)(n))}async encryptAndSendToDevices(e,t){let r=new p.MapWithDefault(()=>new Map);for(let{userId:n,deviceInfo:{deviceId:i}}of e)r.getOrCreate(n).set(i,t);await this.widgetApi.sendToDevice(t.type,!0,(0,p.recursiveMapToObject)(r))}async checkTurnServers(){return this.turnServers.length>0}getSyncState(){return this.syncState}setSyncState(e){let t=this.syncState;this.syncState=e,this.emit(c.ClientEvent.Sync,e,t)}async ack(e){await this.widgetApi.transport.reply(e.detail,{})}async watchTurnServers(){let e=this.widgetApi.getTurnServers(),t=()=>{e.return(void 0)};this.lifecycle.signal.addEventListener("abort",t);try{for await(let t of e)this.turnServers=[{urls:t.uris,username:t.username,credential:t.password}],this.emit(c.ClientEvent.TurnServers,this.turnServers),l.logger.log("Received TURN server: ".concat(t.uris))}catch(e){l.logger.warn("Error watching TURN servers",e)}finally{this.lifecycle.signal.removeEventListener("abort",t)}}constructor(e,t,r,n){var u,h,p,f,g,m,v,y,b,S;super(n),(0,i.default)(this,"syncState",null),(0,i.default)(this,"onEvent",async e=>{if(e.preventDefault(),e.detail.data.room_id===this.roomId){let t=new s.MatrixEvent(e.detail.data);await this.syncApi.injectRoomEvents(this.room,[],[t]),this.emit(c.ClientEvent.Event,t),this.setSyncState(d.SyncState.Syncing),l.logger.info("Received event ".concat(t.getId()," ").concat(t.getType()," ").concat(t.getStateKey()))}else{let{event_id:t,room_id:r}=e.detail.data;l.logger.info("Received event ".concat(t," for a different room ").concat(r,"; discarding"))}await this.ack(e)}),(0,i.default)(this,"onToDevice",async e=>{e.preventDefault();let t=new s.MatrixEvent({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(a.EventType.RoomMessageEncrypted,{},"",""),this.emit(c.ClientEvent.ToDeviceEvent,t),this.setSyncState(d.SyncState.Syncing),await this.ack(e)}),this.widgetApi=e,this.capabilities=t,this.roomId=r,this.widgetApiReady=new Promise(e=>this.widgetApi.once("ready",e)),(null!==(u=t.sendEvent)&&void 0!==u&&u.length||null!==(h=t.receiveEvent)&&void 0!==h&&h.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||!0===t.receiveMessage||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||null!==(p=t.sendState)&&void 0!==p&&p.length||null!==(f=t.receiveState)&&void 0!==f&&f.length)&&e.requestCapabilityForRoomTimeline(r),null===(g=t.sendEvent)||void 0===g||g.forEach(t=>e.requestCapabilityToSendEvent(t)),null===(m=t.receiveEvent)||void 0===m||m.forEach(t=>e.requestCapabilityToReceiveEvent(t)),!0===t.sendMessage?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(t=>e.requestCapabilityToSendMessage(t)),!0===t.receiveMessage?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(t=>e.requestCapabilityToReceiveMessage(t)),null===(v=t.sendState)||void 0===v||v.forEach(t=>{let{eventType:r,stateKey:n}=t;return e.requestCapabilityToSendState(r,n)}),null===(y=t.receiveState)||void 0===y||y.forEach(t=>{let{eventType:r,stateKey:n}=t;return e.requestCapabilityToReceiveState(r,n)}),null===(b=t.sendToDevice)||void 0===b||b.forEach(t=>e.requestCapabilityToSendToDevice(t)),null===(S=t.receiveToDevice)||void 0===S||S.forEach(t=>e.requestCapabilityToReceiveToDevice(t)),t.turnServers&&e.requestCapability(o.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(o.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(o.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.start(),e.sendContentLoaded()}}t.RoomWidgetClient=f},74460:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.KeySignatureUploadError=t.InvalidStoreState=t.InvalidStoreError=t.InvalidCryptoStoreState=t.InvalidCryptoStoreError=t.ClientStoppedError=void 0;var i=n(r(13102));let o=t.InvalidStoreState=function(e){return e[e.ToggledLazyLoading=0]="ToggledLazyLoading",e}({});class s extends Error{constructor(e,t){super("Store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again"),this.reason=e,this.value=t,this.name="InvalidStoreError"}}t.InvalidStoreError=s,(0,i.default)(s,"TOGGLED_LAZY_LOADING",o.ToggledLazyLoading);let a=t.InvalidCryptoStoreState=function(e){return e.TooNew="TOO_NEW",e}({});class l extends Error{constructor(e){super("Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again"),this.reason=e,this.name="InvalidCryptoStoreError"}}t.InvalidCryptoStoreError=l,(0,i.default)(l,"TOO_NEW",a.TooNew);class c extends Error{constructor(e,t){super(e),this.value=t}}t.KeySignatureUploadError=c;class d extends Error{constructor(){super("MatrixClient has been stopped")}}t.ClientStoppedError=d},27526:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.eventMapperFor=c;var i=n(r(13102)),o=r(39325),s=r(15748);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t){let r=!!t.preventReEmit,n=!1!==t.decrypt;function i(a){let c;t.toDevice&&delete a.room_id;let d=e.getRoom(a.room_id);d&&void 0===a.state_key&&(c=d.findEventById(a.event_id)),!c||c.status?c=new o.MatrixEvent(a):(c.setUnsigned(l(l({},c.getUnsigned()),a.unsigned)),r=!0);let u=c.getServerAggregatedRelation(s.RelationType.Replace);if(null!=u&&u.content){let e=i(u);c.makeReplaced(e)}let h=null==d?void 0:d.findThreadForEvent(c);return h&&c.setThread(h),c.isEncrypted()&&(r||e.reEmitter.reEmit(c,[o.MatrixEventEvent.Decrypted]),n&&e.decryptEventIfNeeded(c)),r||(e.reEmitter.reEmit(c,[o.MatrixEventEvent.Replaced,o.MatrixEventEvent.VisibilityChange]),null==d||d.reEmitter.reEmit(c,[o.MatrixEventEvent.BeforeRedaction])),c}return i}},41900:function(e,t){"use strict";function r(e){return null!=e}function n(e){return r(e)&&"string"==typeof e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=n,t.isProvided=r},1755:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerSupport=t.Feature=void 0,t.buildFeatureSupportMap=o;let r=t.ServerSupport=function(e){return e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported",e}({}),n=t.Feature=function(e){return e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion",e.RelationsRecursion="RelationsRecursion",e.IntentionalMentions="IntentionalMentions",e}({}),i={[n.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[n.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[n.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[n.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[n.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[n.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"]},[n.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};async function o(e){let t=new Map;for(let[l,c]of Object.entries(i)){var n,o,s,a;let i=null!==(n=null===(o=e.versions)||void 0===o?void 0:o.includes(c.matrixVersion||""))&&void 0!==n&&n,d=null!==(s=null===(a=c.unstablePrefixes)||void 0===a?void 0:a.every(t=>{var r;return(null===(r=e.unstable_features)||void 0===r?void 0:r[t])===!0}))&&void 0!==s&&s;i?t.set(l,r.Stable):d?t.set(l,r.Unstable):t.set(l,r.Unsupported)}return t}},69229:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=void 0;var n=r(93655);function i(e,t){if(!t.endsWith("*"))return e===t;{let r=t.slice(0,-1);return e.slice(0,r.length)===r}}class o{check(e){var t,r;let i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},o=Object.keys(i),s=[];return this.userId&&null!=i&&null!==(r=i[n.THREAD_RELATION_TYPE.name])&&void 0!==r&&r.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,o,s)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[n.FILTER_RELATED_BY_SENDERS.name]:this.filterJson[n.FILTER_RELATED_BY_SENDERS.name]||[],[n.FILTER_RELATED_BY_REL_TYPES.name]:this.filterJson[n.FILTER_RELATED_BY_REL_TYPES.name]||[]}}checkFields(e,t,r,o,s,a){let l={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return i(r,e)}};for(let e in l){let t=l[e],r="not_"+e,n=this.filterJson[r];if(null!=n&&n.some(t))return!1;let i=this.filterJson[e];if(i&&!i.some(t))return!1}let c=this.filterJson.contains_url;if(void 0!==c&&c!==o)return!1;let d=this.filterJson[n.FILTER_RELATED_BY_REL_TYPES.name];if(void 0!==d&&!this.arrayMatchesFilter(d,s))return!1;let u=this.filterJson[n.FILTER_RELATED_BY_SENDERS.name];return!!(void 0===u||this.arrayMatchesFilter(u,a))}arrayMatchesFilter(e,t){return t.length>0&&e.every(e=>t.includes(e))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}constructor(e,t){this.filterJson=e,this.userId=t}}t.FilterComponent=o},51601:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;var i=n(r(13102)),o=r(64791),s=r(69229);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t,r){let n=t.split("."),i=e;for(let e=0;e<n.length-1;e++)i[n[e]]||(i[n[e]]={}),i=i[n[e]];i[n[n.length-1]]=r}class d{static fromJson(e,t,r){let n=new d(e,t);return n.setDefinition(r),n}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;let t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new s.FilterComponent(r,this.userId),this.roomTimelineFilter=new s.FilterComponent((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){c(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=l(l({},this.definition),{},{room:l(l({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:l(l({},null===(r=this.definition)||void 0===r||null===(r=r.room)||void 0===r?void 0:r.timeline),{},{[o.UNREAD_THREAD_NOTIFICATIONS.name]:e})})})}setLazyLoadMembers(e){c(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){c(this.definition,"room.include_leave",e)}constructor(e,t){(0,i.default)(this,"definition",{}),this.userId=e,this.filterId=t}}t.Filter=d,(0,i.default)(d,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},93386:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixError=t.HTTPError=t.ConnectionError=void 0;class r extends Error{constructor(e,t){super(e),this.httpStatus=t}}t.HTTPError=r;class n extends r{constructor(e={},t,r,n){let i=e.error||"Unknown message";t&&(i="[".concat(t,"] ").concat(i)),r&&(i="".concat(i," (").concat(r,")")),super("MatrixError: ".concat(i),t),this.httpStatus=t,this.url=r,this.event=n,this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}t.MatrixError=n;class i extends Error{get name(){return"ConnectionError"}constructor(e,t){super(e+(t?": ".concat(t.message):""))}}t.ConnectionError=i},97574:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.FetchHttpApi=void 0;var i=n(r(13102)),o=r(44480),s=r(44430),a=r(93386),l=r(87635),c=r(71692);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class h{abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):r.g.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,i){let o,a;if(!this.opts.idBaseUrl)throw Error("No identity server base URL set");e===s.Method.Get?o=r:a=r;let l=this.getUrl(t,o,n,this.opts.idBaseUrl),c={json:!0,headers:{}};return i&&(c.headers.Authorization="Bearer ".concat(i)),this.requestOtherUrl(e,l,a,c)}async authedRequest(e,t,r,n){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};r||(r={});let o=u({},i);this.opts.accessToken&&(this.opts.useAuthorizationHeader?(o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=this.opts.accessToken));try{return await this.request(e,t,r,n,o)}catch(a){let s=a;if("M_UNKNOWN_TOKEN"===s.errcode&&!o.doNotAttemptTokenRefresh&&await this.tryRefreshToken())return this.authedRequest(e,t,r,n,u(u({},i),{},{doNotAttemptTokenRefresh:!0}));throw"M_UNKNOWN_TOKEN"!=s.errcode||null!=o&&o.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==s.errcode&&this.eventEmitter.emit(l.HttpApiEvent.NoConsent,s.message,s.data.consent_uri):this.eventEmitter.emit(l.HttpApiEvent.SessionLoggedOut,s),s}}async tryRefreshToken(){if(!this.opts.refreshToken||!this.opts.tokenRefreshFunction)return!1;try{let{accessToken:e,refreshToken:t}=await this.opts.tokenRefreshFunction(this.opts.refreshToken);return this.opts.accessToken=e,this.opts.refreshToken=t,!0}catch(t){var e;return null===(e=this.opts.logger)||void 0===e||e.warn("Failed to refresh token",t),!1}}request(e,t,r,n,i){let o=this.getUrl(t,r,null==i?void 0:i.prefix,null==i?void 0:i.baseUrl);return this.requestOtherUrl(e,o,n,i)}async requestOtherUrl(e,t,r){var n,i,o,s,l,d,u;let h,p,f=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},g=this.sanitizeUrlForLogs(t);null===(n=this.opts.logger)||void 0===n||n.debug("FetchHttpApi: --> ".concat(e," ").concat(g));let m=Object.assign({},f.headers||{}),v=null===(i=f.json)||void 0===i||i,y=v&&(null==r||null===(o=r.constructor)||void 0===o?void 0:o.name)===Object.name;v&&(y&&!m["Content-Type"]&&(m["Content-Type"]="application/json"),m.Accept||(m.Accept="application/json"));let b=null!==(s=f.localTimeoutMs)&&void 0!==s?s:this.opts.localTimeoutMs,S=null!==(l=f.keepAlive)&&void 0!==l&&l,E=[this.abortController.signal];void 0!==b&&E.push((0,c.timeoutSignal)(b)),f.abortSignal&&E.push(f.abortSignal),h=y?JSON.stringify(r):r;let{signal:_,cleanup:w}=(0,c.anySignal)(E),T=Date.now();try{p=await this.fetch(t,{signal:_,method:e,body:h,headers:m,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:S,priority:f.priority}),null===(d=this.opts.logger)||void 0===d||d.debug("FetchHttpApi: <-- ".concat(e," ").concat(g," [").concat(Date.now()-T,"ms ").concat(p.status,"]"))}catch(t){if(null===(u=this.opts.logger)||void 0===u||u.debug("FetchHttpApi: <-- ".concat(e," ").concat(g," [").concat(Date.now()-T,"ms ").concat(t,"]")),"AbortError"===t.name)throw t;throw new a.ConnectionError("fetch failed",t)}finally{w()}if(!p.ok)throw(0,c.parseErrorResponse)(p,await p.text());return this.opts.onlyData?v?p.json():p.text():p}sanitizeUrlForLogs(e){try{let t;t="string"==typeof e?new URL(e):e;let r=new URLSearchParams;for(let e of t.searchParams.keys())r.append(e,"xxx");let n=r.toString(),i=n?"?".concat(n):"";return t.origin+t.pathname+i}catch(e){return"??"}}getUrl(e,t,r,n){let i=null!=n?n:this.opts.baseUrl,s=i.endsWith("/")?i.slice(0,-1):i,a=new URL(s+(null!=r?r:this.opts.prefix)+e);return t&&(0,o.encodeParams)(t,a.searchParams),a}constructor(e,t){var r;(0,i.default)(this,"abortController",new AbortController),this.eventEmitter=e,this.opts=t,(0,o.checkObjectHasKeys)(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=null===(r=t.useAuthorizationHeader)||void 0===r||r}}t.FetchHttpApi=h},498:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0});var i={MatrixHttpApi:!0};t.MatrixHttpApi=void 0;var o=n(r(13102)),s=r(97574),a=r(18447);Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(i,e))&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var l=r(44480),c=g(r(39626)),d=r(44430);Object.keys(d).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(i,e))&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(93386);Object.keys(u).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(i,e))&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(71692);Object.keys(h).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(i,e))&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var p=r(87635);function f(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(f=function(e){return e?r:t})(e)}function g(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=f(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}Object.keys(p).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(i,e))&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});class m extends s.FetchHttpApi{uploadContent(e){var t,n,i,o;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},p=null===(t=s.includeFilename)||void 0===t||t,f=null!==(n=s.abortController)&&void 0!==n?n:new AbortController,g=(null!==(i=s.type)&&void 0!==i?i:e.type)||"application/octet-stream",m=null!==(o=s.name)&&void 0!==o?o:e.name,v={loaded:0,total:0,abortController:f},y=(0,l.defer)();if(r.g.XMLHttpRequest){let t=new r.g.XMLHttpRequest,n=function(){t.abort(),y.reject(Error("Timeout"))},i=c.setTimeout(n,3e4);t.onreadystatechange=function(){if(t.readyState===r.g.XMLHttpRequest.DONE){c.clearTimeout(i);try{if(0===t.status)throw new DOMException(t.statusText,"AbortError");if(!t.responseText)throw Error("No response body.");t.status>=400?y.reject((0,h.parseErrorResponse)(t,t.responseText)):y.resolve(JSON.parse(t.responseText))}catch(e){if("AbortError"===e.name){y.reject(e);return}y.reject(new u.ConnectionError("request failed",e))}}},t.upload.onprogress=e=>{var t;c.clearTimeout(i),v.loaded=e.loaded,v.total=e.total,i=c.setTimeout(n,3e4),null===(t=s.progressHandler)||void 0===t||t.call(s,{loaded:e.loaded,total:e.total})};let o=this.getUrl("/upload",void 0,a.MediaPrefix.V3);p&&m&&o.searchParams.set("filename",encodeURIComponent(m)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&o.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),t.open(d.Method.Post,o.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&t.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),t.setRequestHeader("Content-Type",g),t.send(e),f.signal.addEventListener("abort",()=>{t.abort()})}else{let t={};p&&m&&(t.filename=m);let r={"Content-Type":g};this.authedRequest(d.Method.Post,"/upload",t,e,{prefix:a.MediaPrefix.V3,headers:r,abortSignal:f.signal}).then(e=>this.opts.onlyData?e:e.json()).then(y.resolve,y.reject)}return v.promise=y.promise.finally(()=>{(0,l.removeElement)(this.uploads,e=>e===v)}),f.signal.addEventListener("abort",()=>{(0,l.removeElement)(this.uploads,e=>e===v),y.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(v),v.promise}cancelUpload(e){let t=this.uploads.find(t=>t.promise===e);return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:a.MediaPrefix.V3+"/upload",params:{access_token:this.opts.accessToken}}}constructor(...e){super(...e),(0,o.default)(this,"uploads",[])}}t.MatrixHttpApi=m},87635:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HttpApiEvent=void 0,t.HttpApiEvent=function(e){return e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e}({})},44430:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Method=void 0,t.Method=function(e){return e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e}({})},18447:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaPrefix=t.IdentityPrefix=t.ClientPrefix=void 0,t.ClientPrefix=function(e){return e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e}({}),t.IdentityPrefix=function(e){return e.V2="/_matrix/identity/v2",e}({}),t.MediaPrefix=function(e){return e.V1="/_matrix/media/v1",e.V3="/_matrix/media/v3",e}({})},71692:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.anySignal=l,t.parseErrorResponse=c,t.retryNetworkOperation=h,t.timeoutSignal=a;var n=r(91333),i=r(34002),o=r(44480),s=r(93386);function a(e){let t=new AbortController;return setTimeout(()=>{t.abort()},e),t.signal}function l(e){let t=new AbortController;function r(){for(let t of e)t.removeEventListener("abort",n)}function n(){t.abort(),r()}for(let t of e){if(t.aborted){n();break}t.addEventListener("abort",n)}return{signal:t.signal,cleanup:r}}function c(e,t){var r,n;let i;try{i=u(e)}catch(e){return e}return(null===(r=i)||void 0===r?void 0:r.type)==="application/json"&&t?new s.MatrixError(JSON.parse(t),e.status,d(e)?e.responseURL:e.url):(null===(n=i)||void 0===n?void 0:n.type)==="text/plain"?new s.HTTPError("Server returned ".concat(e.status," error: ").concat(t),e.status):new s.HTTPError("Server returned ".concat(e.status," error"),e.status)}function d(e){return"getResponseHeader"in e}function u(e){let t;if(!(t=d(e)?e.getResponseHeader("Content-Type"):e.headers.get("Content-Type")))return null;try{return(0,n.parse)(t)}catch(e){throw Error("Error parsing Content-Type '".concat(t,"': ").concat(e))}}async function h(e,t){let r=0,n=null;for(;r<e;)try{if(r>0){let e=1e3*Math.pow(2,r);i.logger.log("network operation failed ".concat(r," times, retrying in ").concat(e,"ms...")),await (0,o.sleep)(e)}return await t()}catch(e){if(e instanceof s.ConnectionError)r+=1,n=e;else throw e}throw n}},86036:function(e,t){"use strict";function r(e,t){return new Promise((r,n)=>{let i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),r(i)},o.onerror=()=>n(o.error)})}Object.defineProperty(t,"__esModule",{value:!0}),t.exists=r},78065:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.NoAuthFlowFoundError=t.InteractiveAuth=t.AuthType=void 0;var i=n(r(13102)),o=r(34002),s=r(44480),a=r(498);let l="m.login.email.identity",c="m.login.msisdn",d=t.AuthType=function(e){return e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",e}({});class u extends Error{constructor(e,t,r){super(e),(0,i.default)(this,"name","NoAuthFlowFoundError"),this.required_stages=t,this.flows=r}}t.NoAuthFlowFoundError=u;class h{async attemptAuth(){var e,t;this.attemptAuthDeferred=(0,s.defer)();let r=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&null!==(e=e.flows)&&void 0!==e&&e.length)this.startNextAuthStage();else{null===(t=this.busyChangedCallback)||void 0===t||t.call(this,!0);let e=this.data.session?{session:this.data.session}:null;this.doRequest(e).finally(()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)})}return r}async poll(){if(!this.data.session||!this.attemptAuthDeferred||this.submitPromise)return;let e={};if(this.currentStage==l&&this.emailSid){let t={sid:this.emailSid,client_secret:this.clientSecret},r=new URL(this.matrixClient.getIdentityServerUrl());t.id_server=r.host,e={type:l,threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data)||void 0===t||null===(t=t.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e){var t,r,n;let i,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.attemptAuthDeferred)throw Error("submitAuthDict() called before attemptAuth()");for(o||null===(r=this.busyChangedCallback)||void 0===r||r.call(this,!0);this.submitPromise;)try{await this.submitPromise}catch(e){}null!==(t=this.data)&&void 0!==t&&t.session?Object.assign(i={session:this.data.session},e):i=e;try{this.submitPromise=this.doRequest(i,o),await this.submitPromise}finally{this.submitPromise=null,o||null===(n=this.busyChangedCallback)||void 0===n||n.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{let r=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(r),this.attemptAuthDeferred=null}catch(h){var r,n,i,s,l;let e=h instanceof a.MatrixError?h:null,c=null!==(r=null==e||null===(n=e.data)||void 0===n?void 0:n.flows)&&void 0!==r?r:null,u=(null===(i=this.data)||void 0===i?void 0:i.flows)||!!c;e&&401===e.httpStatus&&e.data&&u||(t?o.logger.log("Background poll request failed doing UI auth: ignoring",h):null===(l=this.attemptAuthDeferred)||void 0===l||l.reject(h)),e&&!e.data&&(e.data={}),!e||e.data.flows||e.data.completed||e.data.session||(e.data.flows=this.data.flows,e.data.completed=this.data.completed,e.data.session=this.data.session),e&&(this.data=e.data);try{this.startNextAuthStage()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null;return}if(!this.emailSid&&null!==(s=this.chosenFlow)&&void 0!==s&&s.stages.includes(d.Email))try{await this.requestEmailToken()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}}}startNextAuthStage(){var e,t,r,n;let i=this.chooseStage();if(!i)throw Error("No incomplete flows from the server");if(this.currentStage=i,i===d.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if(null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error){this.stateUpdatedCallback(i,{errcode:(null===(r=this.data)||void 0===r?void 0:r.errcode)||"",error:(null===(n=this.data)||void 0===n?void 0:n.error)||""});return}this.stateUpdatedCallback(i,i===l?{emailSid:this.emailSid}:{})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),o.logger.log("Active flow => %s",JSON.stringify(this.chosenFlow));let e=this.firstUncompletedStage(this.chosenFlow);return o.logger.log("Next stage: %s",e),e}scoreFlow(e){let t=e.stages.length;return void 0!==this.supportedStages&&(t+=10*e.stages.filter(e=>!this.supportedStages.has(e)).length),t}chooseFlow(){var e;let t=(null===(e=this.data)||void 0===e?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;for(let e of(t.sort((e,t)=>this.scoreFlow(e)-this.scoreFlow(t)),t)){let t=!1,i=!1;for(let r of e.stages)r===l?t=!0:r==c&&(i=!0);if(t==r&&i==n)return e}let i=[];throw r&&i.push(l),n&&i.push(c),new u("No appropriate authentication flow found",i,t)}firstUncompletedStage(e){var t;let r=(null===(t=this.data)||void 0===t?void 0:t.completed)||[];return e.stages.find(e=>!r.includes(e))}constructor(e){(0,i.default)(this,"requestingEmailToken",!1),(0,i.default)(this,"attemptAuthDeferred",null),(0,i.default)(this,"chosenFlow",null),(0,i.default)(this,"currentStage",null),(0,i.default)(this,"emailAttempt",1),(0,i.default)(this,"submitPromise",null),(0,i.default)(this,"requestEmailToken",async()=>{if(this.requestingEmailToken)o.logger.warn("Could not request email token: Already requesting");else{o.logger.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{let e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,o.logger.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}}),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,void 0!==e.supportedStages&&(this.supportedStages=new Set(e.supportedStages))}}t.InteractiveAuth=h},34002:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.LogSpan=void 0;var i=n(r(42954));let o="matrix";function s(e){let t=e;t.getChild=t.withPrefix=function(e){return a((this.prefix||"")+e)}}function a(e){let t=i.default.getLogger("".concat(o,"-").concat(e));return t.prefix!==e&&(s(t),t.prefix=e,t.setLevel(i.default.levels.DEBUG,!1)),t}i.default.methodFactory=function(e,t,r){return function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(this.prefix&&r.unshift(this.prefix),"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e)?console[e](...r):console.log(...r)}};let l=t.logger=i.default.getLogger(o);l.setLevel(i.default.levels.DEBUG,!1),s(l);class c{trace(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}constructor(e,t){this.parent=e,this.name=t+":"}}t.LogSpan=c},301:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={setCryptoStoreFactory:!0,createClient:!0,createRoomWidgetClient:!0,TypedEventEmitter:!0,LocationAssetType:!0,IdentityProviderBrand:!0,SSOAction:!0,ContentHelpers:!0,SecretStorage:!0,createNewMatrixCall:!0,CallEvent:!0,GroupCall:!0,GroupCallEvent:!0,GroupCallIntent:!0,GroupCallState:!0,GroupCallType:!0,GroupCallStatsReportEvent:!0,CryptoEvent:!0,SyncState:!0,SetPresence:!0,SlidingSyncEvent:!0,MediaHandlerEvent:!0,CallFeedEvent:!0,StatsReport:!0,Relations:!0,RelationsEvent:!0,LocalStorageErrors:!0,DeviceVerificationStatus:!0,Crypto:!0};Object.defineProperty(t,"CallEvent",{enumerable:!0,get:function(){return ei.CallEvent}}),Object.defineProperty(t,"CallFeedEvent",{enumerable:!0,get:function(){return ed.CallFeedEvent}}),t.Crypto=t.ContentHelpers=void 0,Object.defineProperty(t,"CryptoEvent",{enumerable:!0,get:function(){return es.CryptoEvent}}),Object.defineProperty(t,"DeviceVerificationStatus",{enumerable:!0,get:function(){return ef.DeviceVerificationStatus}}),Object.defineProperty(t,"GroupCall",{enumerable:!0,get:function(){return eo.GroupCall}}),Object.defineProperty(t,"GroupCallEvent",{enumerable:!0,get:function(){return eo.GroupCallEvent}}),Object.defineProperty(t,"GroupCallIntent",{enumerable:!0,get:function(){return eo.GroupCallIntent}}),Object.defineProperty(t,"GroupCallState",{enumerable:!0,get:function(){return eo.GroupCallState}}),Object.defineProperty(t,"GroupCallStatsReportEvent",{enumerable:!0,get:function(){return eo.GroupCallStatsReportEvent}}),Object.defineProperty(t,"GroupCallType",{enumerable:!0,get:function(){return eo.GroupCallType}}),Object.defineProperty(t,"IdentityProviderBrand",{enumerable:!0,get:function(){return H.IdentityProviderBrand}}),Object.defineProperty(t,"LocalStorageErrors",{enumerable:!0,get:function(){return ep.LocalStorageErrors}}),Object.defineProperty(t,"LocationAssetType",{enumerable:!0,get:function(){return W.LocationAssetType}}),Object.defineProperty(t,"MediaHandlerEvent",{enumerable:!0,get:function(){return ec.MediaHandlerEvent}}),Object.defineProperty(t,"Relations",{enumerable:!0,get:function(){return eh.Relations}}),Object.defineProperty(t,"RelationsEvent",{enumerable:!0,get:function(){return eh.RelationsEvent}}),Object.defineProperty(t,"SSOAction",{enumerable:!0,get:function(){return H.SSOAction}}),t.SecretStorage=void 0,Object.defineProperty(t,"SetPresence",{enumerable:!0,get:function(){return ea.SetPresence}}),Object.defineProperty(t,"SlidingSyncEvent",{enumerable:!0,get:function(){return el.SlidingSyncEvent}}),Object.defineProperty(t,"StatsReport",{enumerable:!0,get:function(){return eu.StatsReport}}),Object.defineProperty(t,"SyncState",{enumerable:!0,get:function(){return ea.SyncState}}),Object.defineProperty(t,"TypedEventEmitter",{enumerable:!0,get:function(){return w.TypedEventEmitter}}),t.createClient=eS,Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return ei.createNewMatrixCall}}),t.createRoomWidgetClient=eE,t.setCryptoStoreFactory=ey;var i=r(46455);Object.keys(i).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(82908);Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var s=r(89657);Object.keys(s).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var a=r(32950);Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var l=r(1513);Object.keys(l).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var c=r(498);Object.keys(c).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))});var d=r(32540);Object.keys(d).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(88903);Object.keys(u).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(74460);Object.keys(h).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var p=r(98870);Object.keys(p).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var f=r(12533);Object.keys(f).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))});var g=r(39325);Object.keys(g).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))});var m=r(29197);Object.keys(m).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))});var v=r(91776);Object.keys(v).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))});var y=r(10907);Object.keys(y).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))});var b=r(32472);Object.keys(b).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))});var S=r(74130);Object.keys(S).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))});var E=r(19389);Object.keys(E).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))});var _=r(93655);Object.keys(_).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))});var w=r(44441);Object.keys(w).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))});var T=r(69509);Object.keys(T).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))});var I=r(74967);Object.keys(I).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))});var O=r(53014);Object.keys(O).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))});var R=r(30434);Object.keys(R).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))});var C=r(51601);Object.keys(C).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))});var k=r(15809);Object.keys(k).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))});var M=r(78065);Object.keys(M).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===M[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return M[e]}}))});var P=r(67439);Object.keys(P).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))});var A=r(37327);Object.keys(A).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))});var D=r(28875);Object.keys(D).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))});var x=r(87786);Object.keys(x).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===x[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return x[e]}}))});var j=r(34479);Object.keys(j).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===j[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return j[e]}}))});var U=r(41121);Object.keys(U).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===U[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return U[e]}}))});var L=r(15748);Object.keys(L).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===L[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return L[e]}}))});var N=r(49820);Object.keys(N).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===N[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return N[e]}}))});var B=r(36673);Object.keys(B).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===B[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return B[e]}}))});var F=r(69427);Object.keys(F).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===F[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return F[e]}}))});var K=r(14150);Object.keys(K).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===K[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return K[e]}}))});var q=r(42e3);Object.keys(q).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return q[e]}}))});var V=r(49699);Object.keys(V).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===V[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return V[e]}}))});var W=r(13043);Object.keys(W).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===W[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return W[e]}}))});var G=r(33097);Object.keys(G).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===G[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return G[e]}}))});var H=r(19905);Object.keys(H).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===H[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return H[e]}}))});var z=r(11235);Object.keys(z).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return z[e]}}))});var J=r(10436);Object.keys(J).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===J[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return J[e]}}))});var Y=r(82526);Object.keys(Y).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===Y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Y[e]}}))});var Q=r(64157);Object.keys(Q).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===Q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Q[e]}}))});var X=r(35095);Object.keys(X).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===X[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return X[e]}}))});var $=r(9792);Object.keys($).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===$[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return $[e]}}))});var Z=r(77897);Object.keys(Z).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===Z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Z[e]}}))});var ee=r(71162);Object.keys(ee).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===ee[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return ee[e]}}))});var et=r(39883);Object.keys(et).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===et[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return et[e]}}))});var er=em(r(79662));t.ContentHelpers=er;var en=em(r(98466));t.SecretStorage=en;var ei=r(59721),eo=r(41943),es=r(94161),ea=r(9855),el=r(92882),ec=r(33551),ed=r(71968),eu=r(70941),eh=r(81528),ep=r(51456),ef=em(r(68995));function eg(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(eg=function(e){return e?r:t})(e)}function em(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=eg(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}t.Crypto=ef;let ev=()=>new i.MemoryCryptoStore;function ey(e){ev=e}function eb(e){var t,n,i;return e.store=null!==(t=e.store)&&void 0!==t?t:new o.MemoryStore({localStorage:r.g.localStorage}),e.scheduler=null!==(n=e.scheduler)&&void 0!==n?n:new s.MatrixScheduler,e.cryptoStore=null!==(i=e.cryptoStore)&&void 0!==i?i:ev(),e}function eS(e){return new a.MatrixClient(eb(e))}function eE(e,t,r,n){return new l.RoomWidgetClient(e,t,r,eb(n))}},35767:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallMembership=void 0;var n=r(44480);class i{static equal(e,t){return(0,n.deepCompare)(e.data,t.data)}get sender(){return this.parentEvent.getSender()}get callId(){return this.data.call_id}get deviceId(){return this.data.device_id}get application(){return this.data.application}get scope(){return this.data.scope}get membershipID(){return this.data.membershipID}createdTs(){var e;return null!==(e=this.data.created_ts)&&void 0!==e?e:this.parentEvent.getTs()}getAbsoluteExpiry(){return this.data.expires?this.createdTs()+this.data.expires:this.data.expires_ts}getLocalExpiry(){if(!this.data.expires)return this.data.expires_ts;{let e=this.parentEvent.getTs()-this.createdTs();return this.parentEvent.localTimestamp-e+this.data.expires}}getMsUntilExpiry(){return this.getLocalExpiry()-Date.now()}isExpired(){return 0>=this.getMsUntilExpiry()}getActiveFoci(){var e;return null!==(e=this.data.foci_active)&&void 0!==e?e:[]}constructor(e,t){if(this.parentEvent=e,this.data=t,!(t.expires||t.expires_ts))throw Error("Malformed membership: expires_ts or expires must be present");if(t.expires&&"number"!=typeof t.expires)throw Error("Malformed membership: expires must be numeric");if(t.expires_ts&&"number"!=typeof t.expires_ts)throw Error("Malformed membership: expires_ts must be numeric");if("string"!=typeof t.device_id)throw Error("Malformed membership event: device_id must be string");if("string"!=typeof t.call_id)throw Error("Malformed membership event: call_id must be string");if("string"!=typeof t.scope)throw Error("Malformed membership event: scope must be string");if(!e.getSender())throw Error("Invalid parent event: sender is null")}}t.CallMembership=i},86396:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixRTCSessionEvent=t.MatrixRTCSession=void 0;var i=n(r(13102)),o=r(34002),s=r(44441),a=r(91776),l=r(15748),c=r(35767),d=r(89027),u=r(98870);let h=36e5,p=12e4,f=3e3,g=3e3,m=3e3,v=5e3,y=(e,t)=>"".concat(e,":").concat(t),b=e=>y(e.sender,e.deviceId);function S(e,t){return e===t||e&&t&&e.length===t.length&&e.every((e,r)=>e===t[r])}let E=t.MatrixRTCSessionEvent=function(e){return e.MembershipsChanged="memberships_changed",e.JoinStateChanged="join_state_changed",e.EncryptionKeyChanged="encryption_key_changed",e}({});class _ extends s.TypedEventEmitter{get callId(){return this._callId}static callMembershipsForRoom(e){let t=e.getLiveTimeline().getState(a.EventTimeline.FORWARDS);if(!t)throw o.logger.warn("Couldn't get state for room "+e.roomId),Error("Could't get state for room "+e.roomId);let r=t.getStateEvents(l.EventType.GroupCallMemberPrefix),n=[];for(let e of r){let t=e.getContent().memberships;if(void 0===t){o.logger.debug("Ignoring malformed member event from ".concat(e.getSender(),": no memberships section"));continue}if(!Array.isArray(t)){o.logger.warn("Malformed member event from ".concat(e.getSender(),": memberships is not an array"));continue}for(let r of t)try{let t=new c.CallMembership(e,r);if(""!==t.callId||"m.room"!==t.scope){o.logger.info("Ignoring user-scoped call");continue}if(t.isExpired()){o.logger.info("Ignoring expired device membership ".concat(e.getSender(),"/").concat(t.deviceId));continue}n.push(t)}catch(e){o.logger.warn("Couldn't construct call membership: ",e)}}return n.sort((e,t)=>e.createdTs()-t.createdTs()),n.length>1&&o.logger.debug("Call memberships in room ".concat(e.roomId,", in order: "),n.map(e=>[e.createdTs(),e.sender])),n}static roomSessionForRoom(e,t){let r=_.callMembershipsForRoom(t);return new _(e,t,r)}isJoined(){return void 0!==this.relativeExpiry}async stop(){await this.leaveRoomSession(1e3),this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0)}joinRoomSession(e,t){if(this.isJoined()){o.logger.info("Already joined to session in room ".concat(this.room.roomId,": ignoring join call"));return}o.logger.info("Joining call session in room ".concat(this.room.roomId," with manageMediaKeys=").concat(t)),this.activeFoci=e,this.relativeExpiry=h,this.manageMediaKeys=null!=t&&t,this.membershipId=(0,d.randomString)(5),this.emit(E.JoinStateChanged,!0),t&&(this.makeNewSenderKey(),this.requestKeyEventSend()),this.triggerCallMembershipEventUpdate()}async leaveRoomSession(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(!this.isJoined())return o.logger.info("Not joined to session in room ".concat(this.room.roomId,": ignoring leave call")),new Promise(e=>e(!1));let t=this.client.getUserId(),r=this.client.getDeviceId();if(!t)throw Error("No userId");if(!r)throw Error("No deviceId");for(let e of(this.encryptionKeys.set(y(t,r),[]),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0),this.setNewKeyTimeouts))clearTimeout(e);this.setNewKeyTimeouts.clear(),o.logger.info("Leaving call session in room ".concat(this.room.roomId)),this.relativeExpiry=void 0,this.activeFoci=void 0,this.manageMediaKeys=!1,this.membershipId=void 0,this.emit(E.JoinStateChanged,!1);let n=new Promise(t=>{e&&setTimeout(t,e,"timeout")});return new Promise(e=>{Promise.race([this.triggerCallMembershipEventUpdate(),n]).then(t=>{e("timeout"!=t)})})}getKeysForParticipant(e,t){return this.encryptionKeys.get(y(e,t))}getEncryptionKeys(){return this.encryptionKeys.entries()}getNewEncryptionKeyIndex(){var e,t;let r=this.client.getUserId(),n=this.client.getDeviceId();if(!r)throw Error("No userId!");if(!n)throw Error("No deviceId!");return(null!==(e=null===(t=this.getKeysForParticipant(r,n))||void 0===t?void 0:t.length)&&void 0!==e?e:0)%16}setEncryptionKey(e,t,r,n){var i;let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=(0,u.decodeBase64)(n),l=y(e,t),c=null!==(i=this.encryptionKeys.get(l))&&void 0!==i?i:[];if(!S(c[r],a)){if(c[r]=a,this.encryptionKeys.set(l,c),s){let e=setTimeout(()=>{this.setNewKeyTimeouts.delete(e),o.logger.info("Delayed-emitting key changed event for ".concat(l," idx ").concat(r)),this.emit(E.EncryptionKeyChanged,a,r,l)},v);this.setNewKeyTimeouts.add(e)}else this.emit(E.EncryptionKeyChanged,a,r,l)}}makeNewSenderKey(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.client.getUserId(),r=this.client.getDeviceId();if(!t)throw Error("No userId");if(!r)throw Error("No deviceId");let n=(0,d.secureRandomBase64Url)(16),i=this.getNewEncryptionKeyIndex();o.logger.info("Generated new key at index "+i),this.setEncryptionKey(t,r,i,n,e)}requestKeyEventSend(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+g>Date.now()){o.logger.info("Last encryption key event sent too recently: postponing"),void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,g));return}this.sendEncryptionKeysEvent()}}setExpiryTimer(){let e;for(let t of(this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberships)){let r=t.getMsUntilExpiry();(void 0===e||r<e)&&(e=r)}void 0!=e&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}makeMyMembership(e){var t,r;if(void 0===this.relativeExpiry)throw Error("Tried to create our own membership event when we're not joined!");if(void 0===this.membershipId)throw Error("Tried to create our own membership event when we have no membership ID!");let n={call_id:"",scope:"m.room",application:"m.call",device_id:this.client.getDeviceId(),expires:this.relativeExpiry,foci_active:this.activeFoci,membershipID:this.membershipId};return e&&(n.created_ts=e.createdTs()),n.created_ts?n.expires_ts=n.created_ts+(null!==(t=n.expires)&&void 0!==t?t:0):n.expires_ts=Date.now()+(null!==(r=n.expires)&&void 0!==r?r:0),n}membershipEventNeedsUpdate(e,t){let r=!1;return!this.isJoined()&&e&&(r=!0),this.isJoined()&&(t?t.getMsUntilExpiry()<h/2&&(r=!0,this.relativeExpiry+=h):r=!0),r}makeNewMemberships(e,t,r){let n=this.client.getDeviceId();if(!n)throw Error("Local device ID is null!");let i=e=>{let r;try{r=new c.CallMembership(t,e)}catch(e){return!1}return!r.isExpired()},o=e=>(void 0===e.created_ts&&(e.created_ts=t.getTs()),e),s=e.filter(i).filter(e=>e.device_id!==n);return s=s.map(o),this.isJoined()&&s.push(this.makeMyMembership(r)),s}async updateCallMembershipEvent(){var e,t;let r;this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);let n=this.room.getLiveTimeline().getState(a.EventTimeline.FORWARDS);if(!n)throw Error("Couldn't get room state for room "+this.room.roomId);let i=this.client.getUserId(),s=this.client.getDeviceId();if(!i||!s)throw Error("User ID or device ID was null!");let d=null!==(e=n.getStateEvents(l.EventType.GroupCallMemberPrefix,i))&&void 0!==e?e:void 0,u=null!==(t=null==d?void 0:d.getContent())&&void 0!==t?t:{},h=Array.isArray(u.memberships)?u.memberships:[],g=h.find(e=>e.device_id===s);try{d&&g&&g.membershipID===this.membershipId&&(r=new c.CallMembership(d,g))}catch(e){o.logger.warn("Our previous call membership was invalid - this shouldn't happen.",e)}if(r&&o.logger.debug("".concat(r.getMsUntilExpiry()," until our membership expires")),!this.membershipEventNeedsUpdate(g,r)){this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,p);return}let m={memberships:this.makeNewMemberships(h,d,r)};try{await this.client.sendStateEvent(this.room.roomId,l.EventType.GroupCallMemberPrefix,m,i),o.logger.info("Sent updated call member event."),this.isJoined()&&(this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,p))}catch(t){let e=f+2e3*Math.random();o.logger.warn("Failed to send call member event: retrying in ".concat(e)),await new Promise(t=>setTimeout(t,e)),await this.triggerCallMembershipEventUpdate()}}constructor(e,t,r){var n;super(),(0,i.default)(this,"setNewKeyTimeouts",new Set),(0,i.default)(this,"updateCallMembershipRunning",!1),(0,i.default)(this,"needCallMembershipUpdate",!1),(0,i.default)(this,"manageMediaKeys",!1),(0,i.default)(this,"encryptionKeys",new Map),(0,i.default)(this,"sendEncryptionKeysEvent",async()=>{if(void 0!==this.keysEventUpdateTimeout&&(clearTimeout(this.keysEventUpdateTimeout),this.keysEventUpdateTimeout=void 0),this.lastEncryptionKeyUpdateRequest=Date.now(),o.logger.info("Sending encryption keys event"),!this.isJoined())return;let e=this.client.getUserId(),t=this.client.getDeviceId();if(!e)throw Error("No userId");if(!t)throw Error("No deviceId");let r=this.getKeysForParticipant(e,t);if(!r){o.logger.warn("Tried to send encryption keys event but no keys found!");return}try{await this.client.sendEvent(this.room.roomId,l.EventType.CallEncryptionKeysPrefix,{keys:r.map((e,t)=>({index:t,key:(0,u.encodeUnpaddedBase64)(e)})),device_id:t,call_id:""}),o.logger.debug("Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=".concat(e,":").concat(t," numSent=").concat(r.length),this.encryptionKeys)}catch(t){let e=t;if(e.event&&this.client.cancelPendingEvent(e.event),void 0===this.keysEventUpdateTimeout){var n,i;let r=null!==(n=null===(i=e.data)||void 0===i?void 0:i.retry_after_ms)&&void 0!==n?n:5e3;o.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(r),t),this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,r)}else o.logger.info("Not scheduling key resend as another re-send is already pending")}}),(0,i.default)(this,"onCallEncryption",e=>{let t=e.getSender(),r=e.getContent(),n=r.device_id,i=r.call_id;if(!t){o.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(i));return}if(""!==i){o.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(i));return}if(!Array.isArray(r.keys)){o.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(i));return}if(t===this.client.getUserId()&&n===this.client.getDeviceId()){o.logger.info("Ignoring our own keys event");return}for(let e of r.keys){if(!e){o.logger.info("Ignoring false-y key in keys event");continue}let r=e.key,s=e.index;r&&null!=s&&null!=i&&"string"==typeof n&&"string"==typeof i&&"string"==typeof r&&"number"==typeof s?(o.logger.debug("Embedded-E2EE-LOG onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(s),this.encryptionKeys),this.setEncryptionKey(t,n,s,r)):o.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(s," callId=").concat(i))}}),(0,i.default)(this,"onMembershipUpdate",()=>{var e,t;let r=this.memberships;this.memberships=_.callMembershipsForRoom(this.room),this._callId=null!==(e=this._callId)&&void 0!==e?e:null===(t=this.memberships[0])||void 0===t?void 0:t.callId,(r.length!=this.memberships.length||r.some((e,t)=>!c.CallMembership.equal(e,this.memberships[t])))&&(o.logger.info("Memberships for call in room ".concat(this.room.roomId," have changed: emitting")),this.emit(E.MembershipsChanged,r,this.memberships));let n=e=>e.sender===this.client.getUserId()&&e.deviceId===this.client.getDeviceId();if(this.manageMediaKeys&&this.isJoined()&&void 0===this.makeNewKeyTimeout){let e=new Set(r.filter(e=>!n(e)).map(b)),t=new Set(this.memberships.filter(e=>!n(e)).map(b)),i=Array.from(e).some(e=>!t.has(e)),s=Array.from(t).some(t=>!e.has(t));i?(o.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,m)):s&&(o.logger.debug("New member(s) have joined: re-sending keys"),this.requestKeyEventSend())}this.setExpiryTimer()}),(0,i.default)(this,"triggerCallMembershipEventUpdate",async()=>{if(this.updateCallMembershipRunning){this.needCallMembershipUpdate=!0;return}this.updateCallMembershipRunning=!0;try{do this.needCallMembershipUpdate=!1,await this.updateCallMembershipEvent();while(this.needCallMembershipUpdate)}finally{this.updateCallMembershipRunning=!1}}),(0,i.default)(this,"onRotateKeyTimeout",()=>{this.manageMediaKeys&&(this.makeNewKeyTimeout=void 0,o.logger.info("Making new sender key for key rotation"),this.makeNewSenderKey(!0),this.sendEncryptionKeysEvent())}),this.client=e,this.room=t,this.memberships=r,this._callId=null===(n=r[0])||void 0===n?void 0:n.callId,this.setExpiryTimer()}}t.MatrixRTCSession=_},33829:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixRTCSessionManagerEvents=t.MatrixRTCSessionManager=void 0;var i=n(r(13102)),o=r(34002),s=r(32950),a=r(44441),l=r(29197),c=r(19389),d=r(86396),u=r(15748);let h=t.MatrixRTCSessionManagerEvents=function(e){return e.SessionStarted="session_started",e.SessionEnded="session_ended",e}({});class p extends a.TypedEventEmitter{start(){for(let t of null!==(e=this.client.getRooms())&&void 0!==e?e:[]){var e;let r=d.MatrixRTCSession.roomSessionForRoom(this.client,t);r.memberships.length>0&&this.roomSessions.set(t.roomId,r)}this.client.on(s.ClientEvent.Room,this.onRoom),this.client.on(l.RoomEvent.Timeline,this.onTimeline),this.client.on(c.RoomStateEvent.Events,this.onRoomState)}stop(){for(let e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.removeListener(s.ClientEvent.Room,this.onRoom),this.client.removeListener(l.RoomEvent.Timeline,this.onTimeline),this.client.removeListener(c.RoomStateEvent.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,d.MatrixRTCSession.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}refreshRoom(e){let t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onMembershipUpdate();let i=r.memberships.length>0;n&&!i?this.emit(h.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!n&&i&&this.emit(h.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}constructor(e){super(),(0,i.default)(this,"roomSessions",new Map),(0,i.default)(this,"onTimeline",e=>{if(e.getType()!==u.EventType.CallEncryptionKeysPrefix)return;let t=this.client.getRoom(e.getRoomId());if(!t){o.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!"));return}this.getRoomSession(t).onCallEncryption(e)}),(0,i.default)(this,"onRoom",e=>{this.refreshRoom(e)}),(0,i.default)(this,"onRoomState",(e,t)=>{let r=this.client.getRoom(e.getRoomId());if(!r){o.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!"));return}e.getType()==u.EventType.GroupCallMemberPrefix&&this.refreshRoom(r)}),this.client=e}}t.MatrixRTCSessionManager=p},19940:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MSC3089Branch=void 0;var i=n(r(13102)),o=r(15748),s=r(91776);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class c{get id(){let e=this.indexEvent.getStateKey();if(!e)throw Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);let e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,l(l({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,l(l({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){let e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw Error("No HTTP URL available for ".concat(e.url));return{info:e,httpUrl:t}}async getFileEvent(){let e=this.client.getRoom(this.roomId);if(!e)throw Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(s.EventTimeline.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw Error("Failed to find event");return await this.client.decryptEventIfNeeded(t),t}async createNewVersion(e,t,r,n){let i=await this.directory.createFile(e,t,r,l(l({},null!=n?n:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:o.RelationType.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e,version:this.version+1},i.event_id),await this.client.sendStateEvent(this.roomId,o.UNSTABLE_MSC3089_BRANCH.name,l(l({},this.indexEvent.getContent()),{},{active:!1}),this.id),i}async getVersionHistory(){let e;let t=[];t.push(this);let r=this.client.getRoom(this.roomId);if(!r)throw Error("Invalid or unknown room");let n=[...r.getLiveTimeline().getEvents()].reverse(),i=await this.getFileEvent();do if(e=n.find(e=>e.replacingEventId()===i.getId())){let r=this.directory.getFile(e.getId());if(r)t.push(r),i=e;else break}while(e);return t}constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}}t.MSC3089Branch=c},43705:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.TreePermissions=t.MSC3089TreeSpace=t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;var i=n(r(13102)),o=n(r(42759)),s=r(15748),a=r(34002),l=r(44480),c=r(19940),d=r(96229);function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}t.DEFAULT_TREE_POWER_LEVELS_TEMPLATE={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[s.EventType.RoomPowerLevels]:100,[s.EventType.RoomHistoryVisibility]:100,[s.EventType.RoomTombstone]:100,[s.EventType.RoomEncryption]:100,[s.EventType.RoomName]:50,[s.EventType.RoomMessage]:50,[s.EventType.RoomMessageEncrypted]:50,[s.EventType.Sticker]:50},users:{}};let p=t.TreePermissions=function(e){return e.Viewer="viewer",e.Editor="editor",e.Owner="owner",e}({});class f{get id(){return this.roomId}get isTopLevel(){let e=this.room.currentState.getStateEvents(s.EventType.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)})}async setName(e){await this.client.sendStateEvent(this.roomId,s.EventType.RoomName,{name:e},"")}async invite(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=[this.retryInvite(e)];return t&&n.push(...this.getDirectories().map(n=>n.invite(e,t,r))),Promise.all(n).then(()=>{r&&(0,d.isRoomSharedHistory)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])})}retryInvite(e){return(0,l.simpleRetryOperation)(async()=>{await this.client.invite(this.roomId,e).catch(e=>{if((null==e?void 0:e.errcode)==="M_FORBIDDEN")throw new o.default.AbortError(e);throw e})})}async setPermissions(e,t){var r;let n=this.room.currentState.getStateEvents(s.EventType.RoomPowerLevels,"");if(Array.isArray(n))throw Error("Unexpected return type for power levels");let i=(null==n?void 0:n.getContent())||{},o=i.users_default||0,a=i.events_default||50,l=(null===(r=i.events)||void 0===r?void 0:r[s.EventType.RoomPowerLevels])||100,c=i.users||{};switch(t){case p.Viewer:c[e]=o;break;case p.Editor:c[e]=a;break;case p.Owner:c[e]=l;break;default:throw Error("Invalid role: "+t)}i.users=c,await this.client.sendStateEvent(this.roomId,s.EventType.RoomPowerLevels,i,"")}getPermissions(e){var t,r;let n=this.room.currentState.getStateEvents(s.EventType.RoomPowerLevels,"");if(Array.isArray(n))throw Error("Unexpected return type for power levels");let i=(null==n?void 0:n.getContent())||{},o=i.users_default||0,a=i.events_default||50,l=(null===(t=i.events)||void 0===t?void 0:t[s.EventType.RoomPowerLevels])||100,c=(null===(r=i.users)||void 0===r?void 0:r[e])||o;return c>=l?p.Owner:c>=a?p.Editor:p.Viewer}async createDirectory(e){let t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,s.EventType.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,s.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){let e=[];for(let t of this.room.currentState.getStateEvents(s.EventType.SpaceChild))try{let r=t.getStateKey();if(r){let t=this.client.unstableGetFileTreeSpace(r);t&&e.push(t)}}catch(e){a.logger.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}async delete(){for(let e of this.getDirectories())await e.delete();let e=["invite","knock","join"];for(let t of this.room.currentState.getStateEvents(s.EventType.RoomMember))if(t.getStateKey()!==this.client.getUserId()&&e.includes(t.getContent().membership)){let e=t.getStateKey();if(!e)throw Error("State key not found for branch");await this.client.kick(this.roomId,e,"Room deleted")}await this.client.leave(this.roomId)}getOrderedChildren(e){let t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order})).filter(e=>e.roomId);return t.sort((e,t)=>{if(e.order&&!t.order)return -1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,l.lexicographicCompare)(e.order,t.order);{var r,n,i,o;let a=this.client.getRoom(e.roomId),c=this.client.getRoom(t.roomId);if(!a||!c)return(0,l.lexicographicCompare)(e.roomId,t.roomId);let d=null!==(r=null===(n=a.currentState.getStateEvents(s.EventType.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==r?r:0,u=null!==(i=null===(o=c.currentState.getStateEvents(s.EventType.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==i?i:0;return d===u?(0,l.lexicographicCompare)(e.roomId,t.roomId):d-u}}),t}getParentRoom(){let e=this.room.currentState.getStateEvents(s.EventType.SpaceParent)[0];if(!e)throw Error("Expected to have a parent in a non-top level space");let t=e.getStateKey();if(!t)throw Error("No state key found for parent");let r=this.client.getRoom(t);if(!r)throw Error("Unable to locate room for parent");return r}getOrder(){if(this.isTopLevel)return -1;let e=this.getParentRoom().currentState.getStateEvents(s.EventType.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}async setOrder(e){var t,r;if(this.isTopLevel)throw Error("Cannot set order of top level spaces currently");let n=this.getParentRoom(),i=n.currentState.getStateEvents(s.EventType.SpaceChild),o=this.getOrderedChildren(i);e=Math.max(Math.min(e,o.length-1),0);let a=this.getOrder()<e;a&&e===o.length-1?e--:!a&&0===e&&e++;let c=o[a?e:e-1],d=o[a?e+1:e],u=l.DEFAULT_ALPHABET[0],p=!1;if(c){if(e===o.length-1)null!=d&&d.order&&(u=(0,l.nextString)(d.order));else{let e=null==c?void 0:c.order,t=null==d?void 0:d.order;e&&t?u=e===t?(0,l.nextString)(e):(0,l.averageBetweenStrings)(e,t):e?u=(0,l.nextString)(e):t?u=(0,l.prevString)(t):p=!0}}else null!=d&&d.order&&(u=(0,l.prevString)(d.order));if(p){let t;for(let i=0;i<=e;i++){let e=o[i];if(0===i&&(t=e.order),e.order)t=e.order;else{t=t?(0,l.nextString)(t):l.DEFAULT_ALPHABET[0];let i=n.currentState.getStateEvents(s.EventType.SpaceChild,e.roomId),o=null!==(r=null==i?void 0:i.getContent())&&void 0!==r?r:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,s.EventType.SpaceChild,h(h({},o),{},{order:t}),e.roomId)}}t&&(u=(0,l.nextString)(t))}let f=n.currentState.getStateEvents(s.EventType.SpaceChild,this.roomId),g=null!==(t=null==f?void 0:f.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(n.roomId,s.EventType.SpaceChild,h(h({},g),{},{order:u}),this.roomId)}async createFile(e,t,r,n){var i;let{content_uri:o}=await this.client.uploadContent(t,{includeFilename:!1});r.url=o;let a={msgtype:s.MsgType.File,body:e,url:o,file:r};(n=null!==(i=n)&&void 0!==i?i:{})["m.new_content"]&&(n["m.new_content"]=a);let l=await this.client.sendMessage(this.roomId,h(h(h({},n),a),{},{[s.UNSTABLE_MSC3089_LEAF.name]:{}}));return await this.client.sendStateEvent(this.roomId,s.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e},l.event_id),l}getFile(e){let t=this.room.currentState.getStateEvents(s.UNSTABLE_MSC3089_BRANCH.name,e);return t?new c.MSC3089Branch(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(s.UNSTABLE_MSC3089_BRANCH.name))&&void 0!==e?e:[]).map(e=>new c.MSC3089Branch(this.client,e,this))}constructor(e,t){if(this.client=e,this.roomId=t,this.room=this.client.getRoom(this.roomId),!this.room)throw Error("Unknown room")}}t.MSC3089TreeSpace=f},12533:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.isTimestampInDuration=t.getBeaconInfoIdentifier=t.BeaconEvent=t.Beacon=void 0;var i=n(r(13102)),o=r(79662),s=r(44480),a=r(44441);let l=t.BeaconEvent=function(e){return e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate",e}({}),c=(e,t,r)=>r>=e&&e+t>=r;t.isTimestampInDuration=c;let d=e=>"".concat(e.getRoomId(),"_").concat(e.getStateKey());t.getBeaconInfoIdentifier=d;class u extends a.TypedEventEmitter{get isLive(){return!!this._isLive}get identifier(){return d(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,o.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(d(e)!==this.identifier)throw Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(l.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(l.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo){if(this.isLive){let e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}}addLocations(e){var t;if(!this.isLive)return;let r=null===(t=e.filter(e=>{let t=e.getContent(),r=(0,o.parseBeaconContent)(t);if(!r.uri||!r.timestamp)return!1;let{timestamp:n}=r;return this._beaconInfo.timestamp&&c(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)}).sort(s.sortEventsByLatestContentTimestamp))||void 0===t?void 0:t[0];r&&(this._latestLocationEvent=r,this.emit(l.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=(0,o.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){let e=this.isLive;if(!this.beaconInfo)return;let t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&c(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(l.LivenessChange,this.isLive,this)}constructor(e){super(),(0,i.default)(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(l.LocationUpdate,this.latestLocationState)}),this.rootEvent=e,this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}}t.Beacon=u},72071:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareEventOrdering=i;var n=r(32950);function i(e,t,r){let i=e.findEventById(t),a=e.findEventById(r);if(!i||!a)return null;let l=(0,n.inMainTimelineForReceipt)(i),c=(0,n.inMainTimelineForReceipt)(a);return l&&c?o(e,t,r,i,a):s(t,r,i,a)}function o(e,t,r,n,i){let o=e.getUnfilteredTimelineSet(),s=o.compareEventOrdering(t,r);return null!==s?s:o.getTimelineForEvent(t)===o.getLiveTimeline()?1:o.getTimelineForEvent(r)===o.getLiveTimeline()?-1:a(n,i)}function s(e,t,r,i){let o=(0,n.threadIdForReceipt)(r),s=(0,n.threadIdForReceipt)(i),l=r.getThread();return l&&o===s?l.timelineSet.compareEventOrdering(e,t):a(r,i)}function a(e,t){let r=e.getTs(),n=t.getTs();return r<n?-1:r>n?1:0}},74967:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceVerification=t.Device=void 0;let r=t.DeviceVerification=function(e){return e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e}({});class n{getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}constructor(e){this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||r.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName}}t.Device=n},78583:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=void 0;var i=n(r(13102)),o=r(91776);class s{getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?o.Direction.Backward:o.Direction.Forward]}setPaginateToken(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?o.Direction.Backward:o.Direction.Forward]=null!=e?e:null}addEvents(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}constructor(e){(0,i.default)(this,"ourEventIndex",0),(0,i.default)(this,"paginateTokens",{[o.Direction.Backward]:null,[o.Direction.Forward]:null}),this.ourEvent=e,this.timeline=[e]}}t.EventContext=s},39883:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventStatus=void 0,t.EventStatus=function(e){return e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled",e}({})},10907:function(e,t,r){"use strict";let n;var i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimelineSet=t.DuplicateStrategy=void 0;var o=i(r(13102)),s=r(91776),a=r(34002),l=r(29197),c=r(44441),d=r(36504);n=a.logger.log.bind(a.logger);let u=t.DuplicateStrategy=function(e){return e.Ignore="ignore",e.Replace="replace",e}({});class h extends c.TypedEventEmitter{getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){let r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){let r=!this.timelineSupport||!t,n=this.liveTimeline,i=r?n.forkLive(s.EventTimeline.FORWARDS):n.fork(s.EventTimeline.FORWARDS);r?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&n.setPaginationToken(t,s.EventTimeline.FORWARDS),i.setPaginationToken(null!=e?e:null,s.EventTimeline.BACKWARDS),this.liveTimeline=i,this.emit(l.RoomEvent.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(null==e)return null;let t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){let t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(t){return t.getId()==e})}addTimeline(){if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");let e=new s.EventTimeline(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,i){if(!r)throw Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this.liveTimeline)throw Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;let o=t?s.EventTimeline.BACKWARDS:s.EventTimeline.FORWARDS,l=t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS,c=!1,d=!1;for(let i of e){let e=i.getId(),u=this._eventIdToTimeline.get(e);if(!u){this.addEventToTimeline(i,r,{toStartOfTimeline:t}),d=!0,c=!0;continue}if(d=!1,u==r){n("Event "+e+" already in timeline "+r);continue}let h=r.getNeighbouringTimeline(o);if(h){u==h?n("Event "+e+" in neighbouring timeline - switching to "+u):n("Event "+e+" already in a different timeline "+u),r=u;continue}a.logger.info("Already have timeline for "+e+" - joining timeline "+r+" to "+u);let p=u===this.liveTimeline,f=r===this.liveTimeline,g=o===s.EventTimeline.BACKWARDS&&p,m=o===s.EventTimeline.FORWARDS&&f;if(g||m){g&&a.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+u+")"),m&&a.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")");continue}r.setNeighbouringTimeline(u,o),u.setNeighbouringTimeline(r,l),r=u,c=!0}if(d||!c){if(o===s.EventTimeline.FORWARDS&&r===this.liveTimeline){a.logger.warn({lastEventWasNew:d,didUpdate:c}),a.logger.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(i));return}r.setPaginationToken(null!=i?i:null,o)}}addLiveEvent(e,t){let r,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3?arguments[3]:void 0,l=t||u.Ignore;if("object"==typeof t?{duplicateStrategy:l=u.Ignore,fromCache:i=!1,roomState:o,timelineWasEmpty:r}=t:void 0!==t&&a.logger.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter&&!this.filter.filterRoomTimeline([e]).length)return;let c=this._eventIdToTimeline.get(e.getId());if(c){if(l===u.Replace){n("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());let t=c.getEvents();for(let r=0;r<t.length;r++)if(t[r].getId()===e.getId()){o||(o=c.getState(s.EventTimeline.FORWARDS)),s.EventTimeline.setEventMetadata(e,o,!1),t[r]=e;break}}else n("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:o,timelineWasEmpty:r})}addEventToTimeline(e,t,r){var n,i;let o,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4?arguments[4]:void 0,d=!!r;if("object"==typeof r?{toStartOfTimeline:d,fromCache:s=!1,roomState:c,timelineWasEmpty:o}=r:void 0!==r&&a.logger.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this)throw Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(n=this.thread)||void 0===n?void 0:n.id,")"));let u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let r="event=".concat(u);e.threadRootId&&(r+="(belongs to thread=".concat(e.threadRootId,")")),a.logger.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(r," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(i=this.thread)||void 0===i?void 0:i.id,")"));return}t.addEvent(e,{toStartOfTimeline:d,roomState:c,timelineWasEmpty:o}),this._eventIdToTimeline.set(u,t);let h={timeline:t,liveEvent:!d&&t==this.liveTimeline&&!s};this.emit(l.RoomEvent.Timeline,e,this.room,!!d,!1,h)}insertEventIntoTimeline(e,t,r){var n,i;if(t.getTimelineSet()!==this)throw Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(n=this.thread)||void 0===n?void 0:n.id,")"));let o=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let r="event=".concat(o);e.threadRootId&&(r+="(belongs to thread=".concat(e.threadRootId,")")),a.logger.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(r," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(i=this.thread)||void 0===i?void 0:i.id,")"));return}let s=e.relationEventId;if(!s){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r});return}let c=this.findEventById(s),d=t.getEvents(),u=void 0!==c?d.indexOf(c):0;for(;u<d.length&&!(d[u].getTs()>e.getTs());u++);t.insertEvent(e,u,r),this._eventIdToTimeline.set(o,t);let h={timeline:t,liveEvent:!1};this.emit(l.RoomEvent.Timeline,e,this.room,!1,!1,h)}handleRemoteEcho(e,t,r){let n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){let t=this._eventIdToTimeline.get(e);if(!t)return null;let r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);let n={timeline:t};this.emit(l.RoomEvent.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;let r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(void 0===r||void 0===n)return null;if(r===n){let n,i;let o=r.getEvents();for(let r=0;r<o.length&&(void 0===n||void 0===i);r++){let s=o[r].getId();s==e&&(n=r),s==t&&(i=r)}let s=n-i;return s<0?-1:s>0?1:0}let i=r;for(;i;){if(i===n)return -1;i=i.getNeighbouringTimeline(s.EventTimeline.FORWARDS)}for(i=r;i;){if(i===n)return 1;i=i.getNeighbouringTimeline(s.EventTimeline.BACKWARDS)}return null}canContain(e){if(!this.room)throw Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");let{threadId:t,shouldLiveInRoom:r,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!r&&!n){var i;a.logger.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat(null===(i=this.room)||void 0===i?void 0:i.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return r}constructor(e,t={},r,n,i=null){var a,l,c;super(),(0,o.default)(this,"_eventIdToTimeline",new Map),this.room=e,this.thread=n,this.threadListType=i,this.timelineSupport=!!t.timelineSupport,this.liveTimeline=new s.EventTimeline(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=t.filter,this.relations=null!==(a=null===(l=this.room)||void 0===l?void 0:l.relations)&&void 0!==a?a:new d.RelationsContainer(null!==(c=null==e?void 0:e.client)&&void 0!==c?c:r)}}t.EventTimelineSet=h},91776:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimeline=t.Direction=void 0;var i=n(r(13102)),o=r(34002),s=r(19389),a=r(15748);let l=t.Direction=function(e){return e.Backward="b",e.Forward="f",e}({});class c{static setEventMetadata(e,t,r){var n,i;null!==(n=e.sender)&&void 0!==n&&null!==(n=n.events)&&void 0!==n&&n.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(i=e.target)&&void 0!==i&&null!==(i=i.events)&&void 0!==i&&i.member||e.getType()!==a.EventType.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)}initialiseState(e){var t,r;let{timelineWasEmpty:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.events.length>0)throw Error("Cannot initialise state after events are added");null===(t=this.startState)||void 0===t||t.setStateEvents(e,{timelineWasEmpty:n}),null===(r=this.endState)||void 0===r||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){let t=this.getState(e),r=new c(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=t,this.endState=null==t?void 0:t.clone(),r}fork(e){let t=this.getState(e),r=new c(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=null==t?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==c.BACKWARDS)return this.startState;if(e==c.FORWARDS)return this.endState;throw Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===l.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===l.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==c.BACKWARDS)return this.prevTimeline;if(e==c.FORWARDS)return this.nextTimeline;throw Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==c.BACKWARDS)this.prevTimeline=e;else if(t==c.FORWARDS)this.nextTimeline=e;else throw Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t,r){let n,i,s=!!t;"object"==typeof t?{toStartOfTimeline:s,roomState:r,timelineWasEmpty:n}=t:void 0!==t&&o.logger.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),r||(r=s?this.startState:this.endState);let l=this.getTimelineSet();if(l.room&&(c.setEventMetadata(e,r,s),e.isState()&&l.room.getUnfilteredTimelineSet()===l)){var d;null===(d=r)||void 0===d||d.setStateEvents([e],{timelineWasEmpty:n}),e.sender&&(e.getType()!==a.EventType.RoomMember||s)||c.setEventMetadata(e,r,s)}i=s?0:this.events.length,this.events.splice(i,0,e),s&&this.baseIndex++}insertEvent(e,t,r){let n=this.getTimelineSet();n.room&&(c.setEventMetadata(e,r,!1),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(r.setStateEvents([e],{}),e.sender&&e.getType()!==a.EventType.RoomMember||c.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){let r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}constructor(e){var t,r;(0,i.default)(this,"events",[]),(0,i.default)(this,"baseIndex",0),(0,i.default)(this,"startToken",null),(0,i.default)(this,"endToken",null),(0,i.default)(this,"prevTimeline",null),(0,i.default)(this,"nextTimeline",null),(0,i.default)(this,"paginationRequests",{[l.Backward]:null,[l.Forward]:null}),this.eventTimelineSet=e,this.roomId=null!==(t=null===(r=e.room)||void 0===r?void 0:r.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new s.RoomState(this.roomId),this.endState=new s.RoomState(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}}t.EventTimeline=c,(0,i.default)(c,"BACKWARDS",l.Backward),(0,i.default)(c,"FORWARDS",l.Forward)},39325:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"EventStatus",{enumerable:!0,get:function(){return g.EventStatus}}),t.MatrixEventEvent=t.MatrixEvent=void 0;var i=n(r(13102)),o=r(33653),s=r(34002),a=r(15748),l=r(44480),c=r(93655),d=r(92807),u=r(44441),h=r(22079),p=r(10845),f=r(91776),g=r(39883);let m=Object.freeze({visible:!0}),v=t.MatrixEventEvent=function(e){return e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e}({});class y extends u.TypedEventEmitter{get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=o.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){let e=Object.assign({},this.getContent());if(this.getWireType()===a.EventType.RoomMessageEncrypted)for(let[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0!==e[t]||(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){let e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat(null===(t=this.getDate())||void 0===t?void 0:t.toISOString())}{let e=this.getContent()[a.ToDeviceMessageId];return"msgid=".concat(e," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(this.isState())return;let t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===c.THREAD_RELATION_TYPE.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;let r=this.getUnsigned();if("string"==typeof r[a.UNSIGNED_THREAD_ID_FIELD.name])return r[a.UNSIGNED_THREAD_ID_FIELD.name]}get isThreadRoot(){return!this.isState()&&(!!this.getServerAggregatedRelation(c.THREAD_RELATION_TYPE.name)||this.threadRootId===this.getId())}get replyEventId(){var e;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(e=e["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e;return null===(e=this.getWireContent())||void 0===e||null===(e=e["m.relates_to"])||void 0===e?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){var e;return(null===(e=this.clearEvent)||void 0===e||null===(e=e.content)||void 0===e?void 0:e.msgtype)==="m.bad.encrypted"}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted())&&!this.clearEvent&&!!this.isEncrypted()}async attemptDecryption(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isEncrypted())throw Error("Attempt to decrypt event which isn't encrypted");let r=this.clearEvent&&!this.isDecryptionFailure(),n=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(r&&!n)throw Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(s.logger.log("Event ".concat(this.getId()," already being decrypted; queueing a retry")),this.retryDecryption=!0):this.decryptionPromise=this.decryptionLoop(e,t),this.decryptionPromise}cancelAndResendKeyRequest(e,t){let r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}async decryptionLoop(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(await Promise.resolve();;){let r,n;this.retryDecryption=!1;try{e?(r=await e.decryptEvent(this),!0===t.isRetry&&s.logger.info("Decrypted event on retry (".concat(this.getDetails(),")"))):r=this.badEncryptedMessage("Encryption not enabled")}catch(t){let e=t instanceof h.DecryptionError?t.detailedString:String(t);if(n=t,this.retryDecryption){s.logger.log("Error decrypting event (".concat(this.getDetails(),"), but retrying: ").concat(e));continue}s.logger.warn("Error decrypting event (".concat(this.getDetails(),"): ").concat(e)),r=this.badEncryptedMessage(String(t))}this.decryptionPromise=null,this.retryDecryption=!1,this.setClearData(r),this.setPushDetails(),!1!==t.emit&&this.emit(v.Decrypted,this,n);return}}badEncryptedMessage(e){return{clearEvent:{type:a.EventType.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}},encryptedDisabledForUnverifiedDevices:e==="DecryptionError: ".concat(p.WITHHELD_MESSAGES["m.unverified"])}}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(r=e.claimedEd25519Key)&&void 0!==r?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=e.encryptedDisabledForUnverifiedDevices||!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.EventType.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){let e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(v.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r;let n=null===(t=null==e?void 0:e.visible)||void 0===t||t,i=null!==(r=null==e?void 0:e.reason)&&void 0!==r?r:null,o=!1;this.visibility.visible!==n?o=!0:this.visibility.visible||this.visibility.reason===i||(o=!0),o&&(n?this.visibility=m:this.visibility=Object.freeze({visible:!1,reason:i}),this.emit(v.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw Error("invalid redactionEvent in makeRedacted");for(let t in this._localRedactionEvent=null,this.emit(v.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&!b.has(t)&&delete this.event[t];this.isEncrypted()&&(this.clearEvent=void 0);let r=this.getType() in S?S[this.getType()]:{},n=this.getContent();for(let e in n)n.hasOwnProperty(e)&&!r[e]&&delete n[e];t&&!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){let t=this.thread;if(this.moveToMainTimeline(e),t)for(let n of t.events){var r;(null===(r=n.getRelation())||void 0===r?void 0:r.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;null===(t=this.thread)||void 0===t||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);let r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(f.EventTimeline.FORWARDS))}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===a.EventType.RoomRedaction}asVisibilityChange(){if(!a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType()))return null;let e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;let t=e.event_id;if(!t)return null;let r=this.getWireContent(),n=!!r.visible,i=r.reason;return i&&"string"!=typeof i?null:{visible:n,reason:i,eventId:t}}isVisibilityEvent(){return a.EVENT_VISIBILITY_CHANGE_TYPE.matches(this.getType())}getRedactionEvent(){var e,t,r,n;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(r=null===(n=this.clearEvent)||void 0===n?void 0:n.unsigned.redacted_because)&&void 0!==r?r:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushActions(e){this.pushDetails={actions:e||void 0}}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){let t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit(v.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(v.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(v.LocalEventIdReplaced,this)}isRelation(e){var t;let r=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return!(this.isState()&&null!=r&&r.rel_type&&[a.RelationType.Replace,a.RelationType.Thread].includes(r.rel_type))&&!!(null!=r&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent===e||(this._replacingEvent=null!=e?e:null,this.emit(v.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){let e=this.getServerAggregatedRelation(a.RelationType.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){let e=this.getServerAggregatedRelation(a.RelationType.Replace);if(e){let t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var t;return null!==(t=this._replacingEvent.getDate())&&void 0!==t?t:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){let e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){let t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){let e=new y(JSON.parse(JSON.stringify(this.event)));for(let[t,r]of Object.entries(this))"event"!==t&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;let t=(0,l.deepSortedObjectEntries)(this.event),r=(0,l.deepSortedObjectEntries)(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){let e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){!this.isState()&&(this.thread&&this.reEmitter.stopReEmitting(this.thread,[c.ThreadEvent.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[c.ThreadEvent.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}constructor(e={}){var t;super(),(0,i.default)(this,"pushDetails",{}),(0,i.default)(this,"_replacingEvent",null),(0,i.default)(this,"_localRedactionEvent",null),(0,i.default)(this,"_isCancelled",!1),(0,i.default)(this,"visibility",m),(0,i.default)(this,"_hasCachedExtEv",!1),(0,i.default)(this,"_cachedExtEv",void 0),(0,i.default)(this,"senderCurve25519Key",null),(0,i.default)(this,"claimedEd25519Key",null),(0,i.default)(this,"forwardingCurve25519KeyChain",[]),(0,i.default)(this,"untrusted",null),(0,i.default)(this,"decryptionPromise",null),(0,i.default)(this,"retryDecryption",!1),(0,i.default)(this,"encryptedDisabledForUnverifiedDevices",!1),(0,i.default)(this,"sender",null),(0,i.default)(this,"target",null),(0,i.default)(this,"status",null),(0,i.default)(this,"error",null),(0,i.default)(this,"forwardLooking",!0),this.event=e,["state_key","type","sender","room_id","membership"].forEach(t=>{"string"==typeof e[t]&&(e[t]=(0,l.internaliseString)(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{var r;"string"==typeof(null===(r=e.content)||void 0===r?void 0:r[t])&&(e.content[t]=(0,l.internaliseString)(e.content[t]))}),["rel_type"].forEach(t=>{var r;"string"==typeof(null===(r=e.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r[t])&&(e.content["m.relates_to"][t]=(0,l.internaliseString)(e.content["m.relates_to"][t]))}),this.txnId=e.txn_id;let r=this.getAge();this.localTimestamp=void 0!==r?Date.now()-r:null!==(t=this.getTs())&&void 0!==t?t:Date.now(),this.reEmitter=new d.TypedReEmitter(this)}}t.MatrixEvent=y;let b=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),S={[a.EventType.RoomMember]:{membership:1},[a.EventType.RoomJoinRules]:{join_rule:1},[a.EventType.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},85300:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolicyScope=t.POLICIES_ACCOUNT_EVENT_TYPE=t.IgnoredInvites=t.IGNORE_INVITES_ACCOUNT_EVENT_KEY=void 0;var n=r(33653),i=r(91776),o=r(36673),s=r(44480);let a=t.POLICIES_ACCOUNT_EVENT_TYPE=new n.UnstableValue("m.policies","org.matrix.msc3847.policies"),l=t.IGNORE_INVITES_ACCOUNT_EVENT_KEY=new n.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");var c=function(e){return e.Ban="m.ban",e}(c||{});let d=t.PolicyScope=function(e){return e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server",e}({});class u{async addRule(e,t,r){let n=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(n.roomId,e,{entity:t,reason:r,recommendation:c.Ban})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);let t=(await this.getOrCreateSourceRooms()).map(e=>e.roomId);return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies(e=>{e.sources=t}),!0)}async getRuleForInvite(e){let{sender:t,roomId:r}=e,n=await this.getOrCreateSourceRooms(),o=t.split(":")[1],a=r.split(":")[1];for(let e of n){let n=e.getUnfilteredTimelineSet().getLiveTimeline().getState(i.EventTimeline.FORWARDS);for(let{scope:e,entities:i}of[{scope:d.Room,entities:[r]},{scope:d.User,entities:[t]},{scope:d.Server,entities:[o,a]}])for(let t of n.getStateEvents(e)){let e;let r=t.getContent();if((null==r?void 0:r.recommendation)!=c.Ban)continue;let n=null==r?void 0:r.entity;if(n){try{e=new RegExp((0,s.globToRegexp)(n))}catch(e){continue}for(let r of i)if(r&&e.test(r))return t}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){let t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:o.Preset.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies(t=>{t.target=e}),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let r=e.filter(e=>"string"==typeof e).map(e=>this.client.getRoom(e)).filter(e=>!!e);return r.length!=e.length&&(t=!0),0==r.length&&(t=!0,r=[await this.getOrCreateTargetRoom()]),t&&await this.withIgnoreInvitesPolicies(t=>{t.sources=e}),r}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){let{policies:t,ignoreInvitesPolicies:r}=this.getPoliciesAndIgnoreInvitesPolicies();e(r),t[l.name]=r,await this.client.setAccountData(a.name,t)}getPoliciesAndIgnoreInvitesPolicies(){let e={};for(let r of[a.name,a.altName]){var t;if(!r)continue;let n=null===(t=this.client.getAccountData(r))||void 0===t?void 0:t.getContent();if(n){e=n;break}}let r={},n=!1;for(let t of[l.name,l.altName]){if(!t)continue;let i=e[t];if(i&&"object"==typeof i){r=i,n=!0;break}}return n||(e[l.name]=r),{policies:e,ignoreInvitesPolicies:r}}constructor(e){this.client=e}}t.IgnoredInvites=u},32472:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.isPollEvent=t.PollEvent=t.Poll=void 0;var i=n(r(13102)),o=r(33653),s=r(11235),a=r(81528),l=r(44441);let c=t.PollEvent=function(e){return e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations",e}({}),d=(e,t)=>({responseEvents:e.filter(e=>{if(!e.isDecryptionFailure())return s.M_POLL_RESPONSE.matches(e.getType())&&e.getTs()<=t})});class u extends l.TypedEventEmitter{get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses||this.isFetchingResponses||await this.fetchResponses(),this.responses}onNewRelation(e){var t;if(s.M_POLL_END.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(c.End)),!this.responses)return;let{responseEvents:r}=d([e],(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER);this.countUndecryptableEvents([e]),r.length&&(r.forEach(e=>{this.responses.addEvent(e)}),this.emit(c.Responses,this.responses))}async fetchResponses(){var e,t;this._isFetchingResponses=!0;let r=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(r.events.map(e=>this.matrixClient.decryptEventIfNeeded(e)));let n=this.responses||new a.Relations("m.reference",s.M_POLL_RESPONSE.name,this.matrixClient,[s.M_POLL_RESPONSE.altName]),i=r.events.find(e=>s.M_POLL_END.matches(e.getType()));this.validateEndEvent(i)&&(this.endEvent=i,this.refilterResponsesOnEnd(),this.emit(c.End));let o=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=d(r.events,o);l.forEach(e=>{n.addEvent(e)}),this.relationsNextBatch=null!==(t=r.nextBatch)&&void 0!==t?t:void 0,this.responses=n,this.countUndecryptableEvents(r.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(c.Responses,this.responses)}refilterResponsesOnEnd(){var e;if(!this.responses)return;let t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(e=>{if(e.getTs()>t){var r;null===(r=this.responses)||void 0===r||r.removeEvent(e)}}),this.emit(c.Responses,this.responses)}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;let t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}constructor(e,t,r){if(super(),(0,i.default)(this,"_isFetchingResponses",!1),(0,i.default)(this,"responses",null),(0,i.default)(this,"undecryptableRelationEventIds",new Set),(0,i.default)(this,"countUndecryptableEvents",e=>{let t=e.filter(e=>e.isDecryptionFailure()).map(e=>e.getId()),r=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==r&&this.emit(c.UndecryptableRelations,this.undecryptableRelationsCount)}),this.rootEvent=e,this.matrixClient=t,this.room=r,!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}}t.Poll=u;let h=e=>{let t=e.getType();return o.M_POLL_START.matches(t)||s.M_POLL_RESPONSE.matches(t)||s.M_POLL_END.matches(t)};t.isPollEvent=h},56332:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ReadReceipt=void 0,t.synthesizeReceipt=g;var i=n(r(13102)),o=r(64157),s=r(44441),a=r(44480),l=r(39325),c=r(15748),d=r(29197),u=r(34002),h=r(32950);function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function g(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new l.MatrixEvent({content:{[t.getId()]:{[r]:{[e]:f({ts:t.getTs()},!n&&{thread_id:(0,h.threadIdForReceipt)(t)})}}},type:c.EventType.Receipt,room_id:t.getRoomId()})}let m=0,v=1;class y extends s.TypedEventEmitter{getReadReceiptForUserId(e){var t,r;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.ReceiptType.Read,[s,a]=null!==(t=null===(r=this.receipts.get(i))||void 0===r?void 0:r.get(e))&&void 0!==t?t:[null,null];return n?s:null!=a?a:s}compareReceipts(e,t){var r;return null!==(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))&&void 0!==r?r:e.data.ts-t.data.ts}getEventReadUpTo(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t;let r=this.findEventById(e.eventId);if(!r)return!1;if(!(null!==(t=e.data)&&void 0!==t&&t.thread_id))return!0;if(e.data.thread_id===o.MAIN_ROOM_TIMELINE){if((0,h.inMainTimelineForReceipt)(r))return!0}else if(r.threadRootId===e.data.thread_id)return!0;return u.logger.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n;let i;let s=this.getReadReceiptForUserId(e,t,o.ReceiptType.Read),a=this.getReadReceiptForUserId(e,t,o.ReceiptType.ReadPrivate);return(null!=s&&s.eventId&&null!=a&&a.eventId&&(i=this.compareReceipts(s,a)),i)?null!==(n=i<0?a:s)&&void 0!==n?n:null:null!==(r=null!=a?a:s)&&void 0!==r?r:null}addReceiptToStructure(e,t,r,n,i){var o,s,a;let l=this.receipts.getOrCreate(t),c=l.get(r);c||(c=[null,null],l.set(r,c));let d=c[m];i&&(d=null!==(a=c[v])&&void 0!==a?a:c[m]);let u={eventId:e,data:n};if(d&&this.compareReceipts(d,u)>=0)return;let h=i?c[m]:u,p=i?u:c[v],f=null;h&&p&&(f=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,p.eventId));let g=null===f||f<0,y=null!==(o=c[v])&&void 0!==o?o:c[m];if(i&&g?c[v]=u:i||(c[m]=u,g||(c[v]=null)),y!==(null!==(s=c[v])&&void 0!==s?s:c[m])){if(y&&this.receiptCacheByEventId.get(y.eventId)){let e=y.eventId;this.receiptCacheByEventId.set(e,this.receiptCacheByEventId.get(e).filter(e=>e.type!==t||e.userId!==r)),this.receiptCacheByEventId.get(e).length<1&&this.receiptCacheByEventId.delete(e)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){let t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(null==t?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(d.NotificationCountType.Total,0),this.setUnread(d.NotificationCountType.Highlight,0))}addLocalEchoReceipt(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.addReceipt(g(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(e){return(0,a.isSupportedReceiptType)(e.type)}).map(function(e){return e.userId})}constructor(...e){super(...e),(0,i.default)(this,"receipts",new a.MapWithDefault(()=>new Map)),(0,i.default)(this,"receiptCacheByEventId",new Map)}}t.ReadReceipt=y},36504:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsContainer=void 0;var i=n(r(13102)),o=r(81528),s=r(39325);class a{getChildEventsForEvent(e,t,r){var n;return null===(n=this.relations.get(e))||void 0===n||null===(n=n.get(t))||void 0===n?void 0:n.get(r)}getAllChildEventsForEvent(e){var t;let r=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,n=[];for(let e of r.values())for(let t of e.values())n.push(...t.getRelations());return n}aggregateParentEvent(e){let t=this.relations.get(e.getId());if(t)for(let r of t.values())for(let t of r.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===s.EventStatus.CANCELLED)return;let r=e.getRelation();if(!r)return;let n=()=>{if(e.isDecryptionFailure()){e.once(s.MatrixEventEvent.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(s.MatrixEventEvent.Decrypted,n);return}let{event_id:i,rel_type:a}=r,l=e.getType(),c=this.relations.get(i);c||(c=new Map,this.relations.set(i,c));let d=c.get(a);d||(d=new Map,c.set(a,d));let u=d.get(l);if(!u){var h,p,f;u=new o.Relations(a,l,this.client),d.set(l,u);let e=null!==(h=this.room)&&void 0!==h?h:null==t?void 0:t.room,r=null!==(p=null!==(f=null==t?void 0:t.findEventById(i))&&void 0!==f?f:null==e?void 0:e.findEventById(i))&&void 0!==p?p:null==e?void 0:e.getPendingEvent(i);r&&u.setTargetEvent(r)}u.addEvent(e)}constructor(e,t){(0,i.default)(this,"relations",new Map),this.client=e,this.room=t}}t.RelationsContainer=a},81528:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsEvent=t.Relations=void 0;var i=n(r(13102)),o=r(39325),s=r(34002),a=r(15748),l=r(44441),c=r(29197);let d=t.RelationsEvent=function(e){return e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e}({}),u=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return[t,...r].includes(e)};class h extends l.TypedEventEmitter{async addEvent(e){if(this.relationEventIds.has(e.getId()))return;let t=e.getRelation();if(!t){s.logger.error("Event must have relation info");return}let r=t.rel_type,n=e.getType();if(this.relationType!==r||!u(n,this.eventType,this.altEventTypes)){s.logger.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(o.MatrixEventEvent.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===a.RelationType.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Add,e),this.maybeEmitCreated()}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(d.Remove,e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t;let{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!r)return;let n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{let r=e[1];return t[1].size-r.size});let i=e.getSender(),o=this.annotationsBySender[i];o||(o=this.annotationsBySender[i]=new Set),o.add(e)}removeAnnotationFromAggregation(e){var t;let{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!r)return;let n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{let r=e[1];return t[1].size-r.size}));let i=e.getSender(),o=this.annotationsBySender[i];o&&o.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==a.RelationType.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.RelationType.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==a.RelationType.Replace||!this.targetEvent)return null;let e=this.targetEvent.getServerAggregatedRelation(a.RelationType.Replace),t=null==e?void 0:e.origin_server_ts,r=this.getRelations().reduce((e,r)=>r.getSender()!==this.targetEvent.getSender()||t&&t>r.getTs()||e&&e.getTs()>r.getTs()?e:r,null);return null!=r&&r.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await r.attemptDecryption(this.client.crypto):null!=r&&r.isBeingDecrypted()&&await r.getDecryptionPromise(),r}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===a.RelationType.Replace&&!this.targetEvent.isState()){let e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){!this.creationEmitted&&this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.MatrixEventEvent.RelationsCreated,this.relationType,this.eventType))}constructor(e,t,r,n){super(),(0,i.default)(this,"relationEventIds",new Set),(0,i.default)(this,"relations",new Set),(0,i.default)(this,"annotationsByKey",{}),(0,i.default)(this,"annotationsBySender",{}),(0,i.default)(this,"sortedAnnotationsByKey",[]),(0,i.default)(this,"targetEvent",null),(0,i.default)(this,"creationEmitted",!1),(0,i.default)(this,"onEventStatus",(e,t)=>{if(!e.isSending()){e.removeListener(o.MatrixEventEvent.Status,this.onEventStatus);return}t===o.EventStatus.CANCELLED&&(e.removeListener(o.MatrixEventEvent.Status,this.onEventStatus),this.removeEvent(e))}),(0,i.default)(this,"onBeforeRedaction",async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===a.RelationType.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===a.RelationType.Replace&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(o.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.emit(d.Redaction,e)}}),this.relationType=e,this.eventType=t,this.altEventTypes=n,this.client=r instanceof c.Room?r.client:r}}t.Relations=h},74130:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomMemberEvent=t.RoomMember=void 0;var i=n(r(13102)),o=r(34479),s=r(44480),a=r(34002),l=r(44441),c=r(15748);let d=t.RoomMemberEvent=function(e){return e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing",e}({});class u extends l.TypedEventEmitter{markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n;let i=null!==(r=e.getDirectionalContent().displayname)&&void 0!==r?r:"";if(e.getType()!==c.EventType.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;let o=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.logger.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=f(this.userId,i,t);let l=this.name;this.name=g(this.userId,i,this.disambiguate),this.rawDisplayName=(0,s.removeDirectionOverrideChars)(null!==(n=e.getDirectionalContent().displayname)&&void 0!==n?n:""),this.rawDisplayName&&(0,s.removeHiddenChars)(this.rawDisplayName)||(this.rawDisplayName=this.userId),o!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,o)),l!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,l))}setPowerLevelEvent(e){if(e.getType()!==c.EventType.RoomPowerLevels||""!==e.getStateKey())return;let t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach(e=>{r=Math.max(r,e)});let i=this.powerLevel,o=this.powerLevelNorm;void 0!==n[this.userId]&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),(i!==this.powerLevel||o!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(d.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;let t=this.typing;this.typing=!1;let r=e.getContent().user_ids;Array.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return"leave"===this.membership&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){let e=this.events.member,t=e.getContent(),r=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){let i=!(arguments.length>4)||void 0===arguments[4]||arguments[4],s=arguments.length>5?arguments[5]:void 0,a=this.getMxcAvatarUrl();return(a||i)&&(0,o.getHttpUriForMxc)(e,a,t,r,n,s)||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}constructor(e,t){super(),(0,i.default)(this,"_isOutOfBand",!1),(0,i.default)(this,"modified",-1),(0,i.default)(this,"requestedProfileInfo",!1),(0,i.default)(this,"typing",!1),(0,i.default)(this,"powerLevel",0),(0,i.default)(this,"powerLevelNorm",0),(0,i.default)(this,"disambiguate",!1),(0,i.default)(this,"events",{}),this.roomId=e,this.userId=t,this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}}t.RoomMember=u;let h=/@.+:.+/,p=/[\u200E\u200F\u202A-\u202F]/;function f(e,t,r){return!!(t&&t!==e&&(0,s.removeHiddenChars)(t))&&!!r&&!!(h.test(t)||p.test(t)||r.getUserIdsWithDisplayName(t).some(t=>t!==e))}function g(e,t,r){return t&&t!==e?r?(0,s.removeDirectionOverrideChars)(t)+" ("+e+")":(0,s.removeHiddenChars)(t)?(0,s.removeDirectionOverrideChars)(t):e:e}},52879:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomReceipts=void 0;var i=n(r(13102)),o=r(64157),s=r(32950),a=r(29197),l=r(34002);class c{add(e,t){for(let[r,n]of Object.entries(e))for(let[e,i]of Object.entries(n))for(let[n,o]of Object.entries(i))this.room.findEventById(r)?o.thread_id?this.threadedReceipts.set(o.thread_id,r,e,n,o.ts,t):this.unthreadedReceipts.set(r,e,n,o.ts,t):this.danglingReceipts.add(new u(r,e,n,o,t))}hasUserReadEvent(e,t){let r=this.unthreadedReceipts.get(e);if(r&&v(r.eventId,t,this.room))return!0;let n=this.room.findEventById(t);if(!n)return l.logger.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;let i=(0,s.threadIdForReceipt)(n),o=this.threadedReceipts.get(i,e);return!!(o&&v(o.eventId,t,this.room)||this.userSentLatestEventInThread(i,e))}userSentLatestEventInThread(e,t){var r;let n=e===o.MAIN_ROOM_TIMELINE?this.room.getLiveTimeline().getEvents():null===(r=this.room.getThread(e))||void 0===r?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}constructor(e){(0,i.default)(this,"onTimelineEvent",e=>{let t=e.getId();if(!t)return;let r=this.danglingReceipts.remove(t);null==r||r.forEach(e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)})}),this.room=e,this.threadedReceipts=new f(e),this.unthreadedReceipts=new p(e),this.danglingReceipts=new g,e.on(a.RoomEvent.Timeline,this.onTimelineEvent)}}t.RoomReceipts=c;class d{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class u{constructor(e,t,r,n,i){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=i}}class h{set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&v(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!==(e=this.synthetic)&&void 0!==e?e:this.real}getByType(e){return e?this.synthetic:this.real}constructor(e){this.room=e,this.real=void 0,this.synthetic=void 0}}class p{set(e,t,r,n,i){let o=m(this.data,r,()=>new h(this.room)),s=o.getByType(i);s&&y(s.eventId,e,this.room)||o.set(i,new d(e,t,n))}get(e){var t;return null===(t=this.data.get(e))||void 0===t?void 0:t.get()}constructor(e){this.room=e,this.data=new Map}}class f{set(e,t,r,n,i,o){m(this.data,e,()=>new p(this.room)).set(t,r,n,i,o)}get(e,t){var r;return null===(r=this.data.get(e))||void 0===r?void 0:r.get(t)}constructor(e){this.room=e,this.data=new Map}}class g{add(e){m(this.data,e.eventId,()=>[]).push(e)}remove(e){let t=this.data.get(e);return this.data.delete(e),t}constructor(){(0,i.default)(this,"data",new Map)}}function m(e,t,r){let n=e.get(t);if(n)return n;{let n=r();return e.set(t,n),n}}function v(e,t,r){let n=r.compareEventOrdering(e,t);return null!==n&&n>=0}function y(e,t,r){let n=r.compareEventOrdering(e,t);return null!==n&&n>0}},19389:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomStateEvent=t.RoomState=void 0;var i=n(r(13102)),o=r(74130),s=r(34002),a=r(44480),l=r(15748),c=r(39325),d=r(36673),u=r(44441),h=r(12533),p=r(92807),f=r(42e3),g=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished",e}(g||{});let m=t.RoomStateEvent=function(e){return e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker",e}({});class v extends u.TypedEventEmitter{getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new o.RoomMember(this.roomId,e);let r=this.members[e];null!=r&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){return this.events.has(e)?void 0===t?Array.from(this.events.get(e).values()):this.events.get(e).get(t)||null:void 0===t?[]:null}get hasLiveBeacons(){var e;return!!(null!==(e=this.liveBeaconIds)&&void 0!==e&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){let e=new v(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=g.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==g.Finished&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){var r;null===(r=e.getMember(t.userId))||void 0===r||r.markOutOfBand()}}),e}setUnknownStateEvents(e){let t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()!==this.roomId||!e.isState())return;f.M_BEACON_INFO.matches(e.getType())&&this.setBeacon(e);let t=this.getStateEventMatching(e);if(this.setStateEvent(e),e.getType()===l.EventType.RoomMember){var r;this.updateDisplayNameCache(e.getStateKey(),null!==(r=e.getContent().displayname)&&void 0!==r?r:""),this.updateThirdPartyTokenCache(e)}this.emit(m.Events,e,this,t)}),this.onBeaconLivenessChange(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState()){if(e.getType()===l.EventType.RoomMember){let t=e.getStateKey();("leave"===e.getContent().membership||"ban"===e.getContent().membership)&&(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);let r=this.getOrCreateMember(t,e);r.setMembershipEvent(e,this),this.updateMember(r),this.emit(m.Members,e,this,r)}else if(e.getType()===l.EventType.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach(t=>{let r=t.getLastModifiedTime();t.setPowerLevelEvent(e),r!==t.getLastModifiedTime()&&this.emit(m.Members,e,this,t)}),this.sentinels={}}else l.UNSTABLE_MSC2716_MARKER.matches(e.getType())&&this.emit(m.Marker,e,t)}}),this.emit(m.Update,this)}async processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;let r=[...this.beacons.values()].reduce((e,t)=>(e[t.beaconInfoId]=t,e),{}),n=(e,t)=>{if(!f.M_BEACON.matches(t.getType()))return;let n=r[e];n&&n.addLocations([t])};for(let o of e){var i;let e=null===(i=o.getRelation())||void 0===i?void 0:i.event_id;if(!e||!r[e]||!f.M_BEACON.matches(o.getType())&&!o.isEncrypted())return;try{await t.decryptEventIfNeeded(o),n(e,o)}catch(t){o.isDecryptionFailure()&&o.once(c.MatrixEventEvent.Decrypted,async()=>{n(e,o)})}}}getOrCreateMember(e,t){let r=this.members[e];return r||(r=new o.RoomMember(this.roomId,e),this.members[e]=r,this.emit(m.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){let t=(0,h.getBeaconInfoIdentifier)(e);if(this.beacons.has(t)){let n=this.beacons.get(t);if(e.isRedacted()){var r;n.beaconInfoId===(null===(r=e.getRedactionEvent())||void 0===r?void 0:r.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(e.isRedacted())return;let n=new h.Beacon(e);this.reEmitter.reEmit(n,[h.BeaconEvent.New,h.BeaconEvent.Update,h.BeaconEvent.Destroy,h.BeaconEvent.LivenessChange]),this.emit(h.BeaconEvent.New,e,n),n.on(h.BeaconEvent.LivenessChange,this.onBeaconLivenessChange.bind(this)),n.on(h.BeaconEvent.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(n.identifier,n)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(m.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return null!==(t=null===(r=this.events.get(e.getType()))||void 0===r?void 0:r.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){let t=this.getStateEvents(l.EventType.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===g.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===g.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===g.NotStarted&&(this.oobMemberFlags.status=g.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===g.InProgress&&(this.oobMemberFlags.status=g.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),s.logger.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=g.NotStarted}setOutOfBandMembers(e){s.logger.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===g.InProgress&&(s.logger.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=g.Finished,e.forEach(e=>this.setOutOfBandMember(e)),this.emit(m.Update,this))}setOutOfBandMember(e){if(e.getType()!==l.EventType.RoomMember)return;let t=e.getStateKey(),r=this.getMember(t);if(r&&!r.isOutOfBand())return;let n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(m.Members,e,this,n)}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get((0,a.removeHiddenChars)(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){let r=this.getMember(t);return!(!r||"leave"===r.membership||e.status||e.isRedacted())&&!!this.maySendEvent(l.EventType.RoomRedaction,t)&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",r.powerLevel))}hasSufficientPowerLevelFor(e,t){let r=this.getStateEvents(l.EventType.RoomPowerLevels,""),n={};r&&(n=r.getContent());let i=50;return(0,a.isNumber)(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(l.EventType.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&!!t.credentials.userId&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){let n;let i=this.getStateEvents(l.EventType.RoomPowerLevels,""),o={},s=0,a=0,c=0;if(i){o=(n=i.getContent()).events||{},s=Number.isSafeInteger(n.state_default)?n.state_default:50;let e=n.users&&n.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(n.users_default)&&(c=n.users_default),Number.isSafeInteger(n.events_default)&&(a=n.events_default)}let d=r?s:a;return Number.isSafeInteger(o[e])&&(d=o[e]),c>=d}mayTriggerNotifOfType(e,t){let r=this.getMember(t);if(!r)return!1;let n=this.getStateEvents(l.EventType.RoomPowerLevels,""),i=50;return n&&n.getContent()&&n.getContent().notifications&&(0,a.isNumber)(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i}getJoinRule(){var e;let t=this.getStateEvents(l.EventType.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||d.JoinRule.Invite}getHistoryVisibility(){var e;let t=this.getStateEvents(l.EventType.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||d.HistoryVisibility.Shared}getGuestAccess(){var e;let t=this.getStateEvents(l.EventType.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||d.GuestAccess.Forbidden}findPredecessor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e){let e=this.getStateEvents(l.EventType.RoomPredecessor,"");if(e){let t=e.getContent(),r=t.predecessor_room_id,n=t.last_known_event_id;"string"!=typeof n&&(n=void 0);let i=t.via_servers;if(Array.isArray(i)||(i=void 0),"string"==typeof r)return{roomId:r,eventId:n,viaServers:i}}}let t=this.getStateEvents(l.EventType.RoomCreate,"");if(t){let e=t.getContent().predecessor;if(e){let t=e.room_id;if("string"==typeof t){let r=e.event_id;return("string"!=typeof r||""===r)&&(r=void 0),{roomId:t,eventId:r}}}}return null}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;let t=(e.getContent().third_party_invite.signed||{}).token;t&&this.getStateEvents(l.EventType.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){let r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){let t=(0,a.removeHiddenChars)(r),n=this.displayNameToUserIds.get(t);if(n){let r=n.filter(t=>t!==e);this.displayNameToUserIds.set(t,r)}}this.userIdsToDisplayNames[e]=t;let n=t&&(0,a.removeHiddenChars)(t);if(n){var i;let t=null!==(i=this.displayNameToUserIds.get(n))&&void 0!==i?i:[];t.push(e),this.displayNameToUserIds.set(n,t)}}constructor(e,t={status:g.NotStarted}){super(),(0,i.default)(this,"reEmitter",new p.TypedReEmitter(this)),(0,i.default)(this,"sentinels",{}),(0,i.default)(this,"displayNameToUserIds",new Map),(0,i.default)(this,"userIdsToDisplayNames",{}),(0,i.default)(this,"tokenToInvite",{}),(0,i.default)(this,"joinedMemberCount",null),(0,i.default)(this,"summaryJoinedMemberCount",null),(0,i.default)(this,"invitedMemberCount",null),(0,i.default)(this,"summaryInvitedMemberCount",null),(0,i.default)(this,"modified",-1),(0,i.default)(this,"members",{}),(0,i.default)(this,"events",new Map),(0,i.default)(this,"paginationToken",null),(0,i.default)(this,"beacons",new Map),(0,i.default)(this,"_liveBeaconIds",[]),this.roomId=e,this.oobMemberFlags=t,this.updateModifiedTime()}}t.RoomState=v},71162:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSummary=void 0;class r{constructor(e,t){this.roomId=e}}t.RoomSummary=r},29197:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomNameType=t.RoomEvent=t.Room=t.NotificationCountType=t.KNOWN_SAFE_ROOM_VERSION=void 0;var i=n(r(13102)),o=r(33653),s=r(10907),a=r(91776),l=r(34479),c=r(44480),d=r(39325),u=r(39883),h=r(74130),p=r(71162),f=r(34002),g=r(92807),m=r(15748),v=r(32950),y=r(51601),b=r(19389),S=r(12533),E=r(93655),_=r(64157),w=r(36504),T=r(56332),I=r(32472),O=r(52879),R=r(72071);function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let M=t.KNOWN_SAFE_ROOM_VERSION="10",P=["1","2","3","4","5","6","7","8","9","10"],A=30,D=t.NotificationCountType=function(e){return e.Highlight="highlight",e.Total="total",e}({}),x=t.RoomEvent=function(e){return e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications",e.Summary="Room.Summary",e}({});class j extends T.ReadReceipt{async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(E.ThreadFilterType.My)]);let e=await this.threadTimelineSetsPromise;return this.threadsTimelineSets[0]=e[0],this.threadsTimelineSets[1]=e[1],e}catch(e){this.threadTimelineSetsPromise=null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;let e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),r=t.findIndex(t=>t.event.event_id===e),n=t.slice(r).reverse().map(e=>this.client.decryptEventIfNeeded(e));await Promise.allSettled(n)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;let e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(e=>this.client.decryptEventIfNeeded(e));await Promise.allSettled(e)}getCreator(){var e;let t=this.currentState.getStateEvents(m.EventType.RoomCreate,"");return null!==(e=null==t?void 0:t.getSender())&&void 0!==e?e:null}getVersion(){var e;let t=this.currentState.getStateEvents(m.EventType.RoomCreate,"");return t?null!==(e=t.getContent().room_version)&&void 0!==e?e:"1":(this.getVersionWarning||(f.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}shouldUpgradeToVersion(){return P.includes(this.getVersion())?null:M}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e)for(let t of(e={default:M,available:{}},P))e.available[t]=v.RoomVersionStability.Stable;let t=this.checkVersionAgainstCapability(e);return t.urgent&&t.needsUpgrade&&(f.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),(e=(await this.client.getCapabilities(!0))["m.room_versions"])?t=this.checkVersionAgainstCapability(e):f.logger.warn("No room version capability - assuming upgrade required.")),t}checkVersionAgainstCapability(e){let t=this.getVersion();f.logger.log("[".concat(this.roomId,"] Current version: ").concat(t)),f.logger.log("[".concat(this.roomId,"] Version capability: "),e);let r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?f.logger.warn("URGENT upgrade required on ".concat(this.roomId)):f.logger.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(m.EventType.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);let t=(0,c.removeElement)(this.pendingEventList,function(t){return t.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.some(t=>t.getId()===e))&&void 0!==t&&t}getPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.find(t=>t.getId()===e))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){let e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t;let r=this.getLiveTimeline().getEvents(),n=r[r.length-1],i=this.getLastThread();if(!i)return n;let o=i.events[i.events.length-1];return(null!==(e=null==n?void 0:n.getTs())&&void 0!==e?e:0)>(null!==(t=null==o?void 0:o.getTs())&&void 0!==t?t:0)?n:o}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;let i=t.events[t.events.length-1],o=e.events[e.events.length-1];return(null!==(r=null==i?void 0:i.getTs())&&void 0!==r?r:0)>=(null!==(n=null==o?void 0:o.getTs())&&void 0!==n?n:0)?t:e},void 0)}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:"leave"}getDMInviter(){let e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if("invite"===this.selfMembership&&2===this.getInvitedAndJoinedMemberCount()){var t;return null===(t=this.summaryHeroes)||void 0===t?void 0:t[0]}}guessDMUserId(){let e=this.getMember(this.myUserId);if(e){let t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];let t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;let e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){let e=this.summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}let t=this.currentState.getMembers();if(t.length<=2){let e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){let e=this.summaryHeroes.map(e=>this.client.getUser(e)).find(e=>!!e);if(e){let t=new h.RoomMember(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){let t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit(x.MyMembership,this,e,t))}async loadMembersFromServer(){let e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,"leave",null!=e?e:void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);return(null===t||this.hasEncryptionStateEvent())&&(e=!0,t=await this.loadMembersFromServer(),f.logger.log("LL: got ".concat(t.length," ")+"members from server for room ".concat(this.roomId))),{memberEvents:t.filter(c.noUnsafeEventProps).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();let e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer)).catch(e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){let e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event});return f.logger.log("LL: telling store to write ".concat(e.length)+" members for room ".concat(this.roomId)),this.client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{f.logger.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{f.logger.error(e)}),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{f.logger.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),f.logger.log(e)})}async refreshLiveTimeline(){let e;let t=this.getLiveTimeline(),r=t.getPaginationToken(a.EventTimeline.FORWARDS),n=t.getPaginationToken(a.EventTimeline.BACKWARDS),i=t.getEvents(),o=i[i.length-1];f.logger.log("[refreshLiveTimeline for ".concat(this.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));let s=this.getUnfilteredTimelineSet();o?(this.resetLiveTimeline(null,null),this.emit(x.TimelineRefresh,this,s),e=await this.client.getEventTimeline(s,o.getId())):e=await this.client.getLatestTimeline(s);let l=s.getLiveTimeline();l&&(null!==l.getPaginationToken(a.Direction.Forward)||null!==l.getPaginationToken(a.Direction.Backward)||0!==l.getEvents().length)?f.logger.log("[refreshLiveTimeline for ".concat(this.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."):(f.logger.log("[refreshLiveTimeline for ".concat(this.roomId,"] using our new live timeline")),e.setPaginationToken(r,a.EventTimeline.FORWARDS),s.setLiveTimeline(e),this.fixUpLegacyTimelineFields()),this.setTimelineNeedsRefresh(!1),this.emit(x.TimelineRefresh,this,s)}resetLiveTimeline(e,t){for(let r of this.timelineSets)r.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(let r of this.threads.values())r.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){let e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(a.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(a.EventTimeline.FORWARDS),e!==this.oldState&&this.emit(x.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(x.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[b.RoomStateEvent.Events,b.RoomStateEvent.Members,b.RoomStateEvent.NewMember,b.RoomStateEvent.Update,b.RoomStateEvent.Marker,S.BeaconEvent.New,S.BeaconEvent.Update,S.BeaconEvent.Destroy,S.BeaconEvent.LivenessChange]),this.reEmitter.reEmit(this.currentState,[b.RoomStateEvent.Events,b.RoomStateEvent.Members,b.RoomStateEvent.NewMember,b.RoomStateEvent.Update,b.RoomStateEvent.Marker,S.BeaconEvent.New,S.BeaconEvent.Update,S.BeaconEvent.Destroy,S.BeaconEvent.LivenessChange]))}async hasUnverifiedDevices(){if(!this.hasEncryptionStateEvent())return!1;for(let e of(await this.getEncryptionTargetMembers()))if(this.client.getStoredDevicesForUser(e.userId).some(e=>e.isUnverified()))return!0;return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){let t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){let r=this.getThreads();for(let n=0;n<r.length&&!(t=r[n].findEventById(e));n++);}return t}getUnreadNotificationCount(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D.Total,t=this.getRoomUnreadNotificationCount(e);for(let n of this.threadNotifications.values()){var r;t+=null!==(r=n[e])&&void 0!==r?r:0}return t}getUnreadCountForEventContext(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D.Total,r=arguments.length>1?arguments[1]:void 0;return null!==(e=r.threadRootId&&!r.isThreadRoot?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))&&void 0!==e?e:0}getRoomUnreadNotificationCount(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D.Total;return null!==(e=this.notificationCounts[t])&&void 0!==e?e:0}getThreadUnreadNotificationCount(e){var t,r;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D.Total;return null!==(t=null===(r=this.threadNotifications.get(e))||void 0===r?void 0:r[n])&&void 0!==t?t:0}hasThreadUnreadNotification(){for(let r of this.threadNotifications.values()){var e,t;if((null!==(e=r.highlight)&&void 0!==e?e:0)>0||(null!==(t=r.total)&&void 0!==t?t:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,i;let o=k({highlight:null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n.highlight,total:null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i.total},{[t]:r});this.threadNotifications.set(e,o),this.emit(x.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){let e=null;for(let n of this.threadNotifications.values()){var t,r;if((null!==(t=n.highlight)&&void 0!==t?t:0)>0)return D.Highlight;(null!==(r=n.total)&&void 0!==r?r:0)>0&&!e&&(e=D.Total)}return e}resetThreadUnreadNotificationCount(e){if(e)for(let[t]of this.threadNotifications)e.includes(t)||this.threadNotifications.delete(t);else this.threadNotifications.clear();this.emit(x.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(x.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){let t=e["m.heroes"],r=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(e=>e!==this.myUserId)),this.emit(x.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){let i=!(arguments.length>4)||void 0===arguments[4]||arguments[4],o=this.currentState.getStateEvents(m.EventType.RoomAvatar,"");if(!o&&!i)return null;let s=o?o.getContent().url:null;return s?(0,l.getHttpUriForMxc)(e,s,t,r,n):null}getMxcAvatarUrl(){var e;return(null===(e=this.currentState.getStateEvents(m.EventType.RoomAvatar,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.url)||null}getCanonicalAlias(){let e=this.currentState.getStateEvents(m.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){let e=this.currentState.getStateEvents(m.EventType.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;let t=this.currentState.getStateEvents(m.EventType.RoomHistoryVisibility,"");return(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){let r=this.getMember(e);return!!r&&r.membership===t}getOrCreateFilteredTimelineSet(e){let{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];let i=Object.assign({filter:e,pendingEvents:n},this.opts),o=new s.EventTimelineSet(this,i);this.reEmitter.reEmit(o,[x.Timeline,x.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));let l=this.getLiveTimeline();if(t){l.getEvents().forEach(function(e){o.addLiveEvent(e)});let e=l;for(;e.getNeighbouringTimeline(a.EventTimeline.BACKWARDS);)e=e.getNeighbouringTimeline(a.EventTimeline.BACKWARDS);o.getLiveTimeline().setPaginationToken(e.getPaginationToken(a.EventTimeline.BACKWARDS),a.EventTimeline.BACKWARDS)}else if(r){let e=l.getPaginationToken(a.Direction.Forward);o.getLiveTimeline().setPaginationToken(e,a.Direction.Backward)}return o}async getThreadListFilter(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:E.ThreadFilterType.All,t=this.client.getUserId(),r=new y.Filter(t),n={room:{timeline:{[E.FILTER_RELATED_BY_REL_TYPES.name]:[E.THREAD_RELATION_TYPE.name]}}};e===E.ThreadFilterType.My&&(n.room.timeline[E.FILTER_RELATED_BY_SENDERS.name]=[t]),r.setDefinition(n);let i=await this.client.getOrCreateFilter("THREAD_PANEL_".concat(this.roomId,"_").concat(e),r);return r.filterId=i,r}async createThreadTimelineSet(e){let t;if(E.Thread.hasServerSideListSupport)t=new s.EventTimelineSet(this,k(k({},this.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:E.ThreadFilterType.All),this.reEmitter.reEmit(t,[x.Timeline,x.TimelineReset]);else if(E.Thread.hasServerSideSupport){let r=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(r,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new s.EventTimelineSet(this,{pendingEvents:!1}),Array.from(this.threads).forEach(r=>{let[,n]=r;if(0===n.length)return;let i=n.timeline.some(e=>e.getSender()===this.client.getUserId());(e!==E.ThreadFilterType.My||i)&&t.getLiveTimeline().addEvent(n.rootEvent,{toStartOfTimeline:!1})});return t}processThreadRoots(e,t){if(this.client.supportsThreads())for(let r of e)a.EventTimeline.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}async fetchRoomThreads(){if(!this.threadsReady&&this.client.supportsThreads()){if(E.Thread.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(E.ThreadFilterType.All),this.fetchRoomThreadList(E.ThreadFilterType.My)]);else{let r;let n=await this.getThreadListFilter(),{chunk:i}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,a.Direction.Backward,n);if(!i.length)return;let o=i.map(this.client.getEventMapper()).sort((e,t)=>{let r=e.getServerAggregatedRelation(E.THREAD_RELATION_TYPE.name),n=t.getServerAggregatedRelation(E.THREAD_RELATION_TYPE.name);return r.latest_event.origin_server_ts-n.latest_event.origin_server_ts}),l=this.getLiveTimeline().getState(a.EventTimeline.FORWARDS);for(let n of o){var e,t;let i={duplicateStrategy:s.DuplicateStrategy.Ignore,fromCache:!1,roomState:l};null===(e=this.threadsTimelineSets[0])||void 0===e||e.addLiveEvent(n,i);let o=n.getServerAggregatedRelation(E.THREAD_RELATION_TYPE.name);null!=o&&o.current_user_participated&&(null===(t=this.threadsTimelineSets[1])||void 0===t||t.addLiveEvent(n,i),r=n)}this.processThreadRoots(o,!0),this.client.decryptEventIfNeeded(o[o.length-1]),r&&this.client.decryptEventIfNeeded(r)}this.on(E.ThreadEvent.NewReply,this.onThreadReply),this.on(E.ThreadEvent.Update,this.onThreadUpdate),this.on(E.ThreadEvent.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(e){for(let t of e)try{if(!t.isEncrypted()&&!(0,I.isPollEvent)(t))continue;await this.client.decryptEventIfNeeded(t),this.processPollEvent(t)}catch(e){f.logger.warn("Error processing poll event",t.getId(),e)}}async processPollEvent(e){if(e.isDecryptionFailure()){e.once(d.MatrixEventEvent.Decrypted,e=>{this.processPollEvent(e)});return}if(o.M_POLL_START.matches(e.getType())){try{let t=new I.Poll(e,this.client,this);this.polls.set(e.getId(),t),this.emit(I.PollEvent.New,t),e.once(d.MatrixEventEvent.BeforeRedaction,e=>{this.polls.delete(e.getId())})}catch(e){}return}let t=e.relationEventId;if(t&&this.polls.has(t)){let r=this.polls.get(t);null==r||r.onNewRelation(e)}}async fetchRoomThreadList(e){if(!this.client.supportsThreads()||0===this.threadsTimelineSets.length)return;let t=e===E.ThreadFilterType.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:r,end:n}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,a.Direction.Backward,t.threadListType,t.getFilter());if(t.getLiveTimeline().setPaginationToken(null!=n?n:null,a.Direction.Backward),!r.length)return;let i=r.map(this.client.getEventMapper());this.processThreadRoots(i,!0);let o=this.getLiveTimeline().getState(a.EventTimeline.FORWARDS);for(let e of i)t.addLiveEvent(e,{duplicateStrategy:s.DuplicateStrategy.Replace,fromCache:!1,roomState:o})}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);let r=this.getTimelineForEvent(e.id),n=null==r||null===(t=r.getEvents())||void 0===t?void 0:t.find(t=>t.getId()===e.id);for(let t of(n?e.clearEventMetadata(n):f.logger.debug("onThreadDelete: Could not find root event in room timeline"),this.threadsTimelineSets))t.removeEvent(e.id)}removeFilteredTimelineSet(e){let t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];let r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n,i;let o;if(!(null!==(n=this.client)&&void 0!==n&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=r&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};let s=e.isRelation(E.THREAD_RELATION_TYPE.name),a=e.getAssociatedId(),l=e.threadRootId;return a&&!s&&(l===a||null!=r&&r.has(a))?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:(a&&(o=null!==(i=this.findEventById(a))&&void 0!==i?i:null==t?void 0:t.find(e=>e.getId()===a)),o&&!s)?this.eventShouldLiveIn(o,t,r):void 0!=l?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:l}:!a||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;let{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getThread(e);if(n)n.addEvents(t,r);else{var i;let n=null!==(i=this.findEventById(e))&&void 0!==i?i:t.find(t=>t.getId()===e);this.createThread(e,n,t,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);let r={};for(let t of e){var n;let{threadId:e,shouldLiveInThread:i}=this.eventShouldLiveIn(t);i&&!r[e]&&(r[e]=[]),null===(n=r[e])||void 0===n||n.push(t)}Object.entries(r).map(e=>{let[r,n]=e;return this.addThreadedEvents(r,n,t)})}createThread(e,t){var r,n,i;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){let e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(o=o.concat(e.filter(e=>!e.isRelation(m.RelationType.Replace))))}let a=new E.Thread(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(r=this.cachedThreadReadReceipts.get(e))&&void 0!==r?r:[]});this.cachedThreadReadReceipts.delete(e),this.threads.set(a.id,a),a.addEvents(o,!1),this.reEmitter.reEmit(a,[E.ThreadEvent.Delete,E.ThreadEvent.Update,E.ThreadEvent.NewReply,x.Timeline,x.TimelineReset]);let l=(null===(n=this.lastThread)||void 0===n?void 0:n.rootEvent)&&(null==t?void 0:t.localTimestamp)&&(null===(i=this.lastThread.rootEvent)||void 0===i?void 0:i.localTimestamp)<(null==t?void 0:t.localTimestamp);return(!this.lastThread||l)&&(this.lastThread=a),this.threadsReady&&a.initialEventsFetched&&this.updateThreadRootEvents(a,s,!1),this.emit(E.ThreadEvent.New,a,s),a}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId){for(let[t,r]of this.txnToEvent)if(r.getId()===e.getId()){f.logger.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());let r=e.getUnsigned();r.transaction_id=t,e.setUnsigned(r);break}}}addLiveEvent(e,t){let{duplicateStrategy:r,timelineWasEmpty:n,fromCache:i}=t;for(let t of this.timelineSets)t.addLiveEvent(e,{duplicateStrategy:r,fromCache:i,timelineWasEmpty:n});e.sender&&e.getType()!==m.EventType.RoomRedaction&&this.addReceipt((0,T.synthesizeReceipt)(e.sender.userId,e,_.ReceiptType.Read),!0)}addPendingEvent(e,t){if(e.status!==u.EventStatus.SENDING&&e.status!==u.EventStatus.NOT_SENT)throw Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw Error("addPendingEvent called on an event with known txnId "+t);if(a.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(a.EventTimeline.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(e=>e.status===u.EventStatus.NOT_SENT)&&(f.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.EventStatus.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){let t=e.event.redacts,r=this.pendingEventList.find(e=>e.getId()===t);!r&&t&&(r=this.findEventById(t)),r&&(r.markLocallyRedacted(e),this.emit(x.Redaction,e,this,r.threadRootId))}}else for(let t of this.timelineSets)t.getFilter()?t.getFilter().filterRoomTimeline([e]).length&&t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1}):t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(x.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){let e=this.pendingEventList.map(e=>k(k({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{let t=e.type===m.EventType.RoomMessageEncrypted,r=this.hasEncryptionStateEvent();return t||!r});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){let r=t.getId(),n=e.getId(),i=t.status;f.logger.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(i)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);let{shouldLiveInRoom:o,threadId:s}=this.eventShouldLiveIn(e),a=s?this.getThread(s):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,r,n),o)for(let e of this.timelineSets)e.handleRemoteEcho(t,r,n);this.emit(x.LocalEchoUpdated,t,this,r,i)}updatePendingEvent(e,t,r){if(f.logger.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==u.EventStatus.SENT&&!r)throw Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.EventStatus.SENT&&this.getTimelineForEvent(r)){let t=this.findEventById(r);if(!(null==t?void 0:t.getUnsigned().transaction_id)&&t){let r=t.getUnsigned();r.transaction_id=e.getTxnId(),t.setUnsigned(r),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}let n=e.status,i=e.getId();if(!n)throw Error("updatePendingEventStatus called on an event which is not a local echo.");let o=U[n];if(!(null!=o&&o.includes(t)))throw Error("Invalid EventStatus transition ".concat(n,"->").concat(t));if(e.setStatus(t),t==u.EventStatus.SENT){e.replaceLocalEventId(r);let{shouldLiveInRoom:t,threadId:n}=this.eventShouldLiveIn(e),o=n?this.getThread(n):void 0;if(null==o||o.setEventMetadata(e),null==o||o.timelineSet.replaceEventId(i,r),t)for(let e of this.timelineSets)e.replaceEventId(i,r)}else if(t==u.EventStatus.CANCELLED){if(this.pendingEventList){let e=this.getPendingEvent(i);this.removePendingEvent(i),null!=e&&e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(i)}this.savePendingEvents(),this.emit(x.LocalEchoUpdated,e,this,i,n)}revertRedactionLocalEcho(e){let t=e.event.redacts;if(!t)return;let r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(x.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}async addLiveEvents(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=t,i=!1;if("object"==typeof t?{duplicateStrategy:n,fromCache:r=!1,timelineWasEmpty:i}=t:void 0!==t&&f.logger.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),n&&-1===["replace","ignore"].indexOf(n))throw Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){let t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(a.EventTimeline.FORWARDS))throw Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(a.EventTimeline.FORWARDS)+")");if(t.getNeighbouringTimeline(a.EventTimeline.FORWARDS))throw Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}let o=this.findThreadRoots(e),s={},l={duplicateStrategy:n,fromCache:r,timelineWasEmpty:i},c=[...e];for(let t of e){var u,h,p,g;if(this.processLiveEvent(t),t.getUnsigned().transaction_id){let e=this.txnToEvent.get(t.getUnsigned().transaction_id);if(e){this.handleRemoteEcho(t,e);continue}}let{shouldLiveInRoom:e,shouldLiveInThread:r,threadId:n}=this.eventShouldLiveIn(t,c,o);if(!r&&!e&&t.isRelation())try{let i=new d.MatrixEvent(await this.client.fetchRoomEvent(this.roomId,t.relationEventId));if(c.push(i),i.threadRootId){o.add(i.threadRootId);let e=t.getUnsigned();e[m.UNSIGNED_THREAD_ID_FIELD.name]=i.threadRootId,t.setUnsigned(e)}({shouldLiveInRoom:e,shouldLiveInThread:r,threadId:n}=this.eventShouldLiveIn(t,c,o))}catch(e){f.logger.error("Failed to load parent event of unhandled relation",e)}r&&!s[null!==(u=n)&&void 0!==u?u:""]&&(s[null!==(g=n)&&void 0!==g?g:""]=[]),null===(h=s[null!==(p=n)&&void 0!==p?p:""])||void 0===h||h.push(t),e?this.addLiveEvent(t,l):!r&&t.isRelation()&&this.relations.aggregateChildEvent(t)}Object.entries(s).forEach(e=>{let[t,r]=e;this.addThreadedEvents(t,r,!1)})}partitionThreadedEvents(e){let t=0,r=1,n=2;if(!this.client.supportsThreads())return[e,[],[]];{let i=this.findThreadRoots(e);return e.reduce((o,s)=>{let{shouldLiveInRoom:a,shouldLiveInThread:l,threadId:c}=this.eventShouldLiveIn(s,e,i);return a&&o[t].push(s),l&&(s.setThreadId(null!=c?c:""),o[r].push(s)),l||a||o[n].push(s),o},[[],[],[]])}}findThreadRoots(e){let t=new Set;for(let r of e){let e=r.threadRootId;void 0!=e&&t.add(e)}return t}addReceipt(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(e=>{Object.keys(r[e]).forEach(n=>{Object.keys(r[e][n]).forEach(i=>{var o,s,a,l;let c=r[e][n][i],d=!c.thread_id||c.thread_id===_.MAIN_ROOM_TIMELINE,u=d?this:this.threads.get(null!==(o=c.thread_id)&&void 0!==o?o:"");if(u){if(u.addReceiptToStructure(e,n,i,c,t),!t&&this.client.isInitialSyncComplete()&&i===this.client.getUserId()){let t=u.timeline[u.timeline.length-1];t&&e===t.getId()&&i===t.getSender()&&(u.setUnread(D.Total,0),u.setUnread(D.Highlight,0))}}else this.cachedThreadReadReceipts.set(c.thread_id,[...null!==(l=this.cachedThreadReadReceipts.get(c.thread_id))&&void 0!==l?l:[],{eventId:e,receiptType:n,userId:i,receipt:c,synthetic:t}]);i===this.client.getUserId()&&!d&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>(null!==(s=null===(a=this.unthreadedReceipts.get(i))||void 0===a?void 0:a.ts)&&void 0!==s?s:0)&&this.unthreadedReceipts.set(i,c)})})}),this.emit(x.Receipt,e,this)}addEphemeralEvents(e){for(let t of e)t.getType()===m.EventType.Typing?this.currentState.setTypingEvent(t):t.getType()===m.EventType.Receipt&&this.addReceipt(t)}removeEvents(e){for(let t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(let r of this.timelineSets){let n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){let e=this.currentState.getStateEvents(m.EventType.RoomMember,this.myUserId);if(e){let t=e.getContent().membership;this.updateMyMembership(t),"invite"===t&&(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.MatrixEvent({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}let t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,c.normalize)(this.name),this.summary=new p.RoomSummary(this.roomId,{title:this.name}),t!==this.name&&this.emit(x.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(x.Tags,e,this)}addAccountData(e){for(let t of e){"m.tag"===t.getType()&&this.addTags(t);let e=t.getType(),r=this.accountData.get(e);this.accountData.set(e,t),this.emit(x.AccountData,t,this,r)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return"join"===this.getMyMembership()&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(m.EventType.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(m.EventType.RoomMessage,this.myUserId))}canInvite(e){let t="join"===this.getMyMembership(),r=this.currentState.getStateEvents(m.EventType.RoomPowerLevels,""),n=r&&r.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){let e=this.currentState.getStateEvents(m.EventType.RoomCreate,"");if(!e){this.getTypeWarning||(f.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[m.RoomCreateTypeField]}isSpaceRoom(){return this.getType()===m.RoomType.Space}isCallRoom(){return this.getType()===m.RoomType.UnstableCall}isElementVideoRoom(){return this.getType()===m.RoomType.ElementVideo}findPredecessor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.getLiveTimeline().getState(a.EventTimeline.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){let t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case L.Actual:return e.name;case L.Generated:if("Inviting"===e.subtype)return"Inviting ".concat(N(e.names,e.count));return N(e.names,e.count);case L.EmptyRoom:if(e.oldName)return"Empty room (was ".concat(e.oldName,")");return"Empty room"}}calculateRoomName(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!r){let e=this.currentState.getStateEvents(m.EventType.RoomName,"");if(null!=e&&e.getContent().name)return this.roomNameGenerator({type:L.Actual,name:e.getContent().name})}let n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:L.Actual,name:n});let i=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,o=[],s=this.currentState.getStateEvents(m.UNSTABLE_ELEMENT_FUNCTIONAL_USERS.name,"");Array.isArray(null==s?void 0:s.getContent().service_members)&&(o=s.getContent().service_members);let a=[];if(this.summaryHeroes)this.summaryHeroes.forEach(e=>{if(o.includes(e)){i--;return}let t=this.getMember(e);a.push(t?t.name:e)});else{let t=this.currentState.getMembers().filter(t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership));(t=t.filter(e=>{let{userId:t}=e;return!o.includes(t)||(i--,!1)})).sort((e,t)=>(0,c.compare)(e.userId,t.userId)),a=(t=t.slice(0,5)).map(e=>e.name)}if(i)return this.roomNameGenerator({type:L.Generated,names:a,count:i});if("join"==this.getMyMembership()){let e=this.currentState.getStateEvents(m.EventType.RoomThirdPartyInvite);if(null!=e&&e.length){let t=e.map(e=>e.getContent().display_name);return this.roomNameGenerator({type:L.Generated,subtype:"Inviting",names:t,count:t.length+1})}}let l=a;return l.length||(l=this.currentState.getMembers().filter(t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership).map(e=>e.name)),l.length&&(t=this.roomNameGenerator({type:L.Generated,names:l,count:l.length+1})),this.roomNameGenerator({type:L.EmptyRoom,oldName:t})}applyNewVisibilityEvent(e){let t=e.asVisibilityChange();if(!t)return;let r=e.getSender();if(!r||!(m.EVENT_VISIBILITY_CHANGE_TYPE.name&&this.currentState.maySendStateEvent(m.EVENT_VISIBILITY_CHANGE_TYPE.name,r)||m.EVENT_VISIBILITY_CHANGE_TYPE.altName&&this.currentState.maySendStateEvent(m.EVENT_VISIBILITY_CHANGE_TYPE.altName,r)))return;let n=this.visibilityEvents.get(t.eventId);if(n){let t=n.length-1,r=Math.max(0,n.length-A);for(;t>=r&&!(n[t].getTs()<e.getTs());--t);-1===t?n.unshift(e):n.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);let i=this.findEventById(t.eventId);i&&i.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw Error("expected a visibility change event");let t=e.getRelation(),r=null==t?void 0:t.event_id,n=this.visibilityEvents.get(r);if(!n)return;let i=n.findIndex(t=>t.getId()===e.getId());if(-1!==i&&(n.splice(i,1),i===n.length)){let e=this.findEventById(r);if(!e)return;if(0===i)this.visibilityEvents.delete(r),e.applyVisibilityEvent();else{let t=n[n.length-1].asVisibilityChange();if(!t)throw Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){let t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;let r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,r.getTs()<e.getTs()||e.applyVisibilityEvent(n))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){for(let t of(super.fixupNotifications(e),this.getThreads().filter(e=>this.getThreadUnreadNotificationCount(e.id,D.Total)>0)))t.fixupNotifications(e)}compareEventOrdering(e,t){return(0,R.compareEventOrdering)(this,e,t)}hasEncryptionStateEvent(){var e;return!!(null===(e=this.getLiveTimeline().getState(a.EventTimeline.FORWARDS))||void 0===e?void 0:e.getStateEvents(m.EventType.RoomEncryption,""))}constructor(e,t,r,n={}){super(),(0,i.default)(this,"txnToEvent",new Map),(0,i.default)(this,"notificationCounts",{}),(0,i.default)(this,"threadNotifications",new Map),(0,i.default)(this,"cachedThreadReadReceipts",new Map),(0,i.default)(this,"oldestThreadedReceiptTs",1/0),(0,i.default)(this,"unthreadedReceipts",new Map),(0,i.default)(this,"polls",new Map),(0,i.default)(this,"threadsTimelineSets",[]),(0,i.default)(this,"filteredTimelineSets",{}),(0,i.default)(this,"timelineNeedsRefresh",!1),(0,i.default)(this,"summaryHeroes",null),(0,i.default)(this,"getTypeWarning",!1),(0,i.default)(this,"getVersionWarning",!1),(0,i.default)(this,"tags",{}),(0,i.default)(this,"accountData",new Map),(0,i.default)(this,"summary",null),(0,i.default)(this,"relations",new w.RelationsContainer(this.client,this)),(0,i.default)(this,"threads",new Map),(0,i.default)(this,"visibilityEvents",new Map),(0,i.default)(this,"roomReceipts",new O.RoomReceipts(this)),(0,i.default)(this,"threadTimelineSetsPromise",null),(0,i.default)(this,"threadsReady",!1),(0,i.default)(this,"updateThreadRootEvents",(e,t,r)=>{if(e.length){var n,i;this.updateThreadRootEvent(null===(n=this.threadsTimelineSets)||void 0===n?void 0:n[0],e,t,r),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(i=this.threadsTimelineSets)||void 0===i?void 0:i[1],e,t,r)}}),(0,i.default)(this,"updateThreadRootEvent",(e,t,r,n)=>{e&&t.rootEvent&&(n&&e.removeEvent(t.id),E.Thread.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:s.DuplicateStrategy.Replace,fromCache:!1,roomState:this.currentState}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:r}))}),(0,i.default)(this,"applyRedaction",e=>{if(e.isRedaction()){let t=e.event.redacts,r=t?this.findEventById(t):void 0;if(r){let n=r.threadRootId;if(r.makeRedacted(e,this),r.isState()){let e=this.currentState.getStateEvents(r.getType(),r.getStateKey());(null==e?void 0:e.getId())===r.getId()&&this.currentState.setStateEvents([r])}this.emit(x.Redaction,e,this,n),this.visibilityEvents.delete(t),r.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}}),this.roomId=e,this.client=t,this.myUserId=r,this.opts=n,this.setMaxListeners(100),this.reEmitter=new g.TypedReEmitter(this),n.pendingEventOrdering=n.pendingEventOrdering||v.PendingEventOrdering.Chronological,this.name=e,this.normalizedName=e,this.timelineSets=[new s.EventTimelineSet(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[x.Timeline,x.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===v.PendingEventOrdering.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(e=>{let r=this.client.getEventMapper({toDevice:!1,decrypt:!1});e.forEach(async e=>{let n=r(e);await t.decryptEventIfNeeded(n),n.setStatus(u.EventStatus.NOT_SENT),this.addPendingEvent(n,n.getTxnId())})})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}}t.Room=j;let U={[u.EventStatus.ENCRYPTING]:[u.EventStatus.SENDING,u.EventStatus.NOT_SENT,u.EventStatus.CANCELLED],[u.EventStatus.SENDING]:[u.EventStatus.ENCRYPTING,u.EventStatus.QUEUED,u.EventStatus.NOT_SENT,u.EventStatus.SENT],[u.EventStatus.QUEUED]:[u.EventStatus.SENDING,u.EventStatus.NOT_SENT,u.EventStatus.CANCELLED],[u.EventStatus.SENT]:[],[u.EventStatus.NOT_SENT]:[u.EventStatus.SENDING,u.EventStatus.QUEUED,u.EventStatus.CANCELLED],[u.EventStatus.CANCELLED]:[]},L=t.RoomNameType=function(e){return e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e}({});function N(e,t){let r=t-1;return e.length?1===e.length&&r<=1?e[0]:2===e.length&&r<=2?"".concat(e[0]," and ").concat(e[1]):r>1?"".concat(e[0]," and ").concat(r," others"):"".concat(e[0]," and 1 other"):"Empty room"}},53014:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=void 0;var n=r(78583);class i{static fromJson(e,t){let r=e.context||{},o=(r.events_before||[]).map(t),s=(r.events_after||[]).map(t),a=new n.EventContext(t(e.result)),l=a.ourEvent.threadRootId;return o=o.filter(e=>e.threadRootId===l),s=s.filter(e=>e.threadRootId===l),a.setPaginateToken(r.start,!0),a.addEvents(o,!0),a.addEvents(s,!1),a.setPaginateToken(r.end,!1),new i(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}t.SearchResult=i},93655:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ThreadFilterType=t.ThreadEvent=t.Thread=t.THREAD_RELATION_TYPE=t.FeatureSupport=t.FILTER_RELATED_BY_SENDERS=t.FILTER_RELATED_BY_REL_TYPES=void 0,t.determineFeatureSupport=E,t.threadFilterTypeToFilter=C;var i=n(r(13102)),o=r(32950),s=r(92807),a=r(15748),l=r(39325),c=r(91776),d=r(10907),u=r(29197),h=r(87225),p=r(34002),f=r(56332),g=r(64157),m=r(1755);function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let b=t.ThreadEvent=function(e){return e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e}({}),S=t.FeatureSupport=function(e){return e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e}({});function E(e,t){return e?S.Stable:t?S.Experimental:S.None}class _ extends f.ReadReceipt{async fetchRootEvent(){this.rootEvent=this.room.findEventById(this.id);try{let e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){p.logger.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}static setServerSideSupport(e){_.hasServerSideSupport=e,e!==S.Stable&&(T.setPreferUnstable(!0),I.setPreferUnstable(!0),O.setPreferUnstable(!0))}static setServerSideListSupport(e){_.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){_.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n;if((null!==(r=this.client.canSupport.get(m.Feature.RelationsRecursion))&&void 0!==r?r:m.ServerSupport.Unsupported)===m.ServerSupport.Unsupported){let r=null===(n=this.getReadReceiptForUserId(e))||void 0===n?void 0:n.eventId;if(r){let e=this.findEventById(r);if(e&&e.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(c.EventTimeline.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){let t=e.getId();!t||this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState)}addEvents(e,t){e.forEach(e=>this.addEvent(e,t,!1)),this.updateThreadMetadata()}addEvent(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];this.setEventMetadata(e);let n=this.lastReply(),i=!n||e.localTimestamp>=n.localTimestamp;if(_.hasServerSideSupport){if(!t&&this.initialEventsFetched&&i)this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e);else if(e.isRelation(a.RelationType.Annotation)||e.isRelation(a.RelationType.Replace)){this.addRelatedThreadEvent(e,t);return}else this.initialEventsFetched&&(t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e))}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(O.name)&&!t&&i&&(this.lastEvent=void 0),r&&(this.emit(b.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n,i,o;this.initialEventsFetched?(null!==(o=this.client.canSupport.get(m.Feature.RelationsRecursion))&&void 0!==o?o:m.ServerSupport.Unsupported)===m.ServerSupport.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t):null===(i=this.replayEvents)||void 0===i||i.push(e),null===(r=this.timelineSet.relations)||void 0===r||r.aggregateParentEvent(e),null===(n=this.timelineSet.relations)||void 0===n||n.aggregateChildEvent(e,this.timelineSet)}async processEvent(e){e&&(this.setEventMetadata(e),await this.fetchEditsWhereNeeded(e))}processReceipts(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(let{eventId:t,receiptType:r,userId:n,receipt:i,synthetic:o}of e)this.addReceiptToStructure(t,r,n,i,o)}getRootEventBundledRelationship(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null==e?void 0:e.getServerAggregatedRelation(O.name)}async processRootEvent(){let e=this.getRootEventBundledRelationship();if(_.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;let t=this.client.getEventMapper();this.lastEvent=t(y(y({},e.latest_event),{},{room_id:this.roomId})),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){let e=(this.pendingEventOrdering===o.PendingEventOrdering.Detached?this.room.getPendingEvents():this.events).filter(e=>{var t;return e.threadRootId===this.id&&e.isRelation(O.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())});this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}async resetLiveTimeline(e,t){var r,n;let i,o;let s=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);let a=this.liveTimeline;e&&(i=(await this.client.createMessagesRequest(this.roomId,e,1,c.Direction.Forward)).end),t&&(o=(await this.client.createMessagesRequest(this.roomId,t,1,c.Direction.Backward)).start),t&&s.getPaginationToken(c.Direction.Forward)===t&&s.setPaginationToken(null!==(r=o)&&void 0!==r?r:null,c.Direction.Forward),e&&a.getPaginationToken(c.Direction.Backward)===e&&a.setPaginationToken(null!==(n=i)&&void 0!==n?n:null,c.Direction.Backward)}async updateThreadFromRootEvent(){_.hasServerSideSupport&&(this.initialEventsFetched||this.lastEvent||await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent()}async updateThreadMetadata(){if(this.updatePendingReplyCount(),this.processRootEventPromise||(this.processRootEventPromise=this.updateThreadFromRootEvent()),await this.processRootEventPromise,!this.initialEventsFetched){this.initialEventsFetched=!0;try{for(let e of(0===this.replyCount&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,c.Direction.Backward)):await this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0}),this.replayEvents))this.addEvent(e,!1);this.replayEvents=null,this.emit(u.RoomEvent.TimelineReset,this.room,this.timelineSet,!0)}catch(e){p.logger.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}}this.emit(b.Update,this)}async fetchEditsWhereNeeded(){for(var e,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];if((null!==(e=this.client.canSupport.get(m.Feature.RelationsRecursion))&&void 0!==e?e:m.ServerSupport.Unsupported)===m.ServerSupport.Unsupported)return Promise.all(r.filter(w).map(async e=>{try{let t=await this.client.relations(this.roomId,e.getId(),a.RelationType.Replace,e.getType(),{limit:1});if(t.events.length){let r=t.events[0];e.makeReplaced(r),this.insertEventIntoTimeline(r)}}catch(e){p.logger.error("Failed to load edits for encrypted thread event",e)}}))}setEventMetadata(e){e&&(c.EventTimeline.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),null===(t=e.event)||void 0===t||null===(t=t.unsigned)||void 0===t||null===(t=t["m.relations"])||void 0===t||delete t[O.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e=>e.isRelation(a.RelationType.Thread);for(let t=this.timeline.length-1;t>=0;t--){let r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e) instanceof l.MatrixEvent}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){let r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){let e=n.getTs()<this.room.getOldestThreadedReceiptTs(),t=n.getId();if(e&&t)return t}let i=super.getEventReadUpTo(e,t);if(n){let t=this.room.getLastUnthreadedReceiptFor(e);if(!t)return i;for(let e=(null===(o=this.timeline)||void 0===o?void 0:o.length)-1;e>=0;--e){var o,s;let r=this.timeline[e];if(r.getId()===i)break;if(r.getTs()<t.ts)return null!==(s=r.getId())&&void 0!==s?s:i}}return i}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,i,o,s,a;let t=(null!==(r=null===(n=this.lastReply())||void 0===n?void 0:n.getTs())&&void 0!==r?r:0)<this.room.getOldestThreadedReceiptTs(),l=null!==(i=null===(o=this.room.getLastUnthreadedReceiptFor(e))||void 0===o?void 0:o.ts)&&void 0!==i?i:0,c=(null!==(s=this===null||void 0===this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==s?s:0)<l;if(t||c)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}constructor(e,t,r){var n;if(super(),(0,i.default)(this,"_currentUserParticipated",!1),(0,i.default)(this,"replyCount",0),(0,i.default)(this,"pendingReplyCount",0),(0,i.default)(this,"initialEventsFetched",!_.hasServerSideSupport),(0,i.default)(this,"replayEvents",[]),(0,i.default)(this,"onTimelineReset",async()=>{await this.processRootEventPromise,this.processRootEventPromise=void 0}),(0,i.default)(this,"onBeforeRedaction",(e,t)=>{null!=e&&e.isRelation(O.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(b.Update,this))}),(0,i.default)(this,"onRedaction",async(e,t,r)=>{if(r===this.id){if(this.replyCount<=0){for(let e of this.timeline)this.clearEventMetadata(e);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(b.Delete,this)}else{var n;(null===(n=this.lastEvent)||void 0===n?void 0:n.getId())===e.getAssociatedId()&&(await this.processRootEventPromise,this.processRootEventPromise=void 0),await this.updateThreadMetadata()}}}),(0,i.default)(this,"onTimelineEvent",(e,t,r)=>{if(!r){let r=e.getSender();r&&t&&this.shouldSendLocalEchoReceipt(r,e)&&t.addLocalEchoReceipt(r,e,g.ReceiptType.Read),e.getId()!==this.id&&e.isRelation(O.name)&&this.replyCount++}this.onEcho(e,null!=r&&r)}),(0,i.default)(this,"onLocalEcho",e=>{this.onEcho(e,!1)}),(0,i.default)(this,"onEcho",async(e,t)=>{e.threadRootId===this.id&&this.lastEvent!==e&&(await this.updateThreadMetadata(),e.isRelation(O.name)&&(t||(this.lastEvent=void 0,this.emit(b.NewReply,this,e))))}),this.id=e,this.rootEvent=t,this.setMaxListeners(1e3),!(null!=r&&r.room))throw Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=null!==(n=r.pendingEventOrdering)&&void 0!==n?n:o.PendingEventOrdering.Chronological,this.timelineSet=new d.EventTimelineSet(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new s.TypedReEmitter(this),this.reEmitter.reEmit(this.timelineSet,[u.RoomEvent.Timeline,u.RoomEvent.TimelineReset]),this.room.on(l.MatrixEventEvent.BeforeRedaction,this.onBeforeRedaction),this.room.on(u.RoomEvent.Redaction,this.onRedaction),this.room.on(u.RoomEvent.LocalEchoUpdated,this.onLocalEcho),this.room.on(u.RoomEvent.TimelineReset,this.onTimelineReset),this.timelineSet.on(u.RoomEvent.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}}function w(e){return e.isEncrypted()&&(e.isRelation(O.name)||e.isThreadRoot)}t.Thread=_,(0,i.default)(_,"hasServerSideSupport",S.None),(0,i.default)(_,"hasServerSideListSupport",S.None),(0,i.default)(_,"hasServerSideFwdPaginationSupport",S.None);let T=t.FILTER_RELATED_BY_SENDERS=new h.ServerControlledNamespacedValue("related_by_senders","io.element.relation_senders"),I=t.FILTER_RELATED_BY_REL_TYPES=new h.ServerControlledNamespacedValue("related_by_rel_types","io.element.relation_types"),O=t.THREAD_RELATION_TYPE=new h.ServerControlledNamespacedValue("m.thread","io.element.thread"),R=t.ThreadFilterType=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});function C(e){return e===R.My?"participated":"all"}},44441:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventEmitter=t.EventEmitterEvents=void 0;var n=r(67779);t.EventEmitterEvents=function(e){return e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e}({});class i extends n.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}async emitPromised(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];let i=this.listeners(e);return Promise.allSettled(i.map(e=>e(...r))).then(()=>i.length>0)}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}t.TypedEventEmitter=i},69509:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.UserEvent=t.User=void 0;var i=n(r(13102)),o=r(44441);let s=t.UserEvent=function(e){return e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e}({});class a extends o.TypedEventEmitter{static createUser(e,t){let r=new a(e);return t.reEmitter.reEmit(r,[s.AvatarUrl,s.DisplayName,s.Presence,s.CurrentlyActive,s.LastPresenceTs]),r}setPresenceEvent(e){if("m.presence"!==e.getType())return;let t=null===this.events.presence;this.events.presence=e;let r=[];for(let n of((e.getContent().presence!==this.presence||t)&&r.push(s.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(s.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(s.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push(s.CurrentlyActive),this.presence=e.getContent().presence,r.push(s.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime(),r))this.emit(n,e,this)}setDisplayName(e){let t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){let t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}constructor(e){super(),(0,i.default)(this,"modified",-1),(0,i.default)(this,"presence","offline"),(0,i.default)(this,"lastActiveAgo",0),(0,i.default)(this,"lastPresenceTs",0),(0,i.default)(this,"currentlyActive",!1),(0,i.default)(this,"events",{}),this.userId=e,this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}}t.User=a},25731:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.generateScope=t.generateOidcAuthorizationUrl=t.generateAuthorizationUrl=t.generateAuthorizationParams=t.completeAuthorizationCodeGrant=void 0;var i=n(r(13102)),o=r(26241),s=r(20763),a=r(34002),l=r(89027),c=r(63350),d=r(19251);function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let p=e=>{let t=null!=e?e:(0,l.randomString)(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(t)};t.generateScope=p;let f=async e=>{if(!s.subtleCrypto)return a.logger.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;let t=new s.TextEncoder().encode(e),r=await s.subtleCrypto.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},g=e=>{let{redirectUri:t}=e;return{scope:p(),redirectUri:t,state:(0,l.randomString)(8),nonce:(0,l.randomString)(8),codeVerifier:(0,l.randomString)(64)}};t.generateAuthorizationParams=g;let m=async(e,t,r)=>{let{scope:n,redirectUri:i,state:o,nonce:s,codeVerifier:a}=r,l=new URL(e);return l.searchParams.append("response_mode","query"),l.searchParams.append("response_type","code"),l.searchParams.append("redirect_uri",i),l.searchParams.append("client_id",t),l.searchParams.append("state",o),l.searchParams.append("scope",n),l.searchParams.append("nonce",s),l.searchParams.append("code_challenge_method","S256"),l.searchParams.append("code_challenge",await f(a)),l.toString()};t.generateAuthorizationUrl=m;let v=async e=>{let{metadata:t,redirectUri:r,clientId:n,homeserverUrl:i,identityServerUrl:s,nonce:a,prompt:l}=e,c=await p(),d=new o.OidcClient(h(h({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:c,stateStore:new o.WebStorageStateStore({prefix:"mx_oidc_",store:window.sessionStorage})})),u={homeserverUrl:i,nonce:a,identityServerUrl:s};return(await d.createSigninRequest({state:u,nonce:a,prompt:l})).url};t.generateOidcAuthorizationUrl=v;let y=e=>({id_token:e.id_token,scope:e.scope,expires_at:e.expires_at,refresh_token:e.refresh_token,access_token:e.access_token,token_type:"Bearer"}),b=async(e,t)=>{let r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),o.Log.setLogger(a.logger);try{let e=new o.SigninResponse(r.searchParams),t=new o.WebStorageStateStore({prefix:"mx_oidc_",store:window.sessionStorage}),n=await t.get(e.state);if(!n)throw Error(c.OidcError.MissingOrInvalidStoredState);let i=o.SigninState.fromStorageString(n),s=new o.OidcClient(h(h({},i),{},{stateStore:t})),a=await s.processSigninResponse(r.href),l=a.userState;(0,d.validateStoredUserState)(l),(0,d.validateBearerTokenResponse)(a),(0,d.validateIdToken)(a.id_token,s.settings.authority,s.settings.client_id,l.nonce);let u=y(a);return{oidcClientSettings:{clientId:s.settings.client_id,issuer:s.settings.authority},tokenResponse:u,homeserverUrl:l.homeserverUrl,identityServerUrl:l.identityServerUrl,idTokenClaims:a.profile}}catch(t){a.logger.error("Oidc login failed",t);let e=t.message;if(Object.values(c.OidcError).includes(e))throw t;throw Error(c.OidcError.CodeExchangeFailed)}};t.completeAuthorizationCodeGrant=b},72939:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.discoverAndValidateAuthenticationConfig=void 0;var i=n(r(13102)),o=r(26241),s=r(19251);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let c=async e=>{var t;let r=(0,s.validateWellKnownAuthentication)(e),n=new o.OidcClientSettingsStore({authority:r.issuer,redirect_uri:"",client_id:""}),i=new o.MetadataService(n),a=await i.getMetadata(),c=null!==(t=await i.getSigningKeys())&&void 0!==t?t:void 0;return(0,s.isValidatedIssuerMetadata)(a),l(l({},r),{},{metadata:a,signingKeys:c})};t.discoverAndValidateAuthenticationConfig=c},63350:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OidcError=void 0,t.OidcError=function(e){return e.NotSupported="OIDC authentication not supported",e.Misconfigured="OIDC is misconfigured",e.General="Something went wrong with OIDC discovery",e.OpSupport="Configured OIDC OP does not support required functions",e.DynamicRegistrationNotSupported="Dynamic registration not supported",e.DynamicRegistrationFailed="Dynamic registration failed",e.DynamicRegistrationInvalid="Dynamic registration invalid response",e.CodeExchangeFailed="Failed to exchange code for token",e.InvalidBearerTokenResponse="Invalid bearer token response",e.InvalidIdToken="Invalid ID token",e.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",e}({})},30434:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(25731);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))});var i=r(72939);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(63350);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var s=r(82025);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var a=r(11790);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var l=r(19251);Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))})},82025:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerOidcClient=void 0;var n=r(63350),i=r(498),o=r(34002);let s=async(e,t)=>{let r={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:["authorization_code","refresh_token"],redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:"web"},s={Accept:"application/json","Content-Type":"application/json"};try{let t=await fetch(e,{method:i.Method.Post,headers:s,body:JSON.stringify(r)});if(t.status>=400)throw Error(n.OidcError.DynamicRegistrationFailed);let o=(await t.json()).client_id;if(!o||"string"!=typeof o)throw Error(n.OidcError.DynamicRegistrationInvalid);return o}catch(e){if(Object.values(n.OidcError).includes(e.message))throw e;throw o.logger.error("Dynamic registration request failed",e),Error(n.OidcError.DynamicRegistrationFailed)}},a=async(e,t,r)=>{let i={clientName:t,clientUri:r,redirectUris:[r]};if(!e.registrationEndpoint)throw Error(n.OidcError.DynamicRegistrationNotSupported);return await s(e.registrationEndpoint,i)};t.registerOidcClient=a},11790:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.OidcTokenRefresher=void 0;var i=n(r(13102)),o=r(26241),s=r(25731),a=r(72939),l=r(34002);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class u{async initialiseOidcClient(e,t,r,n){try{let i=await (0,a.discoverAndValidateAuthenticationConfig)(e),l=(0,s.generateScope)(r);this.oidcClient=new o.OidcClient(d(d({},i.metadata),{},{client_id:t,scope:l,redirect_uri:n,authority:i.metadata.issuer,stateStore:new o.WebStorageStateStore({prefix:"mx_oidc_",store:window.sessionStorage})}))}catch(e){throw l.logger.error("Failed to initialise OIDC client.",e),Error("Failed to initialise OIDC client.")}}async doRefreshAccessToken(e){this.inflightRefreshRequest||(this.inflightRefreshRequest=this.getNewTokens(e));try{return await this.inflightRefreshRequest}finally{this.inflightRefreshRequest=void 0}}async persistTokens(e){}async getNewTokens(e){if(!this.oidcClient)throw Error("Cannot get new token before OIDC client is initialised.");let t={refresh_token:e,session_state:"test",data:void 0,profile:this.idTokenClaims},r=await this.oidcClient.useRefreshToken({state:t,timeoutInSeconds:300}),n={accessToken:r.access_token,refreshToken:r.refresh_token};return await this.persistTokens(n),n}constructor(e,t,r,n,i){this.idTokenClaims=i,this.oidcClientReady=this.initialiseOidcClient(e,t,n,r)}}t.OidcTokenRefresher=u},19251:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"OidcDiscoveryError",{enumerable:!0,get:function(){return s.OidcError}}),t.isValidatedIssuerMetadata=p,t.validateBearerTokenResponse=y,t.validateOIDCIssuerWellKnown=t.validateIdToken=void 0,t.validateStoredUserState=m,t.validateWellKnownAuthentication=void 0;var i=n(r(9104)),o=r(34002),s=r(63350);let a=e=>{if(!e)throw Error(s.OidcError.NotSupported);if("string"==typeof e.issuer&&(!e.hasOwnProperty("account")||"string"==typeof e.account))return{issuer:e.issuer,account:e.account};throw Error(s.OidcError.Misconfigured)};t.validateWellKnownAuthentication=a;let l=e=>!!e&&"object"==typeof e&&!Array.isArray(e),c=(e,t)=>!!(e[t]&&d(e,t))||(o.logger.error("Missing or invalid property: ".concat(t)),!1),d=(e,t)=>!e[t]||"string"==typeof e[t]||(o.logger.error("Invalid property: ".concat(t)),!1),u=(e,t,r)=>{let n=e[t];return!!(n&&Array.isArray(n)&&n.includes(r))||(o.logger.error("Invalid property: ".concat(t,". ").concat(r," is required.")),!1)},h=e=>{if(!l(e))throw o.logger.error("Issuer configuration not found or malformed"),Error(s.OidcError.OpSupport);if(![c(e,"authorization_endpoint"),c(e,"token_endpoint"),c(e,"revocation_endpoint"),d(e,"registration_endpoint"),u(e,"response_types_supported","code"),u(e,"grant_types_supported","authorization_code"),u(e,"code_challenge_methods_supported","S256")].some(e=>!e))return{authorizationEndpoint:e.authorization_endpoint,tokenEndpoint:e.token_endpoint,registrationEndpoint:e.registration_endpoint};throw o.logger.error("Issuer configuration not valid"),Error(s.OidcError.OpSupport)};function p(e){h(e)}t.validateOIDCIssuerWellKnown=h;let f=e=>{try{return(0,i.default)(e)}catch(e){throw o.logger.error("Could not decode id_token",e),e}},g=(e,t,r,n)=>{try{if(!e)throw Error("No ID token");let i=f(e);if(i.iss!==t)throw Error("Invalid issuer");if(i.aud!==r)throw Error("Invalid audience");if(i.nonce!==n)throw Error("Invalid nonce");if(!i.exp||Date.now()>1e3*i.exp)throw Error("Invalid expiry")}catch(e){throw o.logger.error("Invalid ID token",e),Error(s.OidcError.InvalidIdToken)}};function m(e){if(!l(e))throw o.logger.error("Stored user state not found"),Error(s.OidcError.MissingOrInvalidStoredState);if([c(e,"homeserverUrl"),c(e,"nonce"),d(e,"identityServerUrl")].some(e=>!e))throw Error(s.OidcError.MissingOrInvalidStoredState)}t.validateIdToken=g;let v=e=>l(e)&&c(e,"token_type")&&"bearer"===e.token_type.toLowerCase()&&c(e,"access_token")&&c(e,"refresh_token")&&(!("expires_in"in e)||"number"==typeof e.expires_in);function y(e){if(!v(e))throw Error(s.OidcError.InvalidBearerTokenResponse)}},77360:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=void 0;var i=n(r(13102)),o=r(44480),s=r(34002),a=r(49820),l=r(15748);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let u=[a.PushRuleKind.Override,a.PushRuleKind.ContentSpecific,a.PushRuleKind.RoomSpecific,a.PushRuleKind.SenderSpecific,a.PushRuleKind.Underride],h=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:"m.reaction"}],actions:[a.PushRuleActionName.DontNotify]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:l.EventType.RoomServerAcl},{kind:a.ConditionKind.EventMatch,key:"state_key",pattern:""}],actions:[]}],p=[{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:a.ConditionKind.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:a.ConditionKind.CallStarted}],actions:[a.PushRuleActionName.Notify,{set_tweak:a.TweakName.Sound,value:"default"}]}];class f{static actionListToActionsObject(e){let t={notify:!1,tweaks:{}};for(let r of e)r===a.PushRuleActionName.Notify?t.notify=!0:"object"==typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=JSON.parse(JSON.stringify(e));n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]);let i=n.global.override;for(let e of h){let t;let n=i.find(t=>t.rule_id===e.rule_id);if(e.rule_id===a.RuleId.IsUserMention){if(!r)continue;(t=JSON.parse(JSON.stringify(e))).conditions[0].value=r}else t=e;if(n)n.default=t.default,n.conditions=t.conditions,n.actions=t.actions;else{let e=t.rule_id;s.logger.warn("Adding default global override for ".concat(e)),i.push(t)}}let o=null!==(t=n.global.underride)&&void 0!==t?t:[];for(let e of p){let t=o.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{let t=e.rule_id;s.logger.warn("Adding default global underride for ".concat(t)),o.push(e)}}return n}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);let t=new Set(this.parsedKeys.keys());for(let r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(let e of r)if(e.conditions)for(let r of e.conditions)r.kind===a.ConditionKind.EventMatch&&(t.delete(r.key),this.parsedKeys.set(r.key,f.partsForDottedKey(r.key)));t.forEach(e=>this.parsedKeys.delete(e))}matchingRuleFromKindSet(e,t){for(let r of u){let n=t[r];if(n)for(let t of n){if(!t.enabled)continue;let n=this.templateRuleToRaw(r,t);if(n&&this.ruleMatchesEvent(n,e))return d(d({},t),{},{kind:r})}}return null}templateRuleToRaw(e,t){let r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case a.PushRuleKind.Underride:case a.PushRuleKind.Override:r.conditions=t.conditions;break;case a.PushRuleKind.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:a.ConditionKind.EventMatch,key:"room_id",value:t.rule_id});break;case a.PushRuleKind.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:a.ConditionKind.EventMatch,key:"user_id",value:t.rule_id});break;case a.PushRuleKind.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:a.ConditionKind.EventMatch,key:"content.body",pattern:t.pattern})}return r}eventFulfillsCondition(e,t){switch(e.kind){case a.ConditionKind.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case a.ConditionKind.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case a.ConditionKind.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case a.ConditionKind.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case a.ConditionKind.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case a.ConditionKind.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case a.ConditionKind.CallStarted:case a.ConditionKind.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){let r=e.key;if(!r)return!1;let n=this.client.getRoom(t.getRoomId());return null!=n&&!!n.currentState&&n.currentState.mayTriggerNotifOfType(r,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;let r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;let n=r.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;let o=i[1],s=parseInt(i[2]);if(isNaN(s))return!1;switch(o){case"":case"==":return n==s;case"<":return n<s;case">":return n>s;case"<=":return n<=s;case">=":return n>=s;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r;let n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;let i=this.client.getRoom(t.getRoomId()),s=null==i||null===(r=i.currentState)||void 0===r?void 0:r.getMember(this.client.credentials.userId);if(!s)return!1;let a=s.name,l=RegExp("(^|\\W)"+(0,o.escapeRegExp)(a)+"(\\W|$)","i");return n.body.search(l)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;let r=this.valueForDottedKey(e.key,t);if("string"!=typeof r)return!1;if(e.value)return e.value===r;if("string"!=typeof e.pattern)return!1;let n="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!!e.key&&void 0!==e.value&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;let r=this.valueForDottedKey(e.key,t);return!!Array.isArray(r)&&r.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||(0,o.deepCompare)(t.getPrevContent(),{}))}createCachedRegex(e,t,r){return f.cachedGlobToRegex[t]||(f.cachedGlobToRegex[t]=RegExp(e+(0,o.globToRegexp)(t)+r,"i")),f.cachedGlobToRegex[t]}static partsForDottedKey(e){let t=[],r="",n=!1;for(let i of e){if(n){"\\"===i||"."===i?r+=i:r+="\\"+i,n=!1;continue}"."==i?(t.push(r),r=""):"\\"==i?n=!0:r+=i}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){let r,n=this.parsedKeys.get(e);void 0===n&&(n=f.partsForDottedKey(e),this.parsedKeys.set(e,n));let i=n[0],s=0;for("content"===i?(r=t.getContent(),++s):"type"===i?(r=t.getType(),++s):r=t.event;s<n.length;++s){if((0,o.isNullOrUndefined)(r))return;r=r[n[s]]}return r}matchingRuleForEventWithRulesets(e,t){return t&&e.getSender()!==this.client.getSafeUserId()?this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){let r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};let n=f.actionListToActionsObject(r.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=r.kind==a.PushRuleKind.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==a.RuleId.ContainsUserName&&e.rule_id!==a.RuleId.ContainsDisplayName&&e.rule_id!==a.RuleId.AtRoomNotification)&&!(null!==(r=e.conditions)&&void 0!==r&&r.some(e=>!this.eventFulfillsCondition(e,t)))}actionsForEvent(e){let{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t;let r=this.getPushRuleAndKindById(e);return null!==(t=null==r?void 0:r.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(let r of["global"]){var t;if((null===(t=this.client.pushRules)||void 0===t?void 0:t[r])!==void 0){for(let t of u)if(void 0!==this.client.pushRules[r][t]){for(let n of this.client.pushRules[r][t])if(n.rule_id===e)return{rule:n,kind:t}}}}return null}constructor(e){(0,i.default)(this,"parsedKeys",new Map),this.client=e}}t.PushProcessor=f,(0,i.default)(f,"cachedGlobToRegex",{})},89027:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomLowercaseString=d,t.randomString=c,t.randomUppercaseString=u,t.secureRandomBase64Url=l;var n=r(98870),i=r(20763);let o="abcdefghijklmnopqrstuvwxyz",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="0123456789";function l(e){let t=new Uint8Array(e);return i.crypto.getRandomValues(t),(0,n.encodeUnpaddedBase64Url)(t)}function c(e){return h(e,s+o+a)}function d(e){return h(e,o)}function u(e){return h(e,s)}function h(e,t){let r="";for(let n=0;n<e;++n)r+=t.charAt(Math.floor(Math.random()*t.length));return r}},39626:function(e,t,r){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.clearTimeout=d,t.setTimeout=c;var i=r(34002);let o=1e3,s=0,a=[],l=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r]};function c(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];(t=t||0)<0&&(t=0);let o=Date.now()+t,c=s++;l("setTimeout: scheduling cb",c,"at",o,"(delay",t,")");let d={runAt:o,func:e,params:n,key:c},h=p(a,function(e){return e.runAt-o});return a.splice(h,0,d),u(),c}function d(e){let t;if(0!==a.length){for(t=0;t<a.length;t++)if(a[t].key==e){a.splice(t,1);break}0===t&&u()}}function u(){n&&r.g.clearTimeout(n);let e=a[0];if(!e){l("scheduleRealCallback: no more callbacks, not rescheduling");return}let t=Date.now(),i=Math.min(e.runAt-t,o);l("scheduleRealCallback: now:",t,"delay:",i),n=r.g.setTimeout(h,i)}function h(){let e=Date.now();l("runCallbacks: now:",e);let t=[];for(;;){let r=a[0];if(!r||r.runAt>e)break;let n=a.shift();l("runCallbacks: popping",n.key),t.push(n)}for(let e of(u(),t))try{e.func.apply(r.g,e.params)}catch(e){i.logger.error("Uncaught exception in callback function",e)}}function p(e,t){let r=0,n=e.length;for(;r<n;){let i=r+n>>1;t(e[i])>0?n=i:r=i+1}return r}},46159:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiptAccumulator=void 0;var i=n(r(13102)),o=r(15748),s=r(44480);class a{setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(let e of this.threadedReadReceipts.values())for(let t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach(e=>{e.type===o.EventType.Receipt&&e.content&&Object.keys(e.content).forEach(t=>{Object.entries(e.content[t]).forEach(r=>{let[n,i]=r;if((0,s.isSupportedReceiptType)(n))for(let r of Object.keys(i)){let i=e.content[t][n][r],o={data:e.content[t][n][r],type:n,eventId:t};i.thread_id?this.setThreaded(i.thread_id,r,o):this.setUnthreaded(r,o)}})})})}buildAccumulatedReceiptEvent(e){let t={type:o.EventType.Receipt,room_id:e,content:{}},r=new s.MapWithDefault(()=>new s.MapWithDefault(()=>new Map));for(let[e,t]of this.allUnthreaded())r.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);for(let[e,t]of this.allThreaded())r.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);return t.content=(0,s.recursiveMapToObject)(r),r.size>0?t:null}constructor(){(0,i.default)(this,"unthreadedReadReceipts",new Map),(0,i.default)(this,"threadedReadReceipts",new s.MapWithDefault(()=>new Map))}}t.ReceiptAccumulator=a},16318:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CrossSigningIdentity=void 0;var n=r(34002);class i{async bootstrapCrossSigning(e){if(e.setupNewCrossSigning){await this.resetCrossSigning(e.authUploadDeviceSigningKeys);return}let t=await this.olmMachine.crossSigningStatus(),r=await this.secretStorage.get("m.cross_signing.master"),i=await this.secretStorage.get("m.cross_signing.self_signing"),o=await this.secretStorage.get("m.cross_signing.user_signing"),s=!!(r&&i&&o),a=t.hasMaster&&t.hasUserSigning&&t.hasSelfSigning;if(n.logger.log("bootstrapCrossSigning: starting",{setupNewCrossSigning:e.setupNewCrossSigning,olmDeviceHasMaster:t.hasMaster,olmDeviceHasUserSigning:t.hasUserSigning,olmDeviceHasSelfSigning:t.hasSelfSigning,privateKeysInSecretStorage:s}),a)await this.secretStorage.hasKey()?s?n.logger.log("bootstrapCrossSigning: Olm device has private keys and they are saved in secret storage; doing nothing"):(n.logger.log("bootstrapCrossSigning: Olm device has private keys: exporting to secret storage"),await this.exportCrossSigningKeysToStorage()):n.logger.warn("bootstrapCrossSigning: Olm device has private keys, but secret storage is not yet set up; doing nothing for now.");else if(s){n.logger.log("bootstrapCrossSigning: Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.olmMachine.importCrossSigningKeys(r,i,o);let e=await this.olmMachine.getDevice(this.olmMachine.userId,this.olmMachine.deviceId);try{let t=await e.verify();await this.outgoingRequestProcessor.makeOutgoingRequest(t)}finally{e.free()}}else n.logger.log("bootstrapCrossSigning: Cross-signing private keys not found locally or in secret storage, creating new keys"),await this.resetCrossSigning(e.authUploadDeviceSigningKeys);n.logger.log("bootstrapCrossSigning: complete")}async resetCrossSigning(e){let t=await this.olmMachine.bootstrapCrossSigning(!0);for(let r of(await this.secretStorage.hasKey()?(n.logger.log("resetCrossSigning: exporting to secret storage"),await this.exportCrossSigningKeysToStorage()):n.logger.warn("resetCrossSigning: Secret storage is not yet set up; not exporting keys to secret storage yet."),n.logger.log("resetCrossSigning: publishing keys to server"),[t.uploadKeysRequest,t.uploadSigningKeysRequest,t.uploadSignaturesRequest]))r&&await this.outgoingRequestProcessor.makeOutgoingRequest(r,e)}async exportCrossSigningKeysToStorage(){let e=await this.olmMachine.exportCrossSigningKeys();null!=e&&e.masterKey?await this.secretStorage.store("m.cross_signing.master",e.masterKey):n.logger.error("Cannot export MSK to secret storage, private key unknown"),null!=e&&e.self_signing_key?await this.secretStorage.store("m.cross_signing.self_signing",e.self_signing_key):n.logger.error("Cannot export SSK to secret storage, private key unknown"),null!=e&&e.userSigningKey?await this.secretStorage.store("m.cross_signing.user_signing",e.userSigningKey):n.logger.error("Cannot export USK to secret storage, private key unknown")}constructor(e,t,r){this.olmMachine=e,this.outgoingRequestProcessor=t,this.secretStorage=r}}t.CrossSigningIdentity=i},99996:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.KeyClaimManager=void 0;var i=n(r(13102));class o{stop(){this.stopped=!0}ensureSessionsForUsers(e,t){let r=this.currentClaimPromise.catch(()=>{}).then(()=>this.ensureSessionsForUsersInner(e,t));return this.currentClaimPromise=r,r}async ensureSessionsForUsersInner(e,t){if(this.stopped)throw Error("Cannot ensure Olm sessions: shutting down");e.info("Checking for missing Olm sessions");let r=await this.olmMachine.getMissingSessions(t.map(e=>e.clone()));r&&(e.info("Making /keys/claim request"),await this.outgoingRequestProcessor.makeOutgoingRequest(r)),e.info("Olm sessions prepared")}constructor(e,t){(0,i.default)(this,"stopped",!1),this.olmMachine=e,this.outgoingRequestProcessor=t,this.currentClaimPromise=Promise.resolve()}}t.KeyClaimManager=o},73414:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.OutgoingRequestProcessor=void 0;var i=n(r(13102)),o=r(24542),s=r(34002),a=r(498),l=r(44480),c=r(15748);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class h{async makeOutgoingRequest(e,t){let r;if(e instanceof o.KeysUploadRequest)r=await this.rawJsonRequest(a.Method.Post,"/_matrix/client/v3/keys/upload",{},e.body);else if(e instanceof o.KeysQueryRequest)r=await this.rawJsonRequest(a.Method.Post,"/_matrix/client/v3/keys/query",{},e.body);else if(e instanceof o.KeysClaimRequest)r=await this.rawJsonRequest(a.Method.Post,"/_matrix/client/v3/keys/claim",{},e.body);else if(e instanceof o.SignatureUploadRequest)r=await this.rawJsonRequest(a.Method.Post,"/_matrix/client/v3/keys/signatures/upload",{},e.body);else if(e instanceof o.KeysBackupRequest)r=await this.rawJsonRequest(a.Method.Put,"/_matrix/client/v3/room_keys/keys",{version:e.version},e.body);else if(e instanceof o.ToDeviceRequest)r=await this.sendToDeviceRequest(e);else if(e instanceof o.RoomMessageRequest){let t="/_matrix/client/v3/rooms/".concat(encodeURIComponent(e.room_id),"/send/")+"".concat(encodeURIComponent(e.event_type),"/").concat(encodeURIComponent(e.txn_id));r=await this.rawJsonRequest(a.Method.Put,t,{},e.body)}else if(e instanceof o.UploadSigningKeysRequest){await this.makeRequestWithUIA(a.Method.Post,"/_matrix/client/v3/keys/device_signing/upload",{},e.body,t);return}else s.logger.warn("Unsupported outgoing message",Object.getPrototypeOf(e)),r="";if(e.id)try{await (0,l.logDuration)(s.logger,"Mark Request as sent ".concat(e.type),async()=>{await this.olmMachine.markRequestAsSent(e.id,e.type,r)})}catch(e){if(e instanceof Error&&("Attempt to use a moved value"===e.message||"null pointer passed to rust"===e.message))s.logger.log("Ignoring error '".concat(e.message,"': client is likely shutting down"));else throw e}else s.logger.trace("Outgoing request type:".concat(e.type," does not have an ID"))}async sendToDeviceRequest(e){let t=JSON.parse(e.body),r=[];for(let[e,n]of Object.entries(t.messages))for(let[t,i]of Object.entries(n))r.push("".concat(e,"/").concat(t," (msgid ").concat(i[c.ToDeviceMessageId],")"));s.logger.info("Sending batch of to-device messages. type=".concat(e.event_type," txnid=").concat(e.txn_id),r);let n="/_matrix/client/v3/sendToDevice/".concat(encodeURIComponent(e.event_type),"/")+encodeURIComponent(e.txn_id);return await this.rawJsonRequest(a.Method.Put,n,{},e.body)}async makeRequestWithUIA(e,t,r,n,i){if(!i)return await this.rawJsonRequest(e,t,r,n);let o=JSON.parse(n),s=async n=>{let i=u({},o);return null!==n&&(i.auth=n),JSON.parse(await this.rawJsonRequest(e,t,r,JSON.stringify(i)))};return JSON.stringify(await i(s))}async rawJsonRequest(e,t,r,n){let i={json:!1,headers:{"Content-Type":"application/json",Accept:"application/json"},prefix:""};return await this.http.authedRequest(e,t,r,n,i)}constructor(e,t){this.olmMachine=e,this.http=t}}t.OutgoingRequestProcessor=h},67826:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.OutgoingRequestsManager=void 0;var i=n(r(13102)),o=r(44480);class s{stop(){this.stopped=!0}doProcessOutgoingRequests(){this.nextLoopDeferred||(this.nextLoopDeferred=(0,o.defer)());let e=this.nextLoopDeferred.promise;return this.outgoingRequestLoopRunning||this.outgoingRequestLoop().catch(e=>{this.logger.error("Uncaught error in outgoing request loop",e)}),e}async outgoingRequestLoop(){if(this.outgoingRequestLoopRunning)throw Error("Cannot run two outgoing request loops");this.outgoingRequestLoopRunning=!0;try{for(;!this.stopped&&this.nextLoopDeferred;){let e=this.nextLoopDeferred;this.nextLoopDeferred=void 0,await this.processOutgoingRequests().then(e.resolve,e.reject)}}finally{this.outgoingRequestLoopRunning=!1}this.nextLoopDeferred&&this.nextLoopDeferred.reject(Error("OutgoingRequestsManager was stopped"))}async processOutgoingRequests(){if(!this.stopped)for(let e of(await this.olmMachine.outgoingRequests())){if(this.stopped)return;try{await (0,o.logDuration)(this.logger,"Make outgoing request ".concat(e.type),async()=>{await this.outgoingRequestProcessor.makeOutgoingRequest(e)})}catch(t){this.logger.error("Failed to process outgoing request ".concat(e.type,": ").concat(t))}}}constructor(e,t,r){(0,i.default)(this,"stopped",!1),(0,i.default)(this,"outgoingRequestLoopRunning",!1),this.logger=e,this.olmMachine=t,this.outgoingRequestProcessor=r}}t.OutgoingRequestsManager=s},81293:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.PerSessionKeyBackupDownloader=void 0;var i=n(r(13102)),o=r(498),s=r(301),a=r(44480);let l=5e3;var c=function(e){return e.MISSING_DECRYPTION_KEY="MISSING_DECRYPTION_KEY",e.NETWORK_ERROR="NETWORK_ERROR",e.STOPPED="STOPPED",e}(c||{});class d extends Error{constructor(e){super("Failed to get key from backup: ".concat(e)),this.code=e,this.name="KeyDownloadError"}}class u extends Error{constructor(e){super("Failed to get key from backup: rate limited"),this.retryMillis=e,this.name="KeyDownloadRateLimitError"}}class h{onDecryptionKeyMissingError(e,t){if(this.isAlreadyInQueue(e,t)){this.logger.trace("Not checking key backup for session ".concat(t," as it is already queued"));return}if(this.wasRequestedRecently(t)){this.logger.trace("Not checking key backup for session ".concat(t," as it was already requested recently"));return}this.queuedRequests.push({roomId:e,megolmSessionId:t}),this.downloadKeysLoop()}stop(){this.stopped=!0,this.backupManager.off(s.CryptoEvent.KeyBackupStatus,this.onBackupStatusChanged),this.backupManager.off(s.CryptoEvent.KeyBackupFailed,this.onBackupStatusChanged),this.backupManager.off(s.CryptoEvent.KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}isAlreadyInQueue(e,t){return this.queuedRequests.some(r=>r.roomId==e&&r.megolmSessionId==t)}markAsNotFoundInBackup(e){let t=Date.now();this.sessionLastCheckAttemptedTime.set(e,t),this.sessionLastCheckAttemptedTime.size>100&&(this.sessionLastCheckAttemptedTime=new Map(Array.from(this.sessionLastCheckAttemptedTime).filter((e,r)=>Math.max(t-r,0)<l)))}wasRequestedRecently(e){let t=this.sessionLastCheckAttemptedTime.get(e);return!!t&&Math.max(Date.now()-t,0)<l}async getBackupDecryptionKey(){try{return await this.olmMachine.getBackupKeys()}catch(e){return null}}async requestRoomKeyFromBackup(e,t,r){let n=(0,a.encodeUri)("/room_keys/keys/$roomId/$sessionId",{$roomId:t,$sessionId:r});return await this.http.authedRequest(o.Method.Get,n,{version:e},void 0,{prefix:o.ClientPrefix.V3})}async downloadKeysLoop(){if(!this.downloadLoopRunning&&!this.hasConfigurationProblem){this.downloadLoopRunning=!0;try{for(;this.queuedRequests.length>0;){let e=this.queuedRequests[0];try{let t=await this.getOrCreateBackupConfiguration();if(!t){this.downloadLoopRunning=!1;return}let r=await this.queryKeyBackup(e.roomId,e.megolmSessionId,t);if(this.stopped)return;try{await this.decryptAndImport(e,r,t)}catch(t){this.logger.error("Error while decrypting and importing key backup for session ".concat(e.megolmSessionId),t)}this.queuedRequests.shift()}catch(t){if(t instanceof d)switch(t.code){case c.MISSING_DECRYPTION_KEY:this.markAsNotFoundInBackup(e.megolmSessionId),this.queuedRequests.shift();break;case c.NETWORK_ERROR:await (0,a.sleep)(l);break;case c.STOPPED:this.downloadLoopRunning=!1;return}else t instanceof u&&await (0,a.sleep)(t.retryMillis)}}}finally{this.downloadLoopRunning=!1}}}async queryKeyBackup(e,t,r){if(this.logger.debug("Checking key backup for session ".concat(t)),this.stopped)throw new d(c.STOPPED);try{let n=await this.requestRoomKeyFromBackup(r.backupVersion,e,t);return this.logger.debug("Got key from backup for sessionId:".concat(t)),n}catch(e){if(this.stopped)throw new d(c.STOPPED);if(this.logger.info("No luck requesting key backup for session ".concat(t,": ").concat(e)),e instanceof o.MatrixError){let t=e.data.errcode;if("M_NOT_FOUND"==t)throw new d(c.MISSING_DECRYPTION_KEY);if("M_LIMIT_EXCEEDED"==t){let t=e.data.retry_after_ms;if(t>0)throw this.logger.info("Rate limited by server, waiting ".concat(t,"ms")),new u(t);throw new u(l)}}throw new d(c.NETWORK_ERROR)}}async decryptAndImport(e,t,r){let n={[e.megolmSessionId]:t},i=await r.decryptor.decryptSessions(n);for(let t of i)t.room_id=e.roomId;await this.backupManager.importBackedUpRoomKeys(i)}async getOrCreateBackupConfiguration(){if(this.configuration)return this.configuration;if(this.hasConfigurationProblem)return null;if(null!=this.currentBackupVersionCheck)return this.logger.debug("Already checking server version, use current promise"),await this.currentBackupVersionCheck;this.currentBackupVersionCheck=this.internalCheckFromServer();try{return await this.currentBackupVersionCheck}finally{this.currentBackupVersionCheck=null}}async internalCheckFromServer(){var e,t,r,n;let i=null;try{i=await this.backupManager.requestKeyBackupVersion()}catch(e){return this.logger.debug("Backup: error while checking server version: ".concat(e)),this.hasConfigurationProblem=!0,null}if(this.logger.debug("Got current backup version from server: ".concat(null===(e=i)||void 0===e?void 0:e.version)),(null===(t=i)||void 0===t?void 0:t.algorithm)!="m.megolm_backup.v1.curve25519-aes-sha2")return this.logger.info("Unsupported algorithm ".concat(null===(n=i)||void 0===n?void 0:n.algorithm)),this.hasConfigurationProblem=!0,null;if(!(null!==(r=i)&&void 0!==r&&r.version))return this.logger.info("No current key backup"),this.hasConfigurationProblem=!0,null;let o=await this.backupManager.getActiveBackupVersion();if(null==o||i.version!=o)return this.logger.info("The current backup version on the server (".concat(i.version,") is not trusted. Version we are currently backing up to: ").concat(o)),this.hasConfigurationProblem=!0,null;let s=i.auth_data,a=await this.getBackupDecryptionKey();if(!(null!=a&&a.decryptionKey))return this.logger.debug("Not checking key backup for session (no decryption key)"),this.hasConfigurationProblem=!0,null;if(o!=a.backupVersion)return this.logger.debug("Version for which we have a decryption key (".concat(a.backupVersion,") doesn't match the version we are backing up to (").concat(o,")")),this.hasConfigurationProblem=!0,null;if(s.public_key!=a.decryptionKey.megolmV1PublicKey.publicKeyBase64)return this.logger.debug("getBackupDecryptor key mismatch error"),this.hasConfigurationProblem=!0,null;let l=this.backupManager.createBackupDecryptor(a.decryptionKey);return this.hasConfigurationProblem=!1,this.configuration={decryptor:l,backupVersion:o},this.configuration}constructor(e,t,r,n){(0,i.default)(this,"stopped",!1),(0,i.default)(this,"configuration",null),(0,i.default)(this,"sessionLastCheckAttemptedTime",new Map),(0,i.default)(this,"downloadLoopRunning",!1),(0,i.default)(this,"queuedRequests",[]),(0,i.default)(this,"hasConfigurationProblem",!1),(0,i.default)(this,"currentBackupVersionCheck",null),(0,i.default)(this,"onBackupStatusChanged",()=>{this.hasConfigurationProblem=!1,this.configuration=null,this.getOrCreateBackupConfiguration().then(e=>{e&&this.downloadKeysLoop()})}),this.olmMachine=t,this.http=r,this.backupManager=n,this.logger=e.getChild("[PerSessionKeyBackupDownloader]"),n.on(s.CryptoEvent.KeyBackupStatus,this.onBackupStatusChanged),n.on(s.CryptoEvent.KeyBackupFailed,this.onBackupStatusChanged),n.on(s.CryptoEvent.KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}}t.PerSessionKeyBackupDownloader=h},52422:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomEncryptor=void 0,t.toRustHistoryVisibility=f;var i=n(r(13102)),o=h(r(24542)),s=o,a=r(15748),l=r(34002),c=r(36673),d=r(44480);function u(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(u=function(e){return e?r:t})(e)}function h(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=u(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}class p{onCryptoEvent(e){if(JSON.stringify(this.encryptionSettings)!=JSON.stringify(e))throw Error("Cannot reconfigure an active RoomEncryptor")}onRoomMembership(e){("join"==e.membership||"invite"==e.membership&&this.room.shouldEncryptForInvitedMembers())&&(0,d.logDuration)(this.prefixedLogger,"updateTrackedUsers",async()=>{this.olmMachine.updateTrackedUsers([new o.UserId(e.userId)]).catch(e=>{this.prefixedLogger.error("Unable to update tracked users",e)})})}async prepareForEncryption(e){await this.encryptEvent(null,e)}encryptEvent(e,t){var r;let n=new l.LogSpan(this.prefixedLogger,e?null!==(r=e.getTxnId())&&void 0!==r?r:"":"prepareForEncryption"),i=this.currentEncryptionPromise.catch(()=>{}).then(async()=>{await (0,d.logDuration)(n,"ensureEncryptionSession",async()=>{await this.ensureEncryptionSession(n,t)}),e&&await (0,d.logDuration)(n,"encryptEventInner",async()=>{await this.encryptEventInner(n,e)})});return this.currentEncryptionPromise=i,i}async ensureEncryptionSession(e,t){var r;if("m.megolm.v1.aes-sha2"!==this.encryptionSettings.algorithm)throw Error("Cannot encrypt in ".concat(this.room.roomId," for unsupported algorithm '").concat(this.encryptionSettings.algorithm,"'"));e.debug("Starting encryption");let n=await this.room.getEncryptionTargetMembers();this.lazyLoadedMembersResolved?(e.debug("Processing outgoing requests in background"),this.outgoingRequestManager.doProcessOutgoingRequests()):(await (0,d.logDuration)(this.prefixedLogger,"loadMembersIfNeeded: updateTrackedUsers",async()=>{await this.olmMachine.updateTrackedUsers(n.map(e=>new s.UserId(e.userId)))}),e.debug("Updated tracked users"),this.lazyLoadedMembersResolved=!0,e.debug("Processing outgoing requests"),await (0,d.logDuration)(this.prefixedLogger,"doProcessOutgoingRequests",async()=>{await this.outgoingRequestManager.doProcessOutgoingRequests()})),e.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(this.room.shouldEncryptForInvitedMembers(),"):"),n.map(e=>"".concat(e.userId," (").concat(e.membership,")")));let i=n.map(e=>new o.UserId(e.userId));await (0,d.logDuration)(this.prefixedLogger,"ensureSessionsForUsers",async()=>{await this.keyClaimManager.ensureSessionsForUsers(e,i)});let a=new o.EncryptionSettings;a.historyVisibility=f(this.room.getHistoryVisibility()),a.algorithm=o.EncryptionAlgorithm.MegolmV1AesSha2,"number"==typeof this.encryptionSettings.rotation_period_ms&&(a.rotationPeriod=BigInt(1e3*this.encryptionSettings.rotation_period_ms)),"number"==typeof this.encryptionSettings.rotation_period_msgs&&(a.rotationPeriodMessages=BigInt(this.encryptionSettings.rotation_period_msgs)),a.onlyAllowTrustedDevices=null!==(r=this.room.getBlacklistUnverifiedDevices())&&void 0!==r?r:t,await (0,d.logDuration)(this.prefixedLogger,"shareRoomKey",async()=>{let e=await this.olmMachine.shareRoomKey(new o.RoomId(this.room.roomId),i,a);if(e)for(let t of e)await this.outgoingRequestManager.outgoingRequestProcessor.makeOutgoingRequest(t)})}async forceDiscardSession(){await this.olmMachine.invalidateGroupSession(new o.RoomId(this.room.roomId))&&this.prefixedLogger.info("Discarded existing group session")}async encryptEventInner(e,t){e.debug("Encrypting actual message content");let r=await this.olmMachine.encryptRoomEvent(new o.RoomId(this.room.roomId),t.getType(),JSON.stringify(t.getContent()));t.makeEncrypted(a.EventType.RoomMessageEncrypted,JSON.parse(r),this.olmMachine.identityKeys.curve25519.toBase64(),this.olmMachine.identityKeys.ed25519.toBase64()),e.debug("Encrypted event successfully")}constructor(e,t,r,n,o){(0,i.default)(this,"lazyLoadedMembersResolved",!1),(0,i.default)(this,"currentEncryptionPromise",Promise.resolve()),this.olmMachine=e,this.keyClaimManager=t,this.outgoingRequestManager=r,this.room=n,this.encryptionSettings=o,this.prefixedLogger=l.logger.getChild("[".concat(n.roomId," encryption]"));let a=n.getJoinedMembers();this.olmMachine.updateTrackedUsers(a.map(e=>new s.UserId(e.userId))).catch(e=>this.prefixedLogger.error("Error initializing tracked users",e))}}function f(e){switch(e){case c.HistoryVisibility.Invited:return o.HistoryVisibility.Invited;case c.HistoryVisibility.Joined:return o.HistoryVisibility.Joined;case c.HistoryVisibility.Shared:return o.HistoryVisibility.Shared;case c.HistoryVisibility.WorldReadable:return o.HistoryVisibility.WorldReadable}}t.RoomEncryptor=p},83520:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RustBackupManager=t.RustBackupDecryptor=void 0,t.requestKeyBackupVersion=m;var i=n(r(13102)),o=h(r(24542)),s=r(34002),a=r(498),l=r(94161),c=r(44441),d=r(44480);function u(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(u=function(e){return e?r:t})(e)}function h(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=u(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}class p extends c.TypedEventEmitter{stop(){this.stopped=!0}async getActiveBackupVersion(){return await this.olmMachine.isBackupEnabled()?this.activeBackupVersion:null}async isKeyBackupTrusted(e){let t=await this.olmMachine.verifyBackup(e),r=await this.olmMachine.getBackupKeys(),n=null==r?void 0:r.decryptionKey;return{matchesDecryptionKey:!!n&&f(e,n),trusted:t.trusted()}}checkKeyBackupAndEnable(e){return!e&&this.checkedForBackup?Promise.resolve(null):(this.keyBackupCheckInProgress||(this.keyBackupCheckInProgress=this.doCheckKeyBackup().finally(()=>{this.keyBackupCheckInProgress=null})),this.keyBackupCheckInProgress)}async handleBackupSecretReceived(e){var t;let r=await this.checkKeyBackupAndEnable(!0);if(!(null!=r&&null!==(t=r.backupInfo)&&void 0!==t&&t.version)||!r.trustInfo.trusted)return s.logger.warn("handleBackupSecretReceived: Received a backup decryption key, but there is no trusted server-side key backup"),!1;try{let t=o.BackupDecryptionKey.fromBase64(e);if(!f(r.backupInfo,t))return s.logger.warn("handleBackupSecretReceived: Private decryption key does not match the public key of the current remote backup."),!1;return s.logger.info("handleBackupSecretReceived: A valid backup decryption key has been received and stored in cache."),await this.saveBackupDecryptionKey(t,r.backupInfo.version),!0}catch(e){s.logger.warn("handleBackupSecretReceived: Invalid backup decryption key",e)}return!1}async saveBackupDecryptionKey(e,t){await this.olmMachine.saveBackupDecryptionKey(e,t),this.emit(l.CryptoEvent.KeyBackupDecryptionKeyCached,t)}async importRoomKeys(e,t){let r=JSON.stringify(e);await this.olmMachine.importExportedRoomKeys(r,(e,r)=>{var n;let i={total:Number(r),successes:Number(e),stage:"load_keys",failures:0};null==t||null===(n=t.progressCallback)||void 0===n||n.call(t,i)})}async importBackedUpRoomKeys(e,t){let r=new Map;for(let t of e){let e=new o.RoomId(t.room_id);r.has(e)||r.set(e,new Map),r.get(e).set(t.session_id,t)}await this.olmMachine.importBackedUpRoomKeys(r,(e,r,n)=>{var i;let o={total:Number(r),successes:Number(e),stage:"load_keys",failures:Number(n)};null==t||null===(i=t.progressCallback)||void 0===i||i.call(t,o)})}async doCheckKeyBackup(){s.logger.log("Checking key backup status...");let e=null;try{e=await this.requestKeyBackupVersion()}catch(e){return s.logger.warn("Error checking for active key backup",e),null}this.checkedForBackup=!0,e&&!e.version&&s.logger.warn("active backup lacks a useful 'version'; ignoring it");let t=await this.getActiveBackupVersion();if(!e)return null!==t?(s.logger.log("No key backup present on server: disabling key backup"),await this.disableKeyBackup()):s.logger.log("No key backup present on server: not enabling key backup"),null;let r=await this.isKeyBackupTrusted(e);return r.trusted?null===t?(s.logger.log("Found usable key backup v".concat(e.version,": enabling key backups")),await this.enableKeyBackup(e)):t!==e.version?(s.logger.log("On backup version ".concat(t," but found version ").concat(e.version,": switching.")),await this.disableKeyBackup(),await this.enableKeyBackup(e)):s.logger.log("Backup version ".concat(e.version," still current")):null!==t?(s.logger.log("Key backup present on server but not trusted: disabling key backup"),await this.disableKeyBackup()):s.logger.log("Key backup present on server but not trusted: not enabling key backup"),{backupInfo:e,trustInfo:r}}async enableKeyBackup(e){await this.olmMachine.enableBackupV1(e.auth_data.public_key,e.version),this.activeBackupVersion=e.version,this.emit(l.CryptoEvent.KeyBackupStatus,!0),this.backupKeysLoop()}async maybeUploadKey(){null!=this.activeBackupVersion&&this.backupKeysLoop()}async disableKeyBackup(){await this.olmMachine.disableBackup(),this.activeBackupVersion=null,this.emit(l.CryptoEvent.KeyBackupStatus,!1)}async backupKeysLoop(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;if(this.backupKeysLoopRunning){s.logger.log("Backup loop already running");return}this.backupKeysLoopRunning=!0,s.logger.log("Backup: Starting keys upload loop for backup version:".concat(this.activeBackupVersion,"."));let t=Math.random()*e;await (0,d.sleep)(t);try{let e=0,t=null,r=!0;for(;!this.stopped;){let n=null;try{n=await (0,d.logDuration)(s.logger,"BackupRoomKeys: Get keys to backup from rust crypto-sdk",async()=>await this.olmMachine.backupRoomKeys())}catch(e){s.logger.error("Backup: Failed to get keys to backup from rust crypto-sdk",e)}if(!n||this.stopped||!this.activeBackupVersion){s.logger.log("Backup: Ending loop for version ".concat(this.activeBackupVersion,".")),n||this.emit(l.CryptoEvent.KeyBackupSessionsRemaining,0);return}try{if(await this.outgoingRequestProcessor.makeOutgoingRequest(n),e=0,this.stopped)break;if(!r&&null===t)try{let e=await this.olmMachine.roomKeyCounts();t=e.total-e.backedUp}catch(e){s.logger.error("Backup: Failed to get key counts from rust crypto-sdk",e)}if(null!==t){this.emit(l.CryptoEvent.KeyBackupSessionsRemaining,t);let e=this.keysCountInBatch(n);t=Math.max(t-e,0)}}catch(t){if(e++,s.logger.error("Backup: Error processing backup request for rust crypto-sdk",t),t instanceof a.MatrixError){let e=t.data.errcode;if("M_NOT_FOUND"==e||"M_WRONG_ROOM_KEYS_VERSION"==e){s.logger.log("Backup: Failed to upload keys to current vesion: ".concat(e,"."));try{await this.disableKeyBackup()}catch(e){s.logger.error("Backup: An error occurred while disabling key backup:",e)}this.emit(l.CryptoEvent.KeyBackupFailed,t.data.errcode),this.backupKeysLoopRunning=!1,this.checkKeyBackupAndEnable(!0);return}if("M_LIMIT_EXCEEDED"==e){let e=t.data.retry_after_ms;if(e>0){await (0,d.sleep)(e);continue}}}await (0,d.sleep)(1e3*Math.pow(2,Math.min(e-1,4)))}r=!1}}finally{this.backupKeysLoopRunning=!1}}keysCountInBatch(e){let t=JSON.parse(e.body),r=0;for(let{sessions:e}of Object.values(t.rooms))r+=Object.keys(e).length;return r}async requestKeyBackupVersion(){return await m(this.http)}async setupKeyBackup(e){await this.deleteAllKeyBackupVersions();let t=o.BackupDecryptionKey.createRandomKey(),r=t.megolmV1PublicKey,n={public_key:r.publicKeyBase64};await e(n);let i=await this.http.authedRequest(a.Method.Post,"/room_keys/version",void 0,{algorithm:r.algorithm,auth_data:n},{prefix:a.ClientPrefix.V3});return await this.saveBackupDecryptionKey(t,i.version),{version:i.version,algorithm:r.algorithm,authData:n,decryptionKey:t}}async deleteAllKeyBackupVersions(){var e,t,r,n;let i=null!==(e=null===(t=await this.requestKeyBackupVersion())||void 0===t?void 0:t.version)&&void 0!==e?e:null;for(;null!=i;)await this.deleteKeyBackupVersion(i),i=null!==(r=null===(n=await this.requestKeyBackupVersion())||void 0===n?void 0:n.version)&&void 0!==r?r:null}async deleteKeyBackupVersion(e){s.logger.debug("deleteKeyBackupVersion v:".concat(e));let t=(0,d.encodeUri)("/room_keys/version/$version",{$version:e});await this.http.authedRequest(a.Method.Delete,t,void 0,void 0,{prefix:a.ClientPrefix.V3})}createBackupDecryptor(e){return new g(e)}constructor(e,t,r){super(),(0,i.default)(this,"checkedForBackup",!1),(0,i.default)(this,"activeBackupVersion",null),(0,i.default)(this,"stopped",!1),(0,i.default)(this,"backupKeysLoopRunning",!1),(0,i.default)(this,"keyBackupCheckInProgress",null),this.olmMachine=e,this.http=t,this.outgoingRequestProcessor=r}}function f(e,t){var r;return"m.megolm_backup.v1.curve25519-aes-sha2"!==e.algorithm?(s.logger.warn("backupMatchesPrivateKey: Unsupported backup algorithm",e.algorithm),!1):(null===(r=e.auth_data)||void 0===r?void 0:r.public_key)===t.megolmV1PublicKey.publicKeyBase64}t.RustBackupManager=p;class g{async decryptSessions(e){let t=[];for(let[r,n]of Object.entries(e))try{let e=JSON.parse(this.decryptionKey.decryptV1(n.session_data.ephemeral,n.session_data.mac,n.session_data.ciphertext));e.session_id=r,t.push(e)}catch(e){s.logger.log("Failed to decrypt megolm session from backup",e,n)}return t}free(){this.decryptionKey.free()}constructor(e){this.decryptionKey=e,this.sourceTrusted=!1}}async function m(e){try{return await e.authedRequest(a.Method.Get,"/room_keys/version",void 0,void 0,{prefix:a.ClientPrefix.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}}t.RustBackupDecryptor=g},78043:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RUST_SDK_STORE_PREFIX=void 0,t.RUST_SDK_STORE_PREFIX="matrix-js-sdk"},90831:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deviceKeysToDeviceMap=l,t.downloadDeviceToJsDevice=c,t.rustDeviceToJsDevice=a;var n=s(r(24542)),i=r(74967);function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(o=function(e){return e?r:t})(e)}function s(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=o(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}function a(e,t){let r=new Map;for(let[t,n]of e.keys.entries())r.set(t.toString(),n.toBase64());let o=i.DeviceVerification.Unverified;e.isBlacklisted()?o=i.DeviceVerification.Blocked:e.isVerified()&&(o=i.DeviceVerification.Verified);let s=new Map,a=e.signatures.get(t);if(a){let e=new Map;for(let[t,r]of a.entries())r.isValid()&&r.signature&&e.set(t,r.signature.toBase64());s.set(t.toString(),e)}let l=e.algorithms,c=new Set;return l.forEach(e=>{switch(e){case n.EncryptionAlgorithm.MegolmV1AesSha2:c.add("m.megolm.v1.aes-sha2");break;case n.EncryptionAlgorithm.OlmV1Curve25519AesSha2:default:c.add("m.olm.v1.curve25519-aes-sha2")}}),new i.Device({deviceId:e.deviceId.toString(),userId:t.toString(),keys:r,algorithms:Array.from(c),verified:o,signatures:s,displayName:e.displayName})}function l(e){return new Map(Object.entries(e).map(e=>{let[t,r]=e;return[t,c(r)]}))}function c(e){var t;let r=new Map(Object.entries(e.keys)),n=null===(t=e.unsigned)||void 0===t?void 0:t.device_display_name,o=new Map;if(e.signatures)for(let t in e.signatures)o.set(t,new Map(Object.entries(e.signatures[t])));return new i.Device({deviceId:e.device_id,userId:e.user_id,keys:r,algorithms:e.algorithms,verified:i.DeviceVerification.Unverified,signatures:o,displayName:n})}},43542:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.initRustCrypto=p;var i=n(r(13102)),o=d(r(24542)),s=o,a=r(38499),l=r(97915);function c(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(c=function(e){return e?r:t})(e)}function d(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=c(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}async function p(e){var t,r;let{logger:n}=e;n.debug("Initialising Rust crypto-sdk WASM artifact"),await s.initAsync(),new s.Tracing(s.LoggerLevel.Debug).turnOn(),n.debug("Opening Rust CryptoStore");let i=await o.StoreHandle.open(null!==(t=e.storePrefix)&&void 0!==t?t:void 0,null!==(r=e.storePrefix&&e.storePassphrase)&&void 0!==r?r:void 0);e.legacyCryptoStore&&await (0,l.migrateFromLegacyCrypto)(h({legacyStore:e.legacyCryptoStore,storeHandle:i},e));let a=await f(n,e.http,e.userId,e.deviceId,e.secretStorage,e.cryptoCallbacks,i,e.legacyCryptoStore);return i.free(),n.debug("Completed rust crypto-sdk setup"),a}async function f(e,t,r,n,i,o,c,d){e.debug("Init OlmMachine");let u=await s.OlmMachine.initFromStore(new s.UserId(r),new s.DeviceId(n),c);d&&await (0,l.migrateRoomSettingsFromLegacyCrypto)({logger:e,legacyStore:d,olmMachine:u}),u.roomKeyRequestsEnabled=!1;let h=new a.RustCrypto(e,u,t,r,n,i,o);return await u.registerRoomKeyUpdatedCallback(e=>h.onRoomKeysUpdated(e)),await u.registerUserIdentityUpdatedCallback(e=>h.onUserIdentityUpdated(e)),await u.registerDevicesUpdatedCallback(e=>h.onDevicesUpdated(e)),h.checkSecrets("m.megolm_backup.v1"),await u.registerReceiveSecretCallback((e,t)=>h.checkSecrets(e)),await u.outgoingRequests(),h}},97915:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrateFromLegacyCrypto=d,t.migrateRoomSettingsFromLegacyCrypto=m;var n=c(r(24542)),i=r(77705),o=r(87786),s=r(54410),a=r(83520);function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(l=function(e){return e?r:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=l(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}async function d(e){var t;let{logger:r,legacyStore:o}=e;if(await n.initAsync(),new n.Tracing(n.LoggerLevel.Debug).turnOn(),!await o.containsData())return;await o.startup();let s=await o.getMigrationState();if(s>=i.MigrationState.MEGOLM_SESSIONS_MIGRATED)return;let a=await h(r,o),l=await p(r,o),c=1+a+l;r.info("Migrating data from legacy crypto store. ".concat(a," olm sessions and ").concat(l," megolm sessions to migrate."));let d=0;function m(t){var r;d+=t,null===(r=e.legacyMigrationProgressListener)||void 0===r||r.call(e,d,c)}m(0);let v=new TextEncoder().encode(e.legacyPickleKey);s===i.MigrationState.NOT_STARTED&&(r.info("Migrating data from legacy crypto store. Step 1: base data"),await u(e.http,e.userId,e.deviceId,o,v,e.storeHandle),s=i.MigrationState.INITIAL_DATA_MIGRATED,await o.setMigrationState(s)),m(1),s===i.MigrationState.INITIAL_DATA_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 2: olm sessions (".concat(a," sessions to migrate).")),await f(r,o,v,e.storeHandle,m),s=i.MigrationState.OLM_SESSIONS_MIGRATED,await o.setMigrationState(s)),s===i.MigrationState.OLM_SESSIONS_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 3: megolm sessions (".concat(l," sessions to migrate).")),await g(r,o,v,e.storeHandle,m),s=i.MigrationState.MEGOLM_SESSIONS_MIGRATED,await o.setMigrationState(s)),null===(t=e.legacyMigrationProgressListener)||void 0===t||t.call(e,-1,-1),r.info("Migration from legacy crypto store complete")}async function u(e,t,r,i,s,l){let c=new n.BaseMigrationData;c.userId=new n.UserId(t),c.deviceId=new n.DeviceId(r),await i.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_ACCOUNT],e=>i.getAccount(e,e=>{c.pickledAccount=null!=e?e:""}));let d=await v(i,s,"m.megolm_backup.v1");if(d){let t=await (0,a.requestKeyBackupVersion)(e);t&&(c.backupVersion=t.version,c.backupRecoveryKey=d)}c.privateCrossSigningMasterKey=await v(i,s,"master"),c.privateCrossSigningSelfSigningKey=await v(i,s,"self_signing"),c.privateCrossSigningUserSigningKey=await v(i,s,"user_signing"),await n.Migration.migrateBaseData(c,s,l)}async function h(e,t){let r;return e.debug("Counting olm sessions to be migrated"),await t.doTxn("readonly",[o.IndexedDBCryptoStore.STORE_SESSIONS],e=>t.countEndToEndSessions(e,e=>r=e)),r}async function p(e,t){return e.debug("Counting megolm sessions to be migrated"),await t.countEndToEndInboundGroupSessions()}async function f(e,t,r,i,o){for(;;){let s=await t.getEndToEndSessionsBatch();if(null===s)return;e.debug("Migrating batch of ".concat(s.length," olm sessions"));let a=[];for(let e of s){let t=new n.PickledSession;t.senderKey=e.deviceKey,t.pickle=e.session,t.lastUseTime=t.creationTime=new Date(e.lastReceivedMessageTs),a.push(t)}await n.Migration.migrateOlmSessions(a,r,i),await t.deleteEndToEndSessionsBatch(s),o(s.length)}}async function g(e,t,r,i,o){for(;;){let a=await t.getEndToEndInboundGroupSessionsBatch();if(null===a)return;e.debug("Migrating batch of ".concat(a.length," megolm sessions"));let l=[];for(let e of a){var s;let t=e.sessionData,r=new n.PickledInboundGroupSession;r.pickle=t.session,r.roomId=new n.RoomId(t.room_id),r.senderKey=e.senderKey,r.senderSigningKey=null===(s=t.keysClaimed)||void 0===s?void 0:s.ed25519,r.backedUp=!e.needsBackup,r.imported=!0===t.untrusted,l.push(r)}await n.Migration.migrateMegolmSessions(l,r,i),await t.deleteEndToEndInboundGroupSessionsBatch(a),o(a.length)}}async function m(e){let{logger:t,legacyStore:r,olmMachine:s}=e;if(!await r.containsData()||await r.getMigrationState()>=i.MigrationState.ROOM_SETTINGS_MIGRATED)return;let a={};for(let[e,i]of(await r.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],e=>{r.getEndToEndRooms(e,e=>{a=e})}),t.debug("Migrating ".concat(Object.keys(a).length," sets of room settings")),Object.entries(a)))try{let r=new n.RoomSettings;if("m.megolm.v1.aes-sha2"!==i.algorithm){t.warn("Room ".concat(e,": ignoring room with invalid algorithm ").concat(i.algorithm));continue}r.algorithm=n.EncryptionAlgorithm.MegolmV1AesSha2,r.sessionRotationPeriodMs=i.rotation_period_ms,r.sessionRotationPeriodMessages=i.rotation_period_msgs,await s.setRoomSettings(new n.RoomId(e),r)}catch(r){t.warn("Room ".concat(e,": ignoring settings ").concat(JSON.stringify(i)," which caused error ").concat(r))}t.debug("Completed room settings migration"),await r.setMigrationState(i.MigrationState.ROOM_SETTINGS_MIGRATED)}async function v(e,t,r){let n=null;return await e.doTxn("readonly","account",t=>{e.getSecretStorePrivateKey(t,e=>{n=e},r)}),null===n?void 0:await (0,s.decryptAES)(n,t,r)}},38499:function(e,t,r){"use strict";var n=r(31180).Buffer,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RustCrypto=void 0;var o=i(r(13102)),s=i(r(6691)),a=U(r(24542)),l=r(39325),c=r(34002),d=r(498),u=r(52422),h=r(73414),p=r(99996),f=r(44480),g=r(68995),m=r(90831),v=r(98466),y=r(16318),b=r(26952),S=r(53978),E=r(41806),_=r(20763),w=r(42704),T=r(15748),I=r(94161),O=r(44441),R=r(83520),C=r(92807),k=r(89027),M=r(74460),P=r(98870),A=r(22079),D=r(67826),x=r(81293);function j(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(j=function(e){return e?r:t})(e)}function U(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=j(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function N(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?L(Object(r),!0).forEach(function(t){(0,o.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):L(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let B=["m.sas.v1","m.qr_code.scan.v1","m.qr_code.show.v1","m.reciprocate.v1"];class F extends O.TypedEventEmitter{getOlmMachineOrThrow(){if(this.stopped)throw new M.ClientStoppedError;return this.olmMachine}set globalErrorOnUnknownDevices(e){}get globalErrorOnUnknownDevices(){return!1}stop(){this.stopped||(this.stopped=!0,this.keyClaimManager.stop(),this.backupManager.stop(),this.outgoingRequestsManager.stop(),this.perSessionBackupDownloader.stop(),this.olmMachine.close())}async encryptEvent(e,t){let r=e.getRoomId(),n=this.roomEncryptors[r];if(!n)throw Error("Cannot encrypt event in unconfigured room ".concat(r));await n.encryptEvent(e,this.globalBlacklistUnverifiedDevices)}async decryptEvent(e){if(!e.getRoomId())throw Error("to-device event was not decrypted in preprocessToDeviceMessages");return await this.eventDecryptor.attemptEventDecryption(e)}getEventEncryptionInfo(e){var t;let r={};return(r.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,r.algorithm=e.getWireContent().algorithm,r.senderKey&&r.algorithm)?(r.encrypted=!0,r.authenticated=!0,r.mismatchedSender=!0):r.encrypted=!1,r}checkUserTrust(e){return new g.UserVerificationStatus(!1,!1,!1)}getStoredCrossSigningForUser(e){return null}async checkOwnCrossSigningTrust(){}getVersion(){let e=a.getVersions();return"Rust SDK ".concat(e.matrix_sdk_crypto," (").concat(e.git_sha,"), Vodozemac ").concat(e.vodozemac)}async isEncryptionEnabledInRoom(e){let t=await this.olmMachine.getRoomSettings(new a.RoomId(e));return!!(null==t?void 0:t.algorithm)}async getOwnDeviceKeys(){let e=this.olmMachine.identityKeys;return{ed25519:e.ed25519.toBase64(),curve25519:e.curve25519.toBase64()}}prepareToEncrypt(e){let t=this.roomEncryptors[e.roomId];t&&t.prepareForEncryption(this.globalBlacklistUnverifiedDevices)}forceDiscardSession(e){var t;return null===(t=this.roomEncryptors[e])||void 0===t?void 0:t.forceDiscardSession()}async exportRoomKeys(){return JSON.parse(await this.olmMachine.exportRoomKeys(()=>!0))}async importRoomKeys(e,t){return await this.backupManager.importRoomKeys(e,t)}async userHasCrossSigningKeys(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.userId,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(let r of(await this.olmMachine.trackedUsers()))if(t===r.toString()){e=r;break}if(void 0!==e){if(t===this.userId){let t=this.olmMachine.queryKeysForUsers([e.clone()]);await this.outgoingRequestProcessor.makeOutgoingRequest(t)}let r=await this.olmMachine.getIdentity(e);return null==r||r.free(),void 0!==r}if(!r)return!1;{var n;let e=null===(n=(await this.downloadDeviceList(new Set([t]))).master_keys)||void 0===n?void 0:n[t];return!!e&&!!Object.values(e.keys)[0]}}async getUserDeviceInfo(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=new Map,n=await this.getOlmMachineOrThrow().trackedUsers(),i=new Set;n.forEach(e=>i.add(e.toString()));let o=new Set;for(let t of e)i.has(t)?r.set(t,await this.getUserDevices(t)):o.add(t);return t&&o.size>=1&&Object.entries((await this.downloadDeviceList(o)).device_keys).forEach(e=>{let[t,n]=e;return r.set(t,(0,m.deviceKeysToDeviceMap)(n))}),r}async getUserDevices(e){let t=new a.UserId(e),r=await this.olmMachine.getUserDevices(t,1);try{let e=r.devices();try{return new Map(e.map(e=>[e.deviceId.toString(),(0,m.rustDeviceToJsDevice)(e,t)]))}finally{e.forEach(e=>e.free())}}finally{r.free()}}async downloadDeviceList(e){let t={device_keys:{}};return e.forEach(e=>t.device_keys[e]=[]),await this.http.authedRequest(d.Method.Post,"/_matrix/client/v3/keys/query",void 0,t,{prefix:""})}getTrustCrossSignedDevices(){return this._trustCrossSignedDevices}setTrustCrossSignedDevices(e){this._trustCrossSignedDevices=e}async setDeviceVerified(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=await this.olmMachine.getDevice(new a.UserId(e),new a.DeviceId(t));if(!n)throw Error("Unknown device ".concat(e,"|").concat(t));try{await n.setLocalTrust(r?a.LocalTrust.Verified:a.LocalTrust.Unset)}finally{n.free()}}async crossSignDevice(e){let t=await this.olmMachine.getDevice(new a.UserId(this.userId),new a.DeviceId(e));if(!t)throw Error("Unknown device ".concat(e));try{let e=await t.verify();await this.outgoingRequestProcessor.makeOutgoingRequest(e)}finally{t.free()}}async getDeviceVerificationStatus(e,t){let r=await this.olmMachine.getDevice(new a.UserId(e),new a.DeviceId(t));if(!r)return null;try{return new g.DeviceVerificationStatus({signedByOwner:r.isCrossSignedByOwner(),crossSigningVerified:r.isCrossSigningTrusted(),localVerified:r.isLocallyTrusted(),trustCrossSignedDevices:this._trustCrossSignedDevices})}finally{r.free()}}async getUserVerificationStatus(e){let t=await this.getOlmMachineOrThrow().getIdentity(new a.UserId(e));if(void 0===t)return new g.UserVerificationStatus(!1,!1,!1);let r=t.isVerified();return t.free(),new g.UserVerificationStatus(r,!1,!1)}async isCrossSigningReady(){let{publicKeysOnDevice:e,privateKeysInSecretStorage:t,privateKeysCachedLocally:r}=await this.getCrossSigningStatus(),n=!!r.masterKey&&!!r.selfSigningKey&&!!r.userSigningKey;return e&&(n||t)}async getCrossSigningKeyId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g.CrossSigningKey.Master,t=await this.olmMachine.getIdentity(new a.UserId(this.userId));if(!t)return null;try{let r;let n=await this.olmMachine.crossSigningStatus();if(!(n.hasMaster&&n.hasUserSigning&&n.hasSelfSigning)||!t.isVerified())return null;switch(e){case g.CrossSigningKey.Master:r=t.masterKey;break;case g.CrossSigningKey.SelfSigning:r=t.selfSigningKey;break;case g.CrossSigningKey.UserSigning:r=t.userSigningKey;break;default:return null}let i=JSON.parse(r);return Object.values(i.keys)[0]}finally{t.free()}}async bootstrapCrossSigning(e){await this.crossSigningIdentity.bootstrapCrossSigning(e)}async isSecretStorageReady(){let e=["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"];return await this.backupManager.getActiveBackupVersion()!=null&&e.push("m.megolm_backup.v1"),(0,b.secretStorageCanAccessSecrets)(this.secretStorage,e)}async bootstrapSecretStorage(){let{createSecretStorageKey:e,setupNewSecretStorage:t,setupNewKeyBackup:r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t||!await this.secretStorageHasAESKey();if(n){if(!e)throw Error("unable to create a new secret storage key, createSecretStorageKey is not set");this.logger.info("bootstrapSecretStorage: creating new secret storage key");let t=await e();await this.addSecretStorageKeyToSecretStorage(t)}let i=await this.olmMachine.crossSigningStatus();if(i.hasMaster&&i.hasSelfSigning&&i.hasUserSigning&&(n||!await (0,b.secretStorageContainsCrossSigningKeys)(this.secretStorage))){this.logger.info("bootstrapSecretStorage: cross-signing keys not yet exported; doing so now.");let e=await this.olmMachine.exportCrossSigningKeys();if(!e.masterKey)throw Error("missing master key in cross signing private keys");if(!e.userSigningKey)throw Error("missing user signing key in cross signing private keys");if(!e.self_signing_key)throw Error("missing self signing key in cross signing private keys");await this.secretStorage.store("m.cross_signing.master",e.masterKey),await this.secretStorage.store("m.cross_signing.user_signing",e.userSigningKey),await this.secretStorage.store("m.cross_signing.self_signing",e.self_signing_key)}r&&await this.resetKeyBackup()}async addSecretStorageKeyToSecretStorage(e){var t,r,n,i;let o=await this.secretStorage.addKey(v.SECRET_STORAGE_ALGORITHM_V1_AES,{passphrase:null===(t=e.keyInfo)||void 0===t?void 0:t.passphrase,name:null===(r=e.keyInfo)||void 0===r?void 0:r.name,key:e.privateKey});await this.secretStorage.setDefaultKeyId(o.keyId),null===(n=(i=this.cryptoCallbacks).cacheSecretStorageKey)||void 0===n||n.call(i,o.keyId,o.keyInfo,e.privateKey)}async secretStorageHasAESKey(){let e=await this.secretStorage.getKey();if(!e)return!1;let[,t]=e;return t.algorithm===v.SECRET_STORAGE_ALGORITHM_V1_AES}async getCrossSigningStatus(){let e=await this.getOlmMachineOrThrow().getIdentity(new a.UserId(this.userId)),t=!!(null==e?void 0:e.masterKey)&&!!(null==e?void 0:e.selfSigningKey)&&!!(null==e?void 0:e.userSigningKey);null==e||e.free();let r=await (0,b.secretStorageContainsCrossSigningKeys)(this.secretStorage),n=await this.getOlmMachineOrThrow().crossSigningStatus();return{publicKeysOnDevice:t,privateKeysInSecretStorage:r,privateKeysCachedLocally:{masterKey:!!(null==n?void 0:n.hasMaster),userSigningKey:!!(null==n?void 0:n.hasUserSigning),selfSigningKey:!!(null==n?void 0:n.hasSelfSigning)}}}async createRecoveryKeyFromPassphrase(e){if(e){let t=await (0,S.keyFromPassphrase)(e);return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:t.iterations,salt:t.salt}},privateKey:t.key,encodedPrivateKey:(0,E.encodeRecoveryKey)(t.key)}}{let e=new Uint8Array(32);return _.crypto.getRandomValues(e),{privateKey:e,encodedPrivateKey:(0,E.encodeRecoveryKey)(e)}}}async getEncryptionInfoForEvent(e){return this.eventDecryptor.getEncryptionInfoForEvent(e)}getVerificationRequestsToDeviceInProgress(e){return this.olmMachine.getVerificationRequests(new a.UserId(e)).filter(e=>void 0===e.roomId).map(e=>new w.RustVerificationRequest(this.olmMachine,e,this.outgoingRequestProcessor,this._supportedVerificationMethods))}findVerificationRequestDMInProgress(e,t){if(!t)throw Error("missing userId");let r=this.olmMachine.getVerificationRequests(new a.UserId(t)).find(t=>{var r;return(null===(r=t.roomId)||void 0===r?void 0:r.toString())===e});if(r)return new w.RustVerificationRequest(this.olmMachine,r,this.outgoingRequestProcessor,this._supportedVerificationMethods)}async requestVerificationDM(e,t){let r=await this.olmMachine.getIdentity(new a.UserId(e));if(!r)throw Error("unknown userId ".concat(e));try{let e=this._supportedVerificationMethods.map(e=>(0,w.verificationMethodIdentifierToMethod)(e)),n=await r.verificationRequestContent(e),i=await this.sendVerificationRequestContent(t,n),o=await r.requestVerification(new a.RoomId(t),new a.EventId(i),e);return new w.RustVerificationRequest(this.olmMachine,o,this.outgoingRequestProcessor,this._supportedVerificationMethods)}finally{r.free()}}async sendVerificationRequestContent(e,t){let r=(0,k.randomString)(32),{event_id:n}=await this.http.authedRequest(d.Method.Put,"/_matrix/client/v3/rooms/".concat(encodeURIComponent(e),"/send/m.room.message/").concat(encodeURIComponent(r)),void 0,t,{prefix:""});return n}setSupportedVerificationMethods(e){this._supportedVerificationMethods=null!=e?e:B}async requestOwnUserVerification(){let e=await this.olmMachine.getIdentity(new a.UserId(this.userId));if(void 0===e)throw Error("cannot request verification for this device when there is no existing cross-signing key");try{let[t,r]=await e.requestVerification(this._supportedVerificationMethods.map(w.verificationMethodIdentifierToMethod));return await this.outgoingRequestProcessor.makeOutgoingRequest(r),new w.RustVerificationRequest(this.olmMachine,t,this.outgoingRequestProcessor,this._supportedVerificationMethods)}finally{e.free()}}async requestDeviceVerification(e,t){let r=await this.olmMachine.getDevice(new a.UserId(e),new a.DeviceId(t));if(!r)throw Error("Not a known device");try{let[e,t]=await r.requestVerification(this._supportedVerificationMethods.map(w.verificationMethodIdentifierToMethod));return await this.outgoingRequestProcessor.makeOutgoingRequest(t),new w.RustVerificationRequest(this.olmMachine,e,this.outgoingRequestProcessor,this._supportedVerificationMethods)}finally{r.free()}}async getSessionBackupPrivateKey(){let e=await this.olmMachine.getBackupKeys();return e.decryptionKey?n.from(e.decryptionKey.toBase64(),"base64"):null}async storeSessionBackupPrivateKey(e,t){let r=(0,P.encodeBase64)(e);if(!t)throw Error("storeSessionBackupPrivateKey: version is required");await this.backupManager.saveBackupDecryptionKey(a.BackupDecryptionKey.fromBase64(r),t)}async getActiveSessionBackupVersion(){return await this.backupManager.getActiveBackupVersion()}async isKeyBackupTrusted(e){return await this.backupManager.isKeyBackupTrusted(e)}async checkKeyBackupAndEnable(){return await this.backupManager.checkKeyBackupAndEnable(!0)}async deleteKeyBackupVersion(e){await this.backupManager.deleteKeyBackupVersion(e)}async resetKeyBackup(){let e=await this.backupManager.setupKeyBackup(e=>this.signObject(e));await this.secretStorageHasAESKey()&&await this.secretStorage.store("m.megolm_backup.v1",e.decryptionKey.toBase64()),this.checkKeyBackupAndEnable()}async signObject(e){let t=new Map(Object.entries(e.signatures||{})),r=e.unsigned;delete e.signatures,delete e.unsigned;let n=t.get(this.userId)||{},i=s.default.stringify(e),o=JSON.parse((await this.olmMachine.sign(i)).asJSON());t.set(this.userId,N(N({},n),o[this.userId])),void 0!==r&&(e.unsigned=r),e.signatures=Object.fromEntries(t.entries())}async getBackupDecryptor(e,t){if("m.megolm_backup.v1.curve25519-aes-sha2"!=e.algorithm)throw Error("getBackupDecryptor Unsupported algorithm ".concat(e.algorithm));let r=e.auth_data;if(!(t instanceof Uint8Array))throw Error("getBackupDecryptor expects Uint8Array");let n=a.BackupDecryptionKey.fromBase64((0,P.encodeBase64)(t));if(r.public_key!=n.megolmV1PublicKey.publicKeyBase64)throw Error("getBackupDecryptor key mismatch error");return this.backupManager.createBackupDecryptor(n)}async importBackedUpRoomKeys(e,t){return await this.backupManager.importBackedUpRoomKeys(e,t)}async receiveSyncChanges(e){let{events:t,oneTimeKeysCounts:r=new Map,unusedFallbackKeys:n,devices:i=new a.DeviceLists}=e;return JSON.parse(await (0,f.logDuration)(c.logger,"receiveSyncChanges",async()=>await this.olmMachine.receiveSyncChanges(t?JSON.stringify(t):"[]",i,r,n)))}async preprocessToDeviceMessages(e){let t=await this.receiveSyncChanges({events:e});for(let e of t)e.type===T.EventType.KeyVerificationRequest&&this.onIncomingKeyVerificationRequest(e.sender,e.content);return t}async processKeyCounts(e,t){let r=e&&new Map(Object.entries(e)),n=t&&new Set(t);(void 0!==r||void 0!==n)&&await this.receiveSyncChanges({oneTimeKeysCounts:r,unusedFallbackKeys:n})}async processDeviceLists(e){var t,r;let n=new a.DeviceLists(null===(t=e.changed)||void 0===t?void 0:t.map(e=>new a.UserId(e)),null===(r=e.left)||void 0===r?void 0:r.map(e=>new a.UserId(e)));await this.receiveSyncChanges({devices:n})}async onCryptoEvent(e,t){let r=t.getContent(),n=new a.RoomSettings;if("m.megolm.v1.aes-sha2"===r.algorithm)n.algorithm=a.EncryptionAlgorithm.MegolmV1AesSha2;else{this.logger.warn("Room ".concat(e.roomId,": ignoring crypto event with invalid algorithm ").concat(r.algorithm));return}try{n.sessionRotationPeriodMs=r.rotation_period_ms,n.sessionRotationPeriodMessages=r.rotation_period_msgs,await this.olmMachine.setRoomSettings(new a.RoomId(e.roomId),n)}catch(t){this.logger.warn("Room ".concat(e.roomId,": ignoring crypto event which caused error: ").concat(t));return}let i=this.roomEncryptors[e.roomId];i?i.onCryptoEvent(r):this.roomEncryptors[e.roomId]=new u.RoomEncryptor(this.olmMachine,this.keyClaimManager,this.outgoingRequestsManager,e,r)}onSyncCompleted(e){this.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{this.logger.warn("onSyncCompleted: Error processing outgoing requests",e)})}onIncomingKeyVerificationRequest(e,t){let r=t.transaction_id;if(!r||!e)return;let n=this.olmMachine.getVerificationRequest(new a.UserId(e),r);n&&this.emit(I.CryptoEvent.VerificationRequestReceived,new w.RustVerificationRequest(this.olmMachine,n,this.outgoingRequestProcessor,this._supportedVerificationMethods))}onRoomMembership(e,t,r){let n=this.roomEncryptors[e.getRoomId()];n&&n.onRoomMembership(t)}async onRoomKeysUpdated(e){for(let t of e)this.onRoomKeyUpdated(t);this.backupManager.maybeUploadKey()}onRoomKeyUpdated(e){if(this.stopped)return;this.logger.debug("Got update for session ".concat(e.senderKey.toBase64(),"|").concat(e.sessionId," in ").concat(e.roomId.toString()));let t=this.eventDecryptor.getEventsPendingRoomKey(e);if(0!==t.length)for(let e of(this.logger.debug("Retrying decryption on events:",t.map(e=>"".concat(e.getId()))),t))e.attemptDecryption(this,{isRetry:!0}).catch(t=>{this.logger.info("Still unable to decrypt event ".concat(e.getId()," after receiving key"))})}async onUserIdentityUpdated(e){let t=await this.getUserVerificationStatus(e.toString());this.emit(I.CryptoEvent.UserTrustStatusChanged,e.toString(),t),e.toString()===this.userId&&(this.emit(I.CryptoEvent.KeysChanged,{}),await this.checkKeyBackupAndEnable())}async onDevicesUpdated(e){this.emit(I.CryptoEvent.WillUpdateDevices,e,!1),this.emit(I.CryptoEvent.DevicesUpdated,e,!1)}async handleSecretReceived(e,t){return this.logger.debug("onReceiveSecret: Received secret ".concat(e)),"m.megolm_backup.v1"===e&&await this.backupManager.handleBackupSecretReceived(t)}async checkSecrets(e){for(let t of(await this.olmMachine.getSecretsFromInbox(e)))if(await this.handleSecretReceived(e,t))break;await this.olmMachine.deleteSecretsFromInbox(e)}async onLiveEventFromSync(e){if(e.isState()||e.getUnsigned().transaction_id)return;let t=async t=>{(0,w.isVerificationEvent)(e)&&await this.onKeyVerificationRequest(t)};if(e.isDecryptionFailure()||e.isEncrypted()){let r=setTimeout(()=>e.off(l.MatrixEventEvent.Decrypted,n),3e5),n=(i,o)=>{o||(clearTimeout(r),e.off(l.MatrixEventEvent.Decrypted,n),t(i))};e.on(l.MatrixEventEvent.Decrypted,n)}else await t(e)}async onKeyVerificationRequest(e){let t=e.getRoomId();if(!t)throw Error("missing roomId in the event");if(this.logger.debug("Incoming verification event ".concat(e.getId()," type ").concat(e.getType()," from ").concat(e.getSender())),await this.olmMachine.receiveVerificationEvent(JSON.stringify({event_id:e.getId(),type:e.getType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getContent(),origin_server_ts:e.getTs()}),new a.RoomId(t)),e.getType()===T.EventType.RoomMessage&&e.getContent().msgtype===T.MsgType.KeyVerificationRequest){let t=this.olmMachine.getVerificationRequest(new a.UserId(e.getSender()),e.getId());t?this.emit(I.CryptoEvent.VerificationRequestReceived,new w.RustVerificationRequest(this.olmMachine,t,this.outgoingRequestProcessor,this._supportedVerificationMethods)):this.logger.info("Ignoring just-received verification request ".concat(e.getId()," which did not start a rust-side verification"))}this.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{this.logger.warn("onKeyVerificationRequest: Error processing outgoing requests",e)})}constructor(e,t,r,n,i,s,a){super(),(0,o.default)(this,"_trustCrossSignedDevices",!0),(0,o.default)(this,"stopped",!1),(0,o.default)(this,"roomEncryptors",{}),(0,o.default)(this,"reemitter",new C.TypedReEmitter(this)),(0,o.default)(this,"globalBlacklistUnverifiedDevices",!1),(0,o.default)(this,"_supportedVerificationMethods",B),this.logger=e,this.olmMachine=t,this.http=r,this.userId=n,this.secretStorage=s,this.cryptoCallbacks=a,this.outgoingRequestProcessor=new h.OutgoingRequestProcessor(t,r),this.outgoingRequestsManager=new D.OutgoingRequestsManager(this.logger,t,this.outgoingRequestProcessor),this.keyClaimManager=new p.KeyClaimManager(t,this.outgoingRequestProcessor),this.backupManager=new R.RustBackupManager(t,r,this.outgoingRequestProcessor),this.perSessionBackupDownloader=new x.PerSessionKeyBackupDownloader(this.logger,this.olmMachine,this.http,this.backupManager),this.eventDecryptor=new K(this.logger,t,this.perSessionBackupDownloader),this.reemitter.reEmit(this.backupManager,[I.CryptoEvent.KeyBackupStatus,I.CryptoEvent.KeyBackupSessionsRemaining,I.CryptoEvent.KeyBackupFailed,I.CryptoEvent.KeyBackupDecryptionKeyCached]),this.crossSigningIdentity=new y.CrossSigningIdentity(t,this.outgoingRequestProcessor,s),this.checkKeyBackupAndEnable()}}t.RustCrypto=F;class K{async attemptEventDecryption(e){this.addEventToPendingList(e);try{let t=await this.olmMachine.decryptRoomEvent(q(e),new a.RoomId(e.getRoomId()));return this.removeEventFromPendingList(e),{clearEvent:JSON.parse(t.event),claimedEd25519Key:t.senderClaimedEd25519Key,senderCurve25519Key:t.senderCurve25519Key,forwardingCurve25519KeyChain:t.forwardingCurve25519KeyChain}}catch(t){if(t instanceof a.MegolmDecryptionError){let r;let n=e.getWireContent();switch(t.code){case a.DecryptionErrorCode.MissingRoomKey:r=new A.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:n.sender_key+"|"+n.session_id}),this.perSessionBackupDownloader.onDecryptionKeyMissingError(e.getRoomId(),e.getWireContent().session_id);break;case a.DecryptionErrorCode.UnknownMessageIndex:r=new A.DecryptionError("OLM_UNKNOWN_MESSAGE_INDEX","The sender's device has not sent us the keys for this message at this index.",{session:n.sender_key+"|"+n.session_id}),this.perSessionBackupDownloader.onDecryptionKeyMissingError(e.getRoomId(),e.getWireContent().session_id);break;default:r=new A.DecryptionError("UNABLE_TO_DECRYPT",t.description,{session:n.sender_key+"|"+n.session_id})}throw r}throw new A.DecryptionError("UNABLE_TO_DECRYPT","Unknown error")}}async getEncryptionInfoForEvent(e){if(!e.getClearContent()||e.isDecryptionFailure())return null;if(null!==e.status)return{shieldColour:g.EventShieldColour.NONE,shieldReason:null};let t=await this.olmMachine.getRoomEventEncryptionInfo(q(e),new a.RoomId(e.getRoomId()));return V(this.logger,t)}getEventsPendingRoomKey(e){let t=this.eventsPendingKey.get(e.senderKey.toBase64());if(!t)return[];let r=t.get(e.sessionId);if(!r)return[];let n=e.roomId.toString();return[...r].filter(e=>e.getRoomId()===n)}addEventToPendingList(e){let t=e.getWireContent(),r=t.sender_key,n=t.session_id;this.eventsPendingKey.getOrCreate(r).getOrCreate(n).add(e)}removeEventFromPendingList(e){let t=e.getWireContent(),r=t.sender_key,n=t.session_id,i=this.eventsPendingKey.get(r);if(!i)return;let o=i.get(n);o&&(o.delete(e),0===o.size&&(i.delete(n),0===i.size&&this.eventsPendingKey.delete(r)))}constructor(e,t,r){(0,o.default)(this,"eventsPendingKey",new f.MapWithDefault(()=>new f.MapWithDefault(()=>new Set))),this.logger=e,this.olmMachine=t,this.perSessionBackupDownloader=r}}function q(e){return JSON.stringify({event_id:e.getId(),type:e.getWireType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getWireContent(),origin_server_ts:e.getTs()})}function V(e,t){let r,n;if(void 0===t)return null;let i=t.shieldState(!1);switch(i.color){case a.ShieldColor.Grey:r=g.EventShieldColour.GREY;break;case a.ShieldColor.None:r=g.EventShieldColour.NONE;break;default:r=g.EventShieldColour.RED}return void 0===i.message?n=null:"Encrypted by an unverified user."===i.message?n=g.EventShieldReason.UNVERIFIED_IDENTITY:"Encrypted by a device not verified by its owner."===i.message?n=g.EventShieldReason.UNSIGNED_DEVICE:"The authenticity of this encrypted message can't be guaranteed on this device."===i.message?n=g.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED:"Encrypted by an unknown or deleted device."===i.message?n=g.EventShieldReason.UNKNOWN_DEVICE:(e.warn("Unknown shield state message '".concat(i.message,"'")),n=g.EventShieldReason.UNKNOWN),{shieldColour:r,shieldReason:n}}},26952:function(e,t){"use strict";async function r(e){return n(e,["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"])}async function n(e,t){let r=await e.getDefaultKeyId();if(!r)return!1;for(let n of t)if(!(r in(await e.isStored(n)||{})))return!1;return!0}Object.defineProperty(t,"__esModule",{value:!0}),t.secretStorageCanAccessSecrets=n,t.secretStorageContainsCrossSigningKeys=r},42704:function(e,t,r){"use strict";var n=r(31180).Buffer,i=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RustVerificationRequest=t.RustSASVerifier=t.RustQrCodeVerifier=void 0,t.isVerificationEvent=E,t.verificationMethodIdentifierToMethod=S;var o=i(r(13102)),s=f(r(24542)),a=s,l=r(12796),c=r(44441),d=r(92807),u=r(15748),h=r(44480);function p(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(p=function(e){return e?r:t})(e)}function f(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=p(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}class g extends c.TypedEventEmitter{setVerifier(e){this._verifier&&this.reEmitter.stopReEmitting(this._verifier,[l.VerificationRequestEvent.Change]),this._verifier=e,this.reEmitter.reEmit(this._verifier,[l.VerificationRequestEvent.Change])}get transactionId(){return this.inner.flowId}get roomId(){var e;return null===(e=this.inner.roomId)||void 0===e?void 0:e.toString()}get initiatedByMe(){return this.inner.weStarted()}get otherUserId(){return this.inner.otherUserId.toString()}get otherDeviceId(){var e;return null===(e=this.inner.otherDeviceId)||void 0===e?void 0:e.toString()}async getOtherDevice(){let e=this.inner.otherDeviceId;if(e)return await this.olmMachine.getDevice(this.inner.otherUserId,e,5)}get isSelfVerification(){return this.inner.isSelfVerification()}get phase(){let e=this.inner.phase();switch(e){case a.VerificationRequestPhase.Created:case a.VerificationRequestPhase.Requested:return l.VerificationPhase.Requested;case a.VerificationRequestPhase.Ready:return this._accepting?l.VerificationPhase.Requested:l.VerificationPhase.Ready;case a.VerificationRequestPhase.Transitioned:if(!this._verifier)throw Error("VerificationRequest: inner phase == Transitioned but no verifier!");return this._verifier.verificationPhase;case a.VerificationRequestPhase.Done:return l.VerificationPhase.Done;case a.VerificationRequestPhase.Cancelled:return l.VerificationPhase.Cancelled}throw Error("Unknown verification phase ".concat(e))}get pending(){if(this.inner.isPassive())return!1;let e=this.phase;return e!==l.VerificationPhase.Done&&e!==l.VerificationPhase.Cancelled}get accepting(){return this._accepting}get declining(){return this._cancelling}get timeout(){return this.inner.timeRemainingMillis()}get methods(){throw Error("not implemented")}get chosenMethod(){if(this.phase!==l.VerificationPhase.Started)return null;let e=this.inner.getVerification();return e instanceof a.Sas?"m.sas.v1":e instanceof a.Qr?"m.reciprocate.v1":null}otherPartySupportsMethod(e){let t=this.inner.theirSupportedMethods;if(void 0===t)return!1;let r=b[e];return t.some(e=>e===r)}async accept(){if(this.inner.phase()!==a.VerificationRequestPhase.Requested||this._accepting)throw Error("Cannot accept a verification request in phase ".concat(this.phase));this._accepting=!0;try{let e=this.inner.acceptWithMethods(this.supportedVerificationMethods.map(S));e&&await this.outgoingRequestProcessor.makeOutgoingRequest(e)}finally{this._accepting=!1}this.emit(l.VerificationRequestEvent.Change)}async cancel(e){if(!this._cancelling){this._cancelling=!0;try{let e=this.inner.cancel();e&&await this.outgoingRequestProcessor.makeOutgoingRequest(e)}finally{this._cancelling=!1}}}beginKeyVerification(e,t){throw Error("not implemented")}async startVerification(e){if("m.sas.v1"!==e)throw Error("Unsupported verification method ".concat(e));if(!await this.getOtherDevice())throw Error("startVerification(): other device is unknown");let t=await this.inner.startSas();if(t){let[,e]=t;await this.outgoingRequestProcessor.makeOutgoingRequest(e)}if(!this._verifier)throw Error("Still no verifier after startSas() call");return this._verifier}async scanQRCode(e){let t=a.QrCodeScan.fromBytes(new Uint8ClampedArray(e)),r=await this.inner.scanQrCode(t);if(!this._verifier)throw Error("Still no verifier after scanQrCode() call");let n=r.reciprocate();return n&&await this.outgoingRequestProcessor.makeOutgoingRequest(n),this._verifier}get verifier(){return this.phase===l.VerificationPhase.Started?this._verifier:void 0}getQRCodeBytes(){throw Error("getQRCodeBytes() unsupported in Rust Crypto; use generateQRCode() instead.")}async generateQRCode(){if(!await this.getOtherDevice())throw Error("generateQRCode(): other device is unknown");let e=await this.inner.generateQrCode();if(e)return n.from(e.toBytes())}get cancellationCode(){var e,t;return null!==(e=null===(t=this.inner.cancelInfo)||void 0===t?void 0:t.cancelCode())&&void 0!==e?e:null}get cancellingUserId(){let e=this.inner.cancelInfo;return e?e.cancelledbyUs()?this.olmMachine.userId.toString():this.inner.otherUserId.toString():void 0}constructor(e,t,r,n){super(),(0,o.default)(this,"_accepting",!1),(0,o.default)(this,"_cancelling",!1),this.olmMachine=e,this.inner=t,this.outgoingRequestProcessor=r,this.supportedVerificationMethods=n,this.reEmitter=new d.TypedReEmitter(this);let i=async()=>{let e=this.inner.getVerification();e instanceof a.Sas?void 0===this._verifier||this._verifier instanceof v?this.setVerifier(new y(e,this,r)):this._verifier instanceof y&&this._verifier.replaceInner(e):e instanceof a.Qr&&void 0===this._verifier&&this.setVerifier(new v(e,r)),this.emit(l.VerificationRequestEvent.Change)};t.registerChangesCallback(i)}}t.RustVerificationRequest=g;class m extends c.TypedEventEmitter{onChange(){if(this.inner.isDone())this.completionDeferred.resolve(void 0);else if(this.inner.isCancelled()){let e=this.inner.cancelInfo();this.completionDeferred.reject(Error("Verification cancelled by ".concat(e.cancelledbyUs()?"us":"them"," with code ").concat(e.cancelCode(),": ").concat(e.reason())))}this.emit(l.VerificationRequestEvent.Change)}get hasBeenCancelled(){return this.inner.isCancelled()}get userId(){return this.inner.otherUserId.toString()}cancel(e){let t=this.inner.cancel();t&&this.outgoingRequestProcessor.makeOutgoingRequest(t)}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}constructor(e,t){super(),this.inner=e,this.outgoingRequestProcessor=t,this.completionDeferred=(0,h.defer)(),e.registerChangesCallback(async()=>{this.onChange()}),this.completionDeferred.promise.catch(()=>null)}}class v extends m{onChange(){null===this.callbacks&&this.inner.hasBeenScanned()&&(this.callbacks={confirm:()=>this.confirmScanning(),cancel:()=>this.cancel()}),super.onChange()}async verify(){null!==this.callbacks&&this.emit(l.VerifierEvent.ShowReciprocateQr,this.callbacks),await this.completionDeferred.promise}get verificationPhase(){switch(this.inner.state()){case s.QrState.Created:return l.VerificationPhase.Ready;case s.QrState.Scanned:case s.QrState.Confirmed:case s.QrState.Reciprocated:return l.VerificationPhase.Started;case s.QrState.Done:return l.VerificationPhase.Done;case s.QrState.Cancelled:return l.VerificationPhase.Cancelled;default:throw Error("Unknown qr code state ".concat(this.inner.state()))}}getReciprocateQrCodeCallbacks(){return this.callbacks}async confirmScanning(){let e=this.inner.confirmScanning();e&&await this.outgoingRequestProcessor.makeOutgoingRequest(e)}constructor(e,t){super(e,t),(0,o.default)(this,"callbacks",null)}}t.RustQrCodeVerifier=v;class y extends m{async verify(){await this.sendAccept(),await this.completionDeferred.promise}async sendAccept(){let e=this.inner.accept();e&&await this.outgoingRequestProcessor.makeOutgoingRequest(e)}onChange(){if(super.onChange(),null===this.callbacks){let e=this.inner.emoji(),t=this.inner.decimals();if(void 0===e&&void 0===t)return;let r={};e&&(r.emoji=e.map(e=>[e.symbol,e.description])),t&&(r.decimal=[t[0],t[1],t[2]]),this.callbacks={sas:r,confirm:async()=>{for(let e of(await this.inner.confirm()))await this.outgoingRequestProcessor.makeOutgoingRequest(e)},mismatch:()=>{throw Error("impl")},cancel:()=>{throw Error("impl")}},this.emit(l.VerifierEvent.ShowSas,this.callbacks)}}get verificationPhase(){return l.VerificationPhase.Started}getShowSasCallbacks(){return this.callbacks}replaceInner(e){this.inner!=e&&(this.inner=e,e.registerChangesCallback(async()=>{this.onChange()}),this.sendAccept(),this.onChange())}constructor(e,t,r){super(e,r),(0,o.default)(this,"callbacks",null)}}t.RustSASVerifier=y;let b={"m.sas.v1":a.VerificationMethod.SasV1,"m.qr_code.scan.v1":a.VerificationMethod.QrCodeScanV1,"m.qr_code.show.v1":a.VerificationMethod.QrCodeShowV1,"m.reciprocate.v1":a.VerificationMethod.ReciprocateV1};function S(e){let t=b[e];if(void 0===t)throw Error("Unknown verification method ".concat(e));return t}function E(e){switch(e.getType()){case u.EventType.KeyVerificationCancel:case u.EventType.KeyVerificationDone:case u.EventType.KeyVerificationMac:case u.EventType.KeyVerificationStart:case u.EventType.KeyVerificationKey:case u.EventType.KeyVerificationReady:case u.EventType.KeyVerificationAccept:return!0;case u.EventType.RoomMessage:return e.getContent().msgtype===u.MsgType.KeyVerificationRequest;default:return!1}}},89657:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=void 0;var i=n(r(13102)),o=r(34002),s=r(15748),a=r(44480),l=r(498);let c=!1;class d{static RETRY_BACKOFF_RATELIMIT(e,t,r){if(400===r.httpStatus||403===r.httpStatus||401===r.httpStatus||r instanceof l.ConnectionError||"M_TOO_LARGE"===r.name)return -1;if("M_LIMIT_EXCEEDED"===r.name){let e=r.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return e.getType()===s.EventType.RoomMessage||e.hasAssociation()?"message":null}getQueueForEvent(e){let t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map(function(e){return e.event}):null}removeEventFromQueue(e){let t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let r=!1;return(0,a.removeElement)(this.queues[t],t=>t.event.getId()===e.getId()&&(r=!0,!0)),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){let t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);let r=(0,a.defer)();return this.queues[t].push({event:e,defer:r,attempts:0}),u("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),u("Spinning up queue: '%s'",e),this.processQueue(e)})}disableQueue(e){let t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),o.logger.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){let r;for(o.logger.info("clearing queue '%s'",e);r=this.removeNextEvent(e);)r.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){let t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){let t=this.queues[e];if(Array.isArray(t))return t.shift()}constructor(e=d.RETRY_BACKOFF_RATELIMIT,t=d.QUEUE_MESSAGES){(0,i.default)(this,"queues",{}),(0,i.default)(this,"activeQueues",[]),(0,i.default)(this,"procFn",null),(0,i.default)(this,"processQueue",e=>{let t=this.peekNextEvent(e);if(!t){this.disableQueue(e);return}u("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then(()=>this.procFn(t.event)).then(r=>{this.removeNextEvent(e),u("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(r),this.processQueue(e)},r=>{t.attempts+=1;let n=this.retryAlgorithm(t.event,t.attempts,r);u("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,r,t.event.getId(),n),-1===n?(o.logger.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,r)):setTimeout(this.processQueue,n,e)})}),this.retryAlgorithm=e,this.queueAlgorithm=t}}function u(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];c&&o.logger.log(...t)}t.MatrixScheduler=d},98466:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerSideSecretStorageImpl=t.SECRET_STORAGE_ALGORITHM_V1_AES=void 0,t.trimTrailingEquals=c;var n=r(32950),i=r(54410),o=r(89027),s=r(34002);let a=t.SECRET_STORAGE_ALGORITHM_V1_AES="m.secret_storage.v1.aes-hmac-sha2";class l{async getDefaultKeyId(){let e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise((t,r)=>{let i=r=>{"m.secret_storage.default_key"===r.getType()&&r.getContent().key===e&&(this.accountDataAdapter.removeListener(n.ClientEvent.AccountData,i),t())};this.accountDataAdapter.on(n.ClientEvent.AccountData,i),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(e=>{this.accountDataAdapter.removeListener(n.ClientEvent.AccountData,i),r(e)})})}async addKey(e,t,r){if(e!==a)throw Error("Unknown key algorithm ".concat(e));let n={algorithm:e};t.name&&(n.name=t.name),t.passphrase&&(n.passphrase=t.passphrase);let{iv:s,mac:l}=await (0,i.calculateKeyCheck)(t.key);if(n.iv=s,n.mac=l,!r)do r=(0,o.randomString)(32);while(await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return await this.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),n),{keyId:r,keyInfo:n}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;let t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!await this.getKey(e)}async checkKey(e,t){if(t.algorithm===a){if(!t.mac)return!0;{let{mac:r}=await (0,i.calculateKeyCheck)(e,t.iv);return c(t.mac)===c(r)}}throw Error("Unknown algorithm")}async store(e,t,r){let n={};if(!r){let e=await this.getDefaultKeyId();if(!e)throw Error("No keys specified and no default key present");r=[e]}if(0===r.length)throw Error("Zero keys given to encrypt with!");for(let i of r){let r=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+i);if(!r)throw Error("Unknown key: "+i);if(r.algorithm===a){let o={[i]:r},[,s]=await this.getSecretStorageKey(o,e);n[i]=await s.encrypt(t)}else s.logger.warn("unknown algorithm for secret storage key "+i+": "+r.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:n})}async get(e){let t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw Error("Content is not encrypted!");let r={};for(let e of Object.keys(t.encrypted)){let n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),i=t.encrypted[e];(null==n?void 0:n.algorithm)===a&&i.iv&&i.ciphertext&&i.mac&&(r[e]=n)}if(0===Object.keys(r).length)throw Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");let[n,i]=await this.getSecretStorageKey(r,e),o=t.encrypted[n];return i.decrypt(o)}async isStored(e){let t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!(null!=t&&t.encrypted))return null;let r={};for(let e of Object.keys(t.encrypted)){let n=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!n)continue;let i=t.encrypted[e];n.algorithm===a&&i.iv&&i.ciphertext&&i.mac&&(r[e]=n)}return Object.keys(r).length?r:null}async getSecretStorageKey(e,t){if(!this.callbacks.getSecretStorageKey)throw Error("No getSecretStorageKey callback supplied");let r=await this.callbacks.getSecretStorageKey({keys:e},t);if(!r)throw Error("getSecretStorageKey callback returned falsey");if(r.length<2)throw Error("getSecretStorageKey callback returned invalid data");let[n,o]=r;if(!e[n])throw Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===a)return[n,{encrypt:function(e){return(0,i.encryptAES)(e,o,t)},decrypt:function(e){return(0,i.decryptAES)(e,o,t)}}];throw Error("Unknown key type: "+e[n].algorithm)}constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}}function c(e){let t=e.length;for(;t>=1&&61==e.charCodeAt(t-1);)t--;return t<e.length?e.substring(0,t):e}t.ServerSideSecretStorageImpl=l},67439:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0,t.SERVICE_TYPES=function(e){return e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e}({})},46694:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SlidingSyncSdk=void 0;var i=n(r(13102)),o=r(29197),s=r(34002),a=r(44480),l=r(91776),c=r(32950),d=r(9855),u=r(498),h=r(92882),p=r(15748),f=r(19389),g=r(74130);let m=3;class v{name(){return"e2ee"}when(){return h.ExtensionState.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.device_lists&&await this.crypto.processDeviceLists(e.device_lists),await this.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),this.crypto.onSyncCompleted({})}constructor(e){this.crypto=e}}class y{name(){return"to_device"}when(){return h.ExtensionState.PreProcess}onRequest(e){let t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){let t=[],r=e.events||[];r.length>0&&this.cryptoCallbacks&&(r=await this.cryptoCallbacks.preprocessToDeviceMessages(r)),r.map(this.client.getEventMapper()).map(e=>{if("m.key.verification.cancel"===e.getType()){let r=e.getContent().transaction_id;r&&t.push(r)}return e}).forEach(e=>{let r=e.getContent();if("m.room.message"==e.getType()&&"m.bad.encrypted"==r.msgtype){s.logger.log("Ignoring undecryptable to-device event from "+e.getSender());return}if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){let n=r.transaction_id;t.includes(n)&&e.flagCancelled()}this.client.emit(c.ClientEvent.ToDeviceEvent,e)}),this.nextBatch=e.next_batch}constructor(e,t){(0,i.default)(this,"nextBatch",null),this.client=e,this.cryptoCallbacks=t}}class b{name(){return"account_data"}when(){return h.ExtensionState.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){for(let t in e.global&&e.global.length>0&&this.processGlobalAccountData(e.global),e.rooms){let r=T(this.client,t,e.rooms[t]),n=this.client.getRoom(t);if(!n){s.logger.warn("got account data for room but room doesn't exist on client:",t);continue}n.addAccountData(r),r.forEach(e=>{this.client.emit(c.ClientEvent.Event,e)})}}processGlobalAccountData(e){let t=T(this.client,void 0,e),r=t.reduce((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e),{});this.client.store.storeAccountDataEvents(t),t.forEach(e=>{if(e.getType()===p.EventType.PushRules){let t=e.getContent();this.client.setPushRules(t)}let t=r[e.getType()];return this.client.emit(c.ClientEvent.AccountData,e,t),e})}constructor(e){this.client=e}}class S{name(){return"typing"}when(){return h.ExtensionState.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){if(null!=e&&e.rooms)for(let t in e.rooms)I(this.client,t,[e.rooms[t]])}constructor(e){this.client=e}}class E{name(){return"receipts"}when(){return h.ExtensionState.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){if(null!=e&&e.rooms)for(let t in e.rooms)I(this.client,t,[e.rooms[t]])}constructor(e){this.client=e}}class _{async onRoomData(e,t){let r=this.client.store.getRoom(e);if(!r){if(!t.initial){s.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}r=(0,d._createAndReEmitRoom)(this.client,e,this.opts)}await this.processRoomData(this.client,r,t)}onLifecycle(e,t,r){switch(r&&s.logger.debug("onLifecycle",e,r),e){case h.SlidingSyncState.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(d.SyncState.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(d.SyncState.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case h.SlidingSyncState.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>m?d.SyncState.Error:d.SyncState.Reconnecting,{error:new u.MatrixError(r)}),this.shouldAbortSync(new u.MatrixError(r)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){let{timelineSupport:t}=this.client,r=new o.Room(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[o.RoomEvent.Name,o.RoomEvent.Redaction,o.RoomEvent.RedactionCancelled,o.RoomEvent.Receipt,o.RoomEvent.Tags,o.RoomEvent.LocalEchoUpdated,o.RoomEvent.AccountData,o.RoomEvent.MyMembership,o.RoomEvent.Timeline,o.RoomEvent.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[f.RoomStateEvent.Events,f.RoomStateEvent.Members,f.RoomStateEvent.NewMember,f.RoomStateEvent.Update]),e.currentState.on(f.RoomStateEvent.NewMember,(e,t,r)=>{var n;r.user=null!==(n=this.client.getUser(r.userId))&&void 0!==n?n:void 0,this.client.reEmitter.reEmit(r,[g.RoomMemberEvent.Name,g.RoomMemberEvent.Typing,g.RoomMemberEvent.PowerLevel,g.RoomMemberEvent.Membership])})}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(s.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(d.SyncState.Error,{error:e}),!0)}async processRoomData(e,t,r){r=w(e,t.roomId,r);let n=T(this.client,t.roomId,r.required_state),i=T(this.client,t.roomId,r.timeline,!1),s=[];if(r.initial){let e=new Set;t.getLiveTimeline().getEvents().forEach(t=>{e.add(t.getId())});let n=[],o=[],s=!1;for(let t=i.length-1;t>=0;t--){let r=i[t];if(e.has(r.getId())){s=!0;continue}s?n.push(r):o.unshift(r)}i=o,n.length>0&&t.addEventsToTimeline(n,!0,t.getLiveTimeline(),r.prev_batch)}let d=t.hasEncryptionStateEvent();if(null!=r.notification_count&&t.setUnreadNotificationCount(o.NotificationCountType.Total,r.notification_count),null!=r.highlight_count&&(!d||d&&0>=t.getUnreadNotificationCount(o.NotificationCountType.Highlight))&&t.setUnreadNotificationCount(o.NotificationCountType.Highlight,r.highlight_count),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){let e=T(this.client,t.roomId,r.invite_state);await this.injectRoomEvents(t,e),r.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(c.ClientEvent.Room,t)),e.forEach(e=>{this.client.emit(c.ClientEvent.Event,e)}),t.updateMyMembership("invite");return}if(r.initial){var u;t.getLiveTimeline().setPaginationToken(null!==(u=r.prev_batch)&&void 0!==u?u:null,l.EventTimeline.BACKWARDS)}await this.injectRoomEvents(t,n,i,r.num_live),t.addEphemeralEvents(s),t.updateMyMembership("join"),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(c.ClientEvent.Room,t)),this.addNotifications(i);let h=async r=>{e.emit(c.ClientEvent.Event,r),r.isState()&&r.getType()==p.EventType.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(t,r)};await (0,a.promiseMapSeries)(n,h),await (0,a.promiseMapSeries)(i,h),s.forEach(function(t){e.emit(c.ClientEvent.Event,t)}),t.decryptCriticalEvents()}async injectRoomEvents(e,t,r,n){r=r||[],t=t||[],n=n||0;let i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(let e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t)}o||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));let s=[];n>0&&(s=r.slice(-1*n),r=r.slice(0,-1*s.length)),await e.addLiveEvents(r,{fromCache:!0}),s.length>0&&await e.addLiveEvents(s,{fromCache:!1}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;let t=this.client;e.getMembersWithMembership("invite").forEach(function(r){let n;if(r.requestedProfileInfo)return;r.requestedProfileInfo=!0;let i=t.getUser(r.userId);(n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(r.userId)).then(function(t){let n=r.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})})}retryImmediately(){return!0}async sync(){for(s.logger.debug("Sliding sync init loop");!this.client.isGuest();)try{s.logger.debug("Getting push rules...");let e=await this.client.getPushRules();s.logger.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(s.logger.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){s.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){let r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(c.ClientEvent.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(let t of e){let e=this.client.getPushActionsForEvent(t);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)}),this.notifEvents=[]}constructor(e,t,r,n){(0,i.default)(this,"syncState",null),(0,i.default)(this,"lastPos",null),(0,i.default)(this,"failCount",0),(0,i.default)(this,"notifEvents",[]),this.slidingSync=e,this.client=t,this.opts=(0,d.defaultClientOpts)(r),this.syncOpts=(0,d.defaultSyncApiOpts)(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[o.RoomEvent.Timeline,o.RoomEvent.TimelineReset]),this.slidingSync.on(h.SlidingSyncEvent.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(h.SlidingSyncEvent.RoomData,this.onRoomData.bind(this));let s=[new y(this.client,this.syncOpts.cryptoCallbacks),new b(this.client),new S(this.client),new E(this.client)];this.syncOpts.crypto&&s.push(new v(this.syncOpts.crypto)),s.forEach(e=>{this.slidingSync.registerExtension(e)})}}function w(e,t,r){if(!r.name)return r;for(let e of r.required_state)if(e.type===p.EventType.RoomName&&""===e.state_key)return e.content={name:r.name},r;return r.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:p.EventType.RoomName,content:{name:r.name},sender:e.getUserId(),origin_server_ts:new Date().getTime()}),r}function T(e,t,r){let n=!(arguments.length>3)||void 0===arguments[3]||arguments[3],i=e.getEventMapper({decrypt:n});return r.map(function(e){return e.room_id=t,i(e)})}function I(e,t,r){let n=T(e,t,r),i=e.getRoom(t);if(!i){s.logger.warn("got ephemeral events for room but room doesn't exist on client:",t);return}i.addEphemeralEvents(n),n.forEach(t=>{e.emit(c.ClientEvent.Event,t)})}t.SlidingSyncSdk=_},92882:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SlidingSyncState=t.SlidingSyncEvent=t.SlidingSync=t.MSC3575_WILDCARD=t.MSC3575_STATE_KEY_ME=t.MSC3575_STATE_KEY_LAZY=t.ExtensionState=void 0;var i=n(r(13102)),o=r(34002),s=r(44441),a=r(44480);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let d=1e4;t.MSC3575_WILDCARD="*",t.MSC3575_STATE_KEY_ME="$ME",t.MSC3575_STATE_KEY_LAZY="$LAZY";let u=t.SlidingSyncState=function(e){return e.RequestFinished="FINISHED",e.Complete="COMPLETE",e}({});class h{setModified(e){this.isModified=e}updateListRange(e){this.list.ranges=JSON.parse(JSON.stringify(e))}replaceList(e){e.filters=e.filters||{},e.ranges=e.ranges||[],this.list=JSON.parse(JSON.stringify(e)),this.isModified=!0,this.roomIndexToRoomId={},this.joinedCount=0}getList(e){let t={ranges:JSON.parse(JSON.stringify(this.list.ranges))};return(this.isModified||e)&&(t=JSON.parse(JSON.stringify(this.list))),t}isIndexInRange(e){for(let t of this.list.ranges)if(t[0]<=e&&e<=t[1])return!0;return!1}constructor(e){(0,i.default)(this,"roomIndexToRoomId",{}),(0,i.default)(this,"joinedCount",0),this.replaceList(e)}}let p=t.ExtensionState=function(e){return e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess",e}({}),f=t.SlidingSyncEvent=function(e){return e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e.List="SlidingSync.List",e}({});class g extends s.TypedEventEmitter{addCustomSubscription(e,t){if(this.customSubscriptions.has(e)){o.logger.warn("addCustomSubscription: ".concat(e," already exists as a custom subscription, ignoring."));return}this.customSubscriptions.set(e,t)}useCustomSubscription(e,t){this.roomIdToCustomSubscription.get(e)!==t&&(this.roomIdToCustomSubscription.set(e,t),this.confirmedRoomSubscriptions.delete(e))}getListData(e){let t=this.lists.get(e);return t?{joinedCount:t.joinedCount,roomIndexToRoomId:Object.assign({},t.roomIndexToRoomId)}:null}getListParams(e){let t=this.lists.get(e);return t?t.getList(!0):null}setListRanges(e,t){let r=this.lists.get(e);return r?(r.updateListRange(t),this.resend()):Promise.reject(Error("no list with key "+e))}setList(e,t){let r=this.lists.get(e);return r?(r.replaceList(t),this.lists.set(e,r)):this.lists.set(e,new h(t)),this.listModifiedCount+=1,this.resend()}getRoomSubscriptions(){return new Set(Array.from(this.desiredRoomSubscriptions))}modifyRoomSubscriptions(e){return this.desiredRoomSubscriptions=e,this.resend()}modifyRoomSubscriptionInfo(e){return this.roomSubscriptionInfo=e,this.confirmedRoomSubscriptions=new Set,this.resend()}registerExtension(e){if(this.extensions[e.name()])throw Error("registerExtension: ".concat(e.name()," already exists as an extension"));this.extensions[e.name()]=e}getExtensionRequest(e){let t={};return Object.keys(this.extensions).forEach(r=>{t[r]=this.extensions[r].onRequest(e)}),t}onPreExtensionsResponse(e){Object.keys(e).forEach(t=>{this.extensions[t].when()==p.PreProcess&&this.extensions[t].onResponse(e[t])})}onPostExtensionsResponse(e){Object.keys(e).forEach(t=>{this.extensions[t].when()==p.PostProcess&&this.extensions[t].onResponse(e[t])})}async invokeRoomDataListeners(e,t){t.required_state||(t.required_state=[]),t.timeline||(t.timeline=[]),await this.emitPromised(f.RoomData,e,t)}invokeLifecycleListeners(e,t,r){this.emit(f.Lifecycle,e,t,r)}shiftRight(e,t,r){let n=this.lists.get(e);if(n)for(let e=t;e>r;e--)n.isIndexInRange(e)&&(n.roomIndexToRoomId[e]=n.roomIndexToRoomId[e-1])}shiftLeft(e,t,r){let n=this.lists.get(e);if(n)for(let e=r;e<t;e++)n.isIndexInRange(e)&&(n.roomIndexToRoomId[e]=n.roomIndexToRoomId[e+1])}removeEntry(e,t){let r=this.lists.get(e);if(!r)return;let n=-1;for(let e in r.roomIndexToRoomId)Number(e)>n&&(n=Number(e));n<0||t>n||(this.shiftLeft(e,n,t),delete r.roomIndexToRoomId[n])}addEntry(e,t){let r=this.lists.get(e);if(!r)return;let n=-1;for(let e in r.roomIndexToRoomId)Number(e)>n&&(n=Number(e));n<0||t>n||this.shiftRight(e,n+1,t)}processListOps(e,t){let r=-1,n=this.lists.get(t);n&&(e.ops.forEach(e=>{if(n)switch(e.op){case"DELETE":o.logger.debug("DELETE",t,e.index,";"),delete n.roomIndexToRoomId[e.index],-1!==r&&this.removeEntry(t,r),r=e.index;break;case"INSERT":o.logger.debug("INSERT",t,e.index,e.room_id,";"),n.roomIndexToRoomId[e.index]&&(r<0?this.addEntry(t,e.index):r>e.index?this.shiftRight(t,r,e.index):r<e.index&&this.shiftLeft(t,e.index,r)),r=-1,n.roomIndexToRoomId[e.index]=e.room_id;break;case"INVALIDATE":{let r=e.range[0];for(let t=r;t<=e.range[1];t++)delete n.roomIndexToRoomId[t];o.logger.debug("INVALIDATE",t,e.range[0],e.range[1],";");break}case"SYNC":{let r=e.range[0];for(let t=r;t<=e.range[1];t++){let i=e.room_ids[t-r];if(!i)break;n.roomIndexToRoomId[t]=i}o.logger.debug("SYNC",t,e.range[0],e.range[1],(e.room_ids||[]).join(" "),";")}}}),-1!==r&&this.removeEntry(t,r))}resend(){var e;if(this.needsResend&&this.txnIdDefers.length>0)return this.txnIdDefers[this.txnIdDefers.length-1].promise;this.needsResend=!0,this.txnId=this.client.makeTxnId();let t=(0,a.defer)();return this.txnIdDefers.push(c(c({},t),{},{txnId:this.txnId})),null===(e=this.abortController)||void 0===e||e.abort(),this.abortController=new AbortController,t.promise}resolveTransactionDefers(e){if(!e)return;let t=-1;for(let r=0;r<this.txnIdDefers.length;r++)if(this.txnIdDefers[r].txnId===e){t=r;break}if(-1===t){o.logger.warn("resolveTransactionDefers: seen ".concat(e," but it isn't a pending txn, ignoring."));return}for(let e=0;e<t;e++)this.txnIdDefers[e].reject(this.txnIdDefers[e].txnId);this.txnIdDefers[t].resolve(e),this.txnIdDefers=this.txnIdDefers.slice(t+1)}stop(){var e;this.terminated=!0,null===(e=this.abortController)||void 0===e||e.abort(),this.removeAllListeners(f.Lifecycle),this.removeAllListeners(f.List),this.removeAllListeners(f.RoomData)}resetup(){var e;o.logger.warn("SlidingSync: resetting connection info"),this.txnIdDefers.forEach(e=>{e.reject(e.txnId)}),this.txnIdDefers=[],this.lists.forEach(e=>{e.setModified(!0)}),this.confirmedRoomSubscriptions=new Set,this.needsResend=!0,null===(e=this.abortController)||void 0===e||e.abort(),this.abortController=new AbortController}async start(){let e;for(this.abortController=new AbortController;!this.terminated;){let t;this.needsResend=!1;let r=!1;try{let n=this.listModifiedCount,i={};this.lists.forEach((e,t)=>{i[t]=e.getList(!1)});let s={lists:i,pos:e,timeout:this.timeoutMS,clientTimeout:this.timeoutMS+d,extensions:this.getExtensionRequest(void 0===e)},a=m(this.desiredRoomSubscriptions,this.confirmedRoomSubscriptions),l=m(this.confirmedRoomSubscriptions,this.desiredRoomSubscriptions);if(l.size>0&&(s.unsubscribe_rooms=Array.from(l)),a.size>0)for(let e of(s.room_subscriptions={},a)){let t=this.roomIdToCustomSubscription.get(e),r=this.roomSubscriptionInfo;t&&this.customSubscriptions.has(t)&&(r=this.customSubscriptions.get(t)),s.room_subscriptions[e]=r}for(let r of(this.txnId&&(s.txn_id=this.txnId,this.txnId=null),this.pendingReq=this.client.slidingSync(s,this.proxyBaseUrl,this.abortController.signal),e=(t=await this.pendingReq).pos,a))this.confirmedRoomSubscriptions.add(r);for(let e of l)this.confirmedRoomSubscriptions.delete(e);n!==this.listModifiedCount&&(o.logger.debug("list modified during await call, not updating list"),r=!0),this.lists.forEach(e=>{e.setModified(!1)}),t.lists=t.lists||{},t.rooms=t.rooms||{},t.extensions=t.extensions||{},Object.keys(t.lists).forEach(e=>{let r=this.lists.get(e);r&&t&&(r.joinedCount=t.lists[e].count)}),this.invokeLifecycleListeners(u.RequestFinished,t)}catch(t){if(t.httpStatus){if(this.invokeLifecycleListeners(u.RequestFinished,null,t),400===t.httpStatus){this.resetup(),e=void 0,await (0,a.sleep)(50);continue}}else if(this.needsResend||"AbortError"===t.name)continue;o.logger.error(t),await (0,a.sleep)(5e3)}if(!t)continue;for(let e in this.onPreExtensionsResponse(t.extensions),t.rooms)await this.invokeRoomDataListeners(e,t.rooms[e]);let n=new Set;if(!r)for(let[e,r]of Object.entries(t.lists))r.ops=r.ops||[],r.ops.length>0&&n.add(e),this.processListOps(r,e);this.invokeLifecycleListeners(u.Complete,t),this.onPostExtensionsResponse(t.extensions),n.forEach(e=>{let t=this.lists.get(e);t&&this.emit(f.List,e,t.joinedCount,Object.assign({},t.roomIndexToRoomId))}),this.resolveTransactionDefers(t.txn_id)}}constructor(e,t,r,n,o){super(),(0,i.default)(this,"listModifiedCount",0),(0,i.default)(this,"terminated",!1),(0,i.default)(this,"needsResend",!1),(0,i.default)(this,"txnId",null),(0,i.default)(this,"txnIdDefers",[]),(0,i.default)(this,"extensions",{}),(0,i.default)(this,"desiredRoomSubscriptions",new Set),(0,i.default)(this,"confirmedRoomSubscriptions",new Set),(0,i.default)(this,"customSubscriptions",new Map),(0,i.default)(this,"roomIdToCustomSubscription",new Map),this.proxyBaseUrl=e,this.roomSubscriptionInfo=r,this.client=n,this.timeoutMS=o,this.lists=new Map,t.forEach((e,t)=>{this.lists.set(t,new h(e))})}}t.SlidingSync=g;let m=(e,t)=>{let r=new Set(e);for(let e of t)r.delete(e);return r}},85166:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=void 0;var i=n(r(13102)),o=r(88903),s=r(44480),a=r(86036),l=r(34002);let c=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],d=c.length;function u(e,t,r){let n=e.openCursor(t);return new Promise((e,t)=>{let i=[];n.onerror=()=>{t(Error("Query failed: "+n.error))},n.onsuccess=()=>{let t=n.result;if(!t){e(i);return}i.push(r(t)),t.continue()}})}function h(e){return new Promise((t,r)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){r(e.error)}})}function p(e){return new Promise((t,r)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){r(e.error)}})}function f(e){return new Promise((t,r)=>{e.onsuccess=()=>t(e),e.onerror=e=>r(e)})}function g(e){return p(e).then(t=>e.result)}class m{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),(0,a.exists)(e,t)}connect(e){if(!this.disconnected)return l.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,l.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");let t=this.indexedDB.open(this.dbName,d);return t.onupgradeneeded=e=>{let r=t.result,n=e.oldVersion;l.logger.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(n)),n<1&&(this._isNewlyCreated=!0),c.forEach((e,t)=>{n<=t&&e(r)})},t.onblocked=()=>{l.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},l.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),p(t).then(async()=>{l.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=t.result,this.db.onversionchange=()=>{var e;null===(e=this.db)||void 0===e||e.close(),this.disconnected=!0,this.db=void 0},this.db.onclose=()=>{this.disconnected=!0,this.db=void 0,null==e||e()},await this.init()})}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{let[t,r]=e;l.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{let n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=n.openCursor(i),s=[],a=!1;o.onsuccess=()=>{let e=o.result;if(!e)return s.length||a?t(s):t(null);let r=e.value;r.oob_written?a=!0:s.push(r),e.continue()},o.onerror=e=>{r(e)}}).then(t=>(l.logger.log("LL: got ".concat(null==t?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}async setOutOfBandMembers(e,t){l.logger.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));let r=this.db.transaction(["oob_membership_events"],"readwrite"),n=r.objectStore("oob_membership_events");t.forEach(e=>{n.put(e)});let i={room_id:e,oob_written:!0,state_key:0};n.put(i),await h(r),l.logger.log("LL: backend done storing for ".concat(e,"!"))}async clearOutOfBandMembers(e){let t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),r=IDBKeyRange.only(e),n=g(t.openKeyCursor(r,"next")).then(e=>(null==e?void 0:e.primaryKey)[1]),i=g(t.openKeyCursor(r,"prev")).then(e=>(null==e?void 0:e.primaryKey)[1]),[o,s]=await Promise.all([n,i]),a=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),c=IDBKeyRange.bound([e,o],[e,s]);l.logger.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,o],[e,s]),await f(a.delete(c))}clearDatabase(){return new Promise(e=>{var t;l.logger.log("Removing indexeddb instance: ".concat(this.dbName)),null===(t=this.db)||void 0===t||t.close();let r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{l.logger.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{l.logger.warn("unable to delete js-sdk store indexeddb: ".concat(r.error)),e()},r.onsuccess=()=>{l.logger.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve((0,s.deepCopy)(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}async syncToDatabase(e){return this.syncToDatabasePromise?(l.logger.warn("Skipping syncToDatabase() as persist already in flight"),this.pendingUserPresenceData.push(...e)):(e.unshift(...this.pendingUserPresenceData),this.syncToDatabasePromise=this.doSyncToDatabase(e)),this.syncToDatabasePromise}async doSyncToDatabase(e){try{let t=this.syncAccumulator.getJSON(!0);await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t.nextBatch,t.roomsData)])}finally{this.syncToDatabasePromise=void 0}}persistSyncData(e,t){return l.logger.log("Persisting sync data up to",e),(0,s.promiseTry)(()=>{let r=this.db.transaction(["sync"],"readwrite");return r.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),h(r).then(()=>{l.logger.log("Persisted sync data up to",e)})})}persistAccountData(e){return(0,s.promiseTry)(()=>{let t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(let t of e)r.put(t);return h(t).then()})}persistUserPresenceEvents(e){return(0,s.promiseTry)(()=>{let t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(let t of e)r.put({userId:t[0],event:t[1]});return h(t).then()})}getUserPresenceEvents(){return(0,s.promiseTry)(()=>u(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))}loadAccountData(){return l.logger.log("LocalIndexedDBStoreBackend: loading account data..."),(0,s.promiseTry)(()=>u(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(l.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}loadSyncData(){return l.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),(0,s.promiseTry)(()=>u(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(l.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&l.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}getClientOptions(){return Promise.resolve().then(()=>u(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options}).then(e=>e[0]))}async storeClientOptions(e){let t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await h(t)}async saveToDeviceBatches(e){let t=this.db.transaction(["to_device_queue"],"readwrite"),r=t.objectStore("to_device_queue");for(let t of e)r.add(t);await h(t)}async getOldestToDeviceBatch(){let e=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),t=await g(e.openCursor());if(!t)return null;let r=t.value;return{id:t.key,txnId:r.txnId,eventType:r.eventType,batch:r.batch}}async removeToDeviceBatch(e){let t=this.db.transaction(["to_device_queue"],"readwrite");t.objectStore("to_device_queue").delete(e),await h(t)}async destroy(){var e;null===(e=this.db)||void 0===e||e.close()}constructor(e,t="default"){(0,i.default)(this,"disconnected",!0),(0,i.default)(this,"_isNewlyCreated",!1),(0,i.default)(this,"pendingUserPresenceData",[]),this.indexedDB=e,this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new o.SyncAccumulator}}t.LocalIndexedDBStoreBackend=m},97186:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=void 0;var i=n(r(13102)),o=r(34002),s=r(44480);class a{connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(e){return this.doCmd("saveToDeviceBatches",[e])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(e){return this.doCmd("removeToDeviceBatch",[e])}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{o.logger.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r;let n=this.nextSeq++,i=(0,s.defer)();return this.inFlight[n]=i,null===(r=this.worker)||void 0===r||r.postMessage({command:e,seq:n,args:t}),i.promise})}async destroy(){var e;null===(e=this.worker)||void 0===e||e.terminate()}constructor(e,t){(0,i.default)(this,"nextSeq",0),(0,i.default)(this,"inFlight",{}),(0,i.default)(this,"onWorkerMessage",e=>{let t=e.data;if("closed"==t.command){var r;null===(r=this.onClose)||void 0===r||r.call(this)}else if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq){o.logger.error("Got reply from worker with no seq");return}let e=this.inFlight[t.seq];if(void 0===e){o.logger.error("Got reply for unknown seq "+t.seq);return}if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{let r=Error(t.error.message);r.name=t.error.name,e.reject(r)}}else o.logger.warn("Unrecognised message from worker: ",t)}),this.workerFactory=e,this.dbName=t}}t.RemoteIndexedDBStoreBackend=a},37327:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=void 0;var i=n(r(13102)),o=r(82908),s=r(85166),a=r(97186),l=r(39325),c=r(34002),d=r(44441);let u=3e5;class h extends o.MemoryStore{static exists(e,t){return s.LocalIndexedDBStoreBackend.exists(e,t)}startup(){return this.startedUp?(c.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(c.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(c.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{c.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach(e=>{let[t,r]=e;if(!this.createUser)throw Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");let n=this.createUser(t);r&&n.setPresenceEvent(new l.MatrixEvent(r)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){return Date.now()-this.syncTs>u}save(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this;let n=t?super[t]:null;return async function(){for(var t=arguments.length,i=Array(t),o=0;o<t;o++)i[o]=arguments[o];try{return await e.call(r,...i)}catch(e){c.logger.error("IndexedDBStore failure, degrading to MemoryStore",e),r.emitter.emit("degraded",e);try{c.logger.log("IndexedDBStore trying to delete degraded data"),await r.backend.clearDatabase(),c.logger.log("IndexedDBStore delete after degrading succeeded")}catch(e){c.logger.warn("IndexedDBStore delete after degrading failed",e)}if(n)return n.call(r,...i)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);let t=this.localStorage.getItem(p(e));if(t)try{return JSON.parse(t)}catch(e){c.logger.error("Could not parse persisted pending events",e)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem(p(e),JSON.stringify(t)):this.localStorage.removeItem(p(e))}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}constructor(e){if(super(e),(0,i.default)(this,"startedUp",!1),(0,i.default)(this,"syncTs",0),(0,i.default)(this,"userModifiedMap",{}),(0,i.default)(this,"emitter",new d.TypedEventEmitter),(0,i.default)(this,"on",this.emitter.on.bind(this.emitter)),(0,i.default)(this,"onClose",()=>{this.emitter.emit("closed")}),(0,i.default)(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),(0,i.default)(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),(0,i.default)(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),(0,i.default)(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{c.logger.log("Deleted indexeddb data.")},e=>{throw c.logger.error("Failed to delete indexeddb data: ".concat(e)),e})))),(0,i.default)(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();let e=[];for(let t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),(0,i.default)(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),(0,i.default)(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),(0,i.default)(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),(0,i.default)(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),(0,i.default)(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),(0,i.default)(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!e.indexedDB)throw Error("Missing required option: indexedDB");e.workerFactory?this.backend=new a.RemoteIndexedDBStoreBackend(e.workerFactory,e.dbName):this.backend=new s.LocalIndexedDBStoreBackend(e.indexedDB,e.dbName)}}function p(e){return"mx_pending_events_".concat(e)}t.IndexedDBStore=h},51456:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.localStorageErrorsEventsEmitter=t.LocalStorageErrors=void 0;var n=r(44441);t.LocalStorageErrors=function(e){return e.Global="Global",e.SetItemError="setItem",e.GetItemError="getItem",e.RemoveItemError="removeItem",e.ClearError="clear",e.QuotaExceededError="QuotaExceededError",e}({});class i extends n.TypedEventEmitter{}t.localStorageErrorsEventsEmitter=new i},82908:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=void 0;var i=n(r(13102)),o=r(19389),s=r(44480);function a(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class l{getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(o.RoomStateEvent.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(o.RoomStateEvent.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){null!=e&&e.userId&&null!=e&&e.filterId&&this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return(null===(r=this.filters.get(e))||void 0===r?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;let t="mxjssdk_memory_filter_"+e;try{let e=this.localStorage.getItem(t);if(a(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;let r="mxjssdk_memory_filter_"+e;try{a(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(e){}}storeAccountDataEvents(e){e.forEach(e=>{Object.keys(e.getContent()).length?this.accountData.set(e.getType(),e):this.accountData.delete(e.getType())})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new s.MapWithDefault(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}async getPendingEvents(e){var t;return null!==(t=this.pendingEvents[e])&&void 0!==t?t:[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}saveToDeviceBatches(e){for(let t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return 0===this.pendingToDeviceBatches.length?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}async destroy(){}constructor(e={}){(0,i.default)(this,"rooms",{}),(0,i.default)(this,"users",{}),(0,i.default)(this,"syncToken",null),(0,i.default)(this,"filters",new s.MapWithDefault(()=>new Map)),(0,i.default)(this,"accountData",new Map),(0,i.default)(this,"oobMembers",new Map),(0,i.default)(this,"pendingEvents",{}),(0,i.default)(this,"pendingToDeviceBatches",[]),(0,i.default)(this,"nextToDeviceBatchId",0),(0,i.default)(this,"onRoomMember",(e,t,r)=>{var n;if("invite"===r.membership)return;let i=this.users[r.userId]||(null===(n=this.createUser)||void 0===n?void 0:n.call(this,r.userId));r.name&&(i.setDisplayName(r.name),r.events.member&&i.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&i.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[i.userId]=i}),this.localStorage=e.localStorage}}t.MemoryStore=l},19314:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=void 0;var i=n(r(13102));class o{isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}async destroy(){}constructor(){(0,i.default)(this,"accountData",new Map),(0,i.default)(this,"fromToken",null)}}t.StubStore=o},88903:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=t.Category=void 0;var i=n(r(13102)),o=r(34002),s=r(44480),a=r(64791),l=r(46159);let c=t.Category=function(e){return e.Invite="invite",e.Leave="leave",e.Join="join",e.Knock="knock",e}({});function d(e){return"_localTs"in e&&void 0!==e._localTs}class u{accumulate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}accumulateRooms(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,c.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,c.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,c.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,c.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case c.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case c.Knock:this.accumulateKnockState(e,r);break;case c.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case c.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:o.logger.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}let r=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let n=0;n<r.invite_state.events.length;n++){let i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)})}accumulateKnockState(e,t){if(!t.knock_state||!t.knock_state.events)return;if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}let r=this.knockRooms[e];t.knock_state.events.forEach(e=>{let t=!1;for(let n=0;n<r.knock_state.events.length;n++){let i=r.knock_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.knock_state.events[n]=e,t=!0)}t||r.knock_state.events.push(e)})}accumulateJoinState(e,t){var r,n,i,o,s,c,d,u;let p=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new l.ReceiptAccumulator});let f=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{f._accountData[e.type]=e}),t.unread_notifications&&(f._unreadNotifications=t.unread_notifications),f._unreadThreadNotifications=null!==(r=null!==(n=t[a.UNREAD_THREAD_NOTIFICATIONS.stable])&&void 0!==n?n:t[a.UNREAD_THREAD_NOTIFICATIONS.unstable])&&void 0!==r?r:void 0,t.summary){let e="m.heroes",r="m.invited_member_count",n="m.joined_member_count",i=f._summary,o=t.summary;i[e]=null!==(c=o[e])&&void 0!==c?c:i[e],i[n]=null!==(d=o[n])&&void 0!==d?d:i[n],i[r]=null!==(u=o[r])&&void 0!==u?u:i[r]}if(f._receipts.consumeEphemeralEvents(null===(i=t.ephemeral)||void 0===i?void 0:i.events),t.timeline&&t.timeline.limited&&(f._timeline=[]),null===(o=t.state)||void 0===o||null===(o=o.events)||void 0===o||o.forEach(e=>{h(f._currentState,e)}),null===(s=t.timeline)||void 0===s||null===(s=s.events)||void 0===s||s.forEach((e,r)=>{var n;let i;if(h(f._currentState,e),p)i=e;else{void 0!==(i=Object.assign({},e)).unsigned&&(i.unsigned=Object.assign({},i.unsigned));let t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(i._localTs=Date.now()-t)}f._timeline.push({event:i,token:0===r&&null!==(n=t.timeline.prev_batch)&&void 0!==n?n:null})}),f._timeline.length>this.opts.maxTimelineEntries){let e=f._timeline.length-this.opts.maxTimelineEntries;for(let t=e;t<f._timeline.length;t++)if(f._timeline[t].token){f._timeline=f._timeline.slice(t,f._timeline.length);break}}}getJSON(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.knockRooms).forEach(e=>{t.knock[e]=this.knockRooms[e]}),Object.keys(this.joinRooms).forEach(r=>{let n=this.joinRooms[r],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,unread_thread_notifications:n._unreadThreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach(e=>{i.account_data.events.push(n._accountData[e])});let o=n._receipts.buildAccumulatedReceiptEvent(r);o&&i.ephemeral.events.push(o),n._timeline.forEach(t=>{let r;if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}!e&&d(t.event)?(void 0!==(r=Object.assign({},t.event)).unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,i.timeline.events.push(r)});let a=Object.create(null);for(let e=i.timeline.events.length-1;e>=0;e--){let t=i.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;let r=(0,s.deepCopy)(t);r.unsigned&&(r.unsigned.prev_content&&(r.content=r.unsigned.prev_content),r.unsigned.prev_sender&&(r.sender=r.unsigned.prev_sender)),h(a,r)}Object.keys(n._currentState).forEach(e=>{Object.keys(n._currentState[e]).forEach(t=>{let r=n._currentState[e][t];a[e]&&a[e][t]&&(r=a[e][t]),i.state.events.push(r)})}),t.join[r]=i});let r=[];return Object.keys(this.accountData).forEach(e=>{r.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}constructor(e={}){(0,i.default)(this,"accountData",{}),(0,i.default)(this,"inviteRooms",{}),(0,i.default)(this,"knockRooms",{}),(0,i.default)(this,"joinRooms",{}),(0,i.default)(this,"nextBatch",null),this.opts=e,this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}}function h(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.SyncAccumulator=u},9855:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncState=t.SyncApi=t.SetPresence=void 0,t._createAndReEmitRoom=D,t.defaultClientOpts=M,t.defaultSyncApiOpts=P;var i=n(r(13102)),o=r(69509),s=r(29197),a=r(44480),l=r(51601),c=r(91776),d=r(34002),u=r(74460),h=r(32950),p=r(498),f=r(15748),g=r(19389),m=r(74130),v=r(12533),y=r(64791),b=r(1755);function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let _=!0,w=8e4,T=3,I=t.SyncState=function(e){return e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING",e}({}),O=["org.matrix.msc2716v3"];function R(e,t){return"FILTER_SYNC_".concat(e)+(t?"_"+t:"")}function C(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];_&&d.logger.log(...t)}let k=t.SetPresence=function(e){return e.Offline="offline",e.Online="online",e.Unavailable="unavailable",e}({});function M(e){return E({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:h.PendingEventOrdering.Chronological,threadSupport:!1},e)}function P(e){return E({canResetEntireTimeline:e=>!1},e)}class A{createRoom(e){let t=D(this.client,e,this.opts);return t.on(g.RoomStateEvent.Marker,(e,r)=>{this.onMarkerStateEvent(t,e,r)}),t}onMarkerStateEvent(e,t){let{timelineWasEmpty:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r){d.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}O.includes(e.getVersion())||t.getSender()===e.getCreator()?(d.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(s.RoomEvent.HistoryImportedWithinTimeline,t,e)):d.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}async syncLeftRooms(){var e;let t=this.client,r=new l.Filter(this.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);let n=this.opts.pollTimeout+w,i={timeout:0,filter:await t.getOrCreateFilter(R(t.credentials.userId,"LEFT_ROOMS"),r)},o=await t.http.authedRequest(p.Method.Get,"/sync",i,void 0,{localTimeoutMs:n}),s=[];return null!==(e=o.rooms)&&void 0!==e&&e.leave&&(s=this.mapSyncResponseToRoomArray(o.rooms.leave)),(await Promise.all(s.map(async e=>{let r=e.room;if(!e.isBrandNewRoom)return;e.timeline=e.timeline||{prev_batch:null,events:[]};let n=this.mapSyncEventsFormat(e.timeline,r),i=this.mapSyncEventsFormat(e.state,r);return r.getLiveTimeline().setPaginationToken(e.timeline.prev_batch,c.EventTimeline.BACKWARDS),await this.injectRoomEvents(r,i,n),r.recalculate(),t.store.storeRoom(r),t.emit(h.ClientEvent.Room,r),this.processEventsForNotifs(r,n),r}))).filter(Boolean)}peek(e){var t;if((null===(t=this._peekRoom)||void 0===t?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);let r=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(t=>{var n;if((null===(n=this._peekRoom)||void 0===n?void 0:n.roomId)!==e)throw Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];let i=(0,a.deepCopy)(t.state).map(r.getEventMapper()),s=t.state.map(r.getEventMapper()),l=t.messages.chunk.map(r.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(r.getEventMapper()).forEach(function(e){let t=r.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=o.User.createUser(e.getContent().user_id,r)).setPresenceEvent(e),r.store.storeUser(t)),r.emit(h.ClientEvent.Event,e)}),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(i),this._peekRoom.currentState.setStateEvents(s),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(l.reverse(),!0,this._peekRoom.getLiveTimeline(),t.messages.start),r.store.storeRoom(this._peekRoom),r.emit(h.ClientEvent.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r;if(this._peekRoom!==e){C("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(p.Method.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(r=this.abortController)||void 0===r?void 0:r.signal}).then(async t=>{if(this._peekRoom!==e){C("Stopped peeking in room %s",e.roomId);return}t.chunk.filter(function(e){return"m.presence"===e.type}).map(this.client.getEventMapper()).forEach(e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=o.User.createUser(e.getContent().user_id,this.client)).setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(h.ClientEvent.Event,e)});let r=t.chunk.filter(function(t){return t.room_id===e.roomId&&t.event_id}).map(this.client.getEventMapper());await e.addLiveEvents(r),this.peekPoll(e,t.end)},r=>{d.logger.error("[%s] Peek poll failed: %s",e.roomId,r),setTimeout(()=>{this.peekPoll(e,t)},3e4)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}async recoverFromSyncStartupError(e,t){await e;let r=this.startKeepAlives();this.updateSyncState(I.Error,{error:t}),await r}async wasLazyLoadingToggled(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!1;if(!await this.client.store.isNewlyCreated()){let r=await this.client.store.getClientOptions();return r&&(t=!!r.lazyLoadMembers),t!==e}return!1}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(I.Error,{error:e}),!0)}async sync(){var e,t;if(this.running=!0,this.abortController=new AbortController,null===(e=r.g.window)||void 0===e||null===(t=e.addEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});C("Getting saved sync token...");let n=this.client.store.getSavedSyncToken().then(e=>(C("Got saved sync token"),e));this.savedSyncPromise=this.client.store.getSavedSync().then(e=>{if(C("Got reply from saved sync, exists? ".concat(!!e)),e)return this.syncFromCache(e)}).catch(e=>{d.logger.error("Getting saved sync failed",e)}),await this.getPushRules(),await this.checkLazyLoadStatus();let{filterId:i,filter:o}=await this.getFilter();if(o){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let e=i,t=await n;if(t)C("Sending first sync request...");else{C("Sending initial sync request...");let t=this.buildDefaultFilter();t.setDefinition(o.getDefinition()),t.setTimelineLimit(this.opts.initialSyncLimit),e=JSON.stringify(t.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:e},t)}return C("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:i})}}stop(){var e,t,n;C("SyncApi.stop"),null===(e=r.g.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(n=this.abortController)||void 0===n||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){C("sync(): not doing HTTP hit, instead returning stored /sync data");let t=e.nextBatch;this.client.store.setSyncToken(t);let r={nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(r,n)}catch(e){d.logger.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(I.Prepared,r)}async doSync(e){for(;this.running;){let t;let r=this.client.store.getSyncToken();try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(e,r)),t=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(t.next_batch),this.failedSyncCount=0;let n={oldSyncToken:null!=r?r:void 0,nextSyncToken:t.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(n);try{await this.processSyncResponse(n,t)}catch(e){d.logger.error("Caught /sync error",e),this.client.emit(h.ClientEvent.SyncUnexpectedError,e)}await this.client.store.setSyncData(t),n.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(I.Prepared,n),e.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(n),this.updateSyncState(I.Syncing,n),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),await this.client.store.save())}this.running||(C("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(I.Stopped))}doSyncRequest(e,t){var r;let n=this.getSyncParams(e,t);return this.client.http.authedRequest(p.Method.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+w,abortSignal:null===(r=this.abortController)||void 0===r?void 0:r.signal})}getSyncParams(e,t){let r=this.opts.pollTimeout;(this.getSyncState()!==I.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);let n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());let i={filter:n,timeout:r};return this.opts.disablePresence?i.set_presence=k.Offline:void 0!==this.presence&&(i.set_presence=this.presence),t?i.since=t:i._cacheBuster=Date.now(),[I.Reconnecting,I.Error].includes(this.getSyncState())&&(i.timeout=0),i}setPresence(e){this.presence=e}async onSyncError(e){if(!this.running)return C("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(I.Stopped),!0;if(d.logger.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,d.logger.log("Number of consecutive failed sync requests:",this.failedSyncCount),C("Starting keep-alive");let t=this.startKeepAlives();return this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=T?I.Error:I.Reconnecting,{error:e}),await t&&this.getSyncState()===I.Error&&this.updateSyncState(I.Catchup,{catchingUp:!0}),!1}async processSyncResponse(e,t){var r,n,i,l;let u=this.client;if(Array.isArray(null===(r=t.presence)||void 0===r?void 0:r.events)&&t.presence.events.filter(a.noUnsafeEventProps).map(u.getEventMapper()).forEach(function(e){let t=u.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=o.User.createUser(e.getSender(),u)).setPresenceEvent(e),u.store.storeUser(t)),u.emit(h.ClientEvent.Event,e)}),Array.isArray(null===(n=t.account_data)||void 0===n?void 0:n.events)){let e=t.account_data.events.filter(a.noUnsafeEventProps).map(u.getEventMapper()),r=e.reduce((e,t)=>(e[t.getType()]=u.store.getAccountData(t.getType()),e),{});u.store.storeAccountDataEvents(e),e.forEach(function(e){if(e.getType()===f.EventType.PushRules){let t=e.getContent();u.setPushRules(t)}let t=r[e.getType()];return u.emit(h.ClientEvent.AccountData,e,t),e})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let e=t.to_device.events.filter(a.noUnsafeEventProps);this.syncOpts.cryptoCallbacks&&(e=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(e));let r=[];e.map(u.getEventMapper({toDevice:!0})).map(e=>{if("m.key.verification.cancel"===e.getType()){let t=e.getContent().transaction_id;t&&r.push(t)}return e}).forEach(function(e){let t=e.getContent();if("m.room.message"==e.getType()&&"m.bad.encrypted"==t.msgtype){d.logger.log("Ignoring undecryptable to-device event from "+e.getSender());return}if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){let n=t.transaction_id;r.includes(n)&&e.flagCancelled()}u.emit(h.ClientEvent.ToDeviceEvent,e)})}else this.catchingUp=!1;let p=[],g=[],m=[],v=[];t.rooms&&(t.rooms.invite&&(p=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(g=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(m=this.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(v=this.mapSyncResponseToRoomArray(t.rooms.knock))),this.notifEvents=[],await (0,a.promiseMapSeries)(p,async e=>{var t;let r=e.room,n=this.mapSyncEventsFormat(e.invite_state,r);await this.injectRoomEvents(r,n);let i=null===(t=r.currentState.getStateEvents(f.EventType.RoomMember,u.getUserId()))||void 0===t?void 0:t.getSender(),o=u.crypto;if(o)for(let e of(await o.cryptoStore.takeParkedSharedHistory(r.roomId)))e.senderId===i&&await o.olmDevice.addInboundGroupSession(r.roomId,e.senderKey,e.forwardingCurve25519KeyChain,e.sessionId,e.sessionKey,e.keysClaimed,!0,{sharedHistory:!0,untrusted:!0});e.isBrandNewRoom?(r.recalculate(),u.store.storeRoom(r),u.emit(h.ClientEvent.Room,r)):r.recalculate(),n.forEach(function(e){u.emit(h.ClientEvent.Event,e)})}),await (0,a.promiseMapSeries)(g,async t=>{var r,n,i,o,a,l;let p=t.room,g=this.mapSyncEventsFormat(t.state,p),m=this.mapSyncEventsFormat(t.timeline,p,!1),v=this.mapSyncEventsFormat(t.ephemeral),b=this.mapSyncEventsFormat(t.account_data),S=this.isRoomEncrypted(p,g,m);t.unread_notifications&&(S&&0!==t.unread_notifications.notification_count||p.setUnreadNotificationCount(s.NotificationCountType.Total,null!==(n=t.unread_notifications.notification_count)&&void 0!==n?n:0),(!S||0>=p.getUnreadNotificationCount(s.NotificationCountType.Highlight))&&p.setUnreadNotificationCount(s.NotificationCountType.Highlight,null!==(i=t.unread_notifications.highlight_count)&&void 0!==i?i:0));let E=null!==(r=t[y.UNREAD_THREAD_NOTIFICATIONS.name])&&void 0!==r?r:t[y.UNREAD_THREAD_NOTIFICATIONS.altName];if(E)for(let[e,t]of(p.resetThreadUnreadNotificationCount(Object.keys(E)),Object.entries(E))){S&&0!==t.notification_count||p.setThreadUnreadNotificationCount(e,s.NotificationCountType.Total,null!==(o=t.notification_count)&&void 0!==o?o:0);let r=0>=p.getThreadUnreadNotificationCount(e,s.NotificationCountType.Highlight);(!S||S&&r)&&p.setThreadUnreadNotificationCount(e,s.NotificationCountType.Highlight,null!==(a=t.highlight_count)&&void 0!==a?a:0)}else p.resetThreadUnreadNotificationCount();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&p.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.EventTimeline.BACKWARDS);else if(t.timeline.limited){let r=!0;for(let e=m.length-1;e>=0;e--){let t=m[e].getId();if(p.getTimelineForEvent(t)){C("Already have event ".concat(t," in limited sync - not resetting")),r=!1,m.splice(0,e);break}}r&&(p.resetLiveTimeline(t.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(p.roomId)?null:null!==(l=e.oldSyncToken)&&void 0!==l?l:null),u.resetNotifTimelineSet())}if(this.syncOpts.cryptoCallbacks)for(let e of g.concat(m))e.isState()&&e.getType()===f.EventType.RoomEncryption&&""===e.getStateKey()&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(p,e);try{await this.injectRoomEvents(p,g,m,e.fromCache)}catch(e){d.logger.error("Failed to process events on room ".concat(p.roomId,":"),e)}t.summary&&p.setSummary(t.summary),p.addEphemeralEvents(v),p.addAccountData(b),p.recalculate(),t.isBrandNewRoom&&(u.store.storeRoom(p),u.emit(h.ClientEvent.Room,p)),this.processEventsForNotifs(p,m);let _=e=>u.emit(h.ClientEvent.Event,e);g.forEach(_),m.forEach(_),v.forEach(_),b.forEach(_),p.decryptCriticalEvents()}),await (0,a.promiseMapSeries)(m,async e=>{let t=e.room,r=this.mapSyncEventsFormat(e.state,t),n=this.mapSyncEventsFormat(e.timeline,t),i=this.mapSyncEventsFormat(e.account_data);await this.injectRoomEvents(t,r,n),t.addAccountData(i),t.recalculate(),e.isBrandNewRoom&&(u.store.storeRoom(t),u.emit(h.ClientEvent.Room,t)),this.processEventsForNotifs(t,n),r.forEach(function(e){u.emit(h.ClientEvent.Event,e)}),n.forEach(function(e){u.emit(h.ClientEvent.Event,e)}),i.forEach(function(e){u.emit(h.ClientEvent.Event,e)})}),await (0,a.promiseMapSeries)(v,async e=>{let t=e.room,r=this.mapSyncEventsFormat(e.knock_state,t);await this.injectRoomEvents(t,r),e.isBrandNewRoom?(t.recalculate(),u.store.storeRoom(t),u.emit(h.ClientEvent.Room,t)):t.recalculate(),r.forEach(function(e){u.emit(h.ClientEvent.Event,e)})}),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(function(e){var t;null===(t=u.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)})),t.device_lists&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists),await (null===(i=this.syncOpts.cryptoCallbacks)||void 0===i?void 0:i.processKeyCounts(t.device_one_time_keys_count,null!==(l=t.device_unused_fallback_key_types)&&void 0!==l?l:t["org.matrix.msc2732.device_unused_fallback_key_types"]))}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=(0,a.defer)()),this.connectionReturnedDefer.promise}pokeKeepAlive(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0);return}let r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(t),this.connectionReturnedDefer=void 0)};this.client.http.request(p.Method.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(e=this.abortController)||void 0===e?void 0:e.signal}).then(()=>{r()},e=>{400==e.httpStatus||404==e.httpStatus?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(I.Error,{error:e}))})}mapSyncResponseToRoomArray(e){let t=this.client;return Object.keys(e).filter(e=>!(0,a.unsafeProp)(e)).map(r=>{let n=t.store.getRoom(r),i=!1;return n||(n=this.createRoom(r),i=!0),E(E({},e[r]),{},{room:n,isBrandNewRoom:i})})}mapSyncEventsFormat(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(!e||!Array.isArray(e.events))return[];let n=this.client.getEventMapper({decrypt:r});return e.events.filter(a.noUnsafeEventProps).map(function(e){return t&&(e.room_id=t.roomId),n(e)})}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;let t=this.client;e.getMembersWithMembership("invite").forEach(function(r){let n;if(r.requestedProfileInfo)return;r.requestedProfileInfo=!0;let i=t.getUser(r.userId);(n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(r.userId)).then(function(t){let n=r.events.member;(null==n?void 0:n.getContent().membership)==="invite"&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})})}findEncryptionEvent(e){return null==e?void 0:e.find(e=>e.getType()===f.EventType.RoomEncryption&&""===e.getStateKey())}isRoomEncrypted(e,t,r){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(r)}async injectRoomEvents(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(let e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t,{timelineWasEmpty:o})}this.resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),await e.addLiveEvents(r||[],{fromCache:n,timelineWasEmpty:o}),this.client.processBeaconEvents(e,r)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(let e of t){var r;let t=this.client.getPushActionsForEvent(e);null!=t&&t.notify&&null!==(r=t.tweaks)&&void 0!==r&&r.highlight&&this.notifEvents.push(e)}}getGuestFilter(){return"{}"}updateSyncState(e,t){let r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(h.ClientEvent.Sync,this.syncState,r,t)}constructor(e,t,r){(0,i.default)(this,"_peekRoom",null),(0,i.default)(this,"syncState",null),(0,i.default)(this,"catchingUp",!1),(0,i.default)(this,"running",!1),(0,i.default)(this,"notifEvents",[]),(0,i.default)(this,"failedSyncCount",0),(0,i.default)(this,"storeIsInvalid",!1),(0,i.default)(this,"getPushRules",async()=>{try{C("Getting push rules...");let e=await this.client.getPushRules();C("Got push rules"),this.client.pushRules=e}catch(e){if(d.logger.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return C("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getPushRules()}}),(0,i.default)(this,"buildDefaultFilter",()=>{let e=new l.Filter(this.client.credentials.userId);return this.client.canSupport.get(b.Feature.ThreadUnreadNotifications)!==b.ServerSupport.Unsupported&&e.setUnreadThreadNotifications(!0),e}),(0,i.default)(this,"checkLazyLoadStatus",async()=>{if(C("Checking lazy load status..."),this.opts.lazyLoadMembers&&this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(C("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)),C("Checking whether lazy loading has changed in store..."),await this.wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this.storeIsInvalid=!0;let e=new u.InvalidStoreError(u.InvalidStoreState.ToggledLazyLoading,!!this.opts.lazyLoadMembers);this.updateSyncState(I.Error,{error:e}),d.logger.warn("InvalidStoreError: store is not usable: stopping sync.");return}if(this.opts.lazyLoadMembers){var e;null===(e=this.syncOpts.crypto)||void 0===e||e.enableLazyLoading()}try{C("Storing client options..."),await this.client.storeClientOptions(),C("Stored client options")}catch(e){throw d.logger.error("Storing client options failed",e),e}}),(0,i.default)(this,"getFilter",async()=>{let e,t;C("Getting filter..."),e=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{t=await this.client.getOrCreateFilter(R(this.client.credentials.userId),e)}catch(e){if(d.logger.error("Getting filter failed",e),this.shouldAbortSync(e))return{};return C("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getFilter()}return{filter:e,filterId:t}}),(0,i.default)(this,"onOnline",()=>{C("Browser thinks we are back online"),this.startKeepAlives(0)}),this.client=e,this.opts=M(t),this.syncOpts=P(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[s.RoomEvent.Timeline,s.RoomEvent.TimelineReset])}}function D(e,t,r){let{timelineSupport:n}=e,i=new s.Room(t,e,e.getUserId(),{lazyLoadMembers:r.lazyLoadMembers,pendingEventOrdering:r.pendingEventOrdering,timelineSupport:n});return e.reEmitter.reEmit(i,[s.RoomEvent.Name,s.RoomEvent.Redaction,s.RoomEvent.RedactionCancelled,s.RoomEvent.Receipt,s.RoomEvent.Tags,s.RoomEvent.LocalEchoUpdated,s.RoomEvent.AccountData,s.RoomEvent.MyMembership,s.RoomEvent.Timeline,s.RoomEvent.TimelineReset,g.RoomStateEvent.Events,g.RoomStateEvent.Members,g.RoomStateEvent.NewMember,g.RoomStateEvent.Update,v.BeaconEvent.New,v.BeaconEvent.Update,v.BeaconEvent.Destroy,v.BeaconEvent.LivenessChange]),i.on(g.RoomStateEvent.NewMember,(t,r,n)=>{var i;n.user=null!==(i=e.getUser(n.userId))&&void 0!==i?i:void 0,e.reEmitter.reEmit(n,[m.RoomMemberEvent.Name,m.RoomMemberEvent.Typing,m.RoomMemberEvent.PowerLevel,m.RoomMemberEvent.Membership])}),i}t.SyncApi=A},12994:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getRelationsThreadFilter=i;var n=r(93655);function i(e){return t=>{var r,i;return(null===(r=t.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r.event_id)!==e||(null===(i=t.content)||void 0===i||null===(i=i["m.relates_to"])||void 0===i?void 0:i.rel_type)===n.THREAD_RELATION_TYPE.name}}},15809:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=t.TimelineIndex=void 0;var i=n(r(13102)),o=r(91776),s=(r(34002),r(29197));let a=function(){},l=10;class c{load(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=r=>{let n;if(!r)throw Error("No timeline given to initFields");let i=r.getEvents();if(e){if((n=i.findIndex(t=>t.getId()===e))<0)throw Error("getEventTimeline result didn't include requested event")}else n=i.length;let o=Math.min(i.length,n+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new d(r,s-r.getBaseIndex()),this.end=new d(r,o-r.getBaseIndex()),this.eventCount=o-s};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,r;if(e==o.EventTimeline.BACKWARDS)return null!==(t=this.start)&&void 0!==t?t:null;if(e==o.EventTimeline.FORWARDS)return null!==(r=this.end)&&void 0!==r?r:null;throw Error("Invalid direction '"+e+"'")}extend(e,t){let r=this.getTimelineIndex(e);if(!r)return a("TimelineWindow: no timeline yet"),!1;let n=e==o.EventTimeline.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,a("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");let t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=o.EventTimeline.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){let e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){let t=this.getTimelineIndex(e);if(!t)return a("TimelineWindow: no timeline yet"),!1;if(e==o.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;let r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}async paginate(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:l,i=this.getTimelineIndex(e);if(!i)return a("TimelineWindow: no timeline yet"),!1;if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(e,t))return!0;if(!r||0===n)return!1;if(!i.timeline.getPaginationToken(e))return a("TimelineWindow: no token"),!1;a("TimelineWindow: starting request");let s=this.client.paginateEventTimeline(i.timeline,{backwards:e==o.EventTimeline.BACKWARDS,limit:t}).finally(function(){i.pendingPaginate=void 0}).then(r=>(a("TimelineWindow: request completed with result "+r),r)?this.paginate(e,t,!0,n-1):this.paginate(e,t,!1,0));return i.pendingPaginate=s,s}unpaginate(e,t){let r=t?this.start:this.end;if(!r)throw Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){let n=t?r.advance(e):r.retreat(e);if(n<=0)throw Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,a("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];let e=[],t=this.start.timeline;for(;t;){var r,n;let i=t.getEvents(),s=0,a=i.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===(null===(r=this.end)||void 0===r?void 0:r.timeline)&&(a=this.end.index+t.getBaseIndex());for(let t=s;t<a;t++)e.push(i[t]);if(t===(null===(n=this.end)||void 0===n?void 0:n.timeline))break;t=t.getNeighbouringTimeline(o.EventTimeline.FORWARDS)}return e}constructor(e,t,r={}){var n;(0,i.default)(this,"eventCount",0),this.client=e,this.timelineSet=t,this.windowLimit=r.windowLimit||1e3,null===(n=t.room)||void 0===n||n.on(s.RoomEvent.Timeline,this.onTimelineEvent.bind(this))}}t.TimelineWindow=c;class d{minIndex(){return -1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){let t;if(!e)return 0;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;let r=this.timeline.getNeighbouringTimeline(e<0?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),a("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return -1*this.advance(-1*e)}constructor(e,t){this.timeline=e,this.index=t}}t.TimelineIndex=d},44480:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MapWithDefault=t.DEFAULT_ALPHABET=void 0,t.alphabetPad=K,t.averageBetweenStrings=W,t.baseToString=q,t.checkObjectHasKeys=b,t.chunkPromises=N,t.compare=Y,t.decodeParams=g,t.deepCompare=E,t.deepCopy=S,t.deepSortedObjectEntries=_,t.defer=j,t.encodeParams=p,t.encodeUri=m,t.ensureNoTrailingSlash=M,t.escapeRegExp=C,t.globToRegexp=k,t.immediate=D,t.internaliseString=h,t.isFunction=y,t.isNullOrUndefined=x,t.isNumber=w,t.isSupportedReceiptType=Z,t.lexicographicCompare=z,t.logDuration=A,t.mapsEqual=ee,t.nextString=G,t.noUnsafeEventProps=eo,t.normalize=O,t.prevString=H,t.promiseMapSeries=U,t.promiseTry=L,t.recursiveMapToObject=er,t.recursivelyAssign=Q,t.removeDirectionOverrideChars=I,t.removeElement=v,t.removeHiddenChars=T,t.replaceParam=f,t.safeSet=ei,t.simpleRetryOperation=B,t.sleep=P,t.sortEventsByLatestContentTimestamp=$,t.stringToBase=V,t.unsafeProp=en;var i=n(r(13102)),o=n(r(97819)),s=n(r(42759)),a=r(13043),l=r(64157);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}let u=new Map;function h(e){return e instanceof String&&(e=e.toString()),u.has(e)||u.set(e,e),u.get(e)}function p(e,t){let r=null!=t?t:new URLSearchParams;for(let[t,n]of Object.entries(e))null!=n&&(Array.isArray(n)?n.forEach(e=>{r.append(t,String(e))}):r.append(t,String(n)));return r}function f(e,t,r){let n=d(d({},r),{},{[t]:r[e]});return delete n[e],n}function g(e){let t={},r=new URLSearchParams(e);for(let e of r.keys()){let n=r.getAll(e);t[e]=1===n.length?n[0]:n}return t}function m(e,t){for(let r in t){if(!t.hasOwnProperty(r))continue;let n=t[r];null!=n&&(e=e.replace(r,encodeURIComponent(n)))}return e}function v(e,t,r){let n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e.splice(n,1),!0}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e.splice(n,1),!0;return!1}function y(e){return"[object Function]"===Object.prototype.toString.call(e)}function b(e,t){for(let r of t)if(!e.hasOwnProperty(r))throw Error("Missing required key: "+r)}function S(e){return JSON.parse(JSON.stringify(e))}function E(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object)||e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!E(e[r],t[r]))return!1}else{for(let r in t)if(t.hasOwnProperty(r)!==e.hasOwnProperty(r))return!1;for(let r in e)if(t.hasOwnProperty(r)!==e.hasOwnProperty(r)||!E(e[r],t[r]))return!1}return!0}function _(e){if("object"!=typeof e||null==e||Array.isArray(e))return e;let t=[];for(let[r,n]of Object.entries(e))t.push([r,_(n)]);return t.sort((e,t)=>z(e[0],t[0])),t}function w(e){return"number"==typeof e&&isFinite(e)}function T(e){return"string"==typeof e?(0,o.default)(e.normalize("NFD").replace(R,"")):""}function I(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function O(e){return T(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}let R=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function C(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(e){return C(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function M(e){return null!=e&&e.endsWith("/")?e.slice(0,-1):e}function P(e,t){return new Promise(r=>{setTimeout(r,e,t)})}async function A(e,t,r){let n=Date.now();try{return await r()}finally{let r=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(r-n,"ms"))}}function D(){return new Promise(setImmediate)}function x(e){return null==e}function j(){let e,t;let r=new Promise((r,n)=>{e=r,t=n});return{resolve:e,reject:t,promise:r}}async function U(e,t){for(let r of e)await t(await r)}function L(e){return Promise.resolve(e())}async function N(e,t){let r=[];for(let n=0;n<e.length;n+=t)r.push(...await Promise.all(e.slice(n,n+t).map(e=>e())));return r}function B(e){return(0,s.default)(t=>e(t),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}let F=t.DEFAULT_ALPHABET=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function K(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F;return e.padEnd(t,r[0])}function q(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F,r=BigInt(t.length);if(e<=r){var n;return null!==(n=t[Number(e)-1])&&void 0!==n?n:""}let i=e/r,o=Number(e%r)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(r)-1),q(i,t)+t[o]}function V(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F,r=BigInt(t.length),n=BigInt(0);for(let i=e.length-1,o=BigInt(0);i>=0;i--,o++)n+=BigInt(1+(e.charCodeAt(i)-t.charCodeAt(0)))*r**o;return n}function W(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:F,n=Math.max(e.length,t.length),i=V(K(e,n,r),r),o=V(K(t,n,r),r),s=(i+o)/BigInt(2);return s===i||s==o?q(s,r)+r[0]:q(s,r)}function G(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F;return q(V(e,t)+BigInt(1),t)}function H(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F;return q(V(e,t)-BigInt(1),t)}function z(e,t){return e<t?-1:e>t?1:0}let J=new Intl.Collator;function Y(e,t){return J.compare(e,t)}function Q(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(let[n,i]of Object.entries(t)){if(e[n]instanceof Object&&i){Q(e[n],i);continue}if(null!=i||!r){ei(e,n,i);continue}}return e}function X(e){var t;return null!==(t=a.M_TIMESTAMP.findIn(e.getContent()))&&void 0!==t?t:-1}function $(e,t){return X(t)-X(e)}function Z(e){return[l.ReceiptType.Read,l.ReceiptType.ReadPrivate].includes(e)}function ee(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e===t;if(e.size!==t.size)return!1;for(let[n,i]of e){let e=t.get(n);if(void 0===e||!r(i,e))return!1}return!0}function et(e){return e instanceof Map?er(e):Array.isArray(e)?e.map(e=>et(e)):e}function er(e){let t=new Map;for(let[r,n]of e)t.set(r,et(n));return Object.fromEntries(t.entries())}function en(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function ei(e,t,r){if(en(t))throw Error("Trying to modify prototype or constructor");e[t]=r}function eo(e){return!(en(e.room_id)||en(e.sender)||en(e.user_id)||en(e.event_id))}class es extends Map{getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}constructor(e){super(),this.createDefault=e}}t.MapWithDefault=es},15715:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SUPPORTED_MATRIX_VERSIONS=t.MINIMUM_MATRIX_VERSION=t.MAXIMUM_MATRIX_VERSION=void 0;let r=t.SUPPORTED_MATRIX_VERSIONS=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];t.MINIMUM_MATRIX_VERSION=r[0],t.MAXIMUM_MATRIX_VERSION=r[r.length-1]},41400:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.releaseContext=t.acquireContext=void 0;let r=null,n=0,i=()=>(null===r&&(r=new AudioContext),n++,r);t.acquireContext=i;let o=()=>{if(0==--n){var e;null===(e=r)||void 0===e||e.close(),r=null}};t.releaseContext=o},59721:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixCall=t.FALLBACK_ICE_SERVER=t.CallType=t.CallState=t.CallParty=t.CallEvent=t.CallErrorCode=t.CallError=t.CallDirection=void 0,t.createNewMatrixCall=F,t.genCallID=x,t.setTracksEnabled=N,t.supportsMatrixCall=B;var i=n(r(13102)),o=r(2461),s=r(64109),a=r(34002),l=r(44480),c=r(15748),d=r(89027),u=r(95534),h=r(71968),p=r(44441),f=r(5382),g=r(41943),m=r(498);function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var b=function(e){return e.AUDIO="audio",e.VIDEO="video",e}(b||{}),S=function(e){return e.OPUS="opus",e}(S||{});let E=t.CallState=function(e){return e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended",e}({}),_=t.CallType=function(e){return e.Voice="voice",e.Video="video",e}({}),w=t.CallDirection=function(e){return e.Inbound="inbound",e.Outbound="outbound",e}({}),T=t.CallParty=function(e){return e.Local="local",e.Remote="remote",e}({}),I=t.CallEvent=function(e){return e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event",e.PeerConnectionCreated="peer_connection_created",e}({}),O=t.CallErrorCode=function(e){return e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session",e}({}),R="1",C=t.FALLBACK_ICE_SERVER="stun:turn.matrix.org",k=6e4,M=1e3,P=3e4,A=2e3;class D extends Error{constructor(e,t,r){super(t+": "+r),this.code=e}}function x(){return Date.now().toString()+(0,d.randomString)(16)}function j(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}function U(e,t){return e+":"+t}t.CallError=D;class L extends p.TypedEventEmitter{async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){let r=this.peerConn.createDataChannel(e,t);return this.emit(I.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){let t=this._state;this._state=e,this.emit(I.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?_.Video:_.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!(null!==(e=this.localUsermediaStream)&&void 0!==e&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===u.SDPStreamMetadataPurpose.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!(null!==(e=this.localUsermediaStream)&&void 0!==e&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===u.SDPStreamMetadataPurpose.Usermedia&&!!(null!==(t=e.stream)&&void 0!==t&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(null===(e=this.transceivers.get(U(u.SDPStreamMetadataPurpose.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return!!(null===(e=this.transceivers.get(U(u.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===u.SDPStreamMetadataPurpose.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===u.SDPStreamMetadataPurpose.Screenshare)}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===u.SDPStreamMetadataPurpose.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===u.SDPStreamMetadataPurpose.Screenshare)}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}async initOpponentCrypto(){var e,t;if(!this.opponentDeviceId||!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled()){this.opponentDeviceInfo=new f.DeviceInfo(this.opponentDeviceId);return}if(!this.client.crypto)throw Error("Crypto is not initialised.");let r=this.invitee||(null===(e=this.getOpponentMember())||void 0===e?void 0:e.userId);if(!r)throw Error("Couldn't find opponent user ID to init crypto");let n=await this.client.crypto.deviceList.downloadKeys([r],!1);if(this.opponentDeviceInfo=null===(t=n.get(r))||void 0===t?void 0:t.get(this.opponentDeviceId),void 0===this.opponentDeviceInfo)throw new g.GroupCallUnknownDeviceError(r)}getLocalSDPStreamMetadata(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={};for(let r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}let t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;if(!r){a.logger.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){a.logger.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new h.CallFeed({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:i})),this.emit(I.FeedsChanged,this.feeds,this),a.logger.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))}pushRemoteFeedWithoutMetadata(e){var t;let r=this.getOpponentMember().userId,n=u.SDPStreamMetadataPurpose.Usermedia,i=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(i&&e.id!==i.id){a.logger.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){a.logger.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new h.CallFeed({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(I.FeedsChanged,this.feeds,this),a.logger.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=this.client.getUserId();if(N(e.getAudioTracks(),!0),N(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){a.logger.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new h.CallFeed({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this.feeds.some(t=>e.stream.id===t.stream.id)){a.logger.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),t)for(let t of e.stream.getTracks()){a.logger.info("Call ".concat(this.callId," pushLocalFeed() adding track to peer connection (id=").concat(t.id,", kind=").concat(t.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(t.enabled,")"));let r=U(e.purpose,t.kind);if(this.transceivers.has(r)){let e=this.transceivers.get(r);e.sender.replaceTrack(t),e.direction="inactive"===e.direction?"sendonly":"sendrecv"}else{let n=this.peerConn.addTrack(t,e.stream),i=this.peerConn.getTransceivers().find(e=>e.sender===n);i?this.transceivers.set(r,i):a.logger.warn("Call ".concat(this.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}}a.logger.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(I.FeedsChanged,this.feeds,this)}removeLocalFeed(e){for(let t of[U(e.purpose,"audio"),U(e.purpose,"video")])if(this.transceivers.has(t)){let e=this.transceivers.get(t);e.sender&&this.peerConn.removeTrack(e.sender)}e.purpose===u.SDPStreamMetadataPurpose.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(let e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(I.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){let t=this.getFeedByStreamId(e.id);if(!t){a.logger.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(I.FeedsChanged,this.feeds,this)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;let e=await this.peerConn.getStats(),t=[];return e.forEach(e=>{t.push(e)}),t}async initWithInvite(e){var t;let r=e.getContent();this.direction=w.Inbound,await this.client.checkTurnServers()||a.logger.warn("Call ".concat(this.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));let n=r[u.SDPStreamMetadataKey];n?this.updateRemoteSDPStreamMetadata(n):a.logger.debug("Call ".concat(this.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),this.peerConn=this.createPeerConnection(),this.emit(I.PeerConnectionCreated,this.peerConn,this),this.chooseOpponent(e),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(r.offer),a.logger.debug("Call ".concat(this.callId," initWithInvite() set remote description: ").concat(r.offer.type)),await this.addBufferedIceCandidates()}catch(e){a.logger.debug("Call ".concat(this.callId," initWithInvite() failed to set remote description"),e),this.terminate(T.Local,O.SetRemoteDescription,!1);return}let i=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(!this.isOnlyDataChannelAllowed&&(!i||0===i.getTracks().length)){a.logger.error("Call ".concat(this.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),this.terminate(T.Local,O.SetRemoteDescription,!1);return}if(this.state=E.Ringing,e.getLocalAge()){let t=setTimeout(()=>{if(this.state==E.Ringing){var e;a.logger.debug("Call ".concat(this.callId," initWithInvite() invite has expired. Hanging up.")),this.hangupParty=T.Remote,this.state=E.Ended,this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),null===(e=this.stats)||void 0===e||e.removeStatsReportGatherer(this.callId),this.emit(I.Hangup,this)}},r.lifetime-e.getLocalAge()),n=e=>{e!==E.Ringing&&(clearTimeout(t),this.off(I.State,n))};this.on(I.State,n)}}initWithHangup(e){this.state=E.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(a.logger.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):(0,l.isNullOrUndefined)(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(a.logger.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw Error("You CANNOT answer a call without media");if(this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&(this.state=E.WaitLocalMedia);else{let n=this.state,i=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),o=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.state=E.WaitLocalMedia,this.waitForLocalAVStream=!0;try{var r;let e=await this.client.getMediaHandler().getUserMediaStream(i,o);this.waitForLocalAVStream=!1;let t=[new h.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(r=this.client.getDeviceId())&&void 0!==r?r:void 0,stream:e,purpose:u.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(o)a.logger.warn("Call ".concat(this.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),this.state=n,this.waitForLocalAVStream=!1,await this.answer(i,!1);else{this.getUserMediaFailed(e);return}}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){a.logger.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===E.WaitLocalMedia?(a.logger.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[E.CreateOffer,E.InviteSent].includes(this.state)&&(e.direction===w.Outbound?e.queueGotCallFeedsForAnswer([]):(a.logger.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(e=>e.clone())))),this.successor=e,this.emit(I.Replaced,e,this),this.hangup(O.Replaced,!0)}hangup(e,t){if(this.callHasEnded()||(a.logger.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(T.Local,e,!t),[E.Fledgling,E.WaitLocalMedia].includes(this.state)))return;let r={};(this.opponentVersion&&0!==this.opponentVersion||e!==O.UserHangup)&&(r.reason=e),this.sendVoipEvent(c.EventType.CallHangup,r)}reject(){if(this.state!==E.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion){a.logger.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(O.UserHangup,!0);return}a.logger.debug("Rejecting call: "+this.callId),this.terminate(T.Local,O.UserHangup,!0),this.sendVoipEvent(c.EventType.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{a.logger.debug("Call ".concat(this.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));let r=e||this.hasLocalUserMediaAudioTrack,n=t||this.hasLocalUserMediaVideoTrack,i=await this.client.getMediaHandler().getUserMediaStream(r,n,!1);await this.updateLocalUsermediaStream(i,e,t)}catch(e){a.logger.error("Call ".concat(this.callId," upgradeCall() failed to upgrade the call"),e),this.emit(I.Error,new D(O.NoUserMedia,"Failed to get camera access: ",e),this)}}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return a.logger.warn("Call ".concat(this.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!this.isScreensharing())return a.logger.warn("Call ".concat(this.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(a.logger.debug("Call ".concat(this.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{let e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;return this.pushNewLocalFeed(e,u.SDPStreamMetadataPurpose.Screenshare),!0}catch(e){return a.logger.error("Call ".concat(this.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),e),!1}else{for(let e of[this.transceivers.get(U(u.SDPStreamMetadataPurpose.Screenshare,"audio")),this.transceivers.get(U(u.SDPStreamMetadataPurpose.Screenshare,"video"))])e&&e.sender&&this.peerConn.removeTrack(e.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){var r,n,i;if(a.logger.debug("Call ".concat(this.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{let e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;let n=e.getTracks().find(e=>"video"===e.kind),i=null===(r=this.transceivers.get(U(u.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===r?void 0:r.sender;return null==i||i.replaceTrack(null!=n?n:null),this.pushNewLocalFeed(e,u.SDPStreamMetadataPurpose.Screenshare,!1),!0}catch(e){return a.logger.error("Call ".concat(this.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),e),!1}else{let e=null===(n=this.localUsermediaStream)||void 0===n?void 0:n.getTracks().find(e=>"video"===e.kind),t=null===(i=this.transceivers.get(U(u.SDPStreamMetadataPurpose.Usermedia,"video")))||void 0===i?void 0:i.sender;return null==t||t.replaceTrack(null!=e?e:null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async updateLocalUsermediaStream(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.localUsermediaFeed,i=t||!n.isAudioMuted()&&!this.remoteOnHold,o=r||!n.isVideoMuted()&&!this.remoteOnHold;for(let t of(a.logger.log("Call ".concat(this.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(i,", video=").concat(o,")")),N(e.getAudioTracks(),i),N(e.getVideoTracks(),o),this.localUsermediaStream.getTracks()))this.localUsermediaStream.removeTrack(t),t.stop();for(let t of e.getTracks())this.localUsermediaStream.addTrack(t);for(let t of e.getTracks()){let r=U(u.SDPStreamMetadataPurpose.Usermedia,t.kind),i=this.transceivers.get(r),o=null==i?void 0:i.sender,s=!1;if(o)try{a.logger.info("Call ".concat(this.callId," updateLocalUsermediaStream() replacing track (id=").concat(t.id,", kind=").concat(t.kind,", streamId=").concat(e.id,", streamPurpose=").concat(n.purpose,")")),await o.replaceTrack(t),i.direction="inactive"===i.direction?"sendonly":"sendrecv",s=!0}catch(e){a.logger.warn("Call ".concat(this.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),e)}if(!s){a.logger.info("Call ".concat(this.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(t.id,", kind=").concat(t.kind,", streamId=").concat(e.id,", streamPurpose=").concat(n.purpose,")"));let i=this.peerConn.addTrack(t,this.localUsermediaStream),o=this.peerConn.getTransceivers().find(e=>e.sender===i);o?this.transceivers.set(r,o):a.logger.warn("Call ".concat(this.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}}}async setLocalVideoMuted(e){var t,r;if(a.logger.log("Call ".concat(this.callId," setLocalVideoMuted() running ").concat(e)),e||void 0===this.stopVideoTrackTimer||(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!e)return null===(r=this.localUsermediaFeed)||void 0===r||r.setAudioVideoMuted(null,e),await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!e&&0===this.localUsermediaStream.getVideoTracks().length){let e=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(e)}return null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(null,e),this.updateMuteStatus(),await this.sendMetadataUpdate(),e&&(this.stopVideoTrackTimer=setTimeout(()=>{for(let e of this.localUsermediaStream.getVideoTracks())e.stop(),this.localUsermediaStream.removeTrack(e)},120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}async setMicrophoneMuted(e){var t;return a.logger.log("Call ".concat(this.callId," setMicrophoneMuted() running ").concat(e)),await this.client.getMediaHandler().hasAudioDevice()&&(e||this.hasUserMediaAudioSender&&this.hasLocalUserMediaAudioTrack?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),await this.sendMetadataUpdate()):await this.upgradeCall(!0,!1)),this.isMicrophoneMuted()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){for(let t of(this.remoteOnHold=e,this.peerConn.getTransceivers()))t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(I.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==E.Connected)return!1;let e=!0;for(let t of this.peerConn.getTransceivers())["inactive","recvonly"].includes(t.currentDirection)||(e=!1);return e}sendDtmfDigit(e){for(let r of this.peerConn.getSenders()){var t;if((null===(t=r.track)||void 0===t?void 0:t.kind)==="audio"&&r.dtmf){r.dtmf.insertDTMF(e);return}}throw Error("Unable to find a track to send DTMF on")}updateMuteStatus(){let e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;a.logger.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),N(this.localUsermediaStream.getAudioTracks(),!e),N(this.localUsermediaStream.getVideoTracks(),!t)}async sendMetadataUpdate(){await this.sendVoipEvent(c.EventType.CallSDPStreamMetadataChangedPrefix,{[u.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(let t of e)this.pushLocalFeed(t);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=E.CreateOffer,a.logger.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}async sendAnswer(){let e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[u.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};let t=this.discardDuplicateCandidates();a.logger.info("Call ".concat(this.callId," sendAnswer() discarding ").concat(t," candidates that will be sent in answer"));try{await this.sendVoipEvent(c.EventType.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(r){this.state=E.Ringing,r instanceof m.MatrixError&&r.event&&this.client.cancelPendingEvent(r.event);let e=O.SendAnswer,t="Failed to send answer";throw"UnknownDeviceError"==r.name&&(e=O.UnknownDevices,t="Unknown devices present in the room"),this.emit(I.Error,new D(e,t,r),this),r}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){let r=(0,s.parse)(e.sdp);r.media.forEach(e=>{let r=new Map,n=new Map;for(let t of e.rtp)r.set(t.payload,t.codec),n.set(t.codec,t.payload);for(let i of t){if(i.mediaType!==e.type)continue;if(!n.has(i.codec)){a.logger.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(i.codec," as it's not present."));continue}let t=[];void 0!==i.enableDtx&&t.push("usedtx=".concat(i.enableDtx?"1":"0")),void 0!==i.maxAverageBitrate&&t.push("maxaveragebitrate=".concat(i.maxAverageBitrate));let o=!1;for(let n of e.fmtp)r.get(n.payload)===i.codec&&(o=!0,n.config+=";"+t.join(";"));o||e.fmtp.push({payload:n.get(i.codec),config:t.join(";")})}}),e.sdp=(0,s.write)(r)}async createOffer(){let e=await this.peerConn.createOffer();return this.mungeSdp(e,j(this.isPtt)),e}async createAnswer(){let e=await this.peerConn.createAnswer();return this.mungeSdp(e,j(this.isPtt)),e}async gotCallFeedsForAnswer(e){let t;if(!this.callHasEnded()){for(let t of(this.waitForLocalAVStream=!1,e))this.pushLocalFeed(t);this.state=E.CreateAnswer;try{this.getRidOfRTXCodecs(),t=await this.createAnswer()}catch(e){a.logger.debug("Call ".concat(this.callId," gotCallFeedsForAnswer() failed to create answer: "),e),this.terminate(T.Local,O.CreateAnswer,!0);return}try{if(await this.peerConn.setLocalDescription(t),this.callHasEnded()||(this.state=E.Connecting,await new Promise(e=>{setTimeout(e,200)}),this.callHasEnded()))return;this.sendAnswer()}catch(e){a.logger.debug("Call ".concat(this.callId," gotCallFeedsForAnswer() error setting local description!"),e),this.terminate(T.Local,O.SetLocalDescription,!0);return}}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;let t=e.getContent(),r=t.candidates;if(!r){a.logger.info("Call ".concat(this.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}let n=0===t.version?null:t.party_id||null;if(void 0===this.opponentPartyId){if(n){a.logger.info("Call ".concat(this.callId," onRemoteIceCandidatesReceived() buffering ").concat(r.length," candidates until we pick an opponent"));let e=this.remoteCandidateBuffer.get(n)||[];e.push(...r),this.remoteCandidateBuffer.set(n,e)}return}if(!this.partyIdMatches(t)){a.logger.info("Call ".concat(this.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(t.party_id,": we have chosen party ID ").concat(this.opponentPartyId));return}await this.addIceCandidates(r)}async onAnswerReceived(e){let t=e.getContent();if(a.logger.debug("Call ".concat(this.callId," onAnswerReceived() running (hangupParty=").concat(t.party_id,")")),this.callHasEnded()){a.logger.debug("Call ".concat(this.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(void 0!==this.opponentPartyId){a.logger.info("Call ".concat(this.callId," onAnswerReceived() ignoring answer from party ID ").concat(t.party_id,": we already have an answer/reject from ").concat(this.opponentPartyId));return}this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.state=E.Connecting;let r=t[u.SDPStreamMetadataKey];r?this.updateRemoteSDPStreamMetadata(r):a.logger.warn("Call ".concat(this.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{this.isSettingRemoteAnswerPending=!0,await this.peerConn.setRemoteDescription(t.answer),this.isSettingRemoteAnswerPending=!1,a.logger.debug("Call ".concat(this.callId," onAnswerReceived() set remote description: ").concat(t.answer.type))}catch(e){this.isSettingRemoteAnswerPending=!1,a.logger.debug("Call ".concat(this.callId," onAnswerReceived() failed to set remote description"),e),this.terminate(T.Local,O.SetRemoteDescription,!1);return}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(c.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){a.logger.warn("Call ".concat(this.callId," onAnswerReceived() failed to send select_answer event"),e)}}async onSelectAnswerReceived(e){if(this.direction!==w.Inbound){a.logger.warn("Call ".concat(this.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}let t=e.getContent().selected_party_id;if(null==t){a.logger.warn("Call ".concat(this.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}t!==this.ourPartyId&&(a.logger.info("Call ".concat(this.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(t,": we are party ID ").concat(this.ourPartyId,".")),await this.terminate(T.Remote,O.AnsweredElsewhere,!0))}async onNegotiateReceived(e){let t=e.getContent(),r=t.description;if(!r||!r.sdp||!r.type){a.logger.info("Call ".concat(this.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}let n=this.direction===w.Inbound,i=!this.makingOffer&&("stable"===this.peerConn.signalingState||this.isSettingRemoteAnswerPending),o="offer"===r.type&&!i;if(this.ignoreOffer=!n&&o,this.ignoreOffer){a.logger.info("Call ".concat(this.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}let s=this.isLocalOnHold(),l=t[u.SDPStreamMetadataKey];l?this.updateRemoteSDPStreamMetadata(l):a.logger.warn("Call ".concat(this.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(this.isSettingRemoteAnswerPending="answer"==r.type,await this.peerConn.setRemoteDescription(r),this.isSettingRemoteAnswerPending=!1,a.logger.debug("Call ".concat(this.callId," onNegotiateReceived() set remote description: ").concat(r.type)),"offer"===r.type){var d;let e;try{this.getRidOfRTXCodecs(),e=await this.createAnswer()}catch(e){a.logger.debug("Call ".concat(this.callId," onNegotiateReceived() failed to create answer: "),e),this.terminate(T.Local,O.CreateAnswer,!0);return}await this.peerConn.setLocalDescription(e),a.logger.debug("Call ".concat(this.callId," onNegotiateReceived() create an answer")),this.sendVoipEvent(c.EventType.CallNegotiate,{description:null===(d=this.peerConn.localDescription)||void 0===d?void 0:d.toJSON(),[u.SDPStreamMetadataKey]:this.getLocalSDPStreamMetadata(!0)})}}catch(e){this.isSettingRemoteAnswerPending=!1,a.logger.warn("Call ".concat(this.callId," onNegotiateReceived() failed to complete negotiation"),e)}let h=this.isLocalOnHold();s!==h&&(this.emit(I.LocalHoldUnhold,h,this),this.emit(I.HoldUnhold,h))}updateRemoteSDPStreamMetadata(e){for(let r of(this.remoteSDPStreamMetadata=(0,l.recursivelyAssign)(this.remoteSDPStreamMetadata||{},e,!0),this.getRemoteFeeds())){var t;let e=r.stream.id,n=this.remoteSDPStreamMetadata[e];r.setAudioVideoMuted(null==n?void 0:n.audio_muted,null==n?void 0:n.video_muted),r.purpose=null===(t=this.remoteSDPStreamMetadata[e])||void 0===t?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){let t=e.getContent()[u.SDPStreamMetadataKey];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){let t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(I.AssertedIdentityChanged,this))}callHasEnded(){return this.state===E.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(e){this.getLocalOfferFailed(e);return}finally{this.makingOffer=!1}}async gotLocalOffer(){var e,t;let r;if(a.logger.debug("Call ".concat(this.callId," gotLocalOffer() running")),this.callHasEnded()){a.logger.debug("Call ".concat(this.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}try{this.getRidOfRTXCodecs(),r=await this.createOffer()}catch(e){a.logger.debug("Call ".concat(this.callId," gotLocalOffer() failed to create offer: "),e),this.terminate(T.Local,O.CreateOffer,!0);return}try{await this.peerConn.setLocalDescription(r)}catch(e){a.logger.debug("Call ".concat(this.callId," gotLocalOffer() error setting local description!"),e),this.terminate(T.Local,O.SetLocalDescription,!0);return}if("gathering"===this.peerConn.iceGatheringState&&await new Promise(e=>{setTimeout(e,200)}),this.callHasEnded())return;let n=this.state===E.CreateOffer?c.EventType.CallInvite:c.EventType.CallNegotiate,i={lifetime:k};n===c.EventType.CallInvite&&this.invitee&&(i.invitee=this.invitee),this.state===E.CreateOffer?i.offer=null===(e=this.peerConn.localDescription)||void 0===e?void 0:e.toJSON():i.description=null===(t=this.peerConn.localDescription)||void 0===t?void 0:t.toJSON(),i.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},i[u.SDPStreamMetadataKey]=this.getLocalSDPStreamMetadata(!0);let o=this.discardDuplicateCandidates();a.logger.info("Call ".concat(this.callId," gotLocalOffer() discarding ").concat(o," candidates that will be sent in offer"));try{await this.sendVoipEvent(n,i)}catch(r){a.logger.error("Call ".concat(this.callId," gotLocalOffer() failed to send invite"),r),r instanceof m.MatrixError&&r.event&&this.client.cancelPendingEvent(r.event);let e=O.SignallingFailed,t="Signalling failed";this.state===E.CreateOffer&&(e=O.SendInvite,t="Failed to send invite"),"UnknownDeviceError"==r.name&&(e=O.UnknownDevices,t="Unknown devices present in the room"),this.emit(I.Error,new D(e,t,r),this),this.terminate(T.Local,e,!1);return}this.sendCandidateQueue(),this.state===E.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=E.InviteSent,this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=void 0,this.state===E.InviteSent&&this.hangup(O.InviteTimeout,!1)},k))}getRidOfRTXCodecs(){var e;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;let t=RTCRtpReceiver.getCapabilities("video").codecs,r=[...RTCRtpSender.getCapabilities("video").codecs,...t];for(let e of r)if("video/rtx"===e.mimeType){let t=r.indexOf(e);r.splice(t,1)}let n=this.transceivers.get(U(u.SDPStreamMetadataPurpose.Screenshare,"video"));null==n||null===(e=n.setCodecPreferences)||void 0===e||e.call(n,r)}async sendVoipEvent(e,t){var r,n;let i=Object.assign({},t,{version:R,call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){let t=this.toDeviceSeq++,n=y(y({},i),{},{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:t,[c.ToDeviceMessageId]:(0,o.v4)()});this.emit(I.SendVoipEvent,{type:"toDevice",eventType:e,userId:this.invitee||(null===(r=this.getOpponentMember())||void 0===r?void 0:r.userId),opponentDeviceId:this.opponentDeviceId,content:n},this);let s=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo){a.logger.warn("Call ".concat(this.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}await this.client.encryptAndSendToDevices([{userId:s,deviceInfo:this.opponentDeviceInfo}],{type:e,content:n})}else await this.client.sendToDevice(e,new Map([[s,new Map([[this.opponentDeviceId,n]])]]))}else this.emit(I.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:this.roomId,content:i,userId:this.invitee||(null===(n=this.getOpponentMember())||void 0===n?void 0:n.userId)},this),await this.client.sendEvent(this.roomId,e,i)}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state===E.Ringing||!this.inviteOrAnswerSent)return;let t=this.direction===w.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}discardDuplicateCandidates(){let e=0,t=[];for(let r=0;r<this.candidateSendQueue.length;r++){let n=this.candidateSendQueue[r];""===n.candidate?t.push(n):e++}return this.candidateSendQueue=t,e}async transfer(e){let t=await this.client.getProfileInfo(e),r=x(),n={replacement_id:x(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:r};await this.sendVoipEvent(c.EventType.CallReplaces,n),await this.terminate(T.Local,O.Transferred,!0)}async transferToCall(e){var t,r;let n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId,i=n?await this.client.getProfileInfo(n):void 0,o=null===(r=this.getOpponentMember())||void 0===r?void 0:r.userId,s=o?await this.client.getProfileInfo(o):void 0,a=x(),l={replacement_id:x(),target_user:{id:o,display_name:null==s?void 0:s.displayname,avatar_url:null==s?void 0:s.avatar_url},await_call:a};await e.sendVoipEvent(c.EventType.CallReplaces,l);let d={replacement_id:x(),target_user:{id:n,display_name:null==i?void 0:i.displayname,avatar_url:null==i?void 0:i.avatar_url},create_call:a};await this.sendVoipEvent(c.EventType.CallReplaces,d),await this.terminate(T.Local,O.Transferred,!0),await e.terminate(T.Local,O.Transferred,!0)}async terminate(e,t,r){var n;if(!this.callHasEnded()){for(let[r,n]of(this.hangupParty=e,this.hangupReason=t,this.state=E.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),void 0!==this.iceDisconnectedTimeout&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),void 0!==this.stopVideoTrackTimer&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),this.removeTrackListeners))r.removeEventListener("removetrack",n);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),null===(n=this.stats)||void 0===n||n.removeStatsReportGatherer(this.callId),r&&this.emit(I.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){for(let e of(a.logger.debug("Call ".concat(this.callId," stopAllMedia() running")),this.feeds))if(e.isLocal()&&e.purpose===u.SDPStreamMetadataPurpose.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===u.SDPStreamMetadataPurpose.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal())for(let t of(a.logger.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")")),e.stream.getTracks()))t.stop()}checkForErrorListener(){if(0===this.listeners(p.EventEmitterEvents.Error).length)throw Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length||this.callHasEnded())return;let e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;let t={candidates:e.map(e=>e.toJSON())};this.candidatesEnded&&t.candidates.push({candidate:""}),a.logger.debug("Call ".concat(this.callId," sendCandidateQueue() attempting to send ").concat(e.length," candidates"));try{await this.sendVoipEvent(c.EventType.CallCandidates,t),this.candidateSendTries=0,this.sendCandidateQueue()}catch(r){if(r instanceof m.MatrixError&&r.event&&this.client.cancelPendingEvent(r.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){a.logger.debug("Call ".concat(this.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(this.candidateSendTries,". Giving up on this call."),r);let e=O.SignallingFailed,t="Signalling failed";this.emit(I.Error,new D(e,t,r),this),this.hangup(e,!1);return}let t=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,a.logger.debug("Call ".concat(this.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(t,"ms"),r),setTimeout(()=>{this.sendCandidateQueue()},t)}}async placeCall(e,t){let r;if(!e)throw Error("You CANNOT start a call without audio");this.state=E.WaitLocalMedia;try{var n;let i=await this.client.getMediaHandler().getUserMediaStream(e,t);N(i.getAudioTracks(),!0),N(i.getVideoTracks(),!0),r=new h.CallFeed({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(n=this.client.getDeviceId())&&void 0!==n?n:void 0,stream:i,purpose:u.SDPStreamMetadataPurpose.Usermedia,audioMuted:!1,videoMuted:!1})}catch(e){this.getUserMediaFailed(e);return}try{await this.placeCallWithCallFeeds([r])}catch(e){this.placeCallFailed(e);return}}async placeCallWithCallFeeds(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.checkForErrorListener(),this.direction=w.Outbound,await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this),await this.client.checkTurnServers()||a.logger.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),this.peerConn=this.createPeerConnection(),this.emit(I.PeerConnectionCreated,this.peerConn,this),this.gotCallFeedsForInvite(e,t)}createPeerConnection(){var e;let t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);let r=this.getOpponentMember(),n=r?r.userId:"unknown";return null===(e=this.stats)||void 0===e||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t,r;let n=e.getContent();a.logger.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0,this.opponentMember&&(null===(r=this.stats)||void 0===r||r.updateOpponentMember(this.callId,this.opponentMember.userId))}async addBufferedIceCandidates(){let e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(a.logger.info("Call ".concat(this.callId," addBufferedIceCandidates() adding ").concat(e.length," buffered candidates for opponent ").concat(this.opponentPartyId)),await this.addIceCandidates(e)),this.remoteCandidateBuffer.clear()}async addIceCandidates(e){for(let t of e){(null===t.sdpMid||void 0===t.sdpMid)&&(null===t.sdpMLineIndex||void 0===t.sdpMLineIndex)?a.logger.debug("Call ".concat(this.callId," addIceCandidates() got remote ICE end-of-candidates")):a.logger.debug("Call ".concat(this.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(t.sdpMid,", candidate=").concat(t.candidate,")"));try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer?a.logger.debug("Call ".concat(this.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),e):a.logger.info("Call ".concat(this.callId," addIceCandidates() failed to add remote ICE candidate"),e)}}}get hasPeerConnection(){return!!this.peerConn}initStats(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],this.stats=e,this.stats.start()}constructor(e){var t;if(super(),(0,i.default)(this,"toDeviceSeq",0),(0,i.default)(this,"isPtt",!1),(0,i.default)(this,"_state",E.Fledgling),(0,i.default)(this,"candidateSendQueue",[]),(0,i.default)(this,"candidateSendTries",0),(0,i.default)(this,"candidatesEnded",!1),(0,i.default)(this,"feeds",[]),(0,i.default)(this,"transceivers",new Map),(0,i.default)(this,"inviteOrAnswerSent",!1),(0,i.default)(this,"waitForLocalAVStream",!1),(0,i.default)(this,"removeTrackListeners",new Map),(0,i.default)(this,"remoteOnHold",!1),(0,i.default)(this,"makingOffer",!1),(0,i.default)(this,"ignoreOffer",!1),(0,i.default)(this,"isSettingRemoteAnswerPending",!1),(0,i.default)(this,"remoteCandidateBuffer",new Map),(0,i.default)(this,"gotLocalIceCandidate",e=>{e.candidate&&(this.candidatesEnded&&a.logger.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),a.logger.debug("Call ".concat(this.callId," got local ICE ").concat(e.candidate.sdpMid," ").concat(e.candidate.candidate)),this.callHasEnded()||(""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)))}),(0,i.default)(this,"onIceGatheringStateChange",e=>{var t;a.logger.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)==="complete"&&(this.queueCandidate(null),a.logger.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),(0,i.default)(this,"getLocalOfferFailed",e=>{a.logger.error("Call ".concat(this.callId," getLocalOfferFailed() running"),e),this.emit(I.Error,new D(O.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(T.Local,O.LocalOfferFailed,!1)}),(0,i.default)(this,"getUserMediaFailed",e=>{if(this.successor){this.successor.getUserMediaFailed(e);return}a.logger.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),e),this.emit(I.Error,new D(O.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(T.Local,O.NoUserMedia,!1)}),(0,i.default)(this,"placeCallFailed",e=>{if(this.successor){this.successor.placeCallFailed(e);return}a.logger.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),e),this.emit(I.Error,new D(O.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(T.Local,O.IceFailed,!1)}),(0,i.default)(this,"onIceConnectionStateChanged",()=>{var e,t,r,n,i,o,s,l;if(!this.callHasEnded()&&(a.logger.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),["connected","completed"].includes(null!==(r=null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)&&void 0!==r?r:"")?(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=E.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(I.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},M))):(null===(i=this.peerConn)||void 0===i?void 0:i.iceConnectionState)=="failed"?(this.candidatesEnded=!1,null!==(s=this.peerConn)&&void 0!==s&&s.restartIce?(this.candidatesEnded=!1,a.logger.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat(null===(l=this.peerConn)||void 0===l?void 0:l.iceConnectionState,")")),this.peerConn.restartIce()):(a.logger.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(O.IceFailed,!1))):(null===(o=this.peerConn)||void 0===o?void 0:o.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var e,t,r;a.logger.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),null!==(r=this.peerConn)&&void 0!==r&&r.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},A),this.iceDisconnectedTimeout=setTimeout(()=>{a.logger.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(O.IceFailed,!1)},P),this.state=E.Connecting),this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState)))for(let e of this.getRemoteFeeds())e.setAudioVideoMuted(!0,!0)}),(0,i.default)(this,"onSignallingStateChanged",()=>{var e;a.logger.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.signalingState,")"))}),(0,i.default)(this,"onTrack",e=>{if(0===e.streams.length){a.logger.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(e.track.kind,")"));return}let t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){let e=()=>{0===t.getTracks().length&&(a.logger.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(t.id,")")),this.deleteFeedByStream(t),t.removeEventListener("removetrack",e),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",e),this.removeTrackListeners.set(t,e)}}),(0,i.default)(this,"onDataChannel",e=>{this.emit(I.DataChannel,e.channel,this)}),(0,i.default)(this,"onNegotiationNeeded",async()=>{if(a.logger.info("Call ".concat(this.callId," onNegotiationNeeded() negotiation is needed!")),this.state!==E.CreateOffer&&0===this.opponentVersion){a.logger.info("Call ".concat(this.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}this.queueGotLocalOffer()}),(0,i.default)(this,"onHangupReceived",e=>{a.logger.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(e)||this.state===E.Ringing?this.terminate(T.Remote,e.reason||O.UserHangup,!0):a.logger.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(e.party_id,": our partner is ").concat(this.opponentPartyId))}),(0,i.default)(this,"onRejectReceived",e=>{a.logger.debug("Call ".concat(this.callId," onRejectReceived() running")),[E.InviteSent,E.Ringing].includes(this.state)||this.state===E.Fledgling&&this.direction===w.Inbound?this.terminate(T.Remote,e.reason||O.UserHangup,!0):a.logger.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),(0,i.default)(this,"onAnsweredElsewhere",e=>{a.logger.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(T.Remote,O.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw Error("Client must have a device ID to start calls");for(let r of(this.forceTURN=null!==(t=e.forceTURN)&&void 0!==t&&t,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[C]}),this.turnServers))(0,l.checkObjectHasKeys)(r,["urls"]);this.callId=x(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}}function N(e,t){for(let r of e)r.enabled=t}function B(){if("undefined"==typeof document)return!1;try{if(!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return a.logger.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return a.logger.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function F(e,t,r){if(!B())return null;let n=!!r&&r.forceTURN,i=new L({client:e,roomId:t,invitee:null==r?void 0:r.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n,opponentDeviceId:null==r?void 0:r.opponentDeviceId,opponentSessionId:null==r?void 0:r.opponentSessionId,groupCallId:null==r?void 0:r.groupCallId});return e.reEmitter.reEmit(i,Object.values(I)),i}t.MatrixCall=L},30394:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.CallEventHandlerEvent=t.CallEventHandler=void 0;var i=n(r(13102)),o=r(34002),s=r(59721),a=r(15748),l=r(32950),c=r(41943),d=r(29197);let u=3e3,h=t.CallEventHandlerEvent=function(e){return e.Incoming="Call.incoming",e}({});class p{start(){this.client.on(l.ClientEvent.Sync,this.onSync),this.client.on(d.RoomEvent.Timeline,this.onRoomTimeline),this.client.on(l.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(l.ClientEvent.Sync,this.onSync),this.client.removeListener(d.RoomEvent.Timeline,this.onRoomTimeline),this.client.removeListener(l.ClientEvent.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(e){await Promise.all(e.map(e=>this.client.decryptEventIfNeeded(e)));let t=e.filter(e=>{let t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}),r=new Set;for(let e of t){let t=e.getType();(t===a.EventType.CallAnswer||t===a.EventType.CallHangup)&&r.add(e.getContent().call_id)}for(let e of t){let t=e.getType(),n=e.getContent().call_id;if(!(t===a.EventType.CallInvite&&r.has(n)))try{await this.handleCallEvent(e)}catch(e){o.logger.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}}async handleCallEvent(e){var t,r,n,i,d,p,f;let g,m;this.client.emit(l.ClientEvent.ReceivedVoipEvent,e);let v=e.getContent(),y=e.getRoomId()||(null===(t=this.client.groupCallEventHandler.getGroupCallById(v.conf_id))||void 0===t||null===(t=t.room)||void 0===t?void 0:t.roomId),b=v.conf_id,S=e.getType(),E=e.getSender(),_=v.call_id?this.calls.get(v.call_id):void 0;if(b){if(!(m=this.client.groupCallEventHandler.getGroupCallById(b))){o.logger.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(b,", type=").concat(S,")"));return}if(!(g=v.device_id)){o.logger.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(E,")")),m.emit(c.GroupCallEvent.Error,new c.GroupCallUnknownDeviceError(E));return}if(v.dest_session_id!==this.client.getSessionId()){o.logger.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}let w=E===this.client.credentials.userId&&(void 0===g||g===this.client.getDeviceId());if(y){if(S===a.EventType.CallInvite){let t;if(w||e.getLocalAge()>v.lifetime-u||_&&_.state===s.CallState.Ended||(_&&o.logger.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(v.call_id,")")),v.invitee&&v.invitee!==this.client.getUserId()))return;let a=(null!==(r=this.client.getTurnServersExpiry())&&void 0!==r?r:0)-Date.now();if(o.logger.info("CallEventHandler handleCallEvent() current turn creds expire in "+a+" ms"),!(_=null!==(n=(0,s.createNewMatrixCall)(this.client,y,{forceTURN:this.client.forceTURN,opponentDeviceId:g,groupCallId:b,opponentSessionId:v.sender_session_id}))&&void 0!==n?n:void 0)){o.logger.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(v.call_id,")"));return}_.callId=v.call_id;let l=null===(i=m)||void 0===i?void 0:i.getGroupCallStats();l&&_.initStats(l);try{await _.initWithInvite(e)}catch(e){e instanceof s.CallError&&(e.code===c.GroupCallErrorCode.UnknownDevice?null===(d=m)||void 0===d||d.emit(c.GroupCallEvent.Error,e):o.logger.error(e))}if(this.calls.set(_.callId,_),this.candidateEventsByCall.get(_.callId))for(let e of this.candidateEventsByCall.get(_.callId))_.onRemoteIceCandidatesReceived(e);for(let e of this.calls.values()){let r=[s.CallState.WaitLocalMedia,s.CallState.CreateOffer,s.CallState.InviteSent].includes(e.state);if(_.roomId===e.roomId&&e.direction===s.CallDirection.Outbound&&(null===(p=_.getOpponentMember())||void 0===p?void 0:p.userId)===e.invitee&&r){t=e;break}}t?t.callId>_.callId?(o.logger.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(_.callId,", outgoingId=").concat(t.callId,")")),t.replacedBy(_)):(o.logger.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(_.callId,", outgoingId=").concat(t.callId,")")),_.hangup(s.CallErrorCode.Replaced,!0)):this.client.emit(h.Incoming,_);return}if(S===a.EventType.CallCandidates){if(w)return;_?_.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(v.call_id)||this.candidateEventsByCall.set(v.call_id,[]),this.candidateEventsByCall.get(v.call_id).push(e));return}if([a.EventType.CallHangup,a.EventType.CallReject].includes(S)){_?_.state!==s.CallState.Ended&&(S===a.EventType.CallHangup?_.onHangupReceived(v):_.onRejectReceived(v),_.state===s.CallState.Ended&&this.calls.delete(v.call_id)):(_=null!==(f=(0,s.createNewMatrixCall)(this.client,y,{opponentDeviceId:g,opponentSessionId:v.sender_session_id}))&&void 0!==f?f:void 0)&&(_.callId=v.call_id,_.initWithHangup(e),this.calls.set(v.call_id,_));return}if(!_||!_.hasPeerConnection){o.logger.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(S,")"));return}if(e.getContent().party_id!==_.ourPartyId)switch(S){case a.EventType.CallAnswer:w?_.state===s.CallState.Ringing&&_.onAnsweredElsewhere(v):_.onAnswerReceived(e);break;case a.EventType.CallSelectAnswer:_.onSelectAnswerReceived(e);break;case a.EventType.CallNegotiate:_.onNegotiateReceived(e);break;case a.EventType.CallAssertedIdentity:case a.EventType.CallAssertedIdentityPrefix:_.onAssertedIdentityReceived(e);break;case a.EventType.CallSDPStreamMetadataChanged:case a.EventType.CallSDPStreamMetadataChangedPrefix:_.onSDPStreamMetadataChangedReceived(e)}}}constructor(e){(0,i.default)(this,"nextSeqByCall",new Map),(0,i.default)(this,"toDeviceEventBuffers",new Map),(0,i.default)(this,"onSync",()=>{let e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(e)):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)}),(0,i.default)(this,"onRoomTimeline",e=>{this.callEventBuffer.push(e)}),(0,i.default)(this,"onToDeviceEvent",e=>{let t=e.getContent();if(!t.call_id||(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0===t.seq)){this.callEventBuffer.push(e);return}let r=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==r){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);let r=this.toDeviceEventBuffers.get(t.call_id),n=r.findIndex(e=>e.getContent().seq>t.seq);-1===n?r.push(e):r.splice(n,0,e)}else{let r=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(r,t.seq+1);let n=this.toDeviceEventBuffers.get(r),i=n&&n.shift();for(;i&&i.getContent().seq===this.nextSeqByCall.get(r);)this.callEventBuffer.push(i),this.nextSeqByCall.set(r,i.getContent().seq+1),i=n.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}}t.CallEventHandler=p},95534:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SDPStreamMetadataPurpose=t.SDPStreamMetadataKey=void 0,t.SDPStreamMetadataKey="org.matrix.msc3077.sdp_stream_metadata",t.SDPStreamMetadataPurpose=function(e){return e.Usermedia="m.usermedia",e.Screenshare="m.screenshare",e}({})},71968:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.SPEAKING_THRESHOLD=t.CallFeedEvent=t.CallFeed=void 0;var i=n(r(13102)),o=r(95534),s=r(41400),a=r(34002),l=r(44441),c=r(59721);let d=200,u=t.SPEAKING_THRESHOLD=-60,h=8,p=t.CallFeedEvent=function(e){return e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed",e}({});class f extends l.TypedEventEmitter{get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(p.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t===e)return;let r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(p.NewStream,this.stream)}initVolumeMeasuring(){this.hasAudioTrack&&(this.audioContext||(this.audioContext=(0,s.acquireContext)()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount))}getMember(){var e;let t=this.client.getRoom(this.roomId);return null!==(e=null==t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(p.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){e?this.analyser&&this.frequencyBinCount&&this.hasAudioTrack&&(this.measuringVolumeActivity=!0,this.volumeLooper()):(this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(p.VolumeChanged,-1/0))}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){let e=this.client.getMediaHandler(),t=this.stream.clone();return a.logger.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===o.SDPStreamMetadataPurpose.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new f({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(c.CallEvent.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,(0,s.releaseContext)()),this._disposed=!0,this.emit(p.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(p.LocalVolumeChanged,e)}constructor(e){super(),(0,i.default)(this,"localVolume",1),(0,i.default)(this,"measuringVolumeActivity",!1),(0,i.default)(this,"speakingThreshold",u),(0,i.default)(this,"speaking",!1),(0,i.default)(this,"_disposed",!1),(0,i.default)(this,"_connected",!1),(0,i.default)(this,"onAddTrack",()=>{this.emit(p.NewStream,this.stream)}),(0,i.default)(this,"onCallState",e=>{e===c.CallState.Connected?this.connected=!0:e===c.CallState.Connecting&&(this.connected=!1)}),(0,i.default)(this,"volumeLooper",()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(let t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(p.VolumeChanged,e);let t=!1;for(let e of this.speakingVolumeSamples)if(e>this.speakingThreshold){t=!0;break}this.speaking!==t&&(this.speaking=t,this.emit(p.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,d)}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=Array(h).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(c.CallEvent.State,this.onCallState),this.onCallState(e.call.state))}}t.CallFeed=f},41943:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.OtherUserSpeakingError=t.GroupCallUnknownDeviceError=t.GroupCallType=t.GroupCallTerminationReason=t.GroupCallStatsReportEvent=t.GroupCallState=t.GroupCallIntent=t.GroupCallEvent=t.GroupCallErrorCode=t.GroupCallError=t.GroupCall=void 0;var i=n(r(13102)),o=r(44441),s=r(71968),a=r(59721),l=r(19389),c=r(34002),d=r(92807),u=r(95534),h=r(15748),p=r(30394),f=r(11773),g=r(44480),m=r(67508),v=r(70941),y=r(40986),b=r(40365);function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}t.GroupCallIntent=function(e){return e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room",e}({});let _=t.GroupCallType=function(e){return e.Video="m.video",e.Voice="m.voice",e}({}),w=t.GroupCallTerminationReason=function(e){return e.CallEnded="call_ended",e}({}),T=t.GroupCallEvent=function(e){return e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="group_call_error",e}({}),I=t.GroupCallStatsReportEvent=function(e){return e.ConnectionStats="GroupCall.connection_stats",e.ByteSentStats="GroupCall.byte_sent_stats",e.SummaryStats="GroupCall.summary_stats",e.CallFeedStats="GroupCall.call_feed_stats",e}({}),O=t.GroupCallErrorCode=function(e){return e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed",e}({});class R extends Error{constructor(e,t,r){r?super(t+": "+r):super(t),this.code=e}}t.GroupCallError=R;class C extends R{constructor(e){super(O.UnknownDevice,"No device found for "+e),this.userId=e}}t.GroupCallUnknownDeviceError=C;class k extends Error{constructor(){super("Cannot unmute: another user is speaking")}}t.OtherUserSpeakingError=k;let M=t.GroupCallState=function(e){return e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended",e}({}),P=36e5;function A(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class D extends o.TypedEventEmitter{async create(){return this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(f.GroupCallEventHandlerEvent.Outgoing,this),await this.sendCallStateEvent(),this}async sendCallStateEvent(){let e={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};this.livekitServiceURL&&(e["io.element.livekit_service_url"]=this.livekitServiceURL),await this.client.sendStateEvent(this.room.roomId,h.EventType.GroupCallPrefix,e,this.groupCallId)}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){let t=this._state;e!==t&&(this._state=e,this.emit(T.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){let t=this._participants,r=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing,n=(e,t)=>(0,g.mapsEqual)(e,t,r);(0,g.mapsEqual)(e,t,n)||(this._participants=e,this.emit(T.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(let t of this.calls.values())for(let r of t.values())e(r)}getLocalFeeds(){let e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}callExpected(e){var t;let r=A(e),n=null===r?null:this.room.getMember(r),i=e.getOpponentDeviceId();return null!==n&&void 0!==i&&(null===(t=this.participants.get(n))||void 0===t?void 0:t.get(i))!==void 0}async initLocalCallFeed(){if(this.useLivekit){c.logger.info("Livekit group call: not starting local call feed.");return}if(this.state!==M.LocalCallFeedUninitialized)throw Error('Cannot initialize local call feed in the "'.concat(this.state,'" state.'));if(this.state=M.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}async initLocalCallFeedInternal(){let e;c.logger.log("GroupCall ".concat(this.groupCallId," initLocalCallFeedInternal() running"));try{e=await this.client.getMediaHandler().getUserMediaStream(!0,this.type===_.Video)}catch(t){if(this.allowCallWithoutVideoAndAudio)e=new MediaStream;else throw this.state=M.LocalCallFeedUninitialized,t}if(this._state!==M.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(e),Error("Group call disposed while gathering media stream");let t=new s.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:u.SDPStreamMetadataPurpose.Usermedia,audioMuted:this.initWithAudioMuted||0===e.getAudioTracks().length||this.isPtt,videoMuted:this.initWithVideoMuted||0===e.getVideoTracks().length});(0,a.setTracksEnabled)(e.getAudioTracks(),!t.isAudioMuted()),(0,a.setTracksEnabled)(e.getVideoTracks(),!t.isVideoMuted()),this.localCallFeed=t,this.addUserMediaFeed(t),this.state=M.LocalCallFeedInitialized}async updateLocalUsermediaStream(e){if(this.localCallFeed){let t=this.localCallFeed.stream;this.localCallFeed.setNewStream(e);let r=this.localCallFeed.isAudioMuted(),n=this.localCallFeed.isVideoMuted();c.logger.log("GroupCall ".concat(this.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(t.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(r,", vidShouldBeMuted=").concat(n,")")),(0,a.setTracksEnabled)(e.getAudioTracks(),!r),(0,a.setTracksEnabled)(e.getVideoTracks(),!n),this.client.getMediaHandler().stopUserMediaStream(t)}}async enter(){if(this.state===M.LocalCallFeedUninitialized)await this.initLocalCallFeed();else if(this.state!==M.LocalCallFeedInitialized)throw Error('Cannot enter call in the "'.concat(this.state,'" state'));for(let e of(c.logger.log("GroupCall ".concat(this.groupCallId," enter() running")),this.state=M.Entered,this.client.on(p.CallEventHandlerEvent.Incoming,this.onIncomingCall),this.client.callEventHandler.calls.values()))this.onIncomingCall(e);this.useLivekit||(this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval))}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===M.Entered&&(this.forEachCall(e=>e.hangup(a.CallErrorCode.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(p.CallEventHandlerEvent.Incoming,this.onIncomingCall),null===(e=this.stats)||void 0===e||e.stop())}leave(){this.dispose(),this.state=M.LocalCallFeedUninitialized}async terminate(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.dispose(),this.room.off(l.RoomStateEvent.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(f.GroupCallEventHandlerEvent.Ended,this),this.state=M.Ended,e){let e=this.room.currentState.getStateEvents(h.EventType.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,h.EventType.GroupCallPrefix,E(E({},e.getContent()),{},{"m.terminated":w.CallEnded}),this.groupCallId)}}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}async setMicrophoneMuted(e){if(!e&&!await this.client.getMediaHandler().hasAudioDevice())return!1;let t=!e&&this.isPtt;this.isPtt&&(!e&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout(()=>{this.setMicrophoneMuted(!0)},this.pttMaxTransmitTime):e&&!this.isMicrophoneMuted()&&(null!==this.transmitTimer&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall(t=>{var r;return null===(r=t.localUsermediaFeed)||void 0===r?void 0:r.setAudioVideoMuted(e,null)});let r=async()=>{let e=[];this.forEachCall(t=>e.push(t.sendMetadataUpdate())),await Promise.all(e).catch(e=>c.logger.info("GroupCall ".concat(this.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),e))};if(t&&await r(),this.localCallFeed){if(c.logger.log("GroupCall ".concat(this.groupCallId," setMicrophoneMuted() (streamId=").concat(this.localCallFeed.stream.id,", muted=").concat(e,")")),!await this.checkAudioPermissionIfNecessary(e))return!1;this.localCallFeed.setAudioVideoMuted(e,null),(0,a.setTracksEnabled)(this.localCallFeed.stream.getAudioTracks(),!e)}else c.logger.log("GroupCall ".concat(this.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),this.initWithAudioMuted=e;return this.forEachCall(t=>(0,a.setTracksEnabled)(t.localUsermediaFeed.stream.getAudioTracks(),!e&&this.callExpected(t))),this.emit(T.LocalMuteStateChanged,e,this.isLocalVideoMuted()),t||await r(),!0}async checkAudioPermissionIfNecessary(e){try{if(!e&&this.localCallFeed&&!this.localCallFeed.hasAudioTrack){let t=await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted());if((null==t?void 0:t.getTracks().length)===0)return c.logger.log("GroupCall ".concat(this.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch(t){return c.logger.log("GroupCall ".concat(this.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0}async setLocalVideoMuted(e){if(!e&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){c.logger.log("GroupCall ".concat(this.groupCallId," setLocalVideoMuted() (stream=").concat(this.localCallFeed.stream.id,", muted=").concat(e,")"));try{let t=await this.client.getMediaHandler().getUserMediaStream(!0,!e);await this.updateLocalUsermediaStream(t),this.localCallFeed.setAudioVideoMuted(null,e),(0,a.setTracksEnabled)(this.localCallFeed.stream.getVideoTracks(),!e)}catch(t){return c.logger.log("GroupCall ".concat(this.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else c.logger.log("GroupCall ".concat(this.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),this.initWithVideoMuted=e;let t=[];return this.forEachCall(r=>t.push(r.setLocalVideoMuted(e))),await Promise.all(t),this.forEachCall(t=>(0,a.setTracksEnabled)(t.localUsermediaFeed.stream.getVideoTracks(),!e&&this.callExpected(t))),this.emit(T.LocalMuteStateChanged,this.isMicrophoneMuted(),e),!0}async setScreensharingEnabled(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e===this.isScreensharing())return e;if(!e)return this.forEachCall(e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)}),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(T.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{c.logger.log("GroupCall ".concat(this.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));let e=await this.client.getMediaHandler().getScreensharingStream(t);for(let t of e.getTracks()){let e=()=>{this.setScreensharingEnabled(!1),t.removeEventListener("ended",e)};t.addEventListener("ended",e)}return c.logger.log("GroupCall ".concat(this.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),this.localDesktopCapturerSourceId=t.desktopCapturerSourceId,this.localScreenshareFeed=new s.CallFeed({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:u.SDPStreamMetadataPurpose.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(T.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall(e=>e.pushLocalFeed(this.localScreenshareFeed.clone())),!0}catch(e){if(t.throwOnFail)throw e;return c.logger.error("GroupCall ".concat(this.groupCallId," setScreensharingEnabled() enabling screensharing error"),e),this.emit(T.Error,new R(O.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){let r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){let e=!1;for(let[{userId:r},n]of this.participants){var t;let i=null!==(t=this.calls.get(r))&&void 0!==t?t:new Map;for(let[t,o]of n){let n=i.get(t);if((null==n?void 0:n.getOpponentSessionId())!==o.sessionId&&this.wantsOutgoingCall(r,t)){e=!0,void 0!==n&&(c.logger.debug("GroupCall ".concat(this.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(r,", deviceId=").concat(t,", callId=").concat(n.callId,")")),n.hangup(a.CallErrorCode.NewSession,!1));let s=(0,a.createNewMatrixCall)(this.client,this.room.roomId,{invitee:r,opponentDeviceId:t,opponentSessionId:o.sessionId,groupCallId:this.groupCallId});null===s?(c.logger.error("GroupCall ".concat(this.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(r,", device=").concat(t,")")),i.delete(t)):(this.initCall(s),i.set(t,s),c.logger.debug("GroupCall ".concat(this.groupCallId," placeOutgoingCalls() placing call (userId=").concat(r,", deviceId=").concat(t,", sessionId=").concat(o.sessionId,")")),s.placeCallWithCallFeeds(this.getLocalFeeds().map(e=>e.clone()),o.screensharing).then(()=>{this.dataChannelsEnabled&&s.createDataChannel("datachannel",this.dataChannelOptions)}).catch(e=>{c.logger.warn("GroupCall ".concat(this.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(r,")"),e),e instanceof a.CallError&&e.code===O.UnknownDevice?this.emit(T.Error,e):this.emit(T.Error,new R(O.PlaceCallFailed,"Failed to place call to ".concat(r))),s.hangup(a.CallErrorCode.SignallingFailed,!1),i.get(t)===s&&i.delete(t)}))}}i.size>0?this.calls.set(r,i):this.calls.delete(r)}e&&this.emit(T.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(h.EventType.GroupCallMemberPrefix):this.room.currentState.getStateEvents(h.EventType.GroupCallMemberPrefix,e)}initCall(e){let t=A(e);if(!t)throw Error("Cannot init call without user id");let r=()=>this.onCallFeedsChanged(e),n=(t,r)=>this.onCallStateChanged(e,t,r),i=this.onCallHangup,o=t=>this.onCallReplaced(e,t),s=this.callHandlers.get(t);void 0===s&&(s=new Map,this.callHandlers.set(t,s)),s.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:i,onCallReplaced:o}),e.on(a.CallEvent.FeedsChanged,r),e.on(a.CallEvent.State,n),e.on(a.CallEvent.Hangup,i),e.on(a.CallEvent.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(a.CallEvent)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){let r=A(e),n=e.getOpponentDeviceId();if(!r)throw Error("Cannot dispose call without user id");let i=this.callHandlers.get(r),{onCallFeedsChanged:o,onCallStateChanged:s,onCallHangup:l,onCallReplaced:c}=i.get(n);if(e.removeListener(a.CallEvent.FeedsChanged,o),e.removeListener(a.CallEvent.State,s),e.removeListener(a.CallEvent.Hangup,l),e.removeListener(a.CallEvent.Replaced,c),i.delete(r),0===i.size&&this.callHandlers.delete(r),e.hangupReason===a.CallErrorCode.Replaced)return;let d=this.getUserMediaFeed(r,n);d&&this.removeUserMediaFeed(d);let u=this.getScreenshareFeed(r,n);u&&this.removeScreenshareFeed(u)}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(T.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){let r=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(T.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){let t=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(T.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(T.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(T.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){let r=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(T.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){let t=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(T.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){let e=this.room.getMember(this.client.getUserId());if(!e){c.logger.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===M.Ended){this.participants=new Map;return}let t=new Map,r=Date.now(),n=this.state===M.Entered||this.enteredViaAnotherSession,i=1/0;for(let e of this.getMemberStateEvents()){let o=this.room.getMember(e.getStateKey()),s=e.getContent(),a=(Array.isArray(s["m.calls"])?s["m.calls"]:[]).find(e=>e["m.call_id"]===this.groupCallId),l=(Array.isArray(null==a?void 0:a["m.devices"])?a["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>r&&Array.isArray(e.feeds));if(n||(null==o?void 0:o.userId)!==this.client.getUserId()||(l=l.filter(e=>e.device_id!==this.client.getDeviceId())),l.length>0&&(null==o?void 0:o.membership)==="join"){let e=new Map;for(let r of(t.set(o,e),l))e.set(r.device_id,{sessionId:r.session_id,screensharing:r.feeds.some(e=>e.purpose===u.SDPStreamMetadataPurpose.Screenshare)}),r.expires_ts<i&&(i=r.expires_ts)}}if(n){let r=t.get(e);void 0===r&&(r=new Map,t.set(e,r)),r.has(this.client.getDeviceId())||r.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(e=>e.purpose===u.SDPStreamMetadataPurpose.Screenshare)})}this.participants=t,i<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),i-r))}async updateDevices(e){var t;let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=Date.now(),i=this.client.getUserId(),o=this.getMemberStateEvents(i),s=null!==(t=null==o?void 0:o.getContent())&&void 0!==t?t:{},a=Array.isArray(s["m.calls"])?s["m.calls"]:[],l=null,c=[];for(let e of a)e["m.call_id"]===this.groupCallId?l=e:c.push(e);null===l&&(l={});let d=e((Array.isArray(l["m.devices"])?l["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>n&&Array.isArray(e.feeds)));if(null===d)return;let u=[...c];d.length>0&&u.push(E(E({},l),{},{"m.call_id":this.groupCallId,"m.devices":d}));let p={"m.calls":u};await this.client.sendStateEvent(this.room.roomId,h.EventType.GroupCallMemberPrefix,p,i,{keepAlive:r})}async addDeviceToMemberState(){await this.updateDevices(e=>[...e.filter(e=>e.device_id!==this.client.getDeviceId()),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+P,feeds:this.getLocalFeeds().map(e=>({purpose:e.purpose}))}])}async updateMemberState(){null!==this.resendMemberStateTimer&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===M.Entered?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval(async()=>{c.logger.log("GroupCall ".concat(this.groupCallId,' updateMemberState() resending call member state"'));try{await this.addDeviceToMemberState()}catch(e){c.logger.error("GroupCall ".concat(this.groupCallId," updateMemberState() failed to resend call member state"),e)}},3*P/4)):await this.updateDevices(e=>e.filter(e=>e.device_id!==this.client.getDeviceId()),!0)}async cleanMemberState(){let{devices:e}=await this.client.getDevices(),t=new Map(e.map(e=>[e.device_id,e]));await this.updateDevices(e=>{let r=e.filter(e=>{let r=t.get(e.device_id);return(null==r?void 0:r.last_seen_ts)!==void 0&&!(e.device_id===this.client.getDeviceId()&&this.state!==M.Entered&&!this.enteredViaAnotherSession)});return r.length===e.length?null:r})}getGroupCallStats(){if(void 0===this.stats){let e=this.client.getUserId()||"unknown";this.stats=new m.GroupCallStats(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(v.StatsReport.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(v.StatsReport.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(v.StatsReport.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(v.StatsReport.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}constructor(e,t,r,n,o,u,p,f,g,m=!1,v){var S,E;super(),(0,i.default)(this,"activeSpeakerInterval",1e3),(0,i.default)(this,"retryCallInterval",5e3),(0,i.default)(this,"participantTimeout",15e3),(0,i.default)(this,"pttMaxTransmitTime",2e4),(0,i.default)(this,"userMediaFeeds",[]),(0,i.default)(this,"screenshareFeeds",[]),(0,i.default)(this,"calls",new Map),(0,i.default)(this,"callHandlers",new Map),(0,i.default)(this,"retryCallCounts",new Map),(0,i.default)(this,"transmitTimer",null),(0,i.default)(this,"participantsExpirationTimer",null),(0,i.default)(this,"resendMemberStateTimer",null),(0,i.default)(this,"initWithAudioMuted",!1),(0,i.default)(this,"initWithVideoMuted",!1),(0,i.default)(this,"statsCollectIntervalTime",0),(0,i.default)(this,"onConnectionStats",e=>{this.emit(I.ConnectionStats,{report:e})}),(0,i.default)(this,"onByteSentStats",e=>{this.emit(I.ByteSentStats,{report:e})}),(0,i.default)(this,"onSummaryStats",e=>{y.SummaryStatsReportGatherer.extendSummaryReport(e,this.participants),this.emit(I.SummaryStats,{report:e})}),(0,i.default)(this,"onCallFeedReport",e=>{this.localCallFeed&&(e=b.CallFeedStatsReporter.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));let t=[];this.forEachCall(r=>{r.callId===e.callId&&r.getFeeds().forEach(e=>t.push(e))}),e=b.CallFeedStatsReporter.expandCallFeedReport(e,t,"from-call-feed"),this.emit(I.CallFeedStats,{report:e})}),(0,i.default)(this,"_state",M.LocalCallFeedUninitialized),(0,i.default)(this,"_participants",new Map),(0,i.default)(this,"_creationTs",null),(0,i.default)(this,"_enteredViaAnotherSession",!1),(0,i.default)(this,"onIncomingCall",e=>{var t,r;if(e.roomId!==this.room.roomId)return;if(e.state!==a.CallState.Ringing){c.logger.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!e.groupCallId||e.groupCallId!==this.groupCallId){c.logger.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),e.reject();return}let n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0===n){c.logger.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){c.logger.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}let i=null!==(r=this.calls.get(n))&&void 0!==r?r:new Map,o=i.get(e.getOpponentDeviceId());if((null==o?void 0:o.callId)===e.callId)return;c.logger.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(n,", callId=").concat(e.callId,")")),o&&o.hangup(a.CallErrorCode.Replaced,!1),i.set(e.getOpponentDeviceId(),e),this.calls.set(n,i),this.initCall(e);let s=this.getLocalFeeds().map(e=>e.clone());if(!this.callExpected(e))for(let e of s)(0,a.setTracksEnabled)(e.stream.getAudioTracks(),!1),(0,a.setTracksEnabled)(e.stream.getVideoTracks(),!1);e.answerWithCallFeeds(s),this.emit(T.CallsChanged,this.calls)}),(0,i.default)(this,"onRetryCallLoop",()=>{let e=!1;for(let[{userId:n},i]of this.participants){let o=this.calls.get(n),s=this.retryCallCounts.get(n);for(let[a,l]of i){var t,r;let i=null==o?void 0:o.get(a),c=null!==(t=null===(r=s)||void 0===r?void 0:r.get(a))&&void 0!==t?t:0;(null==i?void 0:i.getOpponentSessionId())!==l.sessionId&&this.wantsOutgoingCall(n,a)&&c<3&&(void 0===s&&(s=new Map,this.retryCallCounts.set(n,s)),s.set(a,c+1),e=!0)}}e&&this.placeOutgoingCalls()}),(0,i.default)(this,"onCallFeedsChanged",e=>{let t=A(e),r=e.getOpponentDeviceId();if(!t)throw Error("Cannot change call feeds without user id");let n=this.getUserMediaFeed(t,r),i=e.remoteUsermediaFeed,o=i!==n,s=this.calls.get(t),a=null==s?void 0:s.get(r);if((null==a?void 0:a.callId)!==e.callId)return;o&&(!n&&i?this.addUserMediaFeed(i):n&&i?this.replaceUserMediaFeed(n,i):n&&!i&&this.removeUserMediaFeed(n));let l=this.getScreenshareFeed(t,r),c=e.remoteScreensharingFeed;c!==l&&(!l&&c?this.addScreenshareFeed(c):l&&c?this.replaceScreenshareFeed(l,c):l&&!c&&this.removeScreenshareFeed(l))}),(0,i.default)(this,"onCallStateChanged",(e,t,r)=>{var n;if(t===a.CallState.Ended)return;let i=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==i&&e.setMicrophoneMuted(i);let o=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==o&&e.setLocalVideoMuted(o);let s=null===(n=e.getOpponentMember())||void 0===n?void 0:n.userId;if(t===a.CallState.Connected&&s){let t=this.retryCallCounts.get(s);null==t||t.delete(e.getOpponentDeviceId()),(null==t?void 0:t.size)===0&&this.retryCallCounts.delete(s)}}),(0,i.default)(this,"onCallHangup",e=>{var t,r;if(e.hangupReason===a.CallErrorCode.Replaced)return;let n=null!==(t=null===(r=e.getOpponentMember())||void 0===r?void 0:r.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,i=this.calls.get(n);(null==i?void 0:i.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),i.delete(e.getOpponentDeviceId()),0===i.size&&this.calls.delete(n),this.emit(T.CallsChanged,this.calls))}),(0,i.default)(this,"onCallReplaced",(e,t)=>{let r=e.getOpponentMember().userId,n=this.calls.get(r);void 0===n&&(n=new Map,this.calls.set(r,n)),e.hangup(a.CallErrorCode.Replaced,!1),this.initCall(t),n.set(e.getOpponentDeviceId(),t),this.emit(T.CallsChanged,this.calls)}),(0,i.default)(this,"onActiveSpeakerLoop",()=>{let e,t;for(let r of this.userMediaFeeds){if(r.isLocal()&&this.userMediaFeeds.length>1)continue;let n=r.speakingVolumeSamples.reduce((e,t)=>e+Math.max(t,s.SPEAKING_THRESHOLD))/r.speakingVolumeSamples.length;(!e||n>e)&&(e=n,t=r)}t&&this.activeSpeaker!==t&&e&&e>s.SPEAKING_THRESHOLD&&(this.activeSpeaker=t,this.emit(T.ActiveSpeakerChanged,this.activeSpeaker))}),(0,i.default)(this,"onRoomState",()=>this.updateParticipants()),(0,i.default)(this,"onParticipantsChanged",()=>{this.forEachCall(e=>{let t=this.callExpected(e);for(let r of e.getLocalFeeds())(0,a.setTracksEnabled)(r.stream.getAudioTracks(),!r.isAudioMuted()&&t),(0,a.setTracksEnabled)(r.stream.getVideoTracks(),!r.isVideoMuted()&&t)}),this.state!==M.Entered||this.useLivekit||this.placeOutgoingCalls()}),(0,i.default)(this,"onStateChanged",(e,t)=>{(e===M.Entered||t===M.Entered||e===M.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(e=>c.logger.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),e)))}),(0,i.default)(this,"onLocalFeedsChanged",()=>{this.state===M.Entered&&this.updateMemberState().catch(e=>c.logger.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),e))}),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=o,this.dataChannelsEnabled=p,this.dataChannelOptions=f,this.useLivekit=m,this.reEmitter=new d.ReEmitter(this),this.groupCallId=null!=u?u:(0,a.genCallID)(),this._livekitServiceURL=v,this.creationTs=null!==(S=null===(E=t.currentState.getStateEvents(h.EventType.GroupCallPrefix,this.groupCallId))||void 0===E?void 0:E.getTs())&&void 0!==S?S:null,this.updateParticipants(),t.on(l.RoomStateEvent.Update,this.onRoomState),this.on(T.ParticipantsChanged,this.onParticipantsChanged),this.on(T.GroupCallStateChanged,this.onStateChanged),this.on(T.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!g}}t.GroupCall=D},11773:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.GroupCallEventHandlerEvent=t.GroupCallEventHandler=void 0;var i=n(r(13102)),o=r(32950),s=r(41943),a=r(19389),l=r(34002),c=r(15748),d=r(9855);let u=t.GroupCallEventHandlerEvent=function(e){return e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants",e}({});class h{async start(){for(let e of(this.client.getSyncState()!==d.SyncState.Syncing&&(l.logger.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise(e=>{let t=()=>{if(this.client.getSyncState()===d.SyncState.Syncing)return this.client.off(o.ClientEvent.Sync,t),e()};this.client.on(o.ClientEvent.Sync,t)})),this.client.getRooms()))this.createGroupCallForRoom(e);this.client.on(o.ClientEvent.Room,this.onRoomsChanged),this.client.on(a.RoomStateEvent.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(o.ClientEvent.Room,this.onRoomsChanged),this.client.removeListener(a.RoomStateEvent.Events,this.onRoomStateChanged)}getRoomDeferred(e){let t=this.roomDeferreds.get(e);if(void 0===t){let r;(t={prom:new Promise(e=>{r=e})}).resolve=r,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){let t=e.currentState.getStateEvents(c.EventType.GroupCallPrefix);for(let r of t.sort((e,t)=>t.getTs()-e.getTs()))if(!(r.getContent()["m.terminated"]||r.isRedacted())){l.logger.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(r.getStateKey(),", ts=").concat(r.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(r);break}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){let t;let r=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(r);if(!i){l.logger.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(r,")"));return}let o=e.getStateKey(),a=n["m.type"];if(!Object.values(s.GroupCallType).includes(a)){l.logger.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(a,", roomId=").concat(r,")"));return}let c=n["m.intent"];if(!Object.values(s.GroupCallIntent).includes(c)){l.logger.warn("Received invalid group call intent (type=".concat(a,", roomId=").concat(r,")"));return}let d=!!n["io.element.ptt"];if(null!=n&&n.dataChannelsEnabled&&null!=n&&n.dataChannelOptions){let{ordered:e,maxPacketLifeTime:r,maxRetransmits:i,protocol:o}=n.dataChannelOptions;t={ordered:e,maxPacketLifeTime:r,maxRetransmits:i,protocol:o}}let h=new s.GroupCall(this.client,i,a,d,c,o,(null==n?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,t,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,h),this.client.emit(u.Incoming,h),h}constructor(e){(0,i.default)(this,"groupCalls",new Map),(0,i.default)(this,"roomDeferreds",new Map),(0,i.default)(this,"onRoomsChanged",e=>{this.createGroupCallForRoom(e)}),(0,i.default)(this,"onRoomStateChanged",(e,t)=>{if(e.getType()===c.EventType.GroupCallPrefix){let r=e.getStateKey(),n=e.getContent(),i=this.groupCalls.get(t.roomId);i||n["m.terminated"]||e.isRedacted()?i&&i.groupCallId===r?n["m.terminated"]||e.isRedacted()?i.terminate(!1):n["m.type"]!==i.type&&l.logger.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(t.roomId,")")):i&&i.groupCallId!==r&&l.logger.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(t.roomId,")")):this.createGroupCallFromRoomStateEvent(e)}}),this.client=e}}t.GroupCallEventHandler=h},33551:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHandlerEvent=t.MediaHandler=void 0;var i=n(r(13102)),o=r(44441),s=r(41943),a=r(34002);let l=t.MediaHandlerEvent=function(e){return e.LocalStreamsChanged="local_streams_changed",e}({});class c extends o.TypedEventEmitter{restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}async setAudioInput(e){a.logger.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setAudioSettings(e){a.logger.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),this.audioSettings=Object.assign({},e),await this.updateLocalUsermediaStreams()}async setVideoInput(e){a.logger.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async setMediaInputs(e,t){a.logger.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),this.audioInput=e,this.videoInput=t,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;let e=new Map;for(let t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(let e of this.userMediaStreams)for(let t of(a.logger.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(e.id,")")),e.getTracks()))t.stop();for(let t of(this.userMediaStreams=[],this.localUserMediaStream=void 0,this.client.callEventHandler.calls.values())){if(t.callHasEnded()||!e.has(t.callId))continue;let{audio:r,video:n}=e.get(t.callId);a.logger.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(t.callId,")"));let i=await this.getUserMediaStream(r,n);t.callHasEnded()||await t.updateLocalUsermediaStream(i)}for(let e of this.client.groupCallEventHandler.groupCalls.values()){if(!e.localCallFeed)continue;a.logger.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(e.groupCallId,")"));let t=await this.getUserMediaStream(!0,e.type===s.GroupCallType.Video);e.state!==s.GroupCallState.Ended&&await e.updateLocalUsermediaStream(t)}this.emit(l.LocalStreamsChanged)}async hasAudioDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind).length>0}catch(e){return a.logger.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async hasVideoDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).length>0}catch(e){return a.logger.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async getUserMediaStream(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then(()=>this.getUserMediaStreamInternal(e,t,r)):this.getMediaStreamPromise=this.getUserMediaStreamInternal(e,t,r),this.getMediaStreamPromise}async getUserMediaStreamInternal(e,t,r){var n,i,o;let s;let c=e&&await this.hasAudioDevice(),d=t&&await this.hasVideoDevice(),u=!0;if(this.localUserMediaStream?(c!==this.localUserMediaStream.getAudioTracks().length>0&&(u=!1),d!==this.localUserMediaStream.getVideoTracks().length>0&&(u=!1),c&&(null===(n=this.localUserMediaStream.getAudioTracks()[0])||void 0===n||null===(n=n.getSettings())||void 0===n?void 0:n.deviceId)!==this.audioInput&&(u=!1),d&&(null===(i=this.localUserMediaStream.getVideoTracks()[0])||void 0===i||null===(i=i.getSettings())||void 0===i?void 0:i.deviceId)!==this.videoInput&&(u=!1)):u=!1,u){if(s=this.localUserMediaStream.clone(),a.logger.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat(null===(o=this.localUserMediaStream)||void 0===o?void 0:o.id," newStreamId=").concat(s.id," shouldRequestAudio=").concat(c," shouldRequestVideo=").concat(d,")")),!c)for(let e of s.getAudioTracks())s.removeTrack(e);if(!d)for(let e of s.getVideoTracks())s.removeTrack(e)}else{let e=this.getUserMediaContraints(c,d);for(let t of(s=await navigator.mediaDevices.getUserMedia(e),a.logger.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(s.id,", shouldRequestAudio=").concat(c,", shouldRequestVideo=").concat(d,", constraints=").concat(JSON.stringify(e),")")),s.getTracks())){let e=t.getSettings();"audio"===t.kind?this.audioInput=e.deviceId:"video"===t.kind&&(this.videoInput=e.deviceId)}r&&(this.localUserMediaStream=s)}return r&&this.userMediaStreams.push(s),this.emit(l.LocalStreamsChanged),s}stopUserMediaStream(e){for(let t of(a.logger.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();let t=this.userMediaStreams.indexOf(e);if(-1!==t&&(a.logger.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(t,1)),this.emit(l.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(let t of e.getTracks()){var r;if(null!==(r=this.localUserMediaStream)&&void 0!==r&&r.getTrackById(t.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}async getScreensharingStream(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(0===this.screensharingStreams.length){let r=this.getScreenshareContraints(t);t.desktopCapturerSourceId?(a.logger.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(t),")")),e=await navigator.mediaDevices.getUserMedia(r)):(a.logger.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(t),")")),e=await navigator.mediaDevices.getDisplayMedia(r))}else{let t=this.screensharingStreams[this.screensharingStreams.length-1];a.logger.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(t.id,")")),e=t.clone()}return r&&this.screensharingStreams.push(e),this.emit(l.LocalStreamsChanged),e}stopScreensharingStream(e){for(let t of(a.logger.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")")),e.getTracks()))t.stop();let t=this.screensharingStreams.indexOf(e);-1!==t&&(a.logger.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(t,1)),this.emit(l.LocalStreamsChanged)}stopAllStreams(){for(let e of this.userMediaStreams)for(let t of(a.logger.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();for(let e of this.screensharingStreams)for(let t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(l.LocalStreamsChanged)}getUserMediaContraints(e,t){let r=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){let{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:null!=r&&r,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=r&&r,video:!0}}constructor(e){super(),(0,i.default)(this,"userMediaStreams",[]),(0,i.default)(this,"screensharingStreams",[]),this.client=e}}t.MediaHandler=c},40365:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallFeedStatsReporter=void 0;class r{static buildCallFeedReport(e,t,n){let i=n.getTransceivers(),o=[],s=[];return i.forEach(e=>{var t;let n=null!==(t=e.sender)&&void 0!==t&&t.track?r.buildTrackStats(e.sender.track,"sender"):null,i=r.buildTrackStats(e.receiver.track,"receiver");o.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:n,receiver:i})}),{callId:e,opponentMemberId:t,transceiver:o,callFeeds:s}}static buildTrackStats(e){var t,r;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"--",i=null===(t=e.getSettings())||void 0===t?void 0:t.deviceId,o=null===(r=e.getConstraints())||void 0===r?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:i||"unknown",constrainDeviceId:o||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";return e.callFeeds||(e.callFeeds=[]),t.forEach(t=>{let i=t.stream.getAudioTracks(),o=t.stream.getVideoTracks(),s=i.length>0?r.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,a=o.length>0?r.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,l={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:s,video:a,purpose:t.purpose,prefix:n,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(l)}),e}}t.CallFeedStatsReporter=r},26054:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.CallStatsReportGatherer=void 0;var i=n(r(13102)),o=r(22908),s=r(88541),a=r(3034),l=r(85222),c=r(44078),d=r(24753),u=r(78641),h=r(50812),p=r(72151),f=r(34002),g=r(40365);function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach(function(t){(0,i.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class y{async processStats(e,t){let r={isFirstCollection:void 0===this.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(this.isActive){let n=this.pc.getStats();if("function"==typeof(null==n?void 0:n.then))return n.then(n=>{var i,o;this.currentStatsReport="function"==typeof(null==n?void 0:n.result)?n.result():n;try{this.processStatsReport(e,t)}catch(e){return this.handleError(e),r}this.previousStatsReport=this.currentStatsReport,r.receivedMedia=this.connectionStats.bitrate.download,r.receivedAudioMedia=(null===(i=this.connectionStats.bitrate.audio)||void 0===i?void 0:i.download)||0,r.receivedVideoMedia=(null===(o=this.connectionStats.bitrate.video)||void 0===o?void 0:o.download)||0;let s=u.TrackStatsBuilder.buildTrackSummary(Array.from(this.trackStats.getTrack2stats().values()));return v(v({},r),{},{audioTrackSummary:s.audioTrackSummary,videoTrackSummary:s.videoTrackSummary})}).catch(e=>(this.handleError(e),r));this.isActive=!1}return Promise.resolve(r)}processStatsReport(e,t){var r;let n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,null===(r=this.currentStatsReport)||void 0===r||r.forEach(e=>{let t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=s.ConnectionStatsBuilder.buildBandwidthReport(e),this.connectionStats.transport=a.TransportStatsBuilder.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){let r=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!r)return;if(t&&u.TrackStatsBuilder.buildPacketsLost(r,e,t),"inbound-rtp"===e.type){u.TrackStatsBuilder.buildFramerateResolution(r,e),t&&u.TrackStatsBuilder.buildBitrateReceived(r,e,t);let n=this.trackStats.findTransceiverByTrackId(r.trackId);u.TrackStatsBuilder.setTrackStatsState(r,n),u.TrackStatsBuilder.buildJitter(r,e),u.TrackStatsBuilder.buildAudioConcealment(r,e)}else t&&(n.set(r.trackId,p.ValueFormatter.getNonNegativeValue(e.bytesSent)),u.TrackStatsBuilder.buildBitrateSend(r,e,t));u.TrackStatsBuilder.buildCodec(this.currentStatsReport,r,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){let r=this.trackStats.findLocalVideoTrackStats(e);if(!r)return;u.TrackStatsBuilder.buildFramerateResolution(r,e),u.TrackStatsBuilder.calculateSimulcastFramerate(r,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(g.CallFeedStatsReporter.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,f.logger.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){let e=h.ConnectionStatsReportBuilder.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(v(v({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}constructor(e,t,r,n,s=!0){(0,i.default)(this,"isActive",!0),(0,i.default)(this,"connectionStats",new o.ConnectionStats),this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=s,r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new d.MediaTrackStatsHandler(new l.MediaSsrcHandler,new c.MediaTrackHandler(r))}}t.CallStatsReportGatherer=y},22908:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionStats=void 0;var i=n(r(13102));class o{constructor(){(0,i.default)(this,"bandwidth",{}),(0,i.default)(this,"bitrate",{}),(0,i.default)(this,"packetLoss",{}),(0,i.default)(this,"transport",[])}}t.ConnectionStats=o},88541:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionStatsBuilder=void 0;class r{static buildBandwidthReport(e){let t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}t.ConnectionStatsBuilder=r},50812:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionStatsReportBuilder=void 0;class r{static build(e){let t={},n={download:0,upload:0},i={download:0,upload:0},o=0,s=0,a={local:new Map,remote:new Map},l={local:new Map,remote:new Map},c={local:new Map,remote:new Map},d=new Map,u=new Map,h=0,p=0,f=0,g=0,m=0,v=0;for(let[t,r]of e){let e=r.getLoss(),y=e.isDownloadStream?"download":"upload";if(n[y]+=e.packetsTotal,i[y]+=e.packetsLost,o+=r.getBitrate().download,s+=r.getBitrate().upload,"audio"===r.kind){let e=r.getAudioConcealment();m+=e.concealedAudio,v+=e.totalAudioDuration,h+=r.getBitrate().download,p+=r.getBitrate().upload}else f+=r.getBitrate().download,g+=r.getBitrate().upload;a[r.getType()].set(t,r.getResolution()),l[r.getType()].set(t,r.getFramerate()),c[r.getType()].set(t,r.getCodec()),"remote"===r.getType()&&(d.set(t,r.getJitter()),"audio"===r.kind&&u.set(t,r.getAudioConcealment())),r.resetBitrate()}return t.bitrate={upload:s,download:o},t.bitrate.audio={upload:p,download:h},t.bitrate.video={upload:g,download:f},t.packetLoss={total:r.calculatePacketLoss(i.download+i.upload,n.download+n.upload),download:r.calculatePacketLoss(i.download,n.download),upload:r.calculatePacketLoss(i.upload,n.upload)},t.audioConcealment=u,t.totalAudioConcealment={concealedAudio:m,totalAudioDuration:v},t.framerate=l,t.resolution=a,t.codec=c,t.jitter=d,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}t.ConnectionStatsReportBuilder=r},67508:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.GroupCallStats=void 0;var i=n(r(13102)),o=r(26054),s=r(12253),a=r(40986),l=r(34002);class c{start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new o.CallStatsReportGatherer(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;null===(r=this.getStatsReportGatherer(e))||void 0===r||r.setOpponentMemberId(t)}processStats(){let e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(e=>this.summaryStatsReportGatherer.build(e)).catch(e=>{l.logger.error("Could not build summary stats report",e)})}setInterval(e){this.interval=e}constructor(e,t,r=1e4){(0,i.default)(this,"gatherers",new Map),(0,i.default)(this,"reports",new s.StatsReportEmitter),(0,i.default)(this,"summaryStatsReportGatherer",new a.SummaryStatsReportGatherer(this.reports)),this.groupCallId=e,this.userId=t,this.interval=r}}t.GroupCallStats=c},85222:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaSsrcHandler=void 0;var i=n(r(13102)),o=r(64109);class s{findMidBySsrc(e,t){let r;return this.ssrcToMid[t].forEach((t,n)=>{if(t.find(t=>t==e)){r=n;return}}),r}parse(e,t){let r=(0,o.parse)(e),n=new Map;r.media.forEach(e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t;let r=[];null===(t=e.ssrcs)||void 0===t||t.forEach(e=>{"cname"===e.attribute&&r.push("".concat(e.id))}),n.set("".concat(e.mid),r)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}constructor(){(0,i.default)(this,"ssrcToMid",{local:new Map,remote:new Map})}}t.MediaSsrcHandler=s},44078:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaTrackHandler=void 0;class r{getLocalTracks(e){let t=t=>null!==t&&t.kind===e;return this.pc.getTransceivers().filter(e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection).filter(e=>null!==e.sender).map(e=>e.sender).map(e=>e.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>(null==t?void 0:t.sender.track)!==null&&t.sender.track.id===e?t.sender.track:(null==t?void 0:t.receiver.track)!==null&&t.receiver.track.id===e?t.receiver.track:void 0).find(e=>void 0!==e)}getLocalTrackIdByMid(e){let t=this.pc.getTransceivers().find(t=>t.mid===e);if(void 0!==t&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){let t=this.pc.getTransceivers().find(t=>t.mid===e);if(void 0!==t&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e)}constructor(e){this.pc=e}}t.MediaTrackHandler=r},7771:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaTrackStats=void 0;var i=n(r(13102));class o{getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}constructor(e,t,r){(0,i.default)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,i.default)(this,"bitrate",{download:0,upload:0}),(0,i.default)(this,"resolution",{width:-1,height:-1}),(0,i.default)(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),(0,i.default)(this,"framerate",0),(0,i.default)(this,"jitter",0),(0,i.default)(this,"codec",""),(0,i.default)(this,"isAlive",!0),(0,i.default)(this,"isMuted",!1),(0,i.default)(this,"isEnabled",!0),this.trackId=e,this.type=t,this.kind=r}}t.MediaTrackStats=o},24753:function(e,t,r){"use strict";var n=r(53058);Object.defineProperty(t,"__esModule",{value:!0}),t.MediaTrackStatsHandler=void 0;var i=n(r(13102)),o=r(7771);class s{findTrack2Stats(e,t){let r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(!r)return;let n=this.track2stats.get(r);if(!n){let e=this.mediaTrackHandler.getTackById(r);if(void 0===e)return;{let i="audio"===e.kind?e.kind:"video";n=new o.MediaTrackStats(r,t,i),this.track2stats.set(r,n)}}return n}findLocalVideoTrackStats(e){if(0!==this.mediaTrackHandler.getLocalTracks("video").length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}constructor(e,t){(0,i.default)(this,"track2stats",new Map),this.mediaSsrcHandler=e,this.mediaTrackHandler=t}}t.MediaTrackStatsHandler=s},70941:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReport=void 0,t.StatsReport=function(e){return e.CONNECTION_STATS="StatsReport.connection_stats",e.CALL_FEED_REPORT="StatsReport.call_feed_report",e.BYTE_SENT_STATS="StatsReport.byte_sent_stats",e.SUMMARY_STATS="StatsReport.summary_stats",e}({})},12253:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReportEmitter=void 0;var n=r(44441),i=r(70941);class o extends n.TypedEventEmitter{emitByteSendReport(e){this.emit(i.StatsReport.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(i.StatsReport.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(i.StatsReport.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(i.StatsReport.SUMMARY_STATS,e)}}t.StatsReportEmitter=o},40986:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryStatsReportGatherer=void 0;class r{build(e){let t=e.filter(e=>!e.isFirstCollection),r=t.length,n=e.length;if(0===r)return;let i={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,s=0;t.forEach(e=>{this.countTrackListReceivedMedia(i,e),this.countConcealedAudio(i,e),o=this.buildMaxJitter(o,e),s=this.buildMaxPacketLoss(s,e)});let a=5,l={percentageReceivedMedia:Number((i.receivedMedia/r).toFixed(a)),percentageReceivedVideoMedia:Number((i.receivedVideo/r).toFixed(a)),percentageReceivedAudioMedia:Number((i.receivedAudio/r).toFixed(a)),maxJitter:o,maxPacketLoss:s,percentageConcealedAudio:Number(i.totalAudio>0?(i.concealedAudio/i.totalAudio).toFixed(a):0),peerConnections:n};this.emitter.emitSummaryStatsReport(l)}static extendSummaryReport(e,t){let r=[],n=[];for(let e of t)for(let t of(n.push(e),e[1]))r.push(t);e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,r.length-1)?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){let r=!1,n=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,r=!0),t.receivedVideoMedia>0||0===t.videoTrackSummary.count?(e.receivedVideo++,n=!0):t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}constructor(e){this.emitter=e}}t.SummaryStatsReportGatherer=r},78641:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TrackStatsBuilder=void 0;var n=r(72151);class i{static buildFramerateResolution(e,t){let r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){let i=e.getFramerate();if(!i){if(r){let e=t.timestamp-r.timestamp;e>0&&t.framesSent&&(i=(t.framesSent-r.framesSent)/e*1e3)}if(!i)return}i=n?Math.round(i/n):0,e.setFramerate(i)}static buildCodec(e,t,r){let n=null==e?void 0:e.get(r.codecId);if(n){let e=n.mimeType.split("/")[1];e&&t.setCodec(e)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:i.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){let i="outbound-rtp"===t.type?"packetsSent":"packetsReceived",o=t[i];(!o||o<0)&&(o=0);let s=Math.max(0,o-n.ValueFormatter.getNonNegativeValue(r[i])),a=Math.max(0,n.ValueFormatter.getNonNegativeValue(t.packetsLost)-n.ValueFormatter.getNonNegativeValue(r.packetsLost));e.setLoss({packetsTotal:s+a,packetsLost:a,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,r,i){let o=Math.max(0,n.ValueFormatter.getNonNegativeValue(e)-n.ValueFormatter.getNonNegativeValue(t)),s=r-i,a=0;return s>0&&(a=Math.round(8*o/s)),a}static setTrackStatsState(e,t){var r;if(void 0===t){e.alive=!1;return}let n="remote"===e.getType()?t.receiver.track:null==t||null===(r=t.sender)||void 0===r?void 0:r.track;if(null==n||"ended"===n.readyState){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){let t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(e=>"remote"===e.getType()),i=n.filter(e=>"audio"===e.kind);return n.forEach(e=>{let n="video"===e.kind?t:r;if(n.count++,e.alive&&e.muted&&n.muted++,n.maxJitter<e.getJitter()&&(n.maxJitter=e.getJitter()),n.maxPacketLoss<e.getLoss().packetsLost&&(n.maxPacketLoss=e.getLoss().packetsLost),i.length>0){var o,s;n.concealedAudio+=null===(o=e.getAudioConcealment())||void 0===o?void 0:o.concealedAudio,n.totalAudio+=null===(s=e.getAudioConcealment())||void 0===s?void 0:s.totalAudioDuration}}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"!==t.type)return;let r=null==t?void 0:t.jitter;if(void 0!==r){let t=n.ValueFormatter.getNonNegativeValue(r);e.setJitter(Math.round(1e3*t))}else e.setJitter(-1)}static buildAudioConcealment(e,t){if("inbound-rtp"!==t.type)return;let r=1e3*(null==t?void 0:t.totalSamplesDuration)/(null==t?void 0:t.totalSamplesReceived)*(null==t?void 0:t.concealedSamples),n=1e3*(null==t?void 0:t.totalSamplesDuration);e.setAudioConcealment(r,n)}}t.TrackStatsBuilder=i},3034:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TransportStatsBuilder=void 0;class r{static buildReport(e,t,r,n){let i=null==e?void 0:e.get(t.localCandidateId),o=null==e?void 0:e.get(t.remoteCandidateId);if(o&&i){let e=void 0!==o.ip?o.ip:o.address,s=o.port,a="".concat(e,":").concat(s),l=void 0!==i.ip?i.ip:i.address,c=i.port,d="".concat(l,":").concat(c),u=o.protocol;r.some(e=>e.ip===a&&e.type===u&&e.localIp===d)||r.push({ip:a,type:u,localIp:d,isFocus:n,localCandidateType:i.candidateType,remoteCandidateType:o.candidateType,networkType:i.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return r}}t.TransportStatsBuilder=r},72151:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ValueFormatter=void 0;class r{static getNonNegativeValue(e){let t=e;return("number"!=typeof t&&(t=Number(t)),isNaN(t))?0:Math.max(0,t)}}t.ValueFormatter=r},97500:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientWidgetApi=void 0;var n=r(67779),i=r(89599),o=r(29669),s=r(43310),a=r(45704),l=r(29973),c=r(81720),d=r(75135),u=r(1029),h=r(71323);function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(){f=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function c(e,t,r,i){var o=Object.create((t&&t.prototype instanceof h?t:h).prototype);return n(o,"_invoke",{value:w(e,r,new R(i||[]))}),o}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u={};function h(){}function g(){}function m(){}var v={};l(v,o,function(){return this});var y=Object.getPrototypeOf,b=y&&y(y(C([])));b&&b!==t&&r.call(b,o)&&(v=b);var S=m.prototype=h.prototype=Object.create(v);function E(e){["next","throw","return"].forEach(function(t){l(e,t,function(e){return this._invoke(t,e)})})}function _(e,t){var i;function o(n,i,s,a){var l=d(e[n],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==p(u)&&r.call(u,"__await")?t.resolve(u.__await).then(function(e){o("next",e,s,a)},function(e){o("throw",e,s,a)}):t.resolve(u).then(function(e){c.value=e,s(c)},function(e){return o("throw",e,s,a)})}a(l.arg)}n(this,"_invoke",{value:function(e,r){function n(){return new t(function(t,n){o(e,r,t,n)})}return i=i?i.then(n,n):n()}})}function w(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return k()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=T(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=d(e,t,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===u)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}function T(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,T(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=TypeError("The iterator does not provide a '"+r+"' method")),u;var i=d(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,u;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=TypeError("iterator result is not an object"),t.delegate=null,u)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function C(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:k}}function k(){return{value:void 0,done:!0}}return g.prototype=m,n(S,"constructor",{value:m,configurable:!0}),n(m,"constructor",{value:g,configurable:!0}),g.displayName=l(m,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,l(e,a,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},E(_.prototype),l(_.prototype,s,function(){return this}),e.AsyncIterator=_,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new _(c(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then(function(e){return e.done?e.value:s.next()})},E(S),l(S,a,"Generator"),l(S,o,function(){return this}),l(S,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=C,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(a&&l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;O(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function g(e,t,r,n,i,o,s){try{var a=e[o](s),l=a.value}catch(e){r(e);return}a.done?t(l):Promise.resolve(l).then(n,i)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function s(e){g(o,n,i,s,a,"next",e)}function a(e){g(o,n,i,s,a,"throw",e)}s(void 0)})}}function v(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=y(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function y(e,t){if(e){if("string"==typeof e)return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return b(e,t)}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach(function(t){A(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function w(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,D(n.key),n)}}function T(e,t,r){return t&&w(e.prototype,t),r&&w(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function I(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&O(e,t)}function O(e,t){return(O=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function R(e){var t=M();return function(){var r,n=P(e);if(t){var i=P(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return C(this,r)}}function C(e,t){if(t&&("object"===p(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return k(e)}function k(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function M(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function A(e,t,r){return(t=D(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function D(e){var t=x(e,"string");return"symbol"===p(t)?t:String(t)}function x(e,t){if("object"!==p(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==p(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function j(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new U(t.call(e));r="@@asyncIterator",n="@@iterator"}throw TypeError("Object is not async iterable")}function U(e){function t(e){if(Object(e)!==e)return Promise.reject(TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return(U=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new U(e)}var L=function(e){I(r,e);var t=R(r);function r(e,n,s){var a;if(_(this,r),(a=t.call(this)).widget=e,a.iframe=n,a.driver=s,A(k(a),"transport",void 0),A(k(a),"contentLoadedActionSent",!1),A(k(a),"allowedCapabilities",new Set),A(k(a),"allowedEvents",[]),A(k(a),"isStopped",!1),A(k(a),"turnServers",null),A(k(a),"contentLoadedWaitTimer",void 0),!(null!=n&&n.contentWindow))throw Error("No iframe supplied");if(!e)throw Error("Invalid widget");if(!s)throw Error("Invalid driver");return a.transport=new i.PostmessageTransport(o.WidgetApiDirection.ToWidget,e.id,n.contentWindow,window),a.transport.targetOrigin=e.origin,a.transport.on("message",a.handleMessage.bind(k(a))),n.addEventListener("load",a.onIframeLoad.bind(k(a))),a.transport.start(),a}return T(r,[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(h.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(c.EventDirection.Send,e,t)})}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(c.EventDirection.Send,e,t)})}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(c.EventDirection.Send,e)})}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(c.EventDirection.Receive,e,t)})}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(c.EventDirection.Receive,e,t)})}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(c.EventDirection.Receive,e)})}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsRoomAccountData(c.EventDirection.Receive,e)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(s.WidgetApiToWidgetAction.Capabilities,{}).then(function(r){return e=r.capabilities,t.driver.validateCapabilities(new Set(r.capabilities))}).then(function(r){console.log("Widget ".concat(t.widget.id," is allowed capabilities:"),Array.from(r)),t.allowedCapabilities=r,t.allowedEvents=c.WidgetEventCapability.findEventCapabilities(r),t.notifyCapabilities(e),t.emit("ready")}).catch(function(e){t.emit("error:preparing",e)})}},{key:"notifyCapabilities",value:function(e){var t=this;this.transport.send(s.WidgetApiToWidgetAction.NotifyCapabilities,{requested:e,approved:Array.from(this.allowedCapabilities)}).catch(function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)}).then(function(){t.emit("capabilitiesNotified")})}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:l.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,r=this;this.transport.reply(e,{});var n=(null===(t=e.data)||void 0===t?void 0:t.capabilities)||[],i=new Set(n.filter(function(e){return!r.hasCapability(e)}));if(0===i.size)return this.notifyCapabilities([]);this.driver.validateCapabilities(i).then(function(e){return e.forEach(function(e){return r.allowedCapabilities.add(e)}),c.WidgetEventCapability.findEventCapabilities(e).forEach(function(e){return r.allowedEvents.push(e)}),r.notifyCapabilities(Array.from(i))})}},{key:"handleNavigate",value:function(e){var t,r,n=this;if(!this.hasCapability(a.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(!(null!==(t=e.data)&&void 0!==t&&t.uri)||!(null!==(r=e.data)&&void 0!==r&&r.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var i=function(t){return console.error("[ClientWidgetApi] Failed to handle navigation: ",t),n.transport.reply(e,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(e.data.uri.toString()).catch(function(e){return i(e)}).then(function(){return n.transport.reply(e,{})})}catch(e){return i(e)}}},{key:"handleOIDC",value:function(e){var t=this,r=1,n=function(n,i){return(i=i||{},r>1)?t.transport.send(s.WidgetApiToWidgetAction.OpenIDCredentials,E({state:n,original_request_id:e.requestId},i)):t.transport.reply(e,E({state:n},i))},i=function(i){return(console.error("[ClientWidgetApi] Failed to handle OIDC: ",i),r>1)?n(d.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:i}})},o=new u.SimpleObservable(function(e){if(e.state===d.OpenIDRequestState.PendingUserConfirmation&&r>1)return o.close(),i("client provided out-of-phase response to OIDC flow");if(e.state===d.OpenIDRequestState.PendingUserConfirmation){n(e.state),r++;return}return e.state!==d.OpenIDRequestState.Allowed||e.token?(e.state===d.OpenIDRequestState.Blocked&&(e.token=void 0),o.close(),n(e.state,e.token)):i("client provided invalid OIDC token for an allowed request")});this.driver.askOpenID(o)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,r=Promise.resolve([]);return(r=this.driver.readRoomAccountData(e.data.type),this.canReceiveRoomAccountData(e.data.type))?r.then(function(r){t.transport.reply(e,{events:r})}):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(void 0!==e.data.limit&&(!e.data.limit||e.data.limit<0))return this.transport.reply(e,{error:{message:"Invalid request - limit out of range"}});var r=null;if(e.data.room_ids){Array.isArray(r=e.data.room_ids)||(r=[r]);var n,i=v(r);try{for(i.s();!(n=i.n()).done;){var o=n.value;if(!this.canUseRoomTimeline(o))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(o)}})}}catch(e){i.e(e)}finally{i.f()}}var s=e.data.limit||0,a=e.data.since,l=Promise.resolve([]);if(void 0!==e.data.state_key){var c=!0===e.data.state_key?void 0:e.data.state_key.toString();if(!this.canReceiveStateEvent(e.data.type,null!=c?c:null))return this.transport.reply(e,{error:{message:"Cannot read state events of this type"}});l=this.driver.readStateEvents(e.data.type,c,s,r)}else{if(!this.canReceiveRoomEvent(e.data.type,e.data.msgtype))return this.transport.reply(e,{error:{message:"Cannot read room events of this type"}});l=this.driver.readRoomEvents(e.data.type,e.data.msgtype,s,r,a)}return l.then(function(r){return t.transport.reply(e,{events:r})})}},{key:"handleSendEvent",value:function(e){var t,r=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});if(null!==e.data.state_key&&void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});t=this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var n=e.data.content||{},i=n.msgtype;if(!this.canSendRoomEvent(e.data.type,i))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});t=this.driver.sendEvent(e.data.type,n,null,e.data.room_id)}t.then(function(t){return r.transport.reply(e,{room_id:t.roomId,event_id:t.eventId})}).catch(function(t){return console.error("error sending event: ",t),r.transport.reply(e,{error:{message:"Error sending event"}})})}},{key:"handleSendToDevice",value:function(){var e=m(f().mark(function e(t){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Invalid request - missing event type"}});case 3:case 8:case 13:case 18:case 25:e.next=32;break;case 5:if(t.data.messages){e.next=10;break}return e.next=8,this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}});case 10:if(!("boolean"!=typeof t.data.encrypted)){e.next=15;break}return e.next=13,this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}});case 15:if(this.canSendToDeviceEvent(t.data.type)){e.next=20;break}return e.next=18,this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}});case 20:return e.prev=20,e.next=23,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 23:return e.next=25,this.transport.reply(t,{});case 27:return e.prev=27,e.t0=e.catch(20),console.error("error sending to-device event",e.t0),e.next=32,this.transport.reply(t,{error:{message:"Error sending event"}});case 32:case"end":return e.stop()}},e,this,[[20,27]])}));return function(t){return e.apply(this,arguments)}}()},{key:"pollTurnServers",value:function(){var e=m(f().mark(function e(t,r){var n,i,o,a,l,c;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,r);case 3:n=!1,i=!1,e.prev=5,a=j(t);case 7:return e.next=9,a.next();case 9:if(!(n=!(l=e.sent).done)){e.next=16;break}return c=l.value,e.next=13,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,c);case 13:n=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),i=!0,o=e.t0;case 22:if(e.prev=22,e.prev=23,!(n&&null!=a.return)){e.next=27;break}return e.next=27,a.return();case 27:if(e.prev=27,!i){e.next=30;break}throw o;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e.catch(0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}},e,this,[[0,34],[5,18,22,32],[23,,27,31]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"handleWatchTurnServers",value:function(){var e=m(f().mark(function e(t){var r,n,i,o;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=30;break;case 5:if(!this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.prev=10,r=this.driver.getTurnServers(),e.next=14,r.next();case 14:if(i=(n=e.sent).done,o=n.value,!i){e.next=19;break}throw Error("Client refuses to provide any TURN servers");case 19:return e.next=21,this.transport.reply(t,{});case 21:this.pollTurnServers(r,o),this.turnServers=r,e.next=30;break;case 25:return e.prev=25,e.t0=e.catch(10),console.error("error getting first TURN server results",e.t0),e.next=30,this.transport.reply(t,{error:{message:"TURN servers not available"}});case 30:case"end":return e.stop()}},e,this,[[10,25]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleUnwatchTurnServers",value:function(){var e=m(f().mark(function e(t){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=15;break;case 5:if(this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,e.next=15,this.transport.reply(t,{});case 15:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"handleReadRelations",value:function(){var e=m(f().mark(function e(t){var r,n,i=this;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(void 0!==t.data.room_id&&!this.canUseRoomTimeline(t.data.room_id))){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return n=(r=e.sent).chunk.filter(function(e){return void 0!==e.state_key?i.canReceiveStateEvent(e.type,e.state_key):i.canReceiveRoomEvent(e.type,e.content.msgtype)}),e.abrupt("return",this.transport.reply(t,{chunk:n,prev_batch:r.prevBatch,next_batch:r.nextBatch}));case 14:return e.prev=14,e.t0=e.catch(6),console.error("error getting the relations",e.t0),e.next=19,this.transport.reply(t,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return e.stop()}},e,this,[[6,14]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleUserDirectorySearch",value:function(){var e=m(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if(!("string"!=typeof t.data.search_term)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return r=e.sent,e.abrupt("return",this.transport.reply(t,{limited:r.limited,results:r.results.map(function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}})}));case 13:return e.prev=13,e.t0=e.catch(6),console.error("error searching in the user directory",e.t0),e.next=18,this.transport.reply(t,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return e.stop()}},e,this,[[6,13]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleGetMediaConfig",value:function(){var e=m(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,r));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while getting the media configuration",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while getting the media configuration"}});case 14:case"end":return e.stop()}},e,this,[[2,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleUploadFile",value:function(){var e=m(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:r.contentUri}));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while uploading a file",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while uploading a file"}});case 14:case"end":return e.stop()}},e,this,[[2,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case s.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case s.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case s.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case s.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case s.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case s.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case s.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case s.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case s.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case s.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case s.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case s.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case s.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(s.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:function(){var e=m(f().mark(function e(t,r){var n;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.room_id!==r&&!this.canUseRoomTimeline(t.room_id))){e.next=2;break}return e.abrupt("return");case 2:if(!(void 0!==t.state_key&&null!==t.state_key)){e.next=7;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=5;break}return e.abrupt("return");case 5:e.next=9;break;case 7:if(this.canReceiveRoomEvent(t.type,null===(n=t.content)||void 0===n?void 0:n.msgtype)){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,this.transport.send(s.WidgetApiToWidgetAction.SendEvent,t);case 11:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"feedToDevice",value:function(){var e=m(f().mark(function e(t,r){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(s.WidgetApiToWidgetAction.SendToDevice,E(E({},t),{},{encrypted:r}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()}]),r}(n.EventEmitter);t.ClientWidgetApi=L},71323:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Symbols=void 0;var r=function(e){return e.AnyRoom="*",e}({});t.Symbols=r},95915:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApi=void 0;var n=r(67779),i=r(29669),o=r(29973),s=r(89599),a=r(43310),l=r(75135),c=r(85314),d=r(47860),u=r(81720),h=r(71323);function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(){f=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function c(e,t,r,i){var o=Object.create((t&&t.prototype instanceof h?t:h).prototype);return n(o,"_invoke",{value:w(e,r,new R(i||[]))}),o}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u={};function h(){}function g(){}function m(){}var v={};l(v,o,function(){return this});var y=Object.getPrototypeOf,b=y&&y(y(C([])));b&&b!==t&&r.call(b,o)&&(v=b);var S=m.prototype=h.prototype=Object.create(v);function E(e){["next","throw","return"].forEach(function(t){l(e,t,function(e){return this._invoke(t,e)})})}function _(e,t){var i;function o(n,i,s,a){var l=d(e[n],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==p(u)&&r.call(u,"__await")?t.resolve(u.__await).then(function(e){o("next",e,s,a)},function(e){o("throw",e,s,a)}):t.resolve(u).then(function(e){c.value=e,s(c)},function(e){return o("throw",e,s,a)})}a(l.arg)}n(this,"_invoke",{value:function(e,r){function n(){return new t(function(t,n){o(e,r,t,n)})}return i=i?i.then(n,n):n()}})}function w(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return k()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=T(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=d(e,t,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===u)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}function T(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,T(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=TypeError("The iterator does not provide a '"+r+"' method")),u;var i=d(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,u;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=TypeError("iterator result is not an object"),t.delegate=null,u)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function C(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:k}}function k(){return{value:void 0,done:!0}}return g.prototype=m,n(S,"constructor",{value:m,configurable:!0}),n(m,"constructor",{value:g,configurable:!0}),g.displayName=l(m,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,l(e,a,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},E(_.prototype),l(_.prototype,s,function(){return this}),e.AsyncIterator=_,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new _(c(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then(function(e){return e.done?e.value:s.next()})},E(S),l(S,a,"Generator"),l(S,o,function(){return this}),l(S,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=C,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(a&&l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;O(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function g(e,t,r,n,i,o,s){try{var a=e[o](s),l=a.value}catch(e){r(e);return}a.done?t(l):Promise.resolve(l).then(n,i)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function s(e){g(o,n,i,s,a,"next",e)}function a(e){g(o,n,i,s,a,"throw",e)}s(void 0)})}}function v(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function y(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,C(n.key),n)}}function b(e,t,r){return t&&y(e.prototype,t),r&&y(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function S(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&E(e,t)}function E(e,t){return(E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _(e){var t=I();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return w(this,r)}}function w(e,t){if(t&&("object"===p(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return T(e)}function T(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function I(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function O(e){return(O=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function R(e,t,r){return(t=C(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function C(e){var t=k(e,"string");return"symbol"===p(t)?t:String(t)}function k(e,t){if("object"!==p(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==p(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function M(e){return new D(e,0)}function P(e){return function(){return new A(e.apply(this,arguments))}}function A(e){var t,r;function n(t,r){try{var o=e[t](r),s=o.value,a=s instanceof D;Promise.resolve(a?s.v:s).then(function(r){if(a){var l="return"===t?"return":"next";if(!s.k||r.done)return n(l,r);r=e[l](r).value}i(o.done?"return":"normal",r)},function(e){n("throw",e)})}catch(e){i("throw",e)}}function i(e,i){switch(e){case"return":t.resolve({value:i,done:!0});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:!1})}(t=t.next)?n(t.key,t.arg):r=null}this._invoke=function(e,i){return new Promise(function(o,s){var a={key:e,arg:i,resolve:o,reject:s,next:null};r?r=r.next=a:(t=r=a,n(e,i))})},"function"!=typeof e.return&&(this.return=void 0)}function D(e,t){this.v=e,this.k=t}A.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},A.prototype.next=function(e){return this._invoke("next",e)},A.prototype.throw=function(e){return this._invoke("throw",e)},A.prototype.return=function(e){return this._invoke("return",e)};var x=function(e){S(r,e);var t=_(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(v(this,r),(e=t.call(this)).clientOrigin=o,R(T(e),"transport",void 0),R(T(e),"capabilitiesFinished",!1),R(T(e),"supportsMSC2974Renegotiate",!1),R(T(e),"requestedCapabilities",[]),R(T(e),"approvedCapabilities",void 0),R(T(e),"cachedClientVersions",void 0),R(T(e),"turnServerWatchers",0),!window.parent)throw Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new s.PostmessageTransport(i.WidgetApiDirection.FromWidget,n,window.parent,window),e.transport.targetOrigin=o,e.transport.on("message",e.handleMessage.bind(T(e))),e}return b(r,[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t=this;e.forEach(function(e){return t.requestCapability(e)})}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomAccountData(u.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise(function(t,r){e.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(n){var i=n.response;if(i.state===l.OpenIDRequestState.Allowed)t(i);else if(i.state===l.OpenIDRequestState.Blocked)r(Error("User declined to verify their identity"));else if(i.state===l.OpenIDRequestState.PendingUserConfirmation){var o=function o(s){s.preventDefault();var c=s.detail;c.data.original_request_id===n.requestId&&(c.data.state===l.OpenIDRequestState.Allowed?(t(c.data),e.transport.reply(c,{})):c.data.state===l.OpenIDRequestState.Blocked?(r(Error("User declined to verify their identity")),e.transport.reply(c,{})):(r(Error("Invalid state on reply: "+i.state)),e.transport.reply(c,{error:{message:"Invalid state"}})),e.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),o))};e.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),o)}else r(Error("Invalid state: "+i.state))}).catch(r)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then(function(e){return e.success})}},{key:"openModalWidget",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:c.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:i,url:e,name:t,buttons:r,data:n}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,r){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,{type:e,content:t,room_id:r})}},{key:"sendStateEvent",value:function(e,t,r,n){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,{type:e,content:r,state_key:t,room_id:n})}},{key:"sendToDevice",value:function(e,t,r){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:r})}},{key:"readRoomAccountData",value:function(e,t){var r={type:e};return t&&(t.includes(h.Symbols.AnyRoom)?r.room_ids=h.Symbols.AnyRoom:r.room_ids=t),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,r).then(function(e){return e.events})}},{key:"readRoomEvents",value:function(e,t,r,n,i){var o={type:e,msgtype:r};return void 0!==t&&(o.limit=t),n&&(n.includes(h.Symbols.AnyRoom)?o.room_ids=h.Symbols.AnyRoom:o.room_ids=n),i&&(o.since=i),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,o).then(function(e){return e.events})}},{key:"readEventRelations",value:function(){var e=m(f().mark(function e(t,r,n,i,s,l,c,d){var u;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC3869)){e.next=5;break}throw Error("The read_relations action is not supported by the client.");case 5:return u={event_id:t,rel_type:n,event_type:i,room_id:r,to:c,from:l,limit:s,direction:d},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,u));case 7:case"end":return e.stop()}},e,this)}));return function(t,r,n,i,o,s,a,l){return e.apply(this,arguments)}}()},{key:"readStateEvents",value:function(e,t,r,n){var i={type:e,state_key:void 0===r||r};return void 0!==t&&(i.limit=t),n&&(n.includes(h.Symbols.AnyRoom)?i.room_ids=h.Symbols.AnyRoom:i.room_ids=n),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,i).then(function(e){return e.events})}},{key:"setModalButtonEnabled",value:function(e,t){if(e===d.BuiltInModalButtonID.Close)throw Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e=this;return P(f().mark(function t(){var r,n;return f().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=function(){var t=m(f().mark(function t(n){return f().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n.preventDefault(),r(n.detail.data),t.next=4,e.transport.reply(n.detail,{});case 4:case"end":return t.stop()}},t)}));return function(e){return t.apply(this,arguments)}}(),e.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),0!==e.turnServerWatchers){t.next=12;break}return t.prev=3,t.next=6,M(e.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:t.next=12;break;case 8:throw t.prev=8,t.t0=t.catch(3),e.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),t.t0;case 12:e.turnServerWatchers++,t.prev=13;case 14:return t.next=17,M(new Promise(function(e){return r=e}));case 17:return t.next=19,t.sent;case 19:t.next=14;break;case 21:if(t.prev=21,e.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),n),e.turnServerWatchers--,0!==e.turnServerWatchers){t.next=27;break}return t.next=27,M(e.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return t.finish(21);case 28:case"end":return t.stop()}},t,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var e=m(f().mark(function e(t,r){var n;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC3973)){e.next=5;break}throw Error("The user_directory_search action is not supported by the client.");case 5:return n={search_term:t,limit:r},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,n));case 7:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"getMediaConfig",value:function(){var e=m(f().mark(function e(){var t;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC4039)){e.next=5;break}throw Error("The get_media_config action is not supported by the client.");case 5:return t={},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,t));case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"uploadFile",value:function(){var e=m(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC4039)){e.next=5;break}throw Error("The upload_file action is not supported by the client.");case 5:return r={file:t},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,r));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then(function(t){t.includes(o.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:o.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions}).catch(function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]})}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(r){return r.includes(o.UnstableApiVersion.MSC2871)?t.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")}):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})})}}]),r}(n.EventEmitter);t.WidgetApi=x},21244:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetDriver=void 0;var n=r(98826);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,l(n.key),n)}}function a(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e){var t=c(e,"string");return"symbol"===i(t)?t:String(t)}function c(e,t){if("object"!==i(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==i(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var d=function(){function e(){o(this,e)}return a(e,[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.reject(Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,r){return Promise.reject(Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1],Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,r){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&arguments[4],Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,r){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.resolve([])}},{key:"readEventRelations",value:function(e,t,r,n,i,o,s,a){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(e){e.update({state:n.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw Error("Upload file is not implemented")}}]),e}();t.WidgetDriver=d},98826:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(95915);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))});var i=r(97500);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(71323);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var s=r(14728);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var a=r(89599);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var l=r(8127);Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var c=r(61561);Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))});var d=r(73069);Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(50122);Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(85314);Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var p=r(90910);Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var f=r(47943);Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))});var g=r(19026);Object.keys(g).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))});var m=r(43310);Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))});var v=r(29669);Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))});var y=r(29973);Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))});var b=r(45704);Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))});var S=r(65722);Object.keys(S).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))});var E=r(72392);Object.keys(E).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))});var _=r(32413);Object.keys(_).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))});var w=r(45227);Object.keys(w).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))});var T=r(79020);Object.keys(T).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))});var I=r(94771);Object.keys(I).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))});var O=r(72287);Object.keys(O).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))});var R=r(75135);Object.keys(R).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))});var C=r(43571);Object.keys(C).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))});var k=r(19353);Object.keys(k).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))});var M=r(881);Object.keys(M).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===M[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return M[e]}}))});var P=r(47860);Object.keys(P).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))});var A=r(8877);Object.keys(A).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))});var D=r(19091);Object.keys(D).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))});var x=r(63024);Object.keys(x).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===x[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return x[e]}}))});var j=r(70356);Object.keys(j).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===j[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return j[e]}}))});var U=r(55734);Object.keys(U).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===U[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return U[e]}}))});var L=r(97501);Object.keys(L).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===L[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return L[e]}}))});var N=r(38214);Object.keys(N).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===N[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return N[e]}}))});var B=r(71636);Object.keys(B).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===B[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return B[e]}}))});var F=r(18898);Object.keys(F).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===F[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return F[e]}}))});var K=r(65685);Object.keys(K).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===K[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return K[e]}}))});var q=r(50828);Object.keys(q).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return q[e]}}))});var V=r(95180);Object.keys(V).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===V[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return V[e]}}))});var W=r(81720);Object.keys(W).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===W[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return W[e]}}))});var G=r(58756);Object.keys(G).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===G[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return G[e]}}))});var H=r(83711);Object.keys(H).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===H[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return H[e]}}))});var z=r(52771);Object.keys(z).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return z[e]}}))});var J=r(82977);Object.keys(J).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===J[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return J[e]}}))});var Y=r(44434);Object.keys(Y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Y[e]}}))});var Q=r(1029);Object.keys(Q).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Q[e]}}))});var X=r(21244);Object.keys(X).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===X[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return X[e]}}))})},29973:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableApiVersion=t.MatrixApiVersion=t.CurrentApiVersions=void 0;var r=function(e){return e.Prerelease1="0.0.1",e.Prerelease2="0.0.2",e}({});t.MatrixApiVersion=r;var n=function(e){return e.MSC2762="org.matrix.msc2762",e.MSC2871="org.matrix.msc2871",e.MSC2931="org.matrix.msc2931",e.MSC2974="org.matrix.msc2974",e.MSC2876="org.matrix.msc2876",e.MSC3819="org.matrix.msc3819",e.MSC3846="town.robin.msc3846",e.MSC3869="org.matrix.msc3869",e.MSC3973="org.matrix.msc3973",e.MSC4039="org.matrix.msc4039",e}({});t.UnstableApiVersion=n;var i=[r.Prerelease1,r.Prerelease2,n.MSC2762,n.MSC2871,n.MSC2931,n.MSC2974,n.MSC2876,n.MSC3819,n.MSC3846,n.MSC3869,n.MSC3973,n.MSC4039];t.CurrentApiVersions=i},45704:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoConferenceCapabilities=t.StickerpickerCapabilities=t.MatrixCapabilities=void 0,t.getTimelineRoomIDFromCapability=a,t.isTimelineCapability=o,t.isTimelineCapabilityFor=s;var r=function(e){return e.Screenshots="m.capability.screenshot",e.StickerSending="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.RequiresClient="io.element.requires_client",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC3846TurnServers="town.robin.msc3846.turn_servers",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039UploadFile="org.matrix.msc4039.upload_file",e}({});t.MatrixCapabilities=r;var n=[r.StickerSending];t.StickerpickerCapabilities=n;var i=[r.AlwaysOnScreen];function o(e){return null==e?void 0:e.startsWith("org.matrix.msc2762.timeline:")}function s(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)}function a(e){return e.substring(e.indexOf(":")+1)}t.VideoConferenceCapabilities=i},65722:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},72392:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},50828:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},75135:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenIDRequestState=void 0;var r=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});t.OpenIDRequestState=r},8127:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},61561:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},38214:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},97501:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},73069:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},50122:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},90910:function(e,t){"use strict";function r(e){return"error"in e&&!!e.error.message}Object.defineProperty(t,"__esModule",{value:!0}),t.isErrorResponse=r},47943:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},19026:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},881:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalButtonKind=void 0;var r=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});t.ModalButtonKind=r},47860:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuiltInModalButtonID=void 0;var r=function(e){return e.Close="m.close",e}({});t.BuiltInModalButtonID=r},71636:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},43571:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},55734:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},65685:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},32413:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},63024:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},70356:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},8877:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},45227:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},79020:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},94771:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},18898:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},95180:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},72287:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},43310:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiToWidgetAction=t.WidgetApiFromWidgetAction=void 0;var r=function(e){return e.SupportedApiVersions="supported_api_versions",e.Capabilities="capabilities",e.NotifyCapabilities="notify_capabilities",e.TakeScreenshot="screenshot",e.UpdateVisibility="visibility",e.OpenIDCredentials="openid_credentials",e.WidgetConfig="widget_config",e.CloseModalWidget="close_modal",e.ButtonClicked="button_clicked",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.UpdateTurnServers="update_turn_servers",e}({});t.WidgetApiToWidgetAction=r;var n=function(e){return e.SupportedApiVersions="supported_api_versions",e.ContentLoaded="content_loaded",e.SendSticker="m.sticker",e.UpdateAlwaysOnScreen="set_always_on_screen",e.GetOpenIDCredentials="get_openid",e.CloseModalWidget="close_modal",e.OpenModalWidget="open_modal",e.SetModalButtonEnabled="set_button_enabled",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.WatchTurnServers="watch_turn_servers",e.UnwatchTurnServers="unwatch_turn_servers",e.BeeperReadRoomAccountData="com.beeper.read_room_account_data",e.MSC2876ReadEvents="org.matrix.msc2876.read_events",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",e.MSC3869ReadRelations="org.matrix.msc3869.read_relations",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",e.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",e}({});t.WidgetApiFromWidgetAction=n},29669:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiDirection=void 0,t.invertedDirection=n;var r=function(e){return e.ToWidget="toWidget",e.FromWidget="fromWidget",e}({});function n(e){if(e===r.ToWidget)return r.FromWidget;if(e===r.FromWidget)return r.ToWidget;throw Error("Invalid direction")}t.WidgetApiDirection=r},19091:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},19353:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetKind=void 0;var r=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});t.WidgetKind=r},85314:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixWidgetType=void 0;var r=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});t.MatrixWidgetType=r},52771:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Widget=void 0;var n=r(83711),i=r(98826);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,c(n.key),n)}}function l(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e){var t=d(e,"string");return"symbol"===o(t)?t:String(t)}function d(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var u=function(){function e(t){if(s(this,e),this.definition=t,!this.definition)throw Error("Definition is required");(0,n.assertPresent)(t,"id"),(0,n.assertPresent)(t,"creatorUserId"),(0,n.assertPresent)(t,"type"),(0,n.assertPresent)(t,"url")}return l(e,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,i.runTemplate)(this.templateUrl,this.definition,e)}}]),e}();t.Widget=u},81720:function(e,t){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=i(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){l=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(l)throw s}}}}function i(e,t){if(e){if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(e,t)}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,c(n.key),n)}}function l(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e){var t=d(e,"string");return"symbol"===r(t)?t:String(t)}function d(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==r(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetEventCapability=t.EventKind=t.EventDirection=void 0;var u=function(e){return e.Event="event",e.State="state_event",e.ToDevice="to_device",e.RoomAccount="room_account",e}({});t.EventKind=u;var h=function(e){return e.Send="send",e.Receive="receive",e}({});t.EventDirection=h;var p=function(){function e(t,r,n,i,o){s(this,e),this.direction=t,this.eventType=r,this.kind=n,this.keyStr=i,this.raw=o}return l(e,[{key:"matchesAsStateEvent",value:function(e,t,r){return this.kind===u.State&&this.direction===e&&this.eventType===t&&(null===this.keyStr||this.keyStr===r)}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===u.ToDevice&&this.direction===e&&this.eventType===t}},{key:"matchesAsRoomEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===u.Event&&this.direction===e&&this.eventType===t&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===r)}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===u.RoomAccount&&this.direction===e&&this.eventType===t}}],[{key:"forStateEvent",value:function(t,r,n){r=r.replace(/#/g,"\\#"),n=null!=n?"#".concat(n):"";var i="org.matrix.msc2762.".concat(t,".state_event:").concat(r).concat(n);return e.findEventCapabilities([i])[0]}},{key:"forToDeviceEvent",value:function(t,r){var n="org.matrix.msc3819.".concat(t,".to_device:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(t,r){var n="org.matrix.msc2762.".concat(t,".event:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(t,r){r=null==r?"":r;var n="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(t,r){var n="com.beeper.capabilities.".concat(t,".room_account_data:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(t){var r,i=[],o=n(t);try{for(o.s();!(r=o.n()).done;){var s=r.value,a=null,l=void 0,c=null;if(s.startsWith("org.matrix.msc2762.send.event:")?(a=h.Send,c=u.Event,l=s.substring(30)):s.startsWith("org.matrix.msc2762.send.state_event:")?(a=h.Send,c=u.State,l=s.substring(36)):s.startsWith("org.matrix.msc3819.send.to_device:")?(a=h.Send,c=u.ToDevice,l=s.substring(34)):s.startsWith("org.matrix.msc2762.receive.event:")?(a=h.Receive,c=u.Event,l=s.substring(33)):s.startsWith("org.matrix.msc2762.receive.state_event:")?(a=h.Receive,c=u.State,l=s.substring(39)):s.startsWith("org.matrix.msc3819.receive.to_device:")?(a=h.Receive,c=u.ToDevice,l=s.substring(37)):s.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(a=h.Receive,c=u.RoomAccount,l=s.substring(50)),null!==a&&null!==c&&void 0!==l){var d=l.startsWith("m.room.message#")||c===u.State,p=null;if(l.includes("#")&&d){var f=l.split("#"),g=f.findIndex(function(e){return!e.endsWith("\\")});l=f.slice(0,g+1).map(function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e}).join("#"),p=f.slice(g+1).join("#")}i.push(new e(a,l,c,p,s))}}}catch(e){o.e(e)}finally{o.f()}return i}}]),e}();t.WidgetEventCapability=p},82977:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetParser=void 0;var n=r(52771),i=r(58756);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=a(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw o}}}}function a(e,t){if(e){if("string"==typeof e)return l(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return l(e,t)}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function c(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,h(n.key),n)}}function u(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e){var t=p(e,"string");return"symbol"===o(t)?t:String(t)}function p(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var f=function(){function e(){c(this,e)}return u(e,null,[{key:"parseAccountData",value:function(t){if(!t)return[];for(var r=[],n=0,i=Object.keys(t);n<i.length;n++){var o=i[n],s=t[o];if(s&&("m.widget"===s.type||"im.vector.modular.widgets"===s.type)&&s.sender&&(s.state_key||s.id)===o){var a={content:s.content,sender:s.sender,type:"m.widget",state_key:o,event_id:"$example",room_id:"!example",origin_server_ts:1},l=e.parseRoomWidget(a);l&&r.push(l)}}return r}},{key:"parseWidgetsFromRoomState",value:function(t){if(!t)return[];var r,n=[],i=s(t);try{for(i.s();!(r=i.n()).done;){var o=r.value,a=e.parseRoomWidget(o);a&&n.push(a)}}catch(e){i.e(e)}finally{i.f()}return n}},{key:"parseRoomWidget",value:function(t){if(!t||"m.widget"!==t.type&&"im.vector.modular.widgets"!==t.type)return null;var r=t.content||{},n={id:t.state_key,creatorUserId:r.creatorUserId||t.sender,name:r.name,type:r.type,url:r.url,waitForIframeLoad:r.waitForIframeLoad,data:r.data};return e.processEstimatedWidget(n)}},{key:"processEstimatedWidget",value:function(e){return e.id&&e.creatorUserId&&e.type&&(0,i.isValidUrl)(e.url)?new n.Widget(e):null}}]),e}();t.WidgetParser=f},58756:function(e,t){"use strict";function r(e){if(!e)return!1;try{var t=new URL(e);if("http"!==t.protocol&&"https"!==t.protocol)return!1;return!0}catch(e){if(e instanceof TypeError)return!1;throw e}}Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUrl=r},83711:function(e,t){"use strict";function r(e,t){if(!e[t])throw Error("".concat(String(t)," is required"))}Object.defineProperty(t,"__esModule",{value:!0}),t.assertPresent=r},44434:function(e,t){"use strict";function r(e,t,r){for(var i=Object.assign({},t.data,{matrix_room_id:r.widgetRoomId||"",matrix_user_id:r.currentUserId,matrix_display_name:r.userDisplayName||r.currentUserId,matrix_avatar_url:r.userHttpAvatarUrl||"",matrix_widget_id:t.id,"org.matrix.msc2873.client_id":r.clientId||"","org.matrix.msc2873.client_theme":r.clientTheme||"","org.matrix.msc2873.client_language":r.clientLanguage||"","org.matrix.msc3819.matrix_device_id":r.deviceId||"","org.matrix.msc4039.matrix_base_url":r.baseUrl||""}),o=e,s=0,a=Object.keys(i);s<a.length;s++){var l=a[s],c=RegExp("$".concat(l).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g");o=o.replace(c,encodeURIComponent(n(i[l])))}return o}function n(e){return null==e?"".concat(e):String(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.runTemplate=r,t.toString=n},14728:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},89599:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PostmessageTransport=void 0;var n=r(67779),i=r(98826);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){y(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function l(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,b(n.key),n)}}function d(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}function h(e,t){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function p(e){var t=m();return function(){var r,n=v(e);if(t){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return f(this,r)}}function f(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return g(e)}function g(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function v(e){return(v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function y(e,t,r){return(t=b(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e){var t=S(e,"string");return"symbol"===o(t)?t:String(t)}function S(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var E=function(e){u(r,e);var t=p(r);function r(e,n,i,o){var s;return l(this,r),(s=t.call(this)).sendDirection=e,s.initialWidgetId=n,s.transportWindow=i,s.inboundWindow=o,y(g(s),"strictOriginCheck",!1),y(g(s),"targetOrigin","*"),y(g(s),"timeoutSeconds",10),y(g(s),"_ready",!1),y(g(s),"_widgetId",null),y(g(s),"outboundRequests",new Map),y(g(s),"stopController",new AbortController),s._widgetId=n,s}return d(r,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var e="widgetapi-".concat(Date.now()),t=0,r=e;this.outboundRequests.has(r);)r="".concat(e,"-").concat(t++);return this.outboundRequests.set(r,null),r}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(a(a({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then(function(e){return e.response})}},{key:"sendComplete",value:function(e,t){var r=this;if(!this.ready||!this.widgetId)return Promise.reject(Error("Not ready or unknown widget ID"));var n={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===i.WidgetApiToWidgetAction.UpdateVisibility&&(n.visible=t.visible),new Promise(function(e,t){var i=function(t){l(),e(t)},o=function(e){l(),t(e)},s=setTimeout(function(){return o(Error("Request timed out"))},1e3*(r.timeoutSeconds||1)),a=function(){return o(Error("Transport stopped"))};r.stopController.signal.addEventListener("abort",a);var l=function(){r.outboundRequests.delete(n.requestId),clearTimeout(s),r.stopController.signal.removeEventListener("abort",a)};r.outboundRequests.set(n.requestId,{request:n,resolve:i,reject:o}),r.sendInternal(n)})}},{key:"start",value:function(){var e=this;this.inboundWindow.addEventListener("message",function(t){e.handleMessage(t)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(e){if(!this.stopController.signal.aborted&&e.data&&(!this.strictOriginCheck||e.origin===window.origin)){var t=e.data;if(t.action&&t.requestId&&t.widgetId){if(t.response){if(t.api!==this.sendDirection)return;this.handleResponse(t)}else{var r=t;if(r.api!==(0,i.invertedDirection)(this.sendDirection))return;this.handleRequest(r)}}}}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var t=this.outboundRequests.get(e.requestId);if(t){if((0,i.isErrorResponse)(e.response)){var r=e.response;t.reject(Error(r.error.message))}else t.resolve(e)}}}}]),r}(n.EventEmitter);t.PostmessageTransport=E},1029:function(e,t){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=i(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){l=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(l)throw s}}}}function i(e,t){if(e){if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(e,t)}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,d(n.key),n)}}function l(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,r){return(t=d(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){var t=u(e,"string");return"symbol"===r(t)?t:String(t)}function u(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==r(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObservable=void 0;var h=function(){function e(t){s(this,e),c(this,"listeners",[]),t&&this.listeners.push(t)}return l(e,[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var t,r=n(this.listeners);try{for(r.s();!(t=r.n()).done;)(0,t.value)(e)}catch(e){r.e(e)}finally{r.f()}}},{key:"close",value:function(){this.listeners=[]}}]),e}();t.SimpleObservable=h},13507:function(e,t,r){"use strict";r.d(t,{default:function(){return i.a}});var n=r(65198),i=r.n(n)},53922:function(e,t,r){"use strict";r.d(t,{default:function(){return i.a}});var n=r(29914),i=r.n(n)},55426:function(e,t,r){"use strict";var n,i;e.exports=(null==(n=r.g.process)?void 0:n.env)&&"object"==typeof(null==(i=r.g.process)?void 0:i.env)?r.g.process:r(27448)},74117:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"Image",{enumerable:!0,get:function(){return b}});let n=r(3280),i=r(87791),o=r(19506),s=i._(r(22971)),a=n._(r(8613)),l=n._(r(33328)),c=r(48145),d=r(38792),u=r(51632);r(43737);let h=r(84512),p=n._(r(29657)),f={deviceSizes:[640,750,828,1080,1200,1920,2048,3840],imageSizes:[16,32,48,64,96,128,256,384],path:"/_next/image",loader:"default",dangerouslyAllowSVG:!1,unoptimized:!0};function g(e,t,r,n,i,o){let s=null==e?void 0:e.src;e&&e["data-loaded-src"]!==s&&(e["data-loaded-src"]=s,("decode"in e?e.decode():Promise.resolve()).catch(()=>{}).then(()=>{if(e.parentElement&&e.isConnected){if("empty"!==t&&i(!0),null==r?void 0:r.current){let t=new Event("load");Object.defineProperty(t,"target",{writable:!1,value:e});let n=!1,i=!1;r.current({...t,nativeEvent:t,currentTarget:e,target:e,isDefaultPrevented:()=>n,isPropagationStopped:()=>i,persist:()=>{},preventDefault:()=>{n=!0,t.preventDefault()},stopPropagation:()=>{i=!0,t.stopPropagation()}})}(null==n?void 0:n.current)&&n.current(e)}}))}function m(e){let[t,r]=s.version.split(".",2),n=parseInt(t,10),i=parseInt(r,10);return n>18||18===n&&i>=3?{fetchPriority:e}:{fetchpriority:e}}let v=(0,s.forwardRef)((e,t)=>{let{src:r,srcSet:n,sizes:i,height:a,width:l,decoding:c,className:d,style:u,fetchPriority:h,placeholder:p,loading:f,unoptimized:v,fill:y,onLoadRef:b,onLoadingCompleteRef:S,setBlurComplete:E,setShowAltText:_,onLoad:w,onError:T,...I}=e;return(0,o.jsx)("img",{...I,...m(h),loading:f,width:l,height:a,decoding:c,"data-nimg":y?"fill":"1",className:d,style:u,sizes:i,srcSet:n,src:r,ref:(0,s.useCallback)(e=>{t&&("function"==typeof t?t(e):"object"==typeof t&&(t.current=e)),e&&(T&&(e.src=e.src),e.complete&&g(e,p,b,S,E,v))},[r,p,b,S,E,T,v,t]),onLoad:e=>{g(e.currentTarget,p,b,S,E,v)},onError:e=>{_(!0),"empty"!==p&&E(!0),T&&T(e)}})});function y(e){let{isAppRouter:t,imgAttributes:r}=e,n={as:"image",imageSrcSet:r.srcSet,imageSizes:r.sizes,crossOrigin:r.crossOrigin,referrerPolicy:r.referrerPolicy,...m(r.fetchPriority)};return t&&a.default.preload?(a.default.preload(r.src,n),null):(0,o.jsx)(l.default,{children:(0,o.jsx)("link",{rel:"preload",href:r.srcSet?void 0:r.src,...n},"__nimg-"+r.src+r.srcSet+r.sizes)})}let b=(0,s.forwardRef)((e,t)=>{let r=!(0,s.useContext)(h.RouterContext),n=(0,s.useContext)(u.ImageConfigContext),i=(0,s.useMemo)(()=>{let e=f||n||d.imageConfigDefault,t=[...e.deviceSizes,...e.imageSizes].sort((e,t)=>e-t),r=e.deviceSizes.sort((e,t)=>e-t);return{...e,allSizes:t,deviceSizes:r}},[n]),{onLoad:a,onLoadingComplete:l}=e,g=(0,s.useRef)(a);(0,s.useEffect)(()=>{g.current=a},[a]);let m=(0,s.useRef)(l);(0,s.useEffect)(()=>{m.current=l},[l]);let[b,S]=(0,s.useState)(!1),[E,_]=(0,s.useState)(!1),{props:w,meta:T}=(0,c.getImgProps)(e,{defaultLoader:p.default,imgConf:i,blurComplete:b,showAltText:E});return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(v,{...w,unoptimized:T.unoptimized,placeholder:T.placeholder,fill:T.fill,onLoadRef:g,onLoadingCompleteRef:m,setBlurComplete:S,setShowAltText:_,ref:t}),T.priority?(0,o.jsx)(y,{isAppRouter:r,imgAttributes:w}):null]})});("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},31180:function(e){"use strict";var t="/";!function(){var r={675:function(e,t){t.byteLength=c,t.toByteArray=u,t.fromByteArray=f;for(var r=[],n=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,a=o.length;s<a;++s)r[s]=o[s],n[o.charCodeAt(s)]=s;function l(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var n=r===t?0:4-r%4;return[r,n]}function c(e){var t=l(e),r=t[0],n=t[1];return(r+n)*3/4-n}function d(e,t,r){return(t+r)*3/4-r}function u(e){var t,r,o=l(e),s=o[0],a=o[1],c=new i(d(e,s,a)),u=0,h=a>0?s-4:s;for(r=0;r<h;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===a&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,c[u++]=255&t),1===a&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c}function h(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function p(e,t,r){for(var n=[],i=t;i<r;i+=3)n.push(h((e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2])));return n.join("")}function f(e){for(var t,n=e.length,i=n%3,o=[],s=16383,a=0,l=n-i;a<l;a+=s)o.push(p(e,a,a+s>l?l:a+s));return 1===i?o.push(r[(t=e[n-1])>>2]+r[t<<4&63]+"=="):2===i&&o.push(r[(t=(e[n-2]<<8)+e[n-1])>>10]+r[t>>4&63]+r[t<<2&63]+"="),o.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},72:function(e,t,r){/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var n=r(675),i=r(783),o="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=b,t.INSPECT_MAX_BYTES=50;var s=2147483647;function a(){try{var e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}function l(e){if(e>s)throw RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return Object.setPrototypeOf(t,c.prototype),t}function c(e,t,r){if("number"==typeof e){if("string"==typeof t)throw TypeError('The "string" argument must be of type string. Received type number');return p(e)}return d(e,t,r)}function d(e,t,r){if("string"==typeof e)return f(e,t);if(ArrayBuffer.isView(e))return g(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(X(e,ArrayBuffer)||e&&X(e.buffer,ArrayBuffer)||"undefined"!=typeof SharedArrayBuffer&&(X(e,SharedArrayBuffer)||e&&X(e.buffer,SharedArrayBuffer)))return m(e,t,r);if("number"==typeof e)throw TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return c.from(n,t,r);var i=v(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return c.from(e[Symbol.toPrimitive]("string"),t,r);throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function u(e){if("number"!=typeof e)throw TypeError('"size" argument must be of type number');if(e<0)throw RangeError('The value "'+e+'" is invalid for option "size"')}function h(e,t,r){return(u(e),e<=0)?l(e):void 0!==t?"string"==typeof r?l(e).fill(t,r):l(e).fill(t):l(e)}function p(e){return u(e),l(e<0?0:0|y(e))}function f(e,t){if(("string"!=typeof t||""===t)&&(t="utf8"),!c.isEncoding(t))throw TypeError("Unknown encoding: "+t);var r=0|S(e,t),n=l(r),i=n.write(e,t);return i!==r&&(n=n.slice(0,i)),n}function g(e){for(var t=e.length<0?0:0|y(e.length),r=l(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function m(e,t,r){var n;if(t<0||e.byteLength<t)throw RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw RangeError('"length" is outside of buffer bounds');return Object.setPrototypeOf(n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),c.prototype),n}function v(e){if(c.isBuffer(e)){var t=0|y(e.length),r=l(t);return 0===r.length||e.copy(r,0,0,t),r}return void 0!==e.length?"number"!=typeof e.length||$(e.length)?l(0):g(e):"Buffer"===e.type&&Array.isArray(e.data)?g(e.data):void 0}function y(e){if(e>=s)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function b(e){return+e!=e&&(e=0),c.alloc(+e)}function S(e,t){if(c.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||X(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return H(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return Y(e).length;default:if(i)return n?-1:H(e).length;t=(""+t).toLowerCase(),i=!0}}function E(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length||((void 0===r||r>this.length)&&(r=this.length),r<=0||(r>>>=0)<=(t>>>=0)))return"";for(e||(e="utf8");;)switch(e){case"hex":return L(this,t,r);case"utf8":case"utf-8":return A(this,t,r);case"ascii":return j(this,t,r);case"latin1":case"binary":return U(this,t,r);case"base64":return P(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,r);default:if(n)throw TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function _(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function w(e,t,r,n,i){if(0===e.length)return -1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),$(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return -1;r=e.length-1}else if(r<0){if(!i)return -1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:T(e,t,r,n,i);if("number"==typeof t)return(t&=255,"function"==typeof Uint8Array.prototype.indexOf)?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):T(e,[t],r,n,i);throw TypeError("val must be string, number or Buffer")}function T(e,t,r,n,i){var o,s=1,a=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return -1;s=2,a/=2,l/=2,r/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var d=-1;for(o=r;o<a;o++)if(c(e,o)===c(t,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===l)return d*s}else -1!==d&&(o-=o-d),d=-1}else for(r+l>a&&(r=a-l),o=r;o>=0;o--){for(var u=!0,h=0;h<l;h++)if(c(e,o+h)!==c(t,h)){u=!1;break}if(u)return o}return -1}function I(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=t.length;n>o/2&&(n=o/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if($(a))break;e[r+s]=a}return s}function O(e,t,r,n){return Q(H(t,e.length-r),e,r,n)}function R(e,t,r,n){return Q(z(t),e,r,n)}function C(e,t,r,n){return R(e,t,r,n)}function k(e,t,r,n){return Q(Y(t),e,r,n)}function M(e,t,r,n){return Q(J(t,e.length-r),e,r,n)}function P(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function A(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var o,s,a,l,c=e[i],d=null,u=c>239?4:c>223?3:c>191?2:1;if(i+u<=r)switch(u){case 1:c<128&&(d=c);break;case 2:(192&(o=e[i+1]))==128&&(l=(31&c)<<6|63&o)>127&&(d=l);break;case 3:o=e[i+1],s=e[i+2],(192&o)==128&&(192&s)==128&&(l=(15&c)<<12|(63&o)<<6|63&s)>2047&&(l<55296||l>57343)&&(d=l);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],(192&o)==128&&(192&s)==128&&(192&a)==128&&(l=(15&c)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&l<1114112&&(d=l)}null===d?(d=65533,u=1):d>65535&&(d-=65536,n.push(d>>>10&1023|55296),d=56320|1023&d),n.push(d),i+=u}return x(n)}t.kMaxLength=s,c.TYPED_ARRAY_SUPPORT=a(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(e,t,r){return d(e,t,r)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array),c.alloc=function(e,t,r){return h(e,t,r)},c.allocUnsafe=function(e){return p(e)},c.allocUnsafeSlow=function(e){return p(e)},c.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==c.prototype},c.compare=function(e,t){if(X(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),X(t,Uint8Array)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(e)||!c.isBuffer(t))throw TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);i<o;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!Array.isArray(e))throw TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);if(void 0===t)for(r=0,t=0;r<e.length;++r)t+=e[r].length;var r,n=c.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var o=e[r];if(X(o,Uint8Array)&&(o=c.from(o)),!c.isBuffer(o))throw TypeError('"list" argument must be an Array of Buffers');o.copy(n,i),i+=o.length}return n},c.byteLength=S,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)_(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},c.prototype.toString=function(){var e=this.length;return 0===e?"":0==arguments.length?A(this,0,e):E.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},o&&(c.prototype[o]=c.prototype.inspect),c.prototype.compare=function(e,t,r,n,i){if(X(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return -1;if(t>=r)return 1;if(t>>>=0,r>>>=0,n>>>=0,i>>>=0,this===e)return 0;for(var o=i-n,s=r-t,a=Math.min(o,s),l=this.slice(n,i),d=e.slice(t,r),u=0;u<a;++u)if(l[u]!==d[u]){o=l[u],s=d[u];break}return o<s?-1:s<o?1:0},c.prototype.includes=function(e,t,r){return -1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return w(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return w(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else if(isFinite(t))t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0);else throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return I(this,e,t,r);case"utf8":case"utf-8":return O(this,e,t,r);case"ascii":return R(this,e,t,r);case"latin1":case"binary":return C(this,e,t,r);case"base64":return k(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,e,t,r);default:if(o)throw TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var D=4096;function x(e){var t=e.length;if(t<=D)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=D));return r}function j(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function U(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function L(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=t;o<r;++o)i+=Z[e[o]];return i}function N(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function B(e,t,r){if(e%1!=0||e<0)throw RangeError("offset is not uint");if(e+t>r)throw RangeError("Trying to access beyond buffer length")}function F(e,t,r,n,i,o){if(!c.isBuffer(e))throw TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw RangeError('"value" argument is out of bounds');if(r+n>e.length)throw RangeError("Index out of range")}function K(e,t,r,n,i,o){if(r+n>e.length||r<0)throw RangeError("Index out of range")}function q(e,t,r,n,o){return t=+t,r>>>=0,o||K(e,t,r,4,34028234663852886e22,-34028234663852886e22),i.write(e,t,r,n,23,4),r+4}function V(e,t,r,n,o){return t=+t,r>>>=0,o||K(e,t,r,8,17976931348623157e292,-17976931348623157e292),i.write(e,t,r,n,52,8),r+8}c.prototype.slice=function(e,t){var r=this.length;e=~~e,t=void 0===t?r:~~t,e<0?(e+=r)<0&&(e=0):e>r&&(e=r),t<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return Object.setPrototypeOf(n,c.prototype),n},c.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||B(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},c.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||B(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},c.prototype.readUInt8=function(e,t){return e>>>=0,t||B(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return e>>>=0,t||B(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return e>>>=0,t||B(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return e>>>=0,t||B(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return e>>>=0,t||B(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||B(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||B(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return(e>>>=0,t||B(e,1,this.length),128&this[e])?-((255-this[e]+1)*1):this[e]},c.prototype.readInt16LE=function(e,t){e>>>=0,t||B(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){e>>>=0,t||B(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return e>>>=0,t||B(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return e>>>=0,t||B(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return e>>>=0,t||B(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return e>>>=0,t||B(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return e>>>=0,t||B(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return e>>>=0,t||B(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){var i=Math.pow(2,8*r)-1;F(this,e,t,r,i,0)}var o=1,s=0;for(this[t]=255&e;++s<r&&(o*=256);)this[t+s]=e/o&255;return t+r},c.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){var i=Math.pow(2,8*r)-1;F(this,e,t,r,i,0)}var o=r-1,s=1;for(this[t+o]=255&e;--o>=0&&(s*=256);)this[t+o]=e/s&255;return t+r},c.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,1,255,0),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);F(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);F(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||F(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeFloatLE=function(e,t,r){return q(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return q(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return V(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return V(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(!c.isBuffer(e))throw TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r||0===e.length||0===this.length)return 0;if(t<0)throw RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw RangeError("Index out of range");if(n<0)throw RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var o=i-1;o>=0;--o)e[o+t]=this[o+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return i},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw TypeError("Unknown encoding: "+n);if(1===e.length){var i,o=e.charCodeAt(0);("utf8"===n&&o<128||"latin1"===n)&&(e=o)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw RangeError("Out of range index");if(r<=t)return this;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{var s=c.isBuffer(e)?e:c.from(e,n),a=s.length;if(0===a)throw TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=s[i%a]}return this};var W=/[^+/0-9A-Za-z-_]/g;function G(e){if((e=(e=e.split("=")[0]).trim().replace(W,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function H(e,t){t=t||1/0;for(var r,n=e.length,i=null,o=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319||s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=(i-55296<<10|r-56320)+65536}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else if(r<1114112){if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}else throw Error("Invalid code point")}return o}function z(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}function J(e,t){for(var r,n,i=[],o=0;o<e.length&&!((t-=2)<0);++o)n=(r=e.charCodeAt(o))>>8,i.push(r%256),i.push(n);return i}function Y(e){return n.toByteArray(G(e))}function Q(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length)&&!(i>=e.length);++i)t[i+r]=e[i];return i}function X(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function $(e){return e!=e}var Z=function(){for(var e="0123456789abcdef",t=Array(256),r=0;r<16;++r)for(var n=16*r,i=0;i<16;++i)t[n+i]=e[r]+e[i];return t}()},783:function(e,t){/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */t.read=function(e,t,r,n,i){var o,s,a=8*i-n-1,l=(1<<a)-1,c=l>>1,d=-7,u=r?i-1:0,h=r?-1:1,p=e[t+u];for(u+=h,o=p&(1<<-d)-1,p>>=-d,d+=a;d>0;o=256*o+e[t+u],u+=h,d-=8);for(s=o&(1<<-d)-1,o>>=-d,d+=n;d>0;s=256*s+e[t+u],u+=h,d-=8);if(0===o)o=1-c;else{if(o===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),o-=c}return(p?-1:1)*s*Math.pow(2,o-n)},t.write=function(e,t,r,n,i,o){var s,a,l,c=8*o-i-1,d=(1<<c)-1,u=d>>1,h=23===i?5960464477539062e-23:0,p=n?0:o-1,f=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(isNaN(t=Math.abs(t))||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),s+u>=1?t+=h/l:t+=h*Math.pow(2,1-u),t*l>=2&&(s++,l/=2),s+u>=d?(a=0,s=d):s+u>=1?(a=(t*l-1)*Math.pow(2,i),s+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,i),s=0));i>=8;e[r+p]=255&a,p+=f,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[r+p]=255&s,p+=f,s/=256,c-=8);e[r+p-f]|=128*g}}},n={};function i(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}},s=!0;try{r[e](o,o.exports,i),s=!1}finally{s&&delete n[e]}return o.exports}i.ab=t+"/";var o=i(72);e.exports=o}()},27448:function(e){"use strict";var t="/";!function(){var r={229:function(e){var t,r,n,i=e.exports={};function o(){throw Error("setTimeout has not been defined")}function s(){throw Error("clearTimeout has not been defined")}function a(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(r){try{return t.call(null,e,0)}catch(r){return t.call(this,e,0)}}}function l(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{return r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var c=[],d=!1,u=-1;function h(){d&&n&&(d=!1,n.length?c=n.concat(c):u=-1,c.length&&p())}function p(){if(!d){var e=a(h);d=!0;for(var t=c.length;t;){for(n=c,c=[];++u<t;)n&&n[u].run();u=-1,t=c.length}n=null,d=!1,l(e)}}function f(e,t){this.fun=e,this.array=t}function g(){}i.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new f(e,t)),1!==c.length||d||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=g,i.addListener=g,i.once=g,i.off=g,i.removeListener=g,i.removeAllListeners=g,i.emit=g,i.prependListener=g,i.prependOnceListener=g,i.listeners=function(e){return[]},i.binding=function(e){throw Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw Error("process.chdir is not supported")},i.umask=function(){return 0}}},n={};function i(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}},s=!0;try{r[e](o,o.exports,i),s=!1}finally{s&&delete n[e]}return o.exports}i.ab=t+"/";var o=i(229);e.exports=o}()},56428:function(e,t,r){"use strict";var n="/",i=r(55426);!function(){var t={782:function(e){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}},646:function(e){let t={};function r(e,r,n){function i(e,t,n){return"string"==typeof r?r:r(e,t,n)}n||(n=Error);class o extends n{constructor(e,t,r){super(i(e,t,r))}}o.prototype.name=n.name,o.prototype.code=e,t[e]=o}function n(e,t){if(!Array.isArray(e))return"of ".concat(t," ").concat(String(e));{let r=e.length;return(e=e.map(e=>String(e)),r>2)?"one of ".concat(t," ").concat(e.slice(0,r-1).join(", "),", or ")+e[r-1]:2===r?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}}function i(e,t,r){return e.substr(!r||r<0?0:+r,t.length)===t}function o(e,t,r){return(void 0===r||r>e.length)&&(r=e.length),e.substring(r-t.length,r)===t}function s(e,t,r){return"number"!=typeof r&&(r=0),!(r+t.length>e.length)&&-1!==e.indexOf(t,r)}r("ERR_INVALID_OPT_VALUE",function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'},TypeError),r("ERR_INVALID_ARG_TYPE",function(e,t,r){let a,l;if("string"==typeof t&&i(t,"not ")?(a="must not be",t=t.replace(/^not /,"")):a="must be",o(e," argument"))l="The ".concat(e," ").concat(a," ").concat(n(t,"type"));else{let r=s(e,".")?"property":"argument";l='The "'.concat(e,'" ').concat(r," ").concat(a," ").concat(n(t,"type"))}return l+". Received type ".concat(typeof r)},TypeError),r("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),r("ERR_METHOD_NOT_IMPLEMENTED",function(e){return"The "+e+" method is not implemented"}),r("ERR_STREAM_PREMATURE_CLOSE","Premature close"),r("ERR_STREAM_DESTROYED",function(e){return"Cannot call "+e+" after a stream was destroyed"}),r("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),r("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),r("ERR_STREAM_WRITE_AFTER_END","write after end"),r("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),r("ERR_UNKNOWN_ENCODING",function(e){return"Unknown encoding: "+e},TypeError),r("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),e.exports.q=t},403:function(e,t,r){var n=Object.keys||function(e){var t=[];for(var r in e)t.push(r);return t};e.exports=d;var o=r(709),s=r(337);r(782)(d,o);for(var a=n(s.prototype),l=0;l<a.length;l++){var c=a[l];d.prototype[c]||(d.prototype[c]=s.prototype[c])}function d(e){if(!(this instanceof d))return new d(e);o.call(this,e),s.call(this,e),this.allowHalfOpen=!0,e&&(!1===e.readable&&(this.readable=!1),!1===e.writable&&(this.writable=!1),!1===e.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",u)))}function u(){this._writableState.ended||i.nextTick(h,this)}function h(e){e.end()}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}})},889:function(e,t,r){e.exports=i;var n=r(170);function i(e){if(!(this instanceof i))return new i(e);n.call(this,e)}r(782)(i,n),i.prototype._transform=function(e,t,r){r(null,e)}},709:function(e,t,n){e.exports=k,k.ReadableState=C,n(361).EventEmitter;var o,s,a,l,c,d=function(e,t){return e.listeners(t).length},u=n(678),h=n(300).Buffer,p=r.g.Uint8Array||function(){};function f(e){return h.from(e)}function g(e){return h.isBuffer(e)||e instanceof p}var m=n(837);s=m&&m.debuglog?m.debuglog("stream"):function(){};var v=n(379),y=n(25),b=n(776).getHighWaterMark,S=n(646).q,E=S.ERR_INVALID_ARG_TYPE,_=S.ERR_STREAM_PUSH_AFTER_EOF,w=S.ERR_METHOD_NOT_IMPLEMENTED,T=S.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;n(782)(k,u);var I=y.errorOrDestroy,O=["error","close","destroy","pause","resume"];function R(e,t,r){if("function"==typeof e.prependListener)return e.prependListener(t,r);e._events&&e._events[t]?Array.isArray(e._events[t])?e._events[t].unshift(r):e._events[t]=[r,e._events[t]]:e.on(t,r)}function C(e,t,r){o=o||n(403),e=e||{},"boolean"!=typeof r&&(r=t instanceof o),this.objectMode=!!e.objectMode,r&&(this.objectMode=this.objectMode||!!e.readableObjectMode),this.highWaterMark=b(this,e,"readableHighWaterMark",r),this.buffer=new v,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(a||(a=n(704).s),this.decoder=new a(e.encoding),this.encoding=e.encoding)}function k(e){if(o=o||n(403),!(this instanceof k))return new k(e);var t=this instanceof o;this._readableState=new C(e,this,t),this.readable=!0,e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy)),u.call(this)}function M(e,t,r,n,i){s("readableAddChunk",t);var o,a=e._readableState;if(null===t)a.reading=!1,U(e,a);else if(i||(o=A(a,t)),o)I(e,o);else if(a.objectMode||t&&t.length>0){if("string"==typeof t||a.objectMode||Object.getPrototypeOf(t)===h.prototype||(t=f(t)),n)a.endEmitted?I(e,new T):P(e,a,t,!0);else if(a.ended)I(e,new _);else{if(a.destroyed)return!1;a.reading=!1,a.decoder&&!r?(t=a.decoder.write(t),a.objectMode||0!==t.length?P(e,a,t,!1):B(e,a)):P(e,a,t,!1)}}else n||(a.reading=!1,B(e,a));return!a.ended&&(a.length<a.highWaterMark||0===a.length)}function P(e,t,r,n){t.flowing&&0===t.length&&!t.sync?(t.awaitDrain=0,e.emit("data",r)):(t.length+=t.objectMode?1:r.length,n?t.buffer.unshift(r):t.buffer.push(r),t.needReadable&&L(e)),B(e,t)}function A(e,t){var r;return g(t)||"string"==typeof t||void 0===t||e.objectMode||(r=new E("chunk",["string","Buffer","Uint8Array"],t)),r}Object.defineProperty(k.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),k.prototype.destroy=y.destroy,k.prototype._undestroy=y.undestroy,k.prototype._destroy=function(e,t){t(e)},k.prototype.push=function(e,t){var r,n=this._readableState;return n.objectMode?r=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=h.from(e,t),t=""),r=!0),M(this,e,t,!1,r)},k.prototype.unshift=function(e){return M(this,e,null,!0,!1)},k.prototype.isPaused=function(){return!1===this._readableState.flowing},k.prototype.setEncoding=function(e){a||(a=n(704).s);var t=new a(e);this._readableState.decoder=t,this._readableState.encoding=this._readableState.decoder.encoding;for(var r=this._readableState.buffer.head,i="";null!==r;)i+=t.write(r.data),r=r.next;return this._readableState.buffer.clear(),""!==i&&this._readableState.buffer.push(i),this._readableState.length=i.length,this};var D=1073741824;function x(e){return e>=D?e=D:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}function j(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=x(e)),e<=t.length)?e:t.ended?t.length:(t.needReadable=!0,0)}function U(e,t){if(s("onEofChunk"),!t.ended){if(t.decoder){var r=t.decoder.end();r&&r.length&&(t.buffer.push(r),t.length+=t.objectMode?1:r.length)}t.ended=!0,t.sync?L(e):(t.needReadable=!1,t.emittedReadable||(t.emittedReadable=!0,N(e)))}}function L(e){var t=e._readableState;s("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(s("emitReadable",t.flowing),t.emittedReadable=!0,i.nextTick(N,e))}function N(e){var t=e._readableState;s("emitReadable_",t.destroyed,t.length,t.ended),!t.destroyed&&(t.length||t.ended)&&(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,H(e)}function B(e,t){t.readingMore||(t.readingMore=!0,i.nextTick(F,e,t))}function F(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){var r=t.length;if(s("maybeReadMore read 0"),e.read(0),r===t.length)break}t.readingMore=!1}function K(e){return function(){var t=e._readableState;s("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&d(e,"data")&&(t.flowing=!0,H(e))}}function q(e){var t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!t.paused?t.flowing=!0:e.listenerCount("data")>0&&e.resume()}function V(e){s("readable nexttick read 0"),e.read(0)}function W(e,t){t.resumeScheduled||(t.resumeScheduled=!0,i.nextTick(G,e,t))}function G(e,t){s("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),H(e),t.flowing&&!t.reading&&e.read(0)}function H(e){var t=e._readableState;for(s("flow",t.flowing);t.flowing&&null!==e.read(););}function z(e,t){var r;return 0===t.length?null:(t.objectMode?r=t.buffer.shift():!e||e>=t.length?(r=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):r=t.buffer.consume(e,t.decoder),r)}function J(e){var t=e._readableState;s("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,i.nextTick(Y,t,e))}function Y(e,t){if(s("endReadableNT",e.endEmitted,e.length),!e.endEmitted&&0===e.length&&(e.endEmitted=!0,t.readable=!1,t.emit("end"),e.autoDestroy)){var r=t._writableState;(!r||r.autoDestroy&&r.finished)&&t.destroy()}}function Q(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return -1}k.prototype.read=function(e){s("read",e),e=parseInt(e,10);var t,r=this._readableState,n=e;if(0!==e&&(r.emittedReadable=!1),0===e&&r.needReadable&&((0!==r.highWaterMark?r.length>=r.highWaterMark:r.length>0)||r.ended))return s("read: emitReadable",r.length,r.ended),0===r.length&&r.ended?J(this):L(this),null;if(0===(e=j(e,r))&&r.ended)return 0===r.length&&J(this),null;var i=r.needReadable;return s("need readable",i),(0===r.length||r.length-e<r.highWaterMark)&&s("length less than watermark",i=!0),r.ended||r.reading?s("reading or ended",i=!1):i&&(s("do read"),r.reading=!0,r.sync=!0,0===r.length&&(r.needReadable=!0),this._read(r.highWaterMark),r.sync=!1,r.reading||(e=j(n,r))),null===(t=e>0?z(e,r):null)?(r.needReadable=r.length<=r.highWaterMark,e=0):(r.length-=e,r.awaitDrain=0),0===r.length&&(r.ended||(r.needReadable=!0),n!==e&&r.ended&&J(this)),null!==t&&this.emit("data",t),t},k.prototype._read=function(e){I(this,new w("_read()"))},k.prototype.pipe=function(e,t){var r=this,n=this._readableState;switch(n.pipesCount){case 0:n.pipes=e;break;case 1:n.pipes=[n.pipes,e];break;default:n.pipes.push(e)}n.pipesCount+=1,s("pipe count=%d opts=%j",n.pipesCount,t);var o=t&&!1===t.end||e===i.stdout||e===i.stderr?v:l;function a(e,t){s("onunpipe"),e===r&&t&&!1===t.hasUnpiped&&(t.hasUnpiped=!0,h())}function l(){s("onend"),e.end()}n.endEmitted?i.nextTick(o):r.once("end",o),e.on("unpipe",a);var c=K(r);e.on("drain",c);var u=!1;function h(){s("cleanup"),e.removeListener("close",g),e.removeListener("finish",m),e.removeListener("drain",c),e.removeListener("error",f),e.removeListener("unpipe",a),r.removeListener("end",l),r.removeListener("end",v),r.removeListener("data",p),u=!0,n.awaitDrain&&(!e._writableState||e._writableState.needDrain)&&c()}function p(t){s("ondata");var i=e.write(t);s("dest.write",i),!1===i&&((1===n.pipesCount&&n.pipes===e||n.pipesCount>1&&-1!==Q(n.pipes,e))&&!u&&(s("false write response, pause",n.awaitDrain),n.awaitDrain++),r.pause())}function f(t){s("onerror",t),v(),e.removeListener("error",f),0===d(e,"error")&&I(e,t)}function g(){e.removeListener("finish",m),v()}function m(){s("onfinish"),e.removeListener("close",g),v()}function v(){s("unpipe"),r.unpipe(e)}return r.on("data",p),R(e,"error",f),e.once("close",g),e.once("finish",m),e.emit("pipe",r),n.flowing||(s("pipe resume"),r.resume()),e},k.prototype.unpipe=function(e){var t=this._readableState,r={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,r)),this;if(!e){var n=t.pipes,i=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var o=0;o<i;o++)n[o].emit("unpipe",this,{hasUnpiped:!1});return this}var s=Q(t.pipes,e);return -1===s||(t.pipes.splice(s,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,r)),this},k.prototype.on=function(e,t){var r=u.prototype.on.call(this,e,t),n=this._readableState;return"data"===e?(n.readableListening=this.listenerCount("readable")>0,!1!==n.flowing&&this.resume()):"readable"!==e||n.endEmitted||n.readableListening||(n.readableListening=n.needReadable=!0,n.flowing=!1,n.emittedReadable=!1,s("on readable",n.length,n.reading),n.length?L(this):n.reading||i.nextTick(V,this)),r},k.prototype.addListener=k.prototype.on,k.prototype.removeListener=function(e,t){var r=u.prototype.removeListener.call(this,e,t);return"readable"===e&&i.nextTick(q,this),r},k.prototype.removeAllListeners=function(e){var t=u.prototype.removeAllListeners.apply(this,arguments);return("readable"===e||void 0===e)&&i.nextTick(q,this),t},k.prototype.resume=function(){var e=this._readableState;return e.flowing||(s("resume"),e.flowing=!e.readableListening,W(this,e)),e.paused=!1,this},k.prototype.pause=function(){return s("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(s("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},k.prototype.wrap=function(e){var t=this,r=this._readableState,n=!1;for(var i in e.on("end",function(){if(s("wrapped end"),r.decoder&&!r.ended){var e=r.decoder.end();e&&e.length&&t.push(e)}t.push(null)}),e.on("data",function(i){s("wrapped data"),r.decoder&&(i=r.decoder.write(i)),(!r.objectMode||null!=i)&&(r.objectMode||i&&i.length)&&(t.push(i)||(n=!0,e.pause()))}),e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));for(var o=0;o<O.length;o++)e.on(O[o],this.emit.bind(this,O[o]));return this._read=function(t){s("wrapped _read",t),n&&(n=!1,e.resume())},this},"function"==typeof Symbol&&(k.prototype[Symbol.asyncIterator]=function(){return void 0===l&&(l=n(871)),l(this)}),Object.defineProperty(k.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(k.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(k.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}}),k._fromList=z,Object.defineProperty(k.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(k.from=function(e,t){return void 0===c&&(c=n(727)),c(k,e,t)})},170:function(e,t,r){e.exports=d;var n=r(646).q,i=n.ERR_METHOD_NOT_IMPLEMENTED,o=n.ERR_MULTIPLE_CALLBACK,s=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,a=n.ERR_TRANSFORM_WITH_LENGTH_0,l=r(403);function c(e,t){var r=this._transformState;r.transforming=!1;var n=r.writecb;if(null===n)return this.emit("error",new o);r.writechunk=null,r.writecb=null,null!=t&&this.push(t),n(e);var i=this._readableState;i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}function d(e){if(!(this instanceof d))return new d(e);l.call(this,e),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function u(){var e=this;"function"!=typeof this._flush||this._readableState.destroyed?h(this,null,null):this._flush(function(t,r){h(e,t,r)})}function h(e,t,r){if(t)return e.emit("error",t);if(null!=r&&e.push(r),e._writableState.length)throw new a;if(e._transformState.transforming)throw new s;return e.push(null)}r(782)(d,l),d.prototype.push=function(e,t){return this._transformState.needTransform=!1,l.prototype.push.call(this,e,t)},d.prototype._transform=function(e,t,r){r(new i("_transform()"))},d.prototype._write=function(e,t,r){var n=this._transformState;if(n.writecb=r,n.writechunk=e,n.writeencoding=t,!n.transforming){var i=this._readableState;(n.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},d.prototype._read=function(e){var t=this._transformState;null===t.writechunk||t.transforming?t.needTransform=!0:(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform))},d.prototype._destroy=function(e,t){l.prototype._destroy.call(this,e,function(e){t(e)})}},337:function(e,t,n){function o(e){var t=this;this.next=null,this.entry=null,this.finish=function(){G(t,e)}}e.exports=C,C.WritableState=R;var s,a,l={deprecate:n(769)},c=n(678),d=n(300).Buffer,u=r.g.Uint8Array||function(){};function h(e){return d.from(e)}function p(e){return d.isBuffer(e)||e instanceof u}var f=n(25),g=n(776).getHighWaterMark,m=n(646).q,v=m.ERR_INVALID_ARG_TYPE,y=m.ERR_METHOD_NOT_IMPLEMENTED,b=m.ERR_MULTIPLE_CALLBACK,S=m.ERR_STREAM_CANNOT_PIPE,E=m.ERR_STREAM_DESTROYED,_=m.ERR_STREAM_NULL_VALUES,w=m.ERR_STREAM_WRITE_AFTER_END,T=m.ERR_UNKNOWN_ENCODING,I=f.errorOrDestroy;function O(){}function R(e,t,r){s=s||n(403),e=e||{},"boolean"!=typeof r&&(r=t instanceof s),this.objectMode=!!e.objectMode,r&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=g(this,e,"writableHighWaterMark",r),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var i=!1===e.decodeStrings;this.decodeStrings=!i,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){U(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new o(this)}function C(e){var t=this instanceof(s=s||n(403));if(!t&&!a.call(C,this))return new C(e);this._writableState=new R(e,this,t),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),c.call(this)}function k(e,t){var r=new w;I(e,r),i.nextTick(t,r)}function M(e,t,r,n){var o;return null===r?o=new _:"string"==typeof r||t.objectMode||(o=new v("chunk",["string","Buffer"],r)),!o||(I(e,o),i.nextTick(n,o),!1)}function P(e,t,r){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=d.from(t,r)),t}function A(e,t,r,n,i,o){if(!r){var s=P(t,n,i);n!==s&&(r=!0,i="buffer",n=s)}var a=t.objectMode?1:n.length;t.length+=a;var l=t.length<t.highWaterMark;if(l||(t.needDrain=!0),t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:i,isBuf:r,callback:o,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else D(e,t,!1,a,n,i,o);return l}function D(e,t,r,n,i,o,s){t.writelen=n,t.writecb=s,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new E("write")):r?e._writev(i,t.onwrite):e._write(i,o,t.onwrite),t.sync=!1}function x(e,t,r,n,o){--t.pendingcb,r?(i.nextTick(o,n),i.nextTick(V,e,t),e._writableState.errorEmitted=!0,I(e,n)):(o(n),e._writableState.errorEmitted=!0,I(e,n),V(e,t))}function j(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function U(e,t){var r=e._writableState,n=r.sync,o=r.writecb;if("function"!=typeof o)throw new b;if(j(r),t)x(e,r,n,t,o);else{var s=F(r)||e.destroyed;s||r.corked||r.bufferProcessing||!r.bufferedRequest||B(e,r),n?i.nextTick(L,e,r,s,o):L(e,r,s,o)}}function L(e,t,r,n){r||N(e,t),t.pendingcb--,n(),V(e,t)}function N(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function B(e,t){t.bufferProcessing=!0;var r=t.bufferedRequest;if(e._writev&&r&&r.next){var n=Array(t.bufferedRequestCount),i=t.corkedRequestsFree;i.entry=r;for(var s=0,a=!0;r;)n[s]=r,r.isBuf||(a=!1),r=r.next,s+=1;n.allBuffers=a,D(e,t,!0,t.length,n,"",i.finish),t.pendingcb++,t.lastBufferedRequest=null,i.next?(t.corkedRequestsFree=i.next,i.next=null):t.corkedRequestsFree=new o(t),t.bufferedRequestCount=0}else{for(;r;){var l=r.chunk,c=r.encoding,d=r.callback,u=t.objectMode?1:l.length;if(D(e,t,!1,u,l,c,d),r=r.next,t.bufferedRequestCount--,t.writing)break}null===r&&(t.lastBufferedRequest=null)}t.bufferedRequest=r,t.bufferProcessing=!1}function F(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function K(e,t){e._final(function(r){t.pendingcb--,r&&I(e,r),t.prefinished=!0,e.emit("prefinish"),V(e,t)})}function q(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.pendingcb++,t.finalCalled=!0,i.nextTick(K,e,t)))}function V(e,t){var r=F(t);if(r&&(q(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"),t.autoDestroy))){var n=e._readableState;(!n||n.autoDestroy&&n.endEmitted)&&e.destroy()}return r}function W(e,t,r){t.ending=!0,V(e,t),r&&(t.finished?i.nextTick(r):e.once("finish",r)),t.ended=!0,e.writable=!1}function G(e,t,r){var n=e.entry;for(e.entry=null;n;){var i=n.callback;t.pendingcb--,i(r),n=n.next}t.corkedRequestsFree.next=e}n(782)(C,c),R.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(R.prototype,"buffer",{get:l.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(a=Function.prototype[Symbol.hasInstance],Object.defineProperty(C,Symbol.hasInstance,{value:function(e){return!!a.call(this,e)||this===C&&e&&e._writableState instanceof R}})):a=function(e){return e instanceof this},C.prototype.pipe=function(){I(this,new S)},C.prototype.write=function(e,t,r){var n=this._writableState,i=!1,o=!n.objectMode&&p(e);return o&&!d.isBuffer(e)&&(e=h(e)),"function"==typeof t&&(r=t,t=null),o?t="buffer":t||(t=n.defaultEncoding),"function"!=typeof r&&(r=O),n.ending?k(this,r):(o||M(this,n,e,r))&&(n.pendingcb++,i=A(this,n,o,e,t,r)),i},C.prototype.cork=function(){this._writableState.corked++},C.prototype.uncork=function(){var e=this._writableState;!e.corked||(e.corked--,e.writing||e.corked||e.bufferProcessing||!e.bufferedRequest||B(this,e))},C.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new T(e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(C.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(C.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),C.prototype._write=function(e,t,r){r(new y("_write()"))},C.prototype._writev=null,C.prototype.end=function(e,t,r){var n=this._writableState;return"function"==typeof e?(r=e,e=null,t=null):"function"==typeof t&&(r=t,t=null),null!=e&&this.write(e,t),n.corked&&(n.corked=1,this.uncork()),n.ending||W(this,n,r),this},Object.defineProperty(C.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(C.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),C.prototype.destroy=f.destroy,C.prototype._undestroy=f.undestroy,C.prototype._destroy=function(e,t){t(e)}},871:function(e,t,r){function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var o,s=r(698),a=Symbol("lastResolve"),l=Symbol("lastReject"),c=Symbol("error"),d=Symbol("ended"),u=Symbol("lastPromise"),h=Symbol("handlePromise"),p=Symbol("stream");function f(e,t){return{value:e,done:t}}function g(e){var t=e[a];if(null!==t){var r=e[p].read();null!==r&&(e[u]=null,e[a]=null,e[l]=null,t(f(r,!1)))}}function m(e){i.nextTick(g,e)}function v(e,t){return function(r,n){e.then(function(){if(t[d]){r(f(void 0,!0));return}t[h](r,n)},n)}}var y=Object.getPrototypeOf(function(){}),b=Object.setPrototypeOf((n(o={get stream(){return this[p]},next:function(){var e,t=this,r=this[c];if(null!==r)return Promise.reject(r);if(this[d])return Promise.resolve(f(void 0,!0));if(this[p].destroyed)return new Promise(function(e,r){i.nextTick(function(){t[c]?r(t[c]):e(f(void 0,!0))})});var n=this[u];if(n)e=new Promise(v(n,this));else{var o=this[p].read();if(null!==o)return Promise.resolve(f(o,!1));e=new Promise(this[h])}return this[u]=e,e}},Symbol.asyncIterator,function(){return this}),n(o,"return",function(){var e=this;return new Promise(function(t,r){e[p].destroy(null,function(e){if(e){r(e);return}t(f(void 0,!0))})})}),o),y),S=function(e){var t,r=Object.create(b,(n(t={},p,{value:e,writable:!0}),n(t,a,{value:null,writable:!0}),n(t,l,{value:null,writable:!0}),n(t,c,{value:null,writable:!0}),n(t,d,{value:e._readableState.endEmitted,writable:!0}),n(t,h,{value:function(e,t){var n=r[p].read();n?(r[u]=null,r[a]=null,r[l]=null,e(f(n,!1))):(r[a]=e,r[l]=t)},writable:!0}),t));return r[u]=null,s(e,function(e){if(e&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code){var t=r[l];null!==t&&(r[u]=null,r[a]=null,r[l]=null,t(e)),r[c]=e;return}var n=r[a];null!==n&&(r[u]=null,r[a]=null,r[l]=null,n(f(void 0,!0))),r[d]=!0}),e.on("readable",m.bind(null,r)),r};e.exports=S},379:function(e,t,r){function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}var c=r(300).Buffer,d=r(837).inspect,u=d&&d.custom||"inspect";function h(e,t,r){c.prototype.copy.call(e,t,r)}e.exports=function(){function e(){s(this,e),this.head=null,this.tail=null,this.length=0}return l(e,[{key:"push",value:function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}},{key:"unshift",value:function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}},{key:"shift",value:function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(e){if(0===this.length)return"";for(var t=this.head,r=""+t.data;t=t.next;)r+=e+t.data;return r}},{key:"concat",value:function(e){if(0===this.length)return c.alloc(0);for(var t=c.allocUnsafe(e>>>0),r=this.head,n=0;r;)h(r.data,t,n),n+=r.data.length,r=r.next;return t}},{key:"consume",value:function(e,t){var r;return e<this.head.data.length?(r=this.head.data.slice(0,e),this.head.data=this.head.data.slice(e)):r=e===this.head.data.length?this.shift():t?this._getString(e):this._getBuffer(e),r}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(e){var t=this.head,r=1,n=t.data;for(e-=n.length;t=t.next;){var i=t.data,o=e>i.length?i.length:e;if(o===i.length?n+=i:n+=i.slice(0,e),0==(e-=o)){o===i.length?(++r,t.next?this.head=t.next:this.head=this.tail=null):(this.head=t,t.data=i.slice(o));break}++r}return this.length-=r,n}},{key:"_getBuffer",value:function(e){var t=c.allocUnsafe(e),r=this.head,n=1;for(r.data.copy(t),e-=r.data.length;r=r.next;){var i=r.data,o=e>i.length?i.length:e;if(i.copy(t,t.length-e,0,o),0==(e-=o)){o===i.length?(++n,r.next?this.head=r.next:this.head=this.tail=null):(this.head=r,r.data=i.slice(o));break}++n}return this.length-=n,t}},{key:u,value:function(e,t){return d(this,i({},t,{depth:0,customInspect:!1}))}}]),e}()},25:function(e){function t(e,t){var o=this,a=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return a||l?t?t(e):e&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,i.nextTick(s,this,e)):i.nextTick(s,this,e)):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,function(e){!t&&e?o._writableState?o._writableState.errorEmitted?i.nextTick(n,o):(o._writableState.errorEmitted=!0,i.nextTick(r,o,e)):i.nextTick(r,o,e):t?(i.nextTick(n,o),t(e)):i.nextTick(n,o)})),this}function r(e,t){s(e,t),n(e)}function n(e){(!e._writableState||e._writableState.emitClose)&&(!e._readableState||e._readableState.emitClose)&&e.emit("close")}function o(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function s(e,t){e.emit("error",t)}function a(e,t){var r=e._readableState,n=e._writableState;r&&r.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}e.exports={destroy:t,undestroy:o,errorOrDestroy:a}},698:function(e,t,r){var n=r(646).q.ERR_STREAM_PREMATURE_CLOSE;function i(e){var t=!1;return function(){if(!t){t=!0;for(var r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];e.apply(this,n)}}}function o(){}function s(e){return e.setHeader&&"function"==typeof e.abort}function a(e,t,r){if("function"==typeof t)return a(e,null,t);t||(t={}),r=i(r||o);var l=t.readable||!1!==t.readable&&e.readable,c=t.writable||!1!==t.writable&&e.writable,d=function(){e.writable||h()},u=e._writableState&&e._writableState.finished,h=function(){c=!1,u=!0,l||r.call(e)},p=e._readableState&&e._readableState.endEmitted,f=function(){l=!1,p=!0,c||r.call(e)},g=function(t){r.call(e,t)},m=function(){var t;return l&&!p?(e._readableState&&e._readableState.ended||(t=new n),r.call(e,t)):c&&!u?(e._writableState&&e._writableState.ended||(t=new n),r.call(e,t)):void 0},v=function(){e.req.on("finish",h)};return s(e)?(e.on("complete",h),e.on("abort",m),e.req?v():e.on("request",v)):c&&!e._writableState&&(e.on("end",d),e.on("close",d)),e.on("end",f),e.on("finish",h),!1!==t.error&&e.on("error",g),e.on("close",m),function(){e.removeListener("complete",h),e.removeListener("abort",m),e.removeListener("request",v),e.req&&e.req.removeListener("finish",h),e.removeListener("end",d),e.removeListener("close",d),e.removeListener("finish",h),e.removeListener("end",f),e.removeListener("error",g),e.removeListener("close",m)}}e.exports=a},727:function(e,t,r){function n(e,t,r,n,i,o,s){try{var a=e[o](s),l=a.value}catch(e){r(e);return}a.done?t(l):Promise.resolve(l).then(n,i)}function i(e){return function(){var t=this,r=arguments;return new Promise(function(i,o){var s=e.apply(t,r);function a(e){n(s,i,o,a,l,"next",e)}function l(e){n(s,i,o,a,l,"throw",e)}a(void 0)})}}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){a(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var l=r(646).q.ERR_INVALID_ARG_TYPE;function c(e,t,r){if(t&&"function"==typeof t.next)n=t;else if(t&&t[Symbol.asyncIterator])n=t[Symbol.asyncIterator]();else if(t&&t[Symbol.iterator])n=t[Symbol.iterator]();else throw new l("iterable",["Iterable"],t);var n,o=new e(s({objectMode:!0},r)),a=!1;function c(){return d.apply(this,arguments)}function d(){return(d=i(function*(){try{var e=yield n.next(),t=e.value;e.done?o.push(null):o.push((yield t))?c():a=!1}catch(e){o.destroy(e)}})).apply(this,arguments)}return o._read=function(){a||(a=!0,c())},o}e.exports=c},442:function(e,t,r){function n(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}var i,o=r(646).q,s=o.ERR_MISSING_ARGS,a=o.ERR_STREAM_DESTROYED;function l(e){if(e)throw e}function c(e){return e.setHeader&&"function"==typeof e.abort}function d(e,t,o,s){s=n(s);var l=!1;e.on("close",function(){l=!0}),void 0===i&&(i=r(698)),i(e,{readable:t,writable:o},function(e){if(e)return s(e);l=!0,s()});var d=!1;return function(t){if(!l&&!d){if(d=!0,c(e))return e.abort();if("function"==typeof e.destroy)return e.destroy();s(t||new a("pipe"))}}}function u(e){e()}function h(e,t){return e.pipe(t)}function p(e){return e.length&&"function"==typeof e[e.length-1]?e.pop():l}function f(){for(var e,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var i=p(r);if(Array.isArray(r[0])&&(r=r[0]),r.length<2)throw new s("streams");var o=r.map(function(t,n){var s=n<r.length-1;return d(t,s,n>0,function(t){e||(e=t),t&&o.forEach(u),s||(o.forEach(u),i(e))})});return r.reduce(h)}e.exports=f},776:function(e,t,r){var n=r(646).q.ERR_INVALID_OPT_VALUE;function i(e,t,r){return null!=e.highWaterMark?e.highWaterMark:t?e[r]:null}function o(e,t,r,o){var s=i(t,o,r);if(null!=s){if(!(isFinite(s)&&Math.floor(s)===s)||s<0)throw new n(o?r:"highWaterMark",s);return Math.floor(s)}return e.objectMode?16:16384}e.exports={getHighWaterMark:o}},678:function(e,t,r){e.exports=r(781)},55:function(e,t,r){var n=r(300),i=n.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=n:(o(n,t),t.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return i(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n.SlowBuffer(e)}},173:function(e,t,r){e.exports=i;var n=r(361).EventEmitter;function i(){n.call(this)}r(782)(i,n),i.Readable=r(709),i.Writable=r(337),i.Duplex=r(403),i.Transform=r(170),i.PassThrough=r(889),i.finished=r(698),i.pipeline=r(442),i.Stream=i,i.prototype.pipe=function(e,t){var r=this;function i(t){e.writable&&!1===e.write(t)&&r.pause&&r.pause()}function o(){r.readable&&r.resume&&r.resume()}r.on("data",i),e.on("drain",o),e._isStdio||t&&!1===t.end||(r.on("end",a),r.on("close",l));var s=!1;function a(){s||(s=!0,e.end())}function l(){s||(s=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(d(),0===n.listenerCount(this,"error"))throw e}function d(){r.removeListener("data",i),e.removeListener("drain",o),r.removeListener("end",a),r.removeListener("close",l),r.removeListener("error",c),e.removeListener("error",c),r.removeListener("end",d),r.removeListener("close",d),e.removeListener("close",d)}return r.on("error",c),e.on("error",c),r.on("end",d),r.on("close",d),e.on("close",d),e.emit("pipe",r),e}},704:function(e,t,r){var n=r(55).Buffer,i=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function o(e){var t;if(!e)return"utf8";for(;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function s(e){var t=o(e);if("string"!=typeof t&&(n.isEncoding===i||!i(e)))throw Error("Unknown encoding: "+e);return t||e}function a(e){var t;switch(this.encoding=s(e),this.encoding){case"utf16le":this.text=f,this.end=g,t=4;break;case"utf8":this.fillLast=u,t=4;break;case"base64":this.text=m,this.end=v,t=3;break;default:this.write=y,this.end=b;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function l(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function c(e,t,r){var n=t.length-1;if(n<r)return 0;var i=l(t[n]);return i>=0?(i>0&&(e.lastNeed=i-1),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(e.lastNeed=i-2),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(2===i?i=0:e.lastNeed=i-3),i):0}function d(e,t,r){if((192&t[0])!=128)return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if((192&t[1])!=128)return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&(192&t[2])!=128)return e.lastNeed=2,"�"}}function u(e){var t=this.lastTotal-this.lastNeed,r=d(this,e,t);return void 0!==r?r:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):void(e.copy(this.lastChar,t,0,e.length),this.lastNeed-=e.length)}function h(e,t){var r=c(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=r;var n=e.length-(r-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)}function p(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t}function f(e,t){if((e.length-t)%2==0){var r=e.toString("utf16le",t);if(r){var n=r.charCodeAt(r.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function g(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var r=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,r)}return t}function m(e,t){var r=(e.length-t)%3;return 0===r?e.toString("base64",t):(this.lastNeed=3-r,this.lastTotal=3,1===r?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-r))}function v(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function y(e){return e.toString(this.encoding)}function b(e){return e&&e.length?this.write(e):""}t.s=a,a.prototype.write=function(e){var t,r;if(0===e.length)return"";if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";r=this.lastNeed,this.lastNeed=0}else r=0;return r<e.length?t?t+this.text(e,r):this.text(e,r):t||""},a.prototype.end=p,a.prototype.text=h,a.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},769:function(e){function t(e,t){if(n("noDeprecation"))return e;var r=!1;return function(){if(!r){if(n("throwDeprecation"))throw Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),r=!0}return e.apply(this,arguments)}}function n(e){try{if(!r.g.localStorage)return!1}catch(e){return!1}var t=r.g.localStorage[e];return null!=t&&"true"===String(t).toLowerCase()}e.exports=t},300:function(e){e.exports=r(31180)},361:function(e){e.exports=r(67779)},781:function(e){e.exports=r(67779).EventEmitter},837:function(e){e.exports=r(9574)}},o={};function s(e){var r=o[e];if(void 0!==r)return r.exports;var n=o[e]={exports:{}},i=!0;try{t[e](n,n.exports,s),i=!1}finally{i&&delete o[e]}return n.exports}s.ab=n+"/";var a=s(173);e.exports=a}()},91938:function(e,t,r){"use strict";var n="/";!function(){var t={55:function(e,t,r){var n=r(300),i=n.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=n:(o(n,t),t.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return i(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n.SlowBuffer(e)}},300:function(e){e.exports=r(31180)}},i={};function o(e){var r=i[e];if(void 0!==r)return r.exports;var n=i[e]={exports:{}},s=!0;try{t[e](n,n.exports,o),s=!1}finally{s&&delete i[e]}return n.exports}o.ab=n+"/";var s={};!function(){var e=s,t=o(55).Buffer,r=t.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function n(e){var t;if(!e)return"utf8";for(;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}function i(e){var i=n(e);if("string"!=typeof i&&(t.isEncoding===r||!r(e)))throw Error("Unknown encoding: "+e);return i||e}function a(e){var r;switch(this.encoding=i(e),this.encoding){case"utf16le":this.text=f,this.end=g,r=4;break;case"utf8":this.fillLast=u,r=4;break;case"base64":this.text=m,this.end=v,r=3;break;default:this.write=y,this.end=b;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=t.allocUnsafe(r)}function l(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function c(e,t,r){var n=t.length-1;if(n<r)return 0;var i=l(t[n]);return i>=0?(i>0&&(e.lastNeed=i-1),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(e.lastNeed=i-2),i):--n<r||-2===i?0:(i=l(t[n]))>=0?(i>0&&(2===i?i=0:e.lastNeed=i-3),i):0}function d(e,t,r){if((192&t[0])!=128)return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if((192&t[1])!=128)return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&(192&t[2])!=128)return e.lastNeed=2,"�"}}function u(e){var t=this.lastTotal-this.lastNeed,r=d(this,e,t);return void 0!==r?r:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):void(e.copy(this.lastChar,t,0,e.length),this.lastNeed-=e.length)}function h(e,t){var r=c(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=r;var n=e.length-(r-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)}function p(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t}function f(e,t){if((e.length-t)%2==0){var r=e.toString("utf16le",t);if(r){var n=r.charCodeAt(r.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function g(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var r=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,r)}return t}function m(e,t){var r=(e.length-t)%3;return 0===r?e.toString("base64",t):(this.lastNeed=3-r,this.lastTotal=3,1===r?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-r))}function v(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function y(e){return e.toString(this.encoding)}function b(e){return e&&e.length?this.write(e):""}e.StringDecoder=a,a.prototype.write=function(e){var t,r;if(0===e.length)return"";if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";r=this.lastNeed,this.lastNeed=0}else r=0;return r<e.length?t?t+this.text(e,r):this.text(e,r):t||""},a.prototype.end=p,a.prototype.text=h,a.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}}(),e.exports=s}()},9574:function(e,t,r){"use strict";var n="/",i=r(31180).Buffer,o=r(55426);!function(){var t={992:function(e){e.exports=function(e,r,n){if(e.filter)return e.filter(r,n);if(null==e||"function"!=typeof r)throw TypeError();for(var i=[],o=0;o<e.length;o++)if(t.call(e,o)){var s=e[o];r.call(n,s,o,e)&&i.push(s)}return i};var t=Object.prototype.hasOwnProperty},256:function(e,t,r){var n=r(925),i=r(139),o=i(n("String.prototype.indexOf"));e.exports=function(e,t){var r=n(e,!!t);return"function"==typeof r&&o(e,".prototype.")>-1?i(r):r}},139:function(e,t,r){var n=r(174),i=r(925),o=i("%Function.prototype.apply%"),s=i("%Function.prototype.call%"),a=i("%Reflect.apply%",!0)||n.call(s,o),l=i("%Object.getOwnPropertyDescriptor%",!0),c=i("%Object.defineProperty%",!0),d=i("%Math.max%");if(c)try{c({},"a",{value:1})}catch(e){c=null}e.exports=function(e){var t=a(n,s,arguments);return l&&c&&l(t,"length").configurable&&c(t,"length",{value:1+d(0,e.length-(arguments.length-1))}),t};var u=function(){return a(n,o,arguments)};c?c(e.exports,"apply",{value:u}):e.exports.apply=u},144:function(e){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString;e.exports=function(e,n,i){if("[object Function]"!==r.call(n))throw TypeError("iterator must be a function");var o=e.length;if(o===+o)for(var s=0;s<o;s++)n.call(i,e[s],s,e);else for(var a in e)t.call(e,a)&&n.call(i,e[a],a,e)}},426:function(e){var t="Function.prototype.bind called on incompatible ",r=Array.prototype.slice,n=Object.prototype.toString,i="[object Function]";e.exports=function(e){var o,s=this;if("function"!=typeof s||n.call(s)!==i)throw TypeError(t+s);for(var a=r.call(arguments,1),l=function(){if(!(this instanceof o))return s.apply(e,a.concat(r.call(arguments)));var t=s.apply(this,a.concat(r.call(arguments)));return Object(t)===t?t:this},c=Math.max(0,s.length-a.length),d=[],u=0;u<c;u++)d.push("$"+u);if(o=Function("binder","return function ("+d.join(",")+"){ return binder.apply(this,arguments); }")(l),s.prototype){var h=function(){};h.prototype=s.prototype,o.prototype=new h,h.prototype=null}return o}},174:function(e,t,r){var n=r(426);e.exports=Function.prototype.bind||n},500:function(e,t,r){var n,i=SyntaxError,o=Function,s=TypeError,a=function(e){try{return o('"use strict"; return ('+e+").constructor;")()}catch(e){}},l=Object.getOwnPropertyDescriptor;if(l)try{l({},"")}catch(e){l=null}var c=function(){throw new s},d=l?function(){try{return arguments.callee,c}catch(e){try{return l(arguments,"callee").get}catch(e){return c}}}():c,u=r(115)(),h=Object.getPrototypeOf||function(e){return e.__proto__},p={},f="undefined"==typeof Uint8Array?n:h(Uint8Array),g={"%AggregateError%":"undefined"==typeof AggregateError?n:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer,"%ArrayIteratorPrototype%":u?h([][Symbol.iterator]()):n,"%AsyncFromSyncIteratorPrototype%":n,"%AsyncFunction%":p,"%AsyncGenerator%":p,"%AsyncGeneratorFunction%":p,"%AsyncIteratorPrototype%":p,"%Atomics%":"undefined"==typeof Atomics?n:Atomics,"%BigInt%":"undefined"==typeof BigInt?n:BigInt,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?n:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?n:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?n:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?n:FinalizationRegistry,"%Function%":o,"%GeneratorFunction%":p,"%Int8Array%":"undefined"==typeof Int8Array?n:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?n:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?n:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":u?h(h([][Symbol.iterator]())):n,"%JSON%":"object"==typeof JSON?JSON:n,"%Map%":"undefined"==typeof Map?n:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&u?h((new Map)[Symbol.iterator]()):n,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?n:Promise,"%Proxy%":"undefined"==typeof Proxy?n:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?n:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?n:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&u?h((new Set)[Symbol.iterator]()):n,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":u?h(""[Symbol.iterator]()):n,"%Symbol%":u?Symbol:n,"%SyntaxError%":i,"%ThrowTypeError%":d,"%TypedArray%":f,"%TypeError%":s,"%Uint8Array%":"undefined"==typeof Uint8Array?n:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?n:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?n:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?n:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?n:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?n:WeakSet},m=function e(t){var r;if("%AsyncFunction%"===t)r=a("async function () {}");else if("%GeneratorFunction%"===t)r=a("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=a("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&(r=h(i.prototype))}return g[t]=r,r},v={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},y=r(174),b=r(101),S=y.call(Function.call,Array.prototype.concat),E=y.call(Function.apply,Array.prototype.splice),_=y.call(Function.call,String.prototype.replace),w=y.call(Function.call,String.prototype.slice),T=y.call(Function.call,RegExp.prototype.exec),I=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,O=/\\(\\)?/g,R=function(e){var t=w(e,0,1),r=w(e,-1);if("%"===t&&"%"!==r)throw new i("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new i("invalid intrinsic syntax, expected opening `%`");var n=[];return _(e,I,function(e,t,r,i){n[n.length]=r?_(i,O,"$1"):t||e}),n},C=function(e,t){var r,n=e;if(b(v,n)&&(n="%"+(r=v[n])[0]+"%"),b(g,n)){var o=g[n];if(o===p&&(o=m(n)),void 0===o&&!t)throw new s("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:o}}throw new i("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new s("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new s('"allowMissing" argument must be a boolean');if(null===T(/^%?[^%]*%?$/g,e))throw new i("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=R(e),n=r.length>0?r[0]:"",o=C("%"+n+"%",t),a=o.name,c=o.value,d=!1,u=o.alias;u&&(n=u[0],E(r,S([0,1],u)));for(var h=1,p=!0;h<r.length;h+=1){var f=r[h],m=w(f,0,1),v=w(f,-1);if(('"'===m||"'"===m||"`"===m||'"'===v||"'"===v||"`"===v)&&m!==v)throw new i("property names with quotes must have matching quotes");if("constructor"!==f&&p||(d=!0),n+="."+f,b(g,a="%"+n+"%"))c=g[a];else if(null!=c){if(!(f in c)){if(!t)throw new s("base intrinsic for "+e+" exists, but the property is not available.");return}if(l&&h+1>=r.length){var y=l(c,f);c=(p=!!y)&&"get"in y&&!("originalValue"in y.get)?y.get:c[f]}else p=b(c,f),c=c[f];p&&!d&&(g[a]=c)}}return c}},925:function(e,t,r){var n,i=SyntaxError,o=Function,s=TypeError,a=function(e){try{return o('"use strict"; return ('+e+").constructor;")()}catch(e){}},l=Object.getOwnPropertyDescriptor;if(l)try{l({},"")}catch(e){l=null}var c=function(){throw new s},d=l?function(){try{return arguments.callee,c}catch(e){try{return l(arguments,"callee").get}catch(e){return c}}}():c,u=r(115)(),h=r(504)(),p=Object.getPrototypeOf||(h?function(e){return e.__proto__}:null),f={},g="undefined"!=typeof Uint8Array&&p?p(Uint8Array):n,m={"%AggregateError%":"undefined"==typeof AggregateError?n:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?n:ArrayBuffer,"%ArrayIteratorPrototype%":u&&p?p([][Symbol.iterator]()):n,"%AsyncFromSyncIteratorPrototype%":n,"%AsyncFunction%":f,"%AsyncGenerator%":f,"%AsyncGeneratorFunction%":f,"%AsyncIteratorPrototype%":f,"%Atomics%":"undefined"==typeof Atomics?n:Atomics,"%BigInt%":"undefined"==typeof BigInt?n:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?n:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?n:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?n:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?n:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?n:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?n:FinalizationRegistry,"%Function%":o,"%GeneratorFunction%":f,"%Int8Array%":"undefined"==typeof Int8Array?n:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?n:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?n:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":u&&p?p(p([][Symbol.iterator]())):n,"%JSON%":"object"==typeof JSON?JSON:n,"%Map%":"undefined"==typeof Map?n:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&u&&p?p((new Map)[Symbol.iterator]()):n,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?n:Promise,"%Proxy%":"undefined"==typeof Proxy?n:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?n:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?n:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&u&&p?p((new Set)[Symbol.iterator]()):n,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?n:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":u&&p?p(""[Symbol.iterator]()):n,"%Symbol%":u?Symbol:n,"%SyntaxError%":i,"%ThrowTypeError%":d,"%TypedArray%":g,"%TypeError%":s,"%Uint8Array%":"undefined"==typeof Uint8Array?n:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?n:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?n:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?n:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?n:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?n:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?n:WeakSet};if(p)try{null.error}catch(e){var v=p(p(e));m["%Error.prototype%"]=v}var y=function e(t){var r;if("%AsyncFunction%"===t)r=a("async function () {}");else if("%GeneratorFunction%"===t)r=a("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=a("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&p&&(r=p(i.prototype))}return m[t]=r,r},b={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},S=r(174),E=r(101),_=S.call(Function.call,Array.prototype.concat),w=S.call(Function.apply,Array.prototype.splice),T=S.call(Function.call,String.prototype.replace),I=S.call(Function.call,String.prototype.slice),O=S.call(Function.call,RegExp.prototype.exec),R=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,C=/\\(\\)?/g,k=function(e){var t=I(e,0,1),r=I(e,-1);if("%"===t&&"%"!==r)throw new i("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new i("invalid intrinsic syntax, expected opening `%`");var n=[];return T(e,R,function(e,t,r,i){n[n.length]=r?T(i,C,"$1"):t||e}),n},M=function(e,t){var r,n=e;if(E(b,n)&&(n="%"+(r=b[n])[0]+"%"),E(m,n)){var o=m[n];if(o===f&&(o=y(n)),void 0===o&&!t)throw new s("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:o}}throw new i("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new s("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new s('"allowMissing" argument must be a boolean');if(null===O(/^%?[^%]*%?$/,e))throw new i("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=k(e),n=r.length>0?r[0]:"",o=M("%"+n+"%",t),a=o.name,c=o.value,d=!1,u=o.alias;u&&(n=u[0],w(r,_([0,1],u)));for(var h=1,p=!0;h<r.length;h+=1){var f=r[h],g=I(f,0,1),v=I(f,-1);if(('"'===g||"'"===g||"`"===g||'"'===v||"'"===v||"`"===v)&&g!==v)throw new i("property names with quotes must have matching quotes");if("constructor"!==f&&p||(d=!0),n+="."+f,E(m,a="%"+n+"%"))c=m[a];else if(null!=c){if(!(f in c)){if(!t)throw new s("base intrinsic for "+e+" exists, but the property is not available.");return}if(l&&h+1>=r.length){var y=l(c,f);c=(p=!!y)&&"get"in y&&!("originalValue"in y.get)?y.get:c[f]}else p=E(c,f),c=c[f];p&&!d&&(m[a]=c)}}return c}},504:function(e){var t={foo:{}},r=Object;e.exports=function(){return({__proto__:t}).foo===t.foo&&!(({__proto__:null})instanceof r)}},942:function(e,t,r){var n="undefined"!=typeof Symbol&&Symbol,i=r(773);e.exports=function(){return"function"==typeof n&&"function"==typeof Symbol&&"symbol"==typeof n("foo")&&"symbol"==typeof Symbol("bar")&&i()}},773:function(e){e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t||"[object Symbol]"!==Object.prototype.toString.call(t)||"[object Symbol]"!==Object.prototype.toString.call(r))return!1;var n=42;for(t in e[t]=n,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length||"function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var o=Object.getOwnPropertyDescriptor(e,t);if(o.value!==n||!0!==o.enumerable)return!1}return!0}},115:function(e,t,r){var n="undefined"!=typeof Symbol&&Symbol,i=r(832);e.exports=function(){return"function"==typeof n&&"function"==typeof Symbol&&"symbol"==typeof n("foo")&&"symbol"==typeof Symbol("bar")&&i()}},832:function(e){e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t||"[object Symbol]"!==Object.prototype.toString.call(t)||"[object Symbol]"!==Object.prototype.toString.call(r))return!1;var n=42;for(t in e[t]=n,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length||"function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var o=Object.getOwnPropertyDescriptor(e,t);if(o.value!==n||!0!==o.enumerable)return!1}return!0}},101:function(e,t,r){var n=r(174);e.exports=n.call(Function.call,Object.prototype.hasOwnProperty)},782:function(e){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}},157:function(e){var t="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,r=Object.prototype.toString,n=function(e){return(!t||!e||"object"!=typeof e||!(Symbol.toStringTag in e))&&"[object Arguments]"===r.call(e)},i=function(e){return!!n(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==r.call(e)&&"[object Function]"===r.call(e.callee)},o=function(){return n(arguments)}();n.isLegacyArguments=i,e.exports=o?n:i},391:function(e){var t=Object.prototype.toString,r=Function.prototype.toString,n=/^\s*(?:function)?\*/,i="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,o=Object.getPrototypeOf,s=function(){if(!i)return!1;try{return Function("return function*() {}")()}catch(e){}}(),a=s?o(s):{};e.exports=function(e){return"function"==typeof e&&(!!n.test(r.call(e))||(i?o(e)===a:"[object GeneratorFunction]"===t.call(e)))}},994:function(e,t,n){var i=n(144),o=n(349),s=n(256),a=s("Object.prototype.toString"),l=n(942)()&&"symbol"==typeof Symbol.toStringTag,c=o(),d=s("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return -1},u=s("String.prototype.slice"),h={},p=n(24),f=Object.getPrototypeOf;l&&p&&f&&i(c,function(e){var t=new r.g[e];if(!(Symbol.toStringTag in t))throw EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=f(t),i=p(n,Symbol.toStringTag);i||(i=p(f(n),Symbol.toStringTag)),h[e]=i.get});var g=function(e){var t=!1;return i(h,function(r,n){if(!t)try{t=r.call(e)===n}catch(e){}}),t};e.exports=function(e){return!!e&&"object"==typeof e&&(l?!!p&&g(e):d(c,u(a(e),8,-1))>-1)}},369:function(e){e.exports=function(e){return e instanceof i}},584:function(e,t,r){var n=r(157),i=r(391),o=r(490),s=r(994);function a(e){return e.call.bind(e)}var l="undefined"!=typeof BigInt,c="undefined"!=typeof Symbol,d=a(Object.prototype.toString),u=a(Number.prototype.valueOf),h=a(String.prototype.valueOf),p=a(Boolean.prototype.valueOf);if(l)var f=a(BigInt.prototype.valueOf);if(c)var g=a(Symbol.prototype.valueOf);function m(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function v(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch}function y(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):s(e)||K(e)}function b(e){return"Uint8Array"===o(e)}function S(e){return"Uint8ClampedArray"===o(e)}function E(e){return"Uint16Array"===o(e)}function _(e){return"Uint32Array"===o(e)}function w(e){return"Int8Array"===o(e)}function T(e){return"Int16Array"===o(e)}function I(e){return"Int32Array"===o(e)}function O(e){return"Float32Array"===o(e)}function R(e){return"Float64Array"===o(e)}function C(e){return"BigInt64Array"===o(e)}function k(e){return"BigUint64Array"===o(e)}function M(e){return"[object Map]"===d(e)}function P(e){return"undefined"!=typeof Map&&(M.working?M(e):e instanceof Map)}function A(e){return"[object Set]"===d(e)}function D(e){return"undefined"!=typeof Set&&(A.working?A(e):e instanceof Set)}function x(e){return"[object WeakMap]"===d(e)}function j(e){return"undefined"!=typeof WeakMap&&(x.working?x(e):e instanceof WeakMap)}function U(e){return"[object WeakSet]"===d(e)}function L(e){return U(e)}function N(e){return"[object ArrayBuffer]"===d(e)}function B(e){return"undefined"!=typeof ArrayBuffer&&(N.working?N(e):e instanceof ArrayBuffer)}function F(e){return"[object DataView]"===d(e)}function K(e){return"undefined"!=typeof DataView&&(F.working?F(e):e instanceof DataView)}t.isArgumentsObject=n,t.isGeneratorFunction=i,t.isTypedArray=s,t.isPromise=v,t.isArrayBufferView=y,t.isUint8Array=b,t.isUint8ClampedArray=S,t.isUint16Array=E,t.isUint32Array=_,t.isInt8Array=w,t.isInt16Array=T,t.isInt32Array=I,t.isFloat32Array=O,t.isFloat64Array=R,t.isBigInt64Array=C,t.isBigUint64Array=k,M.working="undefined"!=typeof Map&&M(new Map),t.isMap=P,A.working="undefined"!=typeof Set&&A(new Set),t.isSet=D,x.working="undefined"!=typeof WeakMap&&x(new WeakMap),t.isWeakMap=j,U.working="undefined"!=typeof WeakSet&&U(new WeakSet),t.isWeakSet=L,N.working="undefined"!=typeof ArrayBuffer&&N(new ArrayBuffer),t.isArrayBuffer=B,F.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&F(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=K;var q="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function V(e){return"[object SharedArrayBuffer]"===d(e)}function W(e){return void 0!==q&&(void 0===V.working&&(V.working=V(new q)),V.working?V(e):e instanceof q)}function G(e){return"[object AsyncFunction]"===d(e)}function H(e){return"[object Map Iterator]"===d(e)}function z(e){return"[object Set Iterator]"===d(e)}function J(e){return"[object Generator]"===d(e)}function Y(e){return"[object WebAssembly.Module]"===d(e)}function Q(e){return m(e,u)}function X(e){return m(e,h)}function $(e){return m(e,p)}function Z(e){return l&&m(e,f)}function ee(e){return c&&m(e,g)}function et(e){return Q(e)||X(e)||$(e)||Z(e)||ee(e)}function er(e){return"undefined"!=typeof Uint8Array&&(B(e)||W(e))}t.isSharedArrayBuffer=W,t.isAsyncFunction=G,t.isMapIterator=H,t.isSetIterator=z,t.isGeneratorObject=J,t.isWebAssemblyCompiledModule=Y,t.isNumberObject=Q,t.isStringObject=X,t.isBooleanObject=$,t.isBigIntObject=Z,t.isSymbolObject=ee,t.isBoxedPrimitive=et,t.isAnyArrayBuffer=er,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw Error(e+" is not supported in userland")}})})},177:function(e,t,r){var n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),r={},n=0;n<t.length;n++)r[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return r},i=/%[sdj%]/g;t.format=function(e){if(!T(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(c(arguments[r]));return t.join(" ")}for(var r=1,n=arguments,o=n.length,s=String(e).replace(i,function(e){if("%%"===e)return"%";if(r>=o)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}}),a=n[r];r<o;a=n[++r])E(a)||!C(a)?s+=" "+a:s+=" "+c(a);return s},t.deprecate=function(e,r){if(void 0!==o&&!0===o.noDeprecation)return e;if(void 0===o)return function(){return t.deprecate(e,r).apply(this,arguments)};var n=!1;return function(){if(!n){if(o.throwDeprecation)throw Error(r);o.traceDeprecation?console.trace(r):console.error(r),n=!0}return e.apply(this,arguments)}};var s={},a=/^$/;if(o.env.NODE_DEBUG){var l=o.env.NODE_DEBUG;a=RegExp("^"+(l=l.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase())+"$","i")}function c(e,r){var n={seen:[],stylize:u};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),S(r)?n.showHidden=r:r&&t._extend(n,r),O(n.showHidden)&&(n.showHidden=!1),O(n.depth)&&(n.depth=2),O(n.colors)&&(n.colors=!1),O(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=d),p(n,e,n.depth)}function d(e,t){var r=c.styles[t];return r?"\x1b["+c.colors[r][0]+"m"+e+"\x1b["+c.colors[r][1]+"m":e}function u(e,t){return e}function h(e){var t={};return e.forEach(function(e,r){t[e]=!0}),t}function p(e,r,n){if(e.customInspect&&r&&P(r.inspect)&&r.inspect!==t.inspect&&!(r.constructor&&r.constructor.prototype===r)){var i,o=r.inspect(n,e);return T(o)||(o=p(e,o,n)),o}var s=f(e,r);if(s)return s;var a=Object.keys(r),l=h(a);if(e.showHidden&&(a=Object.getOwnPropertyNames(r)),M(r)&&(a.indexOf("message")>=0||a.indexOf("description")>=0))return g(r);if(0===a.length){if(P(r)){var c=r.name?": "+r.name:"";return e.stylize("[Function"+c+"]","special")}if(R(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(k(r))return e.stylize(Date.prototype.toString.call(r),"date");if(M(r))return g(r)}var d="",u=!1,S=["{","}"];return(b(r)&&(u=!0,S=["[","]"]),P(r)&&(d=" [Function"+(r.name?": "+r.name:"")+"]"),R(r)&&(d=" "+RegExp.prototype.toString.call(r)),k(r)&&(d=" "+Date.prototype.toUTCString.call(r)),M(r)&&(d=" "+g(r)),0!==a.length||u&&0!=r.length)?n<0?R(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special"):(e.seen.push(r),i=u?m(e,r,n,l,a):a.map(function(t){return v(e,r,n,l,t,u)}),e.seen.pop(),y(i,d,S)):S[0]+d+S[1]}function f(e,t){if(O(t))return e.stylize("undefined","undefined");if(T(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}return w(t)?e.stylize(""+t,"number"):S(t)?e.stylize(""+t,"boolean"):E(t)?e.stylize("null","null"):void 0}function g(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,r,n,i){for(var o=[],s=0,a=t.length;s<a;++s)L(t,String(s))?o.push(v(e,t,r,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(v(e,t,r,n,i,!0))}),o}function v(e,t,r,n,i,o){var s,a,l;if((l=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(a=e.stylize("[Setter]","special")),L(n,i)||(s="["+i+"]"),!a&&(0>e.seen.indexOf(l.value)?(a=E(r)?p(e,l.value,null):p(e,l.value,r-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+a.split("\n").map(function(e){return"   "+e}).join("\n")):a=e.stylize("[Circular]","special")),O(s)){if(o&&i.match(/^\d+$/))return a;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+a}function y(e,t,r){var n=0;return e.reduce(function(e,t){return n++,t.indexOf("\n")>=0&&n++,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}function b(e){return Array.isArray(e)}function S(e){return"boolean"==typeof e}function E(e){return null===e}function _(e){return null==e}function w(e){return"number"==typeof e}function T(e){return"string"==typeof e}function I(e){return"symbol"==typeof e}function O(e){return void 0===e}function R(e){return C(e)&&"[object RegExp]"===D(e)}function C(e){return"object"==typeof e&&null!==e}function k(e){return C(e)&&"[object Date]"===D(e)}function M(e){return C(e)&&("[object Error]"===D(e)||e instanceof Error)}function P(e){return"function"==typeof e}function A(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function D(e){return Object.prototype.toString.call(e)}function x(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(!s[e=e.toUpperCase()]){if(a.test(e)){var r=o.pid;s[e]=function(){var n=t.format.apply(t,arguments);console.error("%s %d: %s",e,r,n)}}else s[e]=function(){}}return s[e]},t.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=r(584),t.isArray=b,t.isBoolean=S,t.isNull=E,t.isNullOrUndefined=_,t.isNumber=w,t.isString=T,t.isSymbol=I,t.isUndefined=O,t.isRegExp=R,t.types.isRegExp=R,t.isObject=C,t.isDate=k,t.types.isDate=k,t.isError=M,t.types.isNativeError=M,t.isFunction=P,t.isPrimitive=A,t.isBuffer=r(369);var j=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function U(){var e=new Date,t=[x(e.getHours()),x(e.getMinutes()),x(e.getSeconds())].join(":");return[e.getDate(),j[e.getMonth()],t].join(" ")}function L(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",U(),t.format.apply(t,arguments))},t.inherits=r(782),t._extend=function(e,t){if(!t||!C(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e};var N="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function B(e,t){if(!e){var r=Error("Promise was rejected with a falsy value");r.reason=e,e=r}return t(e)}function F(e){if("function"!=typeof e)throw TypeError('The "original" argument must be of type Function');function t(){for(var t=[],r=0;r<arguments.length;r++)t.push(arguments[r]);var n=t.pop();if("function"!=typeof n)throw TypeError("The last argument must be of type Function");var i=this,s=function(){return n.apply(i,arguments)};e.apply(this,t).then(function(e){o.nextTick(s.bind(null,null,e))},function(e){o.nextTick(B.bind(null,e,s))})}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,n(e)),t}t.promisify=function(e){if("function"!=typeof e)throw TypeError('The "original" argument must be of type Function');if(N&&e[N]){var t=e[N];if("function"!=typeof t)throw TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,r,n=new Promise(function(e,n){t=e,r=n}),i=[],o=0;o<arguments.length;o++)i.push(arguments[o]);i.push(function(e,n){e?r(e):t(n)});try{e.apply(this,i)}catch(e){r(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),N&&Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=N,t.callbackify=F},490:function(e,t,n){var i=n(144),o=n(349),s=n(256),a=s("Object.prototype.toString"),l=n(942)()&&"symbol"==typeof Symbol.toStringTag,c=o(),d=s("String.prototype.slice"),u={},h=n(24),p=Object.getPrototypeOf;l&&h&&p&&i(c,function(e){if("function"==typeof r.g[e]){var t=new r.g[e];if(!(Symbol.toStringTag in t))throw EvalError("this engine has support for Symbol.toStringTag, but "+e+" does not have the property! Please report this.");var n=p(t),i=h(n,Symbol.toStringTag);i||(i=h(p(n),Symbol.toStringTag)),u[e]=i.get}});var f=function(e){var t=!1;return i(u,function(r,n){if(!t)try{var i=r.call(e);i===n&&(t=i)}catch(e){}}),t},g=n(994);e.exports=function(e){return!!g(e)&&(l?f(e):d(a(e),8,-1))}},349:function(e,t,n){var i=n(992);e.exports=function(){return i(["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],function(e){return"function"==typeof r.g[e]})}},24:function(e,t,r){var n=r(500)("%Object.getOwnPropertyDescriptor%",!0);if(n)try{n([],"length")}catch(e){n=null}e.exports=n}},s={};function a(e){var r=s[e];if(void 0!==r)return r.exports;var n=s[e]={exports:{}},i=!0;try{t[e](n,n.exports,a),i=!1}finally{i&&delete s[e]}return n.exports}a.ab=n+"/";var l=a(177);e.exports=l}()},9023:function(module){"use strict";var __dirname="/";!function(){var __webpack_modules__={950:function(__unused_webpack_module,exports){var indexOf=function(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0;r<e.length;r++)if(e[r]===t)return r;return -1},Object_keys=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var r in e)t.push(r);return t},forEach=function(e,t){if(e.forEach)return e.forEach(t);for(var r=0;r<e.length;r++)t(e[r],r,e)},defineProp=function(){try{return Object.defineProperty({},"_",{}),function(e,t,r){Object.defineProperty(e,t,{writable:!0,enumerable:!1,configurable:!0,value:r})}}catch(e){return function(e,t,r){e[t]=r}}}(),globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];function Context(){}Context.prototype={};var Script=exports.Script=function(e){if(!(this instanceof Script))return new Script(e);this.code=e};Script.prototype.runInContext=function(e){if(!(e instanceof Context))throw TypeError("needs a 'context' argument.");var t=document.createElement("iframe");t.style||(t.style={}),t.style.display="none",document.body.appendChild(t);var r=t.contentWindow,n=r.eval,i=r.execScript;!n&&i&&(i.call(r,"null"),n=r.eval),forEach(Object_keys(e),function(t){r[t]=e[t]}),forEach(globals,function(t){e[t]&&(r[t]=e[t])});var o=Object_keys(r),s=n.call(r,this.code);return forEach(Object_keys(r),function(t){(t in e||-1===indexOf(o,t))&&(e[t]=r[t])}),forEach(globals,function(t){t in e||defineProp(e,t,r[t])}),document.body.removeChild(t),s},Script.prototype.runInThisContext=function(){return eval(this.code)},Script.prototype.runInNewContext=function(e){var t=Script.createContext(e),r=this.runInContext(t);return e&&forEach(Object_keys(t),function(r){e[r]=t[r]}),r},forEach(Object_keys(Script.prototype),function(e){exports[e]=Script[e]=function(t){var r=Script(t);return r[e].apply(r,[].slice.call(arguments,1))}}),exports.isContext=function(e){return e instanceof Context},exports.createScript=function(e){return exports.Script(e)},exports.createContext=Script.createContext=function(e){var t=new Context;return"object"==typeof e&&forEach(Object_keys(e),function(r){t[r]=e[r]}),t}}};"undefined"!=typeof __nccwpck_require__&&(__nccwpck_require__.ab=__dirname+"/");var __nested_webpack_exports__={};__webpack_modules__[950](0,__nested_webpack_exports__),module.exports=__nested_webpack_exports__}()},87130:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"AmpStateContext",{enumerable:!0,get:function(){return n}});let n=r(3280)._(r(22971)).default.createContext({})},80033:function(e,t){"use strict";function r(e){let{ampFirst:t=!1,hybrid:r=!1,hasQuery:n=!1}=void 0===e?{}:e;return t||r&&n}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"isInAmpMode",{enumerable:!0,get:function(){return r}})},48145:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"getImgProps",{enumerable:!0,get:function(){return u}}),r(43737);let n=r(70559),i=r(38792);function o(e){return void 0!==e.default}function s(e){return void 0!==e.src}function a(e){return"object"==typeof e&&(o(e)||s(e))}function l(e){return void 0===e?e:"number"==typeof e?Number.isFinite(e)?e:NaN:"string"==typeof e&&/^[0-9]+$/.test(e)?parseInt(e,10):NaN}function c(e,t,r){let{deviceSizes:n,allSizes:i}=e;if(r){let e=/(^|\s)(1?\d?\d)vw/g,t=[];for(let n;n=e.exec(r);n)t.push(parseInt(n[2]));if(t.length){let e=.01*Math.min(...t);return{widths:i.filter(t=>t>=n[0]*e),kind:"w"}}return{widths:i,kind:"w"}}return"number"!=typeof t?{widths:n,kind:"w"}:{widths:[...new Set([t,2*t].map(e=>i.find(t=>t>=e)||i[i.length-1]))],kind:"x"}}function d(e){let{config:t,src:r,unoptimized:n,width:i,quality:o,sizes:s,loader:a}=e;if(n)return{src:r,srcSet:void 0,sizes:void 0};let{widths:l,kind:d}=c(t,i,s),u=l.length-1;return{sizes:s||"w"!==d?s:"100vw",srcSet:l.map((e,n)=>a({config:t,src:r,quality:o,width:e})+" "+("w"===d?e:n+1)+d).join(", "),src:a({config:t,src:r,quality:o,width:l[u]})}}function u(e,t){let r,s,c,{src:u,sizes:h,unoptimized:p=!1,priority:f=!1,loading:g,className:m,quality:v,width:y,height:b,fill:S=!1,style:E,onLoad:_,onLoadingComplete:w,placeholder:T="empty",blurDataURL:I,fetchPriority:O,layout:R,objectFit:C,objectPosition:k,lazyBoundary:M,lazyRoot:P,...A}=e,{imgConf:D,showAltText:x,blurComplete:j,defaultLoader:U}=t,L=D||i.imageConfigDefault;if("allSizes"in L)r=L;else{let e=[...L.deviceSizes,...L.imageSizes].sort((e,t)=>e-t),t=L.deviceSizes.sort((e,t)=>e-t);r={...L,allSizes:e,deviceSizes:t}}let N=A.loader||U;delete A.loader,delete A.srcSet;let B="__next_img_default"in N;if(B){if("custom"===r.loader)throw Error('Image with src "'+u+'" is missing "loader" prop.\nRead more: https://nextjs.org/docs/messages/next-image-missing-loader')}else{let e=N;N=t=>{let{config:r,...n}=t;return e(n)}}if(R){"fill"===R&&(S=!0);let e={responsive:"100vw",fill:"100vw"},t={intrinsic:{maxWidth:"100%",height:"auto"},responsive:{width:"100%",height:"auto"}}[R];t&&(E={...E,...t});let r=e[R];r&&!h&&(h=r)}let F="",K=l(y),q=l(b);if(a(u)){let e=o(u)?u.default:u;if(!e.src)throw Error("An object should only be passed to the image component src parameter if it comes from a static image import. It must include src. Received "+JSON.stringify(e));if(!e.height||!e.width)throw Error("An object should only be passed to the image component src parameter if it comes from a static image import. It must include height and width. Received "+JSON.stringify(e));if(s=e.blurWidth,c=e.blurHeight,I=I||e.blurDataURL,F=e.src,!S){if(K||q){if(K&&!q){let t=K/e.width;q=Math.round(e.height*t)}else if(!K&&q){let t=q/e.height;K=Math.round(e.width*t)}}else K=e.width,q=e.height}}let V=!f&&("lazy"===g||void 0===g);(!(u="string"==typeof u?u:F)||u.startsWith("data:")||u.startsWith("blob:"))&&(p=!0,V=!1),r.unoptimized&&(p=!0),B&&u.endsWith(".svg")&&!r.dangerouslyAllowSVG&&(p=!0),f&&(O="high");let W=l(v),G=Object.assign(S?{position:"absolute",height:"100%",width:"100%",left:0,top:0,right:0,bottom:0,objectFit:C,objectPosition:k}:{},x?{}:{color:"transparent"},E),H=j||"empty"===T?null:"blur"===T?'url("data:image/svg+xml;charset=utf-8,'+(0,n.getImageBlurSvg)({widthInt:K,heightInt:q,blurWidth:s,blurHeight:c,blurDataURL:I||"",objectFit:G.objectFit})+'")':'url("'+T+'")',z=H?{backgroundSize:G.objectFit||"cover",backgroundPosition:G.objectPosition||"50% 50%",backgroundRepeat:"no-repeat",backgroundImage:H}:{},J=d({config:r,src:u,unoptimized:p,width:K,quality:W,sizes:h,loader:N});return{props:{...A,loading:V?"lazy":g,fetchPriority:O,width:K,height:q,decoding:"async",className:m,style:{...G,...z},sizes:J.sizes,srcSet:J.srcSet,src:J.src},meta:{unoptimized:p,priority:f,placeholder:T,fill:S}}}},33328:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{defaultHead:function(){return u},default:function(){return m}});let n=r(3280),i=r(87791),o=r(19506),s=i._(r(22971)),a=n._(r(89049)),l=r(87130),c=r(69086),d=r(80033);function u(e){void 0===e&&(e=!1);let t=[(0,o.jsx)("meta",{charSet:"utf-8"})];return e||t.push((0,o.jsx)("meta",{name:"viewport",content:"width=device-width"})),t}function h(e,t){return"string"==typeof t||"number"==typeof t?e:t.type===s.default.Fragment?e.concat(s.default.Children.toArray(t.props.children).reduce((e,t)=>"string"==typeof t||"number"==typeof t?e:e.concat(t),[])):e.concat(t)}r(43737);let p=["name","httpEquiv","charSet","itemProp"];function f(){let e=new Set,t=new Set,r=new Set,n={};return i=>{let o=!0,s=!1;if(i.key&&"number"!=typeof i.key&&i.key.indexOf("$")>0){s=!0;let t=i.key.slice(i.key.indexOf("$")+1);e.has(t)?o=!1:e.add(t)}switch(i.type){case"title":case"base":t.has(i.type)?o=!1:t.add(i.type);break;case"meta":for(let e=0,t=p.length;e<t;e++){let t=p[e];if(i.props.hasOwnProperty(t)){if("charSet"===t)r.has(t)?o=!1:r.add(t);else{let e=i.props[t],r=n[t]||new Set;("name"!==t||!s)&&r.has(e)?o=!1:(r.add(e),n[t]=r)}}}}return o}}function g(e,t){let{inAmpMode:r}=t;return e.reduce(h,[]).reverse().concat(u(r).reverse()).filter(f()).reverse().map((e,t)=>{let n=e.key||t;if(!r&&"link"===e.type&&e.props.href&&["https://fonts.googleapis.com/css","https://use.typekit.net/"].some(t=>e.props.href.startsWith(t))){let t={...e.props||{}};return t["data-href"]=t.href,t.href=void 0,t["data-optimized-fonts"]=!0,s.default.cloneElement(e,t)}return s.default.cloneElement(e,{key:n})})}let m=function(e){let{children:t}=e,r=(0,s.useContext)(l.AmpStateContext),n=(0,s.useContext)(c.HeadManagerContext);return(0,o.jsx)(a.default,{reduceComponentsToState:g,headManager:n,inAmpMode:(0,d.isInAmpMode)(r),children:t})};("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},70559:function(e,t){"use strict";function r(e){let{widthInt:t,heightInt:r,blurWidth:n,blurHeight:i,blurDataURL:o,objectFit:s}=e,a=n?40*n:t,l=i?40*i:r,c=a&&l?"viewBox='0 0 "+a+" "+l+"'":"",d=c?"none":"contain"===s?"xMidYMid":"cover"===s?"xMidYMid slice":"none";return"%3Csvg xmlns='http://www.w3.org/2000/svg' "+c+"%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='20'/%3E%3CfeColorMatrix values='1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 100 -1' result='s'/%3E%3CfeFlood x='0' y='0' width='100%25' height='100%25'/%3E%3CfeComposite operator='out' in='s'/%3E%3CfeComposite in2='SourceGraphic'/%3E%3CfeGaussianBlur stdDeviation='20'/%3E%3C/filter%3E%3Cimage width='100%25' height='100%25' x='0' y='0' preserveAspectRatio='"+d+"' style='filter: url(%23b);' href='"+o+"'/%3E%3C/svg%3E"}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"getImageBlurSvg",{enumerable:!0,get:function(){return r}})},51632:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ImageConfigContext",{enumerable:!0,get:function(){return o}});let n=r(3280)._(r(22971)),i=r(38792),o=n.default.createContext(i.imageConfigDefault)},38792:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{VALID_LOADERS:function(){return r},imageConfigDefault:function(){return n}});let r=["default","imgix","cloudinary","akamai","custom"],n={deviceSizes:[640,750,828,1080,1200,1920,2048,3840],imageSizes:[16,32,48,64,96,128,256,384],path:"/_next/image",loader:"default",loaderFile:"",domains:[],disableStaticImages:!1,minimumCacheTTL:60,formats:["image/webp"],dangerouslyAllowSVG:!1,contentSecurityPolicy:"script-src 'none'; frame-src 'none'; sandbox;",contentDispositionType:"inline",remotePatterns:[],unoptimized:!1}},65198:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{getImageProps:function(){return a},default:function(){return l}});let n=r(3280),i=r(48145),o=r(74117),s=n._(r(29657)),a=e=>{let{props:t}=(0,i.getImgProps)(e,{defaultLoader:s.default,imgConf:{deviceSizes:[640,750,828,1080,1200,1920,2048,3840],imageSizes:[16,32,48,64,96,128,256,384],path:"/_next/image",loader:"default",dangerouslyAllowSVG:!1,unoptimized:!0}});for(let[e,r]of Object.entries(t))void 0===r&&delete t[e];return{props:t}},l=o.Image},29657:function(e,t){"use strict";function r(e){let{config:t,src:r,width:n,quality:i}=e;return t.path+"?url="+encodeURIComponent(r)+"&w="+n+"&q="+(i||75)}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n}}),r.__next_img_default=!0;let n=r},89049:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a}});let n=r(22971),i=!1,o=n.useLayoutEffect,s=i?()=>{}:n.useEffect;function a(e){let{headManager:t,reduceComponentsToState:r}=e;function a(){if(t&&t.mountedInstances){let i=n.Children.toArray(Array.from(t.mountedInstances).filter(Boolean));t.updateHead(r(i,e))}}if(i){var l;null==t||null==(l=t.mountedInstances)||l.add(e.children),a()}return o(()=>{var r;return null==t||null==(r=t.mountedInstances)||r.add(e.children),()=>{var r;null==t||null==(r=t.mountedInstances)||r.delete(e.children)}}),o(()=>(t&&(t._pendingUpdate=a),()=>{t&&(t._pendingUpdate=a)})),s(()=>(t&&t._pendingUpdate&&(t._pendingUpdate(),t._pendingUpdate=null),()=>{t&&t._pendingUpdate&&(t._pendingUpdate(),t._pendingUpdate=null)})),null}},26241:function(e,t,r){"use strict";var n,i,o,s=Object.create,a=Object.defineProperty,l=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyNames,d=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,h=(e,t,r,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let i of c(t))u.call(e,i)||i===r||a(e,i,{get:()=>t[i],enumerable:!(n=l(t,i))||n.enumerable});return e},p=(e,t,r)=>(r=null!=e?s(d(e)):{},h(!t&&e&&e.__esModule?r:a(r,"default",{value:e,enumerable:!0}),e)),f=e=>h(a({},"__esModule",{value:!0}),e),g={};((e,t)=>{for(var r in t)a(e,r,{get:t[r],enumerable:!0})})(g,{AccessTokenEvents:()=>x,CheckSessionIFrame:()=>j,ErrorResponse:()=>A,ErrorTimeout:()=>D,InMemoryWebStorage:()=>U,Log:()=>E,Logger:()=>_,MetadataService:()=>N,OidcClient:()=>es,OidcClientSettingsStore:()=>H,SessionMonitor:()=>ea,SigninResponse:()=>ee,SigninState:()=>X,SignoutResponse:()=>er,State:()=>Q,User:()=>el,UserManager:()=>eR,UserManagerSettingsStore:()=>em,Version:()=>eC,WebStorageStateStore:()=>B}),e.exports=f(g);var m=p(r(28389)),v=p(r(46445)),y=p(r(30146)),b=p(r(11892)),S={debug:()=>void 0,info:()=>void 0,warn:()=>void 0,error:()=>void 0},E=((n=E||{})[n.NONE=0]="NONE",n[n.ERROR=1]="ERROR",n[n.WARN=2]="WARN",n[n.INFO=3]="INFO",n[n.DEBUG=4]="DEBUG",n);(e=>{function t(){i=3,o=S}function r(e){if(!(0<=e&&e<=4))throw Error("Invalid log level");i=e}function n(e){o=e}e.reset=t,e.setLevel=r,e.setLogger=n})(E||(E={}));var _=class{debug(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];i>=4&&o.debug(_._format(this._name,this._method),...t)}info(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];i>=3&&o.info(_._format(this._name,this._method),...t)}warn(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];i>=2&&o.warn(_._format(this._name,this._method),...t)}error(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];i>=1&&o.error(_._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){let t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){let r=new _("".concat(e,".").concat(t));return r.debug("begin"),r}static _format(e,t){let r="[".concat(e,"]");return t?"".concat(r," ").concat(t,":"):r}static debug(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];i>=4&&o.debug(_._format(e),...r)}static info(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];i>=3&&o.info(_._format(e),...r)}static warn(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];i>=2&&o.warn(_._format(e),...r)}static error(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];i>=1&&o.error(_._format(e),...r)}constructor(e){this._name=e}};E.reset();var w="10000000-1000-4000-8000-100000000000",T=class{static _randomWord(){return m.default.lib.WordArray.random(1).words[0]}static generateUUIDv4(){return w.replace(/[018]/g,e=>(+e^T._randomWord()&15>>+e/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return T.generateUUIDv4()+T.generateUUIDv4()+T.generateUUIDv4()}static generateCodeChallenge(e){try{let t=(0,v.default)(e);return y.default.stringify(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){throw _.error("CryptoUtils.generateCodeChallenge",e),e}}static generateBasicAuth(e,t){let r=b.default.parse([e,t].join(":"));return y.default.stringify(r)}},I=class{addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){let t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}raise(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];for(let e of(this._logger.debug("raise:",...t),this._callbacks))e(...t)}constructor(e){this._name=e,this._logger=new _("Event('".concat(this._name,"')")),this._callbacks=[]}},O=p(r(9104)),R=class{static decode(e){try{return(0,O.default)(e)}catch(e){throw _.error("JwtUtils.decode",e),e}}},C=class{static center(e){var t,r,n;let{...i}=e;return null==i.width&&(i.width=null!=(t=[800,720,600,480].find(e=>e<=window.outerWidth/1.618))?t:360),null!=(r=i.left)||(i.left=Math.max(0,Math.round(window.screenX+(window.outerWidth-i.width)/2))),null!=i.height&&(null!=(n=i.top)||(i.top=Math.max(0,Math.round(window.screenY+(window.outerHeight-i.height)/2)))),i}static serialize(e){return Object.entries(e).filter(e=>{let[,t]=e;return null!=t}).map(e=>{let[t,r]=e;return"".concat(t,"=").concat("boolean"!=typeof r?r:r?"yes":"no")}).join(",")}},k=class extends I{static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){let t=this._logger.create("init");e=Math.max(Math.floor(e),1);let r=k.getEpochTime()+e;if(this.expiration===r&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=r;let n=Math.min(e,5);this._timerHandle=setInterval(this._callback,1e3*n)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}constructor(){super(...arguments),this._logger=new _("Timer('".concat(this._name,"')")),this._timerHandle=null,this._expiration=0,this._callback=()=>{let e=this._expiration-k.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=k.getEpochTime()&&(this.cancel(),super.raise())}}},M=class{static readParams(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"query";if(!e)throw TypeError("Invalid URL");let r=new URL(e,"http://127.0.0.1")["fragment"===t?"hash":"search"];return new URLSearchParams(r.slice(1))}},P=";",A=class extends Error{constructor(e,t){var r,n,i;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw _.error("ErrorResponse","No error passed"),Error("No error passed");this.error=e.error,this.error_description=null!=(r=e.error_description)?r:null,this.error_uri=null!=(n=e.error_uri)?n:null,this.state=e.userState,this.session_state=null!=(i=e.session_state)?i:null,this.url_state=e.url_state}},D=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},x=class{load(e){let t=this._logger.create("load");if(e.access_token&&void 0!==e.expires_in){let r=e.expires_in;if(t.debug("access token present, remaining duration:",r),r>0){let e=r-this._expiringNotificationTimeInSeconds;e<=0&&(e=1),t.debug("registering expiring timer, raising in",e,"seconds"),this._expiringTimer.init(e)}else t.debug("canceling existing expiring timer because we're past expiration."),this._expiringTimer.cancel();let n=r+1;t.debug("registering expired timer, raising in",n,"seconds"),this._expiredTimer.init(n)}else this._expiringTimer.cancel(),this._expiredTimer.cancel()}unload(){this._logger.debug("unload: canceling existing access token timers"),this._expiringTimer.cancel(),this._expiredTimer.cancel()}addAccessTokenExpiring(e){return this._expiringTimer.addHandler(e)}removeAccessTokenExpiring(e){this._expiringTimer.removeHandler(e)}addAccessTokenExpired(e){return this._expiredTimer.addHandler(e)}removeAccessTokenExpired(e){this._expiredTimer.removeHandler(e)}constructor(e){this._logger=new _("AccessTokenEvents"),this._expiringTimer=new k("Access token expiring"),this._expiredTimer=new k("Access token expired"),this._expiringNotificationTimeInSeconds=e.expiringNotificationTimeInSeconds}},j=class{load(){return new Promise(e=>{this._frame.onload=()=>{e()},window.document.body.appendChild(this._frame),window.addEventListener("message",this._message,!1)})}start(e){if(this._session_state===e)return;this._logger.create("start"),this.stop(),this._session_state=e;let t=()=>{this._frame.contentWindow&&this._session_state&&this._frame.contentWindow.postMessage(this._client_id+" "+this._session_state,this._frame_origin)};t(),this._timer=setInterval(t,1e3*this._intervalInSeconds)}stop(){this._logger.create("stop"),this._session_state=null,this._timer&&(clearInterval(this._timer),this._timer=null)}constructor(e,t,r,n,i){this._callback=e,this._client_id=t,this._intervalInSeconds=n,this._stopOnError=i,this._logger=new _("CheckSessionIFrame"),this._timer=null,this._session_state=null,this._message=e=>{e.origin===this._frame_origin&&e.source===this._frame.contentWindow&&("error"===e.data?(this._logger.error("error message from check session op iframe"),this._stopOnError&&this.stop()):"changed"===e.data?(this._logger.debug("changed message from check session op iframe"),this.stop(),this._callback()):this._logger.debug(e.data+" message from check session op iframe"))};let o=new URL(r);this._frame_origin=o.origin,this._frame=window.document.createElement("iframe"),this._frame.style.visibility="hidden",this._frame.style.position="fixed",this._frame.style.left="-1000px",this._frame.style.top="0",this._frame.width="0",this._frame.height="0",this._frame.src=o.href}},U=class{clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create("getItem('".concat(e,"')")),this._data[e]}setItem(e,t){this._logger.create("setItem('".concat(e,"')")),this._data[e]=t}removeItem(e){this._logger.create("removeItem('".concat(e,"')")),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}constructor(){this._logger=new _("InMemoryWebStorage"),this._data={}}},L=class{async fetchWithTimeout(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{timeoutInSeconds:r,...n}=t;if(!r)return await fetch(e,n);let i=new AbortController,o=setTimeout(()=>i.abort(),1e3*r);try{return await fetch(e,{...t,signal:i.signal})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw new D("Network timed out");throw e}finally{clearTimeout(o)}}async getJson(e){let t,r,{token:n,credentials:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};n&&(o.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+n),this.appendExtraHeaders(s);try{o.debug("url:",e),t=await this.fetchWithTimeout(e,{method:"GET",headers:s,credentials:i})}catch(e){throw o.error("Network Error"),e}o.debug("HTTP response received, status",t.status);let a=t.headers.get("Content-Type");if(a&&!this._contentTypes.find(e=>a.startsWith(e))&&o.throw(Error("Invalid response Content-Type: ".concat(null!=a?a:"undefined",", from URL: ").concat(e))),t.ok&&this._jwtHandler&&(null==a?void 0:a.startsWith("application/jwt")))return await this._jwtHandler(await t.text());try{r=await t.json()}catch(e){if(o.error("Error parsing JSON response",e),t.ok)throw e;throw Error("".concat(t.statusText," (").concat(t.status,")"))}if(!t.ok){if(o.error("Error from server:",r),r.error)throw new A(r);throw Error("".concat(t.statusText," (").concat(t.status,"): ").concat(JSON.stringify(r)))}return r}async postForm(e,t){let r,{body:n,basicAuth:i,timeoutInSeconds:o,initCredentials:s}=t,a=this._logger.create("postForm"),l={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded"};void 0!==i&&(l.Authorization="Basic "+i),this.appendExtraHeaders(l);try{a.debug("url:",e),r=await this.fetchWithTimeout(e,{method:"POST",headers:l,body:n,timeoutInSeconds:o,credentials:s})}catch(e){throw a.error("Network error"),e}a.debug("HTTP response received, status",r.status);let c=r.headers.get("Content-Type");if(c&&!this._contentTypes.find(e=>c.startsWith(e)))throw Error("Invalid response Content-Type: ".concat(null!=c?c:"undefined",", from URL: ").concat(e));let d=await r.text(),u={};if(d)try{u=JSON.parse(d)}catch(e){if(a.error("Error parsing JSON response",e),r.ok)throw e;throw Error("".concat(r.statusText," (").concat(r.status,")"))}if(!r.ok){if(a.error("Error from server:",u),u.error)throw new A(u,n);throw Error("".concat(r.statusText," (").concat(r.status,"): ").concat(JSON.stringify(u)))}return u}appendExtraHeaders(e){let t=this._logger.create("appendExtraHeaders"),r=Object.keys(this._extraHeaders),n=["authorization","accept","content-type"];0!==r.length&&r.forEach(r=>{if(n.includes(r.toLocaleLowerCase())){t.warn("Protected header could not be overridden",r,n);return}let i="function"==typeof this._extraHeaders[r]?this._extraHeaders[r]():this._extraHeaders[r];i&&""!==i&&(e[r]=i)})}constructor(e=[],t=null,r={}){this._jwtHandler=t,this._extraHeaders=r,this._logger=new _("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}},N=class{resetSigningKeys(){this._signingKeys=null}async getMetadata(){let e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);let t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},this._settings.metadataSeed,t),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._logger.create("_getMetadataProperty('".concat(e,"')")),n=await this.getMetadata();if(r.debug("resolved"),void 0===n[e]){if(!0===t){r.warn("Metadata does not contain optional property");return}r.throw(Error("Metadata does not contain property "+e))}return n[e]}async getSigningKeys(){let e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;let t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);let r=await this._jsonService.getJson(t);if(e.debug("got key set",r),!Array.isArray(r.keys))throw e.throw(Error("Missing keys on keyset")),null;return this._signingKeys=r.keys,this._signingKeys}constructor(e){this._settings=e,this._logger=new _("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new L(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}},B=class{async set(e,t){this._logger.create("set('".concat(e,"')")),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){return this._logger.create("get('".concat(e,"')")),e=this._prefix+e,await this._store.getItem(e)}async remove(e){this._logger.create("remove('".concat(e,"')")),e=this._prefix+e;let t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");let e=await this._store.length,t=[];for(let r=0;r<e;r++){let e=await this._store.key(r);e&&0===e.indexOf(this._prefix)&&t.push(e.substr(this._prefix.length))}return t}constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new _("WebStorageStateStore"),this._store=t,this._prefix=e}},F="code",K="openid",q="client_secret_post",V="query",W=900,G=300,H=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:n,metadataSeed:i,client_id:o,client_secret:s,response_type:a=F,scope:l=K,redirect_uri:c,post_logout_redirect_uri:d,client_authentication:u=q,prompt:h,display:p,max_age:f,ui_locales:g,acr_values:m,resource:v,response_mode:y=V,filterProtocolClaims:b=!0,loadUserInfo:S=!1,staleStateAgeInSeconds:E=W,clockSkewInSeconds:_=G,userInfoJwtIssuer:w="OP",mergeClaims:T=!1,disablePKCE:I=!1,stateStore:O,refreshTokenCredentials:R,revokeTokenAdditionalContentTypes:C,fetchRequestCredentials:k,refreshTokenAllowedScope:M,extraQueryParams:P={},extraTokenParams:A={},extraHeaders:D={}}){if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=r,this.metadataSeed=i,this.signingKeys=n,this.client_id=o,this.client_secret=s,this.response_type=a,this.scope=l,this.redirect_uri=c,this.post_logout_redirect_uri=d,this.client_authentication=u,this.prompt=h,this.display=p,this.max_age=f,this.ui_locales=g,this.acr_values=m,this.resource=v,this.response_mode=y,this.filterProtocolClaims=null==b||b,this.loadUserInfo=!!S,this.staleStateAgeInSeconds=E,this.clockSkewInSeconds=_,this.userInfoJwtIssuer=w,this.mergeClaims=!!T,this.disablePKCE=!!I,this.revokeTokenAdditionalContentTypes=C,k&&R&&console.warn("Both fetchRequestCredentials and refreshTokenCredentials is set. Only fetchRequestCredentials will be used."),this.fetchRequestCredentials=k||R||"same-origin",O)this.stateStore=O;else{let e=window.localStorage;this.stateStore=new B({store:e})}this.refreshTokenAllowedScope=M,this.extraQueryParams=P,this.extraTokenParams=A,this.extraHeaders=D}},z=class{async getClaims(e){let t=this._logger.create("getClaims");e||this._logger.throw(Error("No token passed"));let r=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",r);let n=await this._jsonService.getJson(r,{token:e,credentials:this._settings.fetchRequestCredentials});return t.debug("got claims",n),n}constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new _("UserInfoService"),this._getClaimsFromJwt=async e=>{let t=this._logger.create("_getClaimsFromJwt");try{let r=R.decode(e);return t.debug("JWT decoding successful"),r}catch(e){throw t.error("Error parsing JWT response"),e}},this._jsonService=new L(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}},J=class{async exchangeCode(e){let t,{grant_type:r="authorization_code",redirect_uri:n=this._settings.redirect_uri,client_id:i=this._settings.client_id,client_secret:o=this._settings.client_secret,...s}=e,a=this._logger.create("exchangeCode");i||a.throw(Error("A client_id is required")),n||a.throw(Error("A redirect_uri is required")),s.code||a.throw(Error("A code is required"));let l=new URLSearchParams({grant_type:r,redirect_uri:n});for(let[e,t]of Object.entries(s))null!=t&&l.set(e,t);switch(this._settings.client_authentication){case"client_secret_basic":if(!o)throw a.throw(Error("A client_secret is required")),null;t=T.generateBasicAuth(i,o);break;case"client_secret_post":l.append("client_id",i),o&&l.append("client_secret",o)}let c=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");let d=await this._jsonService.postForm(c,{body:l,basicAuth:t,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),d}async exchangeCredentials(e){let t,{grant_type:r="password",client_id:n=this._settings.client_id,client_secret:i=this._settings.client_secret,scope:o=this._settings.scope,...s}=e,a=this._logger.create("exchangeCredentials");n||a.throw(Error("A client_id is required"));let l=new URLSearchParams({grant_type:r,scope:o});for(let[e,t]of Object.entries(s))null!=t&&l.set(e,t);switch(this._settings.client_authentication){case"client_secret_basic":if(!i)throw a.throw(Error("A client_secret is required")),null;t=T.generateBasicAuth(n,i);break;case"client_secret_post":l.append("client_id",n),i&&l.append("client_secret",i)}let c=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");let d=await this._jsonService.postForm(c,{body:l,basicAuth:t,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),d}async exchangeRefreshToken(e){let t,{grant_type:r="refresh_token",client_id:n=this._settings.client_id,client_secret:i=this._settings.client_secret,timeoutInSeconds:o,...s}=e,a=this._logger.create("exchangeRefreshToken");n||a.throw(Error("A client_id is required")),s.refresh_token||a.throw(Error("A refresh_token is required"));let l=new URLSearchParams({grant_type:r});for(let[e,t]of Object.entries(s))Array.isArray(t)?t.forEach(t=>l.append(e,t)):null!=t&&l.set(e,t);switch(this._settings.client_authentication){case"client_secret_basic":if(!i)throw a.throw(Error("A client_secret is required")),null;t=T.generateBasicAuth(n,i);break;case"client_secret_post":l.append("client_id",n),i&&l.append("client_secret",i)}let c=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");let d=await this._jsonService.postForm(c,{body:l,basicAuth:t,timeoutInSeconds:o,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),d}async revoke(e){var t;let r=this._logger.create("revoke");e.token||r.throw(Error("A token is required"));let n=await this._metadataService.getRevocationEndpoint(!1);r.debug("got revocation endpoint, revoking ".concat(null!=(t=e.token_type_hint)?t:"default token type"));let i=new URLSearchParams;for(let[t,r]of Object.entries(e))null!=r&&i.set(t,r);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i}),r.debug("got response")}constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new _("TokenClient"),this._jsonService=new L(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}},Y=class{async validateSigninResponse(e,t){let r=this._logger.create("validateSigninResponse");this._processSigninState(e,t),r.debug("state processed"),await this._processCode(e,t),r.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,null==t?void 0:t.skipUserInfo,e.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(e,t){let r=this._logger.create("validateCredentialsResponse");e.isOpenId&&e.id_token&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t,e.isOpenId),r.debug("claims processed")}async validateRefreshResponse(e,t){var r,n;let i=this._logger.create("validateRefreshResponse");e.userState=t.data,null!=(r=e.session_state)||(e.session_state=t.session_state),null!=(n=e.scope)||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),i.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);let o=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,o),i.debug("claims processed")}validateSignoutResponse(e,t){let r=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&r.throw(Error("State does not match")),r.debug("state validated"),e.userState=t.data,e.error)throw r.warn("Response was error",e.error),new A(e)}_processSigninState(e,t){var r;let n=this._logger.create("_processSigninState");if(t.id!==e.state&&n.throw(Error("State does not match")),t.client_id||n.throw(Error("No client_id on state")),t.authority||n.throw(Error("No authority on state")),this._settings.authority!==t.authority&&n.throw(Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&n.throw(Error("client_id mismatch on settings vs. signin state")),n.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,null!=(r=e.scope)||(e.scope=t.scope),e.error)throw n.warn("Response was error",e.error),new A(e);t.code_verifier&&!e.code&&n.throw(Error("Expected code in response"))}async _processClaims(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token){n.debug("not loading user info");return}n.debug("loading user info");let i=await this._userInfoService.getClaims(e.access_token);n.debug("user info claims received from user info endpoint"),r&&i.sub!==e.profile.sub&&n.throw(Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t){let r=this._logger.create("_processCode");if(e.code){r.debug("Validating code");let n=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,...t.extraTokenParams});Object.assign(e,n)}else r.debug("No code to process")}_validateIdTokenAttributes(e,t){var r;let n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");let i=R.decode(null!=(r=e.id_token)?r:"");if(i.sub||n.throw(Error("ID Token is missing a subject claim")),t){let e=R.decode(t);i.sub!==e.sub&&n.throw(Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==e.auth_time&&n.throw(Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==e.azp&&n.throw(Error("azp in id_token does not match original azp")),!i.azp&&e.azp&&n.throw(Error("azp not in id_token, but present in original id_token"))}e.profile=i}constructor(e,t,r){this._settings=e,this._metadataService=t,this._claimsService=r,this._logger=new _("ResponseValidator"),this._userInfoService=new z(this._settings,this._metadataService),this._tokenClient=new J(this._settings,this._metadataService)}},Q=class{toStorageString(){return new _("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return _.createStatic("State","fromStorageString"),new Q(JSON.parse(e))}static async clearStaleState(e,t){let r=_.createStatic("State","clearStaleState"),n=k.getEpochTime()-t,i=await e.getAllKeys();r.debug("got keys",i);for(let t=0;t<i.length;t++){let o=i[t],s=await e.get(o),a=!1;if(s)try{let e=Q.fromStorageString(s);r.debug("got item from key:",o,e.created),e.created<=n&&(a=!0)}catch(e){r.error("Error parsing state for key:",o,e),a=!0}else r.debug("no item in storage for key:",o),a=!0;a&&(r.debug("removed item for key:",o),e.remove(o))}}constructor(e){this.id=e.id||T.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=k.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}},X=class extends Q{toStorageString(){return new _("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){return _.createStatic("SigninState","fromStorageString"),new X(JSON.parse(e))}constructor(e){super(e),!0===e.code_verifier?this.code_verifier=T.generateCodeVerifier():e.code_verifier&&(this.code_verifier=e.code_verifier),this.code_verifier&&(this.code_challenge=T.generateCodeChallenge(this.code_verifier)),this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}},$=class{constructor({url:e,authority:t,client_id:r,redirect_uri:n,response_type:i,scope:o,state_data:s,response_mode:a,request_type:l,client_secret:c,nonce:d,url_state:u,resource:h,skipUserInfo:p,extraQueryParams:f,extraTokenParams:g,disablePKCE:m,...v}){if(this._logger=new _("SigninRequest"),!e)throw this._logger.error("ctor: No url passed"),Error("url");if(!r)throw this._logger.error("ctor: No client_id passed"),Error("client_id");if(!n)throw this._logger.error("ctor: No redirect_uri passed"),Error("redirect_uri");if(!i)throw this._logger.error("ctor: No response_type passed"),Error("response_type");if(!o)throw this._logger.error("ctor: No scope passed"),Error("scope");if(!t)throw this._logger.error("ctor: No authority passed"),Error("authority");this.state=new X({data:s,request_type:l,url_state:u,code_verifier:!m,client_id:r,authority:t,redirect_uri:n,response_mode:a,client_secret:c,scope:o,extraTokenParams:g,skipUserInfo:p});let y=new URL(e);y.searchParams.append("client_id",r),y.searchParams.append("redirect_uri",n),y.searchParams.append("response_type",i),y.searchParams.append("scope",o),d&&y.searchParams.append("nonce",d);let b=this.state.id;for(let[e,t]of(u&&(b="".concat(b).concat(P).concat(u)),y.searchParams.append("state",b),this.state.code_challenge&&(y.searchParams.append("code_challenge",this.state.code_challenge),y.searchParams.append("code_challenge_method","S256")),h&&(Array.isArray(h)?h:[h]).forEach(e=>y.searchParams.append("resource",e)),Object.entries({response_mode:a,...v,...f})))null!=t&&y.searchParams.append(e,t.toString());this.url=y.href}},Z="openid",ee=class{get expires_in(){if(void 0!==this.expires_at)return this.expires_at-k.getEpochTime()}set expires_in(e){"string"==typeof e&&(e=Number(e)),void 0!==e&&e>=0&&(this.expires_at=Math.floor(e)+k.getEpochTime())}get isOpenId(){var e;return(null==(e=this.scope)?void 0:e.split(" ").includes(Z))||!!this.id_token}constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){let e=decodeURIComponent(this.state).split(P);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(P))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}},et=class{constructor({url:e,state_data:t,id_token_hint:r,post_logout_redirect_uri:n,extraQueryParams:i,request_type:o,client_id:s}){if(this._logger=new _("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),Error("url");let a=new URL(e);for(let[e,l]of(r&&a.searchParams.append("id_token_hint",r),s&&a.searchParams.append("client_id",s),n&&(a.searchParams.append("post_logout_redirect_uri",n),t&&(this.state=new Q({data:t,request_type:o}),a.searchParams.append("state",this.state.id))),Object.entries({...i})))null!=l&&a.searchParams.append(e,l.toString());this.url=a.href}},er=class{constructor(e){this.state=e.get("state"),this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},en=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],ei=["sub","iss","aud","exp","iat"],eo=class{filterProtocolClaims(e){let t={...e};if(this._settings.filterProtocolClaims){let e;for(let r of e=Array.isArray(this._settings.filterProtocolClaims)?this._settings.filterProtocolClaims:en)ei.includes(r)||delete t[r]}return t}mergeClaims(e,t){let r={...e};for(let[e,n]of Object.entries(t))for(let t of Array.isArray(n)?n:[n]){let n=r[e];void 0===n?r[e]=t:Array.isArray(n)?n.includes(t)||n.push(t):r[e]!==t&&("object"==typeof t&&this._settings.mergeClaims?r[e]=this.mergeClaims(n,t):r[e]=[n,t])}return r}constructor(e){this._settings=e,this._logger=new _("ClaimsService")}},es=class{async createSigninRequest(e){let{state:t,request:r,request_uri:n,request_type:i,id_token_hint:o,login_hint:s,skipUserInfo:a,nonce:l,url_state:c,response_type:d=this.settings.response_type,scope:u=this.settings.scope,redirect_uri:h=this.settings.redirect_uri,prompt:p=this.settings.prompt,display:f=this.settings.display,max_age:g=this.settings.max_age,ui_locales:m=this.settings.ui_locales,acr_values:v=this.settings.acr_values,resource:y=this.settings.resource,response_mode:b=this.settings.response_mode,extraQueryParams:S=this.settings.extraQueryParams,extraTokenParams:E=this.settings.extraTokenParams}=e,_=this._logger.create("createSigninRequest");if("code"!==d)throw Error("Only the Authorization Code flow (with PKCE) is supported");let w=await this.metadataService.getAuthorizationEndpoint();_.debug("Received authorization endpoint",w);let T=new $({url:w,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:h,response_type:d,scope:u,state_data:t,url_state:c,prompt:p,display:f,max_age:g,ui_locales:m,id_token_hint:o,login_hint:s,acr_values:v,resource:y,request:r,request_uri:n,extraQueryParams:S,extraTokenParams:E,request_type:i,response_mode:b,client_secret:this.settings.client_secret,skipUserInfo:a,nonce:l,disablePKCE:this.settings.disablePKCE});await this.clearStaleState();let I=T.state;return await this.settings.stateStore.set(I.id,I.toStorageString()),T}async readSigninResponseState(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._logger.create("readSigninResponseState"),n=new ee(M.readParams(e,this.settings.response_mode));if(!n.state)throw r.throw(Error("No state in response")),null;let i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(Error("No matching state found in storage")),null;return{state:X.fromStorageString(i),response:n}}async processSigninResponse(e){let t=this._logger.create("processSigninResponse"),{state:r,response:n}=await this.readSigninResponseState(e,!0);return t.debug("received state from storage; validating response"),await this._validator.validateSigninResponse(n,r),n}async processResourceOwnerPasswordCredentials(e){let{username:t,password:r,skipUserInfo:n=!1,extraTokenParams:i={}}=e,o=await this._tokenClient.exchangeCredentials({username:t,password:r,...i}),s=new ee(new URLSearchParams);return Object.assign(s,o),await this._validator.validateCredentialsResponse(s,n),s}async useRefreshToken(e){var t;let r,{state:n,timeoutInSeconds:i}=e,o=this._logger.create("useRefreshToken");if(void 0===this.settings.refreshTokenAllowedScope)r=n.scope;else{let e=this.settings.refreshTokenAllowedScope.split(" ");r=((null==(t=n.scope)?void 0:t.split(" "))||[]).filter(t=>e.includes(t)).join(" ")}let s=await this._tokenClient.exchangeRefreshToken({refresh_token:n.refresh_token,resource:n.resource,scope:r,timeoutInSeconds:i}),a=new ee(new URLSearchParams);return Object.assign(a,s),o.debug("validating response",a),await this._validator.validateRefreshResponse(a,{...n,scope:r}),a}async createSignoutRequest(){let{state:e,id_token_hint:t,client_id:r,request_type:n,post_logout_redirect_uri:i=this.settings.post_logout_redirect_uri,extraQueryParams:o=this.settings.extraQueryParams}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=this._logger.create("createSignoutRequest"),a=await this.metadataService.getEndSessionEndpoint();if(!a)throw s.throw(Error("No end session endpoint")),null;s.debug("Received end session endpoint",a),r||!i||t||(r=this.settings.client_id);let l=new et({url:a,id_token_hint:t,client_id:r,post_logout_redirect_uri:i,state_data:e,extraQueryParams:o,request_type:n});await this.clearStaleState();let c=l.state;return c&&(s.debug("Signout request has state to persist"),await this.settings.stateStore.set(c.id,c.toStorageString())),l}async readSignoutResponseState(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._logger.create("readSignoutResponseState"),n=new er(M.readParams(e,this.settings.response_mode));if(!n.state){if(r.debug("No state in response"),n.error)throw r.warn("Response was error:",n.error),new A(n);return{state:void 0,response:n}}let i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(Error("No matching state found in storage")),null;return{state:Q.fromStorageString(i),response:n}}async processSignoutResponse(e){let t=this._logger.create("processSignoutResponse"),{state:r,response:n}=await this.readSignoutResponseState(e,!0);return r?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,r)):t.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),Q.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}constructor(e,t){this._logger=new _("OidcClient"),this.settings=e instanceof H?e:new H(e),this.metadataService=null!=t?t:new N(this.settings),this._claimsService=new eo(this.settings),this._validator=new Y(this.settings,this.metadataService,this._claimsService),this._tokenClient=new J(this.settings,this.metadataService)}},ea=class{async _init(){this._logger.create("_init");let e=await this._userManager.getUser();if(e)this._start(e);else if(this._userManager.settings.monitorAnonymousSession){let e=await this._userManager.querySessionStatus();if(e){let t={session_state:e.session_state,profile:e.sub&&e.sid?{sub:e.sub,sid:e.sid}:null};this._start(t)}}}constructor(e){this._userManager=e,this._logger=new _("SessionMonitor"),this._start=async e=>{let t=e.session_state;if(!t)return;let r=this._logger.create("_start");if(e.profile?(this._sub=e.profile.sub,this._sid=e.profile.sid,r.debug("session_state",t,", sub",this._sub)):(this._sub=void 0,this._sid=void 0,r.debug("session_state",t,", anonymous user")),this._checkSessionIFrame){this._checkSessionIFrame.start(t);return}try{let e=await this._userManager.metadataService.getCheckSessionIframe();if(e){r.debug("initializing check session iframe");let n=this._userManager.settings.client_id,i=this._userManager.settings.checkSessionIntervalInSeconds,o=this._userManager.settings.stopCheckSessionOnError,s=new j(this._callback,n,e,i,o);await s.load(),this._checkSessionIFrame=s,s.start(t)}else r.warn("no check session iframe found in the metadata")}catch(e){r.error("Error from getCheckSessionIframe:",e instanceof Error?e.message:e)}},this._stop=()=>{let e=this._logger.create("_stop");if(this._sub=void 0,this._sid=void 0,this._checkSessionIFrame&&this._checkSessionIFrame.stop(),this._userManager.settings.monitorAnonymousSession){let t=setInterval(async()=>{clearInterval(t);try{let e=await this._userManager.querySessionStatus();if(e){let t={session_state:e.session_state,profile:e.sub&&e.sid?{sub:e.sub,sid:e.sid}:null};this._start(t)}}catch(t){e.error("error from querySessionStatus",t instanceof Error?t.message:t)}},1e3)}},this._callback=async()=>{let e=this._logger.create("_callback");try{let t=await this._userManager.querySessionStatus(),r=!0;t&&this._checkSessionIFrame?t.sub===this._sub?(r=!1,this._checkSessionIFrame.start(t.session_state),t.sid===this._sid?e.debug("same sub still logged in at OP, restarting check session iframe; session_state",t.session_state):(e.debug("same sub still logged in at OP, session state has changed, restarting check session iframe; session_state",t.session_state),this._userManager.events._raiseUserSessionChanged())):e.debug("different subject signed into OP",t.sub):e.debug("subject no longer signed into OP"),r?this._sub?this._userManager.events._raiseUserSignedOut():this._userManager.events._raiseUserSignedIn():e.debug("no change in session detected, no event to raise")}catch(t){this._sub&&(e.debug("Error calling queryCurrentSigninSession; raising signed out event",t),this._userManager.events._raiseUserSignedOut())}},e||this._logger.throw(Error("No user manager passed")),this._userManager.events.addUserLoaded(this._start),this._userManager.events.addUserUnloaded(this._stop),this._init().catch(e=>{this._logger.error(e)})}},el=class{get expires_in(){if(void 0!==this.expires_at)return this.expires_at-k.getEpochTime()}set expires_in(e){void 0!==e&&(this.expires_at=Math.floor(e)+k.getEpochTime())}get expired(){let e=this.expires_in;if(void 0!==e)return e<=0}get scopes(){var e,t;return null!=(t=null==(e=this.scope)?void 0:e.split(" "))?t:[]}toStorageString(){return new _("User").create("toStorageString"),JSON.stringify({id_token:this.id_token,session_state:this.session_state,access_token:this.access_token,refresh_token:this.refresh_token,token_type:this.token_type,scope:this.scope,profile:this.profile,expires_at:this.expires_at})}static fromStorageString(e){return _.createStatic("User","fromStorageString"),new el(JSON.parse(e))}constructor(e){var t;this.id_token=e.id_token,this.session_state=null!=(t=e.session_state)?t:null,this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.token_type=e.token_type,this.scope=e.scope,this.profile=e.profile,this.expires_at=e.expires_at,this.state=e.userState,this.url_state=e.url_state}},ec="oidc-client",ed=class{async navigate(e){let t=this._logger.create("navigate");if(!this._window)throw Error("Attempted to navigate on a disposed window");t.debug("setting URL in window"),this._window.location.replace(e.url);let{url:r,keepOpen:n}=await new Promise((r,n)=>{let i=i=>{var o;let s=i.data,a=null!=(o=e.scriptOrigin)?o:window.location.origin;if(i.origin===a&&(null==s?void 0:s.source)===ec){try{let r=M.readParams(s.url,e.response_mode).get("state");if(r||t.warn("no state found in response url"),i.source!==this._window&&r!==e.state)return}catch(e){this._dispose(),n(Error("Invalid response from window"))}r(s)}};window.addEventListener("message",i,!1),this._disposeHandlers.add(()=>window.removeEventListener("message",i,!1)),this._disposeHandlers.add(this._abort.addHandler(e=>{this._dispose(),n(e)}))});return t.debug("got response from window"),this._dispose(),n||this.close(),{url:r}}_dispose(){for(let e of(this._logger.create("_dispose"),this._disposeHandlers))e();this._disposeHandlers.clear()}static _notifyParent(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:window.location.origin;e.postMessage({source:ec,url:t,keepOpen:r},n)}constructor(){this._abort=new I("Window navigation aborted"),this._disposeHandlers=new Set,this._window=null}},eu={location:!1,toolbar:!1,height:640,closePopupWindowAfterInSeconds:-1},eh="_blank",ep=60,ef=2,eg=10,em=class extends H{constructor(e){let{popup_redirect_uri:t=e.redirect_uri,popup_post_logout_redirect_uri:r=e.post_logout_redirect_uri,popupWindowFeatures:n=eu,popupWindowTarget:i=eh,redirectMethod:o="assign",redirectTarget:s="self",iframeNotifyParentOrigin:a=e.iframeNotifyParentOrigin,iframeScriptOrigin:l=e.iframeScriptOrigin,silent_redirect_uri:c=e.redirect_uri,silentRequestTimeoutInSeconds:d=eg,automaticSilentRenew:u=!0,validateSubOnSilentRenew:h=!0,includeIdTokenInSilentRenew:p=!1,monitorSession:f=!1,monitorAnonymousSession:g=!1,checkSessionIntervalInSeconds:m=ef,query_status_response_type:v="code",stopCheckSessionOnError:y=!0,revokeTokenTypes:b=["access_token","refresh_token"],revokeTokensOnSignout:S=!1,includeIdTokenInSilentSignout:E=!1,accessTokenExpiringNotificationTimeInSeconds:_=ep,userStore:w}=e;if(super(e),this.popup_redirect_uri=t,this.popup_post_logout_redirect_uri=r,this.popupWindowFeatures=n,this.popupWindowTarget=i,this.redirectMethod=o,this.redirectTarget=s,this.iframeNotifyParentOrigin=a,this.iframeScriptOrigin=l,this.silent_redirect_uri=c,this.silentRequestTimeoutInSeconds=d,this.automaticSilentRenew=u,this.validateSubOnSilentRenew=h,this.includeIdTokenInSilentRenew=p,this.monitorSession=f,this.monitorAnonymousSession=g,this.checkSessionIntervalInSeconds=m,this.stopCheckSessionOnError=y,this.query_status_response_type=v,this.revokeTokenTypes=b,this.revokeTokensOnSignout=S,this.includeIdTokenInSilentSignout=E,this.accessTokenExpiringNotificationTimeInSeconds=_,w)this.userStore=w;else{let e=window.sessionStorage;this.userStore=new B({store:e})}}},ev=class extends ed{static createHiddenIframe(){let e=window.document.createElement("iframe");return e.style.visibility="hidden",e.style.position="fixed",e.style.left="-1000px",e.style.top="0",e.width="0",e.height="0",window.document.body.appendChild(e),e}async navigate(e){this._logger.debug("navigate: Using timeout of:",this._timeoutInSeconds);let t=setTimeout(()=>this._abort.raise(new D("IFrame timed out without a response")),1e3*this._timeoutInSeconds);return this._disposeHandlers.add(()=>clearTimeout(t)),await super.navigate(e)}close(){var e;this._frame&&(this._frame.parentNode&&(this._frame.addEventListener("load",e=>{var t;let r=e.target;null==(t=r.parentNode)||t.removeChild(r),this._abort.raise(Error("IFrame removed from DOM"))},!0),null==(e=this._frame.contentWindow)||e.location.replace("about:blank")),this._frame=null),this._window=null}static notifyParent(e,t){return super._notifyParent(window.parent,e,!1,t)}constructor({silentRequestTimeoutInSeconds:e=eg}){super(),this._logger=new _("IFrameWindow"),this._timeoutInSeconds=e,this._frame=ev.createHiddenIframe(),this._window=this._frame.contentWindow}},ey=class{async prepare(e){let{silentRequestTimeoutInSeconds:t=this._settings.silentRequestTimeoutInSeconds}=e;return new ev({silentRequestTimeoutInSeconds:t})}async callback(e){this._logger.create("callback"),ev.notifyParent(e,this._settings.iframeNotifyParentOrigin)}constructor(e){this._settings=e,this._logger=new _("IFrameNavigator")}},eb=500,eS=1e3,eE=class extends ed{async navigate(e){var t;null==(t=this._window)||t.focus();let r=setInterval(()=>{(!this._window||this._window.closed)&&this._abort.raise(Error("Popup closed by user"))},eb);return this._disposeHandlers.add(()=>clearInterval(r)),await super.navigate(e)}close(){this._window&&!this._window.closed&&(this._window.close(),this._abort.raise(Error("Popup closed"))),this._window=null}static notifyOpener(e,t){if(!window.opener)throw Error("No window.opener. Can't complete notification.");return super._notifyParent(window.opener,e,t)}constructor({popupWindowTarget:e=eh,popupWindowFeatures:t={}}){super(),this._logger=new _("PopupWindow");let r=C.center({...eu,...t});this._window=window.open(void 0,e,C.serialize(r)),t.closePopupWindowAfterInSeconds&&t.closePopupWindowAfterInSeconds>0&&setTimeout(()=>{if(!this._window||"boolean"!=typeof this._window.closed||this._window.closed){this._abort.raise(Error("Popup blocked by user"));return}this.close()},t.closePopupWindowAfterInSeconds*eS)}},e_=class{async prepare(e){let{popupWindowFeatures:t=this._settings.popupWindowFeatures,popupWindowTarget:r=this._settings.popupWindowTarget}=e;return new eE({popupWindowFeatures:t,popupWindowTarget:r})}async callback(e,t){let{keepOpen:r=!1}=t;this._logger.create("callback"),eE.notifyOpener(e,r)}constructor(e){this._settings=e,this._logger=new _("PopupNavigator")}},ew=class{async prepare(e){var t;let r,{redirectMethod:n=this._settings.redirectMethod,redirectTarget:i=this._settings.redirectTarget}=e;this._logger.create("prepare");let o=window.self;"top"===i&&(o=null!=(t=window.top)?t:window.self);let s=o.location[n].bind(o.location);return{navigate:async e=>{this._logger.create("navigate");let t=new Promise((e,t)=>{r=t});return s(e.url),await t},close:()=>{this._logger.create("close"),null==r||r(Error("Redirect aborted")),o.stop()}}}async callback(){}constructor(e){this._settings=e,this._logger=new _("RedirectNavigator")}},eT=class extends x{load(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];super.load(e),t&&this._userLoaded.raise(e)}unload(){super.unload(),this._userUnloaded.raise()}addUserLoaded(e){return this._userLoaded.addHandler(e)}removeUserLoaded(e){return this._userLoaded.removeHandler(e)}addUserUnloaded(e){return this._userUnloaded.addHandler(e)}removeUserUnloaded(e){return this._userUnloaded.removeHandler(e)}addSilentRenewError(e){return this._silentRenewError.addHandler(e)}removeSilentRenewError(e){return this._silentRenewError.removeHandler(e)}_raiseSilentRenewError(e){this._silentRenewError.raise(e)}addUserSignedIn(e){return this._userSignedIn.addHandler(e)}removeUserSignedIn(e){this._userSignedIn.removeHandler(e)}_raiseUserSignedIn(){this._userSignedIn.raise()}addUserSignedOut(e){return this._userSignedOut.addHandler(e)}removeUserSignedOut(e){this._userSignedOut.removeHandler(e)}_raiseUserSignedOut(){this._userSignedOut.raise()}addUserSessionChanged(e){return this._userSessionChanged.addHandler(e)}removeUserSessionChanged(e){this._userSessionChanged.removeHandler(e)}_raiseUserSessionChanged(){this._userSessionChanged.raise()}constructor(e){super({expiringNotificationTimeInSeconds:e.accessTokenExpiringNotificationTimeInSeconds}),this._logger=new _("UserManagerEvents"),this._userLoaded=new I("User loaded"),this._userUnloaded=new I("User unloaded"),this._silentRenewError=new I("Silent renew error"),this._userSignedIn=new I("User signed in"),this._userSignedOut=new I("User signed out"),this._userSessionChanged=new I("User session changed")}},eI=class{async start(){let e=this._logger.create("start");if(!this._isStarted){this._isStarted=!0,this._userManager.events.addAccessTokenExpiring(this._tokenExpiring),this._retryTimer.addHandler(this._tokenExpiring);try{await this._userManager.getUser()}catch(t){e.error("getUser error",t)}}}stop(){this._isStarted&&(this._retryTimer.cancel(),this._retryTimer.removeHandler(this._tokenExpiring),this._userManager.events.removeAccessTokenExpiring(this._tokenExpiring),this._isStarted=!1)}constructor(e){this._userManager=e,this._logger=new _("SilentRenewService"),this._isStarted=!1,this._retryTimer=new k("Retry Silent Renew"),this._tokenExpiring=async()=>{let e=this._logger.create("_tokenExpiring");try{await this._userManager.signinSilent(),e.debug("silent token renewal successful")}catch(t){if(t instanceof D){e.warn("ErrorTimeout from signinSilent:",t,"retry in 5s"),this._retryTimer.init(5);return}e.error("Error from signinSilent:",t),this._userManager.events._raiseSilentRenewError(t)}}}},eO=class{constructor(e,t){this.refresh_token=e.refresh_token,this.id_token=e.id_token,this.session_state=e.session_state,this.scope=e.scope,this.profile=e.profile,this.resource=t,this.data=e.state}},eR=class{get events(){return this._events}get metadataService(){return this._client.metadataService}async getUser(){let e=this._logger.create("getUser"),t=await this._loadUser();return t?(e.info("user loaded"),this._events.load(t,!1),t):(e.info("user not found in storage"),null)}async removeUser(){let e=this._logger.create("removeUser");await this.storeUser(null),e.info("user removed from storage"),this._events.unload()}async signinRedirect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._logger.create("signinRedirect");let{redirectMethod:t,...r}=e,n=await this._redirectNavigator.prepare({redirectMethod:t});await this._signinStart({request_type:"si:r",...r},n)}async signinRedirectCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=this._logger.create("signinRedirectCallback"),r=await this._signinEnd(e);return r.profile&&r.profile.sub?t.info("success, signed in subject",r.profile.sub):t.info("no subject"),r}async signinResourceOwnerCredentials(e){let{username:t,password:r,skipUserInfo:n=!1}=e,i=this._logger.create("signinResourceOwnerCredential"),o=await this._client.processResourceOwnerPasswordCredentials({username:t,password:r,skipUserInfo:n,extraTokenParams:this.settings.extraTokenParams});i.debug("got signin response");let s=await this._buildUser(o);return s.profile&&s.profile.sub?i.info("success, signed in subject",s.profile.sub):i.info("no subject"),s}async signinPopup(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._logger.create("signinPopup"),{popupWindowFeatures:r,popupWindowTarget:n,...i}=e,o=this.settings.popup_redirect_uri;o||t.throw(Error("No popup_redirect_uri configured"));let s=await this._popupNavigator.prepare({popupWindowFeatures:r,popupWindowTarget:n}),a=await this._signin({request_type:"si:p",redirect_uri:o,display:"popup",...i},s);return a&&(a.profile&&a.profile.sub?t.info("success, signed in subject",a.profile.sub):t.info("no subject")),a}async signinPopupCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._logger.create("signinPopupCallback");await this._popupNavigator.callback(e,{keepOpen:t}),r.info("success")}async signinSilent(){var e;let t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=this._logger.create("signinSilent"),{silentRequestTimeoutInSeconds:i,resource:o,...s}=r,a=await this._loadUser();if(null==a?void 0:a.refresh_token){n.debug("using refresh token");let e=new eO(a,o);return await this._useRefreshToken(e)}let l=this.settings.silent_redirect_uri;l||n.throw(Error("No silent_redirect_uri configured")),a&&this.settings.validateSubOnSilentRenew&&(n.debug("subject prior to silent renew:",a.profile.sub),t=a.profile.sub);let c=await this._iframeNavigator.prepare({silentRequestTimeoutInSeconds:i});return(a=await this._signin({request_type:"si:s",redirect_uri:l,prompt:"none",id_token_hint:this.settings.includeIdTokenInSilentRenew?null==a?void 0:a.id_token:void 0,...s},c,t))&&((null==(e=a.profile)?void 0:e.sub)?n.info("success, signed in subject",a.profile.sub):n.info("no subject")),a}async _useRefreshToken(e){let t=await this._client.useRefreshToken({state:e,timeoutInSeconds:this.settings.silentRequestTimeoutInSeconds}),r=new el({...e,...t});return await this.storeUser(r),this._events.load(r),r}async signinSilentCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=this._logger.create("signinSilentCallback");await this._iframeNavigator.callback(e),t.info("success")}async signinCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,{state:t}=await this._client.readSigninResponseState(e);switch(t.request_type){case"si:r":return await this.signinRedirectCallback(e);case"si:p":return await this.signinPopupCallback(e);case"si:s":return await this.signinSilentCallback(e);default:throw Error("invalid response_type in state")}}async signoutCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{state:r}=await this._client.readSignoutResponseState(e);if(r)switch(r.request_type){case"so:r":await this.signoutRedirectCallback(e);break;case"so:p":await this.signoutPopupCallback(e,t);break;case"so:s":await this.signoutSilentCallback(e);break;default:throw Error("invalid response_type in state")}}async querySessionStatus(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._logger.create("querySessionStatus"),{silentRequestTimeoutInSeconds:r,...n}=e,i=this.settings.silent_redirect_uri;i||t.throw(Error("No silent_redirect_uri configured"));let o=await this._loadUser(),s=await this._iframeNavigator.prepare({silentRequestTimeoutInSeconds:r}),a=await this._signinStart({request_type:"si:s",redirect_uri:i,prompt:"none",id_token_hint:this.settings.includeIdTokenInSilentRenew?null==o?void 0:o.id_token:void 0,response_type:this.settings.query_status_response_type,scope:"openid",skipUserInfo:!0,...n},s);try{let e=await this._client.processSigninResponse(a.url);if(t.debug("got signin response"),e.session_state&&e.profile.sub)return t.info("success for subject",e.profile.sub),{session_state:e.session_state,sub:e.profile.sub,sid:e.profile.sid};return t.info("success, user not authenticated"),null}catch(e){if(this.settings.monitorAnonymousSession&&e instanceof A)switch(e.error){case"login_required":case"consent_required":case"interaction_required":case"account_selection_required":return t.info("success for anonymous user"),{session_state:e.session_state}}throw e}}async _signin(e,t,r){let n=await this._signinStart(e,t);return await this._signinEnd(n.url,r)}async _signinStart(e,t){let r=this._logger.create("_signinStart");try{let n=await this._client.createSigninRequest(e);return r.debug("got signin request"),await t.navigate({url:n.url,state:n.state.id,response_mode:n.state.response_mode,scriptOrigin:this.settings.iframeScriptOrigin})}catch(e){throw r.debug("error after preparing navigator, closing navigator window"),t.close(),e}}async _signinEnd(e,t){let r=this._logger.create("_signinEnd"),n=await this._client.processSigninResponse(e);return r.debug("got signin response"),await this._buildUser(n,t)}async _buildUser(e,t){let r=this._logger.create("_buildUser"),n=new el(e);if(t){if(t!==n.profile.sub)throw r.debug("current user does not match user returned from signin. sub from signin:",n.profile.sub),new A({...e,error:"login_required"});r.debug("current user matches user returned from signin")}return await this.storeUser(n),r.debug("user stored"),this._events.load(n),n}async signoutRedirect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._logger.create("signoutRedirect"),{redirectMethod:r,...n}=e,i=await this._redirectNavigator.prepare({redirectMethod:r});await this._signoutStart({request_type:"so:r",post_logout_redirect_uri:this.settings.post_logout_redirect_uri,...n},i),t.info("success")}async signoutRedirectCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=this._logger.create("signoutRedirectCallback"),r=await this._signoutEnd(e);return t.info("success"),r}async signoutPopup(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._logger.create("signoutPopup"),{popupWindowFeatures:r,popupWindowTarget:n,...i}=e,o=this.settings.popup_post_logout_redirect_uri,s=await this._popupNavigator.prepare({popupWindowFeatures:r,popupWindowTarget:n});await this._signout({request_type:"so:p",post_logout_redirect_uri:o,state:null==o?void 0:{},...i},s),t.info("success")}async signoutPopupCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._logger.create("signoutPopupCallback");await this._popupNavigator.callback(e,{keepOpen:t}),r.info("success")}async _signout(e,t){let r=await this._signoutStart(e,t);return await this._signoutEnd(r.url)}async _signoutStart(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0,n=this._logger.create("_signoutStart");try{let i=await this._loadUser();n.debug("loaded current user from storage"),this.settings.revokeTokensOnSignout&&await this._revokeInternal(i);let o=t.id_token_hint||i&&i.id_token;o&&(n.debug("setting id_token_hint in signout request"),t.id_token_hint=o),await this.removeUser(),n.debug("user removed, creating signout request");let s=await this._client.createSignoutRequest(t);return n.debug("got signout request"),await r.navigate({url:s.url,state:null==(e=s.state)?void 0:e.id,scriptOrigin:this.settings.iframeScriptOrigin})}catch(e){throw n.debug("error after preparing navigator, closing navigator window"),r.close(),e}}async _signoutEnd(e){let t=this._logger.create("_signoutEnd"),r=await this._client.processSignoutResponse(e);return t.debug("got signout response"),r}async signoutSilent(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this._logger.create("signoutSilent"),{silentRequestTimeoutInSeconds:n,...i}=t,o=this.settings.includeIdTokenInSilentSignout?null==(e=await this._loadUser())?void 0:e.id_token:void 0,s=this.settings.popup_post_logout_redirect_uri,a=await this._iframeNavigator.prepare({silentRequestTimeoutInSeconds:n});await this._signout({request_type:"so:s",post_logout_redirect_uri:s,id_token_hint:o,...i},a),r.info("success")}async signoutSilentCallback(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,t=this._logger.create("signoutSilentCallback");await this._iframeNavigator.callback(e),t.info("success")}async revokeTokens(e){let t=await this._loadUser();await this._revokeInternal(t,e)}async _revokeInternal(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.settings.revokeTokenTypes,r=this._logger.create("_revokeInternal");if(!e)return;let n=t.filter(t=>"string"==typeof e[t]);if(!n.length){r.debug("no need to revoke due to no token(s)");return}for(let t of n)await this._client.revokeToken(e[t],t),r.info("".concat(t," revoked successfully")),"access_token"!==t&&(e[t]=null);await this.storeUser(e),r.debug("user stored"),this._events.load(e)}startSilentRenew(){this._logger.create("startSilentRenew"),this._silentRenewService.start()}stopSilentRenew(){this._silentRenewService.stop()}get _userStoreKey(){return"user:".concat(this.settings.authority,":").concat(this.settings.client_id)}async _loadUser(){let e=this._logger.create("_loadUser"),t=await this.settings.userStore.get(this._userStoreKey);return t?(e.debug("user storageString loaded"),el.fromStorageString(t)):(e.debug("no user storageString"),null)}async storeUser(e){let t=this._logger.create("storeUser");if(e){t.debug("storing user");let r=e.toStorageString();await this.settings.userStore.set(this._userStoreKey,r)}else this._logger.debug("removing user"),await this.settings.userStore.remove(this._userStoreKey)}async clearStaleState(){await this._client.clearStaleState()}constructor(e,t,r,n){this._logger=new _("UserManager"),this.settings=new em(e),this._client=new es(e),this._redirectNavigator=null!=t?t:new ew(this.settings),this._popupNavigator=null!=r?r:new e_(this.settings),this._iframeNavigator=null!=n?n:new ey(this.settings),this._events=new eT(this.settings),this._silentRenewService=new eI(this),this.settings.automaticSilentRenew&&this.startSilentRenew(),this._sessionMonitor=null,this.settings.monitorSession&&(this._sessionMonitor=new ea(this))}},eC="2.4.0"},42759:function(e,t,r){"use strict";let n=r(85266),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class o extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}let s=(e,t,r)=>{let n=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=n,e},a=e=>i.includes(e),l=(e,t)=>new Promise((r,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};let l=n.operation(t);l.attempt(async n=>{try{r(await e(n))}catch(e){if(!(e instanceof Error)){i(TypeError('Non-error was thrown: "'.concat(e,'". You should only throw errors.')));return}if(e instanceof o)l.stop(),i(e.originalError);else if(e instanceof TypeError&&!a(e.message))l.stop(),i(e);else{s(e,n,t);try{await t.onFailedAttempt(e)}catch(e){i(e);return}l.retry(e)||i(l.mainError())}}})});e.exports=l,e.exports.default=l,e.exports.AbortError=o},85266:function(e,t,r){"use strict";e.exports=r(34288)},34288:function(e,t,r){var n=r(44895);t.operation=function(e){return new n(t.timeouts(e),{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<t.retries;i++)n.push(this.createTimeout(i,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(i,t)),n.sort(function(e,t){return e-t}),n},t.createTimeout=function(e,t){return Math.min(Math.round((t.randomize?Math.random()+1:1)*Math.max(t.minTimeout,1)*Math.pow(t.factor,e)),t.maxTimeout)},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var i in n=[],e)"function"==typeof e[i]&&n.push(i);for(var o=0;o<n.length;o++){var s=n[o],a=e[s];e[s]=(function(n){var i=t.operation(r),o=Array.prototype.slice.call(arguments,1),s=o.pop();o.push(function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),s.apply(this,arguments))}),i.attempt(function(){n.apply(e,o)})}).bind(e,a),e[s].options=r}}},44895:function(e){"use strict";function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var i=this._errors[n],o=i.message,s=(e[o]||0)+1;e[o]=s,s>=r&&(t=i,r=s)}return t}},13629:function(e){"use strict";var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=(null!=e.raddr?" raddr %s rport %d":"%v%v")+(null!=e.tcptype?" tcptype %s":"%v"),null!=e.generation&&(t+=" generation %d"),t+=(null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){return"mediaclk:"+((null!=e.id?"id=%s %s":"%v%s")+(null!=e.mediaClockValue?"=%s":"")+(null!=e.rateNumerator?" rate=%s":""))+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach(function(e){t[e].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})},64109:function(e,t,r){var n=r(70585),i=r(53698);t.write=i,t.parse=n.parse,t.parseParams=n.parseParams,t.parseFmtpConfig=n.parseFmtpConfig,t.parsePayloads=n.parsePayloads,t.parseRemoteCandidates=n.parseRemoteCandidates,t.parseImageAttributes=n.parseImageAttributes,t.parseSimulcastStreamList=n.parseSimulcastStreamList},70585:function(e,t,r){var n=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,r,i){if(i&&!r)t[i]=n(e[1]);else for(var o=0;o<r.length;o+=1)null!=e[o+1]&&(t[r[o]]=n(e[o+1]))},o=function(e,t,r){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:n?t[e.name]:t;i(r.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},s=r(13629),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},r=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(a).forEach(function(e){var t=e[0],i=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),n=r[r.length-1]);for(var a=0;a<(s[t]||[]).length;a+=1){var l=s[t][a];if(l.reg.test(i))return o(l,n,i)}}),t.media=r,t};var l=function(e,t){var r=t.split(/=(.+)/,2);return 2===r.length?e[r[0]]=n(r[1]):1===r.length&&t.length>1&&(e[r[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(l,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],r=e.split(" ").map(n),i=0;i<r.length;i+=3)t.push({component:r[i],ip:r[i+1],port:r[i+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(l,{})})},t.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var t,r=!1;return"~"!==e[0]?t=n(e):(t=n(e.substring(1,e.length)),r=!0),{scid:t,paused:r}})})}},53698:function(e,t,r){"use strict";var n=r(13629),i=/%[sdv%]/g,o=function(e){var t=1,r=arguments,n=r.length;return e.replace(i,function(e){if(t>=n)return e;var i=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},s=function(e,t,r){var n=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var i=0;i<t.names.length;i+=1){var s=t.names[i];t.name?n.push(r[t.name][s]):n.push(r[t.names[i]])}else n.push(r[t.name]);return o.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],l=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var r=t.outerOrder||a,i=t.innerOrder||l,o=[];return r.forEach(function(t){n[t].forEach(function(r){r.name in e&&null!=e[r.name]?o.push(s(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){o.push(s(t,r,e))})})}),e.media.forEach(function(e){o.push(s("m",n.m[0],e)),i.forEach(function(t){n[t].forEach(function(r){r.name in e&&null!=e[r.name]?o.push(s(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){o.push(s(t,r,e))})})})}),o.join("\r\n")+"\r\n"}},97819:function(e,t,r){"use strict";var n=r(33211);function i(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var o=RegExp(Object.keys(n).map(i).join("|"),"g");function s(e){return n[e]}function a(e){return e.replace(o,s)}e.exports=a},2461:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"NIL",{enumerable:!0,get:function(){return a.default}}),Object.defineProperty(t,"parse",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(t,"stringify",{enumerable:!0,get:function(){return d.default}}),Object.defineProperty(t,"v1",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(t,"v3",{enumerable:!0,get:function(){return i.default}}),Object.defineProperty(t,"v4",{enumerable:!0,get:function(){return o.default}}),Object.defineProperty(t,"v5",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(t,"validate",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(t,"version",{enumerable:!0,get:function(){return l.default}});var n=h(r(16790)),i=h(r(76256)),o=h(r(17901)),s=h(r(39965)),a=h(r(2793)),l=h(r(10808)),c=h(r(9199)),d=h(r(22902)),u=h(r(97626));function h(e){return e&&e.__esModule?e:{default:e}}},93987:function(e,t){"use strict";function r(e){let t=[],r=32*e.length,n="0123456789abcdef";for(let i=0;i<r;i+=8){let r=e[i>>5]>>>i%32&255,o=parseInt(n.charAt(r>>>4&15)+n.charAt(15&r),16);t.push(o)}return t}function n(e){return(e+64>>>9<<4)+14+1}function i(e,t){e[t>>5]|=128<<t%32,e[n(t)-1]=t;let r=1732584193,i=-271733879,o=-1732584194,a=271733878;for(let t=0;t<e.length;t+=16){let n=r,l=i,p=o,f=a;r=c(r,i,o,a,e[t],7,-680876936),a=c(a,r,i,o,e[t+1],12,-389564586),o=c(o,a,r,i,e[t+2],17,606105819),i=c(i,o,a,r,e[t+3],22,-1044525330),r=c(r,i,o,a,e[t+4],7,-176418897),a=c(a,r,i,o,e[t+5],12,1200080426),o=c(o,a,r,i,e[t+6],17,-1473231341),i=c(i,o,a,r,e[t+7],22,-45705983),r=c(r,i,o,a,e[t+8],7,1770035416),a=c(a,r,i,o,e[t+9],12,-1958414417),o=c(o,a,r,i,e[t+10],17,-42063),i=c(i,o,a,r,e[t+11],22,-1990404162),r=c(r,i,o,a,e[t+12],7,1804603682),a=c(a,r,i,o,e[t+13],12,-40341101),o=c(o,a,r,i,e[t+14],17,-1502002290),i=c(i,o,a,r,e[t+15],22,1236535329),r=d(r,i,o,a,e[t+1],5,-165796510),a=d(a,r,i,o,e[t+6],9,-1069501632),o=d(o,a,r,i,e[t+11],14,643717713),i=d(i,o,a,r,e[t],20,-373897302),r=d(r,i,o,a,e[t+5],5,-701558691),a=d(a,r,i,o,e[t+10],9,38016083),o=d(o,a,r,i,e[t+15],14,-660478335),i=d(i,o,a,r,e[t+4],20,-405537848),r=d(r,i,o,a,e[t+9],5,568446438),a=d(a,r,i,o,e[t+14],9,-1019803690),o=d(o,a,r,i,e[t+3],14,-187363961),i=d(i,o,a,r,e[t+8],20,1163531501),r=d(r,i,o,a,e[t+13],5,-1444681467),a=d(a,r,i,o,e[t+2],9,-51403784),o=d(o,a,r,i,e[t+7],14,1735328473),i=d(i,o,a,r,e[t+12],20,-1926607734),r=u(r,i,o,a,e[t+5],4,-378558),a=u(a,r,i,o,e[t+8],11,-2022574463),o=u(o,a,r,i,e[t+11],16,1839030562),i=u(i,o,a,r,e[t+14],23,-35309556),r=u(r,i,o,a,e[t+1],4,-1530992060),a=u(a,r,i,o,e[t+4],11,1272893353),o=u(o,a,r,i,e[t+7],16,-155497632),i=u(i,o,a,r,e[t+10],23,-1094730640),r=u(r,i,o,a,e[t+13],4,681279174),a=u(a,r,i,o,e[t],11,-358537222),o=u(o,a,r,i,e[t+3],16,-722521979),i=u(i,o,a,r,e[t+6],23,76029189),r=u(r,i,o,a,e[t+9],4,-640364487),a=u(a,r,i,o,e[t+12],11,-421815835),o=u(o,a,r,i,e[t+15],16,530742520),i=u(i,o,a,r,e[t+2],23,-995338651),r=h(r,i,o,a,e[t],6,-198630844),a=h(a,r,i,o,e[t+7],10,1126891415),o=h(o,a,r,i,e[t+14],15,-1416354905),i=h(i,o,a,r,e[t+5],21,-57434055),r=h(r,i,o,a,e[t+12],6,1700485571),a=h(a,r,i,o,e[t+3],10,-1894986606),o=h(o,a,r,i,e[t+10],15,-1051523),i=h(i,o,a,r,e[t+1],21,-2054922799),r=h(r,i,o,a,e[t+8],6,1873313359),a=h(a,r,i,o,e[t+15],10,-30611744),o=h(o,a,r,i,e[t+6],15,-1560198380),i=h(i,o,a,r,e[t+13],21,1309151649),r=h(r,i,o,a,e[t+4],6,-145523070),a=h(a,r,i,o,e[t+11],10,-1120210379),o=h(o,a,r,i,e[t+2],15,718787259),i=h(i,o,a,r,e[t+9],21,-343485551),r=s(r,n),i=s(i,l),o=s(o,p),a=s(a,f)}return[r,i,o,a]}function o(e){if(0===e.length)return[];let t=8*e.length,r=new Uint32Array(n(t));for(let n=0;n<t;n+=8)r[n>>5]|=(255&e[n/8])<<n%32;return r}function s(e,t){let r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function a(e,t){return e<<t|e>>>32-t}function l(e,t,r,n,i,o){return s(a(s(s(t,e),s(n,o)),i),r)}function c(e,t,r,n,i,o,s){return l(t&r|~t&n,e,t,i,o,s)}function d(e,t,r,n,i,o,s){return l(t&n|r&~n,e,t,i,o,s)}function u(e,t,r,n,i,o,s){return l(t^r^n,e,t,i,o,s)}function h(e,t,r,n,i,o,s){return l(r^(t|~n),e,t,i,o,s)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var p=function(e){if("string"==typeof e){let t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(let r=0;r<t.length;++r)e[r]=t.charCodeAt(r)}return r(i(o(e),8*e.length))};t.default=p},14265:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};t.default=r},2793:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r="00000000-0000-0000-0000-000000000000";t.default=r},97626:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=i(r(9199));function i(e){return e&&e.__esModule?e:{default:e}}var o=function(e){let t;if(!(0,n.default)(e))throw TypeError("Invalid UUID");let r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r};t.default=o},25593:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;t.default=r},13189:function(e,t){"use strict";let r;Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;let n=new Uint8Array(16);function i(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(n)}},4682:function(e,t){"use strict";function r(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:case 3:return t^r^n;case 2:return t&r^t&n^r&n}}function n(e,t){return e<<t|e>>>32-t}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(e){let t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){let t=unescape(encodeURIComponent(e));e=[];for(let r=0;r<t.length;++r)e.push(t.charCodeAt(r))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);let o=Math.ceil((e.length/4+2)/16),s=Array(o);for(let t=0;t<o;++t){let r=new Uint32Array(16);for(let n=0;n<16;++n)r[n]=e[64*t+4*n]<<24|e[64*t+4*n+1]<<16|e[64*t+4*n+2]<<8|e[64*t+4*n+3];s[t]=r}s[o-1][14]=(e.length-1)*8/4294967296,s[o-1][14]=Math.floor(s[o-1][14]),s[o-1][15]=(e.length-1)*8&4294967295;for(let e=0;e<o;++e){let o=new Uint32Array(80);for(let t=0;t<16;++t)o[t]=s[e][t];for(let e=16;e<80;++e)o[e]=n(o[e-3]^o[e-8]^o[e-14]^o[e-16],1);let a=i[0],l=i[1],c=i[2],d=i[3],u=i[4];for(let e=0;e<80;++e){let i=Math.floor(e/20),s=n(a,5)+r(i,l,c,d)+u+t[i]+o[e]>>>0;u=d,d=c,c=n(l,30)>>>0,l=a,a=s}i[0]=i[0]+a>>>0,i[1]=i[1]+l>>>0,i[2]=i[2]+c>>>0,i[3]=i[3]+d>>>0,i[4]=i[4]+u>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,255&i[0],i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,255&i[1],i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,255&i[2],i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,255&i[3],i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,255&i[4]]};t.default=i},22902:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,t.unsafeStringify=s;var n=i(r(9199));function i(e){return e&&e.__esModule?e:{default:e}}let o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]}var a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=s(e,t);if(!(0,n.default)(r))throw TypeError("Stringified UUID is invalid");return r};t.default=a},16790:function(e,t,r){"use strict";let n,i;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=a(r(13189)),s=r(22902);function a(e){return e&&e.__esModule?e:{default:e}}let l=0,c=0;var d=function(e,t,r){let a=t&&r||0,d=t||Array(16),u=(e=e||{}).node||n,h=void 0!==e.clockseq?e.clockseq:i;if(null==u||null==h){let t=e.random||(e.rng||o.default)();null==u&&(u=n=[1|t[0],t[1],t[2],t[3],t[4],t[5]]),null==h&&(h=i=(t[6]<<8|t[7])&16383)}let p=void 0!==e.msecs?e.msecs:Date.now(),f=void 0!==e.nsecs?e.nsecs:c+1,g=p-l+(f-c)/1e4;if(g<0&&void 0===e.clockseq&&(h=h+1&16383),(g<0||p>l)&&void 0===e.nsecs&&(f=0),f>=1e4)throw Error("uuid.v1(): Can't create more than 10M uuids/sec");l=p,c=f,i=h;let m=((268435455&(p+=122192928e5))*1e4+f)%4294967296;d[a++]=m>>>24&255,d[a++]=m>>>16&255,d[a++]=m>>>8&255,d[a++]=255&m;let v=p/4294967296*1e4&268435455;d[a++]=v>>>8&255,d[a++]=255&v,d[a++]=v>>>24&15|16,d[a++]=v>>>16&255,d[a++]=h>>>8|128,d[a++]=255&h;for(let e=0;e<6;++e)d[a+e]=u[e];return t||(0,s.unsafeStringify)(d)};t.default=d},76256:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=o(r(61523)),i=o(r(93987));function o(e){return e&&e.__esModule?e:{default:e}}var s=(0,n.default)("v3",48,i.default);t.default=s},61523:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.URL=t.DNS=void 0,t.default=c;var n=r(22902),i=o(r(97626));function o(e){return e&&e.__esModule?e:{default:e}}function s(e){e=unescape(encodeURIComponent(e));let t=[];for(let r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}let a="6ba7b810-9dad-11d1-80b4-00c04fd430c8";t.DNS=a;let l="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function c(e,t,r){function o(e,o,a,l){var c;if("string"==typeof e&&(e=s(e)),"string"==typeof o&&(o=(0,i.default)(o)),(null===(c=o)||void 0===c?void 0:c.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let d=new Uint8Array(16+e.length);if(d.set(o),d.set(e,o.length),(d=r(d))[6]=15&d[6]|t,d[8]=63&d[8]|128,a){l=l||0;for(let e=0;e<16;++e)a[l+e]=d[e];return a}return(0,n.unsafeStringify)(d)}try{o.name=e}catch(e){}return o.DNS=a,o.URL=l,o}t.URL=l},17901:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=s(r(14265)),i=s(r(13189)),o=r(22902);function s(e){return e&&e.__esModule?e:{default:e}}var a=function(e,t,r){if(n.default.randomUUID&&!t&&!e)return n.default.randomUUID();let s=(e=e||{}).random||(e.rng||i.default)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=s[e];return t}return(0,o.unsafeStringify)(s)};t.default=a},39965:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=o(r(61523)),i=o(r(4682));function o(e){return e&&e.__esModule?e:{default:e}}var s=(0,n.default)("v5",80,i.default);t.default=s},9199:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=i(r(25593));function i(e){return e&&e.__esModule?e:{default:e}}var o=function(e){return"string"==typeof e&&n.default.test(e)};t.default=o},10808:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=i(r(9199));function i(e){return e&&e.__esModule?e:{default:e}}var o=function(e){if(!(0,n.default)(e))throw TypeError("Invalid UUID");return parseInt(e.slice(14,15),16)};t.default=o},13102:function(e,t,r){"use strict";var n=r(67699);function i(e,t,r){return(t=n(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}e.exports=i,e.exports.__esModule=!0,e.exports.default=e.exports},53058:function(e){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},14474:function(e,t,r){"use strict";var n=r(41304);function i(e,t){if(null==e)return{};var r,i,o=n(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)r=s[i],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}e.exports=i,e.exports.__esModule=!0,e.exports.default=e.exports},41304:function(e){"use strict";function t(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},42992:function(e,t,r){"use strict";var n=r(13776).default;function i(e,t){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=n(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}e.exports=i,e.exports.__esModule=!0,e.exports.default=e.exports},67699:function(e,t,r){"use strict";var n=r(13776).default,i=r(42992);function o(e){var t=i(e,"string");return"symbol"==n(t)?t:String(t)}e.exports=o,e.exports.__esModule=!0,e.exports.default=e.exports},13776:function(e){"use strict";function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},33211:function(e){"use strict";e.exports=JSON.parse('{"0":"O","1":"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","\uD805\uDCBF":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","\uD804\uDF00":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","\uD804\uDDCA":"̣","\uD805\uDCC3":"̣","\uD802\uDE3A":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ","ﱞ":"ﹲّ","ࣲ":"ٍ","ﱟ":"ﹴّ","ﳲ":"ﹷّ","ﱠ":"ﹶّ","ﳳ":"ﹹّ","ﱡ":"ﹸّ","ؚ":"ِ","̗":"ِ","ﳴ":"ﹻّ","ﱢ":"ﹺّ","ﱣ":"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","\uD805\uDCC1":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\\u2028":" ","\\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","\xa0":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","\xb8":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":","ː":":","ꓽ":":","⩴":"::=","⧴":":→","！":"!","ǃ":"!","ⵑ":"!","‼":"!!","⁉":"!?","ʔ":"?","Ɂ":"?","ॽ":"?","Ꭾ":"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","\uD834\uDD6D":".","․":".","܁":".","܂":".","꘎":".","\uD802\uDE50":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"\xb7","･":"\xb7","᛫":"\xb7","·":"\xb7","⸱":"\xb7","\uD800\uDD01":"\xb7","•":"\xb7","‧":"\xb7","∙":"\xb7","⋅":"\xb7","ꞏ":"\xb7","ᐧ":"\xb7","⋯":"\xb7\xb7\xb7","ⵈ":"\xb7\xb7\xb7","ᑄ":"\xb7<","⋗":"\xb7>","ᐷ":"\xb7>","ᑀ":"\xb7>","ᔯ":"\xb74","ᑾ":"\xb7b","ᒀ":"\xb7ḃ","ᑺ":"\xb7d","ᒘ":"\xb7J","ᒶ":"\xb7L","ᑶ":"\xb7P","ᑗ":"\xb7U","ᐺ":"\xb7V","ᐼ":"\xb7Ʌ","ᒮ":"\xb7Γ","ᐎ":"\xb7Δ","ᑙ":"\xb7Ո","ᐌ":"\xb7ᐁ","ᐐ":"\xb7ᐄ","ᐒ":"\xb7ᐅ","ᐔ":"\xb7ᐆ","ᐗ":"\xb7ᐊ","ᐙ":"\xb7ᐋ","ᐾ":"\xb7ᐲ","ᑂ":"\xb7ᐴ","ᑆ":"\xb7ᐹ","ᑛ":"\xb7ᑏ","ᑔ":"\xb7ᑐ","ᑝ":"\xb7ᑐ","ᑟ":"\xb7ᑑ","ᑡ":"\xb7ᑕ","ᑣ":"\xb7ᑖ","ᑴ":"\xb7ᑫ","ᑸ":"\xb7ᑮ","ᑼ":"\xb7ᑰ","ᒒ":"\xb7ᒉ","ᒔ":"\xb7ᒋ","ᒖ":"\xb7ᒌ","ᒚ":"\xb7ᒎ","ᒜ":"\xb7ᒐ","ᒞ":"\xb7ᒑ","ᒬ":"\xb7ᒣ","ᒰ":"\xb7ᒦ","ᒲ":"\xb7ᒧ","ᒴ":"\xb7ᒨ","ᒸ":"\xb7ᒫ","ᓉ":"\xb7ᓀ","ᣆ":"\xb7ᓂ","ᣈ":"\xb7ᓃ","ᣊ":"\xb7ᓄ","ᣌ":"\xb7ᓅ","ᓋ":"\xb7ᓇ","ᓍ":"\xb7ᓈ","ᓜ":"\xb7ᓓ","ᓞ":"\xb7ᓕ","ᓠ":"\xb7ᓖ","ᓢ":"\xb7ᓗ","ᓤ":"\xb7ᓘ","ᓦ":"\xb7ᓚ","ᓨ":"\xb7ᓛ","ᓶ":"\xb7ᓭ","ᓸ":"\xb7ᓯ","ᓺ":"\xb7ᓰ","ᓼ":"\xb7ᓱ","ᓾ":"\xb7ᓲ","ᔀ":"\xb7ᓴ","ᔂ":"\xb7ᓵ","ᔗ":"\xb7ᔐ","ᔙ":"\xb7ᔑ","ᔛ":"\xb7ᔒ","ᔝ":"\xb7ᔓ","ᔟ":"\xb7ᔔ","ᔡ":"\xb7ᔕ","ᔣ":"\xb7ᔖ","ᔱ":"\xb7ᔨ","ᔳ":"\xb7ᔩ","ᔵ":"\xb7ᔪ","ᔷ":"\xb7ᔫ","ᔹ":"\xb7ᔭ","ᔻ":"\xb7ᔮ","ᣎ":"\xb7ᕃ","ᣏ":"\xb7ᕆ","ᣐ":"\xb7ᕇ","ᣑ":"\xb7ᕈ","ᣒ":"\xb7ᕉ","ᣓ":"\xb7ᕋ","ᕎ":"\xb7ᕌ","ᕛ":"\xb7ᕚ","ᕨ":"\xb7ᕧ","ᢳ":"\xb7ᢱ","ᢶ":"\xb7ᢴ","ᢹ":"\xb7ᢸ","ᣂ":"\xb7ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","\uD802\uDE57":"\uD802\uDE56\uD802\uDE56","\uD805\uDC4C":"\uD805\uDC4B\uD805\uDC4B","\uD805\uDE42":"\uD805\uDE41\uD805\uDE41","\uD807\uDC42":"\uD807\uDC41\uD807\uDC41","᱿":"᱾᱾","՝":"\'","＇":"\'","‘":"\'","’":"\'","‛":"\'","′":"\'","‵":"\'","՚":"\'","׳":"\'","`":"\'","`":"\'","｀":"\'","\xb4":"\'","΄":"\'","´":"\'","᾽":"\'","᾿":"\'","῾":"\'","ʹ":"\'","ʹ":"\'","ˈ":"\'","ˊ":"\'","ˋ":"\'","˴":"\'","ʻ":"\'","ʽ":"\'","ʼ":"\'","ʾ":"\'","ꞌ":"\'","י":"\'","ߴ":"\'","ߵ":"\'","ᑊ":"\'","ᛌ":"\'","\uD81B\uDF51":"\'","\uD81B\uDF52":"\'","᳓":"\'\'","\\"":"\'\'","＂":"\'\'","“":"\'\'","”":"\'\'","‟":"\'\'","″":"\'\'","‶":"\'\'","〃":"\'\'","״":"\'\'","˝":"\'\'","ʺ":"\'\'","˶":"\'\'","ˮ":"\'\'","ײ":"\'\'","‴":"\'\'\'","‷":"\'\'\'","⁗":"\'\'\'\'","Ɓ":"\'B","Ɗ":"\'D","ŉ":"\'n","Ƥ":"\'P","Ƭ":"\'T","Ƴ":"\'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","\uD83C\uDD10":"(A)","⒝":"(b)","\uD83C\uDD11":"(B)","⒞":"(c)","\uD83C\uDD12":"(C)","⒟":"(d)","\uD83C\uDD13":"(D)","⒠":"(e)","\uD83C\uDD14":"(E)","⒡":"(f)","\uD83C\uDD15":"(F)","⒢":"(g)","\uD83C\uDD16":"(G)","⒣":"(h)","\uD83C\uDD17":"(H)","⒤":"(i)","⒥":"(j)","\uD83C\uDD19":"(J)","⒦":"(k)","\uD83C\uDD1A":"(K)","⑴":"(l)","\uD83C\uDD18":"(l)","⒧":"(l)","\uD83C\uDD1B":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","\uD83C\uDD1C":"(M)","⒩":"(n)","\uD83C\uDD1D":"(N)","⒪":"(o)","\uD83C\uDD1E":"(O)","⒫":"(p)","\uD83C\uDD1F":"(P)","⒬":"(q)","\uD83C\uDD20":"(Q)","⒭":"(r)","\uD83C\uDD21":"(R)","⒨":"(rn)","⒮":"(s)","\uD83C\uDD22":"(S)","\uD83C\uDD2A":"(S)","⒯":"(t)","\uD83C\uDD23":"(T)","⒰":"(u)","\uD83C\uDD24":"(U)","⒱":"(v)","\uD83C\uDD25":"(V)","⒲":"(w)","\uD83C\uDD26":"(W)","⒳":"(x)","\uD83C\uDD27":"(X)","⒴":"(y)","\uD83C\uDD28":"(Y)","⒵":"(z)","\uD83C\uDD29":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","\uD83C\uDE41":"(三)","㈨":"(九)","㈡":"(二)","\uD83C\uDE42":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","\uD83C\uDE47":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","\uD83C\uDE43":"(安)","\uD83C\uDE45":"(打)","\uD83C\uDE48":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","\uD83C\uDE40":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","\uD83C\uDE44":"(点)","㈵":"(特)","\uD83C\uDE46":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","\uD834\uDD14":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬","く":"❬","\uD847\uDFE8":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"\xb6","⁎":"*","٭":"*","∗":"*","\uD800\uDF1F":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","\uD834\uDE3A":"/","㇓":"/","〳":"/","Ⳇ":"/","ノ":"/","丿":"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\\\","﹨":"\\\\","∖":"\\\\","⟍":"\\\\","⧵":"\\\\","⧹":"\\\\","\uD834\uDE0F":"\\\\","\uD834\uDE3B":"\\\\","㇔":"\\\\","丶":"\\\\","⼂":"\\\\","⳹":"\\\\\\\\","⑊":"\\\\\\\\","⟈":"\\\\ᑕ","ꝸ":"&","૰":"॰","\uD804\uDCBB":"॰","\uD804\uDDC7":"॰","⚬":"॰","\uD804\uDDDB":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","\xaf":"ˉ","￣":"ˉ","▔":"ˉ","ъ":"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"\xb0","˚":"\xb0","∘":"\xb0","○":"\xb0","◦":"\xb0","⍜":"\xb0̲","⍤":"\xb0̈","℃":"\xb0C","℉":"\xb0F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"\xa9","Ⓡ":"\xae","Ⓟ":"℗","\uD834\uDE1B":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","\uD835\uDEDB":"∂","\uD835\uDF15":"∂","\uD835\uDF4F":"∂","\uD835\uDF89":"∂","\uD835\uDFC3":"∂","\uD83A\uDCCC":"∂","\uD83A\uDCCD":"∂̵","\xf0":"∂̵","⌀":"∅","\uD835\uDEC1":"∇","\uD835\uDEFB":"∇","\uD835\uDF35":"∇","\uD835\uDF6F":"∇","\uD835\uDFA9":"∇","\uD806\uDCA8":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","\uD800\uDE9B":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"\xf7","‹":"<","❮":"<","˂":"<","\uD834\uDE36":"<","ᐸ":"<","ᚲ":"<","⋖":"<\xb7","Ⲵ":"<\xb7","ᑅ":"<\xb7","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","\uD834\uDE37":">","ᐳ":">","\uD81B\uDF3F":">","ᑁ":">\xb7","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","\uD83A\uDCC8":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","\uD804\uDDDE":"≈","♎":"≏","\uD83D\uDF5E":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","\uD834\uDE38":"⊏","\uD834\uDE39":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","\uD83D\uDF71":"⊠","\uD83D\uDF55":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","\uD83D\uDF0A":"☩","\uD83C\uDF12":"☽","\uD83C\uDF19":"☽","⏾":"☾","\uD83C\uDF18":"☾","⧙":"⦚","\uD83D\uDF3A":"⧟","⨾":"⨟","\uD800\uDDA0":"⳨","♩":"\uD834\uDD58\uD834\uDD65","♪":"\uD834\uDD58\uD834\uDD65\uD834\uDD6E","⓪":"\uD83C\uDD0D","↺":"\uD83C\uDD0E","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー","ᅳ":"ー","ㅡ":"ー","一":"ー","⼀":"ー","ᆖ":"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ","ᆕ":"ーᅮ","ᅴ":"ー丨","ㅢ":"ー丨","ᆗ":"ー丨ᅮ","\uD83C\uDD0F":"$⃠","₤":"\xa3","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","\uD805\uDCD1":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","\uD835\uDFD0":"2","\uD835\uDFDA":"2","\uD835\uDFE4":"2","\uD835\uDFEE":"2","\uD835\uDFF8":"2","\uD83E\uDFF2":"2","Ꝛ":"2","Ƨ":"2","Ϩ":"2","Ꙅ":"2","ᒿ":"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","\uD805\uDCD2":"২","೨":"౨","②":"➁","ƻ":"2̵","\uD83C\uDD03":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","\uD834\uDE06":"3","\uD835\uDFD1":"3","\uD835\uDFDB":"3","\uD835\uDFE5":"3","\uD835\uDFEF":"3","\uD835\uDFF9":"3","\uD83E\uDFF3":"3","Ɜ":"3","Ȝ":"3","Ʒ":"3","Ꝫ":"3","Ⳍ":"3","З":"3","Ӡ":"3","\uD81B\uDF3B":"3","\uD806\uDCCA":"3","۳":"٣","\uD83A\uDCC9":"٣","૩":"३","③":"➂","Ҙ":"3̦","\uD83C\uDD04":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","\uD835\uDFD2":"4","\uD835\uDFDC":"4","\uD835\uDFE6":"4","\uD835\uDFF0":"4","\uD835\uDFFA":"4","\uD83E\uDFF4":"4","Ꮞ":"4","\uD806\uDCAF":"4","۴":"٤","૪":"४","④":"➃","\uD83C\uDD05":"4,","⒋":"4.","ᔰ":"4\xb7","㏣":"4日","㋃":"4月","㍜":"4点","\uD835\uDFD3":"5","\uD835\uDFDD":"5","\uD835\uDFE7":"5","\uD835\uDFF1":"5","\uD835\uDFFB":"5","\uD83E\uDFF5":"5","Ƽ":"5","\uD806\uDCBB":"5","⑤":"➄","\uD83C\uDD06":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","\uD835\uDFD4":"6","\uD835\uDFDE":"6","\uD835\uDFE8":"6","\uD835\uDFF2":"6","\uD835\uDFFC":"6","\uD83E\uDFF6":"6","Ⳓ":"6","б":"6","Ꮾ":"6","\uD806\uDCD5":"6","۶":"٦","\uD805\uDCD6":"৬","⑥":"➅","\uD83C\uDD07":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","\uD834\uDE12":"7","\uD835\uDFD5":"7","\uD835\uDFDF":"7","\uD835\uDFE9":"7","\uD835\uDFF3":"7","\uD835\uDFFD":"7","\uD83E\uDFF7":"7","\uD801\uDCD2":"7","\uD806\uDCC6":"7","⑦":"➆","\uD83C\uDD08":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","\uD83A\uDCCB":"8","\uD835\uDFD6":"8","\uD835\uDFE0":"8","\uD835\uDFEA":"8","\uD835\uDFF4":"8","\uD835\uDFFE":"8","\uD83E\uDFF8":"8","ȣ":"8","Ȣ":"8","\uD800\uDF1A":"8","૮":"८","⑧":"➇","\uD83C\uDD09":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","\uD835\uDFD7":"9","\uD835\uDFE1":"9","\uD835\uDFEB":"9","\uD835\uDFF5":"9","\uD835\uDFFF":"9","\uD83E\uDFF9":"9","Ꝯ":"9","Ⳋ":"9","\uD806\uDCCC":"9","\uD806\uDCAC":"9","\uD806\uDCD6":"9","१":"٩","\uD806\uDCE4":"٩","۹":"٩","೯":"౯","⑨":"➈","\uD83C\uDD0A":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a","ａ":"a","\uD835\uDC1A":"a","\uD835\uDC4E":"a","\uD835\uDC82":"a","\uD835\uDCB6":"a","\uD835\uDCEA":"a","\uD835\uDD1E":"a","\uD835\uDD52":"a","\uD835\uDD86":"a","\uD835\uDDBA":"a","\uD835\uDDEE":"a","\uD835\uDE22":"a","\uD835\uDE56":"a","\uD835\uDE8A":"a","ɑ":"a","α":"a","\uD835\uDEC2":"a","\uD835\uDEFC":"a","\uD835\uDF36":"a","\uD835\uDF70":"a","\uD835\uDFAA":"a","а":"a","ⷶ":"ͣ","Ａ":"A","\uD835\uDC00":"A","\uD835\uDC34":"A","\uD835\uDC68":"A","\uD835\uDC9C":"A","\uD835\uDCD0":"A","\uD835\uDD04":"A","\uD835\uDD38":"A","\uD835\uDD6C":"A","\uD835\uDDA0":"A","\uD835\uDDD4":"A","\uD835\uDE08":"A","\uD835\uDE3C":"A","\uD835\uDE70":"A","Α":"A","\uD835\uDEA8":"A","\uD835\uDEE2":"A","\uD835\uDF1C":"A","\uD835\uDF56":"A","\uD835\uDF90":"A","А":"A","Ꭺ":"A","ᗅ":"A","ꓮ":"A","\uD81B\uDF40":"A","\uD800\uDEA0":"A","⍶":"a̲","ǎ":"ă","Ǎ":"Ă","ȧ":"\xe5","Ȧ":"\xc5","ẚ":"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA","\xe6":"ae","ӕ":"ae","\xc6":"AE","Ӕ":"AE","ꜵ":"ao","Ꜵ":"AO","\uD83D\uDF07":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","\uD834\uDE17":"Ɐ","ᗄ":"Ɐ","ꓯ":"Ɐ","\uD801\uDC1F":"Ɒ","\uD835\uDC1B":"b","\uD835\uDC4F":"b","\uD835\uDC83":"b","\uD835\uDCB7":"b","\uD835\uDCEB":"b","\uD835\uDD1F":"b","\uD835\uDD53":"b","\uD835\uDD87":"b","\uD835\uDDBB":"b","\uD835\uDDEF":"b","\uD835\uDE23":"b","\uD835\uDE57":"b","\uD835\uDE8B":"b","Ƅ":"b","Ь":"b","Ꮟ":"b","ᑲ":"b","ᖯ":"b","Ｂ":"B","ℬ":"B","\uD835\uDC01":"B","\uD835\uDC35":"B","\uD835\uDC69":"B","\uD835\uDCD1":"B","\uD835\uDD05":"B","\uD835\uDD39":"B","\uD835\uDD6D":"B","\uD835\uDDA1":"B","\uD835\uDDD5":"B","\uD835\uDE09":"B","\uD835\uDE3D":"B","\uD835\uDE71":"B","Ꞵ":"B","Β":"B","\uD835\uDEA9":"B","\uD835\uDEE3":"B","\uD835\uDF1D":"B","\uD835\uDF57":"B","\uD835\uDF91":"B","В":"B","Ᏼ":"B","ᗷ":"B","ꓐ":"B","\uD800\uDE82":"B","\uD800\uDEA1":"B","\uD800\uDF01":"B","ɓ":"b̔","ᑳ":"ḃ","ƃ":"b̄","Ƃ":"b̄","Б":"b̄","ƀ":"b̵","ҍ":"b̵","Ҍ":"b̵","ѣ":"b̵","Ѣ":"b̵","ᑿ":"b\xb7","ᒁ":"ḃ\xb7","ᒈ":"b\'","Ы":"bl","в":"ʙ","ᏼ":"ʙ","ｃ":"c","ⅽ":"c","\uD835\uDC1C":"c","\uD835\uDC50":"c","\uD835\uDC84":"c","\uD835\uDCB8":"c","\uD835\uDCEC":"c","\uD835\uDD20":"c","\uD835\uDD54":"c","\uD835\uDD88":"c","\uD835\uDDBC":"c","\uD835\uDDF0":"c","\uD835\uDE24":"c","\uD835\uDE58":"c","\uD835\uDE8C":"c","ᴄ":"c","ϲ":"c","ⲥ":"c","с":"c","ꮯ":"c","\uD801\uDC3D":"c","ⷭ":"ͨ","\uD83D\uDF4C":"C","\uD806\uDCF2":"C","\uD806\uDCE9":"C","Ｃ":"C","Ⅽ":"C","ℂ":"C","ℭ":"C","\uD835\uDC02":"C","\uD835\uDC36":"C","\uD835\uDC6A":"C","\uD835\uDC9E":"C","\uD835\uDCD2":"C","\uD835\uDD6E":"C","\uD835\uDDA2":"C","\uD835\uDDD6":"C","\uD835\uDE0A":"C","\uD835\uDE3E":"C","\uD835\uDE72":"C","Ϲ":"C","Ⲥ":"C","С":"C","Ꮯ":"C","ꓚ":"C","\uD800\uDEA2":"C","\uD800\uDF02":"C","\uD801\uDC15":"C","\uD801\uDD1C":"C","\xa2":"c̸","ȼ":"c̸","₡":"C⃫","\uD83C\uDD6E":"C⃠","\xe7":"c̦","ҫ":"c̦","\xc7":"C̦","Ҫ":"C̦","Ƈ":"C\'","℅":"c/o","℆":"c/u","\uD83C\uDD6D":"㏄\\t⃝","⋴":"ꞓ","ɛ":"ꞓ","ε":"ꞓ","ϵ":"ꞓ","\uD835\uDEC6":"ꞓ","\uD835\uDEDC":"ꞓ","\uD835\uDF00":"ꞓ","\uD835\uDF16":"ꞓ","\uD835\uDF3A":"ꞓ","\uD835\uDF50":"ꞓ","\uD835\uDF74":"ꞓ","\uD835\uDF8A":"ꞓ","\uD835\uDFAE":"ꞓ","\uD835\uDFC4":"ꞓ","ⲉ":"ꞓ","є":"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","\uD806\uDCCE":"ꞓ","\uD801\uDC29":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ","Є":"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","\uD835\uDC1D":"d","\uD835\uDC51":"d","\uD835\uDC85":"d","\uD835\uDCB9":"d","\uD835\uDCED":"d","\uD835\uDD21":"d","\uD835\uDD55":"d","\uD835\uDD89":"d","\uD835\uDDBD":"d","\uD835\uDDF1":"d","\uD835\uDE25":"d","\uD835\uDE59":"d","\uD835\uDE8D":"d","ԁ":"d","Ꮷ":"d","ᑯ":"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","\uD835\uDC03":"D","\uD835\uDC37":"D","\uD835\uDC6B":"D","\uD835\uDC9F":"D","\uD835\uDCD3":"D","\uD835\uDD07":"D","\uD835\uDD3B":"D","\uD835\uDD6F":"D","\uD835\uDDA3":"D","\uD835\uDDD7":"D","\uD835\uDE0B":"D","\uD835\uDE3F":"D","\uD835\uDE73":"D","Ꭰ":"D","ᗞ":"D","ᗪ":"D","ꓓ":"D","ɗ":"d̔","ɖ":"d̨","ƌ":"d̄","đ":"d̵","Đ":"D̵","\xd0":"D̵","Ɖ":"D̵","₫":"ḏ̵","ꝺ":"Ꝺ","ᑻ":"d\xb7","ᒇ":"d\'","ʤ":"dȝ","ǳ":"dz","ʣ":"dz","ǲ":"Dz","Ǳ":"DZ","ǆ":"dž","ǅ":"Dž","Ǆ":"DŽ","ʥ":"dʑ","ꭰ":"ᴅ","⸹":"ẟ","δ":"ẟ","\uD835\uDEC5":"ẟ","\uD835\uDEFF":"ẟ","\uD835\uDF39":"ẟ","\uD835\uDF73":"ẟ","\uD835\uDFAD":"ẟ","ծ":"ẟ","ᕷ":"ẟ","℮":"e","ｅ":"e","ℯ":"e","ⅇ":"e","\uD835\uDC1E":"e","\uD835\uDC52":"e","\uD835\uDC86":"e","\uD835\uDCEE":"e","\uD835\uDD22":"e","\uD835\uDD56":"e","\uD835\uDD8A":"e","\uD835\uDDBE":"e","\uD835\uDDF2":"e","\uD835\uDE26":"e","\uD835\uDE5A":"e","\uD835\uDE8E":"e","ꬲ":"e","е":"e","ҽ":"e","ⷷ":"ͤ","⋿":"E","Ｅ":"E","ℰ":"E","\uD835\uDC04":"E","\uD835\uDC38":"E","\uD835\uDC6C":"E","\uD835\uDCD4":"E","\uD835\uDD08":"E","\uD835\uDD3C":"E","\uD835\uDD70":"E","\uD835\uDDA4":"E","\uD835\uDDD8":"E","\uD835\uDE0C":"E","\uD835\uDE40":"E","\uD835\uDE74":"E","Ε":"E","\uD835\uDEAC":"E","\uD835\uDEE6":"E","\uD835\uDF20":"E","\uD835\uDF5A":"E","\uD835\uDF94":"E","Е":"E","ⴹ":"E","Ꭼ":"E","ꓰ":"E","\uD806\uDCA6":"E","\uD806\uDCAE":"E","\uD800\uDE86":"E","ě":"ĕ","Ě":"Ĕ","ɇ":"e̸","Ɇ":"E̸","ҿ":"ę","ꭼ":"ᴇ","ə":"ǝ","ә":"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ","ɚ":"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵","Ә":"Ə","\uD834\uDE21":"Ɛ","ℇ":"Ɛ","Ԑ":"Ɛ","Ꮛ":"Ɛ","\uD81B\uDF2D":"Ɛ","\uD801\uDC01":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ","з":"ɜ","ҙ":"ɜ̦","\uD801\uDC42":"ɞ","ꞝ":"ʚ","\uD801\uDC2A":"ʚ","\uD835\uDC1F":"f","\uD835\uDC53":"f","\uD835\uDC87":"f","\uD835\uDCBB":"f","\uD835\uDCEF":"f","\uD835\uDD23":"f","\uD835\uDD57":"f","\uD835\uDD8B":"f","\uD835\uDDBF":"f","\uD835\uDDF3":"f","\uD835\uDE27":"f","\uD835\uDE5B":"f","\uD835\uDE8F":"f","ꬵ":"f","ꞙ":"f","ſ":"f","ẝ":"f","ք":"f","\uD834\uDE13":"F","ℱ":"F","\uD835\uDC05":"F","\uD835\uDC39":"F","\uD835\uDC6D":"F","\uD835\uDCD5":"F","\uD835\uDD09":"F","\uD835\uDD3D":"F","\uD835\uDD71":"F","\uD835\uDDA5":"F","\uD835\uDDD9":"F","\uD835\uDE0D":"F","\uD835\uDE41":"F","\uD835\uDE75":"F","Ꞙ":"F","Ϝ":"F","\uD835\uDFCA":"F","ᖴ":"F","ꓝ":"F","\uD806\uDCC2":"F","\uD806\uDCA2":"F","\uD800\uDE87":"F","\uD800\uDEA5":"F","\uD801\uDD25":"F","ƒ":"f̦","Ƒ":"F̦","ᵮ":"f̴","℻":"FAX","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ʩ":"fŋ","ᖵ":"Ⅎ","ꓞ":"Ⅎ","\uD834\uDE30":"ꟻ","ᖷ":"ꟻ","ｇ":"g","ℊ":"g","\uD835\uDC20":"g","\uD835\uDC54":"g","\uD835\uDC88":"g","\uD835\uDCF0":"g","\uD835\uDD24":"g","\uD835\uDD58":"g","\uD835\uDD8C":"g","\uD835\uDDC0":"g","\uD835\uDDF4":"g","\uD835\uDE28":"g","\uD835\uDE5C":"g","\uD835\uDE90":"g","ɡ":"g","ᶃ":"g","ƍ":"g","ց":"g","\uD835\uDC06":"G","\uD835\uDC3A":"G","\uD835\uDC6E":"G","\uD835\uDCA2":"G","\uD835\uDCD6":"G","\uD835\uDD0A":"G","\uD835\uDD3E":"G","\uD835\uDD72":"G","\uD835\uDDA6":"G","\uD835\uDDDA":"G","\uD835\uDE0E":"G","\uD835\uDE42":"G","\uD835\uDE76":"G","Ԍ":"G","Ꮐ":"G","Ᏻ":"G","ꓖ":"G","ᶢ":"ᵍ","ɠ":"g̔","ǧ":"ğ","Ǧ":"Ğ","ǵ":"ģ","ǥ":"g̵","Ǥ":"G̵","Ɠ":"G\'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ","ｈ":"h","ℎ":"h","\uD835\uDC21":"h","\uD835\uDC89":"h","\uD835\uDCBD":"h","\uD835\uDCF1":"h","\uD835\uDD25":"h","\uD835\uDD59":"h","\uD835\uDD8D":"h","\uD835\uDDC1":"h","\uD835\uDDF5":"h","\uD835\uDE29":"h","\uD835\uDE5D":"h","\uD835\uDE91":"h","һ":"h","հ":"h","Ꮒ":"h","Ｈ":"H","ℋ":"H","ℌ":"H","ℍ":"H","\uD835\uDC07":"H","\uD835\uDC3B":"H","\uD835\uDC6F":"H","\uD835\uDCD7":"H","\uD835\uDD73":"H","\uD835\uDDA7":"H","\uD835\uDDDB":"H","\uD835\uDE0F":"H","\uD835\uDE43":"H","\uD835\uDE77":"H","Η":"H","\uD835\uDEAE":"H","\uD835\uDEE8":"H","\uD835\uDF22":"H","\uD835\uDF5C":"H","\uD835\uDF96":"H","Ⲏ":"H","Н":"H","Ꮋ":"H","ᕼ":"H","ꓧ":"H","\uD800\uDECF":"H","ᵸ":"ᴴ","ɦ":"h̔","ꚕ":"h̔","Ᏺ":"h̔","Ⱨ":"H̩","Ң":"H̩","ħ":"h̵","ℏ":"h̵","ћ":"h̵","Ħ":"H̵","Ӊ":"H̦","Ӈ":"H̦","н":"ʜ","ꮋ":"ʜ","ң":"ʜ̩","ӊ":"ʜ̦","ӈ":"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ","Ꭸ":"Ⱶ","Ꮀ":"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i","ｉ":"i","ⅰ":"i","ℹ":"i","ⅈ":"i","\uD835\uDC22":"i","\uD835\uDC56":"i","\uD835\uDC8A":"i","\uD835\uDCBE":"i","\uD835\uDCF2":"i","\uD835\uDD26":"i","\uD835\uDD5A":"i","\uD835\uDD8E":"i","\uD835\uDDC2":"i","\uD835\uDDF6":"i","\uD835\uDE2A":"i","\uD835\uDE5E":"i","\uD835\uDE92":"i","ı":"i","\uD835\uDEA4":"i","ɪ":"i","ɩ":"i","ι":"i","ι":"i","ͺ":"i","\uD835\uDECA":"i","\uD835\uDF04":"i","\uD835\uDF3E":"i","\uD835\uDF78":"i","\uD835\uDFB2":"i","і":"i","ꙇ":"i","ӏ":"i","ꭵ":"i","Ꭵ":"i","\uD806\uDCC3":"i","ⓛ":"Ⓘ","⍸":"i̲","ǐ":"ĭ","Ǐ":"Ĭ","ɨ":"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii","ĳ":"ij","ⅳ":"iv","ⅸ":"ix","ｊ":"j","ⅉ":"j","\uD835\uDC23":"j","\uD835\uDC57":"j","\uD835\uDC8B":"j","\uD835\uDCBF":"j","\uD835\uDCF3":"j","\uD835\uDD27":"j","\uD835\uDD5B":"j","\uD835\uDD8F":"j","\uD835\uDDC3":"j","\uD835\uDDF7":"j","\uD835\uDE2B":"j","\uD835\uDE5F":"j","\uD835\uDE93":"j","ϳ":"j","ј":"j","Ｊ":"J","\uD835\uDC09":"J","\uD835\uDC3D":"J","\uD835\uDC71":"J","\uD835\uDCA5":"J","\uD835\uDCD9":"J","\uD835\uDD0D":"J","\uD835\uDD41":"J","\uD835\uDD75":"J","\uD835\uDDA9":"J","\uD835\uDDDD":"J","\uD835\uDE11":"J","\uD835\uDE45":"J","\uD835\uDE79":"J","Ʝ":"J","Ϳ":"J","Ј":"J","Ꭻ":"J","ᒍ":"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵","ᒙ":"J\xb7","\uD835\uDEA5":"ȷ","յ":"ȷ","ꭻ":"ᴊ","\uD835\uDC24":"k","\uD835\uDC58":"k","\uD835\uDC8C":"k","\uD835\uDCC0":"k","\uD835\uDCF4":"k","\uD835\uDD28":"k","\uD835\uDD5C":"k","\uD835\uDD90":"k","\uD835\uDDC4":"k","\uD835\uDDF8":"k","\uD835\uDE2C":"k","\uD835\uDE60":"k","\uD835\uDE94":"k","K":"K","Ｋ":"K","\uD835\uDC0A":"K","\uD835\uDC3E":"K","\uD835\uDC72":"K","\uD835\uDCA6":"K","\uD835\uDCDA":"K","\uD835\uDD0E":"K","\uD835\uDD42":"K","\uD835\uDD76":"K","\uD835\uDDAA":"K","\uD835\uDDDE":"K","\uD835\uDE12":"K","\uD835\uDE46":"K","\uD835\uDE7A":"K","Κ":"K","\uD835\uDEB1":"K","\uD835\uDEEB":"K","\uD835\uDF25":"K","\uD835\uDF5F":"K","\uD835\uDF99":"K","Ⲕ":"K","К":"K","Ꮶ":"K","ᛕ":"K","ꓗ":"K","\uD801\uDD18":"K","ƙ":"k̔","Ⱪ":"K̩","Қ":"K̩","₭":"K̵","Ꝁ":"K̵","Ҟ":"K̵","Ƙ":"K\'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","\uD800\uDF20":"l","\uD83A\uDCC7":"l","\uD835\uDFCF":"l","\uD835\uDFD9":"l","\uD835\uDFE3":"l","\uD835\uDFED":"l","\uD835\uDFF7":"l","\uD83E\uDFF1":"l","I":"l","Ｉ":"l","Ⅰ":"l","ℐ":"l","ℑ":"l","\uD835\uDC08":"l","\uD835\uDC3C":"l","\uD835\uDC70":"l","\uD835\uDCD8":"l","\uD835\uDD40":"l","\uD835\uDD74":"l","\uD835\uDDA8":"l","\uD835\uDDDC":"l","\uD835\uDE10":"l","\uD835\uDE44":"l","\uD835\uDE78":"l","Ɩ":"l","ｌ":"l","ⅼ":"l","ℓ":"l","\uD835\uDC25":"l","\uD835\uDC59":"l","\uD835\uDC8D":"l","\uD835\uDCC1":"l","\uD835\uDCF5":"l","\uD835\uDD29":"l","\uD835\uDD5D":"l","\uD835\uDD91":"l","\uD835\uDDC5":"l","\uD835\uDDF9":"l","\uD835\uDE2D":"l","\uD835\uDE61":"l","\uD835\uDE95":"l","ǀ":"l","Ι":"l","\uD835\uDEB0":"l","\uD835\uDEEA":"l","\uD835\uDF24":"l","\uD835\uDF5E":"l","\uD835\uDF98":"l","Ⲓ":"l","І":"l","Ӏ":"l","ו":"l","ן":"l","ا":"l","\uD83B\uDE00":"l","\uD83B\uDE80":"l","ﺎ":"l","ﺍ":"l","ߊ":"l","ⵏ":"l","ᛁ":"l","ꓲ":"l","\uD81B\uDF28":"l","\uD800\uDE8A":"l","\uD800\uDF09":"l","\uD834\uDE2A":"L","Ⅼ":"L","ℒ":"L","\uD835\uDC0B":"L","\uD835\uDC3F":"L","\uD835\uDC73":"L","\uD835\uDCDB":"L","\uD835\uDD0F":"L","\uD835\uDD43":"L","\uD835\uDD77":"L","\uD835\uDDAB":"L","\uD835\uDDDF":"L","\uD835\uDE13":"L","\uD835\uDE47":"L","\uD835\uDE7B":"L","Ⳑ":"L","Ꮮ":"L","ᒪ":"L","ꓡ":"L","\uD81B\uDF16":"L","\uD806\uDCA3":"L","\uD806\uDCB2":"L","\uD801\uDC1B":"L","\uD801\uDD26":"L","ﴼ":"l̋","ﴽ":"l̋","ł":"l̸","Ł":"L̸","ɭ":"l̨","Ɨ":"l̵","ƚ":"l̵","ɫ":"l̴","إ":"lٕ","ﺈ":"lٕ","ﺇ":"lٕ","ٳ":"lٕ","ŀ":"l\xb7","Ŀ":"l\xb7","ᒷ":"l\xb7","\uD83C\uDD02":"l,","⒈":"l.","ױ":"l\'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点","ǉ":"lj","Ĳ":"lJ","ǈ":"Lj","Ǉ":"LJ","‖":"ll","∥":"ll","Ⅱ":"ll","ǁ":"ll","װ":"ll","\uD800\uDD99":"l̵l̵","⒒":"ll.","Ⅲ":"lll","\uD800\uDD98":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点","Ю":"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点","ʪ":"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX","ɮ":"lȝ","ʫ":"lz","أ":"lٴ","ﺄ":"lٴ","ﺃ":"lٴ","ٲ":"lٴ","ٵ":"lٴ","ﷳ":"lكبر","ﷲ":"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","\uD801\uDC43":"ʟ","Ｍ":"M","Ⅿ":"M","ℳ":"M","\uD835\uDC0C":"M","\uD835\uDC40":"M","\uD835\uDC74":"M","\uD835\uDCDC":"M","\uD835\uDD10":"M","\uD835\uDD44":"M","\uD835\uDD78":"M","\uD835\uDDAC":"M","\uD835\uDDE0":"M","\uD835\uDE14":"M","\uD835\uDE48":"M","\uD835\uDE7C":"M","Μ":"M","\uD835\uDEB3":"M","\uD835\uDEED":"M","\uD835\uDF27":"M","\uD835\uDF61":"M","\uD835\uDF9B":"M","Ϻ":"M","Ⲙ":"M","М":"M","Ꮇ":"M","ᗰ":"M","ᛖ":"M","ꓟ":"M","\uD800\uDEB0":"M","\uD800\uDF11":"M","Ӎ":"M̦","\uD83D\uDF6B":"MB","ⷨ":"ᷟ","\uD835\uDC27":"n","\uD835\uDC5B":"n","\uD835\uDC8F":"n","\uD835\uDCC3":"n","\uD835\uDCF7":"n","\uD835\uDD2B":"n","\uD835\uDD5F":"n","\uD835\uDD93":"n","\uD835\uDDC7":"n","\uD835\uDDFB":"n","\uD835\uDE2F":"n","\uD835\uDE63":"n","\uD835\uDE97":"n","ո":"n","ռ":"n","Ｎ":"N","ℕ":"N","\uD835\uDC0D":"N","\uD835\uDC41":"N","\uD835\uDC75":"N","\uD835\uDCA9":"N","\uD835\uDCDD":"N","\uD835\uDD11":"N","\uD835\uDD79":"N","\uD835\uDDAD":"N","\uD835\uDDE1":"N","\uD835\uDE15":"N","\uD835\uDE49":"N","\uD835\uDE7D":"N","Ν":"N","\uD835\uDEB4":"N","\uD835\uDEEE":"N","\uD835\uDF28":"N","\uD835\uDF62":"N","\uD835\uDF9C":"N","Ⲛ":"N","ꓠ":"N","\uD801\uDD13":"N","\uD800\uDD8E":"N̊","ɳ":"n̨","ƞ":"n̩","η":"n̩","\uD835\uDEC8":"n̩","\uD835\uDF02":"n̩","\uD835\uDF3C":"n̩","\uD835\uDF76":"n̩","\uD835\uDFB0":"n̩","Ɲ":"N̦","ᵰ":"n̴","ǌ":"nj","ǋ":"Nj","Ǌ":"NJ","№":"No","ͷ":"ᴎ","и":"ᴎ","\uD801\uDC4D":"ᴎ","ņ":"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o","ｏ":"o","ℴ":"o","\uD835\uDC28":"o","\uD835\uDC5C":"o","\uD835\uDC90":"o","\uD835\uDCF8":"o","\uD835\uDD2C":"o","\uD835\uDD60":"o","\uD835\uDD94":"o","\uD835\uDDC8":"o","\uD835\uDDFC":"o","\uD835\uDE30":"o","\uD835\uDE64":"o","\uD835\uDE98":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o","ο":"o","\uD835\uDED0":"o","\uD835\uDF0A":"o","\uD835\uDF44":"o","\uD835\uDF7E":"o","\uD835\uDFB8":"o","σ":"o","\uD835\uDED4":"o","\uD835\uDF0E":"o","\uD835\uDF48":"o","\uD835\uDF82":"o","\uD835\uDFBC":"o","ⲟ":"o","о":"o","ჿ":"o","օ":"o","ס":"o","ه":"o","\uD83B\uDE24":"o","\uD83B\uDE64":"o","\uD83B\uDE84":"o","ﻫ":"o","ﻬ":"o","ﻪ":"o","ﻩ":"o","ھ":"o","ﮬ":"o","ﮭ":"o","ﮫ":"o","ﮪ":"o","ہ":"o","ﮨ":"o","ﮩ":"o","ﮧ":"o","ﮦ":"o","ە":"o","ഠ":"o","ဝ":"o","\uD801\uDCEA":"o","\uD806\uDCC8":"o","\uD806\uDCD7":"o","\uD801\uDC2C":"o","߀":"O","০":"O","୦":"O","〇":"O","\uD805\uDCD0":"O","\uD806\uDCE0":"O","\uD835\uDFCE":"O","\uD835\uDFD8":"O","\uD835\uDFE2":"O","\uD835\uDFEC":"O","\uD835\uDFF6":"O","\uD83E\uDFF0":"O","Ｏ":"O","\uD835\uDC0E":"O","\uD835\uDC42":"O","\uD835\uDC76":"O","\uD835\uDCAA":"O","\uD835\uDCDE":"O","\uD835\uDD12":"O","\uD835\uDD46":"O","\uD835\uDD7A":"O","\uD835\uDDAE":"O","\uD835\uDDE2":"O","\uD835\uDE16":"O","\uD835\uDE4A":"O","\uD835\uDE7E":"O","Ο":"O","\uD835\uDEB6":"O","\uD835\uDEF0":"O","\uD835\uDF2A":"O","\uD835\uDF64":"O","\uD835\uDF9E":"O","Ⲟ":"O","О":"O","Օ":"O","ⵔ":"O","ዐ":"O","ଠ":"O","\uD801\uDCC2":"O","ꓳ":"O","\uD806\uDCB5":"O","\uD800\uDE92":"O","\uD800\uDEAB":"O","\uD801\uDC04":"O","\uD801\uDD16":"O","⁰":"\xba","ᵒ":"\xba","ǒ":"ŏ","Ǒ":"Ŏ","ۿ":"ô","Ő":"\xd6","\xf8":"o̸","ꬾ":"o̸","\xd8":"O̸","ⵁ":"O̸","Ǿ":"Ó̸","ɵ":"o̵","ꝋ":"o̵","ө":"o̵","ѳ":"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","\uD834\uDE1A":"O̵","\uD83D\uDF14":"O̵","Ɵ":"O̵","Ꝋ":"O̵","θ":"O̵","ϑ":"O̵","\uD835\uDEC9":"O̵","\uD835\uDEDD":"O̵","\uD835\uDF03":"O̵","\uD835\uDF17":"O̵","\uD835\uDF3D":"O̵","\uD835\uDF51":"O̵","\uD835\uDF77":"O̵","\uD835\uDF8B":"O̵","\uD835\uDFB1":"O̵","\uD835\uDFC5":"O̵","Θ":"O̵","ϴ":"O̵","\uD835\uDEAF":"O̵","\uD835\uDEB9":"O̵","\uD835\uDEE9":"O̵","\uD835\uDEF3":"O̵","\uD835\uDF23":"O̵","\uD835\uDF2D":"O̵","\uD835\uDF5D":"O̵","\uD835\uDF67":"O̵","\uD835\uDF97":"O̵","\uD835\uDFA1":"O̵","Ө":"O̵","Ѳ":"O̵","ⴱ":"O̵","Ꮎ":"O̵","Ꮻ":"O̵","ꭴ":"ơ","ﳙ":"oٰ","\uD83C\uDD01":"O,","\uD83C\uDD00":"O.","ơ":"o\'","Ơ":"O\'","Ꭴ":"O\'","%":"\xba/₀","٪":"\xba/₀","⁒":"\xba/₀","‰":"\xba/₀₀","؉":"\xba/₀₀","‱":"\xba/₀₀₀","؊":"\xba/₀₀₀","œ":"oe","Œ":"OE","ɶ":"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO","ﳗ":"oج","ﱑ":"oج","ﳘ":"oم","ﱒ":"oم","ﶓ":"oمج","ﶔ":"oمم","ﱓ":"oى","ﱔ":"oى","ൟ":"oരo","တ":"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","\uD801\uDC4B":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","\uD801\uDC23":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","\uD801\uDC3F":"ɷ","⍴":"p","ｐ":"p","\uD835\uDC29":"p","\uD835\uDC5D":"p","\uD835\uDC91":"p","\uD835\uDCC5":"p","\uD835\uDCF9":"p","\uD835\uDD2D":"p","\uD835\uDD61":"p","\uD835\uDD95":"p","\uD835\uDDC9":"p","\uD835\uDDFD":"p","\uD835\uDE31":"p","\uD835\uDE65":"p","\uD835\uDE99":"p","ρ":"p","ϱ":"p","\uD835\uDED2":"p","\uD835\uDEE0":"p","\uD835\uDF0C":"p","\uD835\uDF1A":"p","\uD835\uDF46":"p","\uD835\uDF54":"p","\uD835\uDF80":"p","\uD835\uDF8E":"p","\uD835\uDFBA":"p","\uD835\uDFC8":"p","ⲣ":"p","р":"p","Ｐ":"P","ℙ":"P","\uD835\uDC0F":"P","\uD835\uDC43":"P","\uD835\uDC77":"P","\uD835\uDCAB":"P","\uD835\uDCDF":"P","\uD835\uDD13":"P","\uD835\uDD7B":"P","\uD835\uDDAF":"P","\uD835\uDDE3":"P","\uD835\uDE17":"P","\uD835\uDE4B":"P","\uD835\uDE7F":"P","Ρ":"P","\uD835\uDEB8":"P","\uD835\uDEF2":"P","\uD835\uDF2C":"P","\uD835\uDF66":"P","\uD835\uDFA0":"P","Ⲣ":"P","Р":"P","Ꮲ":"P","ᑭ":"P","ꓑ":"P","\uD800\uDE95":"P","ƥ":"p̔","ᵽ":"p̵","ᑷ":"p\xb7","ᒆ":"P\'","ᴩ":"ᴘ","ꮲ":"ᴘ","φ":"ɸ","ϕ":"ɸ","\uD835\uDED7":"ɸ","\uD835\uDEDF":"ɸ","\uD835\uDF11":"ɸ","\uD835\uDF19":"ɸ","\uD835\uDF4B":"ɸ","\uD835\uDF53":"ɸ","\uD835\uDF85":"ɸ","\uD835\uDF8D":"ɸ","\uD835\uDFBF":"ɸ","\uD835\uDFC7":"ɸ","ⲫ":"ɸ","ф":"ɸ","\uD835\uDC2A":"q","\uD835\uDC5E":"q","\uD835\uDC92":"q","\uD835\uDCC6":"q","\uD835\uDCFA":"q","\uD835\uDD2E":"q","\uD835\uDD62":"q","\uD835\uDD96":"q","\uD835\uDDCA":"q","\uD835\uDDFE":"q","\uD835\uDE32":"q","\uD835\uDE66":"q","\uD835\uDE9A":"q","ԛ":"q","գ":"q","զ":"q","ℚ":"Q","\uD835\uDC10":"Q","\uD835\uDC44":"Q","\uD835\uDC78":"Q","\uD835\uDCAC":"Q","\uD835\uDCE0":"Q","\uD835\uDD14":"Q","\uD835\uDD7C":"Q","\uD835\uDDB0":"Q","\uD835\uDDE4":"Q","\uD835\uDE18":"Q","\uD835\uDE4C":"Q","\uD835\uDE80":"Q","ⵕ":"Q","ʠ":"q̔","\uD83D\uDF00":"QE","ᶐ":"ɋ","ᴋ":"ĸ","κ":"ĸ","ϰ":"ĸ","\uD835\uDECB":"ĸ","\uD835\uDEDE":"ĸ","\uD835\uDF05":"ĸ","\uD835\uDF18":"ĸ","\uD835\uDF3F":"ĸ","\uD835\uDF52":"ĸ","\uD835\uDF79":"ĸ","\uD835\uDF8C":"ĸ","\uD835\uDFB3":"ĸ","\uD835\uDFC6":"ĸ","ⲕ":"ĸ","к":"ĸ","ꮶ":"ĸ","қ":"ĸ̩","ҟ":"ĸ̵","\uD835\uDC2B":"r","\uD835\uDC5F":"r","\uD835\uDC93":"r","\uD835\uDCC7":"r","\uD835\uDCFB":"r","\uD835\uDD2F":"r","\uD835\uDD63":"r","\uD835\uDD97":"r","\uD835\uDDCB":"r","\uD835\uDDFF":"r","\uD835\uDE33":"r","\uD835\uDE67":"r","\uD835\uDE9B":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r","г":"r","ꮁ":"r","\uD834\uDE16":"R","ℛ":"R","ℜ":"R","ℝ":"R","\uD835\uDC11":"R","\uD835\uDC45":"R","\uD835\uDC79":"R","\uD835\uDCE1":"R","\uD835\uDD7D":"R","\uD835\uDDB1":"R","\uD835\uDDE5":"R","\uD835\uDE19":"R","\uD835\uDE4D":"R","\uD835\uDE81":"R","Ʀ":"R","Ꭱ":"R","Ꮢ":"R","\uD801\uDCB4":"R","ᖇ":"R","ꓣ":"R","\uD81B\uDF35":"R","ɽ":"r̨","ɼ":"r̩","ɍ":"r̵","ғ":"r̵","ᵲ":"r̴","ґ":"r\'","\uD806\uDCE3":"rn","m":"rn","ⅿ":"rn","\uD835\uDC26":"rn","\uD835\uDC5A":"rn","\uD835\uDC8E":"rn","\uD835\uDCC2":"rn","\uD835\uDCF6":"rn","\uD835\uDD2A":"rn","\uD835\uDD5E":"rn","\uD835\uDD92":"rn","\uD835\uDDC6":"rn","\uD835\uDDFA":"rn","\uD835\uDE2E":"rn","\uD835\uDE62":"rn","\uD835\uDE96":"rn","\uD805\uDF00":"rn","₥":"rn̸","ɱ":"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ","я":"ᴙ","ᵳ":"ɾ̴","℩":"ɿ","ｓ":"s","\uD835\uDC2C":"s","\uD835\uDC60":"s","\uD835\uDC94":"s","\uD835\uDCC8":"s","\uD835\uDCFC":"s","\uD835\uDD30":"s","\uD835\uDD64":"s","\uD835\uDD98":"s","\uD835\uDDCC":"s","\uD835\uDE00":"s","\uD835\uDE34":"s","\uD835\uDE68":"s","\uD835\uDE9C":"s","ꜱ":"s","ƽ":"s","ѕ":"s","ꮪ":"s","\uD806\uDCC1":"s","\uD801\uDC48":"s","Ｓ":"S","\uD835\uDC12":"S","\uD835\uDC46":"S","\uD835\uDC7A":"S","\uD835\uDCAE":"S","\uD835\uDCE2":"S","\uD835\uDD16":"S","\uD835\uDD4A":"S","\uD835\uDD7E":"S","\uD835\uDDB2":"S","\uD835\uDDE6":"S","\uD835\uDE1A":"S","\uD835\uDE4E":"S","\uD835\uDE82":"S","Ѕ":"S","Տ":"S","Ꮥ":"S","Ꮪ":"S","ꓢ":"S","\uD81B\uDF3A":"S","\uD800\uDE96":"S","\uD801\uDC20":"S","ʂ":"s̨","ᵴ":"s̴","ꞵ":"\xdf","β":"\xdf","ϐ":"\xdf","\uD835\uDEC3":"\xdf","\uD835\uDEFD":"\xdf","\uD835\uDF37":"\xdf","\uD835\uDF71":"\xdf","\uD835\uDFAB":"\xdf","Ᏸ":"\xdf","\uD83D\uDF5C":"sss","ﬆ":"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ","Σ":"Ʃ","\uD835\uDEBA":"Ʃ","\uD835\uDEF4":"Ʃ","\uD835\uDF2E":"Ʃ","\uD835\uDF68":"Ʃ","\uD835\uDFA2":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","\uD835\uDC2D":"t","\uD835\uDC61":"t","\uD835\uDC95":"t","\uD835\uDCC9":"t","\uD835\uDCFD":"t","\uD835\uDD31":"t","\uD835\uDD65":"t","\uD835\uDD99":"t","\uD835\uDDCD":"t","\uD835\uDE01":"t","\uD835\uDE35":"t","\uD835\uDE69":"t","\uD835\uDE9D":"t","⊤":"T","⟙":"T","\uD83D\uDF68":"T","Ｔ":"T","\uD835\uDC13":"T","\uD835\uDC47":"T","\uD835\uDC7B":"T","\uD835\uDCAF":"T","\uD835\uDCE3":"T","\uD835\uDD17":"T","\uD835\uDD4B":"T","\uD835\uDD7F":"T","\uD835\uDDB3":"T","\uD835\uDDE7":"T","\uD835\uDE1B":"T","\uD835\uDE4F":"T","\uD835\uDE83":"T","Τ":"T","\uD835\uDEBB":"T","\uD835\uDEF5":"T","\uD835\uDF2F":"T","\uD835\uDF69":"T","\uD835\uDFA3":"T","Ⲧ":"T","Т":"T","Ꭲ":"T","ꓔ":"T","\uD81B\uDF0A":"T","\uD806\uDCBC":"T","\uD800\uDE97":"T","\uD800\uDEB1":"T","\uD800\uDF15":"T","ƭ":"t̔","⍡":"T̈","Ⱦ":"T̸","Ț":"Ţ","Ʈ":"T̨","Ҭ":"T̩","₮":"T⃫","ŧ":"t̵","Ŧ":"T̵","ᵵ":"t̴","Ⴀ":"Ꞇ","Ꜩ":"T3","ʨ":"tɕ","℡":"TEL","ꝷ":"tf","ʦ":"ts","ʧ":"tʃ","ꜩ":"tȝ","τ":"ᴛ","\uD835\uDED5":"ᴛ","\uD835\uDF0F":"ᴛ","\uD835\uDF49":"ᴛ","\uD835\uDF83":"ᴛ","\uD835\uDFBD":"ᴛ","т":"ᴛ","ꭲ":"ᴛ","ҭ":"ᴛ̩","ţ":"ƫ","ț":"ƫ","Ꮏ":"ƫ","\uD835\uDC2E":"u","\uD835\uDC62":"u","\uD835\uDC96":"u","\uD835\uDCCA":"u","\uD835\uDCFE":"u","\uD835\uDD32":"u","\uD835\uDD66":"u","\uD835\uDD9A":"u","\uD835\uDDCE":"u","\uD835\uDE02":"u","\uD835\uDE36":"u","\uD835\uDE6A":"u","\uD835\uDE9E":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u","ʋ":"u","υ":"u","\uD835\uDED6":"u","\uD835\uDF10":"u","\uD835\uDF4A":"u","\uD835\uDF84":"u","\uD835\uDFBE":"u","ս":"u","\uD801\uDCF6":"u","\uD806\uDCD8":"u","∪":"U","⋃":"U","\uD835\uDC14":"U","\uD835\uDC48":"U","\uD835\uDC7C":"U","\uD835\uDCB0":"U","\uD835\uDCE4":"U","\uD835\uDD18":"U","\uD835\uDD4C":"U","\uD835\uDD80":"U","\uD835\uDDB4":"U","\uD835\uDDE8":"U","\uD835\uDE1C":"U","\uD835\uDE50":"U","\uD835\uDE84":"U","Ս":"U","ሀ":"U","\uD801\uDCCE":"U","ᑌ":"U","ꓴ":"U","\uD81B\uDF42":"U","\uD806\uDCB8":"U","ǔ":"ŭ","Ǔ":"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵","Ꮜ":"U̵","ᑘ":"U\xb7","ᑧ":"U\'","ᵫ":"ue","ꭣ":"uo","ṃ":"ꭑ","պ":"ɰ","ሣ":"ɰ","℧":"Ʊ","ᘮ":"Ʊ","ᘴ":"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v","ｖ":"v","ⅴ":"v","\uD835\uDC2F":"v","\uD835\uDC63":"v","\uD835\uDC97":"v","\uD835\uDCCB":"v","\uD835\uDCFF":"v","\uD835\uDD33":"v","\uD835\uDD67":"v","\uD835\uDD9B":"v","\uD835\uDDCF":"v","\uD835\uDE03":"v","\uD835\uDE37":"v","\uD835\uDE6B":"v","\uD835\uDE9F":"v","ᴠ":"v","ν":"v","\uD835\uDECE":"v","\uD835\uDF08":"v","\uD835\uDF42":"v","\uD835\uDF7C":"v","\uD835\uDFB6":"v","ѵ":"v","ט":"v","\uD805\uDF06":"v","ꮩ":"v","\uD806\uDCC0":"v","\uD834\uDE0D":"V","٧":"V","۷":"V","Ⅴ":"V","\uD835\uDC15":"V","\uD835\uDC49":"V","\uD835\uDC7D":"V","\uD835\uDCB1":"V","\uD835\uDCE5":"V","\uD835\uDD19":"V","\uD835\uDD4D":"V","\uD835\uDD81":"V","\uD835\uDDB5":"V","\uD835\uDDE9":"V","\uD835\uDE1D":"V","\uD835\uDE51":"V","\uD835\uDE85":"V","Ѵ":"V","ⴸ":"V","Ꮩ":"V","ᐯ":"V","ꛟ":"V","ꓦ":"V","\uD81B\uDF08":"V","\uD806\uDCA0":"V","\uD801\uDD1D":"V","\uD800\uDD97":"V̵","ᐻ":"V\xb7","\uD83D\uDF6C":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","\uD83D\uDF08":"Vᷤ","ᴧ":"ʌ","\uD801\uDCD8":"ʌ","٨":"Ʌ","۸":"Ʌ","Λ":"Ʌ","\uD835\uDEB2":"Ʌ","\uD835\uDEEC":"Ʌ","\uD835\uDF26":"Ʌ","\uD835\uDF60":"Ʌ","\uD835\uDF9A":"Ʌ","Л":"Ʌ","ⴷ":"Ʌ","\uD801\uDCB0":"Ʌ","ᐱ":"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","\uD81B\uDF3D":"Ʌ","\uD800\uDE8D":"Ʌ","Ӆ":"Ʌ̦","ᐽ":"Ʌ\xb7","ɯ":"w","\uD835\uDC30":"w","\uD835\uDC64":"w","\uD835\uDC98":"w","\uD835\uDCCC":"w","\uD835\uDD00":"w","\uD835\uDD34":"w","\uD835\uDD68":"w","\uD835\uDD9C":"w","\uD835\uDDD0":"w","\uD835\uDE04":"w","\uD835\uDE38":"w","\uD835\uDE6C":"w","\uD835\uDEA0":"w","ᴡ":"w","ѡ":"w","ԝ":"w","ա":"w","\uD805\uDF0A":"w","\uD805\uDF0E":"w","\uD805\uDF0F":"w","ꮃ":"w","\uD806\uDCEF":"W","\uD806\uDCE6":"W","\uD835\uDC16":"W","\uD835\uDC4A":"W","\uD835\uDC7E":"W","\uD835\uDCB2":"W","\uD835\uDCE6":"W","\uD835\uDD1A":"W","\uD835\uDD4E":"W","\uD835\uDD82":"W","\uD835\uDDB6":"W","\uD835\uDDEA":"W","\uD835\uDE1E":"W","\uD835\uDE52":"W","\uD835\uDE86":"W","Ԝ":"W","Ꮃ":"W","Ꮤ":"W","ꓪ":"W","ѽ":"w҆҇","\uD805\uDCC5":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ","м":"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","\xd7":"x","⤫":"x","⤬":"x","⨯":"x","ｘ":"x","ⅹ":"x","\uD835\uDC31":"x","\uD835\uDC65":"x","\uD835\uDC99":"x","\uD835\uDCCD":"x","\uD835\uDD01":"x","\uD835\uDD35":"x","\uD835\uDD69":"x","\uD835\uDD9D":"x","\uD835\uDDD1":"x","\uD835\uDE05":"x","\uD835\uDE39":"x","\uD835\uDE6D":"x","\uD835\uDEA1":"x","х":"x","ᕁ":"x","ᕽ":"x","ⷯ":"ͯ","᙭":"X","╳":"X","\uD800\uDF22":"X","\uD806\uDCEC":"X","Ｘ":"X","Ⅹ":"X","\uD835\uDC17":"X","\uD835\uDC4B":"X","\uD835\uDC7F":"X","\uD835\uDCB3":"X","\uD835\uDCE7":"X","\uD835\uDD1B":"X","\uD835\uDD4F":"X","\uD835\uDD83":"X","\uD835\uDDB7":"X","\uD835\uDDEB":"X","\uD835\uDE1F":"X","\uD835\uDE53":"X","\uD835\uDE87":"X","Ꭓ":"X","Χ":"X","\uD835\uDEBE":"X","\uD835\uDEF8":"X","\uD835\uDF32":"X","\uD835\uDF6C":"X","\uD835\uDFA6":"X","Ⲭ":"X","Х":"X","ⵝ":"X","ᚷ":"X","ꓫ":"X","\uD800\uDE90":"X","\uD800\uDEB4":"X","\uD800\uDF17":"X","\uD801\uDD27":"X","⨰":"ẋ","Ҳ":"X̩","\uD800\uDD96":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll","ɣ":"y","ᶌ":"y","ｙ":"y","\uD835\uDC32":"y","\uD835\uDC66":"y","\uD835\uDC9A":"y","\uD835\uDCCE":"y","\uD835\uDD02":"y","\uD835\uDD36":"y","\uD835\uDD6A":"y","\uD835\uDD9E":"y","\uD835\uDDD2":"y","\uD835\uDE06":"y","\uD835\uDE3A":"y","\uD835\uDE6E":"y","\uD835\uDEA2":"y","ʏ":"y","ỿ":"y","ꭚ":"y","γ":"y","ℽ":"y","\uD835\uDEC4":"y","\uD835\uDEFE":"y","\uD835\uDF38":"y","\uD835\uDF72":"y","\uD835\uDFAC":"y","у":"y","ү":"y","ყ":"y","\uD806\uDCDC":"y","Ｙ":"Y","\uD835\uDC18":"Y","\uD835\uDC4C":"Y","\uD835\uDC80":"Y","\uD835\uDCB4":"Y","\uD835\uDCE8":"Y","\uD835\uDD1C":"Y","\uD835\uDD50":"Y","\uD835\uDD84":"Y","\uD835\uDDB8":"Y","\uD835\uDDEC":"Y","\uD835\uDE20":"Y","\uD835\uDE54":"Y","\uD835\uDE88":"Y","Υ":"Y","ϒ":"Y","\uD835\uDEBC":"Y","\uD835\uDEF6":"Y","\uD835\uDF30":"Y","\uD835\uDF6A":"Y","\uD835\uDFA4":"Y","Ⲩ":"Y","У":"Y","Ү":"Y","Ꭹ":"Y","Ꮍ":"Y","ꓬ":"Y","\uD81B\uDF43":"Y","\uD806\uDCA4":"Y","\uD800\uDEB2":"Y","ƴ":"y̔","ɏ":"y̵","ұ":"y̵","\xa5":"Y̵","Ɏ":"Y̵","Ұ":"Y̵","ʒ":"ȝ","ꝫ":"ȝ","ⳍ":"ȝ","ӡ":"ȝ","ჳ":"ȝ","\uD835\uDC33":"z","\uD835\uDC67":"z","\uD835\uDC9B":"z","\uD835\uDCCF":"z","\uD835\uDD03":"z","\uD835\uDD37":"z","\uD835\uDD6B":"z","\uD835\uDD9F":"z","\uD835\uDDD3":"z","\uD835\uDE07":"z","\uD835\uDE3B":"z","\uD835\uDE6F":"z","\uD835\uDEA3":"z","ᴢ":"z","ꮓ":"z","\uD806\uDCC4":"z","\uD800\uDEF5":"Z","\uD806\uDCE5":"Z","Ｚ":"Z","ℤ":"Z","ℨ":"Z","\uD835\uDC19":"Z","\uD835\uDC4D":"Z","\uD835\uDC81":"Z","\uD835\uDCB5":"Z","\uD835\uDCE9":"Z","\uD835\uDD85":"Z","\uD835\uDDB9":"Z","\uD835\uDDED":"Z","\uD835\uDE21":"Z","\uD835\uDE55":"Z","\uD835\uDE89":"Z","Ζ":"Z","\uD835\uDEAD":"Z","\uD835\uDEE7":"Z","\uD835\uDF21":"Z","\uD835\uDF5B":"Z","\uD835\uDF95":"Z","Ꮓ":"Z","ꓜ":"Z","\uD806\uDCA9":"Z","ʐ":"z̨","ƶ":"z̵","Ƶ":"Z̵","ȥ":"z̦","Ȥ":"Z̦","ᵶ":"z̴","ƿ":"\xfe","ϸ":"\xfe","Ϸ":"\xde","\uD801\uDCC4":"\xde","⁹":"ꝰ","ᴤ":"ƨ","ϩ":"ƨ","ꙅ":"ƨ","ь":"ƅ","ꮟ":"ƅ","ы":"ƅi","ꭾ":"ɂ","ˤ":"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","\uD801\uDCC3":"ʘ","ℾ":"Γ","\uD835\uDEAA":"Γ","\uD835\uDEE4":"Γ","\uD835\uDF1E":"Γ","\uD835\uDF58":"Γ","\uD835\uDF92":"Γ","Ⲅ":"Γ","Г":"Γ","Ꮁ":"Γ","ᒥ":"Γ","\uD81B\uDF07":"Γ","Ғ":"Γ̵","ᒯ":"Γ\xb7","Ґ":"Γ\'","∆":"Δ","△":"Δ","\uD83D\uDF02":"Δ","\uD835\uDEAB":"Δ","\uD835\uDEE5":"Δ","\uD835\uDF1F":"Δ","\uD835\uDF59":"Δ","\uD835\uDF93":"Δ","Ⲇ":"Δ","ⵠ":"Δ","ᐃ":"Δ","\uD81B\uDF1A":"Δ","\uD800\uDE85":"Δ","\uD800\uDEA3":"Δ","⍙":"Δ̲","ᐏ":"Δ\xb7","ᐬ":"Δᐠ","\uD835\uDFCB":"ϝ","\uD835\uDEC7":"ζ","\uD835\uDF01":"ζ","\uD835\uDF3B":"ζ","\uD835\uDF75":"ζ","\uD835\uDFAF":"ζ","ⳤ":"ϗ","\uD835\uDECC":"λ","\uD835\uDF06":"λ","\uD835\uDF40":"λ","\uD835\uDF7A":"λ","\uD835\uDFB4":"λ","Ⲗ":"λ","\uD801\uDCDB":"λ","\xb5":"μ","\uD835\uDECD":"μ","\uD835\uDF07":"μ","\uD835\uDF41":"μ","\uD835\uDF7B":"μ","\uD835\uDFB5":"μ","\uD835\uDECF":"ξ","\uD835\uDF09":"ξ","\uD835\uDF43":"ξ","\uD835\uDF7D":"ξ","\uD835\uDFB7":"ξ","\uD835\uDEB5":"Ξ","\uD835\uDEEF":"Ξ","\uD835\uDF29":"Ξ","\uD835\uDF63":"Ξ","\uD835\uDF9D":"Ξ","ϖ":"π","ℼ":"π","\uD835\uDED1":"π","\uD835\uDEE1":"π","\uD835\uDF0B":"π","\uD835\uDF1B":"π","\uD835\uDF45":"π","\uD835\uDF55":"π","\uD835\uDF7F":"π","\uD835\uDF8F":"π","\uD835\uDFB9":"π","\uD835\uDFC9":"π","ᴨ":"π","п":"π","∏":"Π","ℿ":"Π","\uD835\uDEB7":"Π","\uD835\uDEF1":"Π","\uD835\uDF2B":"Π","\uD835\uDF65":"Π","\uD835\uDF9F":"Π","Ⲡ":"Π","П":"Π","ꛛ":"Π","\uD800\uDEAD":"Ϙ","\uD800\uDF12":"Ϙ","ϛ":"ς","\uD835\uDED3":"ς","\uD835\uDF0D":"ς","\uD835\uDF47":"ς","\uD835\uDF81":"ς","\uD835\uDFBB":"ς","\uD835\uDEBD":"Φ","\uD835\uDEF7":"Φ","\uD835\uDF31":"Φ","\uD835\uDF6B":"Φ","\uD835\uDFA5":"Φ","Ⲫ":"Φ","Ф":"Φ","Փ":"Φ","ቀ":"Φ","ᛰ":"Φ","\uD800\uDEB3":"Φ","ꭓ":"χ","ꭕ":"χ","\uD835\uDED8":"χ","\uD835\uDF12":"χ","\uD835\uDF4C":"χ","\uD835\uDF86":"χ","\uD835\uDFC0":"χ","ⲭ":"χ","\uD835\uDED9":"ψ","\uD835\uDF13":"ψ","\uD835\uDF4D":"ψ","\uD835\uDF87":"ψ","\uD835\uDFC1":"ψ","ѱ":"ψ","\uD801\uDCF9":"ψ","\uD835\uDEBF":"Ψ","\uD835\uDEF9":"Ψ","\uD835\uDF33":"Ψ","\uD835\uDF6D":"Ψ","\uD835\uDFA7":"Ψ","Ⲯ":"Ψ","Ѱ":"Ψ","\uD801\uDCD1":"Ψ","ᛘ":"Ψ","\uD800\uDEB5":"Ψ","⍵":"ω","ꞷ":"ω","\uD835\uDEDA":"ω","\uD835\uDF14":"ω","\uD835\uDF4E":"ω","\uD835\uDF88":"ω","\uD835\uDFC2":"ω","ⲱ":"ω","ꙍ":"ω","Ω":"Ω","\uD835\uDEC0":"Ω","\uD835\uDEFA":"Ω","\uD835\uDF34":"Ω","\uD835\uDF6E":"Ω","\uD835\uDFA8":"Ω","ᘯ":"Ω","ᘵ":"Ω","\uD800\uDEB6":"Ω","⍹":"ω̲","ώ":"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ","җ":"ж̩","Җ":"Ж̩","\uD834\uDE0B":"И","Ͷ":"И","ꚡ":"И","\uD801\uDC25":"И","Й":"Ѝ","Ҋ":"Ѝ̦","ѝ":"й","ҋ":"й̦","\uD801\uDCBC":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","\uD801\uDCEB":"ꙩ","ᷮ":"ⷬ","\uD801\uDCCD":"Ћ","\uD834\uDE02":"Ӿ","\uD834\uDE22":"Ѡ","Ꮗ":"Ѡ","ᗯ":"Ѡ","Ѽ":"Ѡ҆҇","ᣭ":"Ѡ\xb7","Ꞷ":"Ꙍ","ӌ":"ҷ","Ӌ":"Ҷ","Ҿ":"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","\uD83D\uDF01":"Ꙙ","\uD81B\uDF1C":"Ꙙ","ꦒ":"ⰿ","և":"եւ","ኔ":"ձ","ﬔ":"մե","ﬕ":"մի","ﬗ":"մխ","ﬓ":"մն","∩":"Ո","⋂":"Ո","\uD834\uDE45":"Ո","በ":"Ո","ᑎ":"Ո","ꓵ":"Ո","ᑚ":"Ո\xb7","ᑨ":"Ո\'","ﬖ":"վն","₽":"Ք","˓":"ՙ","ʿ":"ՙ","ℵ":"א","ﬡ":"א","אָ":"אַ","אּ":"אַ","ﭏ":"אל","ℶ":"ב","ℷ":"ג","ℸ":"ד","ﬢ":"ד","ﬣ":"ה","יּ":"יִ","ﬤ":"כ","ﬥ":"ל","ﬦ":"ם","ﬠ":"ע","ﬧ":"ר","שׂ":"שׁ","שּ":"שׁ","שּׂ":"שּׁ","ﬨ":"ת","ﺀ":"ء","۽":"ء͈","ﺂ":"آ","ﺁ":"آ","ﭑ":"ٱ","ﭐ":"ٱ","\uD83B\uDE01":"ب","\uD83B\uDE21":"ب","\uD83B\uDE61":"ب","\uD83B\uDE81":"ب","\uD83B\uDEA1":"ب","ﺑ":"ب","ﺒ":"ب","ﺐ":"ب","ﺏ":"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ","ﲠ":"بo","ﳢ":"بo","ﲜ":"بج","ﰅ":"بج","ﲝ":"بح","ﰆ":"بح","ﷂ":"بحى","ﲞ":"بخ","ﰇ":"بخ","ﳒ":"بخ","ﱋ":"بخ","ﶞ":"بخى","ﱪ":"بر","ﱫ":"بز","ﲟ":"بم","ﳡ":"بم","ﱬ":"بم","ﰈ":"بم","ﱭ":"بن","ﱮ":"بى","ﰉ":"بى","ﱯ":"بى","ﰊ":"بى","ﭔ":"ٻ","ﭕ":"ٻ","ﭓ":"ٻ","ﭒ":"ٻ","ې":"ٻ","ﯦ":"ٻ","ﯧ":"ٻ","ﯥ":"ٻ","ﯤ":"ٻ","ﭜ":"ڀ","ﭝ":"ڀ","ﭛ":"ڀ","ﭚ":"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة","\xf6":"ة","ﺔ":"ة","ﺓ":"ة","ۃ":"ة","\uD83B\uDE15":"ت","\uD83B\uDE35":"ت","\uD83B\uDE75":"ت","\uD83B\uDE95":"ت","\uD83B\uDEB5":"ت","ﺗ":"ت","ﺘ":"ت","ﺖ":"ت","ﺕ":"ت","ﲥ":"تo","ﳤ":"تo","ﲡ":"تج","ﰋ":"تج","ﵐ":"تجم","ﶠ":"تجى","ﶟ":"تجى","ﲢ":"تح","ﰌ":"تح","ﵒ":"تحج","ﵑ":"تحج","ﵓ":"تحم","ﲣ":"تخ","ﰍ":"تخ","ﵔ":"تخم","ﶢ":"تخى","ﶡ":"تخى","ﱰ":"تر","ﱱ":"تز","ﲤ":"تم","ﳣ":"تم","ﱲ":"تم","ﰎ":"تم","ﵕ":"تمج","ﵖ":"تمح","ﵗ":"تمخ","ﶤ":"تمى","ﶣ":"تمى","ﱳ":"تن","ﱴ":"تى","ﰏ":"تى","ﱵ":"تى","ﰐ":"تى","ﭠ":"ٺ","ﭡ":"ٺ","ﭟ":"ٺ","ﭞ":"ٺ","ﭤ":"ٿ","ﭥ":"ٿ","ﭣ":"ٿ","ﭢ":"ٿ","\uD83B\uDE02":"ج","\uD83B\uDE22":"ج","\uD83B\uDE42":"ج","\uD83B\uDE62":"ج","\uD83B\uDE82":"ج","\uD83B\uDEA2":"ج","ﺟ":"ج","ﺠ":"ج","ﺞ":"ج","ﺝ":"ج","ﲧ":"جح","ﰕ":"جح","ﶦ":"جحى","ﶾ":"جحى","ﷻ":"جل جلlلo","ﲨ":"جم","ﰖ":"جم","ﵙ":"جمح","ﵘ":"جمح","ﶧ":"جمى","ﶥ":"جمى","ﴝ":"جى","ﴁ":"جى","ﴞ":"جى","ﴂ":"جى","ﭸ":"ڃ","ﭹ":"ڃ","ﭷ":"ڃ","ﭶ":"ڃ","ﭴ":"ڄ","ﭵ":"ڄ","ﭳ":"ڄ","ﭲ":"ڄ","ﭼ":"چ","ﭽ":"چ","ﭻ":"چ","ﭺ":"چ","ﮀ":"ڇ","ﮁ":"ڇ","ﭿ":"ڇ","ﭾ":"ڇ","\uD83B\uDE07":"ح","\uD83B\uDE27":"ح","\uD83B\uDE47":"ح","\uD83B\uDE67":"ح","\uD83B\uDE87":"ح","\uD83B\uDEA7":"ح","ﺣ":"ح","ﺤ":"ح","ﺢ":"ح","ﺡ":"ح","څ":"حۛ","ځ":"حٔ","ݲ":"حٔ","ﲩ":"حج","ﰗ":"حج","ﶿ":"حجى","ﲪ":"حم","ﰘ":"حم","ﵛ":"حمى","ﵚ":"حمى","ﴛ":"حى","ﳿ":"حى","ﴜ":"حى","ﴀ":"حى","\uD83B\uDE17":"خ","\uD83B\uDE37":"خ","\uD83B\uDE57":"خ","\uD83B\uDE77":"خ","\uD83B\uDE97":"خ","\uD83B\uDEB7":"خ","ﺧ":"خ","ﺨ":"خ","ﺦ":"خ","ﺥ":"خ","ﲫ":"خج","ﰙ":"خج","ﰚ":"خح","ﲬ":"خم","ﰛ":"خم","ﴟ":"خى","ﴃ":"خى","ﴠ":"خى","ﴄ":"خى","\uD800\uDEE1":"د","\uD83B\uDE03":"د","\uD83B\uDE83":"د","\uD83B\uDEA3":"د","ﺪ":"د","ﺩ":"د","ڈ":"دؕ","ﮉ":"دؕ","ﮈ":"دؕ","ڎ":"دۛ","ﮇ":"دۛ","ﮆ":"دۛ","ۮ":"د̂","ࢮ":"د̤̣","\uD83B\uDE18":"ذ","\uD83B\uDE98":"ذ","\uD83B\uDEB8":"ذ","ﺬ":"ذ","ﺫ":"ذ","ﱛ":"ذٰ","ڋ":"ڊؕ","ﮅ":"ڌ","ﮄ":"ڌ","ﮃ":"ڍ","ﮂ":"ڍ","\uD83B\uDE13":"ر","\uD83B\uDE93":"ر","\uD83B\uDEB3":"ر","ﺮ":"ر","ﺭ":"ر","ڑ":"رؕ","ﮍ":"رؕ","ﮌ":"رؕ","ژ":"رۛ","ﮋ":"رۛ","ﮊ":"رۛ","ڒ":"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ","ﱜ":"رٰ","ﷶ":"رسول","﷼":"رىlل","\uD83B\uDE06":"ز","\uD83B\uDE86":"ز","\uD83B\uDEA6":"ز","ﺰ":"ز","ﺯ":"ز","ࢲ":"ز̂","ݱ":"ڗؕ","\uD83B\uDE0E":"س","\uD83B\uDE2E":"س","\uD83B\uDE4E":"س","\uD83B\uDE6E":"س","\uD83B\uDE8E":"س","\uD83B\uDEAE":"س","ﺳ":"س","ﺴ":"س","ﺲ":"س","ﺱ":"س","ش":"سۛ","\uD83B\uDE14":"سۛ","\uD83B\uDE34":"سۛ","\uD83B\uDE54":"سۛ","\uD83B\uDE74":"سۛ","\uD83B\uDE94":"سۛ","\uD83B\uDEB4":"سۛ","ﺷ":"سۛ","ﺸ":"سۛ","ﺶ":"سۛ","ﺵ":"سۛ","ݾ":"س̂","ﴱ":"سo","ﳨ":"سo","ﴲ":"سۛo","ﳪ":"سۛo","ﲭ":"سج","ﴴ":"سج","ﰜ":"سج","ﴭ":"سۛج","ﴷ":"سۛج","ﴥ":"سۛج","ﴉ":"سۛج","ﵝ":"سجح","ﵞ":"سجى","ﵩ":"سۛجى","ﲮ":"سح","ﴵ":"سح","ﰝ":"سح","ﴮ":"سۛح","ﴸ":"سۛح","ﴦ":"سۛح","ﴊ":"سۛح","ﵜ":"سحج","ﵨ":"سۛحم","ﵧ":"سۛحم","ﶪ":"سۛحى","ﲯ":"سخ","ﴶ":"سخ","ﰞ":"سخ","ﴯ":"سۛخ","ﴹ":"سۛخ","ﴧ":"سۛخ","ﴋ":"سۛخ","ﶨ":"سخى","ﷆ":"سخى","ﴪ":"سر","ﴎ":"سر","ﴩ":"سۛر","ﴍ":"سۛر","ﲰ":"سم","ﳧ":"سم","ﰟ":"سم","ﴰ":"سۛم","ﳩ":"سۛم","ﴨ":"سۛم","ﴌ":"سۛم","ﵡ":"سمج","ﵠ":"سمح","ﵟ":"سمح","ﵫ":"سۛمخ","ﵪ":"سۛمخ","ﵣ":"سمم","ﵢ":"سمم","ﵭ":"سۛمم","ﵬ":"سۛمم","ﴗ":"سى","ﳻ":"سى","ﴘ":"سى","ﳼ":"سى","ﴙ":"سۛى","ﳽ":"سۛى","ﴚ":"سۛى","ﳾ":"سۛى","\uD800\uDEF2":"ص","\uD83B\uDE11":"ص","\uD83B\uDE31":"ص","\uD83B\uDE51":"ص","\uD83B\uDE71":"ص","\uD83B\uDE91":"ص","\uD83B\uDEB1":"ص","ﺻ":"ص","ﺼ":"ص","ﺺ":"ص","ﺹ":"ص","ڞ":"صۛ","ࢯ":"ص̤̣","ﲱ":"صح","ﰠ":"صح","ﵥ":"صحح","ﵤ":"صحح","ﶩ":"صحى","ﲲ":"صخ","ﴫ":"صر","ﴏ":"صر","ﷵ":"صلعم","ﷹ":"صلى","ﷰ":"صلى","ﷺ":"صلى lللo علىo وسلم","ﲳ":"صم","ﰡ":"صم","ﷅ":"صمم","ﵦ":"صمم","ﴡ":"صى","ﴅ":"صى","ﴢ":"صى","ﴆ":"صى","\uD83B\uDE19":"ض","\uD83B\uDE39":"ض","\uD83B\uDE59":"ض","\uD83B\uDE79":"ض","\uD83B\uDE99":"ض","\uD83B\uDEB9":"ض","ﺿ":"ض","ﻀ":"ض","ﺾ":"ض","ﺽ":"ض","ﲴ":"ضج","ﰢ":"ضج","ﲵ":"ضح","ﰣ":"ضح","ﵮ":"ضحى","ﶫ":"ضحى","ﲶ":"ضخ","ﰤ":"ضخ","ﵰ":"ضخم","ﵯ":"ضخم","ﴬ":"ضر","ﴐ":"ضر","ﲷ":"ضم","ﰥ":"ضم","ﴣ":"ضى","ﴇ":"ضى","ﴤ":"ضى","ﴈ":"ضى","\uD800\uDEE8":"ط","\uD83B\uDE08":"ط","\uD83B\uDE68":"ط","\uD83B\uDE88":"ط","\uD83B\uDEA8":"ط","ﻃ":"ط","ﻄ":"ط","ﻂ":"ط","ﻁ":"ط","ڟ":"طۛ","ﲸ":"طح","ﰦ":"طح","ﴳ":"طم","ﴺ":"طم","ﰧ":"طم","ﵲ":"طمح","ﵱ":"طمح","ﵳ":"طمم","ﵴ":"طمى","ﴑ":"طى","ﳵ":"طى","ﴒ":"طى","ﳶ":"طى","\uD83B\uDE1A":"ظ","\uD83B\uDE7A":"ظ","\uD83B\uDE9A":"ظ","\uD83B\uDEBA":"ظ","ﻇ":"ظ","ﻈ":"ظ","ﻆ":"ظ","ﻅ":"ظ","ﲹ":"ظم","ﴻ":"ظم","ﰨ":"ظم","؏":"ع","\uD83B\uDE0F":"ع","\uD83B\uDE2F":"ع","\uD83B\uDE4F":"ع","\uD83B\uDE6F":"ع","\uD83B\uDE8F":"ع","\uD83B\uDEAF":"ع","ﻋ":"ع","ﻌ":"ع","ﻊ":"ع","ﻉ":"ع","ﲺ":"عج","ﰩ":"عج","ﷄ":"عجم","ﵵ":"عجم","ﷷ":"علىo","ﲻ":"عم","ﰪ":"عم","ﵷ":"عمم","ﵶ":"عمم","ﵸ":"عمى","ﶶ":"عمى","ﴓ":"عى","ﳷ":"عى","ﴔ":"عى","ﳸ":"عى","\uD83B\uDE1B":"غ","\uD83B\uDE3B":"غ","\uD83B\uDE5B":"غ","\uD83B\uDE7B":"غ","\uD83B\uDE9B":"غ","\uD83B\uDEBB":"غ","ﻏ":"غ","ﻐ":"غ","ﻎ":"غ","ﻍ":"غ","ﲼ":"غج","ﰫ":"غج","ﲽ":"غم","ﰬ":"غم","ﵹ":"غمم","ﵻ":"غمى","ﵺ":"غمى","ﴕ":"غى","ﳹ":"غى","ﴖ":"غى","ﳺ":"غى","\uD83B\uDE10":"ف","\uD83B\uDE30":"ف","\uD83B\uDE70":"ف","\uD83B\uDE90":"ف","\uD83B\uDEB0":"ف","ﻓ":"ف","ﻔ":"ف","ﻒ":"ف","ﻑ":"ف","ڧ":"ف","ﲾ":"فج","ﰭ":"فج","ﲿ":"فح","ﰮ":"فح","ﳀ":"فخ","ﰯ":"فخ","ﵽ":"فخم","ﵼ":"فخم","ﳁ":"فم","ﰰ":"فم","ﷁ":"فمى","ﱼ":"فى","ﰱ":"فى","ﱽ":"فى","ﰲ":"فى","\uD83B\uDE1E":"ڡ","\uD83B\uDE7E":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","\uD83B\uDE1F":"ڡ","\uD83B\uDE5F":"ڡ","ࢼ":"ڡ","ڤ":"ڡۛ","ﭬ":"ڡۛ","ﭭ":"ڡۛ","ﭫ":"ڡۛ","ﭪ":"ڡۛ","ڨ":"ڡۛ","ࢤ":"ڢۛ","ﭰ":"ڦ","ﭱ":"ڦ","ﭯ":"ڦ","ﭮ":"ڦ","\uD83B\uDE12":"ق","\uD83B\uDE32":"ق","\uD83B\uDE52":"ق","\uD83B\uDE72":"ق","\uD83B\uDE92":"ق","\uD83B\uDEB2":"ق","ﻗ":"ق","ﻘ":"ق","ﻖ":"ق","ﻕ":"ق","ﳂ":"قح","ﰳ":"قح","ﷱ":"قلى","ﳃ":"قم","ﰴ":"قم","ﶴ":"قمح","ﵾ":"قمح","ﵿ":"قمم","ﶲ":"قمى","ﱾ":"قى","ﰵ":"قى","ﱿ":"قى","ﰶ":"قى","\uD83B\uDE0A":"ك","\uD83B\uDE2A":"ك","\uD83B\uDE6A":"ك","ﻛ":"ك","ﻜ":"ك","ﻚ":"ك","ﻙ":"ك","ک":"ك","ﮐ":"ك","ﮑ":"ك","ﮏ":"ك","ﮎ":"ك","ڪ":"ك","ڭ":"كۛ","ﯕ":"كۛ","ﯖ":"كۛ","ﯔ":"كۛ","ﯓ":"كۛ","ݣ":"كۛ","ﲀ":"كl","ﰷ":"كl","ﳄ":"كج","ﰸ":"كج","ﳅ":"كح","ﰹ":"كح","ﳆ":"كخ","ﰺ":"كخ","ﳇ":"كل","ﳫ":"كل","ﲁ":"كل","ﰻ":"كل","ﳈ":"كم","ﳬ":"كم","ﲂ":"كم","ﰼ":"كم","ﷃ":"كمم","ﶻ":"كمم","ﶷ":"كمى","ﲃ":"كى","ﰽ":"كى","ﲄ":"كى","ﰾ":"كى","ݢ":"ڬ","ﮔ":"گ","ﮕ":"گ","ﮓ":"گ","ﮒ":"گ","ࢰ":"گ","ڴ":"گۛ","ﮜ":"ڱ","ﮝ":"ڱ","ﮛ":"ڱ","ﮚ":"ڱ","ﮘ":"ڳ","ﮙ":"ڳ","ﮗ":"ڳ","ﮖ":"ڳ","\uD83B\uDE0B":"ل","\uD83B\uDE2B":"ل","\uD83B\uDE4B":"ل","\uD83B\uDE8B":"ل","\uD83B\uDEAB":"ل","ﻟ":"ل","ﻠ":"ل","ﻞ":"ل","ﻝ":"ل","ڷ":"لۛ","ڵ":"ل̆","ﻼ":"لl","ﻻ":"لl","ﻺ":"لlٕ","ﻹ":"لlٕ","ﻸ":"لlٴ","ﻷ":"لlٴ","ﳍ":"لo","ﻶ":"لآ","ﻵ":"لآ","ﳉ":"لج","ﰿ":"لج","ﶃ":"لجج","ﶄ":"لجج","ﶺ":"لجم","ﶼ":"لجم","ﶬ":"لجى","ﳊ":"لح","ﱀ":"لح","ﶵ":"لحم","ﶀ":"لحم","ﶂ":"لحى","ﶁ":"لحى","ﳋ":"لخ","ﱁ":"لخ","ﶆ":"لخم","ﶅ":"لخم","ﳌ":"لم","ﳭ":"لم","ﲅ":"لم","ﱂ":"لم","ﶈ":"لمح","ﶇ":"لمح","ﶭ":"لمى","ﲆ":"لى","ﱃ":"لى","ﲇ":"لى","ﱄ":"لى","\uD83B\uDE0C":"م","\uD83B\uDE2C":"م","\uD83B\uDE6C":"م","\uD83B\uDE8C":"م","\uD83B\uDEAC":"م","ﻣ":"م","ﻤ":"م","ﻢ":"م","ﻡ":"م","ࢧ":"مۛ","۾":"م͈","ﲈ":"مl","ﳎ":"مج","ﱅ":"مج","ﶌ":"مجح","ﶒ":"مجخ","ﶍ":"مجم","ﷀ":"مجى","ﳏ":"مح","ﱆ":"مح","ﶉ":"محج","ﶊ":"محم","ﷴ":"محمد","ﶋ":"محى","ﳐ":"مخ","ﱇ":"مخ","ﶎ":"مخج","ﶏ":"مخم","ﶹ":"مخى","ﳑ":"مم","ﲉ":"مم","ﱈ":"مم","ﶱ":"ممى","ﱉ":"مى","ﱊ":"مى","\uD83B\uDE0D":"ن","\uD83B\uDE2D":"ن","\uD83B\uDE4D":"ن","\uD83B\uDE6D":"ن","\uD83B\uDE8D":"ن","\uD83B\uDEAD":"ن","ﻧ":"ن","ﻨ":"ن","ﻦ":"ن","ﻥ":"ن","ݨ":"نؕ","ݩ":"ن̆","ﳖ":"نo","ﳯ":"نo","ﶸ":"نجح","ﶽ":"نجح","ﶘ":"نجم","ﶗ":"نجم","ﶙ":"نجى","ﷇ":"نجى","ﳓ":"نح","ﱌ":"نح","ﶕ":"نحم","ﶖ":"نحى","ﶳ":"نحى","ﳔ":"نخ","ﱍ":"نخ","ﲊ":"نر","ﲋ":"نز","ﳕ":"نم","ﳮ":"نم","ﲌ":"نم","ﱎ":"نم","ﶛ":"نمى","ﶚ":"نمى","ﲍ":"نن","ﲎ":"نى","ﱏ":"نى","ﲏ":"نى","ﱐ":"نى","ۂ":"ۀ","ﮥ":"ۀ","ﮤ":"ۀ","\uD800\uDEE4":"و","\uD83B\uDE05":"و","\uD83B\uDE85":"و","\uD83B\uDEA5":"و","ﻮ":"و","ﻭ":"و","ࢱ":"و","ۋ":"وۛ","ﯟ":"وۛ","ﯞ":"وۛ","ۇ":"و̓","ﯘ":"و̓","ﯗ":"و̓","ۆ":"و̆","ﯚ":"و̆","ﯙ":"و̆","ۉ":"و̂","ﯣ":"و̂","ﯢ":"و̂","ۈ":"وٰ","ﯜ":"وٰ","ﯛ":"وٰ","ؤ":"وٴ","ﺆ":"وٴ","ﺅ":"وٴ","ٶ":"وٴ","ٷ":"و̓ٴ","ﯝ":"و̓ٴ","ﷸ":"وسلم","ﯡ":"ۅ","ﯠ":"ۅ","ٮ":"ى","\uD83B\uDE1C":"ى","\uD83B\uDE7C":"ى","ں":"ى","\uD83B\uDE1D":"ى","\uD83B\uDE5D":"ى","ﮟ":"ى","ﮞ":"ى","ࢽ":"ى","ﯨ":"ى","ﯩ":"ى","ﻰ":"ى","ﻯ":"ى","ي":"ى","\uD83B\uDE09":"ى","\uD83B\uDE29":"ى","\uD83B\uDE49":"ى","\uD83B\uDE69":"ى","\uD83B\uDE89":"ى","\uD83B\uDEA9":"ى","ﻳ":"ى","ﻴ":"ى","ﻲ":"ى","ﻱ":"ى","ی":"ى","ﯾ":"ى","ﯿ":"ى","ﯽ":"ى","ﯼ":"ى","ے":"ى","ﮯ":"ى","ﮮ":"ى","ٹ":"ىؕ","ﭨ":"ىؕ","ﭩ":"ىؕ","ﭧ":"ىؕ","ﭦ":"ىؕ","ڻ":"ىؕ","ﮢ":"ىؕ","ﮣ":"ىؕ","ﮡ":"ىؕ","ﮠ":"ىؕ","پ":"ىۛ","ﭘ":"ىۛ","ﭙ":"ىۛ","ﭗ":"ىۛ","ﭖ":"ىۛ","ث":"ىۛ","\uD83B\uDE16":"ىۛ","\uD83B\uDE36":"ىۛ","\uD83B\uDE76":"ىۛ","\uD83B\uDE96":"ىۛ","\uD83B\uDEB6":"ىۛ","ﺛ":"ىۛ","ﺜ":"ىۛ","ﺚ":"ىۛ","ﺙ":"ىۛ","ڽ":"ىۛ","ۑ":"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆","ێ":"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ","ﲐ":"ىٰ","ﱝ":"ىٰ","ﳞ":"ىo","ﳱ":"ىo","ﳦ":"ىۛo","ئ":"ىٴ","ﺋ":"ىٴ","ﺌ":"ىٴ","ﺊ":"ىٴ","ﺉ":"ىٴ","ٸ":"ىٴ","ﯫ":"ىٴl","ﯪ":"ىٴl","ﲛ":"ىٴo","ﳠ":"ىٴo","ﯭ":"ىٴo","ﯬ":"ىٴo","ﯸ":"ىٴٻ","ﯷ":"ىٴٻ","ﯶ":"ىٴٻ","ﲗ":"ىٴج","ﰀ":"ىٴج","ﲘ":"ىٴح","ﰁ":"ىٴح","ﲙ":"ىٴخ","ﱤ":"ىٴر","ﱥ":"ىٴز","ﲚ":"ىٴم","ﳟ":"ىٴم","ﱦ":"ىٴم","ﰂ":"ىٴم","ﱧ":"ىٴن","ﯯ":"ىٴو","ﯮ":"ىٴو","ﯱ":"ىٴو̓","ﯰ":"ىٴو̓","ﯳ":"ىٴو̆","ﯲ":"ىٴو̆","ﯵ":"ىٴوٰ","ﯴ":"ىٴوٰ","ﯻ":"ىٴى","ﯺ":"ىٴى","ﱨ":"ىٴى","ﯹ":"ىٴى","ﰃ":"ىٴى","ﱩ":"ىٴى","ﰄ":"ىٴى","ﳚ":"ىج","ﱕ":"ىج","ﰑ":"ىۛج","ﶯ":"ىجى","ﳛ":"ىح","ﱖ":"ىح","ﶮ":"ىحى","ﳜ":"ىخ","ﱗ":"ىخ","ﲑ":"ىر","ﱶ":"ىۛر","ﲒ":"ىز","ﱷ":"ىۛز","ﳝ":"ىم","ﳰ":"ىم","ﲓ":"ىم","ﱘ":"ىم","ﲦ":"ىۛم","ﳥ":"ىۛم","ﱸ":"ىۛم","ﰒ":"ىۛم","ﶝ":"ىمم","ﶜ":"ىمم","ﶰ":"ىمى","ﲔ":"ىن","ﱹ":"ىۛن","ﲕ":"ىى","ﱙ":"ىى","ﲖ":"ىى","ﱚ":"ىى","ﱺ":"ىۛى","ﰓ":"ىۛى","ﱻ":"ىۛى","ﰔ":"ىۛى","ﮱ":"ۓ","ﮰ":"ۓ","\uD800\uDEB8":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ","Մ":"ሆ","Ռ":"ቡ","Ի":"ኮ","Պ":"ጣ","आ":"अा","ऒ":"अाॆ","ओ":"अाे","औ":"अाै","ऄ":"अॆ","ऑ":"अॉ","ऍ":"एॅ","ऎ":"एॆ","ऐ":"एे","ई":"र्इ","ઽ":"ऽ","\uD804\uDDDC":"ꣻ","\uD804\uDDCB":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्","আ":"অা","ৠ":"ঋৃ","ৡ":"ঋৃ","\uD805\uDC92":"ঘ","\uD805\uDC94":"চ","\uD805\uDC96":"জ","\uD805\uDC98":"ঞ","\uD805\uDC99":"ট","\uD805\uDC9B":"ড","\uD805\uDCAA":"ণ","\uD805\uDC9E":"ত","\uD805\uDC9F":"থ","\uD805\uDCA0":"দ","\uD805\uDCA1":"ধ","\uD805\uDCA2":"ন","\uD805\uDCA3":"প","\uD805\uDCA9":"ব","\uD805\uDCA7":"ম","\uD805\uDCA8":"য","\uD805\uDCAB":"র","\uD805\uDC9D":"ল","\uD805\uDCAD":"ষ","\uD805\uDCAE":"স","\uD805\uDCC4":"ঽ","\uD805\uDCB0":"া","\uD805\uDCB1":"ি","\uD805\uDCB9":"ে","\uD805\uDCBC":"ো","\uD805\uDCBE":"ৌ","\uD805\uDCC2":"্","\uD805\uDCBD":"ৗ","ਉ":"ੳੁ","ਊ":"ੳੂ","ਆ":"ਅਾ","ਐ":"ਅੈ","ਔ":"ਅੌ","ਇ":"ੲਿ","ਈ":"ੲੀ","ਏ":"ੲੇ","આ":"અા","ઑ":"અાૅ","ઓ":"અાે","ઔ":"અાૈ","ઍ":"અૅ","એ":"અે","ઐ":"અૈ","ଆ":"ଅା","௮":"அ","ர":"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ","ഉ":"உ","ஊ":"உள","ഊ":"உൗ","௭":"எ","௷":"எவ","ஜ":"ஐ","ജ":"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி","ണ":"ண","௺":"நீ","௴":"மீ","௰":"ய","ഴ":"ழ","ௗ":"ள","ை":"ன","ശ":"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ","ಅ":"అ","ಆ":"ఆ","ಇ":"ఇ","ౠ":"ఋా","ౡ":"ఌా","ಒ":"ఒ","ఔ":"ఒౌ","ಔ":"ఒౌ","ఓ":"ఒౕ","ಓ":"ఒౕ","ಜ":"జ","ಞ":"ఞ","ఢ":"డ̣","ಣ":"ణ","థ":"ధּ","భ":"బ̣","ಯ":"య","ఠ":"రּ","ಱ":"ఱ","ಲ":"ల","ష":"వ̣","హ":"వా","మ":"వు","ూ":"ుా","ౄ":"ృా","ೡ":"ಌಾ","ഈ":"ഇൗ","ഐ":"എെ","ഓ":"ഒാ","ഔ":"ഒൗ","ൡ":"ഞ","൫":"ദ്ര","൹":"നു","ഌ":"നു","ങ":"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ","റ":"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","\uD805\uDC13":"\uD805\uDC34\uD805\uDC42\uD805\uDC12","\uD805\uDC19":"\uD805\uDC34\uD805\uDC42\uD805\uDC18","\uD805\uDC24":"\uD805\uDC34\uD805\uDC42\uD805\uDC23","\uD805\uDC2A":"\uD805\uDC34\uD805\uDC42\uD805\uDC29","\uD805\uDC2D":"\uD805\uDC34\uD805\uDC42\uD805\uDC2C","\uD805\uDC2F":"\uD805\uDC34\uD805\uDC42\uD805\uDC2E","\uD805\uDDD8":"\uD805\uDD82","\uD805\uDDD9":"\uD805\uDD82","\uD805\uDDDA":"\uD805\uDD83","\uD805\uDDDB":"\uD805\uDD84","\uD805\uDDDC":"\uD805\uDDB2","\uD805\uDDDD":"\uD805\uDDB3","ฃ":"ข","ด":"ค","ต":"ค","ม":"ฆ","ຈ":"จ","ซ":"ช","ฏ":"ฎ","ท":"ฑ","ບ":"บ","ປ":"ป","ຝ":"ฝ","ພ":"พ","ຟ":"ฟ","ฦ":"ภ","ຍ":"ย","។":"ฯ","ๅ":"า","ำ":"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู","แ":"เเ","ໜ":"ຫນ","ໝ":"ຫມ","ຳ":"̊າ","༂":"འུྂཿ","༃":"འུྂ༔","ཪ":"ར","ༀ":"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","\uD807\uDCB2":"\uD807\uDCAA","ႁ":"ဂှ","က":"ဂာ","ၰ":"ဃှ","ၦ":"ပှ","ဟ":"ပာ","ၯ":"ပာှ","ၾ":"ၽှ","ဩ":"သြ","ဪ":"သြော်","႞":"ႃ̊","ឣ":"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ","ᢖ":"ᡜ","ᡕ":"ᠵ","ῶ":"Ꮿ","ᐍ":"ᐁ\xb7","ᐫ":"ᐁᐠ","ᐑ":"ᐄ\xb7","ᐓ":"ᐅ\xb7","ᐭ":"ᐅᐠ","ᐕ":"ᐆ\xb7","ᐘ":"ᐊ\xb7","ᐮ":"ᐊᐠ","ᐚ":"ᐋ\xb7","ᣝ":"ᐞᣟ","ᓑ":"ᐡ","ᕀ":"ᐩ","ᐿ":"ᐲ\xb7","ᑃ":"ᐴ\xb7","⍩":"ᐵ","ᑇ":"ᐹ\xb7","ᑜ":"ᑏ\xb7","⸧":"ᑐ","⊃":"ᑐ","ᑞ":"ᑐ\xb7","ᑩ":"ᑐ\'","⟉":"ᑐ/","⫗":"ᑐᑕ","ᑠ":"ᑑ\xb7","⸦":"ᑕ","⊂":"ᑕ","ᑢ":"ᑕ\xb7","ᑪ":"ᑕ\'","ᑤ":"ᑖ\xb7","ᑵ":"ᑫ\xb7","ᒅ":"ᑫ\'","ᑹ":"ᑮ\xb7","ᑽ":"ᑰ\xb7","ᘃ":"ᒉ","ᒓ":"ᒉ\xb7","ᒕ":"ᒋ\xb7","ᒗ":"ᒌ\xb7","ᒛ":"ᒎ\xb7","ᘂ":"ᒐ","ᒝ":"ᒐ\xb7","ᒟ":"ᒑ\xb7","ᒭ":"ᒣ\xb7","ᒱ":"ᒦ\xb7","ᒳ":"ᒧ\xb7","ᒵ":"ᒨ\xb7","ᒹ":"ᒫ\xb7","ᓊ":"ᓀ\xb7","ᣇ":"ᓂ\xb7","ᣉ":"ᓃ\xb7","ᣋ":"ᓄ\xb7","ᣍ":"ᓅ\xb7","ᓌ":"ᓇ\xb7","ᓎ":"ᓈ\xb7","ᘄ":"ᓓ","ᓝ":"ᓓ\xb7","ᓟ":"ᓕ\xb7","ᓡ":"ᓖ\xb7","ᓣ":"ᓗ\xb7","ᓥ":"ᓘ\xb7","ᘇ":"ᓚ","ᓧ":"ᓚ\xb7","ᓩ":"ᓛ\xb7","ᓷ":"ᓭ\xb7","ᓹ":"ᓯ\xb7","ᓻ":"ᓰ\xb7","ᓽ":"ᓱ\xb7","ᓿ":"ᓲ\xb7","ᔁ":"ᓴ\xb7","ᔃ":"ᓵ\xb7","ᔌ":"ᔋ<","ᔎ":"ᔋb","ᔍ":"ᔋᑕ","ᔏ":"ᔋᒐ","ᔘ":"ᔐ\xb7","ᔚ":"ᔑ\xb7","ᔜ":"ᔒ\xb7","ᔞ":"ᔓ\xb7","ᔠ":"ᔔ\xb7","ᔢ":"ᔕ\xb7","ᔤ":"ᔖ\xb7","ᔲ":"ᔨ\xb7","ᔴ":"ᔩ\xb7","ᔶ":"ᔪ\xb7","ᔸ":"ᔫ\xb7","ᔺ":"ᔭ\xb7","ᔼ":"ᔮ\xb7","ᘢ":"ᕃ","ᣠ":"ᕃ\xb7","ᘣ":"ᕆ","ᘤ":"ᕊ","ᕏ":"ᕌ\xb7","ᖃ":"ᕐb","ᖄ":"ᕐḃ","ᖁ":"ᕐd","ᕿ":"ᕐP","ᙯ":"ᕐᑫ","ᕾ":"ᕐᑬ","ᖀ":"ᕐᑮ","ᖂ":"ᕐᑰ","ᖅ":"ᕐᒃ","ᕜ":"ᕚ\xb7","ᣣ":"ᕞ\xb7","ᣤ":"ᕦ\xb7","ᕩ":"ᕧ\xb7","ᣥ":"ᕫ\xb7","ᣨ":"ᖆ\xb7","ᖑ":"ᖕJ","ᙰ":"ᖕᒉ","ᖎ":"ᖕᒊ","ᖏ":"ᖕᒋ","ᖐ":"ᖕᒌ","ᖒ":"ᖕᒎ","ᖓ":"ᖕᒐ","ᖔ":"ᖕᒑ","ᙳ":"ᖖJ","ᙱ":"ᖖᒋ","ᙲ":"ᖖᒌ","ᙴ":"ᖖᒎ","ᙵ":"ᖖᒐ","ᙶ":"ᖖᒑ","ᣪ":"ᖗ\xb7","ᙷ":"ᖧ\xb7","ᙸ":"ᖨ\xb7","ᙹ":"ᖩ\xb7","ᙺ":"ᖪ\xb7","ᙻ":"ᖫ\xb7","ᙼ":"ᖬ\xb7","ᙽ":"ᖭ\xb7","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ\xb7","ᣲ":"ᘛ\xb7","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ","ˡ":"ᣳ","ʳ":"ᣴ","ˢ":"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ","ᛡ":"ᚼ","⍿":"ᚽ","ᛂ":"ᚽ","\uD834\uDE3F":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","\uD83D\uDF54":"ᛜ","\uD806\uDCB7":"ᛜ","\uD800\uDE94":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","\uD801\uDCD0":"ᛦ","↕":"ᛨ","\uD803\uDCFC":"\uD803\uDC82","\uD803\uDCFA":"\uD803\uDCA5","ㄱ":"ᄀ","ᆨ":"ᄀ","ᄁ":"ᄀᄀ","ㄲ":"ᄀᄀ","ᆩ":"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ","ᇃ":"ᄀᄅ","ᇻ":"ᄀᄇ","ᆪ":"ᄀᄉ","ㄳ":"ᄀᄉ","ᇄ":"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ","ㄴ":"ᄂ","ᆫ":"ᄂ","ᄓ":"ᄂᄀ","ᇅ":"ᄂᄀ","ᄔ":"ᄂᄂ","ㅥ":"ᄂᄂ","ᇿ":"ᄂᄂ","ᄕ":"ᄂᄃ","ㅦ":"ᄂᄃ","ᇆ":"ᄂᄃ","ퟋ":"ᄂᄅ","ᄖ":"ᄂᄇ","ᅛ":"ᄂᄉ","ᇇ":"ᄂᄉ","ㅧ":"ᄂᄉ","ᅜ":"ᄂᄌ","ᆬ":"ᄂᄌ","ㄵ":"ᄂᄌ","ퟌ":"ᄂᄎ","ᇉ":"ᄂᄐ","ᅝ":"ᄂᄒ","ᆭ":"ᄂᄒ","ㄶ":"ᄂᄒ","ᇈ":"ᄂᅀ","ㅨ":"ᄂᅀ","ㄷ":"ᄃ","ᆮ":"ᄃ","ᄗ":"ᄃᄀ","ᇊ":"ᄃᄀ","ᄄ":"ᄃᄃ","ㄸ":"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ","ᇋ":"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ","ㄹ":"ᄅ","ᆯ":"ᄅ","ꥤ":"ᄅᄀ","ᆰ":"ᄅᄀ","ㄺ":"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ","ᇌ":"ᄅᄀᄉ","ㅩ":"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ","ᄘ":"ᄅᄂ","ᇍ":"ᄅᄂ","ꥦ":"ᄅᄃ","ᇎ":"ᄅᄃ","ㅪ":"ᄅᄃ","ꥧ":"ᄅᄃᄃ","ᇏ":"ᄅᄃᄒ","ᄙ":"ᄅᄅ","ᇐ":"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ","ᆱ":"ᄅᄆ","ㄻ":"ᄅᄆ","ᇑ":"ᄅᄆᄀ","ᇒ":"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ","ᆲ":"ᄅᄇ","ㄼ":"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ","ᇓ":"ᄅᄇᄉ","ㅫ":"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ","ᇕ":"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ","ᇔ":"ᄅᄇᄒ","ꥬ":"ᄅᄉ","ᆳ":"ᄅᄉ","ㄽ":"ᄅᄉ","ᇖ":"ᄅᄉᄉ","ᄛ":"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ","ᇘ":"ᄅᄏ","ᆴ":"ᄅᄐ","ㄾ":"ᄅᄐ","ᆵ":"ᄅᄑ","ㄿ":"ᄅᄑ","ᄚ":"ᄅᄒ","ㅀ":"ᄅᄒ","ᄻ":"ᄅᄒ","ᆶ":"ᄅᄒ","ퟲ":"ᄅᄒ","ᇗ":"ᄅᅀ","ㅬ":"ᄅᅀ","ퟛ":"ᄅᅌ","ᇙ":"ᄅᅙ","ㅭ":"ᄅᅙ","ퟜ":"ᄅᅙᄒ","ㅁ":"ᄆ","ᆷ":"ᄆ","ꥯ":"ᄆᄀ","ᇚ":"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ","ᇛ":"ᄆᄅ","ퟠ":"ᄆᄆ","ᄜ":"ᄆᄇ","ㅮ":"ᄆᄇ","ᇜ":"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ","ᇝ":"ᄆᄉ","ㅯ":"ᄆᄉ","ᇞ":"ᄆᄉᄉ","ᄝ":"ᄆᄋ","ㅱ":"ᄆᄋ","ᇢ":"ᄆᄋ","ퟢ":"ᄆᄌ","ᇠ":"ᄆᄎ","ᇡ":"ᄆᄒ","ᇟ":"ᄆᅀ","ㅰ":"ᄆᅀ","ㅂ":"ᄇ","ᆸ":"ᄇ","ᄞ":"ᄇᄀ","ㅲ":"ᄇᄀ","ᄟ":"ᄇᄂ","ᄠ":"ᄇᄃ","ㅳ":"ᄇᄃ","ퟣ":"ᄇᄃ","ᇣ":"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ","ᄈ":"ᄇᄇ","ㅃ":"ᄇᄇ","ퟦ":"ᄇᄇ","ᄬ":"ᄇᄇᄋ","ㅹ":"ᄇᄇᄋ","ᄡ":"ᄇᄉ","ㅄ":"ᄇᄉ","ᆹ":"ᄇᄉ","ᄢ":"ᄇᄉᄀ","ㅴ":"ᄇᄉᄀ","ᄣ":"ᄇᄉᄃ","ㅵ":"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ","ᄤ":"ᄇᄉᄇ","ᄥ":"ᄇᄉᄉ","ᄦ":"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ","ᄫ":"ᄇᄋ","ㅸ":"ᄇᄋ","ᇦ":"ᄇᄋ","ᄧ":"ᄇᄌ","ㅶ":"ᄇᄌ","ퟨ":"ᄇᄌ","ᄨ":"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ","ᄩ":"ᄇᄐ","ㅷ":"ᄇᄐ","ᄪ":"ᄇᄑ","ᇤ":"ᄇᄑ","ꥴ":"ᄇᄒ","ᇥ":"ᄇᄒ","ㅅ":"ᄉ","ᆺ":"ᄉ","ᄭ":"ᄉᄀ","ㅺ":"ᄉᄀ","ᇧ":"ᄉᄀ","ᄮ":"ᄉᄂ","ㅻ":"ᄉᄂ","ᄯ":"ᄉᄃ","ㅼ":"ᄉᄃ","ᇨ":"ᄉᄃ","ᄰ":"ᄉᄅ","ᇩ":"ᄉᄅ","ᄱ":"ᄉᄆ","ퟪ":"ᄉᄆ","ᄲ":"ᄉᄇ","ㅽ":"ᄉᄇ","ᇪ":"ᄉᄇ","ᄳ":"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ","ᄊ":"ᄉᄉ","ㅆ":"ᄉᄉ","ᆻ":"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ","ᄴ":"ᄉᄉᄉ","ᄵ":"ᄉᄋ","ᄶ":"ᄉᄌ","ㅾ":"ᄉᄌ","ퟯ":"ᄉᄌ","ᄷ":"ᄉᄎ","ퟰ":"ᄉᄎ","ᄸ":"ᄉᄏ","ᄹ":"ᄉᄐ","ퟱ":"ᄉᄐ","ᄺ":"ᄉᄑ","ퟮ":"ᄉᅀ","ㅇ":"ᄋ","ᆼ":"ᄋ","ᅁ":"ᄋᄀ","ᇬ":"ᄋᄀ","ᇭ":"ᄋᄀᄀ","ᅂ":"ᄋᄃ","ꥶ":"ᄋᄅ","ᅃ":"ᄋᄆ","ᅄ":"ᄋᄇ","ᅅ":"ᄋᄉ","ᇱ":"ᄋᄉ","ㆂ":"ᄋᄉ","ᅇ":"ᄋᄋ","ㆀ":"ᄋᄋ","ᇮ":"ᄋᄋ","ᅈ":"ᄋᄌ","ᅉ":"ᄋᄎ","ᇯ":"ᄋᄏ","ᅊ":"ᄋᄐ","ᅋ":"ᄋᄑ","ꥷ":"ᄋᄒ","ᅆ":"ᄋᅀ","ᇲ":"ᄋᅀ","ㆃ":"ᄋᅀ","ㅈ":"ᄌ","ᆽ":"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ","ᅍ":"ᄌᄋ","ᄍ":"ᄌᄌ","ㅉ":"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ","ㅊ":"ᄎ","ᆾ":"ᄎ","ᅒ":"ᄎᄏ","ᅓ":"ᄎᄒ","ㅋ":"ᄏ","ᆿ":"ᄏ","ㅌ":"ᄐ","ᇀ":"ᄐ","ꥹ":"ᄐᄐ","ㅍ":"ᄑ","ᇁ":"ᄑ","ᅖ":"ᄑᄇ","ᇳ":"ᄑᄇ","ퟺ":"ᄑᄉ","ᅗ":"ᄑᄋ","ㆄ":"ᄑᄋ","ᇴ":"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ","ㅎ":"ᄒ","ᇂ":"ᄒ","ᇵ":"ᄒᄂ","ᇶ":"ᄒᄅ","ᇷ":"ᄒᄆ","ᇸ":"ᄒᄇ","ꥻ":"ᄒᄉ","ᅘ":"ᄒᄒ","ㆅ":"ᄒᄒ","ᄽ":"ᄼᄼ","ᄿ":"ᄾᄾ","ㅿ":"ᅀ","ᇫ":"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ","ㆁ":"ᅌ","ᇰ":"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ","ᅏ":"ᅎᅎ","ᅑ":"ᅐᅐ","ㆆ":"ᅙ","ᇹ":"ᅙ","ꥼ":"ᅙᅙ","ㅤ":"ᅠ","ㅏ":"ᅡ","ᆣ":"ᅡー","ᅶ":"ᅡᅩ","ᅷ":"ᅡᅮ","ᅢ":"ᅡ丨","ㅐ":"ᅡ丨","ㅑ":"ᅣ","ᅸ":"ᅣᅩ","ᅹ":"ᅣᅭ","ᆤ":"ᅣᅮ","ᅤ":"ᅣ丨","ㅒ":"ᅣ丨","ㅓ":"ᅥ","ᅼ":"ᅥー","ᅺ":"ᅥᅩ","ᅻ":"ᅥᅮ","ᅦ":"ᅥ丨","ㅔ":"ᅥ丨","ㅕ":"ᅧ","ᆥ":"ᅧᅣ","ᅽ":"ᅧᅩ","ᅾ":"ᅧᅮ","ᅨ":"ᅧ丨","ㅖ":"ᅧ丨","ㅗ":"ᅩ","ᅪ":"ᅩᅡ","ㅘ":"ᅩᅡ","ᅫ":"ᅩᅡ丨","ㅙ":"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨","ᅿ":"ᅩᅥ","ᆀ":"ᅩᅥ丨","ힰ":"ᅩᅧ","ᆁ":"ᅩᅧ丨","ᆂ":"ᅩᅩ","ힱ":"ᅩᅩ丨","ᆃ":"ᅩᅮ","ᅬ":"ᅩ丨","ㅚ":"ᅩ丨","ㅛ":"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨","ᆄ":"ᅭᅣ","ㆇ":"ᅭᅣ","ᆆ":"ᅭᅣ","ᆅ":"ᅭᅣ丨","ㆈ":"ᅭᅣ丨","ힴ":"ᅭᅥ","ᆇ":"ᅭᅩ","ᆈ":"ᅭ丨","ㆉ":"ᅭ丨","ㅜ":"ᅮ","ᆉ":"ᅮᅡ","ᆊ":"ᅮᅡ丨","ᅯ":"ᅮᅥ","ㅝ":"ᅮᅥ","ᆋ":"ᅮᅥー","ᅰ":"ᅮᅥ丨","ㅞ":"ᅮᅥ丨","ힵ":"ᅮᅧ","ᆌ":"ᅮᅧ丨","ᆍ":"ᅮᅮ","ᅱ":"ᅮ丨","ㅟ":"ᅮ丨","ힶ":"ᅮ丨丨","ㅠ":"ᅲ","ᆎ":"ᅲᅡ","ힷ":"ᅲᅡ丨","ᆏ":"ᅲᅥ","ᆐ":"ᅲᅥ丨","ᆑ":"ᅲᅧ","ㆊ":"ᅲᅧ","ᆒ":"ᅲᅧ丨","ㆋ":"ᅲᅧ丨","ힸ":"ᅲᅩ","ᆓ":"ᅲᅮ","ᆔ":"ᅲ丨","ㆌ":"ᅲ丨","ㆍ":"ᆞ","ퟅ":"ᆞᅡ","ᆟ":"ᆞᅥ","ퟆ":"ᆞᅥ丨","ᆠ":"ᆞᅮ","ᆢ":"ᆞᆞ","ᆡ":"ᆞ丨","ㆎ":"ᆞ丨","ヘ":"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","\uD834\uDE1C":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","\uD834\uDE15":"ꓶ","\uD834\uDE2B":"ꓶ","\uD81B\uDF26":"ꓶ","\uD801\uDC11":"ꓶ","⅃":"\uD81B\uDF00","\uD806\uDEE6":"\uD806\uDEE5\uD806\uDEEF","\uD806\uDEE8":"\uD806\uDEE5\uD806\uDEE5","\uD806\uDEE9":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEEF","\uD806\uDEEA":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEF0","\uD806\uDEE7":"\uD806\uDEE5\uD806\uDEF0","\uD806\uDEF4":"\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF6":"\uD806\uDEF3\uD806\uDEF3","\uD806\uDEF7":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF8":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEF0","\uD806\uDEF5":"\uD806\uDEF3\uD806\uDEF0","\uD806\uDEEC":"\uD806\uDEEB\uD806\uDEEF","\uD806\uDEED":"\uD806\uDEEB\uD806\uDEEB","\uD806\uDEEE":"\uD806\uDEEB\uD806\uDEEB\uD806\uDEEF","⊕":"\uD800\uDEA8","⨁":"\uD800\uDEA8","\uD83D\uDF28":"\uD800\uDEA8","Ꚛ":"\uD800\uDEA8","▽":"\uD800\uDEBC","\uD834\uDE14":"\uD800\uDEBC","\uD83D\uDF04":"\uD800\uDEBC","⧖":"\uD800\uDEC0","ꞛ":"\uD801\uDC3A","Ꞛ":"\uD801\uDC12","\uD801\uDCA0":"\uD801\uDC86","\uD800\uDFD1":"\uD800\uDF82","\uD800\uDFD3":"\uD800\uDF93","\uD808\uDC38":"\uD800\uDF9A","☥":"\uD802\uDD9E","\uD80C\uDEF9":"\uD802\uDD9E","〹":"卄","不":"不","\uD87E\uDC00":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨","ᅵ":"丨","ㅣ":"丨","⼁":"丨","ᆜ":"丨ー","ᆘ":"丨ᅡ","ᆙ":"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨","ᆚ":"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ","ᆛ":"丨ᅮ","ퟃ":"丨ᅲ","ᆝ":"丨ᆞ","ퟄ":"丨丨","串":"串","\uD87E\uDC01":"丸","丹":"丹","\uD87E\uDC02":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀","亂":"亂","㇚":"亅","⼅":"亅","了":"了","ニ":"二","⼆":"二","\uD87E\uDC03":"\uD840\uDD22","⼇":"亠","亮":"亮","⼈":"人","イ":"亻","⺅":"亻","什":"什","\uD87E\uDC19":"仌","令":"令","\uD87E\uDC04":"你","倂":"併","\uD87E\uDC07":"併","侀":"侀","來":"來","例":"例","侮":"侮","\uD87E\uDC05":"侮","\uD87E\uDC06":"侻","便":"便","值":"値","倫":"倫","\uD87E\uDC08":"偺","\uD87E\uDC09":"備","\uD87E\uDC0B":"像","僚":"僚","僧":"僧","\uD87E\uDC0A":"僧","\uD87E\uDC0C":"㒞","⼉":"儿","兀":"兀","⺎":"兀","充":"充","免":"免","\uD87E\uDC0E":"免","\uD87E\uDC0F":"兔","\uD87E\uDC10":"兤","⼊":"入","\uD87E\uDC14":"內","全":"全","兩":"兩","ハ":"八","⼋":"八","六":"六","\uD87E\uDC11":"具","\uD87E\uDC12":"\uD841\uDD1C","\uD87E\uDD1B":"\uD841\uDD25","冀":"冀","\uD87E\uDC13":"㒹","⼌":"冂","\uD87E\uDC15":"再","\uD87E\uDC16":"\uD841\uDD4B","\uD87E\uDCD2":"冒","\uD87E\uDCD3":"冕","\uD87E\uDDCA":"㒻","\uD87E\uDCD4":"最","⼍":"冖","\uD87E\uDC17":"冗","\uD87E\uDC18":"冤","⼎":"冫","\uD87E\uDC1A":"冬","况":"况","\uD87E\uDC1B":"况","冷":"冷","凉":"凉","凌":"凌","凜":"凜","凞":"凞","⼏":"几","\uD87E\uDC0D":"\uD841\uDE3A","\uD87E\uDC1D":"凵","⼐":"凵","⼑":"刀","⺉":"刂","\uD87E\uDC1E":"刃","切":"切","\uD87E\uDC50":"切","列":"列","利":"利","\uD87E\uDC1F":"㓟","刺":"刺","\uD87E\uDC20":"刻","\uD87E\uDC21":"剆","\uD87E\uDC22":"割","\uD87E\uDC23":"剷","劉":"劉","\uD87E\uDDD9":"\uD842\uDC04","カ":"力","力":"力","⼒":"力","劣":"劣","\uD87E\uDC24":"㔕","\uD87E\uDD92":"劳","勇":"勇","\uD87E\uDC25":"勇","勉":"勉","\uD87E\uDC26":"勉","勒":"勒","勞":"勞","勤":"勤","\uD87E\uDC27":"勤","勵":"勵","⼓":"勹","勺":"勺","\uD87E\uDC28":"勺","\uD87E\uDC29":"包","\uD87E\uDC2A":"匆","\uD87E\uDDDD":"\uD842\uDCDE","⼔":"匕","北":"北","\uD87E\uDC2B":"北","⼕":"匚","⼖":"匸","匿":"匿","⼗":"十","〸":"十","〺":"卅","\uD87E\uDC2C":"卉","࿖":"卍","࿕":"卐","卑":"卑","\uD87E\uDC2D":"卑","\uD87E\uDC2E":"博","ト":"卜","⼘":"卜","⼙":"卩","⺋":"㔾","\uD87E\uDC2F":"即","卵":"卵","\uD87E\uDC30":"卽","\uD87E\uDC31":"卿","\uD87E\uDC32":"卿","\uD87E\uDC33":"卿","⼚":"厂","\uD87E\uDC34":"\uD842\uDE2C","⼛":"厶","參":"參","⼜":"又","\uD87E\uDC36":"及","\uD87E\uDC37":"叟","\uD87E\uDC38":"\uD842\uDF63","ロ":"口","⼝":"口","囗":"口","⼞":"口","句":"句","\uD87E\uDC39":"叫","\uD87E\uDC3A":"叱","\uD87E\uDC3B":"吆","吏":"吏","吝":"吝","\uD87E\uDC3D":"吸","呂":"呂","\uD87E\uDC3E":"呈","\uD87E\uDC3F":"周","\uD87E\uDC3C":"咞","\uD87E\uDC40":"咢","咽":"咽","䎛":"㖈","\uD87E\uDC41":"哶","\uD87E\uDC42":"唐","\uD87E\uDC43":"啓","啟":"啓","啕":"啕","\uD87E\uDC44":"啣","\uD87E\uDC45":"善","\uD87E\uDC46":"善","喇":"喇","喙":"喙","\uD87E\uDC47":"喙","喝":"喝","喝":"喝","\uD87E\uDC48":"喫","\uD87E\uDC49":"喳","嗀":"嗀","\uD87E\uDC4A":"嗂","嗢":"嗢","嘆":"嘆","\uD87E\uDC4C":"嘆","\uD87E\uDC4E":"噑","\uD87E\uDC4F":"噴","器":"器","囹":"囹","\uD87E\uDC4B":"圖","\uD87E\uDC4D":"圗","⼟":"土","士":"土","⼠":"土","\uD87E\uDC55":"型","\uD87E\uDC52":"城","㦳":"㘽","\uD87E\uDC53":"埴","\uD87E\uDC54":"堍","\uD87E\uDC57":"報","\uD87E\uDC56":"堲","塀":"塀","塚":"塚","塚":"塚","塞":"塞","填":"塡","壿":"墫","\uD87E\uDC58":"墬","墳":"墳","壘":"壘","壟":"壟","\uD87E\uDC59":"\uD845\uDCE4","\uD87E\uDC51":"壮","\uD87E\uDC5A":"売","\uD87E\uDC5B":"壷","⼡":"夂","\uD87E\uDC5C":"夆","⼢":"夊","タ":"夕","⼣":"夕","\uD87E\uDC5D":"多","\uD87E\uDC5E":"夢","⼤":"大","奄":"奄","奈":"奈","契":"契","奔":"奔","\uD87E\uDC5F":"奢","女":"女","⼥":"女","\uD87E\uDC60":"\uD845\uDEA8","\uD87E\uDC61":"\uD845\uDEEA","\uD87E\uDC65":"姘","\uD87E\uDC62":"姬","\uD87E\uDC63":"娛","\uD87E\uDC64":"娧","婢":"婢","\uD87E\uDC66":"婦","嬀":"媯","\uD87E\uDC67":"㛮","\uD87E\uDC68":"㛼","\uD87E\uDD86":"媵","\uD87E\uDC69":"嬈","嬨":"嬨","\uD87E\uDC6A":"嬾","\uD87E\uDC6B":"嬾","⼦":"子","⼧":"宀","宅":"宅","\uD87E\uDC6C":"\uD846\uDDC8","\uD87E\uDC6D":"寃","\uD87E\uDC6E":"寘","寧":"寧","寧":"寧","\uD87E\uDC6F":"寧","寮":"寮","\uD87E\uDC70":"寳","\uD87E\uDC71":"\uD846\uDF18","⼨":"寸","\uD87E\uDC72":"寿","\uD87E\uDC73":"将","⼩":"小","\uD87E\uDC75":"尢","⺐":"尢","⼪":"尢","⺏":"尣","\uD87E\uDC76":"㞁","⼫":"尸","尿":"尿","\uD87E\uDC77":"屠","屢":"屢","層":"層","履":"履","屮":"屮","\uD87E\uDC78":"屮","⼬":"屮","\uD87E\uDCF8":"\uD847\uDD0B","⼭":"山","\uD87E\uDC79":"峀","\uD87E\uDC7A":"岍","\uD87E\uDC7B":"\uD847\uDDE4","\uD87E\uDC7D":"\uD847\uDDE6","崙":"崙","\uD87E\uDC7C":"嵃","嵐":"嵐","\uD87E\uDC7F":"嵫","\uD87E\uDC7E":"嵮","\uD87E\uDC80":"嵼","\uD87E\uDDF4":"嶲","嶺":"嶺","⼮":"巛","\uD87E\uDC82":"巢","エ":"工","⼯":"工","⼰":"己","⺒":"巳","\uD87E\uDC83":"㠯","\uD87E\uDC84":"巽","⼱":"巾","帲":"帡","\uD87E\uDC85":"帨","\uD87E\uDC86":"帽","\uD87E\uDC87":"幩","\uD87E\uDC88":"㡢","\uD87E\uDC89":"\uD848\uDD83","⼲":"干","年":"年","\uD87E\uDD39":"\uD848\uDD9F","⺓":"幺","⼳":"幺","⼴":"广","度":"度","\uD87E\uDC8A":"㡼","\uD87E\uDC8B":"庰","\uD87E\uDC8C":"庳","\uD87E\uDC8D":"庶","廊":"廊","\uD87E\uDC8E":"廊","廉":"廉","廒":"廒","廓":"廓","廙":"廙","廬":"廬","⼵":"廴","\uD87E\uDC90":"廾","⼶":"廾","\uD87E\uDC91":"\uD848\uDF31","\uD87E\uDC92":"\uD848\uDF31","弄":"弄","⼷":"弋","⼸":"弓","\uD87E\uDC94":"弢","\uD87E\uDC95":"弢","⼹":"彐","⺔":"彑","\uD87E\uDC74":"当","\uD87E\uDC96":"㣇","⼺":"彡","\uD87E\uDC99":"形","彩":"彩","\uD87E\uDC9A":"彫","⼻":"彳","律":"律","\uD87E\uDC9B":"㣣","\uD87E\uDC9C":"徚","復":"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","\uD87E\uDC9D":"忍","\uD87E\uDC9E":"志","念":"念","\uD87E\uDC9F":"忹","怒":"怒","怜":"怜","恵":"恵","\uD87E\uDCA2":"㤜","\uD87E\uDCA1":"㤺","\uD87E\uDCA0":"悁","悔":"悔","\uD87E\uDCA3":"悔","\uD87E\uDCA5":"惇","惘":"惘","惡":"惡","\uD87E\uDCA4":"\uD849\uDED4","愈":"愈","慨":"慨","慄":"慄","\uD87E\uDCA6":"慈","\uD87E\uDCA7":"慌","\uD87E\uDCA9":"慌","慎":"慎","\uD87E\uDCA8":"慎","慠":"慠","\uD87E\uDCAA":"慺","憎":"憎","憎":"憎","\uD87E\uDCAB":"憎","憐":"憐","\uD87E\uDCAD":"憤","\uD87E\uDCAE":"憯","\uD87E\uDCAC":"憲","𢡄":"\uD84A\uDC44","𢡊":"\uD84A\uDC4A","\uD87E\uDCAF":"懞","懲":"懲","懲":"懲","\uD87E\uDCB0":"懲","懶":"懶","\uD87E\uDCB1":"懶","戀":"戀","⼽":"戈","\uD87E\uDCB2":"成","\uD87E\uDCB3":"戛","戮":"戮","戴":"戴","⼾":"戶","戸":"戶","⼿":"手","⺘":"扌","\uD87E\uDCB4":"扝","\uD87E\uDCB5":"抱","拉":"拉","拏":"拏","拓":"拓","\uD87E\uDCB6":"拔","\uD87E\uDCBA":"拼","拾":"拾","\uD87E\uDCB8":"\uD84A\uDF0C","\uD87E\uDCB9":"挽","\uD87E\uDCB7":"捐","\uD87E\uDCBB":"捨","捻":"捻","\uD87E\uDCBC":"掃","掠":"掠","\uD87E\uDCC1":"掩","揄":"揄","\uD87E\uDCBD":"揤","摒":"摒","\uD87E\uDCBE":"\uD84A\uDFF1","搜":"搜","\uD87E\uDCBF":"搢","\uD87E\uDCC0":"揅","\uD87E\uDCC3":"摩","\uD87E\uDCC6":"摷","\uD87E\uDCC4":"摾","\uD87E\uDCC2":"㨮","搉":"㩁","撚":"撚","\uD87E\uDCC5":"撝","擄":"擄","\uD87E\uDCC7":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","\uD87E\uDCC8":"敏","敖":"敖","\uD87E\uDCC9":"敬","數":"數","\uD87E\uDCCA":"\uD84C\uDC0A","⽂":"文","⻫":"斉","⽃":"斗","料":"料","⽄":"斤","⽅":"方","旅":"旅","⽆":"无","⺛":"旡","既":"既","\uD87E\uDCCB":"旣","⽇":"日","易":"易","曶":"㫚","\uD87E\uDCD1":"㫤","\uD87E\uDCCD":"晉","晩":"晚","晴":"晴","晴":"晴","暑":"暑","\uD87E\uDCCF":"暑","暈":"暈","\uD87E\uDCD0":"㬈","\uD87E\uDCD5":"暜","暴":"暴","曆":"曆","\uD87E\uDCCE":"㬙","\uD87E\uDC97":"\uD84C\uDEB8","⽈":"曰","更":"更","\uD87E\uDCCC":"書","⽉":"月","\uD87E\uDD80":"\uD84C\uDF5F","肦":"朌","胐":"朏","胊":"朐","脁":"朓","胶":"㬵","朗":"朗","朗":"朗","\uD87E\uDCD8":"朗","脧":"朘","望":"望","\uD87E\uDCD9":"望","幐":"㬺","䐠":"㬻","\uD87E\uDD89":"\uD84C\uDF93","膧":"朣","\uD87E\uDD8A":"\uD84C\uDF9C","⽊":"木","李":"李","\uD87E\uDCDC":"杓","杖":"杖","\uD87E\uDCDB":"杞","\uD87E\uDCDD":"\uD84C\uDFC3","柿":"杮","杻":"杻","\uD87E\uDCE0":"枅","林":"林","\uD87E\uDCDE":"㭉","𣏕":"\uD84C\uDFD5","柳":"柳","\uD87E\uDCDF":"柺","栗":"栗","\uD87E\uDCE5":"栟","\uD87E\uDCE1":"桒","\uD87E\uDCE3":"\uD84D\uDC6D","梁":"梁","梅":"梅","\uD87E\uDCE2":"梅","\uD87E\uDCE4":"梎","梨":"梨","\uD87E\uDCE6":"椔","\uD87E\uDCE8":"楂","㮝":"㮝","\uD87E\uDCE7":"㮝","槩":"㮣","樧":"榝","\uD87E\uDCE9":"榣","\uD87E\uDCEA":"槪","樂":"樂","樂":"樂","樂":"樂","樓":"樓","\uD87E\uDCEC":"\uD84D\uDEA3","\uD87E\uDCEB":"檨","櫓":"櫓","\uD87E\uDCED":"櫛","欄":"欄","\uD87E\uDCEE":"㰘","⽋":"欠","\uD87E\uDCEF":"次","\uD87E\uDCF0":"\uD84E\uDCA7","\uD87E\uDCF1":"歔","\uD87E\uDCF2":"㱎","⽌":"止","⻭":"歯","\uD87E\uDCF3":"歲","歷":"歷","歹":"歹","⽍":"歹","⺞":"歺","\uD87E\uDCF4":"殟","殮":"殮","⽎":"殳","殺":"殺","殺":"殺","\uD87E\uDCF5":"殺","\uD87E\uDCF6":"殻","\uD87E\uDCF7":"\uD84E\uDE8D","⽏":"毋","⺟":"母","\uD87E\uDCF9":"\uD84E\uDEFA","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","\uD87E\uDCFA":"汎","\uD87E\uDCFE":"汧","沈":"沈","\uD87E\uDCFC":"沿","泌":"泌","\uD87E\uDCFD":"泍","泥":"泥","\uD87E\uDCFB":"\uD84F\uDCBC","洛":"洛","洞":"洞","\uD87E\uDD07":"洴","\uD87E\uDD00":"派","流":"流","流":"流","\uD87E\uDD02":"流","\uD87E\uDCFF":"洖","\uD87E\uDD03":"浩","浪":"浪","海":"海","\uD87E\uDD01":"海","\uD87E\uDD04":"浸","\uD87E\uDD05":"涅","\uD87E\uDD06":"\uD84F\uDD1E","淋":"淋","淚":"淚","淪":"淪","\uD87E\uDD0E":"淹","渚":"渚","\uD87E\uDD08":"港","\uD87E\uDD09":"湮","潙":"溈","滋":"滋","\uD87E\uDD0B":"滋","溜":"溜","溺":"溺","\uD87E\uDD0C":"滇","滑":"滑","滛":"滛","\uD87E\uDD0A":"㴳","漏":"漏","漢":"漢","漢":"漢","漣":"漣","\uD87E\uDD0D":"\uD84F\uDED1","\uD87E\uDD0F":"潮","\uD87E\uDD10":"\uD84F\uDF5E","\uD87E\uDD11":"\uD84F\uDF8E","\uD87E\uDD12":"濆","濫":"濫","濾":"濾","\uD87E\uDD15":"瀛","瀞":"瀞","\uD87E\uDD14":"瀞","\uD87E\uDD13":"瀹","\uD87E\uDD17":"灊","\uD87E\uDD16":"㶖","⽕":"火","⺣":"灬","\uD87E\uDC35":"灰","\uD87E\uDD19":"灷","\uD87E\uDD18":"災","炙":"炙","\uD87E\uDD1A":"炭","烈":"烈","烙":"烙","煮":"煮","煮":"煮","\uD87E\uDD1D":"\uD850\uDE63","\uD87E\uDD1C":"煅","煉":"煉","𤋮":"\uD850\uDEEE","\uD87E\uDD1E":"熜","燎":"燎","燐":"燐","\uD87E\uDD1F":"\uD850\uDFAB","爐":"爐","爛":"爛","\uD87E\uDD20":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","\uD87E\uDD21":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","\uD87E\uDD22":"牐","⽛":"牙","\uD87E\uDD23":"\uD851\uDE08","⽜":"牛","牢":"牢","\uD87E\uDD24":"犀","\uD87E\uDD25":"犕","⽝":"犬","⺨":"犭","犯":"犯","狀":"狀","\uD87E\uDD26":"\uD851\uDF35","狼":"狼","猪":"猪","猪":"猪","\uD87E\uDD27":"\uD852\uDC14","獵":"獵","\uD87E\uDD28":"獺","⽞":"玄","率":"率","率":"率","⽟":"玉","\uD87E\uDD29":"王","\uD87E\uDD2A":"㺬","\uD87E\uDD2B":"玥","玲":"玲","\uD87E\uDD2C":"㺸","\uD87E\uDD2D":"㺸","珞":"珞","琉":"琉","理":"理","琢":"琢","\uD87E\uDD2E":"瑇","\uD87E\uDD2F":"瑜","瑩":"瑩","瑱":"瑱","\uD87E\uDD30":"瑱","\uD87E\uDD31":"璅","璉":"璉","璘":"璘","\uD87E\uDD32":"瓊","⽠":"瓜","⽡":"瓦","\uD87E\uDD33":"㼛","甆":"甆","⽢":"甘","⽣":"生","\uD87E\uDD34":"甤","⽤":"用","⽥":"田","画":"画","\uD87E\uDD36":"甾","\uD87E\uDD35":"\uD853\uDC36","留":"留","略":"略","異":"異","\uD87E\uDD38":"異","\uD87E\uDD37":"\uD853\uDC92","⽦":"疋","⽧":"疒","痢":"痢","\uD87E\uDD3A":"瘐","瘟":"瘟","瘝":"瘝","療":"療","癩":"癩","⽨":"癶","⽩":"白","\uD87E\uDD3B":"\uD853\uDFA1","\uD87E\uDD3C":"\uD853\uDFB8","⽪":"皮","⽫":"皿","\uD87E\uDD3D":"\uD854\uDC44","\uD87E\uDD3E":"㿼","益":"益","益":"益","盛":"盛","盧":"盧","\uD87E\uDD3F":"䀈","⽬":"目","直":"直","\uD87E\uDD40":"直","\uD87E\uDD42":"\uD854\uDCF2","\uD87E\uDD41":"\uD854\uDCF3","省":"省","䀘":"䀘","\uD87E\uDD43":"\uD854\uDD19","\uD87E\uDD45":"眞","\uD87E\uDD46":"真","\uD87E\uDD47":"真","\uD87E\uDD44":"\uD854\uDD33","着":"着","睊":"睊","\uD87E\uDD48":"睊","鿃":"䀹","䀹":"䀹","\uD87E\uDD49":"䀹","晣":"䀿","\uD87E\uDD4B":"䁆","\uD87E\uDD4A":"瞋","𥉉":"\uD854\uDE49","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","\uD87E\uDD4C":"䂖","\uD87E\uDD4D":"\uD855\uDC1D","硏":"研","\uD87E\uDD4E":"硎","硫":"硫","碌":"碌","\uD87E\uDD4F":"碌","碑":"碑","磊":"磊","磌":"磌","\uD87E\uDD50":"磌","磻":"磻","\uD87E\uDD51":"䃣","礪":"礪","⽰":"示","⺭":"礻","礼":"礼","社":"社","祈":"祈","祉":"祉","\uD87E\uDD52":"\uD855\uDE26","祐":"祐","祖":"祖","\uD87E\uDD53":"祖","祝":"祝","神":"神","祥":"祥","視":"視","視":"視","祿":"祿","\uD87E\uDD54":"\uD855\uDE9A","禍":"禍","禎":"禎","福":"福","\uD87E\uDD56":"福","\uD87E\uDD55":"\uD855\uDEC5","禮":"禮","⽱":"禸","⽲":"禾","秊":"秊","\uD87E\uDD58":"䄯","\uD87E\uDD57":"秫","稜":"稜","\uD87E\uDD5A":"穊","穀":"穀","\uD87E\uDD59":"穀","\uD87E\uDD5B":"穏","⽳":"穴","突":"突","\uD87E\uDD5C":"\uD856\uDD7C","窱":"窱","立":"立","⽴":"立","⻯":"竜","\uD87E\uDD5D":"\uD856\uDEA7","\uD87E\uDD5E":"\uD856\uDEA7","\uD87E\uDD5F":"竮","⽵":"竹","笠":"笠","節":"節","節":"節","\uD87E\uDD60":"䈂","\uD87E\uDD61":"\uD856\uDFAB","\uD87E\uDD62":"篆","\uD87E\uDD64":"䈧","\uD87E\uDD63":"築","\uD87E\uDD65":"\uD857\uDC80","𥳐":"\uD857\uDCD0","簾":"簾","籠":"籠","⽶":"米","类":"类","粒":"粒","精":"精","\uD87E\uDD66":"糒","糖":"糖","\uD87E\uDD68":"糨","\uD87E\uDD67":"䊠","\uD87E\uDD69":"糣","糧":"糧","⽷":"糸","⺯":"糹","\uD87E\uDD6B":"\uD857\uDF86","\uD87E\uDD6A":"紀","紐":"紐","索":"索","累":"累","絶":"絕","\uD87E\uDD6C":"絣","絛":"絛","綠":"綠","綾":"綾","\uD87E\uDD6E":"緇","練":"練","練":"練","練":"練","\uD87E\uDD6F":"縂","\uD87E\uDD6D":"䌁","縉":"縉","縷":"縷","繁":"繁","\uD87E\uDD70":"繅","\uD87E\uDC98":"\uD858\uDDDA","\uD87E\uDD71":"䌴","⽸":"缶","\uD87E\uDD72":"\uD858\uDE28","缾":"缾","\uD87E\uDD73":"\uD858\uDE47","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","\uD87E\uDD74":"䍙","署":"署","\uD87E\uDD75":"\uD858\uDED9","罹":"罹","\uD87E\uDD76":"罺","羅":"羅","\uD87E\uDD77":"\uD858\uDF3E","⽺":"羊","\uD87E\uDD78":"羕","羚":"羚","羽":"羽","⽻":"羽","\uD87E\uDD79":"翺","老":"老","⽼":"老","⺹":"耂","者":"者","者":"者","\uD87E\uDD7A":"者","⽽":"而","\uD87E\uDD7B":"\uD859\uDCDA","⽾":"耒","\uD87E\uDD7C":"\uD859\uDD23","⽿":"耳","聆":"聆","\uD87E\uDD7D":"聠","\uD87E\uDD7E":"\uD859\uDDA8","聯":"聯","\uD87E\uDD7F":"聰","聾":"聾","⾀":"聿","⺺":"肀","⾁":"肉","肋":"肋","\uD87E\uDCD6":"肭","\uD87E\uDD82":"育","\uD87E\uDD81":"䏕","\uD87E\uDCD7":"䏙","腁":"胼","\uD87E\uDD83":"脃","\uD87E\uDD85":"脾","\uD87E\uDD84":"䐋","\uD87E\uDCDA":"朡","\uD87E\uDD87":"\uD859\uDFA7","\uD87E\uDD88":"\uD859\uDFB5","朦":"䑃","臘":"臘","⾂":"臣","臨":"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","\uD87E\uDC93":"舁","\uD87E\uDD8B":"舁","\uD87E\uDD8C":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","\uD87E\uDD8E":"䑫","⾉":"艮","良":"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","\uD87E\uDD90":"芋","\uD87E\uDD8F":"芑","\uD87E\uDD91":"芝","\uD87E\uDD93":"花","\uD87E\uDD94":"芳","\uD87E\uDD95":"芽","若":"若","\uD87E\uDD98":"若","\uD87E\uDD96":"苦","\uD87E\uDD97":"\uD85A\uDF3C","茶":"茶","荒":"荒","\uD87E\uDD9A":"荣","\uD87E\uDD99":"茝","\uD87E\uDD9C":"茣","\uD87E\uDD9D":"莽","\uD87E\uDDA0":"荓","菉":"菉","\uD87E\uDDA1":"菊","\uD87E\uDDA2":"菌","\uD87E\uDDA3":"菜","\uD87E\uDD9E":"菧","華":"華","菱":"菱","著":"著","\uD87E\uDD9F":"著","\uD87E\uDDA4":"\uD85B\uDC36","\uD87E\uDD9B":"莭","落":"落","葉":"葉","蔿":"蒍","\uD87E\uDDA6":"\uD85B\uDCD5","\uD87E\uDDA5":"\uD85B\uDD6B","蓮":"蓮","\uD87E\uDDA8":"蓱","\uD87E\uDDA9":"蓳","蓼":"蓼","\uD87E\uDDAA":"蔖","\uD87E\uDDA7":"䔫","\uD87E\uDDAC":"蕤","\uD87E\uDDAD":"\uD85B\uDF2C","藍":"藍","\uD87E\uDDAE":"䕝","\uD87E\uDDB0":"\uD85B\uDFB1","\uD87E\uDDAF":"䕡","藺":"藺","蘆":"蘆","\uD87E\uDDB2":"䕫","蘒":"蘒","蘭":"蘭","\uD87E\uDDB1":"\uD85C\uDCD2","虁":"蘷","蘿":"蘿","⾌":"虍","⻁":"虎","\uD87E\uDDB3":"虐","虜":"虜","\uD87E\uDDB4":"虜","\uD87E\uDDB5":"虧","\uD87E\uDDB6":"虩","⾍":"虫","\uD87E\uDDB7":"蚩","\uD87E\uDDB8":"蚈","\uD87E\uDDBA":"蛢","\uD87E\uDDB9":"蜎","\uD87E\uDDBC":"蜨","\uD87E\uDDBD":"蝫","\uD87E\uDDC0":"蟡","蝹":"蝹","\uD87E\uDDBB":"蝹","\uD87E\uDDBE":"螆","\uD87E\uDDBF":"䗗","\uD87E\uDDAB":"\uD85C\uDFCA","螺":"螺","\uD87E\uDDC1":"蠁","\uD87E\uDDC2":"䗹","蠟":"蠟","⾎":"血","行":"行","⾏":"行","\uD87E\uDDC3":"衠","\uD87E\uDDC4":"衣","⾐":"衣","⻂":"衤","裂":"裂","\uD87E\uDDC5":"\uD85D\uDE67","裏":"裏","\uD87E\uDDC6":"裗","\uD87E\uDDC7":"裞","裡":"裡","裸":"裸","\uD87E\uDDC9":"裺","\uD87E\uDDC8":"䘵","褐":"褐","襁":"襁","襤":"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆","見":"見","⾒":"見","\uD87E\uDDCB":"\uD85E\uDCAE","⻅":"见","⾓":"角","⾔":"言","\uD87E\uDDCC":"\uD85E\uDD66","詽":"訮","訞":"䚶","\uD87E\uDDCD":"䚾","\uD87E\uDDCE":"䛇","\uD87E\uDDCF":"誠","說":"說","說":"說","調":"調","請":"請","諒":"諒","論":"論","諭":"諭","\uD87E\uDDD0":"諭","諸":"諸","諸":"諸","諾":"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹","識":"識","讀":"讀","讏":"讆","變":"變","\uD87E\uDDD1":"變","⻈":"讠","⾕":"谷","⾖":"豆","豈":"豈","\uD87E\uDDD2":"豕","⾗":"豕","豣":"豜","⾘":"豸","\uD87E\uDDD3":"\uD85F\uDCA8","⾙":"貝","\uD87E\uDDD4":"貫","\uD87E\uDDD5":"賁","賂":"賂","賈":"賈","賓":"賓","贈":"贈","贈":"贈","\uD87E\uDDD6":"贛","⻉":"贝","⾚":"赤","⾛":"走","\uD87E\uDDD7":"起","趆":"赿","𧻓":"\uD85F\uDED3","\uD87E\uDDD8":"\uD85F\uDF2F","⾜":"足","\uD87E\uDDDA":"跋","\uD87E\uDDDB":"趼","跺":"跥","路":"路","\uD87E\uDDDC":"跰","躛":"躗","⾝":"身","車":"車","⾞":"車","\uD87E\uDDDE":"軔","輧":"軿","輦":"輦","輪":"輪","輸":"輸","\uD87E\uDDDF":"輸","輻":"輻","轢":"轢","⻋":"车","⾟":"辛","\uD87E\uDD8D":"辞","辰":"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","\uD87E\uDC81":"巡","連":"連","逸":"逸","逸":"逸","遲":"遲","遼":"遼","\uD87E\uDDE0":"\uD861\uDDD2","\uD87E\uDDE1":"\uD861\uDDED","邏":"邏","⾢":"邑","\uD87E\uDDE2":"邔","郎":"郎","郞":"郎","郞":"郎","\uD87E\uDDE3":"郱","都":"都","\uD87E\uDDE5":"\uD861\uDF2E","\uD87E\uDDE4":"鄑","\uD87E\uDDE6":"鄛","⾣":"酉","酪":"酪","醙":"醙","醴":"醴","⾤":"釆","里":"里","⾥":"里","量":"量","金":"金","⾦":"金","鈴":"鈴","\uD87E\uDDE7":"鈸","鉶":"鉶","\uD87E\uDDE8":"鋗","\uD87E\uDDE9":"鋘","\uD87E\uDDEA":"鉼","錄":"錄","鍊":"鍊","鎮":"鎭","\uD87E\uDDEB":"鏹","\uD87E\uDDEC":"鐕","\uD87E\uDDED":"\uD862\uDFFA","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","\uD87E\uDDEE":"開","\uD87E\uDDEF":"䦕","閭":"閭","\uD87E\uDDF0":"閷","\uD87E\uDDF1":"\uD863\uDD77","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝","阮":"阮","陋":"陋","降":"降","陵":"陵","陸":"陸","陼":"陼","隆":"隆","隣":"隣","\uD87E\uDDF2":"䧦","⾪":"隶","隷":"隷","隸":"隷","隸":"隷","⾫":"隹","\uD87E\uDDF3":"雃","離":"離","難":"難","難":"難","⾬":"雨","零":"零","雷":"雷","\uD87E\uDDF5":"霣","\uD87E\uDDF6":"\uD864\uDD45","露":"露","靈":"靈","⾭":"靑","⻘":"青","靖":"靖","靖":"靖","\uD87E\uDC1C":"\uD864\uDDDF","⾮":"非","⾯":"面","\uD87E\uDDF7":"\uD864\uDE1A","⾰":"革","\uD87E\uDDF8":"䩮","\uD87E\uDDF9":"䩶","⾱":"韋","韛":"韛","\uD87E\uDDFA":"韠","⻙":"韦","⾲":"韭","\uD87E\uDDFB":"\uD865\uDC0A","⾳":"音","響":"響","響":"響","⾴":"頁","\uD87E\uDDFC":"䪲","頋":"頋","\uD87E\uDDFE":"頋","\uD87E\uDDFF":"頋","領":"領","\uD87E\uDE00":"頩","\uD87E\uDDFD":"\uD865\uDC96","頻":"頻","頻":"頻","類":"類","⻚":"页","⾵":"風","\uD87E\uDE01":"\uD865\uDDB6","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","\uD87E\uDE02":"飢","飯":"飯","飼":"飼","\uD87E\uDE03":"䬳","館":"館","\uD87E\uDE04":"餩","⻠":"饣","⾸":"首","⾹":"香","\uD87E\uDE05":"馧","⾺":"馬","\uD87E\uDE06":"駂","駱":"駱","\uD87E\uDE07":"駾","驪":"驪","⻢":"马","⾻":"骨","\uD87E\uDE08":"䯎","⾼":"高","⾽":"髟","\uD87E\uDE09":"\uD866\uDF30","鬒":"鬒","\uD87E\uDE0A":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚","魯":"魯","\uD87E\uDE0B":"鱀","鱗":"鱗","⻥":"鱼","⿃":"鳥","\uD87E\uDE0C":"鳽","\uD87E\uDE0D":"䳎","\uD87E\uDE0F":"鵧","\uD87E\uDE0E":"䳭","\uD87E\uDE10":"\uD868\uDCCE","鶴":"鶴","\uD87E\uDE12":"\uD868\uDD05","\uD87E\uDE11":"䳸","鷺":"鷺","\uD87E\uDE13":"\uD868\uDE0E","鸞":"鸞","鹃":"鹂","⿄":"鹵","鹿":"鹿","⿅":"鹿","\uD87E\uDE14":"\uD868\uDE91","麗":"麗","麟":"麟","⿆":"麥","⻨":"麦","\uD87E\uDE15":"麻","⿇":"麻","\uD87E\uDC8F":"\uD868\uDF92","⿈":"黃","⻩":"黄","⿉":"黍","黎":"黎","\uD87E\uDE16":"䵖","⿊":"黑","黒":"黑","墨":"墨","\uD87E\uDE17":"黹","⿋":"黹","⿌":"黽","\uD87E\uDE19":"鼅","\uD87E\uDE18":"黾","⿍":"鼎","\uD87E\uDE1A":"鼏","⿎":"鼓","\uD87E\uDE1B":"鼖","⿏":"鼠","\uD87E\uDE1C":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","\uD87E\uDE1D":"\uD869\uDE00","⻮":"齿","龍":"龍","⿓":"龍","龎":"龎","⻰":"龙","龜":"龜","龜":"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"}')}}]);